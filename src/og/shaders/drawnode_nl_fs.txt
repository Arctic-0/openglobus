precision highp float;

uniform vec4 tileOffsetArr[5];
uniform vec4 visibleExtentOffsetArr[5];
uniform vec4 transparentColorArr[5];

uniform sampler2D defaultTexture;
uniform sampler2D samplerArr[5];
uniform int samplerCount;

varying vec2 vTextureCoord;

// return 1 if v inside the box, return 0 otherwise
float insideBox(vec2 v, vec2 bottomLeft, vec2 topRight) {
    vec2 s = step(bottomLeft, v) - step(topRight, v);
    return s.x * s.y;   
}

void main(void) {
	
	gl_FragColor = texture2D( defaultTexture, vTextureCoord );

	if( samplerCount == 0 ) return;
	vec4 t = texture2D( samplerArr[0], tileOffsetArr[0].xy + vTextureCoord * tileOffsetArr[0].zw ) * insideBox(visibleExtentOffsetArr[0].xy + vTextureCoord * visibleExtentOffsetArr[0].zw, vec2(0.0), vec2(1.0));
	gl_FragColor = mix( gl_FragColor, t, transparentColorArr[0].a * t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[0].rgb )));

	if( samplerCount == 1 ) return;
	t = texture2D( samplerArr[1], tileOffsetArr[1].xy + vTextureCoord * tileOffsetArr[1].zw ) * insideBox(visibleExtentOffsetArr[1].xy + vTextureCoord * visibleExtentOffsetArr[1].zw, vec2(0.0), vec2(1.0));
	gl_FragColor = mix( gl_FragColor, t, transparentColorArr[1].a * t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[1].rgb )));

	if( samplerCount == 2 ) return;
	t = texture2D( samplerArr[2], tileOffsetArr[2].xy + vTextureCoord * tileOffsetArr[2].zw ) * insideBox(visibleExtentOffsetArr[2].xy + vTextureCoord * visibleExtentOffsetArr[2].zw, vec2(0.0), vec2(1.0));
	gl_FragColor = mix( gl_FragColor, t, transparentColorArr[2].a * t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[2].rgb )));

	if( samplerCount == 3 ) return;
	t = texture2D( samplerArr[3], tileOffsetArr[3].xy + vTextureCoord * tileOffsetArr[3].zw ) * insideBox(visibleExtentOffsetArr[3].xy + vTextureCoord * visibleExtentOffsetArr[3].zw, vec2(0.0), vec2(1.0));
	gl_FragColor = mix( gl_FragColor, t, transparentColorArr[3].a * t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[3].rgb )));

	if( samplerCount == 4 ) return;
	t = texture2D( samplerArr[4], tileOffsetArr[4].xy + vTextureCoord * tileOffsetArr[4].zw ) * insideBox(visibleExtentOffsetArr[4].xy + vTextureCoord * visibleExtentOffsetArr[4].zw, vec2(0.0), vec2(1.0));
	gl_FragColor = mix( gl_FragColor, t, transparentColorArr[4].a * t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[4].rgb )));
}