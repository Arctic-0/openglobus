!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("og",[],t):"object"==typeof exports?exports.og=t():e.og=t()}(window,function(){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},i.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0)}({0:function(e,t,i){"use strict";i.r(t);var r={};i.d(r,"TWO_PI",function(){return u}),i.d(r,"PI_TWO",function(){return d}),i.d(r,"X",function(){return c}),i.d(r,"Y",function(){return _}),i.d(r,"Z",function(){return f}),i.d(r,"W",function(){return p}),i.d(r,"MAX_FLOAT",function(){return v}),i.d(r,"LOG2",function(){return g}),i.d(r,"MAX32",function(){return m}),i.d(r,"MAX",function(){return C}),i.d(r,"MIN",function(){return b}),i.d(r,"RADIANS",function(){return T}),i.d(r,"DEGREES",function(){return A}),i.d(r,"DEGREES_DOUBLE",function(){return E}),i.d(r,"RADIANS_HALF",function(){return M}),i.d(r,"ARCSECONDS_TO_RADIANS",function(){return P}),i.d(r,"RADIANS_TO_HOURS",function(){return B}),i.d(r,"HOURS_TO_RADIANS",function(){return L}),i.d(r,"HOURS_TO_DEGREES",function(){return R}),i.d(r,"DEGREES_TO_HOURS",function(){return S}),i.d(r,"SQRT_HALF",function(){return N}),i.d(r,"EPSILON1",function(){return I}),i.d(r,"EPSILON2",function(){return F}),i.d(r,"EPSILON3",function(){return k}),i.d(r,"EPSILON4",function(){return D}),i.d(r,"EPSILON5",function(){return O}),i.d(r,"EPSILON6",function(){return V}),i.d(r,"EPSILON7",function(){return U}),i.d(r,"EPSILON8",function(){return H}),i.d(r,"EPSILON9",function(){return W}),i.d(r,"EPSILON10",function(){return G}),i.d(r,"EPSILON11",function(){return X}),i.d(r,"EPSILON12",function(){return Y}),i.d(r,"EPSILON13",function(){return q}),i.d(r,"EPSILON14",function(){return Z}),i.d(r,"EPSILON15",function(){return Q}),i.d(r,"EPSILON16",function(){return K}),i.d(r,"EPSILON17",function(){return J}),i.d(r,"EPSILON18",function(){return $}),i.d(r,"EPSILON19",function(){return ee}),i.d(r,"EPSILON20",function(){return te}),i.d(r,"log",function(){return ie}),i.d(r,"clamp",function(){return re}),i.d(r,"DEG2RAD",function(){return se}),i.d(r,"RAD2DEG",function(){return ne}),i.d(r,"isPowerOfTwo",function(){return ae}),i.d(r,"nextHighestPowerOfTwo",function(){return oe}),i.d(r,"randomi",function(){return he}),i.d(r,"random",function(){return le}),i.d(r,"degToDec",function(){return ue}),i.d(r,"mod",function(){return de}),i.d(r,"zeroTwoPI",function(){return ce}),i.d(r,"step",function(){return _e}),i.d(r,"frac",function(){return fe}),i.d(r,"log2",function(){return pe}),i.d(r,"exp2",function(){return ve}),i.d(r,"pow2i",function(){return ge}),i.d(r,"slice",function(){return me}),i.d(r,"lerp",function(){return xe}),i.d(r,"bezier",function(){return ye}),i.d(r,"rev",function(){return Ce}),i.d(r,"norm_lon",function(){return be}),i.d(r,"negativePItoPI",function(){return Te}),i.d(r,"solve_iteration_fixed",function(){return Ae}),i.d(r,"solve_iteration",function(){return Ee});var s={};i.d(s,"POLE",function(){return we}),i.d(s,"POLE_DOUBLE",function(){return Me}),i.d(s,"ONE_BY_POLE_DOUBLE",function(){return Pe}),i.d(s,"forward_lon",function(){return Be}),i.d(s,"forward_lat",function(){return Le}),i.d(s,"inverse_lon",function(){return Re}),i.d(s,"inverse_lat",function(){return Se}),i.d(s,"getTileX",function(){return Ne}),i.d(s,"getTileY",function(){return Ie}),i.d(s,"forwardArray",function(){return Fe}),i.d(s,"MAX_LAT",function(){return ze}),i.d(s,"MIN_LAT",function(){return ke});var n={};i.d(n,"stamp",function(){return je}),i.d(n,"isString",function(){return qe}),i.d(n,"readTextFile",function(){return Ze}),i.d(n,"htmlColorToRgba",function(){return Qe}),i.d(n,"htmlColorToRgb",function(){return Ke}),i.d(n,"stringTemplate",function(){return Je}),i.d(n,"print2d",function(){return $e}),i.d(n,"defaultString",function(){return et}),i.d(n,"createVector3",function(){return tt}),i.d(n,"createVector4",function(){return it}),i.d(n,"createColorRGBA",function(){return rt}),i.d(n,"createColorRGB",function(){return st}),i.d(n,"createExtent",function(){return nt}),i.d(n,"createLonLat",function(){return at}),i.d(n,"binarySearch",function(){return ot}),i.d(n,"binaryInsert",function(){return ht}),i.d(n,"getLinesIntersection2v",function(){return lt}),i.d(n,"getLinesIntersectionLonLat",function(){return ut}),i.d(n,"xmlToJson",function(){return dt}),i.d(n,"castType",function(){return ct});var a={};i.d(a,"SECONDS_PER_MILLISECOND",function(){return _t}),i.d(a,"MILLISECONDS_PER_SECOND",function(){return ft}),i.d(a,"SECONDS_PER_MINUTE",function(){return pt}),i.d(a,"ONE_BY_SECONDS_PER_MINUTE",function(){return vt}),i.d(a,"MINUTES_PER_HOUR",function(){return gt}),i.d(a,"HOURS_PER_DAY",function(){return mt}),i.d(a,"ONE_BY_HOURS_PER_DAY",function(){return xt}),i.d(a,"SECONDS_PER_HOUR",function(){return yt}),i.d(a,"ONE_BY_SECONDS_PER_HOUR",function(){return Ct}),i.d(a,"SECONDS_PER_12_HOURS",function(){return bt}),i.d(a,"MINUTES_PER_DAY",function(){return Tt}),i.d(a,"ONE_BY_MINUTES_PER_DAY",function(){return At}),i.d(a,"SECONDS_PER_DAY",function(){return Et}),i.d(a,"MILLISECONDS_PER_DAY",function(){return wt}),i.d(a,"ONE_BY_MILLISECONDS_PER_DAY",function(){return Mt}),i.d(a,"ONE_BY_SECONDS_PER_DAY",function(){return Pt}),i.d(a,"DAYS_PER_JULIAN_CENTURY",function(){return Bt}),i.d(a,"DAYS_PER_JULIAN_YEAR",function(){return Lt}),i.d(a,"PICOSECOND",function(){return Rt}),i.d(a,"MODIFIED_JULIAN_DATE_DIFFERENCE",function(){return St}),i.d(a,"J2000",function(){return Nt}),i.d(a,"T",function(){return It}),i.d(a,"getDayNumber",function(){return Ft}),i.d(a,"DateToUTC",function(){return zt}),i.d(a,"DateToTAI",function(){return kt}),i.d(a,"UTCtoTAI",function(){return Dt}),i.d(a,"TAItoUTC",function(){return Ot}),i.d(a,"UTCtoDate",function(){return Vt}),i.d(a,"TAItoDate",function(){return Ut}),i.d(a,"addMilliseconds",function(){return Ht}),i.d(a,"addSeconds",function(){return Wt}),i.d(a,"addHours",function(){return Gt}),i.d(a,"addMinutes",function(){return Xt}),i.d(a,"addDays",function(){return Yt}),i.d(a,"getMilliseconds",function(){return jt}),i.d(a,"getSeconds",function(){return qt}),i.d(a,"getHours",function(){return Zt}),i.d(a,"getMinutes",function(){return Qt}),i.d(a,"getDays",function(){return Kt}),i.d(a,"secondsToDays",function(){return Jt}),i.d(a,"daysToSeconds",function(){return $t}),i.d(a,"J2000TAI",function(){return ii});i(5);const o={ReadyState:{Uninitialized:0,Loading:1,Loaded:2,Interactive:3,Complete:4},Status:{OK:200,Created:201,Accepted:202,NoContent:204,BadRequest:400,Forbidden:403,NotFound:404,Gone:410,ServerError:500},Method:{Get:"GET",Post:"POST"},Asynchronous:!0,Synchronous:!1},h={type:o.Method.Get,async:o.Asynchronous,data:null,sender:null,responseType:"text"};o.request=function(e,t){t=t||{};var i,r={};for(i in h)r[i]=h[i];for(i in t)r[i]=t[i];r.data=t.data;var s,n=function(){if(void 0!==typeof XMLHttpRequest)return new XMLHttpRequest;if(window.ActiveXObject)for(var e=["MSXML2.XMLHttp.5.0","MSXML2.XMLHttp.4.0","MSXML2.XMLHttp.3.0","MSXML2.XMLHttp","Microsoft.XMLHttp"],t=0;t<e.length;t++)try{return new ActiveXObject(e[t])}catch(e){console.log("error: og.ajax.createXMLHttp creation filed.")}}(),a=new function(e){var t=e;this.abort=function(){t.aborted=!0,t.abort()}}(n),l=null;if(r.type===o.Method.Post){if(r.data){for(key in l="",r.data)s=r.data[key],l+=key+"="+encodeURIComponent(s instanceof Object?JSON.stringify(s):s)+"&";l=l.slice(0,-1)}n.open(r.type,e,r.async),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}else if(r.data){var u="?";for(key in r.data)s=r.data[key],u+=key+"="+encodeURIComponent(s instanceof Object?JSON.stringify(s):s)+"&";u=u.slice(0,-1),n.open(r.type,e+u,r.async)}else n.open(r.type,e,r.async);return r.async&&(n.responseType=r.responseType),n.overrideMimeType("text/plain"),n.onreadystatechange=function(){n.readyState===o.ReadyState.Complete&&(n.status===o.Status.OK?t.success&&t.success.call(t.sender||a,n.response):n.aborted?t.abort&&t.abort.call(t.sender||a,n.response,n.status):t.error&&t.error.call(t.sender||a,n.response,n.status),delete n.onreadystatechange,n.onreadystatechange=null,n=null)},n.send(l),a};const l={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},u=2*Math.PI,d=Math.PI/2,c=0,_=1,f=2,p=3,v=Number.MAX_VALUE||1.7976931348623157e308,g=Math.log(2),m=2147483647,C=549755748352,b=-C,T=Math.PI/180,A=180/Math.PI,E=2*A,M=.5*T,P=484813681109536e-20,B=3.819718634205488,L=.26179938779914946,R=15,S=1/15,N=Math.sqrt(.5),I=.1,F=.01,k=.001,D=1e-4,O=1e-5,V=1e-6,U=1e-7,H=1e-8,W=1e-9,G=1e-10,X=1e-11,Y=1e-12,q=1e-13,Z=1e-14,Q=1e-15,K=1e-16,J=1e-17,$=1e-18,ee=1e-19,te=1e-20;function ie(e,t){return Math.log(e)/Math.log(t)}function re(e,t,i){return Math.max(t,Math.min(e,i))}function se(e){return e*og.math.RADIANS}function ne(e){return e*og.math.DEGREES}function ae(e){return 0==(e&e-1)}function oe(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1}function he(e,t){return Math.floor(Math.random()*(t-e))+e}function le(e,t){return Math.random()*(t-e)+e}function ue(e,t,i,r){return r?e+t/60+i/3600:-e-t/60-i/3600}function de(e,t){return(e%t+t)%t}function ce(e){var t=og.math.mod(e,og.math.TWO_PI);return Math.abs(t)<og.math.EPSILON14&&Math.abs(e)>og.math.EPSILON14?og.math.TWO_PI:t}function _e(e,t){return t<e?0:1}function fe(e){return e-Math.floor(e)}function pe(e){return Math.log(e)/og.math.LOG2}function ve(e){return Math.pow(2,e)}function ge(e){return 2<<e-1}function me(e,t,i){return e*(t-i)}function xe(e,t,i){return i+e*(t-i)}function ye(e,t,i,r,s){var n=1-e,a=e*e,o=n*n,h=o*n,l=a*e;return t.scaleTo(h).addA(i.scaleTo(3*o*e)).addA(r.scaleTo(3*n*a)).addA(s.scaleTo(l))}function Ce(e){return e-360*Math.floor(e/360)}function be(e){return e>180?(e+180)%360-180:e<-180?(e-180)%360+180:e}function Te(e){return og.math.zeroTwoPI(e+Math.PI)-Math.PI}function Ae(e,t,i){for(var r=t,s=0;s<i;s++)r=e(r);return r}function Ee(e,t,i,r){r=r||50;for(var s=0,n=t,a=0;a<r;a++)if(n=e(s=n),Math.abs(n-s)<i)return n;return n}const we=20037508.34,Me=2*we,Pe=1/Me;function Be(e){return e*we/180}function Le(e){return Math.log(Math.tan((90+e)*Math.PI/360))/Math.PI*we}function Re(e){return 180*e/we}function Se(e){return 180/Math.PI*(2*Math.atan(Math.exp(e/we*Math.PI))-Math.PI/2)}function Ne(e,t){return Math.floor((e+180)/360*Math.pow(2,t))}function Ie(e,t){return Math.floor((1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,t))}function Fe(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i].forwardMercator());return t}const ze=Se(we),ke=-ze,De=function(e,t,i){this.lon=e||0,this.lat=t||0,this.height=i||0};De.join=function(e){for(var t=[],i=0;i<e.length;i++){var r=e[i];t[i]=new De(r[0],r[1],r[2])}return t},De.createFromArray=function(e){return new De(e[0],e[1],e[2])},De.forwardMercator=function(e,t,i){var r=e*we/180,s=Math.log(Math.tan((90+t)*Math.PI/360))/Math.PI*we;return new De(r,s,i)},De.inverseMercator=function(e,t,i){var r=180*e/we,s=180/Math.PI*(2*Math.atan(Math.exp(t/we*Math.PI))-Math.PI/2);return new De(r,s,i)},De.prototype.set=function(e,t,i){return this.lon=e||0,this.lat=t||0,this.height=i||0,this},De.prototype.copy=function(e){return this.lon=e.lon,this.lat=e.lat,this.height=e.height,this},De.prototype.clone=function(){return new De(this.lon,this.lat,this.height)},De.prototype.forwardMercator=function(){return De.forwardMercator(this.lon,this.lat,this.height)},De.prototype.forwardMercatorEPS01=function(){var e=this.lat;return e>89.9?e=89.9:e<-89.9&&(e=-89.9),new De(this.lon*we/180,Math.log(Math.tan((90+e)*Math.PI/360))/Math.PI*we)},De.prototype.inverseMercator=function(){return De.inverseMercator(this.lon,this.lat,this.height)},De.prototype.equal=function(e){return e.height?this.lon==e.lon&&this.lat==e.lat&&this.height==e.height:this.lon==e.lon&&this.lat==e.lat};const Oe=function(e,t){this.southWest=e||new De,this.northEast=t||new De};Oe.FULL_MERC=new Oe(De.SW_MERC,De.NE_MERC),Oe.NORTH_POLE_DEG=new Oe(De.NW_MERC_DEG,new De(180,90)),Oe.SOUTH_POLE_DEG=new Oe(new De(-180,-90),De.SE_MERC_DEG),Oe.createFromArray=function(e){return new Oe(new De(e[0],e[1]),new De(e[2],e[3]))},Oe.createByCoordinates=function(e){for(var t=C,i=b,r=C,s=b,n=0;n<e.length;n++){var a=e[n];a.lon<t&&(t=a.lon),a.lon>i&&(i=a.lon),a.lat<r&&(r=a.lat),a.lat>s&&(s=a.lat)}return new Oe(new De(t,r),new De(i,s))},Oe.createByCoordinatesArr=function(e){for(var t=C,i=b,r=C,s=b,n=0;n<e.length;n++){var a=e[n];a[0]<t&&(t=a[0]),a[0]>i&&(i=a[0]),a[1]<r&&(r=a[1]),a[1]>s&&(s=a[1])}return new Oe(new De(t,r),new De(i,s))},Oe.fromTile=function(e,t,i,r,s){r=r||Me,s=s||Me;var n=Math.pow(2,i),a=r/Math.pow(2,i),o=s/n,h=.5*-r+e*a,l=.5*s-t*o,u=h+a;return new Oe(new De(h,l-o),new De(u,l))},Oe.prototype.setByCoordinates=function(e){for(var t=C,i=b,r=C,s=b,n=0;n<e.length;n++){var a=e[n];a.lon<t&&(t=a.lon),a.lon>i&&(i=a.lon),a.lat<r&&(r=a.lat),a.lat>s&&(s=a.lat)}return this.southWest.lon=t,this.southWest.lat=r,this.northEast.lon=i,this.northEast.lat=s,this},Oe.prototype.isInside=function(e){var t=this.southWest,i=this.northEast;return e.lon>=t.lon&&e.lon<=i.lon&&e.lat>=t.lat&&e.lat<=i.lat},Oe.prototype.overlaps=function(e){var t=this.southWest,i=this.northEast;return t.lon<=e.northEast.lon&&i.lon>=e.southWest.lon&&t.lat<=e.northEast.lat&&i.lat>=e.southWest.lat},Oe.prototype.getWidth=function(){return this.northEast.lon-this.southWest.lon},Oe.prototype.getHeight=function(){return this.northEast.lat-this.southWest.lat},Oe.prototype.clone=function(){return new Oe(this.southWest.clone(),this.northEast.clone())},Oe.prototype.getCenter=function(){var e=this.southWest,t=this.northEast;return new De(e.lon+.5*(t.lon-e.lon),e.lat+.5*(t.lat-e.lat))},Oe.prototype.getNorthWest=function(){return new De(this.southWest.lon,this.northEast.lat)},Oe.prototype.getNorthEast=function(){return new De(this.northEast.lon,this.northEast.lat)},Oe.prototype.getSouthWest=function(){return new De(this.southWest.lon,this.southWest.lat)},Oe.prototype.getSouthEast=function(){return new De(this.northEast.lon,this.southWest.lat)},Oe.prototype.getNorth=function(){return this.northEast.lat},Oe.prototype.getEast=function(){return this.northEast.lon},Oe.prototype.getWest=function(){return this.southWest.lon},Oe.prototype.getSouth=function(){return this.southWest.lat},Oe.prototype.equals=function(e){return this.southWest.lon===e.southWest.lon&&this.southWest.lat===e.southWest.lat&&this.northEast.lon===e.northEast.lon&&this.northEast.lat===e.northEast.lat},Oe.prototype.forwardMercator=function(){return new Oe(this.southWest.forwardMercator(),this.northEast.forwardMercator())},Oe.prototype.inverseMercator=function(){return new Oe(this.southWest.inverseMercator(),this.northEast.inverseMercator())},Oe.prototype.getCartesianBounds=function(e){for(var t=C,i=b,r=C,s=b,n=C,a=b,o=[new De(this.southWest.lon,this.southWest.lat),new De(this.southWest.lon,this.northEast.lat),new De(this.northEast.lon,this.northEast.lat),new De(this.northEast.lon,this.southWest.lat)],h=0;h<o.length;h++){var l=e.lonLatToCartesian(o[h]),u=l.x,d=l.y,c=l.z;u<t&&(t=u),u>i&&(i=u),d<r&&(r=d),d>s&&(s=d),c<n&&(n=c),c>a&&(a=c)}return[t,i,r,s,n,a]},Oe.prototype.toString=function(){return"["+this.southWest.lon+", "+this.southWest.lat+", "+this.northEast.lon+", "+this.northEast.lat+"]"};const Ve=function(e,t,i,r){this.x=e||0,this.y=t||0,this.z=i||0,this.w=r||0};Ve.identity=new Ve(0,0,0,1),Ve.fromVec=function(e){return new Ve(e[0],e[1],e[2],e[3])},Ve.prototype.toVec3=function(){return new Ge(this.x,this.y,this.z)},Ve.prototype.clone=function(e){return new Ve(this.x,this.y,this.z,this.w)},Ve.prototype.equal=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},Ve.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},Ve.prototype.toVec=function(){return[this.x,this.y,this.z,this.w]},Ve.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},Ve.prototype.set=function(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this},Ve.prototype.addA=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},Ve.prototype.subA=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},Ve.prototype.scale=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},Ve.prototype.affinity=function(){var e=1/this.w;return this.x*=e,this.y*=e,this.z*=e,this.w=1,this},Ve.prototype.scaleTo=function(e){return new Ve(this.x*e,this.y*e,this.z*e,this.w*e)},Ve.prototype.getStep=function(e){return new Ve(this.x<e?0:1,this.y<e?0:1,this.z<e?0:1,this.w<e?0:1)},Ve.prototype.getFrac=function(e){return new Ve(og.math.frac(e.x),og.math.frac(e.y),og.math.frac(e.z),og.math.frac(e.w))},Ve.prototype.dot=function(e){return e.x*this.x+e.y*this.y+e.z*this.z+e.w*this.w};const Ue=function(){this._m=new Array(9)};Ue.prototype.set=function(e){return this._m[0]=e[0],this._m[1]=e[1],this._m[2]=e[2],this._m[3]=e[3],this._m[4]=e[4],this._m[5]=e[5],this._m[6]=e[6],this._m[7]=e[7],this._m[8]=e[8],this},Ue.prototype.clone=function(){var e=new Ue;return e.set(this),e},Ue.prototype.copy=function(e){return this.set(e._m)},Ue.prototype.transposeTo=function(){var e=new Ue,t=this._m;return e._m[0]=t[0],e._m[1]=t[3],e._m[2]=t[6],e._m[3]=t[1],e._m[4]=t[4],e._m[5]=t[7],e._m[6]=t[2],e._m[7]=t[5],e._m[8]=t[8],e},Ue.prototype.setIdentity=function(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=1,this._m[5]=0,this._m[6]=0,this._m[7]=0,this._m[8]=1,this},Ue.prototype.mulVec=function(e){var t=e.x,i=e.y,r=e.z,s=this._m;return new Ge(s[0]*t+s[3]*i+s[6]*r,s[1]*t+s[4]*i+s[7]*r,s[2]*t+s[5]*i+s[8]*r)},Ue.prototype.toMatrix4=function(){var e=new He,t=e._m,i=this._m;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=0,t[4]=i[3],t[5]=i[4],t[6]=i[5],t[7]=0,t[8]=i[6],t[9]=i[7],t[10]=i[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,e};const He=function(){this._m=new Array(16),this.left,this.right,this.bottom,this.top,this.near,this.far};He.identity=function(){var e=new He;return e._m[0]=1,e._m[1]=0,e._m[2]=0,e._m[3]=0,e._m[4]=0,e._m[5]=1,e._m[6]=0,e._m[7]=0,e._m[8]=0,e._m[9]=0,e._m[10]=1,e._m[11]=0,e._m[12]=0,e._m[13]=0,e._m[14]=0,e._m[15]=1,e},He.prototype.set=function(e){return this._m[0]=e[0],this._m[1]=e[1],this._m[2]=e[2],this._m[3]=e[3],this._m[4]=e[4],this._m[5]=e[5],this._m[6]=e[6],this._m[7]=e[7],this._m[8]=e[8],this._m[9]=e[9],this._m[10]=e[10],this._m[11]=e[11],this._m[12]=e[12],this._m[13]=e[13],this._m[14]=e[14],this._m[15]=e[15],this},He.prototype.clone=function(){var e=new He;return e.set(this),e},He.prototype.copy=function(e){this.set(e._m)},He.prototype.toMatrix3=function(){var e=new Ue,t=this._m,i=e._m;return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[4],i[4]=t[5],i[5]=t[6],i[6]=t[8],i[7]=t[9],i[8]=t[10],e},He.prototype.mulVec3=function(e){var t=e.x,i=e.y,r=e.z;return new Ge(this._m[0]*t+this._m[4]*i+this._m[8]*r+this._m[12],this._m[1]*t+this._m[5]*i+this._m[9]*r+this._m[13],this._m[2]*t+this._m[6]*i+this._m[10]*r+this._m[14])},He.prototype.mulVec4=function(e){var t=e.x,i=e.y,r=e.z,s=e.w;return new Ve(this._m[0]*t+this._m[4]*i+this._m[8]*r+this._m[12]*s,this._m[1]*t+this._m[5]*i+this._m[9]*r+this._m[13]*s,this._m[2]*t+this._m[6]*i+this._m[10]*r+this._m[14]*s,this._m[3]*t+this._m[7]*i+this._m[11]*r+this._m[15]*s)},He.prototype.toInverseMatrix3=function(){var e=this._m,t=e[0],i=e[1],r=e[2],s=e[4],n=e[5],a=e[6],o=e[8],h=e[9],l=e[10],u=l*n-a*h,d=-l*s+a*o,c=h*s-n*o,_=t*u+i*d+r*c;if(!_)return null;_=1/_;var f=new Ue;return f._m[0]=u*_,f._m[1]=(-l*i+r*h)*_,f._m[2]=(a*i-r*n)*_,f._m[3]=d*_,f._m[4]=(l*t-r*o)*_,f._m[5]=(-a*t+r*s)*_,f._m[6]=c*_,f._m[7]=(-h*t+i*o)*_,f._m[8]=(n*t-i*s)*_,f},He.prototype.inverseTo=function(){var e=this._m[0],t=this._m[1],i=this._m[2],r=this._m[3],s=this._m[4],n=this._m[5],a=this._m[6],o=this._m[7],h=this._m[8],l=this._m[9],u=this._m[10],d=this._m[11],c=this._m[12],_=this._m[13],f=this._m[14],p=this._m[15],v=e*n-t*s,g=e*a-i*s,m=e*o-r*s,x=t*a-i*n,y=t*o-r*n,C=i*o-r*a,b=h*_-l*c,T=h*f-u*c,A=h*p-d*c,E=l*f-u*_,w=l*p-d*_,M=u*p-d*f,P=1/(v*M-g*w+m*E+x*A-y*T+C*b),B=new He;return B._m[0]=(n*M-a*w+o*E)*P,B._m[1]=(-t*M+i*w-r*E)*P,B._m[2]=(_*C-f*y+p*x)*P,B._m[3]=(-l*C+u*y-d*x)*P,B._m[4]=(-s*M+a*A-o*T)*P,B._m[5]=(e*M-i*A+r*T)*P,B._m[6]=(-c*C+f*m-p*g)*P,B._m[7]=(h*C-u*m+d*g)*P,B._m[8]=(s*w-n*A+o*b)*P,B._m[9]=(-e*w+t*A-r*b)*P,B._m[10]=(c*y-_*m+p*v)*P,B._m[11]=(-h*y+l*m-d*v)*P,B._m[12]=(-s*E+n*T-a*b)*P,B._m[13]=(e*E-t*T+i*b)*P,B._m[14]=(-c*x+_*g-f*v)*P,B._m[15]=(h*x-l*g+u*v)*P,B},He.prototype.transposeTo=function(){var e=new He;return e._m[0]=this._m[0],e._m[1]=this._m[4],e._m[2]=this._m[8],e._m[3]=this._m[12],e._m[4]=this._m[1],e._m[5]=this._m[5],e._m[6]=this._m[9],e._m[7]=this._m[13],e._m[8]=this._m[2],e._m[9]=this._m[6],e._m[10]=this._m[10],e._m[11]=this._m[14],e._m[12]=this._m[3],e._m[13]=this._m[7],e._m[14]=this._m[11],e._m[15]=this._m[15],e},He.prototype.setIdentity=function(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=0,this._m[5]=1,this._m[6]=0,this._m[7]=0,this._m[8]=0,this._m[9]=0,this._m[10]=1,this._m[11]=0,this._m[12]=0,this._m[13]=0,this._m[14]=0,this._m[15]=1,this},He.prototype.mul=function(e){let t=this._m[0],i=this._m[1],r=this._m[2],s=this._m[3],n=this._m[4],a=this._m[5],o=this._m[6],h=this._m[7],l=this._m[8],u=this._m[9],d=this._m[10],c=this._m[11],_=this._m[12],f=this._m[13],p=this._m[14],v=this._m[15],g=e._m[0],m=e._m[1],x=e._m[2],y=e._m[3],C=e._m[4],b=e._m[5],T=e._m[6],A=e._m[7],E=e._m[8],w=e._m[9],M=e._m[10],P=e._m[11],B=e._m[12],L=e._m[13],R=e._m[14],S=e._m[15];var N=new He;return N._m[0]=g*t+m*n+x*l+y*_,N._m[1]=g*i+m*a+x*u+y*f,N._m[2]=g*r+m*o+x*d+y*p,N._m[3]=g*s+m*h+x*c+y*v,N._m[4]=C*t+b*n+T*l+A*_,N._m[5]=C*i+b*a+T*u+A*f,N._m[6]=C*r+b*o+T*d+A*p,N._m[7]=C*s+b*h+T*c+A*v,N._m[8]=E*t+w*n+M*l+P*_,N._m[9]=E*i+w*a+M*u+P*f,N._m[10]=E*r+w*o+M*d+P*p,N._m[11]=E*s+w*h+M*c+P*v,N._m[12]=B*t+L*n+R*l+S*_,N._m[13]=B*i+L*a+R*u+S*f,N._m[14]=B*r+L*o+R*d+S*p,N._m[15]=B*s+L*h+R*c+S*v,N},He.prototype.translate=function(e){var t=e.x,i=e.y,r=e.z,s=this._m;return s[12]=s[0]*t+s[4]*i+s[8]*r+s[12],s[13]=s[1]*t+s[5]*i+s[9]*r+s[13],s[14]=s[2]*t+s[6]*i+s[10]*r+s[14],s[15]=s[3]*t+s[7]*i+s[11]*r+s[15],this},He.prototype.translateToPosition=function(e){var t=this._m;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},He.prototype.rotate=function(e,t){var i=Math.cos(t),r=Math.sin(t),s=new He,n=s._m;return n[0]=i+(1-i)*e.x*e.x,n[1]=(1-i)*e.y*e.x-r*e.z,n[2]=(1-i)*e.z*e.x+r*e.y,n[3]=0,n[4]=(1-i)*e.x*e.y+r*e.z,n[5]=i+(1-i)*e.y*e.y,n[6]=(1-i)*e.z*e.y-r*e.x,n[7]=0,n[8]=(1-i)*e.x*e.z-r*e.y,n[9]=(1-i)*e.y*e.z+r*e.x,n[10]=i+(1-i)*e.z*e.z,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,this.mul(s)},He.prototype.setRotation=function(e,t){var i=Math.cos(t),r=Math.sin(t),s=this._m;return s[0]=i+(1-i)*e.x*e.x,s[1]=(1-i)*e.y*e.x-r*e.z,s[2]=(1-i)*e.z*e.x+r*e.y,s[3]=0,s[4]=(1-i)*e.x*e.y+r*e.z,s[5]=i+(1-i)*e.y*e.y,s[6]=(1-i)*e.z*e.y-r*e.x,s[7]=0,s[8]=(1-i)*e.x*e.z-r*e.y,s[9]=(1-i)*e.y*e.z+r*e.x,s[10]=i+(1-i)*e.z*e.z,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this},He.prototype.rotateBetweenVectors=function(e,t){return We.getRotationBetweenVectors(e,t).getMat4()},He.prototype.scale=function(e){var t=this._m;return t[0]=t[0]*e.x,t[1]=t[1]*e.x,t[2]=t[2]*e.x,t[3]=t[3]*e.x,t[4]=t[4]*e.y,t[5]=t[5]*e.y,t[6]=t[6]*e.y,t[7]=t[7]*e.y,t[8]=t[8]*e.z,t[9]=t[9]*e.z,t[10]=t[10]*e.z,t[11]=t[11]*e.z,t[12]=t[12],t[13]=t[13],t[14]=t[14],t[15]=t[15],this},He.prototype.setFrustum=function(e,t,i,r,s,n){this.left=e,this.right=t,this.bottom=i,this.top=r,this.near=s,this.far=n;var a=t-e,o=r-i,h=n-s;return this._m[0]=2*s/a,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=0,this._m[5]=2*s/o,this._m[6]=0,this._m[7]=0,this._m[8]=(t+e)/a,this._m[9]=(r+i)/o,this._m[10]=-(n+s)/h,this._m[11]=-1,this._m[12]=0,this._m[13]=0,this._m[14]=-n*s*2/h,this._m[15]=0,this},He.prototype.setPerspective=function(e,t,i,r){return t*=e=i*Math.tan(e*Math.PI/360),this.setFrustum(-t,t,-e,e,i,r)},He.prototype.setOrtho=function(e,t,i,r,s,n){this.left=e,this.right=t,this.bottom=i,this.top=r,this.near=s,this.far=n;var a=1/(e-t),o=1/(i-r),h=1/(s-n),l=this._m;return l[0]=-2*a,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=-2*o,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=2*h,l[11]=0,l[12]=(e+t)*a,l[13]=(r+i)*o,l[14]=(n+s)*h,l[15]=1,this},He.prototype.eulerToMatrix=function(e,t,i){var r=Math.cos(e),s=Math.sin(e),n=Math.cos(t),a=Math.sin(t),o=Math.cos(i),h=Math.sin(i),l=r*a,u=s*a,d=this._m;return d[0]=n*o,d[1]=-n*h,d[2]=-a,d[4]=-u*o+r*h,d[5]=u*h+r*o,d[6]=-s*n,d[8]=l*o+s*h,d[9]=-l*h+s*o,d[10]=r*n,d[3]=d[7]=d[11]=d[12]=d[13]=d[14]=0,d[15]=1,this},He.prototype.getEulerAngles=function(){};const We=function(e,t,i,r){this.x=e||0,this.y=t||0,this.z=i||0,this.w=r||0};We.IDENTITY=new We(0,0,0,1),We.xRotation=function(e){return e*=.5,new We(Math.sin(e),0,0,Math.cos(e))},We.yRotation=function(e){return e*=.5,new We(0,Math.sin(e),0,Math.cos(e))},We.zRotation=function(e){return e*=.5,new We(0,0,Math.sin(e),Math.cos(e))},We.axisAngleToQuat=function(e,t){var i=new We,r=e.normal(),s=.5*t,n=Math.sin(s);return i.set(r.x*n,r.y*n,r.z*n,Math.cos(s)),i},We.getLookAtTargetUp=function(e,t){var i=e.normal();i=Ge.OrthoNormalize(t,i);var r=t.cross(i),s=new We;s.w=.5*Math.sqrt(1+r.x+t.y+i.z);var n=1/(4*s.w);return s.x=(i.y-t.z)*n,s.y=(r.z-i.x)*n,s.z=(t.x-r.y)*n,s},We.getLookAtSourceDest=function(e,t){var i=t.subA(e).normalize(),r=Ge.FORWARD.dot(i);if(Math.abs(r- -1)<1e-6)return We.axisAngleToQuat(Ge.UP,Math.PI);if(Math.abs(r-1)<1e-6)return new We(0,0,0,1);var s=Math.acos(r),n=Ge.FORWARD.cross(i).normalize();return We.axisAngleToQuat(n,s)},We.getRotationBetweenVectors=function(e,t){var i=e.cross(t);return new We(i.x,i.y,i.z,1+e.dot(t)).normalize()},We.getRotationBetweenVectorsUp=function(e,t,i){var r=e.dot(t);if(Math.abs(r+1)<1e-6)return We.axisAngleToQuat(i,Math.PI);if(Math.abs(r-1)<1e-6)return new We(0,0,0,1);var s=Math.acos(r),n=e.cross(t).normalize();return We.axisAngleToQuat(n,s)},We.prototype.clear=function(){return this.x=this.y=this.z=this.w=0,this},We.prototype.set=function(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this},We.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},We.prototype.setIdentity=function(){return this.x=0,this.y=0,this.z=0,this.w=1,this},We.prototype.clone=function(){return new We(this.x,this.y,this.z,this.w)},We.prototype.add=function(e){return new We(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},We.prototype.sub=function(e){return new We(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)},We.prototype.scaleTo=function(e){return new We(this.x*e,this.y*e,this.z*e,this.w*e)},We.prototype.toVec=function(){return[this.x,this.y,this.z,this.w]},We.prototype.setFromSphericalCoords=function(e,t,i){var r=Math.sin(i/2),s=Math.cos(i/2),n=Math.sin(e),a=Math.cos(e),o=Math.sin(t),h=Math.cos(t);return this.x=r*a*o,this.y=r*n,this.z=r*n*h,this.w=s,this},We.prototype.toSphericalCoords=function(){var e=this.w,t=Math.sqrt(1-e*e);Math.acos(e);Math.abs(t)<5e-4&&(t=1);var i,r=this.x/t,s=this.y/t,n=this.z/t,a=-Math.asin(s);return(i=r*r+n*n<5e-4?0:Math.atan2(r,n))<0&&(i+=360),{lat:a,lon:i,alpha:Math.acos(e)}},We.prototype.setFromAxisAngle=function(e,t){var i=e.normal(),r=.5*t,s=Math.sin(r);return this.set(i.x*s,i.y*s,i.z*s,Math.cos(r)),this},We.prototype.getAxisAngle=function(){var e,t,i=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);if(i>1e-7){var r=1/i;e=new Ge(x*r,y*r,z*r),t=this.w<0?2*Math.atan2(-i,-w):2*Math.atan2(i,w)}else e=new Ge(0,0,0),t=0;return{axis:e,angle:t}},We.prototype.setFromEulerAngles=function(e,t,i){var r,s,n,a,o,h,l,u,d,c,_;return r=e*T/2,s=t*T/2,n=i*T/2,a=Math.cos(r),o=Math.cos(s),h=Math.cos(n),l=Math.sin(r),c=o*h,_=(u=Math.sin(s))*(d=Math.sin(n)),this.w=a*c+l*_,this.x=l*c-a*_,this.y=a*u*h+l*o*d,this.z=a*o*d-l*u*h,this.normalize()},We.prototype.getEulerAngles=function(){return this.getMat4().getEulerAngles()},We.prototype.setFromMatrix4=function(e){var t,i,r,s,n,a=[],o=[1,2,0];return(t=(e=e._m)[0]+e[5]+e[10])>0?(i=Math.sqrt(t+1),this.w=i/2,i=.5/i,this.x=(e[6]-e[9])*i,this.y=(e[8]-e[2])*i,this.z=(e[1]-e[4])*i):(r=0,e[5]>e[0]&&(r=1),e[10]>e[5*r]&&(r=2),n=o[s=o[r]],i=Math.sqrt(e[5*r]-(e[5*s]+e[5*n])+1),a[r]=.5*i,0!=i&&(i=.5/i),a[3]=(e[4*s+n]-e[4*n+s])*i,a[s]=(e[4*r+s]+e[4*s+r])*i,a[n]=(e[4*r+n]+e[4*n+r])*i,this.x=a[0],this.y=a[1],this.z=a[2],this.w=a[3]),this},We.prototype.getMat4=function(){var e=new He,t=e._m,i=this.x,r=this.y,s=this.z,n=this.w,a=i+i,o=r+r,h=s+s,l=i*a,u=i*o;i*=h;var d=r*o;return r*=h,s*=h,a*=n,o*=n,n*=h,t[0]=1-(d+s),t[1]=u-n,t[2]=i+o,t[3]=0,t[4]=u+n,t[5]=1-(l+s),t[6]=r-a,t[7]=0,t[8]=i-o,t[9]=r+a,t[10]=1-(l+d),t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,e},We.prototype.mulVec3=function(e){var t=e.x,i=e.y,r=e.z,s=this.x,n=this.y,a=this.z,o=this.w,h=o*t+n*r-a*i,l=o*i+a*t-s*r,u=o*r+s*i-n*t;return new Ge(h*o+(t=-s*t-n*i-a*r)*-s+l*-a-u*-n,l*o+t*-n+u*-s-h*-a,u*o+t*-a+h*-n-l*-s)},We.prototype.mul=function(e){var t=this.x,i=this.y,r=this.z,s=this.w,n=e.x,a=e.y,o=e.z,h=e.w;return new We(t*h+s*n+i*o-r*a,i*h+s*a+r*n-t*o,r*h+s*o+t*a-i*n,s*h-t*n-i*a-r*o)},We.prototype.conjugate=function(){return new We(-this.x,-this.y,-this.z,this.w)},We.prototype.inverse=function(){var e=1/this.magnitude2();return new We(-this.x*e,-this.y*e,-this.z*e,this.w*e)},We.prototype.magnitude=function(){var e=this.x,t=this.y,i=this.z,r=this.w;return Math.sqrt(e*e+t*t+i*i+r*r)},We.prototype.magnitude2=function(){var e=this.x,t=this.y,i=this.z,r=this.w;return e*e+t*t+i*i+r*r},We.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},We.prototype.normalize=function(){var e=this.x,t=this.y,i=this.z,r=this.w,s=Math.sqrt(e*e+t*t+i*i+r*r);return 0==s?(this.x=0,this.y=0,this.z=0,this.w=0,this):(s=1/s,this.x=e*s,this.y=t*s,this.z=i*s,this.w=r*s,this)},We.prototype.isEqual=function(e){var t=this.dot(e);return Math.abs(t-1)<.001},We.prototype.slerp=function(e,t){var i,r,s,n,a,o=this.x,h=this.y,l=this.z,u=this.w,d=e.x,c=e.y,_=e.z,f=e.w;return(r=o*d+h*c+l*_+u*f)<0&&(r=-r,d=-d,c=-c,_=-_,f=-f),1-r>1e-6?(i=Math.acos(r),s=Math.sin(i),n=Math.sin((1-t)*i)/s,a=Math.sin(t*i)/s):(n=1-t,a=t),new We(n*o+a*d,n*h+a*c,n*l+a*_,n*u+a*f)},We.prototype.getRoll=function(e){var t=this.x,i=this.y,r=this.z,s=this.w;if(e){var n=2*i,a=2*r,o=a*s,h=n*t,l=n*i,u=a*r;return Math.atan2(h+o,1-(l+u))}return Math.atan2(2*(t*i+s*r),s*s+t*t-i*i-r*r)},We.prototype.getPitch=function(e){var t=this.x,i=this.y,r=this.z,s=this.w;if(e){var n=2*t,a=2*r,o=n*s,h=n*t,l=a*i,u=a*r;return Math.atan2(l+o,1-(h+u))}return Math.atan2(2*(i*r+s*t),s*s-t*t-i*i+r*r)},We.prototype.getYaw=function(e){var t=this.x,i=this.y,r=this.z,s=this.w;if(e){var n=2*i,a=n*s,o=2*t*t,h=2*r*t,l=n*i;return Math.atan2(h+a,1-(o+l))}return Math.asin(-2*(t*r-s*i))};const Ge=function(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0};Ge.UP=new Ge(0,1,0),Ge.DOWN=new Ge(0,-1,0),Ge.RIGHT=new Ge(1,0,0),Ge.LEFT=new Ge(-1,0,0),Ge.FORWARD=new Ge(0,0,-1),Ge.BACKWARD=new Ge(0,0,1),Ge.ZERO=new Ge,Ge.fromVec=function(e){return new Ge(e[0],e[1],e[2])},Ge.angle=function(e,t){return Math.acos(e.dot(t)/Math.sqrt(e.length2()*t.length2()))},Ge.lerp=function(e,t,i){return Ge(e.x+(t.x-e.x)*i,e.y+(t.y-e.y)*i,e.z+(t.z-e.z)*i)},Ge.add=function(e,t){var i=new Ge(e.x,e.y,e.z);return i.addA(t),i},Ge.sub=function(e,t){var i=new Ge(e.x,e.y,e.z);return i.subA(t),i},Ge.scale=function(e,t){var i=new Ge(e.x,e.y,e.z);return i.scale(t),i},Ge.mul=function(e,t){var i=new Ge(e.x,e.y,e.z);return i.mulA(t),i},Ge.noncollinear=function(e,t){return e.y*t.z-e.z*t.y||e.z*t.x-e.x*t.z||e.x*t.y-e.y*t.z},Ge.proj_b_to_plane=function(e,t,i){var r=e.sub(t.scaleTo(t.dot(e)/t.dot(t)));return i&&r.isZero()?new Ge(i.x,i.y,i.z):r},Ge.proj_b_to_a=function(e,t){return t.scaleTo(t.dot(e)/t.dot(t))},Ge.orthoNormalize=function(e,t){return(e=e.normal()).scale(t.dot(e)),t.subA(e).normalize()},Ge.div=function(e,t){var i=new Ge(e.x,e.y,e.z);return i.divA(t),i},Ge.prototype.toVec4=function(){return new Ve(this.x,this.y,this.z,1)},Ge.prototype.clone=function(){return new Ge(this.x,this.y,this.z)},Ge.prototype.toString=function(){return"("+this.x+","+this.y+","+this.z+")"},Ge.prototype.isZero=function(){return!(this.x||this.y||this.z)},Ge.prototype.projToVec=function(e){return e.scaleTo(e.dot(this)/e.dot(e))},Ge.prototype.equal=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},Ge.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},Ge.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},Ge.prototype.length2=function(){return this.x*this.x+this.y*this.y+this.z*this.z},Ge.prototype.getQuat=function(){return new We(this.x,this.y,this.z)},Ge.prototype.addA=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},Ge.prototype.add=function(e){return new Ge(this.x+e.x,this.y+e.y,this.z+e.z)},Ge.prototype.subA=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},Ge.prototype.sub=function(e){return new Ge(this.x-e.x,this.y-e.y,this.z-e.z)},Ge.prototype.scale=function(e){return this.x*=e,this.y*=e,this.z*=e,this},Ge.prototype.scaleTo=function(e){return new Ge(this.x*e,this.y*e,this.z*e)},Ge.prototype.mulA=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},Ge.prototype.mul=function(e){return new Ge(this.x*e.x,this.y*e.y,this.z*e.z)},Ge.prototype.divA=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},Ge.prototype.div=function(e){return new Ge(this.x/e.x,this.y/e.y,this.z/e.z)},Ge.prototype.dot=function(e){return e.x*this.x+e.y*this.y+e.z*this.z},Ge.prototype.dotArr=function(e){return e[0]*this.x+e[1]*this.y+e[2]*this.z},Ge.prototype.cross=function(e){return new Ge(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},Ge.prototype.clear=function(){return this.x=this.y=this.z=0,this},Ge.prototype.normal=function(){var e=new Ge;e.copy(this);var t=1/e.length();return e.x*=t,e.y*=t,e.z*=t,e},Ge.prototype.normalize=function(){var e=1/this.length();return this.x*=e,this.y*=e,this.z*=e,this},Ge.prototype.toVec=function(){return[this.x,this.y,this.z]},Ge.prototype.toArray=function(){return[this.x,this.y,this.z]},Ge.prototype.distance=function(e){return Ge.sub(this,e).length()},Ge.prototype.set=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},Ge.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},Ge.prototype.negateTo=function(){return new Ge(-this.x,-this.y,-this.z)},Ge.prototype.projToRay=function(e,t){var i=Ge.proj_b_to_a(Ge.sub(this,e),t);return i.addA(e),i},Ge.prototype.angle=function(e){return Ge.angle(this,e)},Ge.prototype.lerp=function(e,t){return new Ge(this.x+(e.x-this.x)*t,this.y+(e.y-this.y)*t,this.z+(e.z-this.z)*t)},Ge.prototype.smerp=function(e,t){var i=1-t;return new Ge(this.x*t+e.x*i,this.y*t+e.y*i,this.z*t+e.z*i)},Ge.LERP_DELTA=1e-6,Ge.prototype.slerp=function(e,t){var i=new Ge;if(t<=0)i.copy(this);else{if(!(t>=1)){var r,s,n,a,o=this.dot(e);return 1-o>Ge.LERP_DELTA?(r=Math.acos(o),s=Math.sin(r),n=Math.sin((1-t)*r)/s,a=Math.sin(t*r)/s):(n=1-t,a=t),Ge.add(this.scaleTo(n),e.scale(a))}i.copy(e)}};const Xe=function(e,t){this.x=e||0,this.y=t||0};Xe.UP=new Xe(0,1),Xe.DOWN=new Xe(0,-1),Xe.RIGHT=new Xe(1,0),Xe.LEFT=new Xe(-1,0),Xe.ZERO=new Xe,Xe.add=function(e,t){var i=new Xe(e.x,e.y);return i.addA(t),i},Xe.sub=function(e,t){var i=new oVec2(e.x,e.y);return i.subA(t),i},Xe.scale=function(e,t){var i=new Xe(e.x,e.y);return i.scale(t),i},Xe.mul=function(e,t){var i=new Xe(e.x,e.y);return i.mulA(t),i},Xe.div=function(e,t){var i=new Xe(e.x,e.y);return i.divA(t),i},Xe.proj_b_to_a=function(e,t){return t.scaleTo(t.dot(e)/t.dot(t))},Xe.angle=function(e,t){return Math.acos(e.dot(t)/Math.sqrt(e.length2()*t.length2()))},Xe.orthoNormalize=function(e,t){return(e=e.norm()).scale(t.dot(e)),t.sub(e).normalize()},Xe.prototype.toVector3=function(){return new Ge(this.x,this.y,0)},Xe.prototype.clone=function(){return new Xe(this.x,this.y)},Xe.prototype.equal=function(e){return this.x===e.x&&this.y===e.y},Xe.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this},Xe.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Xe.prototype.length2=function(){return this.x*this.x+this.y*this.y},Xe.prototype.addA=function(e){return this.x+=e.x,this.y+=e.y,this},Xe.prototype.add=function(e){return new Xe(this.x+e.x,this.y+e.y)},Xe.prototype.subA=function(e){return this.x-=e.x,this.y-=e.y,this},Xe.prototype.sub=function(e){return new Xe(this.x-e.x,this.y-e.y)},Xe.prototype.scale=function(e){return this.x*=e,this.y*=e,this},Xe.prototype.scaleTo=function(e){return new Xe(this.x*e,this.y*e)},Xe.prototype.mulA=function(e){return this.x*=e.x,this.y*=e.y,this},Xe.prototype.mul=function(e){return new Xe(this.x*e.x,this.y*e.y)},Xe.prototype.divA=function(e){return this.x/=e.x,this.y/=e.y,this},Xe.prototype.dot=function(e){return e.x*this.x+e.y*this.y},Xe.prototype.dotArr=function(e){return e[0]*this.x+e[1]*this.y},Xe.prototype.cross=function(e){return this.x*e.y-this.y*e.x},Xe.prototype.clear=function(){return this.x=this.y=0,this},Xe.prototype.normal=function(){var e=new Xe;e.copy(this);var t=1/e.length();return e.x*=t,e.y*=t,e},Xe.prototype.normalize=function(){var e=1/this.length();return this.x*=e,this.y*=e,this},Xe.prototype.toVec=function(){return[this.x,this.y]},Xe.prototype.distance=function(e){return Xe.sub(this,e).length()},Xe.prototype.set=function(e,t){return this.x=e,this.y=t,this},Xe.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},Xe.prototype.negateTo=function(){return new Xe(-this.x,-this.y)},Xe.prototype.projToRay=function(e,t){var i=Xe.proj_b_to_a(Xe.sub(this,e),t);return i.add(e),i},Xe.prototype.angle=function(e){return Xe.angle(this,e)},Xe.prototype.lerp=function(e,t,i){var r=Xe.clone(this);return i<=0?r.copy(e):i>=1?r.copy(t):r=Xe.add(e,Xe.sub(t,e).scale(i)),r},Xe.LERP_DELTA=1e-6,Xe.prototype.slerp=function(e,t){var i=new Xe;if(t<=0)i.copy(this);else{if(!(t>=1)){var r,s,n,a,o=this.dot(e);return 1-o>Xe.LERP_DELTA?(r=Math.acos(o),s=Math.sin(r),n=Math.sin((1-t)*r)/s,a=Math.sin(t*r)/s):(n=1-t,a=t),Xe.add(this.scale(n),e.scale(a))}i.copy(e)}};let Ye=0;function je(e){var t=e._openglobus_id;return t||(t=e._openglobus_id=++Ye),t}function qe(e){return"string"==typeof e||e instanceof String}function Ze(e){var t="";return o.request(e,{async:!1,success:function(e){t=e}}),t}function Qe(e,t){var i=l[e];if(i&&(e=i),"#"===e[0]){var r=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,t,i,r){return t+t+i+i+r+r}),s=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(r);return new Ve(parseInt(s[1],16)/255,parseInt(s[2],16)/255,parseInt(s[3],16)/255,void 0==t?1:t)}void 0==t&&(t=1);var n=e.split(",");return new Ve(parseInt(n[0].split("(")[1])/255,parseInt(n[1])/255,parseInt(n[2])/255,void 0!=parseFloat(n[3])?parseFloat(n[3]):t)}function Ke(e){var t=l[e];if(t&&(e=t),"#"==e[0]){var i=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,t,i,r){return t+t+i+i+r+r}),r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(i);return new Ve(parseInt(r[1],16)/255,parseInt(r[2],16)/255,parseInt(r[3],16)/255)}var s=e.split(",");return new Ge(parseInt(s[0].split("(")[1])/255,parseInt(s[1])/255,parseInt(s[2])/255)}function Je(e,t){return e.replace(/{[^{}]+}/g,function(e){return t[e.replace(/[{}]+/g,"")]||""})}function $e(e,t,i,r){var s=document.getElementById(e);s||((s=document.createElement("div")).id=e,s.classList.add("defaultText"),document.body.appendChild(s)),s.innerHTML=t,s.style.left=i,s.style.top=r}function et(e,t){return e?e.trim().toLowerCase():t}function tt(e,t){if(e){if(e instanceof Ge)return e.clone();if(e instanceof Array)return Ge.fromVec(e)}else if(t)return t;return new Ge}function it(e,t){if(e){if(e instanceof Ve)return e.clone();if(e instanceof Array)return Ve.fromVec(e)}else if(t)return t;return new Ve}function rt(e,t){if(e){if(qe(e))return Qe(e);if(e instanceof Array)return new Ve.fromVec(e);if(e instanceof Ve)return e.clone()}else if(t)return t;return new Ve(1,1,1,1)}function st(e,t){if(e){if(qe(e))return Ke(e);if(e instanceof Array)return new Ge.fromVec(e);if(e instanceof Ge)return e.clone()}else if(t)return t;return new Ge(1,1,1)}function nt(e,t){if(e){if(e instanceof Array)return new Oe(at(e[0]),at(e[1]));if(e instanceof Oe)return e.clone()}else if(t)return t;return new Oe}function at(e,t){if(e){if(e instanceof Array)return new De(e[0],e[1],e[2]);if(e instanceof De)return e.clone()}else if(t)return t;return new De}function ot(e,t,i){for(var r=0,s=e.length-1;r<=s;){var n=s+r>>1,a=i(t,e[n],n);if(a>0)r=n+1;else{if(!(a<0))return n;s=n-1}}return-r-1}function ht(e,t,i){var r=ot(e,t,i);return r<0&&(r=~r),e.splice(r,0,t),r}function lt(e,t,i,r,s){var n=t.sub(e),a=r.sub(i),o=-n.y,h=+n.x,l=-(o*e.x+h*e.y),u=-a.y,d=+a.x,c=-(u*i.x+d*i.y),_=u*e.x+d*e.y+c,f=u*t.x+d*t.y+c,p=o*i.x+h*i.y+l,v=o*r.x+h*r.y+l;if(s&&(_*f>0||p*v>0))return null;var g=_/(_-f);return new Xe(e.x+g*n.x,e.y+g*n.y)}function ut(e,t,i,r,s){var n=new De(t.lon-e.lon,t.lat-e.lat),a=new De(r.lon-i.lon,r.lat-i.lat),o=-n.lat,h=+n.lon,l=-(o*e.lon+h*e.lat),u=-a.lat,d=+a.lon,c=-(u*i.lon+d*i.lat),_=u*e.lon+d*e.lat+c,f=u*t.lon+d*t.lat+c,p=o*i.lon+h*i.lat+l,v=o*r.lon+h*r.lat+l;if(s&&(_*f>0||p*v>0))return null;var g=_/(_-f);return new De(e.lon+g*n.lon,e.lat+g*n.lat)}function dt(e){var t={};if(1===e.nodeType){if(e.attributes.length>0){t["@attributes"]={};for(var i=0;i<e.attributes.length;i++){var r=e.attributes.item(i);t["@attributes"][r.nodeName]=r.nodeValue}}}else 3===e.nodeType&&(t=e.nodeValue);if(e.hasChildNodes())for(var s=0;s<e.childNodes.length;s++){var n=e.childNodes.item(s),a=n.nodeName;if(void 0===t[a])t[a]=dt(n);else{if(void 0===t[a].push){var o=t[a];t[a]=[],t[a].push(o)}t[a].push(dt(n))}}return t}const ct={string:function(e){return null!=e?e.toString():e},date:function(e){return null!=e?new Date(1e3*e):e},datetime:function(e){return null!=e?new Date(1e3*e):e},time:function(e){return null!=e?parseInt(e):e},integer:function(e){return null!=e?parseInt(e):e},float:function(e){return null!=e?parseFloat(e):e},boolean:function(e){if(null===e)return e;if("boolean"==typeof e)return!0===e;if("string"==typeof e){if(""===e)return!1;if("true"===(e=e.replace(/^\s+|\s+$/g,"")).toLowerCase()||"yes"===e.toLowerCase())return!0;e=(e=e.replace(/,/g,".")).replace(/^\s*\-\s*/g,"-")}return!isNaN(e)&&0!==parseFloat(e)}},_t=.001,ft=1e3,pt=60,vt=1/pt,gt=60,mt=24,xt=1/mt,yt=3600,Ct=1/yt,bt=12*yt,Tt=1440,At=1/Tt,Et=86400,wt=864e5,Mt=1/wt,Pt=1/Et,Bt=36525,Lt=365.25,Rt=1e-9,St=2400000.5,Nt=2451545;function It(e){return(e-Nt)/Bt}function Ft(e,t,i){var r=(t-14)/12|0,s=e+4800+r;return(1461*s/4|0)+(367*(t-2-12*r)/12|0)-(3*((s+100)/100|0)/4|0)+i-32075}function zt(e){var t=Ft(e.getUTCFullYear(),e.getUTCMonth()+1,e.getUTCDate()),i=e.getUTCHours()-12;i<0&&(i+=24);var r=e.getUTCSeconds()+i*yt+e.getUTCMinutes()*pt+e.getUTCMilliseconds()*_t;r>=bt&&t--;var s=r*Pt|0;return t+=s,(r-=Et*s)<0&&(t--,r+=Et),t+r*Pt}function kt(e){return Dt(zt(e))}function Dt(e){var t=ti,i=ot(t,e,function(e,t){return e-t.jd});i<0&&(i=~i),i>=t.length&&(i=t.length-1);var r=t[i].leapSeconds;return 0!==i&&(t[i].jd-e)*Et>r&&(r=t[i-1].leapSeconds),e+r*Pt}function Ot(e){var t=ti,i=ot(t,e,function(e,t){return e-t.jd});if(i<0&&(i=~i),i>=t.length)return e-t[i-1].leapSeconds*Pt;if(0===i)return e-t[0].leapSeconds*Pt;var r=(t[i].jd-e)*Et;return 0===r?e-t[i].leapSeconds*Pt:r<=1?null:e-t[i-1].leapSeconds*Pt}function Vt(e){var t=0|e,i=(e-t)*Et;i>=bt&&t++;var r=t+68569|0,s=4*r/146097|0,n=4e3*((r=r-((146097*s+3)/4|0)|0)+1)/1461001|0,a=80*(r=r-(1461*n/4|0)+31|0)/2447|0,o=r-(2447*a/80|0)|0,h=a+2-12*(r=a/11|0)|0,l=100*(s-49)+n+r|0,u=i*Ct|0,d=i-u*yt,c=d*vt|0,_=0|(d-=c*pt),f=(d-_)*ft|0;return(u+=12)>23&&(u-=24),new Date(Date.UTC(l,h-1,o,u,c,_,f))}function Ut(e){var t=Ot(e);return t||(t=Ot(Wt(e,-1)),og.console.logWrn("TAItoDate:336 - can't conv utc.")),Vt(t)}function Ht(e,t){return e+t*Mt}function Wt(e,t){return e+t*Pt}function Gt(e,t){return e+t*xt}function Xt(e,t){return e+t*Tt}function Yt(e,t){return e+t}function jt(e){var t=e-(0|e);return((t*=Et)-(0|t))*ft|0}function qt(e){return(e-(0|e))*Et}function Zt(e){var t=(e-(0|e))*Et,i=t*Ct|0,r=t-i*yt,s=r*vt|0,n=0|(r-=s*pt);return(i+=12+s/60+n/3600+((r-n)*ft|0)/1e3)>23&&(i-=24),i}function Qt(e){return(e-(0|e))*Tt|0}function Kt(e){return 0|e}function Jt(e){return e*Pt}function $t(e){return e*Et}function ei(e,t){return{jd:e,leapSeconds:t}}const ti=[ei(2441317.5,10),ei(2441499.5,11),ei(2441683.5,12),ei(2442048.5,13),ei(2442413.5,14),ei(2442778.5,15),ei(2443144.5,16),ei(2443509.5,17),ei(2443874.5,18),ei(2444239.5,19),ei(2444786.5,20),ei(2445151.5,21),ei(2445516.5,22),ei(2446247.5,23),ei(2447161.5,24),ei(2447892.5,25),ei(2448257.5,26),ei(2448804.5,27),ei(2449169.5,28),ei(2449534.5,29),ei(2450083.5,30),ei(2450630.5,31),ei(2451179.5,32),ei(2453736.5,33),ei(2454832.5,34),ei(2456109.5,35),ei(2457204.5,36)],ii=Dt(Nt);class ri{constructor(){this.name="empty",this.minZoom=50,this.maxZoom=50,this.gridSizeByZoom=[32,16,16,8,4,4,4,4,2,2,2,2,2,2,2,2,2,2,2,2,2],this.fileGridSize=2,this._planet=null}handleSegmentTerrain(e){e.terrainIsLoading=!1,e.terrainReady=!0,e.terrainExists=!0}abortLoading(){}}const si=new class{constructor(){this._container=document.createElement("div"),this._container.classList.add("ogConsole"),this._container.style.display="none",document.body&&document.body.appendChild(this._container),this._visibility=!1}getVisibility(){return this._visibility}setVisibility(e){this._visibility!=e&&(this._visibility=e,this._visibility?this.show():this.hide())}show(){this._container.parentNode||document.body&&document.body.appendChild(this._container),this._container.style.display="block",this._visibility=!0}hide(){this._container.style.display="none",this._visibility=!1}logErr(e){var t=document.createElement("div");t.classList.add("ogConsole-text"),t.classList.add("ogConsole-error"),t.innerHTML="error: "+e,console.log(t.innerHTML),this._container.appendChild(t),this.show()}logWrn(e){var t=document.createElement("div");t.classList.add("ogConsole-text"),t.classList.add("ogConsole-warning"),t.innerHTML="warning: "+e,console.log(t.innerHTML),this._container.appendChild(t),this.show()}log(e,t){var i=document.createElement("div");if(i.classList.add("ogConsole-text"),t)for(var r in t)i.style[r]=t[r];i.innerHTML=e,console.log(e),this._container.appendChild(i),this.show()}};class ni{static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}constructor(e){this._eventNames=[],e&&this.registerNames(e),this._counter=0,this._stopPropagation=!1,this._stampCache={},this.__id=ni.__staticCounter++}registerNames(e){for(var t=0;t<e.length;t++)this[e[t]]={active:!0,handlers:[]},this._eventNames.push(e[t])}_stamp(e,t){var i=je(t),r=e+"_"+this.__id+"_"+i;return!this._stampCache[r]&&(this._stampCache[r]=i,!0)}on(e,t,i){this._stamp(e,t)&&this[e]&&this[e].handlers.unshift({sender:i||this,callback:t})}off(e,t){var i=e+"_"+this.__id+"_"+t._openglobus_id;if(t._openglobus_id&&this._stampCache[i]){for(var r=this[e].handlers,s=r.length,n=-1;s--;){if(r[s].callback._openglobus_id===t._openglobus_id){n=s;break}}-1!==n&&(r.splice(n,1),this._stampCache[i]=void 0,delete this._stampCache[i])}}dispatch(e,t){if(e&&e.active)for(var i=e.handlers,r=i.length;r--&&!this._stopPropagation;){var s=i[r];s.callback.call(s.sender,t)}this._stopPropagation=!1}stopPropagation(){this._stopPropagation=!0}clear(){for(var e=0;e<this._eventNames.length;e++){var t=this[this._eventNames[e]];t.handlers.length=0,t.handlers=[]}this._eventNames.length=0,this._eventNames=[]}}class ai{static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}constructor(e){e=e||{},this._id=ai._staticCounter++,this.name=e.name||"",this.events=new ni(["tick","end"]),this.startDate=e.startDate||0,this.endDate=e.endDate||0;var t=e.currentDate||zt(new Date);e.startDate&&t<e.startDate&&(t=e.startDate),e.endDate&&t>e.endDate&&(t=e.endDate),this.currentDate=t,this.multiplier=void 0!==e.multiplier?e.multiplier:1,this.deltaTicks=0,this.active=!0}setDate(e){var t=zt(e);this.startDate&&t<this.startDate&&(t=this.startDate),this.endDate&&t>this.endDate&&(t=this.endDate),this.currentDate=t}getDate(){return Vt(this.currentDate)}reset(){this.startDate&&(this.currentDate=this.startDate)}_tick(e){if(this.deltaTicks=e*this.multiplier,this.active){var t=Ht(this.currentDate,this.deltaTicks);this.multiplier>0?this.endDate&&t>this.endDate?(this.currentDate=this.startDate,this.events.dispatch(this.events.end,this)):this.currentDate=t:this.startDate&&t<this.startDate?(this.currentDate=this.endDate,this.events.dispatch(this.events.end,this)):this.currentDate=t,this.events.dispatch(this.events.tick,this)}}equal(e){return this._id===e._id}}class oi{constructor(e,t){this._canvas=document.createElement("canvas"),this._canvas.width=e||256,this._canvas.height=t||256,this._context=this._canvas.getContext("2d")}getCanvas(){return this._canvas}getContext(){return this._context}fillEmpty(){for(var e=this._context.getImageData(0,0,this._canvas.width,this._canvas.height),t=e.data,i=0,r=t.length;i<r;i+=4)t[i]=t[i+1]=t[i+2]=t[i+3]=0;this._context.putImageData(e,0,0)}getData(){return this._context.getImageData(0,0,this._canvas.width,this._canvas.height).data}fillColor(e){this._context.fillStyle=e,this._context.fillRect(0,0,this._canvas.width,this._canvas.height)}setData(e){var t=this._context.createImageData(this._canvas.width,this._canvas.height);t.data.set(e),this._context.putImageData(t,0,0)}resize(e,t){this._canvas.width=e,this._canvas.height=t,this._context=this._canvas.getContext("2d")}drawImage(e,t,i,r,s){this._context=this._canvas.getContext("2d"),this._context.drawImage(e,t||0,i||0,r||e.width,s||e.height)}getImage(){var e=new Image;return e.width=this.getWidth(),e.height=this.getHeight(),e.src=this._canvas.toDataURL("image/png"),e}getTextWidth(e){var t=this._context.measureText(e);return Math.round(t.width)}drawText(e,t,i,r,s){this._context.fillStyle=s||"black",this._context.font=r||"normal 14px Verdana",this._context.fillText(e,t||0,i||14)}getWidth(){return this._canvas.width}getHeight(){return this._canvas.height}loadImage(e,t){var i=new Image,r=this;i.onload=function(){r.resize(i.width,i.height),r._context.drawImage(i,0,0,i.width,i.height),t&&t(i)},i.src=e}openImage(){var e=this.getImage(),t="<!DOCTYPE html>";t+="<html>",t+="<head><title>Print</title></head>",t+="<body>",t+='<img src="'+e.src+'">',t+="</body>",t+="</html>";var i=window.open("","","width="+e.width+"px ,height="+e.height+"px");i.document.open(),i.document.write(t),i.document.close(),i.focus()}destroy(){this._canvas.width=1,this._canvas.height=1,this._canvas=null,this._context=null}}const hi=function(e,t){this._program=t,this._handler=e,this._activated=!1};hi.prototype.initialize=function(){this._program.createProgram(this._handler.gl)},hi.prototype.getProgram=function(){return this._program},hi.prototype.activate=function(){if(!this._activated){this._handler.activeShaderProgram.deactivate(),this._handler.activeShaderProgram=this;var e=this._program;this._activated=!0,e.enableAttribArrays(),e.use()}return this},hi.prototype.remove=function(){var e=this._handler.shaderPrograms;e[this._program.name]&&(this._activated&&this.deactivate(),this._program.delete(),e[this._program.name]=null,delete e[this._program.name])},hi.prototype.deactivate=function(){this._program.disableAttribArrays(),this._activated=!1},hi.prototype.isActive=function(){return this._activated},hi.prototype.set=function(e){return this.activate(),this._program.set(e),this},hi.prototype.drawIndexBuffer=function(e,t){return this._program.drawIndexBuffer(e,t),this},hi.prototype.drawArray=function(e,t){return this._program.drawArray(e,t),this};class li{constructor(){this.next=null,this.prev=null,this.data=null}}class ui{constructor(e=256){this._current=new li,this._head=this._current;for(var t=0;t<e;t++){var i=new li;i.prev=this._current,this._current.next=i,this._current=i}this._current=this._head}current(){return this._current}push(e){this._current=this._current.next,this._current.data=e}pop(e){return this._current=this._current.prev,this._current.next.data}popPrev(e){return this._current=this._current.prev,this._current.data}}const di=["","WEBKIT_","MOZ_"],ci=function(e,t){this.defaultClock=new ai,this._clocks=[],this.deltaTime=0,this.canvas=null,this.gl=null,this.shaderPrograms={},this.activeShaderProgram=null,this._params=t||{},this._params.anisotropy=this._params.anisotropy||8;var i=this._params.width;i>4096&&(i=4096),this._params.width=i||256;var r=this._params.height;r>4096&&(r=4096),this._params.height=r||256,this._params.context=this._params.context||{},this._params.extensions=this._params.extensions||[],this._oneByHeight=1/this._params.height,this.extensions={},this._id=e,this._lastAnimationFrameTime=0,this._initialized=!1,this._frameCallback=function(){},this.transparentTexture=null,this.framebufferStack=new ui,t.autoActivate&&this.initialize()};ci.getExtension=function(e,t){var i,r;for(i in di)if(r=e.getExtension(di[i]+t))return r;return null},ci.getContext=function(e,t){var i;try{i=e.getContext("webgl",t)||e.getContext("experimental-webgl",t)}catch(e){si.logErr("exception during the GL context initialization")}return i||si.logErr("could not initialise WebGL"),i},ci.prototype.setFrameCallback=function(e){e&&(this._frameCallback=e)},ci.prototype.createTexture_n=function(e){var t=this.gl,i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null),i},ci.prototype.createEmptyTexture_hf=function(e,t){var i=this.gl,r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.HALF_FLOAT_OES,null),i.bindTexture(i.TEXTURE_2D,null),r},ci.prototype.createEmptyTexture_f=function(e,t){var i=this.gl,r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.FLOAT,null),i.bindTexture(i.TEXTURE_2D,null),r},ci.prototype.createEmptyTexture_n=function(e,t){var i=this.gl,r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.bindTexture(i.TEXTURE_2D,null),r},ci.prototype.createEmptyTexture_l=function(e,t){var i=this.gl,r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.bindTexture(i.TEXTURE_2D,null),r},ci.prototype.createTexture_l=function(e){var t=this.gl,i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null),i},ci.prototype.createTexture_mm=function(e){var t=this.gl,i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.generateMipmap(t.TEXTURE_2D),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null),i},ci.prototype.createTexture_a=function(e){var t=this.gl,i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.generateMipmap(t.TEXTURE_2D),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameterf(t.TEXTURE_2D,this.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._params.anisotropy),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null),i},ci.prototype.createTexture=function(e){return this.createTexture_a(e)},ci.prototype.loadCubeMapTexture=function(e){var t=this.gl,i=t.createTexture();t.bindTexture(t.TEXTURE_CUBE_MAP,i),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR);var r=[[e.px,t.TEXTURE_CUBE_MAP_POSITIVE_X],[e.nx,t.TEXTURE_CUBE_MAP_NEGATIVE_X],[e.py,t.TEXTURE_CUBE_MAP_POSITIVE_Y],[e.ny,t.TEXTURE_CUBE_MAP_NEGATIVE_Y],[e.pz,t.TEXTURE_CUBE_MAP_POSITIVE_Z],[e.nz,t.TEXTURE_CUBE_MAP_NEGATIVE_Z]],s=new oi;s.fillEmpty();for(var n=s.getImage(),a=0;a<r.length;a++){var o=r[a][1];t.bindTexture(t.TEXTURE_CUBE_MAP,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(o,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n)}for(a=0;a<r.length;a++){o=r[a][1];var h=new Image;h.crossOrigin="",h.onload=function(e,i,r){return function(){t.bindTexture(t.TEXTURE_CUBE_MAP,e),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(i,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)}}(i,o,h),h.src=r[a][0]}return i},ci.prototype.addShaderProgram=function(e,t){if(this.shaderPrograms[e.name])!COMPILED&&si.logWrn("og.webgl.Handler:284 - shader program: '"+e.name+"' is allready exists.");else{var i=new hi(this,e);this.shaderPrograms[e.name]=i,this._initShaderController(i),t&&(i._activated=!1)}return e},ci.prototype.removeShaderProgram=function(e){this.shaderPrograms[e]&&this.shaderPrograms[e].remove()},ci.prototype.addShaderPrograms=function(e){for(var t=0;t<e.length;t++)this.addShaderProgram(e[t])},ci.prototype._initShaderController=function(e){this._initialized&&(e.initialize(),this.activeShaderProgram?(e.deactivate(),this.activeShaderProgram._program.enableAttribArrays(),this.activeShaderProgram._program.use()):(this.activeShaderProgram=e,e.activate()))},ci.prototype._initShaderPrograms=function(){for(var e in this.shaderPrograms)this._initShaderController(this.shaderPrograms[e])},ci.prototype.initializeExtension=function(e,t){if(!this.extensions||!this.extensions[e]){var i=ci.getExtension(this.gl,e);i?this.extensions[e]=i:t&&!COMPILED&&si.logWrn("og.webgl.Handler: extension '"+e+"' doesn't initialize.")}return this.extensions&&this.extensions[e]},ci.prototype.initialize=function(){this._id?this.canvas=document.getElementById(this._id):(this.canvas=document.createElement("canvas"),this.canvas.width=this._params.width,this.canvas.height=this._params.height),this.gl=ci.getContext(this.canvas,this._params.context),this._initialized=!0,this._params.extensions.push("OES_standard_derivatives"),this._params.extensions.push("EXT_texture_filter_anisotropic"),this._params.extensions.push("OES_element_index_uint");for(var e=this._params.extensions.length;e--;)this.initializeExtension(this._params.extensions[e],!0);this.extensions.EXT_texture_filter_anisotropic||(this.createTexture=this.createTexture_mm),this._initShaderPrograms(),this._setDefaults()},ci.prototype._setDefaults=function(){this.activateDepthTest(),this.setSize(this._params.width,this._params.height),this.gl.frontFace(this.gl.CCW),this.gl.cullFace(this.gl.BACK),this.activateFaceCulling(),this.deactivateBlending();var e=this;this.createDefaultTexture({color:"rgba(0,0,0,0.0)"},function(t){e.transparentTexture=t})},ci.prototype.activateDepthTest=function(){this.gl.enable(this.gl.DEPTH_TEST)},ci.prototype.deactivateDepthTest=function(){this.gl.disable(this.gl.DEPTH_TEST)},ci.prototype.activateFaceCulling=function(){this.gl.enable(this.gl.CULL_FACE)},ci.prototype.deactivateFaceCulling=function(){this.gl.disable(this.gl.CULL_FACE)},ci.prototype.activateBlending=function(){this.gl.enable(this.gl.BLEND)},ci.prototype.deactivateBlending=function(){this.gl.disable(this.gl.BLEND)},ci.prototype.createArrayBuffer=function(e,t,i,r){var s=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,r||this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),s.itemSize=t,s.numItems=i,s},ci.prototype.createElementArrayBuffer=function(e,t,i,r){var s=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,s),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,e,r||this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null),s.itemSize=t,s.numItems=i||e.length,s},ci.prototype.setSize=function(e,t){e>4096&&(e=4096),t>4096&&(t=4096),this._params.width=e,this._params.height=t,this.canvas.width=e,this.canvas.height=t,this._oneByHeight=1/t,this.gl&&this.gl.viewport(0,0,e,t),this.onCanvasResize&&this.onCanvasResize(this.canvas)},ci.prototype.getWidth=function(){return this.canvas.width},ci.prototype.getHeight=function(){return this.canvas.height},ci.prototype.getClientAspect=function(){return this.canvas.clientWidth/this.canvas.clientHeight},ci.prototype.getCenter=function(){var e=this.canvas;return new Xe(Math.round(.5*e.width),Math.round(.5*e.height))},ci.prototype.drawFrame=function(){var e=(new Date).getTime();this.deltaTime=e-this._lastAnimationFrameTime,this._lastAnimationFrameTime=e,this.defaultClock._tick(this.deltaTime);for(var t=0;t<this._clocks.length;t++)this._clocks[t]._tick(this.deltaTime);var i=this.canvas;i.clientWidth===i.width&&i.clientHeight===i.height||this.setSize(i.clientWidth,i.clientHeight),this._frameCallback()},ci.prototype.clearFrame=function(){var e=this.gl;this.gl.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)},ci.prototype.start=function(){if(!this._requestAnimationFrameId&&this._initialized){var e=new Date;this._lastAnimationFrameTime=e.getTime(),this.defaultClock.setDate(e),this._animationFrameCallback()}},ci.prototype.stop=function(){this._requestAnimationFrameId&&(window.cancelAnimationFrame(this._requestAnimationFrameId),this._requestAnimationFrameId=null)},ci.prototype._animationFrameCallback=function(){this._requestAnimationFrameId=window.requestAnimationFrame(()=>{this.drawFrame(),this._animationFrameCallback()})},ci.prototype.createDefaultTexture=function(e,t){var i,r;if(e&&e.color)(i=new oi(2,2)).fillColor(e.color),(r=this.createTexture_n(i._canvas)).default=!0,t(r);else if(e&&e.url){var s=new Image,n=this;s.onload=function(){(r=n.createTexture(this)).default=!0,t(r)},s.src=e.url}else(i=new oi(2,2)).fillColor("#C5C5C5"),(r=this.createTexture_n(i._canvas)).default=!0,t(r)},ci.prototype.destroy=function(){var e=this.gl;for(var t in this.stop(),this.shaderPrograms)this.removeShaderProgram(t);e.deleteTexture(this.transparentTexture),this.transparentTexture=null,this.framebufferStack=null,this.framebufferStack=new ui,this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null;var i=e.getParameter(e.MAX_VERTEX_ATTRIBS),r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r);for(var s=0;s<i;++s)e.disableVertexAttribArray(s),e.vertexAttribPointer(s,4,e.FLOAT,!1,0,0),e.vertexAttrib1f(s,0);e.deleteBuffer(r);var n=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);for(s=0;s<n;++s)e.activeTexture(e.TEXTURE0+s),e.bindTexture(e.TEXTURE_CUBE_MAP,null),e.bindTexture(e.TEXTURE_2D,null);e.activeTexture(e.TEXTURE0),e.useProgram(null),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.DITHER),e.disable(e.SCISSOR_TEST),e.blendColor(0,0,0,0),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.clearColor(0,0,0,0),e.clearDepth(1),e.clearStencil(-1),this.gl=null,this._initialized=!1},ci.prototype.addClock=function(e){e.__handler||(e.__handler=this,this._clocks.push(e))},ci.prototype.addClocks=function(e){for(var t=0;t<e.length;t++)this.addClock(e[t])},ci.prototype.removeClock=function(e){if(e.__handler)for(var t=this._clocks,i=t.length;i--;)if(t[i].equal(e)){e.__handler=null,t.splice(i,1);break}};let _i=["FLOAT","DOUBLE","BOOL","INT","UINT","VEC2","VEC3","VEC4","DVEC2","DVEC3","DVEC4","BVEC2","BVEC3","BVEC4","IVEC2","IVEC3","IVEC4","UVEC2","UVEC3","UVEC4","MAT2","DMAT2","MAT3","DMAT3","MAT4","DMAT4","MAT2X3","MAT2X4","MAT3X2","MAT3X4","MAT4X2","MAT4X3","DMAT2X3","DMAT2X4","DMAT3X2","DMAT3X4","DMAT4X2","DMAT4X3","SAMPLER1D","SAMPLER2D","SAMPLER3D","SAMPLERCUBE","SAMPLER2DSHADOW","SAMPLER2DXX","INTXX","FLOATXX"];const fi={};!function(){for(let e=0;e<_i.length;e++)fi[_i[e]]=e}();const pi={u:[],a:[]};pi.u[fi.MAT4]=function(e,t){e.gl.uniformMatrix4fv(t._pName,!1,t.value)},pi.u[fi.MAT3]=function(e,t){e.gl.uniformMatrix3fv(t._pName,!1,t.value)},pi.u[fi.FLOAT]=function(e,t){e.gl.uniform1f(t._pName,t.value)},pi.u[fi.INT]=function(e,t){e.gl.uniform1i(t._pName,t.value)},pi.u[fi.VEC2]=function(e,t){e.gl.uniform2fv(t._pName,t.value)},pi.u[fi.VEC3]=function(e,t){e.gl.uniform3fv(t._pName,t.value)},pi.u[fi.VEC4]=function(e,t){e.gl.uniform4fv(t._pName,t.value)},pi.u[fi.SAMPLER2D]=function(e,t){let i=e.gl;i.activeTexture(i.TEXTURE0+e._textureID),i.bindTexture(i.TEXTURE_2D,t.value),i.uniform1i(t._pName,e._textureID),e._textureID++},pi.u[fi.SAMPLERCUBE]=function(e,t){let i=e.gl;i.activeTexture(i.TEXTURE0+e._textureID),i.bindTexture(i.TEXTURE_CUBE_MAP,t.value),i.uniform1i(t._pName,e._textureID),e._textureID++},pi.u[fi.SAMPLER2DXX]=function(e,t){let i=e.gl,r=t.value.length,s=new Int32Array(r);for(let n=0;n<r;n++)i.activeTexture(i.TEXTURE0+e._textureID+n),i.bindTexture(i.TEXTURE_2D,t.value[n]),s[n]=n;i.uniform1iv(t._pName,s)},pi.u[fi.INTXX]=function(e,t){pgl.uniform1iv(t._pName,t.value)},pi.u[fi.FLOATXX]=function(e,t){e.gl.uniform1fv(t._pName,t.value)},pi.a[fi.FLOAT]=function(e,t){e.gl.vertexAttrib1f(t._pName,t.value)},pi.a[fi.VEC2]=function(e,t){e.gl.vertexAttrib2fv(t._pName,t.value)},pi.a[fi.VEC3]=function(e,t){e.gl.vertexAttrib3fv(t._pName,t.value)},pi.a[fi.VEC4]=function(e,t){e.gl.vertexAttrib4fv(t._pName,t.value)};class vi{constructor(e,t){this.name=e,this.attributes=t.attributes,this.uniforms=t.uniforms,this.vertexShader=t.vertexShader,this.fragmentShader=t.fragmentShader,this.gl=null,this._variables={},this._p=null,this._textureID=0,this._attribArrays=[]}use(){this.gl.useProgram(this._p)}set(e){for(var t in this._textureID=0,e)this._variables[t].value=e[t],this._variables[t]._callback(this,this._variables[t])}apply(){this._textureID=0;var e=this._variables;for(var t in e)e[t]._callback(this,e[t])}drawIndexBuffer(e,t){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,t),this.gl.drawElements(e,t.numItems,this.gl.UNSIGNED_SHORT,0)}drawArray(e,t){this.gl.drawArrays(e,0,t)}_getShaderCompileStatus(e,t){return this.gl.shaderSource(e,t),this.gl.compileShader(e),!!this.gl.getShaderParameter(e,this.gl.COMPILE_STATUS)||(si.logErr("og/shaderProgram/ShaderProgram:"+this.name+" - "+this.gl.getShaderInfoLog(e)+"."),!1)}_createVertexShader(e){var t=this.gl.createShader(this.gl.VERTEX_SHADER);return this._getShaderCompileStatus(t,e)?t:null}_createFragmentShader(e){var t=this.gl.createShader(this.gl.FRAGMENT_SHADER);return this._getShaderCompileStatus(t,e)?t:null}disableAttribArrays(){for(var e=this.gl,t=this._attribArrays,i=t.length;i--;)e.disableVertexAttribArray(t[i])}enableAttribArrays(){for(var e=this.gl,t=this._attribArrays,i=t.length;i--;)e.enableVertexAttribArray(t[i])}delete(){this.gl.deleteProgram(this._p)}createProgram(e){this.gl=e,this._p=this.gl.createProgram();var t=this._createFragmentShader(this.fragmentShader),i=this._createVertexShader(this.vertexShader);if(e.attachShader(this._p,t),e.attachShader(this._p,i),e.linkProgram(this._p),!e.getProgramParameter(this._p,e.LINK_STATUS))return si.logErr("og/shaderProgram/ShaderProgram:"+this.name+" - couldn't initialise shaders. "+e.getProgramInfoLog(this._p)+"."),void e.deleteProgram(this._p);for(var r in this.use(),this.attributes){if(this.attributes[r]._name=r,this._variables[r]=this.attributes[r],this.attributes[r].enableArray=void 0==this.attributes[r].enableArray||this.attributes[r].enableArray,this.attributes[r].enableArray?this.attributes[r]._callback=vi.bindBuffer:this.attributes[r]._callback=pi.a[this.attributes[r].type],this._p[r]=e.getAttribLocation(this._p,r),void 0==this._p[r])return si.logErr("og/shaderProgram/ShaderProgram:"+this.name+" - attribute '"+r+"' is not exists."),void e.deleteProgram(this._p);this.attributes[r].enableArray&&(this._attribArrays.push(this._p[r]),e.enableVertexAttribArray(this._p[r])),this.attributes[r]._pName=this._p[r]}for(var s in this.uniforms){if(this.uniforms[s]._name=s,this.uniforms[s]._callback=pi.u[this.uniforms[s].type],this._variables[s]=this.uniforms[s],this._p[s]=e.getUniformLocation(this._p,s),void 0==this._p[s])return si.logErr("og/shaderProgram/ShaderProgram:"+this.name+" - uniform '"+s+"' is not exists."),void e.deleteProgram(this._p);this.uniforms[s]._pName=this._p[s]}e.detachShader(this._p,t),e.detachShader(this._p,i)}static bindBuffer(e,t){var i=e.gl;i.bindBuffer(i.ARRAY_BUFFER,t.value),i.vertexAttribPointer(t._pName,t.value.itemSize,i.FLOAT,!1,0,0)}}const gi=0,mi=0,xi=1,yi=2,Ci=3,bi=0,Ti=1,Ai=[yi,Ci,mi,xi],Ei=[[-1,-1,gi,1],[1,-1,3,-1],[2,3,-1,-1],[-1,gi,-1,2]],wi=[[2,3,gi,1],[1,gi,3,2],[2,3,gi,1],[1,gi,3,2]],Mi=6,Pi=function(e){for(var t=[],i=0;i<=e;i++){var r=Math.pow(2,i),s=t[r]=[];Si(r+1,s)}return t[0]=[],t}(Mi),Bi=function(e){var t=[];t[mi]=[],t[Ci]=[],t[yi]=[],t[xi]=[],t[mi][0]=[],t[Ci][0]=[],t[yi][0]=[],t[xi][0]=[];for(var i=0;i<=e;i++){var r=Math.pow(2,i);t[mi][r]=[],t[Ci][r]=[],t[yi][r]=[],t[xi][r]=[],t[mi][r][0]=[],t[Ci][r][0]=[],t[yi][r][0]=[],t[xi][r][0]=[];for(var s=0;s<=e;s++){var n=Math.pow(2,s),a=t[mi][r][n]=[],o=t[Ci][r][n]=[],h=t[yi][r][n]=[],l=t[xi][r][n]=[];Ni(r+1,n,o),Ii(r+1,n,a),Fi(r+1,n,l),zi(r+1,n,h)}}return t}(Mi),Li=function(e){for(var t=[],i=0;i<=e;i++){var r=Math.pow(2,i);t[r]=ki(r)}return t[0]=[],t}(Mi);function Ri(e,t){if(1!=e){var i=Pi[e],r=Bi[Ci][e][t[Ci]],s=Bi[mi][e][t[mi]],n=Bi[xi][e][t[xi]],a=Bi[yi][e][t[yi]],o=new Uint16Array(i.length+r.length+s.length+n.length+a.length),h=0,l=0;for(h=0;h<i.length;h++)o[l++]=i[h];for(h=0;h<r.length;h++)o[l++]=r[h];for(h=0;h<s.length;h++)o[l++]=s[h];for(h=0;h<n.length;h++)o[l++]=n[h];for(h=0;h<a.length;h++)o[l++]=a[h];return o}return new Uint16Array([0,2,1,3])}function Si(e,t){for(var i,r,s,n=1;n<e-1-1;n++){for(var a=1;a<e-1;a++)i=n*e+a,r=(s=(n+1)*e)+a,t.push(i,r);t.push(r,s+1)}t.push(t[t.length-1],e*e-e)}function Ni(e,t,i){for(var r=(e-1)/t,s=e*e-e,n=0,a=0;a<e-2;a++){a%r==0&&(n=a);var o=s-e*a-e+1,h=s-e*n;i.push(h,o)}t===e-1&&(i.push(e),i.push(0))}function Ii(e,t,i){for(var r=(e-1)/t,s=0,n=0;n<e-2;n++){n%r==0&&(s=n);var a=e+n+1,o=s;i.push(o,a)}t===e-1&&(i.push(e-2),i.push(e-1))}function Fi(e,t,i){for(var r=(e-1)/t,s=0,n=0;n<e-2;n++){n%r==0&&(s=n);var a=e*(n+1)+e-2,o=e+e*s-1;i.push(o,a)}t===e-1&&(i.push(e*(e-1)-1),i.push(e*e-1))}function zi(e,t,i){for(var r=(e-1)/t,s=0,n=e*(e-1)-2,a=e*e-1,o=0;o<e-2;o++){o%r==0&&(s=o);var h=n-o,l=a-s;i.push(l,h)}t===e-1&&i.push(e*e-e+1),i.push(e*e-e)}function ki(e){for(var t=[],i=0;i<=e;i++)for(var r=0;r<=e;r++)t.push(r/e,i/e);return new Float32Array(t)}const Di="degrees",Oi="m",Vi="km",Ui={ft:.3048};Ui[Oi]=1,Ui[Vi]=1e3;const Hi=function(e){this.code=e.code,this.units=e.units,this.id=Hi._counter++};Hi.prototype.equal=function(e){return e.id==this.id},Hi._counter=0;const Wi=new Hi({code:"epsg:3857",units:Oi}),Gi=function(e,t){t=t||{},this.handler=e,this._fbo=null,this._rbo=null,this._width=t.width||e.canvas.width,this._height=t.height||e.canvas.height,this._useDepth=void 0==t.useDepth||t.useDepth,this._active=!1,this.texture=t.texture||null};Gi.prototype.destroy=function(){var e=this.handler.gl;e.deleteTexture(this.texture),e.deleteFramebuffer(this._fbo),e.deleteRenderbuffer(this._rbo),this.texture=null,this._rbo=null,this._fbo=null,this._active=!1},Gi.prototype.init=function(){var e=this.handler.gl;this._fbo=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._fbo),!this.texture&&this.bindOutputTexture(this.handler.createEmptyTexture_l(this._width,this._height)),this._useDepth&&(this._rbo=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this._rbo),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this._width,this._height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this._rbo),e.bindRenderbuffer(e.RENDERBUFFER,null)),e.bindFramebuffer(e.FRAMEBUFFER,null)},Gi.prototype.bindOutputTexture=function(e){var t=this.handler.gl;this.texture=e,t.bindTexture(t.TEXTURE_2D,e),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture,0),t.bindTexture(t.TEXTURE_2D,null)},Gi.prototype.setSize=function(e,t){this._width=e,this._height=t,this._active&&this.handler.gl.viewport(0,0,this._width,this._height),this._useDepth&&(this.destroy(),this.init())},Gi.prototype.isComplete=function(){var e=this.handler.gl;return e.checkFramebufferStatus(e.FRAMEBUFFER)==e.FRAMEBUFFER_COMPLETE},Gi.prototype.readAllPixels=function(){var e=this.handler.gl;e.bindFramebuffer(e.FRAMEBUFFER,this._fbo);var t=new Uint8Array(4*this._width*this._height);return e.readPixels(0,0,this._width,this._height,e.RGBA,e.UNSIGNED_BYTE,t),e.bindFramebuffer(e.FRAMEBUFFER,null),t},Gi.prototype.readPixel=function(e,t){var i=this.handler.gl;i.bindFramebuffer(i.FRAMEBUFFER,this._fbo);var r=new Uint8Array(4);return i.readPixels(e*this._width,t*this._height,1,1,i.RGBA,i.UNSIGNED_BYTE,r),i.bindFramebuffer(i.FRAMEBUFFER,null),r},Gi.prototype.activate=function(){var e=this.handler.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,this._fbo),e.viewport(0,0,this._width,this._height),this._active=!0;var t=this.handler.framebufferStack.current().data;return t&&(t._active=!1),this.handler.framebufferStack.push(this),this},Gi.prototype.deactivate=function(){var e=this.handler,t=e.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),this._active=!1;var i=this.handler.framebufferStack.popPrev();i?(t.bindFramebuffer(t.FRAMEBUFFER,i._fbo),t.viewport(0,0,i._width,i._height)):t.viewport(0,0,e.canvas.width,e.canvas.height)},Gi.prototype.getImage=function(){var e=this.readAllPixels(),t=new oi(this._width,this._height);return t.setData(e),t.getImage()},Gi.prototype.openImage=function(){var e=this.getImage(),t="<!DOCTYPE html>";t+="<html>",t+="<head><title>Print</title></head>",t+="<body>",t+='<img src="'+e.src+'">',t+="</body>",t+="</html>";var i=window.open("","","width="+e.width+"px ,height="+e.height+"px");i.document.open(),i.document.write(t),i.document.close(),i.focus()};const Xi=function(e,t){this._gridSize=64,this._handler=e,this._framebuffer=null,this._texCoordsBuffer=null,this._indexBuffer=null,this.MAX_FRAMES=t||5,this._currentFrame=0,this._queue=[],this._animate=[],this._initialize()};Xi.prototype._initialize=function(){this._initShaders(),this._initBuffers()},Xi.prototype.createGridBuffer=function(e,t){for(var i=this._gridSize,r=new De((e[3].lon-e[0].lon)/i,(e[3].lat-e[0].lat)/i),s=new De((e[2].lon-e[1].lon)/i,(e[2].lat-e[1].lat)/i),n=new De((e[1].lon-e[0].lon)/i,(e[1].lat-e[0].lat)/i),a=new De((e[2].lon-e[3].lon)/i,(e[2].lat-e[3].lat)/i),o=new Float32Array((i+1)*(i+1)*2),h=0,l=0;l<=i;l++)for(var u=new De(e[0].lon+l*r.lon,e[0].lat+l*r.lat),d=new De(e[1].lon+l*s.lon,e[1].lat+l*s.lat),c=0;c<=i;c++){var _=ut(u,d,new De(e[0].lon+c*n.lon,e[0].lat+c*n.lat),new De(e[3].lon+c*a.lon,e[3].lat+c*a.lat));o[h++]=_.lon,o[h++]=_.lat}if(t)for(l=0;l<o.length;l+=2){e=new De(o[l],o[l+1]).forwardMercator();o[l]=e.lon,o[l+1]=e.lat}return this._handler.createArrayBuffer(o,2,o.length/2)},Xi.prototype.frame=function(){for(var e=this.MAX_FRAMES;e--&&this._queue.length;){var t=this._queue.shift();t._isRendering=!1,t.rendering()}for(e=this._animate.length;e--;)this._animate[e].rendering()},Xi.prototype.add=function(e){e._isRendering||(e._isRendering=!0,e._animate?this._animate.push(e):this._queue.push(e))},Xi.prototype.remove=function(e){if(e._isRendering){var t;e._creationProceeding=!1,e._isRendering=!1,t=e._animate?this._animate:this._queue;for(var i=0;i<t.length;i++)if(t[i].isEqual(e))return void t.splice(i,1)}},Xi.prototype._initBuffers=function(){this._framebuffer=new Gi(this._handler,{width:2,height:2,useDepth:!1}),this._framebuffer.init(),this._framebufferMercProj=new Gi(this._handler,{width:2,height:2,useDepth:!1}),this._framebufferMercProj.init();var e=this._gridSize,t=this._gridSize+1;this._texCoordsBuffer=this._handler.createArrayBuffer(Li[e],2,t*t);var i=Ri(e,[e,e,e,e]);this._indexBuffer=this._handler.createElementArrayBuffer(i,1,i.length),this._quadTexCoordsBuffer=this._handler.createArrayBuffer(new Float32Array([0,1,1,1,0,0,1,0]),2,4),this._quadVertexBuffer=this._handler.createArrayBuffer(new Float32Array([-1,1,1,1,-1,-1,1,-1]),2,4)},Xi.prototype._initShaders=function(){this._handler.addShaderProgram(new vi("geoImageTransform",{uniforms:{sourceTexture:{type:fi.SAMPLER2D},extentParams:{type:fi.VEC4}},attributes:{corners:{type:fi.VEC2,enableArray:!0},texCoords:{type:fi.VEC2,enableArray:!0}},vertexShader:"attribute vec2 corners;                       attribute vec2 texCoords;                       varying vec2 v_texCoords;                       uniform vec4 extentParams;                       void main() {                           v_texCoords = texCoords;                           gl_Position = vec4((-1.0 + (corners - extentParams.xy) * extentParams.zw) * vec2(1.0, -1.0), 0.0, 1.0);                       }",fragmentShader:"precision highp float;\n                        uniform sampler2D sourceTexture;                         varying vec2 v_texCoords;                         void main () {                              gl_FragColor = texture2D(sourceTexture, v_texCoords);                         }"}))};class Yi{constructor(e){e=e||{},this.id=Yi._staticCounter++,this._position=tt(e.position),this._rotation=e.rotation||0,this._color=rt(e.color),this._alignedAxis=tt(e.alignedAxis),this._offset=tt(e.offset),this._visibility=void 0==e.visibility||e.visibility,this._scale=e.scale||1,this._entity=null,this._handler=null,this._handlerIndex=-1}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}setPosition(e,t,i){this._position.x=e,this._position.y=t,this._position.z=i,this._handler&&this._handler.setPositionArr(this._handlerIndex,this._position)}setPosition3v(e){this._position.x=e.x,this._position.y=e.y,this._position.z=e.z,this._handler&&this._handler.setPositionArr(this._handlerIndex,e)}getPosition(){return this._position}setOffset(e,t,i){this._offset.x=e,this._offset.y=t,void 0!=i&&(this._offset.z=i),this._handler&&this._handler.setOffsetArr(this._handlerIndex,this._offset)}setScale(e){this._scale=e,this._handler&&this._handler.setScaleArr(this._handlerIndex,e)}getScale(){return this._scale}setOffset3v(e){this._offset.x=e.x,this._offset.y=e.y,void 0!=e.z&&(this._offset.z=e.z),this._handler&&this._handler.setOffsetArr(this._handlerIndex,e)}getOffset(){return this._offset}setRotation(e){this._rotation=e,this._handler&&this._handler.setRotationArr(this._handlerIndex,e)}getRotation(){return this._rotation}setOpacity(e){this._color.w=e,this.setColor(this._color.x,this._color.y,this._color.z,e)}setColor(e,t,i,r){this._color.x=e,this._color.y=t,this._color.z=i,void 0!=r&&(this._color.w=r),this._handler&&this._handler.setRgbaArr(this._handlerIndex,this._color)}setColor4v(e){this._color.x=e.x,this._color.y=e.y,this._color.z=e.z,void 0!=e.w&&(this._color.w=e.w),this._handler&&this._handler.setRgbaArr(this._handlerIndex,e)}setColorHTML(e){this.setColor4v(Qe(e))}getColor(){return this._color}setVisibility(e){this._visibility=e,this._handler&&this._handler.setVisibility(this._handlerIndex,e)}getVisibility(){return this._visibility}setAlignedAxis(e,t,i){this._alignedAxis.x=e,this._alignedAxis.y=t,this._alignedAxis.z=i,this._handler&&this._handler.setAlignedAxisArr(this._handlerIndex,this._alignedAxis)}setAlignedAxis3v(e){this._alignedAxis.x=e.x,this._alignedAxis.y=e.y,this._alignedAxis.z=e.z,this._handler&&this._handler.setAlignedAxisArr(this._handlerIndex,e)}getAlignedAxis(){return this._alignedAxis}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(e){this._handler&&this._handler.setPickingColorArr(this._handlerIndex,e)}}class ji extends Yi{constructor(e){super(e),e=e||{},this._src=e.src||null,this._image=e.image||null,this._width=e.width||(e.size?e.size[0]:30),this._height=e.height||(e.size?e.size[1]:30)}setSrc(e){this._src=e;var t=this._handler;if(t&&e){var i=t._entityCollection.renderNode;if(i){var r=i.billboardsTextureAtlas,s=this;r.loadImage(e,function(e){r.nodes[e.__nodeIndex]?(s._image=e,t.setTexCoordArr(s._handlerIndex,r.nodes[s._image.__nodeIndex].texCoords)):(r.addImage(e),r.createTexture(),s._image=e,i.updateBillboardsTexCoords())})}}}setImage(e){this.setSrc(e.src)}setSize(e,t){this._width=e,this._height=t,this._handler&&this._handler.setSizeArr(this._handlerIndex,e*this._scale,t*this._scale)}getSize(){return{width:this._width,height:this._height}}setWidth(e){this.setSize(e,this._height)}getWidth(){return this._width}setHeight(e){this.setSize(this._width,e)}getHeight(){return this._height}}const qi={POINT:1,LINESTRING:2,POLYGON:3,MULTIPOLYGON:4,MULTILINESTRING:5};class Zi{constructor(e){this._id=Zi._staticCounter++,(e=e||{}).style=e.style||{},this._entity=null,this._handler=null,this._handlerIndex=-1,this._polyVerticesMerc=[],this._polyVerticesLength=-1,this._polyIndexesLength=-1,this._polyVerticesHandlerIndex=-1,this._polyIndexesHandlerIndex=-1,this._lineVerticesMerc=[],this._lineVerticesLength=-1,this._lineOrdersLength=-1,this._lineIndexesLength=-1,this._lineColorsLength=-1,this._lineThicknessLength=-1,this._lineVerticesHandlerIndex=-1,this._lineOrdersHandlerIndex=-1,this._lineIndexesHandlerIndex=-1,this._lineThicknessHandlerIndex=-1,this._lineColorsHandlerIndex=-1,this._type=e.type&&Zi.getType(e.type)||qi.POINT,this._coordinates=[],this._extent=Zi.getExtent({type:e.type||"Point",coordinates:e.coordinates||[]},this._coordinates),this._style=e.style||{},this._style.fillColor=rt(e.style.fillColor,new Ve(.19,.62,.85,.4)),this._style.lineColor=rt(e.style.lineColor,new Ve(.19,.62,.85,1)),this._style.strokeColor=rt(e.style.strokeColor,new Ve(1,1,1,.95)),this._style.lineWidth=e.style.lineWidth||3,this._style.strokeWidth=e.style.strokeWidth||0,this._visibility=e.visibility||!0,this._pickingReady=!1}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}static getType(e){return qi[e.toUpperCase()]}static getExtent(e,t){var i=new Oe(new De(180,90),new De(-180,-90)),r=Zi.getType(e.type);if(r===qi.POINT){var s=i.coordinates[0],n=i.coordinates[1];i.southWest.lon=s,i.southWest.lat=n,i.northEast.lon=s,i.northEast.lat=n,t&&(t[0]=s)&&(t[1]=n)}else if(r===qi.LINESTRING)for(var a=e.coordinates,o=0;o<a.length;o++){s=a[o][0],n=a[o][1];s<i.southWest.lon&&(i.southWest.lon=s),n<i.southWest.lat&&(i.southWest.lat=n),s>i.northEast.lon&&(i.northEast.lon=s),n>i.northEast.lat&&(i.northEast.lat=n),t&&(t[o]=[s,n])}else if(r===qi.POLYGON)for(a=e.coordinates,o=0;o<a.length;o++){var h=a[o];t&&(t[o]=[]);for(var l=0;l<h.length;l++){s=(p=h[l])[0],n=p[1];s<i.southWest.lon&&(i.southWest.lon=s),n<i.southWest.lat&&(i.southWest.lat=n),s>i.northEast.lon&&(i.northEast.lon=s),n>i.northEast.lat&&(i.northEast.lat=n),t&&(t[o][l]=[s,n])}}else if(r===qi.MULTIPOLYGON){var u=e.coordinates;for(o=0;o<u.length;o++){var d=u[o];t&&(t[o]=[]);for(l=0;l<d.length;l++){var c=d[l];t&&(t[o][l]=[]);for(var _=0;_<c.length;_++){var f=c[_];s=f[0],n=f[1];s<i.southWest.lon&&(i.southWest.lon=s),n<i.southWest.lat&&(i.southWest.lat=n),s>i.northEast.lon&&(i.northEast.lon=s),n>i.northEast.lat&&(i.northEast.lat=n),t&&(t[o][l][_]=[s,n])}}}}else if(r===qi.MULTILINESTRING)for(a=e.coordinates,o=0;o<a.length;o++){h=a[o];t&&(t[o]=[]);for(l=0;l<h.length;l++){var p;s=(p=h[l])[0],n=p[1];s<i.southWest.lon&&(i.southWest.lon=s),n<i.southWest.lat&&(i.southWest.lat=n),s>i.northEast.lon&&(i.northEast.lon=s),n>i.northEast.lat&&(i.northEast.lat=n),t&&(t[o][l]=[s,n])}}else i.southWest.lon=i.southWest.lat=i.northEast.lon=i.northEast.lat=0,t&&(t[0]=s)&&(t[1]=n);return i}setGeometry(e){var t=this._handler;return this.remove(),this._type=Zi.getType(e.type||"Point"),this._extent=Zi.getExtent(e,this._coordinates),t.add(this),this}setFillColor(e,t,i,r){var s=this._style.fillColor;return(0===s.w&&0!==r||0!==s.w&&0===r)&&(this._pickingReady=!1),s.x=e,s.y=t,s.z=i,s.w=r,this._handler&&this._handler.setPolyColorArr(this,s),this}setFillColor4v(e){return this.setFillColor(e.x,e.y,e.z,e.w)}setStrokeColor(e,t,i,r){var s=this._style.strokeColor;return(0===s.w&&0!==r||0!==s.w&&0===r)&&(this._pickingReady=!1),s.x=e,s.y=t,s.z=i,s.w=r,this._handler&&this._handler.setStrokeColorArr(this,s),this}setLineColor(e,t,i,r){var s=this._style.lineColor;return(0===s.w&&0!==r||0!==s.w&&0===r)&&(this._pickingReady=!1),s.x=e,s.y=t,s.z=i,s.w=r,this._handler&&this._handler.setLineColorArr(this,s),this}setStrokeColor4v(e){return this.setStrokeColor(e.x,e.y,e.z,e.w)}setLineColor4v(e){return this.setLineColor(e.x,e.y,e.z,e.w)}setStrokeOpacity(e){var t=this._style.strokeColor;return t.w=e,this.setStrokeColor(t.x,t.y,t.z,e)}setLineOpacity(e){var t=this._style.lineColor;return t.w=e,this.setLineColor(t.x,t.y,t.z,e)}setStrokeWidth(e){return this._style.strokeWidth=e,this._pickingReady=!1,this._handler&&this._handler.setLineStrokeArr(this,e),this}bringToFront(){return this._handler&&this._handler.bringToFront(this),this}setLineWidth(e){return this._style.lineWidth=e,this._pickingReady=!1,this._handler&&this._handler.setLineThicknessArr(this,e),this}setFillOpacity(e){var t=this._style.fillColor;return(0===t.w&&0!==e||0!==t.w&&0===e)&&(this._pickingReady=!1),t.w=e,this._handler&&this._handler.setPolyColorArr(this,t),this}setVisibility(e){return this._visibility=e,this._handler&&this._handler.setGeometryVisibility(this),this}getVisibility(){return this._visibility}remove(){this._handler&&this._handler.remove(this)}getExtent(){return this._extent.clone()}getType(){return this._type}}const Qi={RIGHT:0,LEFT:1,CENTER:2},Ki={left:Qi.LEFT,right:Qi.RIGHT,center:Qi.CENTER};class Ji extends Yi{constructor(e){super(e),e=e||{},this._text=e.text,this._face=et(e.face,null),this._size=e.size||33,this._style=et(e.style,null),this._weight=et(e.weight,null),this._outline=void 0!=e.outline?e.outline:.5,this._outlineColor=rt(e.outlineColor,new Ve(0,0,0,1)),this._align=e.align&&Ki[e.align.trim().toLowerCase()]||Qi.RIGHT,this._fontIndex=0,this._fontAtlas=null}setText(e){this._text=e,this._handler&&this._handler.setText(this._handlerIndex,e,this._fontIndex,this._align)}getText(){return this._text}setAlign(e){this._align=Ki[e.trim().toLowerCase()],this._handler&&this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align)}getAlign(){return this._align}setFace(e){this._face=e.trim().toLowerCase(),this.update()}getFace(){return this._face}setSize(e){this._size=e,this._handler&&this._handler.setSizeArr(this._handlerIndex,e)}getSize(){return this._size}setStyle(e){this._style=e.trim().toLowerCase(),this.update()}getStyle(){return this._style}setWeight(e){this._weight=e.trim().toLowerCase(),this.update()}getWeight(){return this._wight}setOutline(e){this._outline=e,this._handler&&this._handler.setOutlineArr(this._handlerIndex,1-e)}getOutline(){return this._outline}setOpacity(e){this._color.w=e,this.setColor4v(this._color),this._outlineColor.w=e,this.setOutlineColor4v(this._outlineColor)}setOutlineColor(e,t,i,r){this._outlineColor.x=e,this._outlineColor.y=t,this._outlineColor.z=i,this._outlineColor.w=r,this._handler&&this._handler.setOutlineColorArr(this._handlerIndex,this._outlineColor)}setOutlineColor4v(e){this._outlineColor.x=e.x,this._outlineColor.y=e.y,this._outlineColor.z=e.z,this._outlineColor.w=e.w,this._handler&&this._handler.setOutlineColorArr(this._handlerIndex,e)}setOutlineColorHTML(e){this.setOutlineColor4v(Qe(e))}getOutlineColor(){return this._outlineColor}setOutlineOpacity(e){this._outlineColor.w=e,this._handler&&this._handler.setOutlineColorArr(this._handlerIndex,this._outlineColor)}getOutlineOpacity(){return this._outlineColor.w}update(){if(this._fontAtlas){var e=this._fontAtlas.getFontIndex(this._face,this._style,this._weight);void 0==e?this._fontAtlas.createFontAsync(this._face,this._style,this._weight,this._applyFontIndex.bind(this)):this._applyFontIndex(e)}}_applyFontIndex(e){this._fontIndex=e,this._handler&&(this._handler.setFontIndexArr(this._handlerIndex,this._fontIndex),this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align))}assignFontAtlas(e){!this._fontAtlas&&(this._fontAtlas=e),this.update()}}const $i=0,er=1;class tr{constructor(e){e=e||{},this.id=tr._staticCounter++,this.altitude=0,this.thickness=e.thickness||1.5,this.color=og.utils.createColorRGBA(e.color,new Ve(1,1,1,1)),this.visibility=void 0==e.visibility||e.visibility,this._closedLine=e.isClosed||!1,this._path3v=[],this._pathLonLat=[],this._pathLonLatMerc=[],this._extent=new Oe,this._vertices=[],this._orders=[],this._indexes=[],this._verticesBuffer=null,this._ordersBuffer=null,this._indexesBuffer=null,this._pickingColor=[0,0,0],this._renderNode=null,this._entity=null,this._handler=null,this._handlerIndex=-1,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[$i]=this._createVerticesBuffer,this._buffersUpdateCallbacks[er]=this._createIndexBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),e.pathLonLat?this.setPathLonLat(e.pathLonLat):e.path3v&&this.setPath3v(e.path3v),this._refresh()}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}static appendLineData3v(e,t,i,r,s,n,a,o,h,l){var u=0;l&&(l.southWest.set(180,90),l.northEast.set(-180,-90)),s.length>0?(u=s[s.length-5]+9,s.push(u,u)):s.push(0,0);for(var d=0;d<e.length;d++){var c=e[d];a[d]=[],h[d]=[],o[d]=[];var _,f,p=u;if(t)(_=c[c.length-1]).constructor===Array&&(_=new Ge(_[0],_[1],_[2]));else{var v=c[0],g=c[1];v.constructor===Array&&(v=new Ge(v[0],v[1],v[2])),g.constructor===Array&&(g=new Ge(g[0],g[1],g[2])),_=new Ge(v.x+v.x-g.x,v.y+v.y-g.y,v.z+v.z-g.z)}i.push(_.x,_.y,_.z,_.x,_.y,_.z,_.x,_.y,_.z,_.x,_.y,_.z),r.push(1,-1,2,-2);for(var m=0;m<c.length;m++){var x=c[m];if(x.constructor===Array&&(x=new Ge(x[0],x[1],x[2])),n){var y=n.cartesianToLonLat(x);a[d].push(y),o[d].push(x),h[d].push(y.forwardMercator()),y.lon<l.southWest.lon&&(l.southWest.lon=y.lon),y.lat<l.southWest.lat&&(l.southWest.lat=y.lat),y.lon>l.northEast.lon&&(l.northEast.lon=y.lon),y.lat>l.northEast.lat&&(l.northEast.lat=y.lat)}i.push(x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z),r.push(1,-1,2,-2),s.push(u++,u++,u++,u++)}if(t)(f=c[0]).constructor===Array&&(f=new Ge(f[0],f[1],f[2])),s.push(p,p+1,p+1,p+1);else{v=c[c.length-1],g=c[c.length-2];v.constructor===Array&&(v=new Ge(v[0],v[1],v[2])),g.constructor===Array&&(g=new Ge(g[0],g[1],g[2])),f=new Ge(v.x+v.x-g.x,v.y+v.y-g.y,v.z+v.z-g.z),s.push(u-1,u-1,u-1,u-1)}i.push(f.x,f.y,f.z,f.x,f.y,f.z,f.x,f.y,f.z,f.x,f.y,f.z),r.push(1,-1,2,-2),d<e.length-1&&(u+=8,s.push(u,u))}}static appendLineDataLonLat(e,t,i,r,s,n,a,o,h,l){var u=0;l&&(l.southWest.set(180,90),l.northEast.set(-180,-90)),s.length>0?(u=s[s.length-5]+9,s.push(u,u)):s.push(0,0);for(var d=0;d<e.length;d++){var c,_,f,p,v,g=e[d],m=u;if(a[d]=[],h[d]=[],o[d]=[],t)c=(f=g[g.length-1])instanceof Array?n.lonLatToCartesian(new De(f[0],f[1],f[2])):n.lonLatToCartesian(f);else p=(f=g[0])instanceof Array?n.lonLatToCartesian(new De(f[0],f[1],f[2])):n.lonLatToCartesian(f),v=(f=g[1])instanceof Array?n.lonLatToCartesian(new De(f[0],f[1],f[2])):n.lonLatToCartesian(f),c=new Ge(p.x+p.x-v.x,p.y+p.y-v.y,p.z+p.z-v.z);i.push(c.x,c.y,c.z,c.x,c.y,c.z,c.x,c.y,c.z,c.x,c.y,c.z),r.push(1,-1,2,-2);for(var x=0;x<g.length;x++){var y=g[x];y instanceof Array&&(y=new De(y[0],y[1],y[2]));var C=n.lonLatToCartesian(y);a[d].push(C),o[d].push(y),h[d].push(y.forwardMercator()),i.push(C.x,C.y,C.z,C.x,C.y,C.z,C.x,C.y,C.z,C.x,C.y,C.z),r.push(1,-1,2,-2),s.push(u++,u++,u++,u++),y.lon<l.southWest.lon&&(l.southWest.lon=y.lon),y.lat<l.southWest.lat&&(l.southWest.lat=y.lat),y.lon>l.northEast.lon&&(l.northEast.lon=y.lon),y.lat>l.northEast.lat&&(l.northEast.lat=y.lat)}if(t)_=(f=g[0])instanceof Array?n.lonLatToCartesian(new De(f[0],f[1],f[2])):n.lonLatToCartesian(f),s.push(m,m+1,m+1,m+1);else p=(f=g[g.length-1])instanceof Array?n.lonLatToCartesian(new De(f[0],f[1],f[2])):n.lonLatToCartesian(f),v=(f=g[g.length-2])instanceof Array?n.lonLatToCartesian(new De(f[0],f[1],f[2])):n.lonLatToCartesian(f),_=new Ge(p.x+p.x-v.x,p.y+p.y-v.y,p.z+p.z-v.z),s.push(u-1,u-1,u-1,u-1);i.push(_.x,_.y,_.z,_.x,_.y,_.z,_.x,_.y,_.z,_.x,_.y,_.z),r.push(1,-1,2,-2),d<e.length-1&&(u+=8,s.push(u,u))}}_setEqualPath3v(e){var t=this._extent;t.southWest.set(180,90),t.northEast.set(-180,-90);for(var i=this._vertices,r=this._pathLonLat,s=this._pathLonLatMerc,n=0,a=this._renderNode.ellipsoid,o=0;o<e.length;o++){var h,l,u=e[o];h=this._closedLine?u[u.length-1]:new Ge(u[0].x+u[0].x-u[1].x,u[0].y+u[0].y-u[1].y,u[0].z+u[0].z-u[1].z),i[n++]=h.x,i[n++]=h.y,i[n++]=h.z,i[n++]=h.x,i[n++]=h.y,i[n++]=h.z,i[n++]=h.x,i[n++]=h.y,i[n++]=h.z,i[n++]=h.x,i[n++]=h.y,i[n++]=h.z;for(var d=0;d<u.length;d++){var c=u[d];if(a){var _=a.cartesianToLonLat(c);r[o][d]=_,s[o][d]=_.forwardMercator(),_.lon<t.southWest.lon&&(t.southWest.lon=_.lon),_.lat<t.southWest.lat&&(t.southWest.lat=_.lat),_.lon>t.northEast.lon&&(t.northEast.lon=_.lon),_.lat>t.northEast.lat&&(t.northEast.lat=_.lat)}i[n++]=c.x,i[n++]=c.y,i[n++]=c.z,i[n++]=c.x,i[n++]=c.y,i[n++]=c.z,i[n++]=c.x,i[n++]=c.y,i[n++]=c.z,i[n++]=c.x,i[n++]=c.y,i[n++]=c.z}if(this._closedLine)l=u[0];else{var f=u.length-1;l=new Ge(u[f].x+u[f].x-u[f-1].x,u[f].y+u[f].y-u[f-1].y,u[f].z+u[f].z-u[f-1].z)}i[n++]=l.x,i[n++]=l.y,i[n++]=l.z,i[n++]=l.x,i[n++]=l.y,i[n++]=l.z,i[n++]=l.x,i[n++]=l.y,i[n++]=l.z,i[n++]=l.x,i[n++]=l.y,i[n++]=l.z}}_setEqualPathLonLat(e){var t=this._extent;t.southWest.set(180,90),t.northEast.set(-180,-90);for(var i=this._vertices,r=this._pathLonLat,s=this._pathLonLatMerc,n=this._path3v,a=0,o=this._renderNode.ellipsoid,h=0;h<e.length;h++){var l,u,d=e[h];if(this._closedLine)l=o.lonLatToCartesian(d[d.length-1]);else{var c=o.lonLatToCartesian(d[0]),_=o.lonLatToCartesian(d[1]);l=new Ge(c.x+c.x-_.x,c.y+c.y-_.y,c.z+c.z-_.z)}i[a++]=l.x,i[a++]=l.y,i[a++]=l.z,i[a++]=l.x,i[a++]=l.y,i[a++]=l.z,i[a++]=l.x,i[a++]=l.y,i[a++]=l.z,i[a++]=l.x,i[a++]=l.y,i[a++]=l.z;for(var f=0;f<d.length;f++){var p=d[f];cartesian=o.lonLatToCartesian(p),n[h][f]=cartesian,s[h][f]=p.forwardMercator(),r[h][f]=p,i[a++]=cartesian.x,i[a++]=cartesian.y,i[a++]=cartesian.z,i[a++]=cartesian.x,i[a++]=cartesian.y,i[a++]=cartesian.z,i[a++]=cartesian.x,i[a++]=cartesian.y,i[a++]=cartesian.z,i[a++]=cartesian.x,i[a++]=cartesian.y,i[a++]=cartesian.z,p.lon<t.southWest.lon&&(t.southWest.lon=p.lon),p.lat<t.southWest.lat&&(t.southWest.lat=p.lat),p.lon>t.northEast.lon&&(t.northEast.lon=p.lon),p.lat>t.northEast.lat&&(t.northEast.lat=p.lat)}if(this._closedLine)u=o.lonLatToCartesian(d[0]);else{c=o.lonLatToCartesian(d[d.length-1]),_=o.lonLatToCartesian(d[d.length-2]);u=new Ge(c.x+c.x-_.x,c.y+c.y-_.y,c.z+c.z-_.z)}i[a++]=u.x,i[a++]=u.y,i[a++]=u.z,i[a++]=u.x,i[a++]=u.y,i[a++]=u.z,i[a++]=u.x,i[a++]=u.y,i[a++]=u.z,i[a++]=u.x,i[a++]=u.y,i[a++]=u.z}}setPoint3v(e,t,i,r){if(i=i||0,this._renderNode){for(var s=this._vertices,n=this._pathLonLat,a=this._pathLonLatMerc,o=0,h=0,l=0;l<i;l++)h+=12*this._path3v[l].length+24;var u;if((x=this._path3v[i])[t].x=e.x,x[t].y=e.y,x[t].z=e.z,0===t||1===t)u=this._closedLine?x[x.length-1]:new Ge(x[0].x+x[0].x-x[1].x,x[0].y+x[0].y-x[1].y,x[0].z+x[0].z-x[1].z),s[o=h]=u.x,s[o+1]=u.y,s[o+2]=u.z,s[o+3]=u.x,s[o+4]=u.y,s[o+5]=u.z,s[o+6]=u.x,s[o+7]=u.y,s[o+8]=u.z,s[o+9]=u.x,s[o+10]=u.y,s[o+11]=u.z;if(!r&&this._renderNode.ellipsoid){var d=this._renderNode.ellipsoid.cartesianToLonLat(e);n[i][t]=d,a[i][t]=d.forwardMercator();var c=this._extent;c.southWest.set(180,90),c.northEast.set(-180,-90);for(l=0;l<n.length;l++)for(var _=n[l],f=0;f<_.length;f++){var p=_[f].lon,v=_[f].lat;p>c.northEast.lon&&(c.northEast.lon=p),v>c.northEast.lat&&(c.northEast.lat=v),p<c.southWest.lon&&(c.southWest.lon=p),v<c.southWest.lat&&(c.southWest.lat=v)}}if(s[o=h+12*t+12]=e.x,s[o+1]=e.y,s[o+2]=e.z,s[o+3]=e.x,s[o+4]=e.y,s[o+5]=e.z,s[o+6]=e.x,s[o+7]=e.y,s[o+8]=e.z,s[o+9]=e.x,s[o+10]=e.y,s[o+11]=e.z,t===x.length-1||t===x.length-2){var g;if(this._closedLine)g=x[0];else{var m=x.length-1;g=new Ge(x[m].x+x[m].x-x[m-1].x,x[m].y+x[m].y-x[m-1].y,x[m].z+x[m].z-x[m-1].z)}s[o=h+12*x.length+12]=g.x,s[o+1]=g.y,s[o+2]=g.z,s[o+3]=g.x,s[o+4]=g.y,s[o+5]=g.z,s[o+6]=g.x,s[o+7]=g.y,s[o+8]=g.z,s[o+9]=g.x,s[o+10]=g.y,s[o+11]=g.z}this._changedBuffers[$i]=!0}else{var x;(x=this._path3v[i])[t].x=e.x,x[t].y=e.y,x[t].z=e.z}}addPoint3v(e,t){t=t||0}addPointLonLat(e,t){t=t||0}clear(){this._vertices.length=0,this._orders.length=0,this._indexes.length=0,this._vertices=[],this._orders=[],this._indexes=[],this._deleteBuffers()}setColorHTML(e,t){this.color=Qe(e),t&&(this.color.w=t)}setColor(e,t,i,r){this.color.x=e,this.color.y=t,this.color.z=i,r&&(this.color.w=r)}setColor3v(e){this.color.x=e.x,this.color.y=e.y,this.color.z=e.z}setColor4v(e){this.color.x=e.x,this.color.y=e.y,this.color.z=e.z,this.color.w=e.w}setOpacity(e){this.color.w=e}setThickness(e){this.thickness=e}getThickness(){return this.thickness}setVisibility(e){this.visibility=e}getVisibility(){return this.visibility}setRenderNode(e){this._renderNode=e,this._pathLonLat.length?this._createDataLonLat([].concat(this._pathLonLat)):this._createData3v([].concat(this._path3v))}_clearData(){this._vertices.length=0,this._orders.length=0,this._indexes.length=0,this._vertices=[],this._orders=[],this._indexes=[],this._path3v.length=0,this._pathLonLat.length=0,this._pathLonLatMerc.length=0,this._path3v=[],this._pathLonLat=[],this._pathLonLatMerc=[]}_createData3v(e){this._clearData(),tr.appendLineData3v(e,this._closedLine,this._vertices,this._orders,this._indexes,this._renderNode.ellipsoid,this._pathLonLat,this._path3v,this._pathLonLatMerc,this._extent)}_createDataLonLat(e){this._clearData(),tr.appendLineDataLonLat(e,this._closedLine,this._vertices,this._orders,this._indexes,this._renderNode.ellipsoid,this._path3v,this._pathLonLat,this._pathLonLatMerc,this._extent)}remove(){this._entity=null,this.clear(),this._handler&&this._handler.remove(this)}setPickingColor3v(e){this._pickingColor[0]=e.x/255,this._pickingColor[1]=e.y/255,this._pickingColor[2]=e.z/255}getExtent(){return this._extent.clone()}getPath3v(){return this._path3v}getPathLonLat(){return this._pathLonLat}setPathLonLat(e,t){this._renderNode&&this._renderNode.ellipsoid?t?(this._setEqualPathLonLat(e),this._changedBuffers[$i]=!0):(this._createDataLonLat(e),this._changedBuffers[$i]=!0,this._changedBuffers[er]=!0):this._pathLonLat=[].concat(e)}setPath3v(e,t){this._renderNode?t?(this._setEqualPath3v(e),this._changedBuffers[$i]=!0):(this._createData3v(e),this._changedBuffers[$i]=!0,this._changedBuffers[er]=!0):this._path3v=[].concat(e)}draw(){if(this.visibility&&this._path3v.length){this._update();var e=this._renderNode,t=e.renderer,i=t.handler.shaderPrograms.polyline,r=i._program,s=t.handler.gl,n=r.attributes,a=r.uniforms;i.activate(),s.enable(s.BLEND),s.blendEquationSeparate(s.FUNC_ADD,s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA),s.disable(s.CULL_FACE),s.uniformMatrix4fv(a.proj._pName,!1,t.activeCamera._projectionMatrix._m),s.uniformMatrix4fv(a.view._pName,!1,t.activeCamera._viewMatrix._m),t.isMultiFramebufferCompatible()&&s.uniform3fv(a.pickingColor._pName,[this._pickingColor[0],this._pickingColor[1],this._pickingColor[2]]),s.uniform4fv(a.color._pName,this.color.toVec()),s.uniform3fv(a.uCamPos._pName,t.activeCamera.eye.toVec()),s.uniform2fv(a.uFloatParams._pName,[e._planetRadius2||0,t.activeCamera._tanViewAngle_hradOneByHeight]),s.uniform2fv(a.viewport._pName,[t.handler.canvas.width,t.handler.canvas.height]),s.uniform1f(a.thickness._pName,.5*this.thickness);var o=this._verticesBuffer;s.bindBuffer(s.ARRAY_BUFFER,o),s.vertexAttribPointer(n.prev._pName,o.itemSize,s.FLOAT,!1,12,0),s.vertexAttribPointer(n.current._pName,o.itemSize,s.FLOAT,!1,12,48),s.vertexAttribPointer(n.next._pName,o.itemSize,s.FLOAT,!1,12,96),s.bindBuffer(s.ARRAY_BUFFER,this._ordersBuffer),s.vertexAttribPointer(n.order._pName,this._ordersBuffer.itemSize,s.FLOAT,!1,4,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this._indexesBuffer),s.drawElements(s.TRIANGLE_STRIP,this._indexesBuffer.numItems,s.UNSIGNED_INT,0)}}drawPicking(){if(this.visibility&&this._path3v.length){var e=this._renderNode,t=e.renderer,i=t.handler.shaderPrograms.polyline,r=i._program,s=t.handler.gl,n=r.attributes,a=r.uniforms;i.activate(),s.disable(s.BLEND),s.disable(s.CULL_FACE),s.uniformMatrix4fv(a.proj._pName,!1,t.activeCamera._projectionMatrix._m),s.uniformMatrix4fv(a.view._pName,!1,t.activeCamera._viewMatrix._m),s.uniform4fv(a.color._pName,[this._pickingColor[0],this._pickingColor[1],this._pickingColor[2],1]),s.uniform3fv(a.uCamPos._pName,t.activeCamera.eye.toVec()),s.uniform2fv(a.uFloatParams._pName,[e._planetRadius2||0,t.activeCamera._tanViewAngle_hradOneByHeight]),s.uniform2fv(a.viewport._pName,[t.handler.canvas.width,t.handler.canvas.height]),s.uniform1f(a.thickness._pName,.5*this.thickness);var o=this._verticesBuffer;s.bindBuffer(s.ARRAY_BUFFER,o),s.vertexAttribPointer(n.prev._pName,o.itemSize,s.FLOAT,!1,12,0),s.vertexAttribPointer(n.current._pName,o.itemSize,s.FLOAT,!1,12,48),s.vertexAttribPointer(n.next._pName,o.itemSize,s.FLOAT,!1,12,96),s.bindBuffer(s.ARRAY_BUFFER,this._ordersBuffer),s.vertexAttribPointer(n.order._pName,this._ordersBuffer.itemSize,s.FLOAT,!1,4,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this._indexesBuffer),s.drawElements(s.TRIANGLE_STRIP,this._indexesBuffer.numItems,s.UNSIGNED_INT,0),s.enable(s.CULL_FACE),s.enable(s.BLEND)}}_refresh(){for(var e=this._changedBuffers.length;e--;)this._changedBuffers[e]=!0}_update(){if(this._renderNode)for(var e=this._changedBuffers.length;e--;)this._changedBuffers[e]&&(this._buffersUpdateCallbacks[e].call(this),this._changedBuffers[e]=!1)}_deleteBuffers(){if(this._renderNode){var e=this._renderNode.renderer.handler.gl;e.deleteBuffer(this._verticesBuffer),e.deleteBuffer(this._ordersBuffer),e.deleteBuffer(this._indexesBuffer),this._verticesBuffer=null,this._ordersBuffer=null,this._indexesBuffer=null}}_createVerticesBuffer(){var e=this._renderNode.renderer.handler;e.gl.deleteBuffer(this._verticesBuffer),this._verticesBuffer=e.createArrayBuffer(new Float32Array(this._vertices),3,this._vertices.length/3)}_createIndexBuffer(){var e=this._renderNode.renderer.handler;e.gl.deleteBuffer(this._ordersBuffer),e.gl.deleteBuffer(this._indexesBuffer),this._ordersBuffer=e.createArrayBuffer(new Float32Array(this._orders),1,this._orders.length/2),this._indexesBuffer=e.createElementArrayBuffer(new Uint32Array(this._indexes),1,this._indexes.length)}}const ir=0,rr=1,sr=2;class nr{constructor(e){e=e||{},this.id=nr._staticCounter++,this.visibility=void 0==e.visibility||e.visibility,this.pointSize=e.pointSize||3,this.pickingDistance=e.pickingDistance||0,this._renderNode=null,this._entity=null,this._points=[],this._coordinatesData=[],this._colorData=[],this._pickingColorData=[],this._coordinatesBuffer=null,this._colorBuffer=null,this._pickingColorBuffer=null,this._handler=null,this._handlerIndex=-1,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[ir]=this._createCoordinatesBuffer,this._buffersUpdateCallbacks[rr]=this._createColorBuffer,this._buffersUpdateCallbacks[sr]=this._createPickingColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),this.setPoints(e.points)}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}clear(){this._points.length=0,this._points=[],this._coordinatesData.length=0,this._coordinatesData=[],this._colorData.length=0,this._colorData=[],this._pickingColorData.length=0,this._pickingColorData=[],this._deleteBuffers()}setOpacity(e){this.opacity=e}setVisibility(e){this.visibility=e}getVisibility(){return this.visibility}setRenderNode(e){this._renderNode=e,this._setPickingColors()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPoints(e){this.clear();for(var t=0;t<e.length;t++){var i=e[t],r=new Ge(i[0],i[1],i[2]),s=new Ve(i[3],i[4],i[5],void 0==i[6]?255:i[6]);this._coordinatesData.push(r.x,r.y,r.z),this._colorData.push(s.x/255,s.y/255,s.z/255,s.w/255);var n={_pickingColor:new Ge,_entityCollection:this._entity&&this._entity._entityCollection,index:t,position:r,color:s,pointCloud:this,properties:i[7]||{}};this._points.push(n),this._renderNode&&(this._renderNode.renderer.assignPickingColor(n),this._pickingColorData.push(n._pickingColor.x/255,n._pickingColor.y/255,n._pickingColor.z/255,1))}this._changedBuffers[ir]=!0,this._changedBuffers[rr]=!0,this._changedBuffers[sr]=!0}setPointPosition(e,t,i,r){this._changedBuffers[ir]=!0}setPointColor(e,t,i,r,s){this._changedBuffers[rr]=!0}addPoints(e){this._changedBuffers[ir]=!0,this._changedBuffers[rr]=!0,this._changedBuffers[sr]=!0}addPoint(e,t){this._changedBuffers[ir]=!0,this._changedBuffers[rr]=!0,this._changedBuffers[sr]=!0}getPoint(e){return this._points[e]}removePoint(e){this._changedBuffers[ir]=!0,this._changedBuffers[rr]=!0,this._changedBuffers[sr]=!0}insertPoint(e,t){this._changedBuffers[ir]=!0,this._changedBuffers[rr]=!0,this._changedBuffers[sr]=!0}each(e){for(var t=this._points.length;t--;)e&&e(this._points[t])}draw(){if(this.visibility&&this._coordinatesData.length){this._update();var e=this._renderNode.renderer,t=e.handler.shaderPrograms.pointCloud,i=t._program,r=e.handler.gl,s=i.attributes,n=i.uniforms;t.activate(),r.uniformMatrix4fv(n.projectionViewMatrix._pName,!1,e.activeCamera._projectionViewMatrix._m),r.uniform1f(n.opacity._pName,this._handler._entityCollection._animatedOpacity),r.uniform1f(n.pointSize._pName,this.pointSize),r.bindBuffer(r.ARRAY_BUFFER,this._coordinatesBuffer),r.vertexAttribPointer(s.coordinates._pName,this._coordinatesBuffer.itemSize,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this._colorBuffer),r.vertexAttribPointer(s.colors._pName,this._colorBuffer.itemSize,r.FLOAT,!1,0,0),r.drawArrays(r.POINTS,0,this._coordinatesBuffer.numItems)}}drawPicking(){if(this.visibility&&this._coordinatesData.length){var e=this._renderNode.renderer,t=e.handler.shaderPrograms.pointCloud,i=t._program,r=e.handler.gl,s=i.attributes,n=i.uniforms;t.activate(),r.uniformMatrix4fv(n.projectionViewMatrix._pName,!1,e.activeCamera._projectionViewMatrix._m),r.uniform1f(n.opacity._pName,this._handler._entityCollection._animatedOpacity),r.uniform1f(n.pointSize._pName,this.pointSize+this.pickingDistance),r.bindBuffer(r.ARRAY_BUFFER,this._coordinatesBuffer),r.vertexAttribPointer(s.coordinates._pName,this._coordinatesBuffer.itemSize,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this._pickingColorBuffer),r.vertexAttribPointer(s.colors._pName,this._pickingColorBuffer.itemSize,r.FLOAT,!1,0,0),r.drawArrays(r.POINTS,0,this._coordinatesBuffer.numItems)}}_update(){if(this._renderNode)for(var e=this._changedBuffers.length;e--;)this._changedBuffers[e]&&(this._buffersUpdateCallbacks[e].call(this),this._changedBuffers[e]=!1)}_deleteBuffers(){if(this._renderNode){var e=this._renderNode.renderer.handler.gl;e.deleteBuffer(this._coordinatesBuffer),e.deleteBuffer(this._colorBuffer),e.deleteBuffer(this._pickingColorBuffer)}this._coordinatesBuffer=null,this._colorBuffer=null,this._pickingColorBuffer=null}_createCoordinatesBuffer(){var e=this._renderNode.renderer.handler;e.gl.deleteBuffer(this._coordinatesBuffer),this._coordinatesBuffer=e.createArrayBuffer(new Float32Array(this._coordinatesData),3,this._coordinatesData.length/3)}_createColorBuffer(){var e=this._renderNode.renderer.handler;e.gl.deleteBuffer(this._colorBuffer),this._colorBuffer=e.createArrayBuffer(new Float32Array(this._colorData),4,this._colorData.length/4)}_createPickingColorBuffer(){var e=this._renderNode.renderer.handler;e.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorBuffer=e.createArrayBuffer(new Float32Array(this._pickingColorData),4,this._pickingColorData.length/4)}_setPickingColors(){if(this._renderNode){for(var e=0;e<this._points.length;e++){var t=this._points[e];t._entity=this._entity,t._entityCollection=this._entity._entityCollection,this._renderNode.renderer.assignPickingColor(t),this._pickingColorData.push(t._pickingColor.x/255,t._pickingColor.y/255,t._pickingColor.z/255,1)}this._changedBuffers[sr]=!0}}}class ar{constructor(e){e=e||{},this.id=ar.__staticId++,this.position=e.position||new Ge,this.orientation=e.orientation||new We(0,0,0,1),this.scale=e.scale||new Ge(1,1,1),this.color=e.color||[1,1,1,1],this.visibility=void 0==e.visibility||e.visibility,this._src=e.src||null,this._positionBuffer=null,this._normalBuffer=null,this._indexBuffer=null,this._textureCoordBuffer=null,this._positionData=[],this._normalData=[],this._indexData=[],this._textureCoordData=[],this._mxScale=(new He).setIdentity(),this._mxTranslation=(new He).setIdentity(),this._mxModel=(new He).setIdentity(),this.texture=null,this._renderNode=null,this._pickingColor=[0,0,0,0],this._entity=null,this._handler=null,this._handlerIndex=-1}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}clear(){this.position.set(0,0,0),this.orientation.set(0,0,0,1),this.scale.set(1,1,1),this._positionData.length=0,this._normalData.length=0,this._indexData.length=0,this._mxScale.setIdentity(),this._mxTranslation.setIdentity(),this._mxModel.setIdentity(),this._renderNode.handler.gl.deleteTexture(this.texture),this.texture=null,this._deleteBuffers()}setColor(e){this.color[0]=e[0],this.color[1]=e[1],this.color[2]=e[2],this.color[3]=e[3]}setColor4v(e){this.color[0]=e.x,this.color[1]=e.y,this.color[2]=e.z,this.color[3]=e.w}setOpacity(e){this.color[3]=e}_deleteBuffers(){var e=this._renderNode.renderer.handler.gl;e.deleteBuffer(this._positionBuffer),e.deleteBuffer(this._normalBuffer),e.deleteBuffer(this._indexBuffer),this._positionBuffer=null,this._normalBuffer=null,this._indexBuffer=null}setVisibility(e){this.visibility=e}getVisibility(){return this.visibility}setRenderNode(e){if(this._renderNode=e,this._createBuffers(),this._src){var t=new Image,i=this;t.onload=function(){i.texture=e.renderer.handler.createTexture(this)},t.src=this._src}}setPosition3v(e){this.position.copy(e),this._mxTranslation.translateToPosition(e),this.refresh()}translate3v(e){this.position.addA(e),this._mxTranslation.translate(e)}setScale3v(e){this.scale.copy(e),this._mxScale.scale(e)}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(e){this._pickingColor[0]=e.x/255,this._pickingColor[1]=e.y/255,this._pickingColor[2]=e.z/255,this._pickingColor[3]=1}_createBuffers(){this._deleteBuffers();var e=this._renderNode.renderer;this._positionBuffer=e.handler.createArrayBuffer(new Float32Array(this._positionData),3,this._positionData.length/3),this._normalBuffer=e.handler.createArrayBuffer(new Float32Array(this._normalData),3,this._normalData.length/3),this._indexBuffer=e.handler.createElementArrayBuffer(new Uint16Array(this._indexData),1,this._indexData.length),this._textureCoordBuffer=e.handler.createArrayBuffer(new Float32Array(this._textureCoordData),2,this._textureCoordData.length/2)}refresh(){this._mxModel=this._mxTranslation.mul(this.orientation.getMatrix4().mul(this._mxScale))}draw(){if(this.visibility){var e,t,i=this._renderNode,r=i.renderer,s=r.handler.gl;i.lightEnabled?(t=(e=r.handler.shaderPrograms.shape_wl)._program,sha=t.attributes,shu=t.uniforms,e.activate(),s.uniform4fv(shu.lightsPositions._pName,i._lightsTransformedPositions),s.uniform3fv(shu.lightsParamsv._pName,i._lightsParamsv),s.uniform1fv(shu.lightsParamsf._pName,i._lightsParamsf),s.uniformMatrix4fv(shu.projectionMatrix._pName,!1,r.activeCamera._projectionMatrix._m),s.uniformMatrix4fv(shu.viewMatrix._pName,!1,r.activeCamera._viewMatrix._m),s.uniformMatrix3fv(shu.normalMatrix._pName,!1,r.activeCamera._normalMatrix._m),s.bindBuffer(s.ARRAY_BUFFER,this._normalBuffer),s.vertexAttribPointer(sha.aVertexNormal._pName,this._normalBuffer.itemSize,s.FLOAT,!1,0,0)):(t=(e=r.handler.shaderPrograms.shape_nl)._program,sha=t.attributes,shu=t.uniforms,e.activate(),s.uniformMatrix4fv(shu.projectionViewMatrix._pName,!1,r.activeCamera._projectionViewMatrix._m)),s.uniform4fv(shu.uColor._pName,this.color),s.bindBuffer(s.ARRAY_BUFFER,this._positionBuffer),s.vertexAttribPointer(sha.aVertexPosition._pName,this._positionBuffer.itemSize,s.FLOAT,!1,0,0),s.uniformMatrix4fv(shu.modelMatrix._pName,!1,this._mxModel._m),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.texture),s.uniform1i(shu.uSampler._pName,0),s.bindBuffer(s.ARRAY_BUFFER,this._textureCoordBuffer),s.vertexAttribPointer(sha.aTextureCoord._pName,this._textureCoordBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this._indexBuffer),s.drawElements(r.handler.gl.TRIANGLES,this._indexBuffer.numItems,s.UNSIGNED_SHORT,0)}}}class or extends ar{constructor(e){this._radius=e.radius||100,this._latBands=e.latBands||16,this._lonBands=e.lonBands||16,this._createData()}_createData(){for(let u=0;u<=this._latBands;u++){var e=u*Math.PI/this._latBands,t=Math.sin(e),i=Math.cos(e);for(let e=0;e<=this._lonBands;e++){var r=2*e*Math.PI/this._lonBands,s=Math.sin(r),n=Math.cos(r)*t,a=i,o=s*t,h=1-e/this._lonBands,l=u/this._latBands;this._normalData.push(n),this._normalData.push(a),this._normalData.push(o),this._textureCoordData.push(h),this._textureCoordData.push(l),this._positionData.push(this._radius*n),this._positionData.push(this._radius*a),this._positionData.push(this._radius*o)}}for(let e=0;e<this._latBands;e++)for(let t=0;t<this._lonBands;t++){var u=e*(this._lonBands+1)+t,d=u+this._lonBands+1;this._indexData.push(u),this._indexData.push(u+1),this._indexData.push(d),this._indexData.push(d),this._indexData.push(u+1),this._indexData.push(d+1)}}}class hr{constructor(e){(e=e||{}).properties=e.properties||{},this.id=hr._staticCounter++,this.properties=e.properties||{},this.properties.name=this.properties.name||"noname",this.childrenNodes=[],this.parent=null,this._cartesian=tt(e.cartesian),this._lonlat=at(e.lonlat),this._lonlatMerc=null,this._altitude=e.altitude||0,this._visibility=void 0==e.visibility||e.visibility,this._entityCollection=null,this._entityCollectionIndex=-1,this._layer=null,this._layerIndex=-1,this._pickingColor=new Ge(0,0,0),this._featureConstructorArray={billboard:[ji,this.setBillboard],label:[Ji,this.setLabel],sphere:[or,this.setShape],polyline:[tr,this.setPolyline],pointCloud:[nr,this.setPointCloud],geometry:[Zi,this.setGeometry]},this.billboard=this._createOptionFeature("billboard",e.billboard),this.label=this._createOptionFeature("label",e.label),this.shape=this._createOptionFeature("sphere",e.sphere||e.box),this.polyline=this._createOptionFeature("polyline",e.polyline),this.pointCloud=this._createOptionFeature("pointCloud",e.pointCloud),this.geometry=this._createOptionFeature("geometry",e.geometry)}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}_createOptionFeature(e,t){if(t){var i=this._featureConstructorArray[e];return i[1].call(this,new i[0](t))}return null}addTo(e,t){return e.add(this,t),this}remove(){this._layer&&this._layer.removeEntity(this),this._entityCollection&&this._entityCollection.removeEntity(this)}setVisibility(e){this._visibility=e,this.billboard&&this.billboard.setVisibility(e),this.label&&this.label.setVisibility(e),this.shape&&this.shape.setVisibility(e),this.polyline&&this.polyline.setVisibility(e),this.geometry&&this.geometry.setVisibility(e);for(var t=0;t<this.childrenNodes.length;t++)this.childrenNodes[t].setVisibility(e)}getVisibility(){return this._visibility}setCartesian3v(e){this.setCartesian(e.x,e.y,e.z)}setCartesian(e,t,i){var r=this._cartesian;r.x=e,r.y=t,r.z=i,this.billboard&&this.billboard.setPosition3v(r),this.label&&this.label.setPosition3v(r),this.shape&&this.shape.setPosition3v(r);for(var s=0;s<this.childrenNodes.length;s++)this.childrenNodes[s].setCartesian(e,t,i);var n=this._entityCollection;n&&n.renderNode&&n.renderNode.ellipsoid&&(this._lonlat=n.renderNode.ellipsoid.cartesianToLonLat(r),Math.abs(this._lonlat.lat)<ze?this._lonlatMerc=this._lonlat.forwardMercator():this._lonlatMerc=null),n&&n.events.dispatch(n.events.entitymove,this)}_setCartesian3vSilent(e){var t=this._cartesian;t.x=e.x,t.y=e.y,t.z=e.z,this.billboard&&this.billboard.setPosition3v(t),this.label&&this.label.setPosition3v(t),this.shape&&this.shape.setPosition3v(t);for(var i=0;i<this.childrenNodes.length;i++)this.childrenNodes[i].setCartesian(x,y,z)}getLonLat(){return this._lonlat.clone()}setLonLat(e){var t=this._lonlat;t.lon=e.lon,t.lat=e.lat,t.height=e.height;var i=this._entityCollection;i&&i.renderNode&&i.renderNode.ellipsoid&&(Math.abs(e.lat)<ze?this._lonlatMerc=e.forwardMercator():this._lonlatMerc=null,this._cartesian=i.renderNode.ellipsoid.lonLatToCartesian(e),this.setCartesian3v(this._cartesian))}setAltitude(e){this._altitude=e}getCartesian(){return this._cartesian}setBillboard(e){return this.billboard&&this.billboard.remove(),this.billboard=e,this.billboard._entity=this,this.billboard.setPosition3v(this._cartesian),this.billboard.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._billboardHandler.add(e),e}setLabel(e){return this.label&&this.label.remove(),this.label=e,this.label._entity=this,this.label.setPosition3v(this._cartesian),this.label.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._labelHandler.add(e),e}setShape(e){return this.shape&&this.shape.remove(),this.shape=e,this.shape._entity=this,this.shape.setPosition3v(this._cartesian),this.shape.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._shapeHandler.add(e),e}setPolyline(e){return this.polyline&&this.polyline.remove(),this.polyline=e,this.polyline._entity=this,this.polyline.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._polylineHandler.add(e),e}setPointCloud(e){return this.pointCloud&&this.pointCloud.remove(),this.pointCloud=e,this.pointCloud._entity=this,this.pointCloud.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._pointCloudHandler.add(e),e}setGeometry(e){return this.geometry&&this.geometry.remove(),this.geometry=e,this.geometry._entity=this,this.geometry.setVisibility(this._visibility),this._layer&&this._layer.add(this),e}get layer(){return this._layer}appendChild(e){e._entityCollection=this._entityCollection,e._pickingColor=this._pickingColor,e.parent=this,this.childrenNodes.push(e),this._entityCollection&&this._entityCollection._addRecursively(e)}setPickingColor(){var e=this._pickingColor;this.billboard&&this.billboard.setPickingColor3v(e),this.label&&this.label.setPickingColor3v(e),this.shape&&this.shape.setPickingColor3v(e),this.polyline&&this.polyline.setPickingColor3v(e);for(var t=0;t<this.childrenNodes.length;t++)this.childrenNodes[t].setPickingColor()}getExtent(){var e,t=this._lonlat,i=(e=this.billboard||this.label?new Oe(new De(t.lon,t.lat),new De(t.lon,t.lat)):new Oe(new De(180,90),new De(-180,-90))).southWest,r=e.northEast;this.polyline&&((n=this.polyline.getExtent()).southWest.lon<i.lon&&(i.lon=n.southWest.lon),n.southWest.lat<i.lat&&(i.lat=n.southWest.lat),n.northEast.lon>r.lon&&(r.lon=n.northEast.lon),n.northEast.lat>r.lat&&(r.lat=n.northEast.lat));this.geometry&&((n=this.geometry.getExtent()).southWest.lon<i.lon&&(i.lon=n.southWest.lon),n.southWest.lat<i.lat&&(i.lat=n.southWest.lat),n.northEast.lon>r.lon&&(r.lon=n.northEast.lon),n.northEast.lat>r.lat&&(r.lat=n.northEast.lat));for(var s=0;s<this.childrenNodes.length;s++){var n;(n=this.childrenNodes[s].getExtent()).southWest.lon<i.lon&&(i.lon=n.southWest.lon),n.southWest.lat<i.lat&&(i.lat=n.southWest.lat),n.northEast.lon>r.lon&&(r.lon=n.northEast.lon),n.northEast.lat>r.lat&&(r.lat=n.northEast.lat)}return e}}const lr=0,ur=1,dr=2,cr=3,_r=4,fr=5,pr=6,vr=7,gr=8;class mr{constructor(e){this.pickingEnabled=!0,this._entityCollection=e,this._renderer=null,this._billboards=[],this._positionBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._texCoordBuffer=null,this._vertexBuffer=null,this._alignedAxisBuffer=null,this._texCoordArr=[],this._vertexArr=[],this._positionArr=[],this._sizeArr=[],this._offsetArr=[],this._rgbaArr=[],this._rotationArr=[],this._alignedAxisArr=[],this._pickingColorBuffer=null,this._pickingColorArr=[],this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[lr]=this.createPickingColorBuffer,this._buffersUpdateCallbacks[ur]=this.createPositionBuffer,this._buffersUpdateCallbacks[dr]=this.createSizeBuffer,this._buffersUpdateCallbacks[cr]=this.createOffsetBuffer,this._buffersUpdateCallbacks[_r]=this.createRgbaBuffer,this._buffersUpdateCallbacks[fr]=this.createRotationBuffer,this._buffersUpdateCallbacks[pr]=this.createTexCoordBuffer,this._buffersUpdateCallbacks[vr]=this.createVertexBuffer,this._buffersUpdateCallbacks[gr]=this.createAlignedAxisBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),this.__staticId=mr.staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}static concArr(e,t){for(var i=0;i<t.length;i++)e.push(t[i])}initShaderProgram(){if(this._renderer.handler){if(!this._renderer.handler.shaderPrograms.billboard){var e=!this._renderer.isMultiFramebufferCompatible();this._renderer.handler.addShaderProgram(function(e){var t;return t=e?"precision highp float;\n            uniform sampler2D u_texture;            varying vec2 v_texCoords;            varying vec4 v_rgba;            void main () {                vec4 color = texture2D(u_texture, v_texCoords);                if(color.a < 0.1)                    discard;                gl_FragColor = color * v_rgba;            }":"#extension GL_EXT_draw_buffers : require\n            precision highp float;\n            uniform sampler2D u_texture;            varying vec2 v_texCoords;            varying vec4 v_rgba;            void main () {                vec4 color = texture2D(u_texture, v_texCoords);                if(color.a < 0.1)                    discard;                gl_FragData[0] = color * v_rgba;                gl_FragData[1] = vec4(0.0);            }",new vi("billboard",{uniforms:{u_texture:{type:fi.SAMPLER2D},projectionMatrix:{type:fi.MAT4},viewMatrix:{type:fi.MAT4},uCamPos:{type:fi.VEC3},uFloatParams:{type:fi.VEC2},uScaleByDistance:{type:fi.VEC3},uOpacity:{type:fi.FLOAT}},attributes:{a_vertices:{type:fi.VEC2,enableArray:!0},a_texCoord:{type:fi.VEC2,enableArray:!0},a_positions:{type:fi.VEC4,enableArray:!0},a_size:{type:fi.VEC2,enableArray:!0},a_offset:{type:fi.VEC3,enableArray:!0},a_rgba:{type:fi.VEC4,enableArray:!0},a_rotation:{type:fi.FLOAT,enableArray:!0},a_alignedAxis:{type:fi.VEC3,enableArray:!0}},vertexShader:"precision highp float;\n            attribute vec2 a_vertices;            attribute vec2 a_texCoord;            attribute vec4 a_positions;            attribute vec3 a_offset;            attribute vec2 a_size;            attribute float a_rotation;            attribute vec4 a_rgba;            attribute vec3 a_alignedAxis;            varying vec2 v_texCoords;            varying vec4 v_rgba;            uniform mat4 viewMatrix;            uniform mat4 projectionMatrix;            uniform vec3 uCamPos;            uniform vec2 uFloatParams;            uniform vec3 uScaleByDistance;            uniform float uOpacity;            const vec3 ZERO3 = vec3(0.0);            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main() {                v_texCoords = a_texCoord;                vec3 look = a_positions.xyz - uCamPos;                float lookLength = length(look);                v_rgba = a_rgba;                /*v_rgba.a *= uOpacity * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions.xyz,a_positions.xyz) - uFloatParams[0]));*/                if(uOpacity * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions.xyz,a_positions.xyz) - uFloatParams[0])) == 0.0){                    return;                }                vec3 right, up;                if(a_alignedAxis == ZERO3){                    up = vec3( viewMatrix[0][1], viewMatrix[1][1], viewMatrix[2][1] );                    right = vec3( viewMatrix[0][0], viewMatrix[1][0], viewMatrix[2][0] );                }else{                    up = normalize(a_alignedAxis);                    right = normalize(cross(look,up));                    look = cross(up,right);                }                float dist = dot(uCamPos - a_positions.xyz, vec3(viewMatrix[0][2], viewMatrix[1][2], viewMatrix[2][2]));                float focalSize = 2.0 * dist * uFloatParams[1];                vec2 offset = a_offset.xy * focalSize;                float scd = a_positions.w * (1.0 - smoothstep(uScaleByDistance[0], uScaleByDistance[1], lookLength)) * (1.0 - step(uScaleByDistance[2], lookLength));                vec2 scale = a_size * focalSize * scd;                float cosRot = cos(a_rotation);                float sinRot = sin(a_rotation);                vec3 rr = (right * cosRot - up * sinRot) * (scale.x * a_vertices.x + scd * offset.x) + (right * sinRot + up * cosRot) * (scale.y * a_vertices.y + scd * offset.y) + a_positions.xyz;                gl_Position = projectionMatrix * viewMatrix * vec4(rr, 1);                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                gl_Position.z += a_offset.z;            }",fragmentShader:t})}(e))}this._renderer.handler.shaderPrograms.billboardPicking||this._renderer.handler.addShaderProgram(new vi("billboardPicking",{uniforms:{projectionMatrix:{type:fi.MAT4},viewMatrix:{type:fi.MAT4},uCamPos:{type:fi.VEC3},uFloatParams:{type:fi.VEC2},uScaleByDistance:{type:fi.VEC3},uOpacity:{type:fi.FLOAT}},attributes:{a_vertices:{type:fi.VEC2,enableArray:!0},a_positions:{type:fi.VEC4,enableArray:!0},a_size:{type:fi.VEC2,enableArray:!0},a_offset:{type:fi.VEC3,enableArray:!0},a_pickingColor:{type:fi.VEC3,enableArray:!0},a_rotation:{type:fi.FLOAT,enableArray:!0},a_alignedAxis:{type:fi.VEC3,enableArray:!0}},vertexShader:"precision highp float;\n            attribute vec2 a_vertices;            attribute vec4 a_positions;            attribute vec3 a_offset;            attribute vec2 a_size;            attribute float a_rotation;            attribute vec3 a_pickingColor;            attribute vec3 a_alignedAxis;            varying vec4 v_color;            uniform mat4 viewMatrix;            uniform mat4 projectionMatrix;            uniform vec3 uCamPos;            uniform vec2 uFloatParams;            uniform vec3 uScaleByDistance;            uniform float uOpacity;            const vec3 ZERO3 = vec3(0.0);            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main() {                vec3 look = a_positions.xyz - uCamPos;                float lookLength = length(look);                if( uOpacity == 0.0 ) {                    gl_Position = vec4(0.0);                    return;                }                v_color = vec4(a_pickingColor.rgb, 1.0) * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions.xyz, a_positions.xyz) - uFloatParams[0]));                vec3 right, up;                if(a_alignedAxis == ZERO3){                    up = vec3( viewMatrix[0][1], viewMatrix[1][1], viewMatrix[2][1] );                    right = vec3( viewMatrix[0][0], viewMatrix[1][0], viewMatrix[2][0] );                }else{                    up = normalize(a_alignedAxis);                    right = normalize(cross(look,up));                    look = cross(up,right);                }                float dist = dot(uCamPos - a_positions.xyz, vec3(viewMatrix[0][2], viewMatrix[1][2], viewMatrix[2][2]));                float focalSize = 2.0 * dist * uFloatParams[1];                vec2 offset = a_offset.xy * focalSize;                float scd = a_positions.w * (1.0 - smoothstep(uScaleByDistance[0], uScaleByDistance[1], lookLength)) *(1.0 - step(uScaleByDistance[2], lookLength));                vec2 scale = a_size * focalSize * scd;                float cosRot = cos(a_rotation);                float sinRot = sin(a_rotation);                vec3 rr = (right * cosRot - up * sinRot) * (scale.x * a_vertices.x + scd * offset.x) + (right * sinRot + up * cosRot) * (scale.y * a_vertices.y + scd * offset.y) + a_positions.xyz;                gl_Position = projectionMatrix * viewMatrix * vec4(rr, 1);                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                gl_Position.z += a_offset.z;            }",fragmentShader:"precision highp float;\n            varying vec4 v_color;            void main () {                gl_FragColor = v_color;            }"}))}}setRenderer(e){this._renderer=e,this.initShaderProgram()}refresh(){for(var e=this._changedBuffers.length;e--;)this._changedBuffers[e]=!0}_removeBillboards(){for(var e=this._billboards.length;e--;){var t=this._billboards[e];t._handlerIndex=-1,t._handler=null}this._billboards.length=0,this._billboards=[]}clear(){this._texCoordArr.length=0,this._vertexArr.length=0,this._positionArr.length=0,this._sizeArr.length=0,this._offsetArr.length=0,this._rgbaArr.length=0,this._rotationArr.length=0,this._alignedAxisArr.length=0,this._pickingColorArr.length=0,this._texCoordArr=[],this._vertexArr=[],this._positionArr=[],this._sizeArr=[],this._offsetArr=[],this._rgbaArr=[],this._rotationArr=[],this._alignedAxisArr=[],this._pickingColorArr=[],this._removeBillboards(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){var e=this._renderer.handler.gl;e.deleteBuffer(this._positionBuffer),e.deleteBuffer(this._sizeBuffer),e.deleteBuffer(this._offsetBuffer),e.deleteBuffer(this._rgbaBuffer),e.deleteBuffer(this._rotationBuffer),e.deleteBuffer(this._vertexBuffer),e.deleteBuffer(this._texCoordBuffer),e.deleteBuffer(this._alignedAxisBuffer),e.deleteBuffer(this._pickingColorBuffer),this._positionBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._alignedAxisBuffer=null,this._pickingColorBuffer=null}update(){if(this._renderer)for(var e=this._changedBuffers.length;e--;)this._changedBuffers[e]&&(this._buffersUpdateCallbacks[e].call(this),this._changedBuffers[e]=!1)}add(e){-1==e._handlerIndex&&(e._handler=this,e._handlerIndex=this._billboards.length,this._billboards.push(e),this._addBillboardToArrays(e),this.refresh(),e.setSrc(e._src||e._image&&e._image.src))}_addBillboardToArrays(e){e._visibility?mr.concArr(this._vertexArr,[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]):mr.concArr(this._vertexArr,[0,0,0,0,0,0,0,0,0,0,0,0]),mr.concArr(this._texCoordArr,[0,0,0,0,0,0,0,0,0,0,0,0]);var t=e._position.x,i=e._position.y,r=e._position.z,s=e._scale;mr.concArr(this._positionArr,[t,i,r,s,t,i,r,s,t,i,r,s,t,i,r,s,t,i,r,s,t,i,r,s]),t=e._width,i=e._height,mr.concArr(this._sizeArr,[t,i,t,i,t,i,t,i,t,i,t,i]),t=e._offset.x,i=e._offset.y,r=e._offset.z,mr.concArr(this._offsetArr,[t,i,r,t,i,r,t,i,r,t,i,r,t,i,r,t,i,r]),t=e._color.x,i=e._color.y,r=e._color.z,s=e._color.w,mr.concArr(this._rgbaArr,[t,i,r,s,t,i,r,s,t,i,r,s,t,i,r,s,t,i,r,s,t,i,r,s]),t=e._rotation,mr.concArr(this._rotationArr,[t,t,t,t,t,t]),t=e._alignedAxis.x,i=e._alignedAxis.y,r=e._alignedAxis.z,mr.concArr(this._alignedAxisArr,[t,i,r,t,i,r,t,i,r,t,i,r,t,i,r,t,i,r]),t=e._entity._pickingColor.x/255,i=e._entity._pickingColor.y/255,r=e._entity._pickingColor.z/255,mr.concArr(this._pickingColorArr,[t,i,r,t,i,r,t,i,r,t,i,r,t,i,r,t,i,r])}_displayPASS(){var e=this._renderer,t=e.handler;t.shaderPrograms.billboard.activate();var i=t.shaderPrograms.billboard._program,r=i.attributes,s=i.uniforms,n=t.gl;n.uniform1i(s.u_texture._pName,0),n.uniformMatrix4fv(s.viewMatrix._pName,!1,e.activeCamera._viewMatrix._m),n.uniformMatrix4fv(s.projectionMatrix._pName,!1,e.activeCamera._projectionMatrix._m),n.uniform3fv(s.uCamPos._pName,e.activeCamera.eye.toVec()),n.uniform3fv(s.uScaleByDistance._pName,this._entityCollection.scaleByDistance),n.uniform1f(s.uOpacity._pName,this._entityCollection._animatedOpacity),n.uniform2fv(s.uFloatParams._pName,[this._entityCollection.renderNode._planetRadius2||0,e.activeCamera._tanViewAngle_hradOneByHeight]),n.bindBuffer(n.ARRAY_BUFFER,this._texCoordBuffer),n.vertexAttribPointer(r.a_texCoord._pName,this._texCoordBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._vertexBuffer),n.vertexAttribPointer(r.a_vertices._pName,this._vertexBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._positionBuffer),n.vertexAttribPointer(r.a_positions._pName,this._positionBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._rgbaBuffer),n.vertexAttribPointer(r.a_rgba._pName,this._rgbaBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._sizeBuffer),n.vertexAttribPointer(r.a_size._pName,this._sizeBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._offsetBuffer),n.vertexAttribPointer(r.a_offset._pName,this._offsetBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._rotationBuffer),n.vertexAttribPointer(r.a_rotation._pName,this._rotationBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._alignedAxisBuffer),n.vertexAttribPointer(r.a_alignedAxis._pName,this._alignedAxisBuffer.itemSize,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLES,0,this._vertexBuffer.numItems)}_pickingPASS(){var e=this._renderer,t=e.handler;t.shaderPrograms.billboardPicking.activate();var i=t.shaderPrograms.billboardPicking._program,r=i.attributes,s=i.uniforms,n=t.gl;n.uniformMatrix4fv(s.viewMatrix._pName,!1,e.activeCamera._viewMatrix._m),n.uniformMatrix4fv(s.projectionMatrix._pName,!1,e.activeCamera._projectionMatrix._m),n.uniform3fv(s.uCamPos._pName,e.activeCamera.eye.toVec()),n.uniform3fv(s.uScaleByDistance._pName,this._entityCollection.scaleByDistance),n.uniform1f(s.uOpacity._pName,this._entityCollection._animatedOpacity),n.uniform2fv(s.uFloatParams._pName,[this._entityCollection.renderNode._planetRadius2||0,e.activeCamera._tanViewAngle_hradOneByHeight]),n.bindBuffer(n.ARRAY_BUFFER,this._vertexBuffer),n.vertexAttribPointer(r.a_vertices._pName,this._vertexBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._positionBuffer),n.vertexAttribPointer(r.a_positions._pName,this._positionBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._pickingColorBuffer),n.vertexAttribPointer(r.a_pickingColor._pName,this._pickingColorBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._sizeBuffer),n.vertexAttribPointer(r.a_size._pName,this._sizeBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._offsetBuffer),n.vertexAttribPointer(r.a_offset._pName,this._offsetBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._rotationBuffer),n.vertexAttribPointer(r.a_rotation._pName,this._rotationBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._alignedAxisBuffer),n.vertexAttribPointer(r.a_alignedAxis._pName,this._alignedAxisBuffer.itemSize,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLES,0,this._vertexBuffer.numItems)}draw(){this._billboards.length&&(this.update(),this._displayPASS())}drawPicking(){this._billboards.length&&this.pickingEnabled&&this._pickingPASS()}reindexBillbordsArray(e){for(var t=this._billboards,i=e;i<t.length;i++)t[i]._handlerIndex=i}_removeBillboard(e){var t=e._handlerIndex;this._billboards.splice(t,1);var i=24*t;this._rgbaArr.splice(i,24),this._positionArr.splice(i,24),i=18*t,this._offsetArr.splice(i,18),this._alignedAxisArr.splice(i,18),this._pickingColorArr.splice(i,18),i=12*t,this._vertexArr.splice(i,12),this._sizeArr.splice(i,12),this._texCoordArr.splice(i,12),i=6*t,this._rotationArr.splice(i,6),this.reindexBillbordsArray(t),this.refresh(),e._handlerIndex=-1,e._handler=null}remove(e){e._handler&&this.__staticId==e._handler.__staticId&&this._removeBillboard(e)}setPositionArr(e,t){var i=24*e,r=this._positionArr,s=t.x,n=t.y,a=t.z;r[i]=s,r[i+1]=n,r[i+2]=a,r[i+4]=s,r[i+5]=n,r[i+6]=a,r[i+8]=s,r[i+9]=n,r[i+10]=a,r[i+12]=s,r[i+13]=n,r[i+14]=a,r[i+16]=s,r[i+17]=n,r[i+18]=a,r[i+20]=s,r[i+21]=n,r[i+22]=a,this._changedBuffers[ur]=!0}setScaleArr(e,t){var i=24*e,r=this._positionArr;r[i+3]=t,r[i+7]=t,r[i+11]=t,r[i+15]=t,r[i+19]=t,r[i+23]=t,this._changedBuffers[ur]=!0}setPickingColorArr(e,t){var i=18*e,r=this._pickingColorArr,s=t.x/255,n=t.y/255,a=t.z/255;r[i]=s,r[i+1]=n,r[i+2]=a,r[i+3]=s,r[i+4]=n,r[i+5]=a,r[i+6]=s,r[i+7]=n,r[i+8]=a,r[i+9]=s,r[i+10]=n,r[i+11]=a,r[i+12]=s,r[i+13]=n,r[i+14]=a,r[i+15]=s,r[i+16]=n,r[i+17]=a,this._changedBuffers[lr]=!0}setSizeArr(e,t,i){var r=12*e,s=this._sizeArr,n=t,a=i;s[r]=n,s[r+1]=a,s[r+2]=n,s[r+3]=a,s[r+4]=n,s[r+5]=a,s[r+6]=n,s[r+7]=a,s[r+8]=n,s[r+9]=a,s[r+10]=n,s[r+11]=a,this._changedBuffers[dr]=!0}setOffsetArr(e,t){var i=18*e,r=this._offsetArr,s=t.x,n=t.y,a=t.z;r[i]=s,r[i+1]=n,r[i+2]=a,r[i+3]=s,r[i+4]=n,r[i+5]=a,r[i+6]=s,r[i+7]=n,r[i+8]=a,r[i+9]=s,r[i+10]=n,r[i+11]=a,r[i+12]=s,r[i+13]=n,r[i+14]=a,r[i+15]=s,r[i+16]=n,r[i+17]=a,this._changedBuffers[cr]=!0}setRgbaArr(e,t){var i=24*e,r=this._rgbaArr,s=t.x,n=t.y,a=t.z,o=t.w;r[i]=s,r[i+1]=n,r[i+2]=a,r[i+3]=o,r[i+4]=s,r[i+5]=n,r[i+6]=a,r[i+7]=o,r[i+8]=s,r[i+9]=n,r[i+10]=a,r[i+11]=o,r[i+12]=s,r[i+13]=n,r[i+14]=a,r[i+15]=o,r[i+16]=s,r[i+17]=n,r[i+18]=a,r[i+19]=o,r[i+20]=s,r[i+21]=n,r[i+22]=a,r[i+23]=o,this._changedBuffers[_r]=!0}setRotationArr(e,t){var i=6*e,r=this._rotationArr;r[i]=t,r[i+1]=t,r[i+2]=t,r[i+3]=t,r[i+4]=t,r[i+5]=t,this._changedBuffers[fr]=!0}setTexCoordArr(e,t){var i=12*e,r=this._texCoordArr;r[i]=t[0],r[i+1]=t[1],r[i+2]=t[2],r[i+3]=t[3],r[i+4]=t[4],r[i+5]=t[5],r[i+6]=t[6],r[i+7]=t[7],r[i+8]=t[8],r[i+9]=t[9],r[i+10]=t[10],r[i+11]=t[11],this._changedBuffers[pr]=!0}setVisibility(e,t){var i;i=t?[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(e,i)}setVertexArr(e,t){var i=12*e,r=this._vertexArr;r[i]=t[0],r[i+1]=t[1],r[i+2]=t[2],r[i+3]=t[3],r[i+4]=t[4],r[i+5]=t[5],r[i+6]=t[6],r[i+7]=t[7],r[i+8]=t[8],r[i+9]=t[9],r[i+10]=t[10],r[i+11]=t[11],this._changedBuffers[vr]=!0}setAlignedAxisArr(e,t){var i=18*e,r=this._alignedAxisArr,s=t.x,n=t.y,a=t.z;r[i]=s,r[i+1]=n,r[i+2]=a,r[i+3]=s,r[i+4]=n,r[i+5]=a,r[i+6]=s,r[i+7]=n,r[i+8]=a,r[i+9]=s,r[i+10]=n,r[i+11]=a,r[i+12]=s,r[i+13]=n,r[i+14]=a,r[i+15]=s,r[i+16]=n,r[i+17]=a,this._changedBuffers[gr]=!0}createPositionBuffer(){var e=this._renderer.handler;e.gl.deleteBuffer(this._positionBuffer),this._positionBuffer=e.createArrayBuffer(new Float32Array(this._positionArr),4,this._positionArr.length/4,e.gl.DYNAMIC_DRAW)}createSizeBuffer(){var e=this._renderer.handler;e.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=e.createArrayBuffer(new Float32Array(this._sizeArr),2,this._sizeArr.length/2)}createOffsetBuffer(){var e=this._renderer.handler;e.gl.deleteBuffer(this._offsetBuffer),this._offsetBuffer=e.createArrayBuffer(new Float32Array(this._offsetArr),3,this._offsetArr.length/3)}createRgbaBuffer(){var e=this._renderer.handler;e.gl.deleteBuffer(this._rgbaBuffer),this._rgbaBuffer=e.createArrayBuffer(new Float32Array(this._rgbaArr),4,this._rgbaArr.length/4)}createRotationBuffer(){var e=this._renderer.handler;e.gl.deleteBuffer(this._rotationBuffer),this._rotationBuffer=e.createArrayBuffer(new Float32Array(this._rotationArr),1,this._rotationArr.length,e.gl.DYNAMIC_DRAW)}createVertexBuffer(){var e=this._renderer.handler;e.gl.deleteBuffer(this._vertexBuffer),this._vertexBuffer=e.createArrayBuffer(new Float32Array(this._vertexArr),2,this._vertexArr.length/2,e.gl.DYNAMIC_DRAW)}createTexCoordBuffer(){var e=this._renderer.handler;e.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=e.createArrayBuffer(new Float32Array(this._texCoordArr),2,this._texCoordArr.length/2,e.gl.DYNAMIC_DRAW)}createAlignedAxisBuffer(){var e=this._renderer.handler;e.gl.deleteBuffer(this._alignedAxisBuffer),this._alignedAxisBuffer=e.createArrayBuffer(new Float32Array(this._alignedAxisArr),3,this._alignedAxisArr.length/3)}createPickingColorBuffer(){var e=this._renderer.handler;e.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorBuffer=e.createArrayBuffer(new Float32Array(this._pickingColorArr),3,this._pickingColorArr.length/3)}refreshTexCoordsArr(){var e=this._entityCollection;if(e&&e.renderNode)for(var t=e.renderNode.billboardsTextureAtlas,i=0;i<this._billboards.length;i++){var r=this._billboards[i];if(r._image){var s=t.nodes[r._image.__nodeIndex];s&&this.setTexCoordArr(r._handlerIndex,s.texCoords)}}}}const xr=0,yr=1,Cr=2,br=3,Tr=4,Ar=5,Er=6,wr=7,Mr=8,Pr=9,Br=10,Lr=11;class Rr extends mr{constructor(e){super(e),this._fontIndexBuffer=null,this._noOutlineBuffer=null,this._outlineBuffer=null,this._outlineColorBuffer=null,this._fontIndexArr=[],this._noOutlineArr=[],this._outlineArr=[],this._outlineColorArr=[],this._buffersUpdateCallbacks[Pr]=this.createFontIndexBuffer,this._buffersUpdateCallbacks[Br]=this.createOutlineBuffer,this._buffersUpdateCallbacks[Lr]=this.createOutlineColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),this._maxLetters=25}initShaderProgram(){if(this._renderer.handler){if(!this._renderer.handler.shaderPrograms.label){var e=!this._renderer.isMultiFramebufferCompatible();this._renderer.handler.addShaderProgram(function(e){var t;return t=e?"#extension GL_OES_standard_derivatives : enable\n            precision highp float;\n            const int MAX_SIZE = 12;            uniform sampler2D u_fontTextureArr[MAX_SIZE];            varying float v_fontIndex;            varying vec2 v_texCoords;            varying vec4 v_rgba;            varying vec3 v_bufferAA;            varying vec3 v_pickingColor;            void main () {                int fi = int(v_fontIndex);                vec4 color;                if (fi == 0) {                    color = texture2D(u_fontTextureArr[0], v_texCoords);                } else if (fi == 1) {                    color = texture2D(u_fontTextureArr[1], v_texCoords);                } else if (fi == 2) {                    color = texture2D(u_fontTextureArr[2], v_texCoords);                } else if (fi == 3) {                    color = texture2D(u_fontTextureArr[3], v_texCoords);                } else if (fi == 4) {                    color = texture2D(u_fontTextureArr[4], v_texCoords);                } else if (fi == 5) {                    color = texture2D(u_fontTextureArr[5], v_texCoords);                } else if (fi == 6) {                    color = texture2D(u_fontTextureArr[6], v_texCoords);                } else if (fi == 7) {                    color = texture2D(u_fontTextureArr[7], v_texCoords);                } else if (fi == 8) {                    color = texture2D(u_fontTextureArr[8], v_texCoords);                } else if (fi == 9) {                    color = texture2D(u_fontTextureArr[9], v_texCoords);                }else{                    color = texture2D(u_fontTextureArr[10], v_texCoords);                }                float afwidth = step(0.5, v_bufferAA.x) * (1.0 - v_bufferAA.y) * v_bufferAA.x * fwidth( color.r );                float alpha = smoothstep ( v_bufferAA.x - afwidth - v_bufferAA.z, v_bufferAA.x + afwidth + v_bufferAA.z, color.r );                if( alpha < 0.2 )                    discard;                gl_FragColor = vec4(v_rgba.rgb, alpha * v_rgba.a);            }":"#extension GL_OES_standard_derivatives : enable\n            #extension GL_EXT_draw_buffers : require\n            precision highp float;\n            const int MAX_SIZE = 12;            uniform sampler2D u_fontTextureArr[MAX_SIZE];            varying float v_fontIndex;            varying vec2 v_texCoords;            varying vec4 v_rgba;            varying vec3 v_bufferAA;            varying vec3 v_pickingColor;            void main () {                int fi = int(v_fontIndex);                vec4 color;                if (fi == 0) {                    color = texture2D(u_fontTextureArr[0], v_texCoords);                } else if (fi == 1) {                    color = texture2D(u_fontTextureArr[1], v_texCoords);                } else if (fi == 2) {                    color = texture2D(u_fontTextureArr[2], v_texCoords);                } else if (fi == 3) {                    color = texture2D(u_fontTextureArr[3], v_texCoords);                } else if (fi == 4) {                    color = texture2D(u_fontTextureArr[4], v_texCoords);                } else if (fi == 5) {                    color = texture2D(u_fontTextureArr[5], v_texCoords);                } else if (fi == 6) {                    color = texture2D(u_fontTextureArr[6], v_texCoords);                } else if (fi == 7) {                    color = texture2D(u_fontTextureArr[7], v_texCoords);                } else if (fi == 8) {                    color = texture2D(u_fontTextureArr[8], v_texCoords);                } else if (fi == 9) {                    color = texture2D(u_fontTextureArr[9], v_texCoords);                }else{                    color = texture2D(u_fontTextureArr[10], v_texCoords);                }                float afwidth = step(0.5, v_bufferAA.x) * (1.0 - v_bufferAA.y) * v_bufferAA.x * fwidth( color.r );                float alpha = smoothstep ( v_bufferAA.x - afwidth - v_bufferAA.z, v_bufferAA.x + afwidth + v_bufferAA.z, color.r );                if( alpha < 0.2 )                    discard;                gl_FragData[0] = vec4(v_rgba.rgb, alpha * v_rgba.a);                gl_FragData[1] = vec4(0.0);            }",new vi("label",{uniforms:{u_fontTextureArr:{type:fi.SAMPLER2DXX},projectionMatrix:{type:fi.MAT4},viewMatrix:{type:fi.MAT4},uCamPos:{type:fi.VEC3},uFloatParams:{type:fi.VEC2},uZ:{type:fi.FLOAT},uScaleByDistance:{type:fi.VEC3},uOpacity:{type:fi.FLOAT}},attributes:{a_vertices:{type:fi.VEC2,enableArray:!0},a_texCoord:{type:fi.VEC4,enableArray:!0},a_positions:{type:fi.VEC4,enableArray:!0},a_size:{type:fi.FLOAT,enableArray:!0},a_offset:{type:fi.VEC3,enableArray:!0},a_rgba:{type:fi.VEC4,enableArray:!0},a_rotation:{type:fi.FLOAT,enableArray:!0},a_alignedAxis:{type:fi.VEC3,enableArray:!0},a_fontIndex:{type:fi.FLOAT,enableArray:!0},a_bufferAA:{type:fi.VEC2,enableArray:!0}},vertexShader:"attribute vec2 a_vertices;            attribute vec4 a_texCoord;            attribute vec4 a_positions;            attribute vec3 a_offset;            attribute float a_size;            attribute float a_rotation;            attribute vec4 a_rgba;            attribute vec3 a_alignedAxis;            attribute float a_fontIndex;            attribute vec2 a_bufferAA;            varying vec2 v_texCoords;            varying vec4 v_rgba;            varying float v_fontIndex;            varying vec3 v_bufferAA;            uniform mat4 viewMatrix;            uniform mat4 projectionMatrix;            uniform vec3 uCamPos;            /*0 - planetRadius^2, 1 - tan(fov), 2 - screen ratio*/            uniform vec2 uFloatParams;            uniform float uZ;            uniform vec3 uScaleByDistance;            uniform float uOpacity;            const vec3 ZERO3 = vec3(0.0);            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main() {                if(a_texCoord.z == -1.0 || a_bufferAA.x == 1.0){                    gl_Position = vec4(0.0);                    return;                }                v_fontIndex = a_fontIndex;                v_texCoords = vec2(a_texCoord.xy);                vec3 look = a_positions.xyz - uCamPos;                float lookDist = length(look);                v_rgba = a_rgba;                /*v_rgba.a *= uOpacity * step(lookDist, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions.xyz,a_positions.xyz) - uFloatParams[0]));*/                if(uOpacity * step(lookDist, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions.xyz,a_positions.xyz) - uFloatParams[0]))==0.0){                    return;                }                vec3 right, up;                if(a_alignedAxis == ZERO3){                    up = vec3( viewMatrix[0][1], viewMatrix[1][1], viewMatrix[2][1] );                    right = vec3( viewMatrix[0][0], viewMatrix[1][0], viewMatrix[2][0] );                }else{                    up = normalize(a_alignedAxis);                    right = normalize(cross(look,up));                    look = cross(up,right);                }                v_bufferAA = vec3(a_bufferAA, 8.0 * a_bufferAA.y / a_size);                float dist = dot(uCamPos - a_positions.xyz, vec3(viewMatrix[0][2], viewMatrix[1][2], viewMatrix[2][2]));                float focalSize = 2.0 * dist * uFloatParams[1];                vec2 offset = a_offset.xy * focalSize;                float scd = a_positions.w * (1.0 - smoothstep(uScaleByDistance[0], uScaleByDistance[1], lookDist)) * (1.0 - step(uScaleByDistance[2], lookDist));                float scale = a_size * focalSize * scd;                float cosRot = cos(a_rotation);                float sinRot = sin(a_rotation);                vec3 rr = (right * cosRot - up * sinRot) * (scale * (a_vertices.x + a_texCoord.z + a_texCoord.w) + scd * offset.x) + (right * sinRot + up * cosRot) * (scale * a_vertices.y + scd * offset.y) + a_positions.xyz;                gl_Position = projectionMatrix * viewMatrix * vec4(rr, 1);                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                gl_Position.z += a_offset.z + uZ;            }",fragmentShader:t})}(e))}this._renderer.handler.shaderPrograms.labelPicking||this._renderer.handler.addShaderProgram(new vi("labelPicking",{uniforms:{projectionMatrix:{type:fi.MAT4},viewMatrix:{type:fi.MAT4},uCamPos:{type:fi.VEC3},uFloatParams:{type:fi.VEC2},uScaleByDistance:{type:fi.VEC3},uOpacity:{type:fi.FLOAT}},attributes:{a_vertices:{type:fi.VEC2,enableArray:!0},a_texCoord:{type:fi.VEC4,enableArray:!0},a_positions:{type:fi.VEC4,enableArray:!0},a_size:{type:fi.FLOAT,enableArray:!0},a_offset:{type:fi.VEC3,enableArray:!0},a_pickingColor:{type:fi.VEC3,enableArray:!0},a_rotation:{type:fi.FLOAT,enableArray:!0},a_alignedAxis:{type:fi.VEC3,enableArray:!0}},vertexShader:"precision highp float;\n            attribute vec2 a_vertices;            attribute vec4 a_texCoord;            attribute vec4 a_positions;            attribute vec3 a_offset;            attribute float a_size;            attribute float a_rotation;            attribute vec3 a_pickingColor;            attribute vec3 a_alignedAxis;            varying vec4 v_color;            uniform mat4 viewMatrix;            uniform mat4 projectionMatrix;            uniform vec3 uCamPos;            /*0 - planetRadius^2, 1 - tan(fov), 2 - screen ratio*/            uniform vec2 uFloatParams;            uniform vec3 uScaleByDistance;            uniform float uOpacity;            const vec3 ZERO3 = vec3(0.0);            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main() {                if( uOpacity == 0.0 ){                    gl_Position = vec4(0.0);                    return;                }                if(a_texCoord.z == -1.0){                    gl_Position = vec4(0.0);                    return;                }                vec3 look = a_positions.xyz - uCamPos;                float lookLength = length(look);                v_color = vec4(a_pickingColor.rgb, 1.0) * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions.xyz, a_positions.xyz) - uFloatParams[0]));                vec3 right, up;                if(a_alignedAxis == ZERO3){                    up = vec3( viewMatrix[0][1], viewMatrix[1][1], viewMatrix[2][1] );                    right = vec3( viewMatrix[0][0], viewMatrix[1][0], viewMatrix[2][0] );                }else{                    up = normalize(a_alignedAxis);                    right = normalize(cross(look,up));                    look = cross(up,right);                }                float dist = dot(uCamPos - a_positions.xyz, vec3(viewMatrix[0][2], viewMatrix[1][2], viewMatrix[2][2]));                float focalSize = 2.0 * dist * uFloatParams[1];                vec2 offset = a_offset.xy * focalSize;                float scd = a_positions.w * (1.0 - smoothstep(uScaleByDistance[0], uScaleByDistance[1], lookLength)) *(1.0 - step(uScaleByDistance[2], lookLength));                float scale = a_size * focalSize * scd;                float cosRot = cos(a_rotation);                float sinRot = sin(a_rotation);                vec3 rr = (right * cosRot - up * sinRot) * (scale * (a_vertices.x + a_texCoord.z + a_texCoord.w) + scd * offset.x) + (right * sinRot + up * cosRot) * (scale * a_vertices.y + scd * offset.y) + a_positions.xyz;                gl_Position = projectionMatrix * viewMatrix * vec4(rr, 1);                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                gl_Position.z += a_offset.z;            }",fragmentShader:"precision highp float;\n            varying vec4 v_color;            void main () {                gl_FragColor = v_color;            }"}))}}add(e){-1==e._handlerIndex&&(e._handler=this,e._handlerIndex=this._billboards.length,this._billboards.push(e),this._addBillboardToArrays(e),this.refresh(),this.assignFontAtlas(e))}assignFontAtlas(e){this._entityCollection&&this._entityCollection.renderNode&&e.assignFontAtlas(this._entityCollection.renderNode.fontAtlas)}clear(){this._texCoordArr.length=0,this._vertexArr.length=0,this._positionArr.length=0,this._sizeArr.length=0,this._offsetArr.length=0,this._rgbaArr.length=0,this._rotationArr.length=0,this._alignedAxisArr.length=0,this._fontIndexArr.length=0,this._noOutlineArr.length=0,this._outlineArr.length=0,this._outlineColorArr.length=0,this._texCoordArr=[],this._vertexArr=[],this._positionArr=[],this._sizeArr=[],this._offsetArr=[],this._rgbaArr=[],this._rotationArr=[],this._alignedAxisArr=[],this._fontIndexArr=[],this._noOutlineArr=[],this._outlineArr=[],this._outlineColorArr=[],this._removeBillboards(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){var e=this._renderer.handler.gl;e.deleteBuffer(this._sizeBuffer),e.deleteBuffer(this._fontIndexBuffer),e.deleteBuffer(this._texCoordBuffer),e.deleteBuffer(this._outlineBuffer),e.deleteBuffer(this._noOutlineBuffer),e.deleteBuffer(this._outlineColorBuffer),e.deleteBuffer(this._positionBuffer),e.deleteBuffer(this._sizeBuffer),e.deleteBuffer(this._offsetBuffer),e.deleteBuffer(this._rgbaBuffer),e.deleteBuffer(this._rotationBuffer),e.deleteBuffer(this._vertexBuffer),e.deleteBuffer(this._texCoordBuffer),e.deleteBuffer(this._alignedAxisBuffer),e.deleteBuffer(this._pickingColorBuffer),this._sizeBuffer=null,this._fontIndexBuffer=null,this._texCoordBuffer=null,this._outlineBuffer=null,this._outlineColorBuffer=null,this._positionBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._alignedAxisBuffer=null,this._pickingColorBuffer=null}_addBillboardToArrays(e){for(var t=0;t<this._maxLetters;t++){e._visibility?mr.concArr(this._vertexArr,[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]):mr.concArr(this._vertexArr,[0,0,0,0,0,0,0,0,0,0,0,0]),mr.concArr(this._texCoordArr,[0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0]);var i=e._position.x,r=e._position.y,s=e._position.z,n=e._scale;mr.concArr(this._positionArr,[i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n]),i=e._size,mr.concArr(this._sizeArr,[i,i,i,i,i,i]),i=e._offset.x,r=e._offset.y,s=e._offset.z-.05,mr.concArr(this._offsetArr,[i,r,s,i,r,s,i,r,s,i,r,s,i,r,s,i,r,s]),i=e._color.x,r=e._color.y,s=e._color.z,n=e._color.w,mr.concArr(this._rgbaArr,[i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n]),i=e._rotation,mr.concArr(this._rotationArr,[i,i,i,i,i,i]),i=e._alignedAxis.x,r=e._alignedAxis.y,s=e._alignedAxis.z,mr.concArr(this._alignedAxisArr,[i,r,s,i,r,s,i,r,s,i,r,s,i,r,s,i,r,s]),i=e._fontIndex,mr.concArr(this._fontIndexArr,[0,0,0,0,0,0]),i=1-e._outline,r=0,mr.concArr(this._outlineArr,[i,r,i,r,i,r,i,r,i,r,i,r]),i=.75,r=.7,mr.concArr(this._noOutlineArr,[i,r,i,r,i,r,i,r,i,r,i,r]),i=e._outlineColor.x,r=e._outlineColor.y,s=e._outlineColor.z,n=e._outlineColor.w,mr.concArr(this._outlineColorArr,[i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n]),i=e._entity._pickingColor.x/255,r=e._entity._pickingColor.y/255,s=e._entity._pickingColor.z/255,mr.concArr(this._pickingColorArr,[i,r,s,i,r,s,i,r,s,i,r,s,i,r,s,i,r,s])}}_displayPASS(){var e=this._renderer,t=e.handler;t.shaderPrograms.label.activate();var i=t.shaderPrograms.label._program,r=i.attributes,s=i.uniforms,n=t.gl,a=this._entityCollection,o=a.renderNode;n.uniform1iv(s.u_fontTextureArr._pName,o.fontAtlas.samplerArr),n.uniformMatrix4fv(s.viewMatrix._pName,!1,e.activeCamera._viewMatrix._m),n.uniformMatrix4fv(s.projectionMatrix._pName,!1,e.activeCamera._projectionMatrix._m),n.uniform3fv(s.uCamPos._pName,e.activeCamera.eye.toVec()),n.uniform3fv(s.uScaleByDistance._pName,a.scaleByDistance),n.uniform1f(s.uOpacity._pName,a._animatedOpacity),n.uniform2fv(s.uFloatParams._pName,[o._planetRadius2||0,e.activeCamera._tanViewAngle_hradOneByHeight]),n.bindBuffer(n.ARRAY_BUFFER,this._texCoordBuffer),n.vertexAttribPointer(r.a_texCoord._pName,this._texCoordBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._vertexBuffer),n.vertexAttribPointer(r.a_vertices._pName,this._vertexBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._positionBuffer),n.vertexAttribPointer(r.a_positions._pName,this._positionBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._sizeBuffer),n.vertexAttribPointer(r.a_size._pName,this._sizeBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._offsetBuffer),n.vertexAttribPointer(r.a_offset._pName,this._offsetBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._rotationBuffer),n.vertexAttribPointer(r.a_rotation._pName,this._rotationBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._alignedAxisBuffer),n.vertexAttribPointer(r.a_alignedAxis._pName,this._alignedAxisBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._fontIndexBuffer),n.vertexAttribPointer(r.a_fontIndex._pName,this._fontIndexBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._outlineColorBuffer),n.vertexAttribPointer(r.a_rgba._pName,this._outlineColorBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._outlineBuffer),n.vertexAttribPointer(r.a_bufferAA._pName,this._outlineBuffer.itemSize,n.FLOAT,!1,0,0),n.uniform1f(s.uZ._pName,-2),n.drawArrays(n.TRIANGLES,0,this._vertexBuffer.numItems),n.bindBuffer(n.ARRAY_BUFFER,this._rgbaBuffer),n.vertexAttribPointer(r.a_rgba._pName,this._rgbaBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._noOutlineBuffer),n.vertexAttribPointer(r.a_bufferAA._pName,this._noOutlineBuffer.itemSize,n.FLOAT,!1,0,0),n.uniform1f(s.uZ._pName,-10),n.drawArrays(n.TRIANGLES,0,this._vertexBuffer.numItems)}_pickingPASS(){var e=this._renderer,t=e.handler;t.shaderPrograms.labelPicking.activate();var i=t.shaderPrograms.labelPicking._program,r=i.attributes,s=i.uniforms,n=t.gl;n.uniformMatrix4fv(s.viewMatrix._pName,!1,e.activeCamera._viewMatrix._m),n.uniformMatrix4fv(s.projectionMatrix._pName,!1,e.activeCamera._projectionMatrix._m),n.uniform3fv(s.uCamPos._pName,e.activeCamera.eye.toVec()),n.uniform3fv(s.uScaleByDistance._pName,this._entityCollection.scaleByDistance),n.uniform1f(s.uOpacity._pName,this._entityCollection._animatedOpacity),n.uniform2fv(s.uFloatParams._pName,[this._entityCollection.renderNode._planetRadius2||0,e.activeCamera._tanViewAngle_hradOneByHeight]),n.bindBuffer(n.ARRAY_BUFFER,this._vertexBuffer),n.vertexAttribPointer(r.a_vertices._pName,this._vertexBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._texCoordBuffer),n.vertexAttribPointer(r.a_texCoord._pName,this._texCoordBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._positionBuffer),n.vertexAttribPointer(r.a_positions._pName,this._positionBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._sizeBuffer),n.vertexAttribPointer(r.a_size._pName,this._sizeBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._offsetBuffer),n.vertexAttribPointer(r.a_offset._pName,this._offsetBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._rotationBuffer),n.vertexAttribPointer(r.a_rotation._pName,this._rotationBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._alignedAxisBuffer),n.vertexAttribPointer(r.a_alignedAxis._pName,this._alignedAxisBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._pickingColorBuffer),n.vertexAttribPointer(r.a_pickingColor._pName,this._pickingColorBuffer.itemSize,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLES,0,this._vertexBuffer.numItems)}_removeBillboard(e){var t=e._handlerIndex;this._billboards.splice(t,1);var i=24*this._maxLetters,r=t*i;this._rgbaArr.splice(r,i),this._outlineColorArr.splice(r,i),this._texCoordArr.splice(r,i),this._positionArr.splice(r,i),r=t*(i=18*this._maxLetters),this._offsetArr.splice(r,i),this._alignedAxisArr.splice(r,i),this._pickingColorArr.splice(r,i),r=t*(i=12*this._maxLetters),this._vertexArr.splice(r,i),this._outlineArr.splice(r,i),this._noOutlineArr.splice(r,i),r=t*(i=6*this._maxLetters),this._sizeArr.splice(r,i),this._rotationArr.splice(r,i),this._fontIndexArr.splice(r,i),this.reindexBillbordsArray(t),this.refresh(),e._handlerIndex=-1,e._handler=null}setText(e,t,i,r){var s=this._entityCollection.renderNode.fontAtlas.atlasesArr[i];if(s){var n=24*e*this._maxLetters,a=this._texCoordArr,o=n+24*(c=0),h=(u=s.nodes[t[c]])?u.emptySize:0,l=h;for(c=0;c<t.length;c++){o=n+24*c;var u,d=(u=s.nodes[t[c]]||s.nodes[" "]).texCoords;a[o]=d[0],a[o+1]=d[1],a[o+2]=l,a[o+3]=0,a[o+4]=d[2],a[o+5]=d[3],a[o+6]=l,a[o+7]=0,a[o+8]=d[4],a[o+9]=d[5],a[o+10]=l,a[o+11]=0,a[o+12]=d[6],a[o+13]=d[7],a[o+14]=l,a[o+15]=0,a[o+16]=d[8],a[o+17]=d[9],a[o+18]=l,a[o+19]=0,a[o+20]=d[10],a[o+21]=d[11],a[o+22]=l,a[o+23]=0,l+=u.emptySize}if(r==Qi.CENTER)for(l=.5*(h+49/512-l),c=0;c<t.length;c++){a[(o=n+24*c)+3]=l,a[o+7]=l,a[o+11]=l,a[o+15]=l,a[o+19]=l,a[o+23]=l}else if(r==Qi.LEFT)for(l=h+49/512-l,c=0;c<t.length;c++){a[(o=n+24*c)+3]=l,a[o+7]=l,a[o+11]=l,a[o+15]=l,a[o+19]=l,a[o+23]=l}for(var c=c;c<this._maxLetters;c++){a[(o=n+24*c)+2]=-1,a[o+6]=-1,a[o+10]=-1,a[o+14]=-1,a[o+18]=-1,a[o+17]=-1}this._changedBuffers[Er]=!0}}setPositionArr(e,t){for(var i=24*e*this._maxLetters,r=this._positionArr,s=t.x,n=t.y,a=t.z,o=0;o<this._maxLetters;o++){var h=i+24*o;r[h]=s,r[h+1]=n,r[h+2]=a,r[h+4]=s,r[h+5]=n,r[h+6]=a,r[h+8]=s,r[h+9]=n,r[h+10]=a,r[h+12]=s,r[h+13]=n,r[h+14]=a,r[h+16]=s,r[h+17]=n,r[h+18]=a,r[h+20]=s,r[h+21]=n,r[h+22]=a}this._changedBuffers[yr]=!0}setScaleArr(e,t){for(var i=24*e*this._maxLetters,r=this._positionArr,s=0;s<this._maxLetters;s++){var n=i+24*s;r[n+3]=t,r[n+7]=t,r[n+11]=t,r[n+15]=t,r[n+19]=t,r[n+23]=t}this._changedBuffers[yr]=!0}setPickingColorArr(e,t){for(var i=18*e*this._maxLetters,r=this._pickingColorArr,s=t.x/255,n=t.y/255,a=t.z/255,o=0;o<this._maxLetters;o++){var h=i+18*o;r[h]=s,r[h+1]=n,r[h+2]=a,r[h+3]=s,r[h+4]=n,r[h+5]=a,r[h+6]=s,r[h+7]=n,r[h+8]=a,r[h+9]=s,r[h+10]=n,r[h+11]=a,r[h+12]=s,r[h+13]=n,r[h+14]=a,r[h+15]=s,r[h+16]=n,r[h+17]=a}this._changedBuffers[xr]=!0}setSizeArr(e,t){for(var i=6*e*this._maxLetters,r=this._sizeArr,s=0;s<this._maxLetters;s++){var n=i+6*s;r[n]=t,r[n+1]=t,r[n+2]=t,r[n+3]=t,r[n+4]=t,r[n+5]=t}this._changedBuffers[Cr]=!0}setOffsetArr(e,t){for(var i=18*e*this._maxLetters,r=this._offsetArr,s=t.x,n=t.y,a=t.z,o=0;o<this._maxLetters;o++){var h=i+18*o;r[h]=s,r[h+1]=n,r[h+2]=a,r[h+3]=s,r[h+4]=n,r[h+5]=a,r[h+6]=s,r[h+7]=n,r[h+8]=a,r[h+9]=s,r[h+10]=n,r[h+11]=a,r[h+12]=s,r[h+13]=n,r[h+14]=a,r[h+15]=s,r[h+16]=n,r[h+17]=a}this._changedBuffers[br]=!0}setRgbaArr(e,t){for(var i=24*e*this._maxLetters,r=this._rgbaArr,s=t.x,n=t.y,a=t.z,o=t.w,h=0;h<this._maxLetters;h++){var l=i+24*h;r[l]=s,r[l+1]=n,r[l+2]=a,r[l+3]=o,r[l+4]=s,r[l+5]=n,r[l+6]=a,r[l+7]=o,r[l+8]=s,r[l+9]=n,r[l+10]=a,r[l+11]=o,r[l+12]=s,r[l+13]=n,r[l+14]=a,r[l+15]=o,r[l+16]=s,r[l+17]=n,r[l+18]=a,r[l+19]=o,r[l+20]=s,r[l+21]=n,r[l+22]=a,r[l+23]=o}this._changedBuffers[Tr]=!0}setOutlineColorArr(e,t){for(var i=24*e*this._maxLetters,r=this._outlineColorArr,s=t.x,n=t.y,a=t.z,o=t.w,h=0;h<this._maxLetters;h++){var l=i+24*h;r[l]=s,r[l+1]=n,r[l+2]=a,r[l+3]=o,r[l+4]=s,r[l+5]=n,r[l+6]=a,r[l+7]=o,r[l+8]=s,r[l+9]=n,r[l+10]=a,r[l+11]=o,r[l+12]=s,r[l+13]=n,r[l+14]=a,r[l+15]=o,r[l+16]=s,r[l+17]=n,r[l+18]=a,r[l+19]=o,r[l+20]=s,r[l+21]=n,r[l+22]=a,r[l+23]=o}this._changedBuffers[Lr]=!0}setOutlineArr(e,t){for(var i=12*e*this._maxLetters,r=this._outlineArr,s=0;s<this._maxLetters;s++){var n=i+12*s;r[n]=t,r[n+2]=t,r[n+4]=t,r[n+6]=t,r[n+8]=t,r[n+10]=t}this._changedBuffers[Br]=!0}setRotationArr(e,t){for(var i=6*e*this._maxLetters,r=this._rotationArr,s=0;s<this._maxLetters;s++){var n=i+6*s;r[n]=t,r[n+1]=t,r[n+2]=t,r[n+3]=t,r[n+4]=t,r[n+5]=t}this._changedBuffers[Ar]=!0}setVertexArr(e,t){for(var i=12*e*this._maxLetters,r=this._vertexArr,s=0;s<this._maxLetters;s++){var n=i+12*s;r[n]=t[0],r[n+1]=t[1],r[n+2]=t[2],r[n+3]=t[3],r[n+4]=t[4],r[n+5]=t[5],r[n+6]=t[6],r[n+7]=t[7],r[n+8]=t[8],r[n+9]=t[9],r[n+10]=t[10],r[n+11]=t[11]}this._changedBuffers[wr]=!0}setAlignedAxisArr(e,t){for(var i=18*e*this._maxLetters,r=this._alignedAxisArr,s=t.x,n=t.y,a=t.z,o=0;o<this._maxLetters;o++){var h=i+18*o;r[h]=s,r[h+1]=n,r[h+2]=a,r[h+3]=s,r[h+4]=n,r[h+5]=a,r[h+6]=s,r[h+7]=n,r[h+8]=a,r[h+9]=s,r[h+10]=n,r[h+11]=a,r[h+12]=s,r[h+13]=n,r[h+14]=a,r[h+15]=s,r[h+16]=n,r[h+17]=a}this._changedBuffers[Mr]=!0}setFontIndexArr(e,t){for(var i=6*e*this._maxLetters,r=this._fontIndexArr,s=0;s<this._maxLetters;s++){var n=i+6*s;r[n]=t,r[n+1]=t,r[n+2]=t,r[n+3]=t,r[n+4]=t,r[n+5]=t}this._changedBuffers[Pr]=!0}createSizeBuffer(){var e=this._renderer.handler;e.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=e.createArrayBuffer(new Float32Array(this._sizeArr),1,this._sizeArr.length)}createFontIndexBuffer(){var e=this._renderer.handler;e.gl.deleteBuffer(this._fontIndexBuffer),this._fontIndexBuffer=e.createArrayBuffer(new Float32Array(this._fontIndexArr),1,this._fontIndexArr.length)}createTexCoordBuffer(){var e=this._renderer.handler;e.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=e.createArrayBuffer(new Float32Array(this._texCoordArr),4,this._texCoordArr.length/4)}createOutlineBuffer(){var e=this._renderer.handler;e.gl.deleteBuffer(this._outlineBuffer),this._outlineBuffer=e.createArrayBuffer(new Float32Array(this._outlineArr),2,this._outlineArr.length/2),e.gl.deleteBuffer(this._noOutlineBuffer),this._noOutlineBuffer=e.createArrayBuffer(new Float32Array(this._noOutlineArr),2,this._noOutlineArr.length/2)}createOutlineColorBuffer(){var e=this._renderer.handler;e.gl.deleteBuffer(this._outlineColorBuffer),this._outlineColorBuffer=e.createArrayBuffer(new Float32Array(this._outlineColorArr),4,this._outlineColorArr.length/4)}setMaxLetters(e){this._maxLetters=e}refreshTexCoordsArr(){return null}}class Sr{constructor(e){this._entityCollection=e,this._renderer=null,this._polylines=[],this.__staticId=Sr._staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}_initShaderProgram(){var e;this._renderer.handler&&(this._renderer.handler.shaderPrograms.polyline||this._renderer.handler.addShaderProgram((e=this._renderer.isMultiFramebufferCompatible(),new vi("polyline",e?{uniforms:{viewport:{type:fi.VEC2},proj:{type:fi.MAT4},view:{type:fi.MAT4},viewport:{type:fi.VEC2},uCamPos:{type:fi.VEC3},uFloatParams:{type:fi.VEC2},color:{type:fi.VEC4},thickness:{type:fi.FLOAT},pickingColor:{type:fi.VEC3}},attributes:{prev:{type:fi.VEC3},current:{type:fi.VEC3},next:{type:fi.VEC3},order:{type:fi.FLOAT}},vertexShader:"attribute vec3 prev;                attribute vec3 current;                attribute vec3 next;                attribute float order;                uniform float thickness;                uniform vec4 color;                uniform mat4 proj;                uniform mat4 view;                uniform vec2 viewport;                varying vec4 vColor;                varying vec3 vPos;                                const float C = 0.1;                const float far = 149.6e+9;                float logc = 2.0 / log( C * far + 1.0 );                                const float NEAR = -1.0;                                vec2 project(vec4 p){                    return (0.5 * p.xyz / p.w + 0.5).xy * viewport;                }                                void main(){                    vColor = color;                    vPos = current;                                        vec4 vCurrent = view * vec4(current, 1.0);                    vec4 vPrev = view * vec4(prev, 1.0);                    vec4 vNext = view * vec4(next, 1.0);                                        /*Clip near plane*/                    if(vCurrent.z > NEAR) {                        if(vPrev.z < NEAR){                            /*to the begining path view*/                            vCurrent = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);                        }else if(vNext.z < NEAR){                            /*to the end path view*/                            vPrev = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);                            vCurrent = vNext + (vCurrent - vNext) * (NEAR - vNext.z) / (vCurrent.z - vNext.z);                        }                    } else if( vPrev.z > NEAR) {                        /*to the end path view*/                        vPrev = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);                    } else if( vNext.z > NEAR) {                        /*to the begining path view*/                        vNext = vNext + (vCurrent - vNext) * (NEAR - vNext.z) / (vCurrent.z - vNext.z);                    }                                        vec4 dCurrent = proj * vCurrent;                    vec2 _next = project(proj * vNext);                    vec2 _prev = project(proj * vPrev);                    vec2 _current = project(dCurrent);                    if(_prev == _current){                        if(_next == _current){                            _next = _current + vec2(1.0, 0.0);                            _prev = _current - _next;                        }else{                            _prev = _current + normalize(_current - _next);                        }                    }                    if(_next == _current){                        _next = _current + normalize(_current - _prev);                    }                                        vec2 sNext = _next,                         sCurrent = _current,                         sPrev = _prev;                    vec2 dirNext = normalize(sNext - sCurrent);                    vec2 dirPrev = normalize(sPrev - sCurrent);                    float dotNP = dot(dirNext, dirPrev);                                        vec2 normalNext = normalize(vec2(-dirNext.y, dirNext.x));                    vec2 normalPrev = normalize(vec2(dirPrev.y, -dirPrev.x));                                        float d = thickness * sign(order);                                        vec2 m;                    if(dotNP >= 0.99991){                        m = sCurrent - normalPrev * d;                    }else{                        vec2 dir = normalPrev + normalNext;                        m = sCurrent + dir * d / (dirNext.x * dir.y - dirNext.y * dir.x);                                                if( dotNP > 0.5 && dot(dirNext + dirPrev, m - sCurrent) < 0.0 ){                            float occw = order * sign(dirNext.x * dirPrev.y - dirNext.y * dirPrev.x);                            if(occw == -1.0){                                m = sCurrent + normalPrev * d;                            }else if(occw == 1.0){                                m = sCurrent + normalNext * d;                            }else if(occw == -2.0){                                m = sCurrent + normalNext * d;                            }else if(occw == 2.0){                                m = sCurrent + normalPrev * d;                            }                        }else if(distance(sCurrent, m) > min(distance(sCurrent, sNext), distance(sCurrent, sPrev))){                            m = sCurrent + normalNext * d;                        }                    }                    gl_Position = vec4((2.0 * m / viewport - 1.0) * dCurrent.w, dCurrent.z, dCurrent.w);                    gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                }",fragmentShader:"#extension GL_EXT_draw_buffers : require\n                precision highp float;\n                uniform vec3 pickingColor;                uniform vec2 uFloatParams;                uniform vec3 uCamPos;                varying vec4 vColor;                varying vec3 vPos;                void main() {                    vec3 look = vPos - uCamPos;                    float lookLength = length(look);                    float a = vColor.a * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(vPos,vPos) - uFloatParams[0]));                    gl_FragData[0] = vec4(vColor.rgb, a);                    gl_FragData[1] = vec4(pickingColor, 1.0);                }"}:{uniforms:{viewport:{type:fi.VEC2},proj:{type:fi.MAT4},view:{type:fi.MAT4},viewport:{type:fi.VEC2},uCamPos:{type:fi.VEC3},uFloatParams:{type:fi.VEC2},color:{type:fi.VEC4},thickness:{type:fi.FLOAT}},attributes:{prev:{type:fi.VEC3},current:{type:fi.VEC3},next:{type:fi.VEC3},order:{type:fi.FLOAT}},vertexShader:"attribute vec3 prev;                attribute vec3 current;                attribute vec3 next;                attribute float order;                uniform float thickness;                uniform vec4 color;                uniform mat4 proj;                uniform mat4 view;                uniform vec2 viewport;                varying vec4 vColor;                varying vec3 vPos;                                const float C = 0.1;                const float far = 149.6e+9;                float logc = 2.0 / log( C * far + 1.0 );                                const float NEAR = -1.0;                                vec2 getIntersection(vec2 start1, vec2 end1, vec2 start2, vec2 end2){                    vec2 dir = end2 - start2;                    vec2 perp = vec2(-dir.y, dir.x);                    float d2 = dot(perp, start2);                    float seg = dot(perp, start1) - d2;                    float prl = seg - dot(perp, end1) + d2;                    if(prl > -1.0 && prl < 1.0){                        return start1;                    }                    float u = seg / prl;                    return start1 + u * (end1 - start1);                }                                vec2 project(vec4 p){                    return (0.5 * p.xyz / p.w + 0.5).xy * viewport;                }                                void main(){                    vColor = color;                    vPos = current;                                        vec4 vCurrent = view * vec4(current, 1.0);                    vec4 vPrev = view * vec4(prev, 1.0);                    vec4 vNext = view * vec4(next, 1.0);                                        /*Clip near plane*/                    if(vCurrent.z > NEAR) {                        if(vPrev.z < NEAR){                            /*to the begining path view*/                            vCurrent = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);                        }else if(vNext.z < NEAR){                            /*to the end path view*/                            vPrev = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);                            vCurrent = vNext + (vCurrent - vNext) * (NEAR - vNext.z) / (vCurrent.z - vNext.z);                        }                    } else if( vPrev.z > NEAR) {                        /*to the end path view*/                        vPrev = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);                    } else if( vNext.z > NEAR) {                        /*to the begining path view*/                        vNext = vNext + (vCurrent - vNext) * (NEAR - vNext.z) / (vCurrent.z - vNext.z);                    }                                        vec4 dCurrent = proj * vCurrent;                    vec2 _next = project(proj * vNext);                    vec2 _prev = project(proj * vPrev);                    vec2 _current = project(dCurrent);                    if(_prev == _current){                        if(_next == _current){                            _next = _current + vec2(1.0, 0.0);                            _prev = _current - _next;                        }else{                            _prev = _current + normalize(_current - _next);                        }                    }                    if(_next == _current){                        _next = _current + normalize(_current - _prev);                    }                                        vec2 sNext = _next,                         sCurrent = _current,                         sPrev = _prev;                    vec2 dirNext = normalize(sNext - sCurrent);                    vec2 dirPrev = normalize(sPrev - sCurrent);                    float dotNP = dot(dirNext, dirPrev);                                        vec2 normalNext = normalize(vec2(-dirNext.y, dirNext.x));                    vec2 normalPrev = normalize(vec2(dirPrev.y, -dirPrev.x));                                        float d = thickness * sign(order);                                        vec2 m;                    if(dotNP >= 0.99991){                        m = sCurrent - normalPrev * d;                    }else{                        m = getIntersection( sCurrent + normalPrev * d, sPrev + normalPrev * d,                            sCurrent + normalNext * d, sNext + normalNext * d );                                                if( dotNP > 0.5 && dot(dirNext + dirPrev, m - sCurrent) < 0.0 ){                            float occw = order * sign(dirNext.x * dirPrev.y - dirNext.y * dirPrev.x);                            if(occw == -1.0){                                m = sCurrent + normalPrev * d;                            }else if(occw == 1.0){                                m = sCurrent + normalNext * d;                            }else if(occw == -2.0){                                m = sCurrent + normalNext * d;                            }else if(occw == 2.0){                                m = sCurrent + normalPrev * d;                            }                        }else if(distance(sCurrent, m) > min(distance(sCurrent, sNext), distance(sCurrent, sPrev))){                            m = sCurrent + normalNext * d;                        }                    }                    gl_Position = vec4((2.0 * m / viewport - 1.0) * dCurrent.w, dCurrent.z, dCurrent.w);                    gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                }",fragmentShader:"precision highp float;                uniform vec2 uFloatParams;                uniform vec3 uCamPos;                varying vec4 vColor;                varying vec3 vPos;                void main() {                    vec3 look = vPos - uCamPos;                    float lookLength = length(look);                    float a = vColor.a * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(vPos,vPos) - uFloatParams[0]));                    gl_FragColor = vec4(vColor.rgb, a);                }"}))))}setRenderNode(e){this._renderer=e.renderer,this._initShaderProgram();for(var t=0;t<this._polylines.length;t++)this._polylines[t].setRenderNode(e)}add(e){-1==e._handlerIndex&&(e._handler=this,e._handlerIndex=this._polylines.length,this._polylines.push(e),this._entityCollection&&this._entityCollection.renderNode&&e.setRenderNode(this._entityCollection.renderNode))}remove(e){var t=e._handlerIndex;-1!==t&&(e._deleteBuffers(),e._handlerIndex=-1,e._handler=null,this._polylines.splice(t,1),this.reindexPolylineArray(t))}reindexPolylineArray(e){for(var t=this._polylines,i=e;i<t.length;i++)t[i]._handlerIndex=i}draw(){for(var e=this._polylines.length;e--;)this._polylines[e].draw()}clear(){for(var e=this._polylines.length;e--;)this._polylines[e]._deleteBuffers(),this._polylines[e]._handler=null,this._polylines[e]._handlerIndex=-1;this._polylines.length=0,this._polylines=[]}}class Nr{constructor(e){this.pickingEnabled=!0,this._entityCollection=e,this._renderer=null,this._pointClouds=[],this.__staticId=Nr._staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}_initShaderProgram(){this._renderer.handler&&(this._renderer.handler.shaderPrograms.pointCloud||this._renderer.handler.addShaderProgram(new vi("pointCloud",{uniforms:{projectionViewMatrix:{type:fi.MAT4},opacity:{type:fi.FLOAT},pointSize:{type:fi.FLOAT}},attributes:{coordinates:{type:fi.VEC3,enableArray:!0},colors:{type:fi.VEC3,enableArray:!0}},vertexShader:"attribute vec3 coordinates;            attribute vec4 colors;            uniform mat4 projectionViewMatrix;            uniform float opacity;            uniform float pointSize;            varying vec4 color;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main() {                color = colors;                color.a *= opacity;                gl_Position = projectionViewMatrix * vec4(coordinates, 1.0);                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                gl_PointSize = pointSize;            }",fragmentShader:"precision highp float;\n            varying vec4 color;            void main(void) {                gl_FragColor = color;            }"})))}setRenderNode(e){this._renderer=e.renderer,this._initShaderProgram();for(var t=0;t<this._pointClouds.length;t++)this._pointClouds[t].setRenderNode(e)}add(e){-1==e._handlerIndex&&(e._handler=this,e._handlerIndex=this._pointClouds.length,this._pointClouds.push(e),this._entityCollection&&this._entityCollection.renderNode&&e.setRenderNode(this._entityCollection.renderNode))}remove(e){var t=e._handlerIndex;-1!==t&&(e._deleteBuffers(),e._handlerIndex=-1,e._handler=null,this._pointClouds.splice(t,1),this.reindexPointCloudArray(t))}reindexPointCloudArray(e){for(var t=this._pointClouds,i=e;i<t.length;i++)t[i]._handlerIndex=i}draw(){for(var e=this._pointClouds.length;e--;)this._pointClouds[e].draw()}drawPicking(){if(this.pickingEnabled)for(var e=this._pointClouds.length;e--;)this._pointClouds[e].drawPicking()}clear(){for(var e=this._pointClouds.length;e--;)this._pointClouds[e]._deleteBuffers(),this._pointClouds[e]._handler=null,this._pointClouds[e]._handlerIndex=-1;this._pointClouds.length=0,this._pointClouds=[]}}class Ir{constructor(e){this.pickingEnabled=!0,this._entityCollection=e,this._renderer=null,this._shapes=[],this.__staticId=Ir._staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}_initShaderProgram(){this._renderer.handler&&(this._renderer.handler.shaderPrograms.shape_nl||this._renderer.handler.addShaderProgram(new vi("shape_nl",{uniforms:{projectionViewMatrix:{type:fi.MAT4},modelMatrix:{type:fi.MAT4},uColor:{type:fi.VEC4},uSampler:{type:fi.SAMPLER2D}},attributes:{aVertexPosition:{type:fi.VEC3,enableArray:!0},aTextureCoord:{type:fi.VEC2,enableArray:!0}},vertexShader:"attribute vec3 aVertexPosition;            attribute vec2 aTextureCoord;            uniform mat4 projectionViewMatrix;            uniform mat4 modelMatrix;            varying vec2 vTextureCoord;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main(void) {                gl_Position = projectionViewMatrix * (modelMatrix * vec4(aVertexPosition, 1.0));                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                vTextureCoord = aTextureCoord;            }",fragmentShader:"precision highp float;\n            uniform vec4 uColor;            uniform sampler2D uSampler;            varying vec2 vTextureCoord;            void main(void) {                gl_FragColor = uColor*texture2D( uSampler, vTextureCoord.st );            }"})),this._renderer.handler.shaderPrograms.shape_wl||this._renderer.handler.addShaderProgram(new vi("shape_wl",{uniforms:{viewMatrix:{type:fi.MAT4},projectionMatrix:{type:fi.MAT4},modelMatrix:{type:fi.MAT4},normalMatrix:{type:fi.MAT4},lightsPositions:{type:fi.VEC4},lightsParamsv:{type:fi.VEC3},lightsParamsf:{type:fi.FLOAT},uColor:{type:fi.VEC4},uSampler:{type:fi.SAMPLER2D}},attributes:{aVertexNormal:{type:fi.VEC3,enableArray:!0},aVertexPosition:{type:fi.VEC3,enableArray:!0},aTextureCoord:{type:fi.VEC2,enableArray:!0}},vertexShader:"attribute vec3 aVertexNormal;            attribute vec3 aVertexPosition;            attribute vec2 aTextureCoord;            uniform mat4 projectionMatrix;            uniform mat4 viewMatrix;            uniform mat4 modelMatrix;            uniform mat3 normalMatrix;            varying vec2 vTextureCoord;            varying vec3 vNormal;            varying vec4 vPosition;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main(void) {                vTextureCoord = aTextureCoord;                vNormal = normalMatrix * aVertexNormal;                vPosition = viewMatrix * modelMatrix * vec4(aVertexPosition, 1.0);                gl_Position = projectionMatrix * vPosition;                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;            }",fragmentShader:"precision highp float;\n            varying vec2 vTextureCoord;            varying vec3 vNormal;            varying vec4 vPosition;            uniform vec4 uColor;            uniform sampler2D uSampler;\n            #define MAX_POINT_LIGHTS 1\n            uniform int lightsQuantity;            uniform vec4 lightsPositions[MAX_POINT_LIGHTS];            uniform vec3 lightsParamsv[MAX_POINT_LIGHTS * 3];            uniform float lightsParamsf[MAX_POINT_LIGHTS];            void main(void) {                vec3 lightWeighting;                vec3 lightDirection;                vec3 normal;                vec3 eyeDirection;                vec3 reflectionDirection;                float specularLightWeighting;                float diffuseLightWeighting;                lightDirection = normalize(lightsPositions[0].xyz - vPosition.xyz * lightsPositions[0].w);                normal = normalize(vNormal);                eyeDirection = normalize(-vPosition.xyz);                reflectionDirection = reflect(-lightDirection, normal);                specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), lightsParamsf[0]);                diffuseLightWeighting = max(dot(normal, lightDirection), 0.0);                lightWeighting = lightsParamsv[0] + lightsParamsv[1] * diffuseLightWeighting + lightsParamsv[2] * specularLightWeighting;                vec4 cc = texture2D( uSampler, vTextureCoord.st );                gl_FragColor = vec4(lightWeighting, uColor.a) * cc * uColor;            }"})))}setRenderNode(e){this._renderer=e.renderer,this._initShaderProgram();for(var t=0;t<this._shapes.length;t++)this._shapes[t].setRenderNode(e)}add(e){-1==e._handlerIndex&&(e._handler=this,e._handlerIndex=this._shapes.length,this._shapes.push(e),this._entityCollection&&this._entityCollection.renderNode&&e.setRenderNode(this._entityCollection.renderNode))}remove(e){}draw(){for(var e=this._shapes.length;e--;)this._shapes[e].draw()}drawPicking(){}clear(){}}class Fr{constructor(e){e=e||{},this.id=Fr.__staticCounter++,this._renderNodeIndex=-1,this.renderNode=null,this._visibility=void 0==e.visibility||e.visibility,this.billboardHandler=new mr(this),this.labelHandler=new Rr(this),this.shapeHandler=new Ir(this),this.polylineHandler=new Sr(this),this.pointCloudHandler=new Nr(this),void 0!=e.pickingEnabled&&this.setPickingEnabled(e.pickingEnabled),this._entities=e.entities||[],this.scaleByDistance=e.scaleByDistance||[m,m,m],this._opacity=void 0==e.opacity?1:e.opacity,this._animatedOpacity=this._opacity,this.events=new ni(zr),this.addEntities(this._entities)}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}setVisibility(e){this._visibility=e,this._animatedOpacity=this._opacity*(e?1:0),this.events.dispatch(this.events.visibilitychange,this)}getVisibility(){return this._visibility}setOpacity(e){this._opacity=e}setPickingEnabled(e){this.billboardHandler.pickingEnabled=e,this.labelHandler.pickingEnabled=e,this.polylineHandler.pickingEnabled=e,this.shapeHandler.pickingEnabled=e,this.pointCloudHandler.pickingEnabled=e}getOpacity(){return this._opacity}setScaleByDistance(e,t,i){this.scaleByDistance[0]=e,this.scaleByDistance[1]=t,this.scaleByDistance[2]=i||m}_addRecursively(e){e.billboard&&this.billboardHandler.add(e.billboard),e.label&&this.labelHandler.add(e.label),e.shape&&this.shapeHandler.add(e.shape),e.polyline&&this.polylineHandler.add(e.polyline),e.pointCloud&&this.pointCloudHandler.add(e.pointCloud),this.events.dispatch(this.events.entityadd,e);for(var t=0;t<e.childrenNodes.length;t++)e.childrenNodes[t]._entityCollection=this,e.childrenNodes[t]._entityCollectionIndex=e._entityCollectionIndex,e.childrenNodes[t]._pickingColor=e._pickingColor,this._addRecursively(e.childrenNodes[t])}add(e){if(!e._entityCollection){e._entityCollection=this,e._entityCollectionIndex=this._entities.length,this._entities.push(e);var t=this.renderNode;t&&(t.renderer&&t.renderer.assignPickingColor(e),t.ellipsoid&&e._lonlat&&e.setCartesian3v(t.ellipsoid.lonLatToCartesian(e._lonlat))),this._addRecursively(e)}return this}addEntities(e){for(var t=e.length;t--;)this.add(e[t]);return this}belongs(e){return e._entityCollection&&this._renderNodeIndex==e._entityCollection._renderNodeIndex}_removeRecursively(e){e._entityCollection=null,e._entityCollectionIndex=-1,e.billboard&&this.billboardHandler.remove(e.billboard),e.label&&this.labelHandler.remove(e.label),e.shape&&this.shapeHandler.remove(e.shape),e.polyline&&this.polylineHandler.remove(e.polyline),e.pointCloud&&this.pointCloudHandler.remove(e.pointCloud);for(var t=0;t<e.childrenNodes.length;t++)this._removeRecursively(e.childrenNodes[t])}removeEntity(e){this._entities.splice(e._entityCollectionIndex,1),this.reindexEntitiesArray(e._entityCollectionIndex),this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(e),e._pickingColor.clear()),this.belongs(e)&&this._removeRecursively(e),this.events.dispatch(this.events.entityremove,e)}_removeEntitySilent(e){this._entities.splice(e._entityCollectionIndex,1),this.reindexEntitiesArray(e._entityCollectionIndex),this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(e),e._pickingColor.clear()),this.belongs(e)&&this._removeRecursively(e)}createPickingColors(){for(var e=this._entities,t=0;t<e.length;t++)e[t].parent||(this.renderNode.renderer.assignPickingColor(e[t]),e[t].setPickingColor())}reindexEntitiesArray(e){for(var t=this._entities,i=e;i<t.length;i++)t[i]._entityCollectionIndex=i}addTo(e,t){return this.renderNode||(this.renderNode=e,t||(this._renderNodeIndex=e.entityCollections.length,e.entityCollections.push(this)),e.ellipsoid&&this._updateGeodeticCoordinates(e.ellipsoid),this.setRenderer(e.renderer),this.shapeHandler.setRenderNode(e),this.polylineHandler.setRenderNode(e),this.pointCloudHandler.setRenderNode(e),this.events.dispatch(this.events.add,this)),this}_updateGeodeticCoordinates(e){for(var t=this._entities,i=t.length;i--;){var r=t[i];r._lonlat&&r.setCartesian3v(e.lonLatToCartesian(r._lonlat))}}setRenderer(e){e&&(this.billboardHandler.setRenderer(e),this.labelHandler.setRenderer(e),this.updateBillboardsTextureAtlas(),this.updateLabelsFontAtlas(),this.createPickingColors())}updateBillboardsTextureAtlas(){for(var e=this.billboardHandler._billboards,t=0;t<e.length;t++)e[t].setSrc(e[t]._src)}updateLabelsFontAtlas(){if(this.renderNode)for(var e=this.labelHandler._billboards,t=0;t<e.length;t++)e[t].assignFontAtlas(this.renderNode.fontAtlas)}remove(){if(this.renderNode){if(-1!=this._renderNodeIndex){this.renderNode.entityCollections.splice(this._renderNodeIndex,1);for(var e=this._renderNodeIndex;e<this.renderNode.entityCollections.length;e++)this.renderNode.entityCollections._renderNodeIndex=e}this.renderNode=null,this._renderNodeIndex=-1,this.events.dispatch(this.events.remove,this)}}getEntities(){return[].concat(this._entities)}each(e){for(var t=this._entities.length;t--;){var i=this._entities[t];i&&e(i)}}clear(){this.billboardHandler.clear(),this.labelHandler.clear(),this.shapeHandler.clear(),this.polylineHandler.clear(),this.pointCloudHandler.clear();for(var e=this._entities.length;e--;){var t=this._entities[e];this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(t),t._pickingColor.clear()),this._clearEntity(t)}this._entities.length=0,this._entities=[]}_clearEntity(e){e._entityCollection=null,e._entityCollectionIndex=-1;for(var t=0;t<e.childrenNodes.length;t++)this._clearEntity(e.childrenNodes[t])}}const zr=["entitymove","draw","drawend","add","remove","entityadd","entityremove","visibilitychange","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];function kr(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e}class Dr{constructor(e,t){this.radius=e||0,this.center=t?t.clone():new Ge}setFromBounds(e){this.center.set(e[0]+(e[1]-e[0])/2,e[2]+(e[3]-e[2])/2,e[4]+(e[5]-e[4])/2),this.radius=this.center.distance(new Ge(e[0],e[2],e[4]))}setFromExtent(e,t){this.setFromBounds(t.getCartesianBounds(e))}}const Or=function(e,t,i,r,s,n,a){this.layer=e,this.parentNode=i,this.childrenNodes=[],this.partId=t,this.nodeId=t+r,this.state=null,this.extent=s,this.count=0,this.deferredEntities=[],this.entityCollection=null,this.zoom=a,this._inTheQueue=!1,this.bsphere=new Dr,n&&this._setExtentBounds()};Or.prototype.insertEntity=function(e,t,i){var r=this._setLonLat(e);if(t||r&&this.extent.isInside(r))if(this.count++,this.count>this.layer._nodeCapacity){var s=this.childrenNodes;if(s.length)s[gi].extent.isInside(r)?s[gi].insertEntity(e,!0,i):s[1].extent.isInside(r)?s[1].insertEntity(e,!0,i):s[2].extent.isInside(r)?s[2].insertEntity(e,!0,i):s[3].extent.isInside(r)&&s[3].insertEntity(e,!0,i);else{var n=this.entityCollection.getEntities();n.push(e),this.entityCollection.events.clear(),this.entityCollection.clear(),this.entityCollection=null,this.buildTree(n,i)}}else this._addEntitiesToCollection([e],i)},Or.prototype._addEntitiesToCollection=function(e,t){if(e.length){var i=this.layer,r=i._planet,s=(r.ellipsoid,this.extent,this.entityCollection);s||((s=new Fr({pickingEnabled:i._pickingEnabled}))._layer=this.layer,s.addTo(r,!0),s._quadNode=this,i._bindEventsDefault(s),this.entityCollection=s),t?this.entityCollection.addEntities(e):this.deferredEntities.push.apply(this.deferredEntities,e)}},Or.prototype._setExtentBounds=function(){this.nodeId?this.bsphere.setFromExtent(this.layer._planet.ellipsoid,this.extent.inverseMercator()):(this.bsphere.radius=this.layer._planet.ellipsoid._a,this.bsphere.center=new Ge)},Or.prototype._setLonLat=function(e){return e._lonlat||(e._lonlat=this.layer._planet.ellipsoid.cartesianToLonLat(e._cartesian)),this.layer._fitExtent(e),Math.abs(e._lonlat.lat)<ze?e._lonlatMerc=e._lonlat.forwardMercator():e._lonlatMerc=null,e._lonlatMerc},Or.prototype.buildTree=function(e,t){if(this.count=e.length,e.length>this.layer._nodeCapacity||this.zoom<this.layer.minZoom||this.zoom<this.layer._minDepth){var i=this.childrenNodes;i.length||this.createChildrenNodes();for(var r=[],s=[],n=[],a=[],o=e.length;o--;){var h=e[o],l=this._setLonLat(h);l&&(i[gi].extent.isInside(l)?(h._nodePtr=i[gi],r.push(h)):i[1].extent.isInside(l)?(h._nodePtr=i[1],s.push(h)):i[2].extent.isInside(l)?(h._nodePtr=i[2],n.push(h)):i[3].extent.isInside(l)&&(h._nodePtr=i[3],a.push(h)))}r.length&&i[gi].buildTree(r,t),s.length&&i[1].buildTree(s,t),n.length&&i[2].buildTree(n,t),a.length&&i[3].buildTree(a,t)}else this._addEntitiesToCollection(e,t)},Or.prototype.createChildrenNodes=function(){var e=this.layer,t=this.extent,i=.5*t.getWidth(),r=.5*t.getHeight(),s=t.northEast,n=t.southWest,a=4*this.nodeId+1,o=new De(n.lon+i,n.lat+r),h=this.childrenNodes,l=this.layer._planet,u=this.zoom+1;h[gi]=new Or(e,gi,this,a,new Oe(new De(n.lon,n.lat+r),new De(n.lon+i,s.lat)),l,u),h[1]=new Or(e,1,this,a,new Oe(o,new De(s.lon,s.lat)),l,u),h[2]=new Or(e,2,this,a,new Oe(new De(n.lon,n.lat),o),l,u),h[3]=new Or(e,3,this,a,new Oe(new De(n.lon+i,n.lat),new De(s.lon,n.lat+r)),l,u)},Or.prototype.collectRenderCollectionsPASS1=function(e,t){this.layer._planet.renderer.activeCamera;var i=e[this.nodeId];if(i){var r=this.childrenNodes;this.entityCollection?this.renderCollection(t,e):r.length&&(i.state===Ti?this.layer._secondPASS.push(this):(r[gi].collectRenderCollectionsPASS1(e,t),r[1].collectRenderCollectionsPASS1(e,t),r[2].collectRenderCollectionsPASS1(e,t),r[3].collectRenderCollectionsPASS1(e,t)))}},Or.prototype.collectRenderCollectionsPASS2=function(e,t,i){var r=this.layer._planet,s=r.renderer.activeCamera,n=s.eye.distance(this.bsphere.center)-this.bsphere.radius<3570*Math.sqrt(s._lonLat.height)||s._lonLat.height>1e4;if(this.count>0&&n&&r.renderer.activeCamera.frustum.containsSphere(this.bsphere)>0){var a=this.childrenNodes;this.entityCollection?this.renderCollection(t,e,i):a.length&&(a[gi].collectRenderCollectionsPASS2(e,t,i),a[1].collectRenderCollectionsPASS2(e,t,i),a[2].collectRenderCollectionsPASS2(e,t,i),a[3].collectRenderCollectionsPASS2(e,t,i))}},Or.prototype.applyCollection=function(){this.entityCollection.addEntities(this.deferredEntities),this.deferredEntities.length=0,this.deferredEntities=[],this._inTheQueue=!1},Or.prototype.traverseTree=function(e){var t=this.childrenNodes;this.entityCollection?e(this):t.length&&(t[gi].traverseTree(e),t[1].traverseTree(e),t[2].traverseTree(e),t[3].traverseTree(e))},Or.prototype.renderCollection=function(e,t,i){var r=this.layer;r._renderingNodes[this.nodeId]=!0,this.deferredEntities.length&&!this._inTheQueue&&(r.async?r._queueDeferredNode(this):this.applyCollection());var s=this.entityCollection;if(s._animatedOpacity=r.opacity,s.scaleByDistance=r.scaleByDistance,e.push(this.entityCollection),r.clampToGround||r.relativeToGround){var n=s._entities,a=n.length;if(t[this.nodeId]&&t[this.nodeId].state===Ti)for(;a--;){var o=n[a];this.alignEntityToTheGround(o,t[this.nodeId].segment)}else if(i)for(;a--;){o=n[a];this.alignEntityToTheGround(o,t[i].segment)}else for(var h=r._planet._renderedNodes;a--;){o=n[a];for(var l=h.length;l--;)if(h[l].segment.isEntityInside(o)){this.alignEntityToTheGround(o,h[l].segment);break}}}},Or.prototype.alignEntityToTheGround=function(e,t){t.getEntityTerrainPoint(e,e._cartesian),e._setCartesian3vSilent(e._cartesian.addA(e._cartesian.normal().scale(this.layer.relativeToGround&&e._altitude||.1)))},Or.prototype.isVisible=function(){return!!this.layer._renderingNodes[this.nodeId]};const Vr=function(e,t,i,r,s,n,a){Or.call(this,e,t,i,r,s,n,a),this.isNorth=!1};function Ur(e,t,i){i=i||2;var r,s,n,a,o,h,l,u=t&&t.length,d=u?t[0]*i:e.length,c=Hr(e,0,d,i,!0),_=[];if(!c)return _;if(u&&(c=function(e,t,i,r){var s,n,a,o,h,l=[];for(s=0,n=t.length;s<n;s++)a=t[s]*r,o=s<n-1?t[s+1]*r:e.length,(h=Hr(e,a,o,r,!1))===h.next&&(h.steiner=!0),l.push(Jr(h));for(l.sort(Zr),s=0;s<l.length;s++)Qr(l[s],i),i=Wr(i,i.next);return i}(e,t,c,i)),e.length>80*i){r=n=e[0],s=a=e[1];for(var f=i;f<d;f+=i)o=e[f],h=e[f+1],o<r&&(r=o),h<s&&(s=h),o>n&&(n=o),h>a&&(a=h);l=Math.max(n-r,a-s)}return Gr(c,_,i,r,s,l),_}function Hr(e,t,i,r,s){var n,a;if(s===ls(e,t,i,r)>0)for(n=t;n<i;n+=r)a=as(n,e[n],e[n+1],a);else for(n=i-r;n>=t;n-=r)a=as(n,e[n],e[n+1],a);return a&&is(a,a.next)&&(os(a),a=a.next),a}function Wr(e,t){if(!e)return e;t||(t=e);var i,r=e;do{if(i=!1,r.steiner||!is(r,r.next)&&0!==ts(r.prev,r,r.next))r=r.next;else{if(os(r),(r=t=r.prev)===r.next)return null;i=!0}}while(i||r!==t);return t}function Gr(e,t,i,r,s,n,a){if(e){!a&&n&&function(e,t,i,r){var s=e;do{null===s.z&&(s.z=Kr(s.x,s.y,t,i,r)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,function(e){var t,i,r,s,n,a,o,h,l=1;do{for(i=e,e=null,n=null,a=0;i;){for(a++,r=i,o=0,t=0;t<l&&(o++,r=r.nextZ);t++);for(h=l;o>0||h>0&&r;)0!==o&&(0===h||!r||i.z<=r.z)?(s=i,i=i.nextZ,o--):(s=r,r=r.nextZ,h--),n?n.nextZ=s:e=s,s.prevZ=n,n=s;i=r}n.nextZ=null,l*=2}while(a>1)}(s)}(e,r,s,n);for(var o,h,l=e;e.prev!==e.next;)if(o=e.prev,h=e.next,n?Yr(e,r,s,n):Xr(e))t.push(o.i/i),t.push(e.i/i),t.push(h.i/i),os(e),e=h.next,l=h.next;else if((e=h)===l){a?1===a?Gr(e=jr(e,t,i),t,i,r,s,n,2):2===a&&qr(e,t,i,r,s,n):Gr(Wr(e),t,i,r,s,n,1);break}}}function Xr(e){var t=e.prev,i=e,r=e.next;if(ts(t,i,r)>=0)return!1;for(var s=e.next.next;s!==e.prev;){if($r(t.x,t.y,i.x,i.y,r.x,r.y,s.x,s.y)&&ts(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function Yr(e,t,i,r){var s=e.prev,n=e,a=e.next;if(ts(s,n,a)>=0)return!1;for(var o=s.x<n.x?s.x<a.x?s.x:a.x:n.x<a.x?n.x:a.x,h=s.y<n.y?s.y<a.y?s.y:a.y:n.y<a.y?n.y:a.y,l=s.x>n.x?s.x>a.x?s.x:a.x:n.x>a.x?n.x:a.x,u=s.y>n.y?s.y>a.y?s.y:a.y:n.y>a.y?n.y:a.y,d=Kr(o,h,t,i,r),c=Kr(l,u,t,i,r),_=e.nextZ;_&&_.z<=c;){if(_!==e.prev&&_!==e.next&&$r(s.x,s.y,n.x,n.y,a.x,a.y,_.x,_.y)&&ts(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(_=e.prevZ;_&&_.z>=d;){if(_!==e.prev&&_!==e.next&&$r(s.x,s.y,n.x,n.y,a.x,a.y,_.x,_.y)&&ts(_.prev,_,_.next)>=0)return!1;_=_.prevZ}return!0}function jr(e,t,i){var r=e;do{var s=r.prev,n=r.next.next;!is(s,n)&&rs(s,r,r.next,n)&&ss(s,n)&&ss(n,s)&&(t.push(s.i/i),t.push(r.i/i),t.push(n.i/i),os(r),os(r.next),r=e=n),r=r.next}while(r!==e);return r}function qr(e,t,i,r,s,n){var a=e;do{for(var o=a.next.next;o!==a.prev;){if(a.i!==o.i&&es(a,o)){var h=ns(a,o);return a=Wr(a,a.next),h=Wr(h,h.next),Gr(a,t,i,r,s,n),void Gr(h,t,i,r,s,n)}o=o.next}a=a.next}while(a!==e)}function Zr(e,t){return e.x-t.x}function Qr(e,t){if(t=function(e,t){var i,r=t,s=e.x,n=e.y,a=-1/0;do{if(n<=r.y&&n>=r.next.y&&r.next.y!==r.y){var o=r.x+(n-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(o<=s&&o>a){if(a=o,o===s){if(n===r.y)return r;if(n===r.next.y)return r.next}i=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!i)return null;if(s===a)return i.prev;var h,l=i,u=i.x,d=i.y,c=1/0;r=i.next;for(;r!==l;)s>=r.x&&r.x>=u&&s!==r.x&&$r(n<d?s:a,n,u,d,n<d?a:s,n,r.x,r.y)&&((h=Math.abs(n-r.y)/(s-r.x))<c||h===c&&r.x>i.x)&&ss(r,e)&&(i=r,c=h),r=r.next;return i}(e,t)){var i=ns(t,e);Wr(i,i.next)}}function Kr(e,t,i,r,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/s)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)/s)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Jr(e){var t=e,i=e;do{t.x<i.x&&(i=t),t=t.next}while(t!==e);return i}function $r(e,t,i,r,s,n,a,o){return(s-a)*(t-o)-(e-a)*(n-o)>=0&&(e-a)*(r-o)-(i-a)*(t-o)>=0&&(i-a)*(n-o)-(s-a)*(r-o)>=0}function es(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&rs(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&ss(e,t)&&ss(t,e)&&function(e,t){var i=e,r=!1,s=(e.x+t.x)/2,n=(e.y+t.y)/2;do{i.y>n!=i.next.y>n&&i.next.y!==i.y&&s<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==e);return r}(e,t)}function ts(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function is(e,t){return e.x===t.x&&e.y===t.y}function rs(e,t,i,r){return!!(is(e,t)&&is(i,r)||is(e,r)&&is(i,t))||ts(e,t,i)>0!=ts(e,t,r)>0&&ts(i,r,e)>0!=ts(i,r,t)>0}function ss(e,t){return ts(e.prev,e,e.next)<0?ts(e,t,e.next)>=0&&ts(e,e.prev,t)>=0:ts(e,t,e.prev)<0||ts(e,e.next,t)<0}function ns(e,t){var i=new hs(e.i,e.x,e.y),r=new hs(t.i,t.x,t.y),s=e.next,n=t.prev;return e.next=t,t.prev=e,i.next=s,s.prev=i,r.next=i,i.prev=r,n.next=r,r.prev=n,r}function as(e,t,i,r){var s=new hs(e,t,i);return r?(s.next=r.next,s.prev=r,r.next.prev=s,r.next=s):(s.prev=s,s.next=s),s}function os(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function hs(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function ls(e,t,i,r){for(var s=0,n=t,a=i-r;n<i;n+=r)s+=(e[a]-e[n])*(e[n+1]+e[a+1]),a=n;return s}function us(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},r=0,s=0;s<e.length;s++){for(var n=0;n<e[s].length;n++)for(var a=0;a<t;a++)i.vertices.push(e[s][n][a]);s>0&&(r+=e[s-1].length,i.holes.push(r))}return i}kr(Vr,Or),Vr.prototype._setExtentBounds=function(){this.extent.northEast.lat>0&&(this.isNorth=!0),this.bsphere.setFromExtent(this.layer._planet.ellipsoid,this.extent)},Vr.prototype._setLonLat=function(e){return e._lonlat||(e._lonlat=this.layer._planet.ellipsoid.cartesianToLonLat(e._cartesian)),e._lonlat},Vr.prototype.isVisible=function(){return!(!this.isNorth||!this.layer._renderingNodesNorth[this.nodeId])||!!this.layer._renderingNodesSouth[this.nodeId]},Vr.prototype.renderCollection=function(e,t,i){this.isNorth?this.layer._renderingNodesNorth[this.nodeId]=!0:this.layer._renderingNodesSouth[this.nodeId]=!0,this.deferredEntities.length&&!this._inTheQueue&&(this.layer.async?this.layer._queueDeferredNode(this):this.applyCollection()),this.entityCollection._animatedOpacity=this.layer.opacity,this.entityCollection.scaleByDistance=this.layer.scaleByDistance,e.push(this.entityCollection)};const ds=0,cs=1,_s=2,fs=3,ps=4,vs=5,gs=6,ms=7,xs=8,ys=9,Cs=10,bs=11;class Ts{constructor(e){this.__staticId=Ts._staticCounter++,this._layer=e,this._handler=null,this._geometries=[],this._updatedGeometryArr=[],this._updatedGeometry={},this._removeGeometryExtentArr=[],this._removeGeometryExtents={},this._polyVerticesMerc=[],this._polyColors=[],this._polyPickingColors=[],this._polyIndexes=[],this._lineVerticesMerc=[],this._lineOrders=[],this._lineIndexes=[],this._lineColors=[],this._linePickingColors=[],this._lineThickness=[],this._lineStrokes=[],this._lineStrokeColors=[],this._polyVerticesBufferMerc=null,this._polyColorsBuffer=null,this._polyPickingColorsBuffer=null,this._polyIndexesBuffer=null,this._lineVerticesBufferMerc=null,this._lineColorsBuffer=null,this._linePickingColorsBuffer=null,this._lineThicknessBuffer=null,this._lineStrokesBuffer=null,this._lineStrokeColorsBuffer=null,this._lineOrdersBuffer=null,this._lineIndexesBuffer=null,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[ds]=this.createPolyVerticesBuffer,this._buffersUpdateCallbacks[cs]=this.createPolyIndexesBuffer,this._buffersUpdateCallbacks[_s]=this.createPolyColorsBuffer,this._buffersUpdateCallbacks[fs]=this.createLineVerticesBuffer,this._buffersUpdateCallbacks[ps]=this.createLineIndexesBuffer,this._buffersUpdateCallbacks[vs]=this.createLineOrdersBuffer,this._buffersUpdateCallbacks[gs]=this.createLineColorsBuffer,this._buffersUpdateCallbacks[ms]=this.createLineThicknessBuffer,this._buffersUpdateCallbacks[xs]=this.createLineStrokesBuffer,this._buffersUpdateCallbacks[ys]=this.createLineStrokeColorsBuffer,this._buffersUpdateCallbacks[Cs]=this.createPolyPickingColorsBuffer,this._buffersUpdateCallbacks[bs]=this.createLinePickingColorsBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}static appendLineData(e,t,i,r,s,n,a,o,h,l,u,d,c,_,f,p){var v=0;l.length>0?(v=l[l.length-5]+9,l.push(v,v)):l.push(0,0);for(var g=s,m=[i.x,i.y,i.z,i.w],x=a,y=[n.x,n.y,n.z,n.w],C=[r.x,r.y,r.z,1],b=0;b<e.length;b++){var T,A,E=e[b],w=v;if(t)T=E[E.length-1];else{var M=E[0],P=E[1];T=[M[0]+M[0]-P[0],M[1]+M[1]-P[1]]}o.push(T[0],T[1],T[0],T[1],T[0],T[1],T[0],T[1]),p.push(T[0],T[1],T[0],T[1],T[0],T[1],T[0],T[1]),h.push(1,-1,2,-2),c.push(g,g,g,g),f.push(x,x,x,x),u.push(m[0],m[1],m[2],m[3],m[0],m[1],m[2],m[3],m[0],m[1],m[2],m[3],m[0],m[1],m[2],m[3]),_.push(y[0],y[1],y[2],y[3],y[0],y[1],y[2],y[3],y[0],y[1],y[2],y[3],y[0],y[1],y[2],y[3]),d.push(C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3]);for(var B=0;B<E.length;B++){var L=E[B];o.push(L[0],L[1],L[0],L[1],L[0],L[1],L[0],L[1]),p.push(L[0],L[1],L[0],L[1],L[0],L[1],L[0],L[1]),h.push(1,-1,2,-2),c.push(g,g,g,g),f.push(x,x,x,x),u.push(m[0],m[1],m[2],m[3],m[0],m[1],m[2],m[3],m[0],m[1],m[2],m[3],m[0],m[1],m[2],m[3]),_.push(y[0],y[1],y[2],y[3],y[0],y[1],y[2],y[3],y[0],y[1],y[2],y[3],y[0],y[1],y[2],y[3]),d.push(C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3]),l.push(v++,v++,v++,v++)}if(t)A=E[0],l.push(w,w+1,w+1,w+1);else{M=E[E.length-1],P=E[E.length-2];A=[M[0]+M[0]-P[0],M[1]+M[1]-P[1]],l.push(v-1,v-1,v-1,v-1)}o.push(A[0],A[1],A[0],A[1],A[0],A[1],A[0],A[1]),p.push(A[0],A[1],A[0],A[1],A[0],A[1],A[0],A[1]),h.push(1,-1,2,-2),c.push(g,g,g,g),f.push(x,x,x,x),u.push(m[0],m[1],m[2],m[3],m[0],m[1],m[2],m[3],m[0],m[1],m[2],m[3],m[0],m[1],m[2],m[3]),_.push(y[0],y[1],y[2],y[3],y[0],y[1],y[2],y[3],y[0],y[1],y[2],y[3],y[0],y[1],y[2],y[3]),d.push(C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3]),b<e.length-1&&(v+=8,l.push(v,v))}}assignHandler(e){this._handler=e,this.refresh()}add(e){if(-1===e._handlerIndex){e._handler=this,e._handlerIndex=this._geometries.length,this._geometries.push(e);var t=e._entity._pickingColor.scaleTo(1/255);if(e._polyVerticesMerc=[],e._lineVerticesMerc=[],e._type===qi.POLYGON){for(var i=e._coordinates,r=[],s=0;s<i.length;s++){r[s]=[];for(var n=0;n<i[s].length;n++)r[s][n]=[Be(i[s][n][0]),Le(i[s][n][1])]}var a=Ur((d=us(r)).vertices,d.holes,2);e._polyVerticesMerc=d.vertices,e._polyVerticesHandlerIndex=this._polyVerticesMerc.length,e._polyIndexesHandlerIndex=this._polyIndexes.length,this._polyVerticesMerc.push.apply(this._polyVerticesMerc,d.vertices);for(var o=0;o<a.length;o++)this._polyIndexes.push(a[o]+.5*e._polyVerticesHandlerIndex);var h=e._style.fillColor;for(o=0;o<.5*d.vertices.length;o++)this._polyColors.push(h.x,h.y,h.z,h.w),this._polyPickingColors.push(t.x,t.y,t.z,1);e._polyVerticesLength=d.vertices.length,e._polyIndexesLength=a.length,e._lineVerticesHandlerIndex=this._lineVerticesMerc.length,e._lineOrdersHandlerIndex=this._lineOrders.length,e._lineIndexesHandlerIndex=this._lineIndexes.length,e._lineColorsHandlerIndex=this._lineColors.length,e._lineThicknessHandlerIndex=this._lineThickness.length,Ts.appendLineData(r,!0,e._style.lineColor,t,e._style.lineWidth,e._style.strokeColor,e._style.strokeWidth,this._lineVerticesMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,e._lineVerticesMerc),e._lineVerticesLength=this._lineVerticesMerc.length-e._lineVerticesHandlerIndex,e._lineOrdersLength=this._lineOrders.length-e._lineOrdersHandlerIndex,e._lineIndexesLength=this._lineIndexes.length-e._lineIndexesHandlerIndex,e._lineColorsLength=this._lineColors.length-e._lineColorsHandlerIndex,e._lineThicknessLength=this._lineThickness.length-e._lineThicknessHandlerIndex}else if(e._type===qi.MULTIPOLYGON){i=e._coordinates;var l=[];a=[];e._lineVerticesHandlerIndex=this._lineVerticesMerc.length,e._lineOrdersHandlerIndex=this._lineOrders.length,e._lineIndexesHandlerIndex=this._lineIndexes.length,e._lineColorsHandlerIndex=this._lineColors.length,e._lineThicknessHandlerIndex=this._lineThickness.length;for(o=0;o<i.length;o++){var u=i[o];for(r=[],s=0;s<u.length;s++){r[s]=[];for(n=0;n<i[o][s].length;n++)r[s][n]=[Be(u[s][n][0]),Le(u[s][n][1])]}var d,c=Ur((d=us(r)).vertices,d.holes,2);for(s=0;s<c.length;s++)a.push(c[s]+.5*l.length);l.push.apply(l,d.vertices),Ts.appendLineData(r,!0,e._style.lineColor,t,e._style.lineWidth,e._style.strokeColor,e._style.strokeWidth,this._lineVerticesMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,e._lineVerticesMerc)}e._polyVerticesMerc=l,e._polyVerticesHandlerIndex=this._polyVerticesMerc.length,e._polyIndexesHandlerIndex=this._polyIndexes.length,this._polyVerticesMerc.push.apply(this._polyVerticesMerc,l);for(o=0;o<a.length;o++)this._polyIndexes.push(a[o]+.5*e._polyVerticesHandlerIndex);for(h=e._style.fillColor,o=0;o<.5*l.length;o++)this._polyColors.push(h.x,h.y,h.z,h.w),this._polyPickingColors.push(t.x,t.y,t.z,1);e._polyVerticesLength=l.length,e._polyIndexesLength=a.length,e._lineVerticesLength=this._lineVerticesMerc.length-e._lineVerticesHandlerIndex,e._lineOrdersLength=this._lineOrders.length-e._lineOrdersHandlerIndex,e._lineIndexesLength=this._lineIndexes.length-e._lineIndexesHandlerIndex,e._lineColorsLength=this._lineColors.length-e._lineColorsHandlerIndex,e._lineThicknessLength=this._lineThickness.length-e._lineThicknessHandlerIndex}else if(e._type===qi.LINESTRING){for(i=e._coordinates,r=new Array(i.length),s=0;s<i.length;s++)r[s]=[Be(i[s][0]),Le(i[s][1])];e._lineVerticesHandlerIndex=this._lineVerticesMerc.length,e._lineOrdersHandlerIndex=this._lineOrders.length,e._lineIndexesHandlerIndex=this._lineIndexes.length,e._lineColorsHandlerIndex=this._lineColors.length,e._lineThicknessHandlerIndex=this._lineThickness.length,Ts.appendLineData([r],!1,e._style.lineColor,t,e._style.lineWidth,e._style.strokeColor,e._style.strokeWidth,this._lineVerticesMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,e._lineVerticesMerc),e._lineVerticesLength=this._lineVerticesMerc.length-e._lineVerticesHandlerIndex,e._lineOrdersLength=this._lineOrders.length-e._lineOrdersHandlerIndex,e._lineIndexesLength=this._lineIndexes.length-e._lineIndexesHandlerIndex,e._lineColorsLength=this._lineColors.length-e._lineColorsHandlerIndex,e._lineThicknessLength=this._lineThickness.length-e._lineThicknessHandlerIndex}else if(e._type===qi.MULTILINESTRING){for(i=e._coordinates,r=[],s=0;s<i.length;s++){r[s]=[];for(n=0;n<i[s].length;n++)r[s][n]=[Be(i[s][n][0]),Le(i[s][n][1])]}e._lineVerticesHandlerIndex=this._lineVerticesMerc.length,e._lineOrdersHandlerIndex=this._lineOrders.length,e._lineIndexesHandlerIndex=this._lineIndexes.length,e._lineColorsHandlerIndex=this._lineColors.length,e._lineThicknessHandlerIndex=this._lineThickness.length,Ts.appendLineData(r,!1,e._style.lineColor,t,e._style.lineWidth,e._style.strokeColor,e._style.strokeWidth,this._lineVerticesMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,e._lineVerticesMerc),e._lineVerticesLength=this._lineVerticesMerc.length-e._lineVerticesHandlerIndex,e._lineOrdersLength=this._lineOrders.length-e._lineOrdersHandlerIndex,e._lineIndexesLength=this._lineIndexes.length-e._lineIndexesHandlerIndex,e._lineColorsLength=this._lineColors.length-e._lineColorsHandlerIndex,e._lineThicknessLength=this._lineThickness.length-e._lineThicknessHandlerIndex}this.setGeometryVisibility(e),!this._updatedGeometry[e._id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e._id]=!0,this.refresh()}}remove(e){var t=e._handlerIndex;if(-1!==t){this._geometries.splice(t,1),this._polyVerticesMerc.splice(e._polyVerticesHandlerIndex,e._polyVerticesLength),this._polyColors.splice(2*e._polyVerticesHandlerIndex,2*e._polyVerticesLength),this._polyPickingColors.splice(2*e._polyVerticesHandlerIndex,2*e._polyVerticesLength),this._polyIndexes.splice(e._polyIndexesHandlerIndex,e._polyIndexesLength);for(var i=.5*e._polyVerticesLength,r=e._polyIndexesHandlerIndex;r<this._polyIndexes.length;r++)this._polyIndexes[r]-=i;this._lineVerticesMerc.splice(e._lineVerticesHandlerIndex,e._lineVerticesLength),this._lineOrders.splice(e._lineOrdersHandlerIndex,e._lineOrdersLength),this._lineColors.splice(e._lineColorsHandlerIndex,e._lineColorsLength),this._linePickingColors.splice(e._lineColorsHandlerIndex,e._lineColorsLength),this._lineStrokeColors.splice(e._lineColorsHandlerIndex,e._lineColorsLength),this._lineThickness.splice(e._lineThicknessHandlerIndex,e._lineThicknessLength),this._lineStrokes.splice(e._lineThicknessHandlerIndex,e._lineThicknessLength),this._lineIndexes.splice(e._lineIndexesHandlerIndex,e._lineIndexesLength),i=.5*e._lineVerticesLength;for(r=e._lineIndexesHandlerIndex;r<this._lineIndexes.length;r++)this._lineIndexes[r]-=i;var s=this._geometries;for(r=t;r<s.length;r++){var n=s[r];n._handlerIndex=r,n._polyVerticesHandlerIndex-=e._polyVerticesLength,n._polyIndexesHandlerIndex-=e._polyIndexesLength,n._lineVerticesHandlerIndex-=e._lineVerticesLength,n._lineOrdersHandlerIndex-=e._lineOrdersLength,n._lineColorsHandlerIndex-=e._lineColorsLength,n._lineThicknessHandlerIndex-=e._lineThicknessLength,n._lineIndexesHandlerIndex-=e._lineIndexesLength}e._pickingReady=!1,e._handler=null,e._handlerIndex=-1,e._polyVerticesMerc=[],e._polyVerticesLength=-1,e._polyIndexesLength=-1,e._polyVerticesHandlerIndex=-1,e._polyIndexesHandlerIndex=-1,e._lineVerticesMerc=[],e._lineVerticesLength=-1,e._lineOrdersLength=-1,e._lineIndexesLength=-1,e._lineColorsLength=-1,e._lineThicknessLength=-1,e._lineVerticesHandlerIndex=-1,e._lineOrdersHandlerIndex=-1,e._lineIndexesHandlerIndex=-1,e._lineThicknessHandlerIndex=-1,e._lineColorsHandlerIndex=-1,!this._removeGeometryExtents[e._id]&&this._removeGeometryExtentArr.push(e.getExtent()),this._removeGeometryExtents[e._id]=!0,this.refresh()}}_refreshRecursevely(e,t){for(var i=this._layer._id,r=0;r<t.nodes.length;r++){var s=t.nodes[r];if(e._extent.overlaps(s.segment.getExtentLonLat())){this._refreshRecursevely(e,s);var n=s.segment.materials[i];n&&n.isReady&&(n.segment.node.getState()!==Ti?n.layer.clearMaterial(n):(n.pickingReady=n.pickingReady&&e._pickingReady,n.isReady=!1,n._updateTexture=n.texture,n._updatePickingMask=n.pickingMask),e._pickingReady=!0)}}}_refreshRecursevelyExt(e,t){for(var i=this._layer._id,r=0;r<t.nodes.length;r++){var s=t.nodes[r];if(e.overlaps(s.segment.getExtentLonLat())){this._refreshRecursevelyExt(e,s);var n=s.segment.materials[i];n&&n.isReady&&n.layer.clearMaterial(n)}}}_refreshPlanetNode(e){var t=0,i=this._removeGeometryExtentArr;for(t=0;t<i.length;t++)this._refreshRecursevelyExt(i[t],e);var r=this._updatedGeometryArr;for(t=0;t<r.length;t++)this._refreshRecursevely(r[t],e)}_updatePlanet(){var e=this._layer._planet;e&&(this._refreshPlanetNode(e._quadTree),this._refreshPlanetNode(e._quadTreeNorth),this._refreshPlanetNode(e._quadTreeSouth)),this._updatedGeometryArr.length=0,this._updatedGeometryArr=[],this._updatedGeometry={},this._removeGeometryExtentArr.length=0,this._removeGeometryExtentArr=[],this._removeGeometryExtents={}}refresh(){for(var e=this._changedBuffers.length;e--;)this._changedBuffers[e]=!0}update(){if(this._handler){for(var e=!1,t=this._changedBuffers.length;t--;)this._changedBuffers[t]&&(e=!0,this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1);e&&this._updatePlanet()}}setGeometryVisibility(e){for(var t=e._visibility?1:0,i=this._polyVerticesMerc,r=e._polyVerticesLength,s=e._polyVerticesHandlerIndex,n=0;n<r;n++)i[s+n]=e._polyVerticesMerc[n]*t;for(i=this._lineVerticesMerc,r=e._lineVerticesLength,s=e._lineVerticesHandlerIndex,n=0;n<r;n++)i[s+n]=e._lineVerticesMerc[n]*t;this._changedBuffers[ds]=!0,this._changedBuffers[fs]=!0,!this._updatedGeometry[e._id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e._id]=!0}setPolyColorArr(e,t){for(var i=2*e._polyVerticesHandlerIndex,r=i+2*e._polyVerticesLength,s=this._polyColors,n=i;n<r;n+=4)s[n]=t.x,s[n+1]=t.y,s[n+2]=t.z,s[n+3]=t.w;this._changedBuffers[_s]=!0,!this._updatedGeometry[e._id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e._id]=!0}setLineStrokeColorArr(e,t){for(var i=e._lineColorsHandlerIndex,r=i+e._lineColorsLength,s=this._lineStrokeColors,n=i;n<r;n+=4)s[n]=t.x,s[n+1]=t.y,s[n+2]=t.z,s[n+3]=t.w;this._changedBuffers[ys]=!0,!this._updatedGeometry[e._id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e._id]=!0}setLineColorArr(e,t){for(var i=e._lineColorsHandlerIndex,r=i+e._lineColorsLength,s=this._lineColors,n=i;n<r;n+=4)s[n]=t.x,s[n+1]=t.y,s[n+2]=t.z,s[n+3]=t.w;this._changedBuffers[gs]=!0,!this._updatedGeometry[e._id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e._id]=!0}setLineStrokeArr(e,t){for(var i=e._lineStrokesHandlerIndex,r=i+e._lineStrokesLength,s=this._lineStrokes,n=i;n<r;n++)s[n]=t;this._changedBuffers[xs]=!0,!this._updatedGeometry[e._id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e._id]=!0}setLineThicknessArr(e,t){for(var i=e._lineThicknessHandlerIndex,r=i+e._lineThicknessLength,s=this._lineThickness,n=i;n<r;n++)s[n]=t;this._changedBuffers[ms]=!0,!this._updatedGeometry[e._id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e._id]=!0}bringToFront(e){var t=this._polyIndexes.splice(e._polyIndexesHandlerIndex,e._polyIndexesLength),i=this._lineIndexes.splice(e._lineIndexesHandlerIndex,e._lineIndexesLength);this._geometries.splice(e._handlerIndex,1);for(var r=this._geometries,s=e._handlerIndex;s<r.length;s++){var n=r[s];n._handlerIndex=s,n._polyIndexesHandlerIndex-=e._polyIndexesLength,n._lineIndexesHandlerIndex-=e._lineIndexesLength}e._polyIndexesHandlerIndex=this._polyIndexes.length,e._lineIndexesHandlerIndex=this._lineIndexes.length,e._handlerIndex=this._geometries.length,this._geometries.push(e),this._polyIndexes.push.apply(this._polyIndexes,t),this._lineIndexes.push.apply(this._lineIndexes,i),this._changedBuffers[cs]=!0,this._changedBuffers[ps]=!0,!this._updatedGeometry[e._id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e._id]=!0}createPolyVerticesBuffer(){var e=this._handler;e.gl.deleteBuffer(this._polyVerticesBufferMerc),this._polyVerticesBufferMerc=e.createArrayBuffer(new Float32Array(this._polyVerticesMerc),2,this._polyVerticesMerc.length/2)}createPolyIndexesBuffer(){var e=this._handler;e.gl.deleteBuffer(this._polyIndexesBuffer),this._polyIndexesBuffer=e.createElementArrayBuffer(new Uint32Array(this._polyIndexes),1,this._polyIndexes.length)}createPolyColorsBuffer(){var e=this._handler;e.gl.deleteBuffer(this._polyColorsBuffer),this._polyColorsBuffer=e.createArrayBuffer(new Float32Array(this._polyColors),4,this._polyColors.length/4)}createPolyPickingColorsBuffer(){var e=this._handler;e.gl.deleteBuffer(this._polyPickingColorsBuffer),this._polyPickingColorsBuffer=e.createArrayBuffer(new Float32Array(this._polyPickingColors),4,this._polyPickingColors.length/4)}createLineVerticesBuffer(){var e=this._handler;e.gl.deleteBuffer(this._lineVerticesBufferMerc),this._lineVerticesBufferMerc=e.createArrayBuffer(new Float32Array(this._lineVerticesMerc),2,this._lineVerticesMerc.length/2)}createLineIndexesBuffer(){var e=this._handler;e.gl.deleteBuffer(this._lineIndexesBuffer),this._lineIndexesBuffer=e.createElementArrayBuffer(new Uint32Array(this._lineIndexes),1,this._lineIndexes.length)}createLineOrdersBuffer(){var e=this._handler;e.gl.deleteBuffer(this._lineOrdersBuffer),this._lineOrdersBuffer=e.createArrayBuffer(new Float32Array(this._lineOrders),1,this._lineOrders.length/2)}createLineColorsBuffer(){var e=this._handler;e.gl.deleteBuffer(this._lineColorsBuffer),this._lineColorsBuffer=e.createArrayBuffer(new Float32Array(this._lineColors),4,this._lineColors.length/4)}createLinePickingColorsBuffer(){var e=this._handler;e.gl.deleteBuffer(this._linePickingColorsBuffer),this._linePickingColorsBuffer=e.createArrayBuffer(new Float32Array(this._linePickingColors),4,this._linePickingColors.length/4)}createLineThicknessBuffer(){var e=this._handler;e.gl.deleteBuffer(this._lineThicknessBuffer),this._lineThicknessBuffer=e.createArrayBuffer(new Float32Array(this._lineThickness),1,this._lineThickness.length)}createLineStrokesBuffer(){var e=this._handler;e.gl.deleteBuffer(this._lineStrokesBuffer),this._lineStrokesBuffer=e.createArrayBuffer(new Float32Array(this._lineStrokes),1,this._lineStrokes.length)}createLineStrokeColorsBuffer(){var e=this._handler;e.gl.deleteBuffer(this._lineStrokeColorsBuffer),this._lineStrokeColorsBuffer=e.createArrayBuffer(new Float32Array(this._lineStrokeColors),4,this._lineStrokeColors.length/4)}}const As=function(e,t){this.segment=e,this.layer=t,this.isReady=!1,this.isLoading=!1,this.texture=null,this.pickingMask=null,this.image=null,this.textureExists=!1,this.appliedNodeId=0,this._updateTexture=null,this._updatePickingMask=null,this.pickingReady=!1};As.prototype.assignLayer=function(e){this.layer=e},As.prototype.abortLoading=function(){this.layer.abortMaterialLoading(this)},As.prototype.applyImage=function(e){this.segment.ready&&(this._updateTexture=null,this.image=e,this.texture=this.segment.handler.createTexture(e),this.appliedNodeId=this.segment.node.nodeId,this.isReady=!0,this.pickingReady=!0,this.textureExists=!0,this.isLoading=!1)},As.prototype.applyTexture=function(e,t){this.texture=e,this._updateTexture=null,this.pickingMask=t||null,this._updatePickingMask=null,this.isReady=!0,this.pickingReady=!0,this.textureExists=!0,this.isLoading=!1,this.appliedNodeId=this.segment.node.nodeId},As.prototype.textureNotExists=function(){this.isLoading=!0,this.textureExists=!1},As.prototype.clear=function(){this.layer.clearMaterial(this)};class Es{constructor(e,t){t=t||{},this.name=e||"noname",this.displayInLayerSwitcher=void 0===t.displayInLayerSwitcher||t.displayInLayerSwitcher,this.opacity=t.opacity||1,this.transparentColor=t.transparentColor||[-1,-1,-1],this.minZoom=t.minZoom||0,this.maxZoom=t.maxZoom||50,this.ambient=st(t.ambient,new Ge(.1,.1,.21)),this.diffuse=st(t.diffuse,new Ge(1,1,1)),this.specular=st(t.specular,new Ge(25e-5,15e-5,1e-4)),this.shininess=t.shininess||100,this._planet=null,this._id=Es.__layersCounter++,this._attribution=t.attribution||"",this._zIndex=t.zIndex||0,this._isBaseLayer=t.isBaseLayer||!1,this._visibility=void 0===t.visibility||t.visibility,this._height=t.height||0,this._extent=null,this._extentMerc=null,this.setExtent(nt(t.extent,new Oe(new De(-180,-90),new De(180,90)))),this._pickingColor=new Ge,this.events=new ni,this.events.registerNames(ws)}static getTileIndex(...e){return e.join("_")}static get __layersCounter(){return this.__lcounter||0===this.__lcounter||(this.__lcounter=0),this.__lcounter}static set __layersCounter(e){this.__lcounter=e}hasImageryTiles(){return!0}getID(){return this._id}isEqual(e){return e._id===this._id}_assignPlanet(e){e.layers.push(this),this._planet=e,this.events.on("visibilitychange",e._onLayerVisibilityChanged,e),this._isBaseLayer&&this._visibility&&e.setBaseLayer(this),e.events.dispatch(e.events.layeradd,this),this.events.dispatch(this.events.add,e),e.updateVisibleLayers(),this._bindPicking()}_bindPicking(){this._planet&&this._planet.renderer.assignPickingColor(this)}addTo(e){this._assignPlanet(e)}remove(){var e=this._planet;if(e)for(var t=this._id,i=0;i<e.layers.length;i++)if(e.layers[i]._id===t)return e.renderer.clearPickingColor(this),e.layers.splice(i,1),e.updateVisibleLayers(),this.clear(),e.events.dispatch(e.events.layerremove,this),this.events.dispatch(this.events.remove,e),this._planet=null,this;return this}clear(){this._planet&&this._planet._clearLayerMaterial(this)}get planet(){return this._planet}setAttribution(e){this._attribution=e,this._planet.updateAttributionsList()}setHeight(e){this._height=e,this._planet.updateVisibleLayers()}getHeight(){return this._height}setZIndex(e){this._zIndex=e,this._planet.updateVisibleLayers()}getZIndex(){return this._zIndex}bringToFront(){if(this._planet){var e=this._planet.visibleTileLayers,t=e[e.length-1];t.isEqual(this)||this.setZIndex(t.getZIndex()+1)}}isBaseLayer(){return this._isBaseLayer}setBaseLayer(e){this._isBaseLayer=e,this._planet&&!e&&this.isEqual(this._planet.baseLayer)&&(this._planet.baseLayer=null),this._planet.updateVisibleLayers()}setVisibility(e){e!==this._visibility&&(this._visibility=e,this._isBaseLayer&&e&&this._planet.setBaseLayer(this),this._planet.updateVisibleLayers(),this.events.dispatch(this.events.visibilitychange,this))}getVisibility(){return this._visibility}setExtent(e){var t=e.southWest.clone(),i=e.northEast.clone();t.lat<ke&&(t.lat=ke),i.lat>ze&&(i.lat=ze),this._extent=e.clone(),this._extentMerc=new Oe(t.forwardMercator(),i.forwardMercator()),this._correctFullExtent()}getExtent(){return this._extent}_correctFullExtent(){}createMaterial(e){return new As(e,this)}}const ws=["visibilitychange","add","remove","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];class Ms{constructor(e){this._size=e||2048,this._array=new Array(this._size),this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}clear(){this._array.length=0,this._array=new Array(this._size),this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}push(e){this.length++,this._array[this._popIndex++]=e}pop(){if(this.length){this.length--;var e=this._array[--this._popIndex];return this._array[this._popIndex]=null,this._array[this._popIndex-1]||(this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex),e}}unshift(e){this.length++,this._array[--this._shiftIndex]=e}shift(){if(this.length){this.length--;var e=this._array[this._shiftIndex];return this._array[this._shiftIndex++]=null,this._array[this._shiftIndex]||(this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex),e}}each(e){for(var t=this._shiftIndex;t<this._popIndex;t++)e(this._array[t])}}class Ps extends Es{constructor(e,t){super(e,t=t||{}),this.events.registerNames(Bs),this.isVector=!0,this.scaleByDistance=t.scaleByDistance||[m,m,m],this.async=void 0===t.async||t.async,this.clampToGround=t.clampToGround||!1,this.relativeToGround=t.relativeToGround||!1,this._nodeCapacity=t.nodeCapacity||30,this._pickingEnabled=void 0===t.pickingEnabled||t.pickingEnabled,this._minDepth=t.minDepth||1,this._entities=function(e){for(var t=[],i=0;i<e.length;i++){var r=e[i];r instanceof hr?t.push(r):t.push(new hr(r))}return t}(t.entities||[]),this._polylineEntityCollection=new Fr({pickingEnabled:this._pickingEnabled}),this._bindEventsDefault(this._polylineEntityCollection),this._geometryHandler=new Ts(this),this._entityCollectionsTree=null,this._entityCollectionsTreeNorth=null,this._entityCollectionsTreeSouth=null,this._renderingNodes={},this._renderingNodesNorth={},this._renderingNodesSouth={},this._counter=0,this._deferredEntitiesPendingQueue=new Ms,this._pendingsQueue=[],this.setEntities(this._entities)}_bindPicking(){this._pickingColor.clear()}addTo(e){return this._assignPlanet(e),this._geometryHandler.assignHandler(e.renderer.handler),this._polylineEntityCollection.addTo(e,!0),this.setEntities(this._entities),this}hasImageryTiles(){return!0}getEntities(){return[].concat(this._entities)}_fitExtent(e){var t=e.getExtent(),i=this._extent;t.southWest.lon<i.southWest.lon&&(i.southWest.lon=t.southWest.lon),t.southWest.lat<i.southWest.lat&&(i.southWest.lat=t.southWest.lat),t.northEast.lon>i.northEast.lon&&(i.northEast.lon=t.northEast.lon),t.northEast.lat>i.northEast.lat&&(i.northEast.lat=t.northEast.lat),this.setExtent(this._extent)}add(e,t){return e._layer||e._entityCollection||(e._layer=this,e._layerIndex=this._entities.length,this._entities.push(e),this._fitExtent(e),e.polyline&&this._polylineEntityCollection.add(e),e.geometry&&this._planet&&(this._planet.renderer.assignPickingColor(e),this._geometryHandler.add(e.geometry)),(e.billboard||e.label)&&this._planet&&(e._lonlat||(e._lonlat=this.layer._planet.ellipsoid.cartesianToLonLat(e._cartesian)),e._lonlat.lat>ze?this._entityCollectionsTreeNorth.insertEntity(e,t):e._lonlat.lat<ke?this._entityCollectionsTreeSouth.insertEntity(e,t):this._entityCollectionsTree.insertEntity(e,t)),this.events.dispatch(this.events.entityadd,e)),this}addEntities(e,t){for(var i=e.length;i--;)this.add(e[i],t);return this}removeEntity(e){if(e._layer&&this.isEqual(e._layer)){if(this._entities.splice(e._layerIndex,1),this._reindexEntitiesArray(e._layerIndex),e._layer=null,e._layerIndex=-1,e._entityCollection){e._entityCollection._removeEntitySilent(e);for(var t=e._nodePtr;t;)t.count--,t=t.parentNode;e._nodePtr&&0===e._nodePtr.count&&0===e._nodePtr.deferredEntities.length&&(e._nodePtr.entityCollection=null)}else if(e._nodePtr&&e._nodePtr.deferredEntities.length)for(var i=e._nodePtr.deferredEntities,r=i.length;r--;)if(i[r].id===e.id){i.splice(r,1);for(t=e._nodePtr;t;)t.count--,t=t.parentNode;break}e.geometry&&this._planet&&(this._geometryHandler.remove(e.geometry),this._planet.renderer.clearPickingColor(e)),e._nodePtr&&(e._nodePtr=null),this.events.dispatch(this.events.entityremove,e)}return this}setPickingEnabled(e){this._pickingEnabled=e,this._polylineEntityCollection.setPickingEnabled(e),this._entityCollectionsTree.traverseTree(function(t){t.setPickingEnabled(e)}),this._entityCollectionsTreeNorth.traverseTree(function(t){t.setPickingEnabled(e)}),this._entityCollectionsTreeSouth.traverseTree(function(t){t.setPickingEnabled(e)})}_reindexEntitiesArray(e){for(var t=this._entities,i=e;i<t.length;i++)t[i]._layerIndex=i}removeEntities(e){for(var t=e.length;t--;)this.removeEntity(e[t]);return this}setScaleByDistance(e,t,i){return this.scaleByDistance[0]=e,this.scaleByDistance[1]=t,this.scaleByDistance[2]=i||m,this}clear(){}each(e){for(var t=this._entities,i=t.length;i--;)e(t[i])}setEntities(e){this.clear();var t=this._extent=new Oe(new De(180,90),new De(-180,-90));this._entities=new Array(e.length);for(var i=[],r=0;r<e.length;r++){var s=e[r];s._layer=this,s._layerIndex=r,s.polyline?this._polylineEntityCollection.add(s):(s.billboard||s.label||s.shape)&&i.push(s),s.geometry&&this._planet&&(this._planet.renderer.assignPickingColor(s),this._geometryHandler.add(s.geometry)),this._entities[r]=s;var n=s.getExtent();n.northEast.lon>t.northEast.lon&&(t.northEast.lon=n.northEast.lon),n.northEast.lat>t.northEast.lat&&(t.northEast.lat=n.northEast.lat),n.southWest.lon<t.southWest.lon&&(t.southWest.lon=n.southWest.lon),n.southWest.lat<t.southWest.lat&&(t.southWest.lat=n.southWest.lat)}return this._createEntityCollectionsTree(i),this}_createEntityCollectionsTree(e){this._planet&&(this._entityCollectionsTree=new Or(this,gi,null,0,Oe.createFromArray([-20037508.34,-20037508.34,20037508.34,20037508.34]),this._planet,0),this._entityCollectionsTreeNorth=new Vr(this,gi,null,0,Oe.createFromArray([-180,ze,180,90]),this._planet,0),this._entityCollectionsTreeSouth=new Vr(this,gi,null,0,Oe.createFromArray([-180,-90,180,ke]),this._planet,0),this._entityCollectionsTree.buildTree(e),this._entityCollectionsTreeNorth.buildTree(e),this._entityCollectionsTreeSouth.buildTree(e))}_bindEventsDefault(e){var t=this.events;e.events.on("entitymove",function(e){t.dispatch(t.entitymove,e)}),e.events.on("mousemove",function(e){t.dispatch(t.mousemove,e)}),e.events.on("mouseenter",function(e){t.dispatch(t.mouseenter,e)}),e.events.on("mouseleave",function(e){t.dispatch(t.mouseleave,e)}),e.events.on("lclick",function(e){t.dispatch(t.lclick,e)}),e.events.on("rclick",function(e){t.dispatch(t.rclick,e)}),e.events.on("mclick",function(e){t.dispatch(t.mclick,e)}),e.events.on("ldblclick",function(e){t.dispatch(t.ldblclick,e)}),e.events.on("rdblclick",function(e){t.dispatch(t.rdblclick,e)}),e.events.on("mdblclick",function(e){t.dispatch(t.mdblclick,e)}),e.events.on("lup",function(e){t.dispatch(t.lup,e)}),e.events.on("rup",function(e){t.dispatch(t.rup,e)}),e.events.on("mup",function(e){t.dispatch(t.mup,e)}),e.events.on("ldown",function(e){t.dispatch(t.ldown,e)}),e.events.on("rdown",function(e){t.dispatch(t.rdown,e)}),e.events.on("mdown",function(e){t.dispatch(t.mdown,e)}),e.events.on("lhold",function(e){t.dispatch(t.lhold,e)}),e.events.on("rhold",function(e){t.dispatch(t.rhold,e)}),e.events.on("mhold",function(e){t.dispatch(t.mhold,e)}),e.events.on("mousewheel",function(e){t.dispatch(t.mousewheel,e)}),e.events.on("touchmove",function(e){t.dispatch(t.touchmove,e)}),e.events.on("touchstart",function(e){t.dispatch(t.touchstart,e)}),e.events.on("touchend",function(e){t.dispatch(t.touchend,e)}),e.events.on("doubletouch",function(e){t.dispatch(t.doubletouch,e)}),e.events.on("touchleave",function(e){t.dispatch(t.touchleave,e)}),e.events.on("touchenter",function(e){t.dispatch(t.touchenter,e)})}_collectPolylineCollectionPASS(e){if(e.push(this._polylineEntityCollection),this.clampToGround||this.relativeToGround)for(var t=this.relativeToGround,i=this._planet._renderedNodes,r=this._planet.getViewExtent(),s=this._polylineEntityCollection._entities,n=s.length;n--;){var a=s[n].polyline;if(r.overlaps(a._extent))for(var o=a._pathLonLatMerc,h=o.length;h--;)for(var l=o[h].length;l--;)for(var u=o[h][l],d=i.length;d--;){var c=i[d].segment;if(c._extent.isInside(u)){var _=a._path3v[h][l],f=new Ge;c.getTerrainPoint(f,_,u),a.setPoint3v(f.addA(f.normal().scale(t&&a.altitude+1)),l,h,!0);break}}}}collectVisibleCollections(e){var t=this._planet;if(this.minZoom<=this._planet.maxCurrZoom&&this.maxZoom>=t.maxCurrZoom){this._renderingNodes={},this._renderingNodesNorth={},this._renderingNodesSouth={},this._collectPolylineCollectionPASS(e),this._secondPASS=[],this._entityCollectionsTree.collectRenderCollectionsPASS1(t._visibleNodes,e);for(var i=this._secondPASS.length;i--;)this._secondPASS[i].collectRenderCollectionsPASS2(t._visibleNodes,e,this._secondPASS[i].nodeId);for(this._secondPASS=[],this._entityCollectionsTreeNorth.collectRenderCollectionsPASS1(t._visibleNodesNorth,e),i=this._secondPASS.length;i--;)this._secondPASS[i].collectRenderCollectionsPASS2(t._visibleNodesNorth,e,this._secondPASS[i].nodeId);for(this._secondPASS=[],this._entityCollectionsTreeSouth.collectRenderCollectionsPASS1(t._visibleNodesSouth,e),i=this._secondPASS.length;i--;)this._secondPASS[i].collectRenderCollectionsPASS2(t._visibleNodesSouth,e,this._secondPASS[i].nodeId)}}_queueDeferredNode(e){this._visibility&&(e._inTheQueue=!0,this._counter>=1?this._deferredEntitiesPendingQueue.push(e):this._execDeferredNode(e))}_execDeferredNode(e){this._counter++;var t=this;setTimeout(function(){if(e.applyCollection(),t._counter--,t._deferredEntitiesPendingQueue.length&&t._counter<1)for(;t._deferredEntitiesPendingQueue.length;){var i=t._deferredEntitiesPendingQueue.pop();if(i._inTheQueue=!1,i.isVisible())return void t._execDeferredNode(e)}},0)}loadMaterial(e){var t=e.segment;this._isBaseLayer?e.texture=t._isNorth?t.planet.solidTextureOne:t.planet.solidTextureTwo:e.texture=t.planet.transparentTexture,this._planet.layerLock.isFree()&&(e.isReady=!1,e.isLoading=!0,this._planet._vectorTileCreator.add(e))}abortMaterialLoading(e){e.isLoading=!1,e.isReady=!1}applyMaterial(e){if(e.isReady)return[0,0,1,1];!e.isLoading&&this.loadMaterial(e);for(var t=e.segment,i=t.node,r=!1,s=this._id,n=e;i.parentNode;){if(n&&n.isReady){r=!0;break}n=(i=i.parentNode).segment.materials[s]}if(r){e.appliedNodeId=i.nodeId,e.texture=n.texture,e.pickingMask=n.pickingMask;var a=1/(2<<t.tileZoom-i.segment.tileZoom-1);return[t.tileX*a-i.segment.tileX,t.tileY*a-i.segment.tileY,a,a]}return e.textureExists&&e._updateTexture?(e.texture=e._updateTexture,e.pickingMask=e._updatePickingMask):(e.texture=t.planet.transparentTexture,e.pickingMask=t.planet.transparentTexture),[0,0,1,1]}clearMaterial(e){if(e.isReady){var t=e.segment.handler.gl;e.isReady=!1,e.pickingReady=!1;var i=e.texture;e.texture=null,i&&!i.default&&t.deleteTexture(i),i=e.pickingMask,e.pickingMask=null,i&&!i.default&&t.deleteTexture(i),i=e._updateTexture,e._updateTexture=null,i&&!i.default&&t.deleteTexture(i),i=e._updatePickingMask,e._updatePickingMask=null,i&&!i.default&&t.deleteTexture(i)}this.abortMaterialLoading(e),e.isLoading=!1,e.textureExists=!1}update(){this._geometryHandler.update(),this.collectVisibleCollections(this._planet._frustumEntityCollections),this.events.dispatch(this.events.draw,this)}}const Bs=["entitymove","draw","entityadd","entityremove"],Ls=1,Rs=12;class Ss{constructor(e){e=e||{},this._workers=new Array(e.numWorkers||Ls),this._counter=0;for(var t=new Blob([function(e=12){return`var maxRequests = ${e};\n    var _loading = 0;\n    var _queue = [];\n    \n    var processQueue = function() {\n        if (_queue.length > 0 && _loading < maxRequests) {\n            \n            var q = _queue.shift(),\n                src = q.src,\n                options = q.options || {};\n\n            _loading++;\n            \n            return fetch(src, options).then((response) => {\n                if (!response.ok) {\n                    throw Error("Unable to load '" + src + "'");\n                }\n                return response.blob();\n            })\n            .then(createImageBitmap)\n            .then((imageBitmap) => {\n                _loading--;\n                self.postMessage({ 'ok': true, 'imageBitmap': imageBitmap, 'queue': _queue.length }, [imageBitmap]);\n            })\n            .then(processQueue)\n            .catch((err) => {\n                _loading--;\n                self.postMessage({ 'ok': false, 'error': err.toString(), 'queue': _queue.length });\n                processQueue();\n            });\n        }\n    }\n    self.onmessage = function (e) {\n        var toEnqueue = e.data;\n        if (_queue.indexOf(toEnqueue.src) < 0) {\n            _queue.push(toEnqueue);\n            processQueue();\n        }\n    }`}(e.maxRequests||Rs)],{type:"application/javascript"}),i=0;i<this._workers.length;i++)this._workers[i]=new Worker(URL.createObjectURL(t))}load(e,t,i){var r=this._workers[this._counter++%this._workers.length];r.onmessage=(e=>t&&t(e)),r.postMessage({src:e,options:i})}}class Ns{constructor(){this._lock=0}lock(e){this._lock|=1<<e._id}free(e){this._lock&=~(1<<e._id)}isFree(){return 0===this._lock}isLocked(){return 0!==this._lock}}class Is{static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}constructor(){this._id=Is._staticCounter++}}const Fs=new Hi({code:"epsg:4326",units:Di});function zs(e,t,i,r,s){for(var n=new Float32Array((i+s+1)*(r+s+1)*3),a=0,o=i;o<=i+s;o++)for(var h=r;h<=r+s;h++){var l=3*(o*(t+1)+h);n[a++]=e[l],n[a++]=e[l+1],n[a++]=e[l+2]}return n}const ks=function(e,t,i,r,s,n,a){this.planet=t,this.parentNode=r,this.nodes=[],this.partId=i,this.nodeId=i+s,this.state=null,this.appliedTerrainNodeId=-1,this.sideSize=[1,1,1,1],this.hasNeighbor=[!1,!1,!1,!1],this.neighbors=[null,null,null,null],this.SegmentPrototype=e,this.segment=new e(this,t,n,a),this._cameraInside=!1,this.createBounds(),this.planet._createdNodesCount++},Ds=[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}],Os=Math.sqrt(Ds.length)-1;ks.prototype.createChildrenNodes=function(){var e=this.planet,t=this.segment,i=t._extent,r=.5*i.getWidth(),s=.5*i.getHeight(),n=i.northEast,a=i.southWest,o=t.tileZoom+1,h=4*this.nodeId+1,l=new De(a.lon+r,a.lat+s),u=this.nodes;u[gi]=new ks(this.SegmentPrototype,e,gi,this,h,o,new Oe(new De(a.lon,a.lat+s),new De(a.lon+r,n.lat))),u[1]=new ks(this.SegmentPrototype,e,1,this,h,o,new Oe(l,new De(n.lon,n.lat))),u[2]=new ks(this.SegmentPrototype,e,2,this,h,o,new Oe(new De(a.lon,a.lat),l)),u[3]=new ks(this.SegmentPrototype,e,3,this,h,o,new Oe(new De(a.lon+r,a.lat),new De(n.lon,a.lat+s)))},ks.prototype.createBounds=function(){var e=this.segment;if(e.tileZoom)if(e.tileZoom<e.planet.terrain.minZoom)e.createBoundsByExtent();else{for(var t=this;t.parentNode&&!t.segment.terrainReady;)t=t.parentNode;var i=this.segment.tileZoom-t.segment.tileZoom,r=Math.pow(2,i),s=this.segment.tileX-t.segment.tileX*r,n=this.segment.tileY-t.segment.tileY*r;if(t.segment.terrainReady){var a=t.segment.gridSize/Math.pow(2,i);if(a>=1){var o=t.segment.terrainVertices,h=a*s,l=3*((f=a*n)*(t.segment.gridSize+1)+h),u=3*((f+a)*(t.segment.gridSize+1)+h+a);e.bsphere.setFromBounds([o[l],o[u],o[l+1],o[u+1],o[l+2],o[u+2]])}else{var d,c,_=t.segment,f=Math.floor(a*n),p=(h=Math.floor(a*s),1/a),v=(_.gridSize,n-p*f),g=s-p*h,m=zs(_.terrainVertices,_.gridSize,f,h,1),x=new Ge(m[0],m[1],m[2]),y=new Ge(m[9],m[10],m[11]),C=new Ge(m[3]-m[0],m[4]-m[1],m[5]-m[2]),b=new Ge(m[6]-m[0],m[7]-m[1],m[8]-m[2]),T=new Ge(m[3]-m[9],m[4]-m[10],m[5]-m[11]),A=new Ge(m[6]-m[9],m[7]-m[10],m[8]-m[11]),E=v,w=g;d=E+w<p?Ge.add(C.scaleTo(w/p),b.scaleTo(E/p)).addA(x):Ge.add(A.scaleTo(1-w/p),T.scaleTo(1-E/p)).addA(y),c=(E=v+1)+(w=g+1)<p?Ge.add(C.scaleTo(w/p),b.scaleTo(E/p)).addA(x):Ge.add(A.scaleTo(1-w/p),T.scaleTo(1-E/p)).addA(y),e.bsphere.radius=.5*d.distance(c),e.bsphere.center=d.addA(c.subA(d).scale(.5))}}else e.createBoundsByExtent()}else e.bsphere.radius=e.planet.ellipsoid._a,e.bsphere.center=new Ge},ks.prototype.getState=function(){for(var e=this.parentNode;e;){if(2!==e.state)return bi;e=e.parentNode}return this.state},ks.prototype.getEqualNeighbor=function(e){var t=this,i=Ei[e][t.partId];if(-1!==i)return t.parentNode.nodes[i];for(var r=[];t.parentNode;)if(r.push(t.partId),i=Ei[e][t.partId],t=t.parentNode,-1!==i){var s=r.length;for(e=Ai[e];t&&s--;)i=wi[e][r[s]],t=t.nodes[i];return t}},ks.prototype.prepareForRendering=function(e,t,i){e<3e6?t?this.renderNode(i):this.state=bi:this.renderNode(i)},ks.prototype.traverseNodes=function(e){this.nodes.length||this.createChildrenNodes(),this.nodes[gi].renderTree(e),this.nodes[1].renderTree(e),this.nodes[2].renderTree(e),this.nodes[3].renderTree(e)},ks.prototype.isBrother=function(e){return!(this.parentNode||e.parentNode)||this.parentNode.id===e.parentNode.id},ks.prototype.renderTree=function(e){this.state=2,this.neighbors[0]=null,this.neighbors[1]=null,this.neighbors[2]=null,this.neighbors[3]=null;var t,i=this.planet.renderer.activeCamera,r=this.segment,s=this.planet;this.parentNode?(this._cameraInside=!1,this.parentNode._cameraInside&&(Math.abs(i._lonLat.lat)<=ze&&r._projection.id===Wi.id?(t=r._extent.isInside(i._lonLatMerc),i._insideSegmentPosition=i._lonLatMerc):r._projection.id===Fs.id&&(t=r._extent.isInside(i._lonLat),i._insideSegmentPosition=i._lonLat),t&&(i._insideSegment=r,this._cameraInside=!0))):this._cameraInside=!0;var n=i.frustum.containsSphere(r.bsphere),a=i._lonLat.height,o=!n&&!1,h=i.eye.distance(r.bsphere.center)-r.bsphere.radius<3570*Math.sqrt(a);n||o||this._cameraInside?r.tileZoom<2&&r.normalMapReady?this.traverseNodes(e):r.tileZoom===e||!e&&r.acceptForRendering(i)?this.prepareForRendering(a,h,o):r.tileZoom<s.terrain.gridSizeByZoom.length-1?this.traverseNodes(e):this.prepareForRendering(a,h,o):this.state=bi,n&&(h||a>1e4)&&r._collectRenderNodes()},ks.prototype.renderNode=function(e){this.state=bi;var t=this.segment;t.terrainReady||this.whileTerrainLoading()&&t.loadTerrain(),e||(this.state=Ti,!t.planet.lightEnabled||t.normalMapReady||t.parentNormalMapReady||this.whileNormalMapCreating(),!this._cameraInside&&t.tileZoom>this.planet.maxCurrZoom&&(this.planet.maxCurrZoom=t.tileZoom),t.tileZoom<this.planet.minCurrZoom&&(this.planet.minCurrZoom=t.tileZoom),t._addViewExtent(),this.addToRender())},ks.prototype.addToRender=function(){for(var e=this.planet._renderedNodes,t=0;t<e.length;t++){var i=e[t],r=this.getCommonSide(i);if(-1!==r){var s=Ai[r];if(this.neighbors[r]=i,i.neighbors[s]=this,!this.hasNeighbor[r]||!i.hasNeighbor[s]){var n=this.segment,a=i.segment,o=n.gridSize/(a.gridSize*Math.pow(2,a.tileZoom-n.tileZoom));this.hasNeighbor[r]=!0,i.hasNeighbor[s]=!0,o>1?(this.sideSize[r]=Math.ceil(n.gridSize/o),i.sideSize[s]=a.gridSize):o<1?(this.sideSize[r]=n.gridSize,i.sideSize[s]=Math.ceil(a.gridSize*o)):(this.sideSize[r]=n.gridSize,i.sideSize[s]=a.gridSize)}}}e.push(this)},ks.prototype.getCommonSide=function(e){var t=this.segment._extent,i=e.segment._extent,r=t.northEast,s=t.southWest,n=i.northEast,a=i.southWest,o=r.lon,h=r.lat,l=s.lon,u=s.lat,d=n.lon,c=n.lat,_=a.lon,f=a.lat,p=we,v=ze;if(h<=c&&u>=f||h>=c&&u<=f){if(o===_)return xi;if(l===d)return Ci;if(this.segment.tileZoom>0){if(o===p&&_===-p)return xi;if(l===-p&&d===p)return xi;if(l===-p&&d===p)return Ci}}else if(l>=_&&o<=d||l<=_&&o>=d){if(h===f)return mi;if(u===c)return yi;if(h===p&&f===v)return mi;if(u===-p&&c===-v)return yi}return-1},ks.prototype.whileNormalMapCreating=function(){var e=this.segment,t=this.planet.terrain.maxZoom;e.tileZoom<=t&&!e.terrainIsLoading&&e.terrainReady&&!e._inTheQueue&&e.planet._normalMapCreator.queue(e);for(var i=this;i.parentNode&&!i.segment.normalMapReady;)i=i.parentNode;var r=2<<e.tileZoom-i.segment.tileZoom-1;if(e.normalMapTexture=i.segment.normalMapTexture,e.normalMapTextureBias[0]=e.tileX-i.segment.tileX*r,e.normalMapTextureBias[1]=e.tileY-i.segment.tileY*r,e.normalMapTextureBias[2]=1/r,e.tileZoom>t)if(i.segment.tileZoom===t)e.parentNormalMapReady=!0;else{for(i=this;i.parentNode&&i.segment.tileZoom!==t;)i=i.parentNode;var s=i.segment;s.ready?s._inTheQueue||s.terrainIsLoading||s.planet._normalMapCreator.queue(s):(s.createPlainSegment(),s.loadTerrain())}},ks.prototype.whileTerrainLoading=function(){var e=this.segment,t=this.nodes;if(e.tileZoom>=this.planet.terrain.minZoom&&e.tileZoom<this.planet.terrain.maxZoom&&4===t.length&&t[0].segment.terrainReady&&t[1].segment.terrainReady&&t[2].segment.terrainReady&&t[3].segment.terrainReady){var i=C,r=b,s=C,n=b,a=C,o=b;e.initializePlainSegment();var h=this.planet.terrain.fileGridSize,l=Math.max(h/e.gridSize,1),u=Math.max(h,e.gridSize)+1,d=0,c=0,_=u*u*3,f=(e.gridSize+1)*(e.gridSize+1)*3,p=.5*(u-1)+1;e.terrainVertices&&(e.terrainVertices=null),e.normalMapNormals&&(e.normalMapNormals=null),e.normalMapVertices&&(e.normalMapVertices=null),e.terrainVertices=new Float32Array(f),e.normalMapVertices=new Float32Array(_),e.normalMapNormals=new Float32Array(_);for(var v=e.terrainVertices,g=e.normalMapVertices,m=e.normalMapNormals,x=0;x<u;x++)for(var y=Math.floor(x/p),T=x%p+y,A=0;A<u;A++){var E=Math.floor(A/p),w=3*(2*T*u+2*(A%p+E)),M=(t=this.nodes[2*y+E]).segment.normalMapVertices,P=t.segment.normalMapNormals,B=M[w],L=M[w+1],R=M[w+2];g[c]=B,m[c++]=P[w],g[c]=L,m[c++]=P[w+1],g[c]=R,m[c++]=P[w+2],x%l==0&&A%l==0&&(v[d++]=B,v[d++]=L,v[d++]=R,B<i&&(i=B),B>r&&(r=B),L<s&&(s=L),L>n&&(n=L),R<a&&(a=R),R>o&&(o=R))}e.planet.lightEnabled&&this.planet._normalMapCreator.unshift(e),e.createCoordsBuffers(e.terrainVertices,e.gridSize),e.bsphere.setFromBounds([i,r,s,n,a,o]),this.appliedTerrainNodeId=this.nodeId,e.terrainReady=!0,e.terrainExists=!0,e.terrainIsLoading=!1,e.ready=!0;var S=e._extent;return e._globalTextureCoordinates[0]=(S.southWest.lon+we)*Pe,e._globalTextureCoordinates[1]=(we-S.northEast.lat)*Pe,e._globalTextureCoordinates[2]=(S.northEast.lon+we)*Pe,e._globalTextureCoordinates[3]=(we-S.southWest.lat)*Pe,!1}e.ready||e.createPlainSegment();for(var N=this;N.parentNode&&!N.segment.terrainReady;)N=N.parentNode;if(N.segment.terrainReady){var I=2<<e.tileZoom-N.segment.tileZoom-1,F=e.tileX-N.segment.tileX*I,z=e.tileY-N.segment.tileY*I,k=N.segment;if(N.segment.terrainExists&&this.appliedTerrainNodeId!==N.nodeId){var D,O,V=N.segment.gridSize/I,U=(h=this.planet.terrain.fileGridSize)/I;if(e.deleteBuffers(),e.refreshIndexesBuffer=!0,V>=1)e.gridSize=V,this.sideSize=[V,V,V,V],D=zs(k.terrainVertices,k.gridSize,V*z,V*F,V),O=zs(k.normalMapNormals,h,U*z,U*F,U);else{e.gridSize=Os,this.sideSize=[e.gridSize,e.gridSize,e.gridSize,e.gridSize];var H=Math.floor(V*z),W=Math.floor(V*F),G=zs(k.terrainVertices,k.gridSize,H,W,1),X=1/V,Y=z-X*H,j=F-X*W,q=new Ge(G[0],G[1],G[2]),Z=new Ge(G[9],G[10],G[11]),Q=new Ge(G[3]-G[0],G[4]-G[1],G[5]-G[2]),K=new Ge(G[6]-G[0],G[7]-G[1],G[8]-G[2]),J=new Ge(G[3]-G[9],G[4]-G[10],G[5]-G[11]),$=new Ge(G[6]-G[9],G[7]-G[10],G[8]-G[11]),ee=new Ge,te=Ds;D=new Float32Array(3*te.length);for(x=0;x<te.length;x++){var ie=te[x].y+Y,re=te[x].x+j,se=re*V,ne=ie*V;ee=ie+re<X?Q.scaleTo(se).addA(K.scaleTo(ne)).addA(q):$.scaleTo(1-se).addA(J.scaleTo(1-ne)).addA(Z);var ae=3*x;D[ae]=ee.x,D[ae+1]=ee.y,D[ae+2]=ee.z}}e.createCoordsBuffers(D,e.gridSize),e.tempVertices=D,this.appliedTerrainNodeId=N.nodeId}var oe=this.planet.terrain.maxZoom;if(e.tileZoom>oe)if(N.segment.tileZoom>=oe)e.terrainReady=!0,e.terrainIsLoading=!1,this.appliedTerrainNodeId=this.nodeId,N.segment.terrainExists&&(e.terrainExists=!0,e.terrainVertices=D,e.normalMapNormals=O);else{for(N=this;N.parentNode&&N.segment.tileZoom!==oe;)N=N.parentNode;var he=N.segment;he.ready||he.createPlainSegment(),he.loadTerrain()}}return!0},ks.prototype.clearTree=function(){var e=this.getState();if(e===bi)this.destroyBranches(!0);else if(e===Ti)this.destroyBranches(!1);else for(var t=0;t<this.nodes.length;t++)this.nodes[t].clearTree()},ks.prototype.destroy=function(){this.state=bi,this.segment.destroySegment();var e=this.neighbors;e[mi]&&e[mi].neighbors&&(e[mi].neighbors[yi]=null),e[xi]&&e[xi].neighbors&&(e[xi].neighbors[Ci]=null),e[yi]&&e[yi].neighbors&&(e[yi].neighbors[mi]=null),e[Ci]&&e[Ci].neighbors&&(e[Ci].neighbors[xi]=null),this.neighbors=null,this.hasNeighbors=null,this.parentNode=null,this.sideSize=null,this.segment=null},ks.prototype.destroyBranches=function(e){var t,i=[];for(t=0;t<this.nodes.length;t++)i[t]=this.nodes[t];for(this.nodes.neighbors=[null,null,null,null],this.nodes.length=0,this.nodes=[],t=0;t<i.length;t++)i[t].destroyBranches(!1),i[t].destroy(),i[t]=null;i.length=0,i=null},ks.prototype.traverseTree=function(e){e(this);for(var t=0;t<this.nodes.length;t++)this.nodes[t].traverseTree(e)};const Vs=function(e,t,i,r){this._planet=e,this._handler=e.renderer.handler,this._verticesBufferArray=[],this._indexBufferArray=[],this._positionBuffer=null,this._framebuffer=null,this._normalMapVerticesTexture=null,this._width=t||128,this._height=i||128,this.MAX_FRAMES=r||5,this._currentFrame=0,this._queue=new Ms(1024),this._lock=new Ns,this._init()};Vs.prototype._init=function(){var e=new vi("normalMapBlur",{attributes:{a_position:{type:fi.VEC2,enableArray:!0}},uniforms:{s_texture:{type:fi.SAMPLER2D}},vertexShader:"attribute vec2 a_position; \n                       attribute vec2 a_texCoord; \n                      \n                      varying vec2 blurCoordinates[5]; \n                      \n                      void main() { \n                          vec2 vt = a_position * 0.5 + 0.5; gl_Position = vec4(a_position, 0.0, 1.0); \n                          blurCoordinates[0] = vt; \n                          blurCoordinates[1] = vt + "+1/this._width*1.407333+";blurCoordinates[2] = vt - "+1/this._height*1.407333+";blurCoordinates[3] = vt + "+1/this._width*3.294215+";blurCoordinates[4] = vt - "+1/this._height*3.294215+";}",fragmentShader:"precision highp float;\n                        uniform sampler2D s_texture; \n                        \n                        varying vec2 blurCoordinates[5]; \n                        \n                        void main() { \n                            lowp vec4 sum = vec4(0.0); \n                            if(blurCoordinates[0].x <= 0.01 || blurCoordinates[0].x >= 0.99 ||\n                                blurCoordinates[0].y <= 0.01 || blurCoordinates[0].y >= 0.99){\n                                sum = texture2D(s_texture, blurCoordinates[0]);\n                            } else {\n                                sum += texture2D(s_texture, blurCoordinates[0]) * 0.204164; \n                                sum += texture2D(s_texture, blurCoordinates[1]) * 0.304005; \n                                sum += texture2D(s_texture, blurCoordinates[2]) * 0.304005; \n                                sum += texture2D(s_texture, blurCoordinates[3]) * 0.093913; \n                                sum += texture2D(s_texture, blurCoordinates[4]) * 0.093913; \n                            }\n                            gl_FragColor = sum; \n                        }"}),t=new vi("normalMap",{attributes:{a_position:{type:fi.VEC2,enableArray:!0},a_normal:{type:fi.VEC3,enableArray:!0}},vertexShader:"attribute vec2 a_position;                       attribute vec3 a_normal;                                             varying vec3 v_color;                                             void main() {                           gl_PointSize = 1.0;                           gl_Position = vec4(a_position, 0, 1);                           v_color = normalize(a_normal) * 0.5 + 0.5;                       }",fragmentShader:"precision highp float;\n                                                varying vec3 v_color;                                                 void main () {                             gl_FragColor = vec4(v_color, 1.0);                         }"});this._handler.addShaderProgram(e),this._handler.addShaderProgram(t),this._framebuffer=new Gi(this._handler,{width:this._width,height:this._height,useDepth:!1}),this._framebuffer.init(),this._normalMapVerticesTexture=this._handler.createEmptyTexture_l(this._width,this._height);for(var i=1;i<=6;i++){for(var r=Math.pow(2,i),s=r/2,n=[],a=0;a<=r;a++)for(var o=0;o<=r;o++)n.push(o/s-1,a/s-1);this._verticesBufferArray[r]=this._handler.createArrayBuffer(new Float32Array(n),2,n.length/2),this._indexBufferArray[r]=this._planet._indexesCache[r][r][r][r][r].buffer}var h=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this._positionBuffer=this._handler.createArrayBuffer(h,2,h.length/2)},Vs.prototype._drawNormalMap=function(e){var t=e.normalMapNormals;if(e.node&&e.node.getState()!==bi&&t&&t.length){e._normalMapEdgeEqualize(mi,0),e._normalMapEdgeEqualize(yi,1),e._normalMapEdgeEqualize(Ci,0,!0),e._normalMapEdgeEqualize(xi,1,!0);var i=e.normalMapTexturePtr,r=t.length/3,s=Math.sqrt(r)-1,n=this._handler,a=n.gl,o=n.createArrayBuffer(t,3,r,a.DYNAMIC_DRAW),h=this._framebuffer,l=n.shaderPrograms.normalMap,u=l._program.attributes;return h.bindOutputTexture(this._normalMapVerticesTexture),l.activate(),a.bindBuffer(a.ARRAY_BUFFER,this._verticesBufferArray[s]),a.vertexAttribPointer(u.a_position._pName,this._verticesBufferArray[s].itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,o),a.vertexAttribPointer(u.a_normal._pName,o.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this._indexBufferArray[s]),a.drawElements(a.TRIANGLE_STRIP,this._indexBufferArray[s].numItems,a.UNSIGNED_SHORT,0),a.deleteBuffer(o),h.bindOutputTexture(i),(l=n.shaderPrograms.normalMapBlur).activate(),a.bindBuffer(a.ARRAY_BUFFER,this._positionBuffer),a.vertexAttribPointer(l._program.attributes.a_position._pName,this._positionBuffer.itemSize,a.FLOAT,!1,0,0),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this._normalMapVerticesTexture),a.uniform1i(l._program.uniforms.s_texture._pName,0),a.drawArrays(a.TRIANGLE_STRIP,0,this._positionBuffer.numItems),!0}return!1},Vs.prototype.drawSingle=function(e){var t=this._handler.gl;this._framebuffer.activate(),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),e.terrainReady&&this._drawNormalMap(e)&&(e.normalMapReady=!0,e.normalMapTexture=e.normalMapTexturePtr,e.normalMapTextureBias[0]=0,e.normalMapTextureBias[1]=0,e.normalMapTextureBias[2]=1),e._inTheQueue=!1,t.disable(t.BLEND),t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),this._framebuffer.deactivate()},Vs.prototype.frame=function(){if(this._queue.length){var e=this._handler.gl;this._framebuffer.activate(),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST);var t=0,i=window.performance.now();for(this._width,this._height;this._lock.isFree()&&this._queue.length&&t<.25;){var r=this._queue.shift();r.terrainReady&&this._drawNormalMap(r)&&(r.normalMapReady=!0,r.normalMapTexture=r.normalMapTexturePtr,r.normalMapTextureBias[0]=0,r.normalMapTextureBias[1]=0,r.normalMapTextureBias[2]=1),r._inTheQueue=!1,t=window.performance.now()-i}e.disable(e.BLEND),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),this._framebuffer.deactivate()}},Vs.prototype.queue=function(e){e._inTheQueue=!0,this._queue.push(e)},Vs.prototype.unshift=function(e){e._inTheQueue=!0,this._queue.unshift(e)},Vs.prototype.remove=function(e){},Vs.prototype.clear=function(){for(;this._queue.length;){this._queue.pop()._inTheQueue=!1}},Vs.prototype.lock=function(e){this._lock.lock(e)},Vs.prototype.free=function(e){this._lock.free(e)};class Us{constructor(){this._f=new Array(6);for(var e=0;e<6;e++)this._f[e]=new Array(4)}static planeNormalize(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]/=t,e[1]/=t,e[2]/=t,e[3]/=t}setFrustum(e){this._f[0][0]=e[3]-e[0],this._f[0][1]=e[7]-e[4],this._f[0][2]=e[11]-e[8],this._f[0][3]=e[15]-e[12],Us.planeNormalize(this._f[0]),this._f[1][0]=e[3]+e[0],this._f[1][1]=e[7]+e[4],this._f[1][2]=e[11]+e[8],this._f[1][3]=e[15]+e[12],Us.planeNormalize(this._f[1]),this._f[2][0]=e[3]+e[1],this._f[2][1]=e[7]+e[5],this._f[2][2]=e[11]+e[9],this._f[2][3]=e[15]+e[13],Us.planeNormalize(this._f[2]),this._f[3][0]=e[3]-e[1],this._f[3][1]=e[7]-e[5],this._f[3][2]=e[11]-e[9],this._f[3][3]=e[15]-e[13],Us.planeNormalize(this._f[3]),this._f[4][0]=e[3]-e[2],this._f[4][1]=e[7]-e[6],this._f[4][2]=e[11]-e[10],this._f[4][3]=e[15]-e[14],Us.planeNormalize(this._f[4]),this._f[5][0]=e[3]+e[2],this._f[5][1]=e[7]+e[6],this._f[5][2]=e[11]+e[10],this._f[5][3]=e[15]+e[14],Us.planeNormalize(this._f[5])}containsPoint(e){for(var t=0;t<6;t++)if(e.dotArr(this._f[t])+this._f[t][3]<=0)return!1;return!0}containsSphere(e){var t=-e.radius;return!(e.center.dotArr(this._f[0])+this._f[0][3]<=t)&&(!(e.center.dotArr(this._f[1])+this._f[1][3]<=t)&&(!(e.center.dotArr(this._f[2])+this._f[2][3]<=t)&&(!(e.center.dotArr(this._f[3])+this._f[3][3]<=t)&&(!(e.center.dotArr(this._f[4])+this._f[4][3]<=t)&&!(e.center.dotArr(this._f[5])+this._f[5][3]<=t)))))}containsBox(e){for(var t,i,r=!0,s=0;s<6;s++){t=0,i=0;for(var n=0;n<8&&(0==i||0==t);n++){e.vertices[n].dotArr(this._f[s])+this._f[s][3]<0?t++:i++}if(0==i)return!1;t>0&&(r=!0)}return r}}class Hs{constructor(e,t){this.renderer=null,this.events=new ni(Ws),this.eye=new Ge,this.frustum=new Us,this._aspect=t.aspect||0,this._nearDist=0,this._farDist=0,this._viewAngle=0,this._normalMatrix=new Ue,this._projectionMatrix=new He,this._viewMatrix=new He,this._projectionViewMatrix=new He,this._inverseProjectionViewMatrix=new He,this._projectionMatrixPrecise=new He,this._u=new Ge(0,1,0),this._v=new Ge(1,0,0),this.slope=0,this._n=new Ge(0,0,1),this._pu=this._u,this._pv=this._v,this._pn=this._n,this._peye=this.eye,this._moved=!1,this._tanViewAngle_hrad=0,this._tanViewAngle_hradOneByHeight=0,this.renderer=e,e&&this._initialize(t)}_setViewMatrix(){var e=this._u,t=this._v,i=this._n,r=this.eye;this._viewMatrix.set([e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,-r.dot(e),-r.dot(t),-r.dot(i),1])}checkMoveEnd(){var e=this._u,t=this._v,i=this._n,r=this.eye;this.events.moveend.handlers.length&&(this._peye.equal(r)&&this._pu.equal(e)&&this._pv.equal(t)&&this._pn.equal(i)?(this._moved&&this.events.dispatch(this.events.moveend,this),this._moved=!1):this._moved=!0),this._pu=e,this._pv=t,this._pn=i,this._peye=r}_initialize(e){this.setProjectionMatrix(e.viewAngle||Gs.viewAngle,this._aspect||this.renderer.handler.getClientAspect(),e.near||Gs.near,e.far||Gs.far),this.set(e.eye||Gs.eye.clone(),e.look||Gs.look.clone(),e.up||Gs.up.clone())}getUp(){return this._v}getDown(){return this._v.negateTo()}getRight(){return this._u}getLeft(){return this._u.negateTo()}getForward(){return this._n}getBackward(){return this._n.negateTo()}clone(){var e=new Hs;return e.eye.copy(cam.eye),e._u.copy(cam._u),e._v.copy(cam._v),e._n.copy(cam._n),e.renderer=cam.renderer,e._projectionMatrix.copy(cam._projectionMatrix),e._viewMatrix.copy(cam._viewMatrix),e._projectionViewMatrix.copy(cam._projectionViewMatrix),e._inverseProjectionViewMatrix.copy(cam._inverseProjectionViewMatrix),e.frustum.setFrustum(e._projectionViewMatrix),e}update(){this._setViewMatrix(),this._projectionViewMatrix=this._projectionMatrix.mul(this._viewMatrix),this.frustum.setFrustum(this._projectionViewMatrix._m),this._inverseProjectionViewMatrix=this._projectionViewMatrix.inverseTo(),this._normalMatrix=this._viewMatrix.toMatrix3(),this.events.dispatch(this.events.viewchange,this)}refresh(){this.setProjectionMatrix(this._viewAngle,this._aspect,this._nearDist,this._farDist),this.update()}setAspectRatio(e){this._aspect=e,this.refresh()}getAspectRatio(){return this._aspect}setFar(e){this._farDist=e,this.refresh()}getFar(){return this._farDist}setNear(e){this._nearDist=e,this.refresh()}getNear(){return this._nearDist}setProjectionMatrix(e,t,i,r){this._viewAngle=e,this._aspect=t,this._nearDist=i,this._farDist=r,this._tanViewAngle_hrad=Math.tan(e*M),this._tanViewAngle_hradOneByHeight=this._tanViewAngle_hrad*this.renderer.handler._oneByHeight;var s=this.renderer.handler.canvas;this._projSizeConst=Math.min(s.clientWidth,s.clientHeight)/(this._viewAngle*T),this._projectionMatrix.setPerspective(e,t,i,r),this._projectionMatrixPrecise.setPerspective(e,t,.1,10)}setViewAngle(e){this._viewAngle=e,this.refresh()}set(e,t,i){return this.eye.x=e.x,this.eye.y=e.y,this.eye.z=e.z,t=t||this._n,i=i||this._v,this._n.x=e.x-t.x,this._n.y=e.y-t.y,this._n.z=e.z-t.z,this._u.copy(i.cross(this._n)),this._n.normalize(),this._u.normalize(),this._v.copy(this._n.cross(this._u)),this}look(e,t){this._n.set(this.eye.x-e.x,this.eye.y-e.y,this.eye.z-e.z),this._u.copy((t||this._v).cross(this._n)),this._n.normalize(),this._u.normalize(),this._v.copy(this._n.cross(this._u))}slide(e,t,i){this.eye.x+=e*this._u.x+t*this._v.x+i*this._n.x,this.eye.y+=e*this._u.y+t*this._v.y+i*this._n.y,this.eye.z+=e*this._u.z+t*this._v.z+i*this._n.z}roll(e){var t=Math.cos(T*e),i=Math.sin(T*e),r=this._u.clone();this._u.set(t*r.x-i*this._v.x,t*r.y-i*this._v.y,t*r.z-i*this._v.z),this._v.set(i*r.x+t*this._v.x,i*r.y+t*this._v.y,i*r.z+t*this._v.z)}pitch(e){var t=Math.cos(T*e),i=Math.sin(T*e),r=this._n.clone();this._n.set(t*r.x-i*this._v.x,t*r.y-i*this._v.y,t*r.z-i*this._v.z),this._v.set(i*r.x+t*this._v.x,i*r.y+t*this._v.y,i*r.z+t*this._v.z)}yaw(e){var t=Math.cos(T*e),i=Math.sin(T*e),r=this._u.clone();this._u.set(t*r.x-i*this._n.x,t*r.y-i*this._n.y,t*r.z-i*this._n.z),this._n.set(i*r.x+t*this._n.x,i*r.y+t*this._n.y,i*r.z+t*this._n.z)}unproject(e,t){var i=this.renderer.handler.canvas,r=.5*i.width,s=.5*i.height,n=(e-r)/r,a=-(t-s)/s,o=this._inverseProjectionViewMatrix.mulVec4(new Ve(n,a,-1,1)).affinity();return this._inverseProjectionViewMatrix.mulVec4(new Ve(n,a,0,1)).affinity().subA(o).toVec3().normalize()}project(e){var t=this._projectionViewMatrix.mulVec4(e.toVec4()),i=this.renderer.handler.canvas;return new Xe((1+t.x/t.w)*i.width*.5,(1-t.y/t.w)*i.height*.5)}rotateAround(e,t,i,r){i=i||Ge.ZERO,r=r||Ge.UP;var s=(new He).setRotation(t?this._v:r,e),n=(new He).setIdentity().translate(i),a=(new He).setIdentity().translate(i.negateTo()),o=n.mul(s).mul(a);this.eye=o.mulVec3(this.eye),this._v=s.mulVec3(this._v).normalize(),this._u=s.mulVec3(this._u).normalize(),this._n=s.mulVec3(this._n).normalize()}rotateHorizontal(e,t,i,r){this.rotateAround(e,t,i,r)}rotateVertical(e,t){this.rotateAround(e,!1,t,this._u)}projectedSize(e,t){return Math.atan(t/this.eye.distance(e))*this._projSizeConst}getNormalMatrix(){return this._normalMatrix}getProjectionMatrix(){return this._projectionMatrix}getViewMatrix(){return this._viewMatrix}getProjectionViewMatrix(){return this._projectionViewMatrix}getInverseProjecttionViewMatrix(){return this._inverseProjectionViewMatrix}}const Ws=["viewchange","moveend"],Gs={viewAngle:30,near:1,far:C,eye:new Ge(0,0,0),look:new Ge(0,0,0),up:new Ge(0,1,0)},Xs=function(e,t){this.origin=e.clone(),this.direction=t.clone()};Xs.OUTSIDE=0,Xs.INSIDE=1,Xs.INPLANE=2,Xs.AWAY=3,Xs.prototype.set=function(e,t){return this.origin=e.clone(),this.direction=t.clone(),this},Xs.prototype.getPoint=function(e){return Ge.add(this.origin,this.direction.scaleTo(e))},Xs.prototype.hitTriangle=function(e,t,i,r){var s=t.sub(e),n=i.sub(e),a=s.cross(n),o=this.origin.sub(e),h=-a.dot(o),l=a.dot(this.direction);if(Math.abs(l)<G)return 0===h?(r.copy(this.origin),Xs.INPLANE):Xs.OUTSIDE;var u=h/l;if(r.copy(this.origin.add(this.direction.scaleTo(u))),u<0)return Xs.AWAY;var d=s.dot(s),c=s.dot(n),_=n.dot(n),f=r.sub(e),p=f.dot(s),v=f.dot(n),g=c*c-d*_,m=(c*v-_*p)/g;if(m<0||m>1)return Xs.OUTSIDE;var x=(c*p-d*v)/g;return x<0||m+x>1?Xs.OUTSIDE:Xs.INSIDE},Xs.prototype.hitPlane=function(e,t,i,r){var s=Ge.sub(t,e),n=Ge.sub(i,e),a=s.cross(n),o=Ge.sub(this.origin,e),h=-a.dot(o),l=a.dot(this.direction);if(Math.abs(l)<G&&0===h)return Xs.OUTSIDE;var u=h/l;if(u<0)return Xs.OUTSIDE;var d=this.direction.scaleTo(u);return r.x=this.origin.x+d.x,r.y=this.origin.y+d.y,r.z=this.origin.z+d.z,Xs.INSIDE},Xs.prototype.hitSphere=function(e){var t=e.radius,i=e.center,r=this.origin,s=this.direction,n=Ge.sub(i,r);if(n.dot(s)<0){var a=n.length();if(a>t)return null;if(a===t)return r.clone();var o=i.projToRay(r,n),h=Ge.sub(o,i).length(),l=(d=Math.sqrt(t*t-h*h))-Ge.sub(o,r).length();return Ge.add(r,s.scaleTo(l))}o=i.projToRay(r,s);var u=Ge.sub(i,o).length();if(u>e.radius)return null;var d=Math.sqrt(t*t-u*u);return o.subA(r),l=n.length()>t?o.length()-d:o.length()+d,Ge.add(r,s.scaleTo(l))},Xs.prototype.hitBox=function(e){};class Ys extends Hs{constructor(e,t){super(e.renderer,t),this.planet=e,this.minAltitude=t.minAltitude||50,this._lonLat=this.planet.ellipsoid.cartesianToLonLat(this.eye),this._lonLatMerc=this._lonLat.forwardMercator(),this._terrainAltitude=this._lonLat.height,this._terrainPoint=new Ge,this._insideSegment=null,this.slope=0,this._insideSegmentPosition=null,this._keyLock=new Is,this._framesArr=[],this._framesCounter=0,this._numFrames=50,this._completeCallback=null,this._flying=!1}clone(){var e=new Ys;return e.eye.copy(cam.eye),e._u.copy(cam._u),e._v.copy(cam._v),e._n.copy(cam._n),e.renderer=cam.renderer,e._projectionMatrix.copy(cam._projectionMatrix),e._viewMatrix.copy(cam._viewMatrix),e._projectionViewMatrix.copy(cam._projectionViewMatrix),e._inverseProjectionViewMatrix.copy(cam._inverseProjectionViewMatrix),e.frustum.setFrustum(e._projectionViewMatrix),e.planet=cam.planet,e._lonLat=cam._lonLat.clone(),e}update(){this._setViewMatrix(),this._projectionViewMatrix=this._projectionMatrix.mul(this._viewMatrix),this.frustum.setFrustum(this._projectionViewMatrix._m),this._inverseProjectionViewMatrix=this._projectionMatrixPrecise.mul(this._viewMatrix).inverseTo(),this._normalMatrix=this._viewMatrix.toMatrix3(),this.updateGeodeticPosition(),this.slope=this._n.dot(this.eye.normal()),this.events.dispatch(this.events.viewchange,this)}updateGeodeticPosition(){this._lonLat=this.planet.ellipsoid.cartesianToLonLat(this.eye),Math.abs(this._lonLat.lat)<=ze&&(this._lonLatMerc=this._lonLat.forwardMercator())}setAltitude(e){var t=this.eye.normal(),i=this._terrainPoint;this.eye.x=t.x*e+i.x,this.eye.y=t.y*e+i.y,this.eye.z=t.z*e+i.z,this._terrainAltitude=e,this.update()}getAltitude(){return this._terrainAltitude}setLonLat(e,t){this._lonLat.set(e.lon,e.lat,e.height||this._lonLat.height);var i=this.planet.ellipsoid.lonLatToCartesian(this._lonLat),r=(new He).rotateBetweenVectors(i.normal(),this.eye.normal());this.eye=i,this._v=r.mulVec3(this._v),this._u=r.mulVec3(this._u),this._n=r.mulVec3(this._n)}getLonLat(){return this._lonLat}getHeight(){return this._lonLat.height}viewLonLat(e,t){this._lonLat.set(e.lon,e.lat,e.height||this._lonLat.height);var i=this.planet.ellipsoid,r=i.lonLatToCartesian(this._lonLat),s=i.lonLatToCartesian(new De(this._lonLat.lon,this._lonLat.lat,0));this.set(r,s,t||Ge.UP)}getExtentPosition(e){var t=e.getNorth(),i=e.getSouth(),r=e.getEast(),s=e.getWest();s>r&&(r+=360);var n=this.planet.ellipsoid,a=new De(r,t),o=n.lonLatToCartesian(a);a.lat=i;var h=n.lonLatToCartesian(a);a.lon=s;var l=n.lonLatToCartesian(a);a.lat=t;var u=n.lonLatToCartesian(a),d=Ge.sub(o,l).scale(.5).addA(l),c=d.length();c<1e-6&&(a.lon=.5*(r+s),a.lat=.5*(t+i),d=n.lonLatToCartesian(a)),u.subA(d),h.subA(d),o.subA(d),l.subA(d);var _=d.normal(),f=_.cross(Ge.UP).normalize(),p=f.cross(_).normalize(),v=Math.max(Math.abs(p.dot(u)),Math.abs(p.dot(h)),Math.abs(p.dot(o)),Math.abs(p.dot(l))),g=Math.max(Math.abs(f.dot(u)),Math.abs(f.dot(h)),Math.abs(f.dot(o)),Math.abs(f.dot(l))),m=Math.tan(this._viewAngle*T*.5),x=this._aspect*m,y=Math.max(g/x,v/m);return d.normalize(),d.scale(c+y),d}viewExtent(e){this.stopFlying(),this.set(this.getExtentPosition(e),Ge.ZERO,Ge.UP),this.refresh()}flyExtent(e,t,i,r){this.flyCartesian(this.getExtentPosition(e),Ge.ZERO,t,i,r)}flyCartesian(e,t,i,r,s){this.stopFlying(),this._completeCallback=r,s&&s.call(this);var n=t||Ge.ZERO;t instanceof De&&(n=this.planet.ellipsoid.lonLatToCartesian(t));var a=this.planet.ellipsoid.lonLatToCartesian(new De(this._lonLat.lon,this._lonLat.lat)),o=this._v,h=this._n,l=this.planet.ellipsoid.cartesianToLonLat(e),u=i||Ge.UP,d=this.planet.ellipsoid.lonLatToCartesian(new De(l.lon,l.lat,0)),c=e,_=Ge.sub(c,n),f=u.cross(_);_.normalize(),f.normalize();var p=_.cross(f),v=a.normal(),g=d.normal(),m=1-v.dot(g),x=N*Math.sqrt(m>0?m:0),y=6639613,C=Math.max(this._lonLat.height,l.height);C>y&&(y=C);for(var b=C+2.5*x*(y-C),T=Ge.ZERO,A=0;A<=this._numFrames;A++){var E=1-A/this._numFrames;E=E*E*(3-2*E),E*=E;var w=a.smerp(d,E).normalize(),M=this.planet.getRayIntersectionEllipsoid(new Xs(T,w)),P=1-E,B=this._lonLat.height*E*E*E+3*b*E*E*P+3*b*E*P*P+l.height*P*P*P,L=M.addA(w.scale(B)),R=o.smerp(p,E),S=Ge.add(L,h.smerp(_,E).negateTo()),I=new Ge(L.x-S.x,L.y-S.y,L.z-S.z),F=R.cross(I);I.normalize(),F.normalize();var z=I.cross(F);this._framesArr[A]={eye:L,n:I,u:F,v:z}}this._framesCounter=this._numFrames,this._flying=!0}flyLonLat(e,t,i,r,s){var n=new De(e.lon,e.lat,e.height||this._lonLat.height);this.flyCartesian(this.planet.ellipsoid.lonLatToCartesian(n),t,i,r,s)}stopFlying(){this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock),this._flying=!1,this._framesArr.length=0,this._framesArr=[],this._framesCounter=-1}isFlying(){return this._flying}rotateLeft(e,t){this.rotateHorizontal(e*T,!0^t,Ge.ZERO),this.update()}rotateRight(e,t){this.rotateHorizontal(-e*T,!0^t,Ge.ZERO),this.update()}rotateUp(e){this.rotateVertical(e*T,Ge.ZERO),this.update()}rotateDown(e){this.rotateVertical(-e*T,Ge.ZERO),this.update()}prepareFrame(){if(this._flying){var e=this._numFrames-this._framesCounter;this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock),this.eye=this._framesArr[e].eye,this._u=this._framesArr[e].u,this._v=this._framesArr[e].v,this._n=this._framesArr[e].n,this.update(),this._framesCounter--,this._framesCounter<0&&(this.stopFlying(),this._completeCallback&&(this._completeCallback(),this._completeCallback=null))}else this._terrainAltitude=this._lonLat.height,this._lonLat.height<1e6&&(this._terrainAltitude=this._insideSegment.getTerrainPoint(this._terrainPoint,this.eye,this._insideSegmentPosition),this._terrainAltitude<this.minAltitude&&this.setAltitude(this.minAltitude))}}class js{constructor(e){this.name=e,this.topNode=this,this._dictionary=[],this._dictionary[e]=this,this.childNodes=[],this.parentNode=null,this.__staticId=Node.__staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}addNode(e){null==this.parentNode?e.topNode=this:e.topNode=this.topNode,e.parentNode=this,e._dictionary=this.topNode._dictionary,this.childNodes.push(e),this.topNode._dictionary[e.name]=e}destroy(){for(var e=0;e<this.childNodes.length;e++)this.childNodes[e].destroy();this._clear()}getNodeByName(e){return this._dictionary[e]}_clear(){this.name="",this.parentNode=null,this.topNode=null,this.childNodes.length=0}}class qs{constructor(e,t,i,r){this.left=e||0,this.right=i||0,this.top=t||0,this.bottom=r||0}clone(){return new qs(this.left,this.top,this.right,this.bottom)}getWidth(){return Math.abs(this.right-this.left)}getHeight(){return Math.abs(this.bottom-this.top)}getSquare(){return this.getHeight()*this.getWidth()}getDiagonal(){var e=this.getWidth(),t=this.getHeight();return Math.sqrt(t*t+e*e)}fit(e,t){return this.getWidth()==e&&this.getHeight()==t}}class Zs{constructor(){this.imagesCache={},this._counter=0,this._pendingsQueue=new Ms,this._imageIndexCounter=0}load(e,t){if(this.imagesCache[e])t(this.imagesCache[e]);else{var i={src:e,success:t};this._counter>=1?this._pendingsQueue.push(i):this._exec(i)}}_exec(e){this._counter++;var t=this,i=new Image;i.crossOrigin="",i.onload=function(){t.imagesCache[e.src]=i,this.__nodeIndex=t._imageIndexCounter++,e.success(this),t._dequeueRequest()},i.onerror=function(){t._dequeueRequest()},i.src=e.src}_dequeueRequest(){if(this._counter--,this._pendingsQueue.length&&this._counter<1)for(;this._pendingsQueue.length;){var e=this._pendingsQueue.pop();if(e){if(!this.imagesCache[e.src]){this._exec(e);break}this._counter<=0?this._counter=0:this._counter--,e.success(this.imagesCache[e.src])}}}}class Qs{constructor(e,t){this.nodes=[],this.texture=null,this.canvas=new oi(e||1024,t||1024),this.clearCanvas(),this._handler=null,this._images=[],this._btree=null,this._imagesCacheManager=new Zs,this.borderSize=4}getImage(){return this.canvas.getImage()}getCanvas(){return this.canvas._canvas}clearCanvas(){this.canvas.fillEmpty("black")}assignHandler(e){this._handler=e,this.createTexture()}getDiagonal(e){var t=e.atlasWidth||e.width,i=e.atlasHeight||e.height;return Math.sqrt(t*t+i*i)}addImage(e,t){if(e.width&&e.height)return this._images.push(e),this._makeAtlas(t),this.nodes[e.__nodeIndex]}_completeNode(e,t){if(t){var i=this.canvas.getWidth(),r=this.canvas.getHeight(),s=t.image,n=t.rect,a=Math.round(.5*this.borderSize);this.canvas.drawImage(s,n.left+a,n.top+a,s.atlasWidth,s.atlasHeight);var o=t.texCoords;o[0]=(n.left+a)/i,o[1]=(n.top+a)/r,o[2]=(n.left+a)/i,o[3]=(n.bottom-a)/r,o[4]=(n.right-a)/i,o[5]=(n.bottom-a)/r,o[6]=(n.right-a)/i,o[7]=(n.bottom-a)/r,o[8]=(n.right-a)/i,o[9]=(n.top+a)/r,o[10]=(n.left+a)/i,o[11]=(n.top+a)/r,e[s.__nodeIndex]=t}}_makeAtlas(e){if(e&&this._btree){var t=this._images[this._images.length-1];this._completeNode(this.nodes,this._btree.insert(t))}else{(t=this._images.slice(0)).sort(function(e,t){return(t.atlasWidth||t.width)-(e.atlasWidth||e.width)||(t.atlasHeight||t.height)-(e.atlasHeight||e.height)}),this._btree=new Ks(new qs(0,0,this.canvas.getWidth(),this.canvas.getHeight())),this._btree.atlas=this,this.clearCanvas();for(var i=[],r=0;r<t.length;r++)this._completeNode(i,this._btree.insert(t[r]));this.nodes=[],this.nodes=i}}createTexture(){this._handler&&(this._handler.gl.deleteTexture(this.texture),this.texture=this._handler.createTexture_l(this.canvas._canvas))}loadImage(e,t){this._imagesCacheManager.load(e,t)}}class Ks{constructor(e){this.childNodes=null,this.image=null,this.rect=e,this.texCoords=[],this.atlas=null}insert(e){if(this.childNodes){var t=this.childNodes[0].insert(e);return null!=t?t:this.childNodes[1].insert(e)}if(null!=this.image)return null;var i=this.rect,r=(e.atlasWidth||e.width)+this.atlas.borderSize,s=(e.atlasHeight||e.height)+this.atlas.borderSize;return r>i.getWidth()||s>i.getHeight()?null:i.fit(r,s)?(this.image=e,this):(this.childNodes=new Array(2),this.childNodes[0]=new Ks,this.childNodes[0].atlas=this.atlas,this.childNodes[1]=new Ks,this.childNodes[1].atlas=this.atlas,i.getWidth()-r>i.getHeight()-s?(this.childNodes[0].rect=new qs(i.left,i.top,i.left+r,i.bottom),this.childNodes[1].rect=new qs(i.left+r,i.top,i.right,i.bottom)):(this.childNodes[0].rect=new qs(i.left,i.top,i.right,i.top+s),this.childNodes[1].rect=new qs(i.left,i.top+s,i.right,i.bottom)),this.childNodes[0].insert(e))}}class Js{constructor(){var e=["monospace","sans-serif","serif"],t=document.getElementsByTagName("body")[0],i=document.createElement("span");i.style.fontSize="72px",i.innerHTML="mmmmmmmmmmlli";var r={},s={};for(var n in e)i.style.fontFamily=e[n],t.appendChild(i),r[e[n]]=i.offsetWidth,s[e[n]]=i.offsetHeight,t.removeChild(i);this.detect=function(n){var a=!1;for(var o in e){i.style.fontFamily=n+","+e[o],t.appendChild(i);var h=i.offsetWidth!=r[e[o]]||i.offsetHeight!=s[e[o]];t.removeChild(i),a=a||h}return a}}}class $s{constructor(e,t){this._handler=null,this._framebuffer0=null,this._framebuffer1=null,this._framebuffer2=null,this._vertexBuffer=null,this._width=e||512,this._height=t||512;var i=Math.max(this._width,this._height);this._outsideDistance=Math.round(80*i/512),this._insideDistance=Math.round(10*i/512),this._outsideMix=.71,this._insideMix=.679,this._sourceTexture=null,this.initialize()}initialize(){this._initHandler(this._width,this._height),this._initShaders()}_initHandler(e,t){this._handler=new ci(null,{width:e,height:t,context:{alpha:!0,depth:!1}}),this._handler.initialize(),this._handler.deactivateFaceCulling(),this._handler.deactivateDepthTest(),this._vertexBuffer=this._handler.createArrayBuffer(new Float32Array([-1,-1,-1,1,1,-1,1,1]),2,4),this._framebuffer0=new Gi(this._handler,{useDepth:!1}),this._framebuffer1=new Gi(this._handler,{useDepth:!1}),this._framebuffer2=new Gi(this._handler,{useDepth:!1}),this._framebuffer0.init(),this._framebuffer1.init(),this._framebuffer2.init()}_initShaders(){var e=new vi("vfield",{uniforms:{uTexSize:{type:fi.VEC2},uTex1:{type:fi.SAMPLER2D},uDistance:{type:fi.INT},uNeg:{type:fi.VEC2}},attributes:{aPos:{type:fi.VEC2,enableArray:!0}},vertexShader:"precision highp float;            attribute vec2 aPos;            uniform vec2 uTexSize;            varying vec2 TexCoord;            varying vec2 vTexSize;            void main() {                TexCoord = (aPos + 1.0) * 0.5;                TexCoord *= uTexSize;                vTexSize = uTexSize;                gl_Position.xy = aPos;                gl_Position.zw = vec2(0.0, 1.0);            }",fragmentShader:"precision highp float;            uniform sampler2D uTex1;            uniform int uDistance;            uniform vec2 uNeg;            varying vec2 TexCoord;            varying vec2 vTexSize;            const int maxDistance = "+this._outsideDistance+";            void main() {                if ( uNeg.x - uNeg.y * texture2D(uTex1, TexCoord / vTexSize).r > 0.5 ) {                    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);                    return;                }                for ( int i=1; i <= maxDistance; i++ ) {                    if(i > uDistance) break;                    if ( uNeg.x - uNeg.y * texture2D(uTex1, ( TexCoord + vec2(0.0, i) ) / vTexSize ).r > 0.5 ) {                        gl_FragColor = vec4( vec3(float(i)/float(uDistance)), 1.0 );                        return;                    }                    if ( uNeg.x - uNeg.y * texture2D(uTex1, ( TexCoord - vec2(0.0, i)) / vTexSize ).r > 0.5 ) {                        gl_FragColor = vec4(vec3(float(i)/float(uDistance)), 1.0);                        return;                    }                }                gl_FragColor = vec4(1.0);            }"}),t=new vi("hfield",{uniforms:{uTexSize:{type:fi.VEC2},uTex1:{type:fi.SAMPLER2D},uDistance:{type:fi.INT}},attributes:{aPos:{type:fi.VEC2,enableArray:!0}},vertexShader:"precision highp float;            attribute vec2 aPos;            uniform vec2 uTexSize;            varying vec2 TexCoord;            varying vec2 vTexSize;            void main() {\n                TexCoord = (aPos + 1.0) * 0.5;                TexCoord *= uTexSize;                vTexSize = uTexSize;                gl_Position.xy = aPos;                gl_Position.zw = vec2(0.0, 1.0);            }",fragmentShader:"precision highp float;            uniform sampler2D uTex1;            uniform int uDistance;            varying vec2 TexCoord;            varying vec2 vTexSize;            const int maxDistance = "+this._outsideDistance+";            float CalcC(float H, float V) {                return ( sqrt( H * H + V * V ) );            }            void main(){                float dist = CalcC( 0.0, texture2D( uTex1, TexCoord / vTexSize ).r );                for ( int i = 1; i <= maxDistance; i++ ) {                    if(i > uDistance) break;                    float H = float(i) / float(uDistance);                    dist = min( dist, CalcC( H, texture2D( uTex1, ( TexCoord + vec2( float(i), 0.0) ) / vTexSize ).r ) );                    dist = min( dist, CalcC( H, texture2D( uTex1, ( TexCoord - vec2( float(i), 0.0) ) / vTexSize ).r ) );                }                gl_FragColor = vec4(dist);                gl_FragColor.w = 1.0;            }"}),i=new vi("sum",{uniforms:{outside:{type:fi.SAMPLER2D},inside:{type:fi.SAMPLER2D},source:{type:fi.SAMPLER2D}},attributes:{aPos:{type:fi.VEC2,enableArray:!0}},vertexShader:"attribute vec2 aPos;\n                        varying vec2 TexCoord;\n                        void main(){\n                            TexCoord = (aPos * vec2(1.0,-1.0) + 1.0) * 0.5;\n                            gl_Position.xy = aPos;\n                            gl_Position.zw = vec2(0.0, 1.0);\n                        }",fragmentShader:"precision highp float;\n                        uniform sampler2D outside;\n                        uniform sampler2D inside;\n                        uniform sampler2D source;\n                        varying vec2 TexCoord;\n                        void main(){\n                            float o = texture2D(outside, TexCoord).r;\n                            float i = 1.0 - texture2D(inside, TexCoord).r;\n                            float s = texture2D(source, TexCoord).r;\n                            gl_FragColor = vec4( vec3(1.0 - mix(i, o, step(0.5, s) * "+this._outsideMix+" + (1.0 - step(0.5, s)) * "+this._insideMix+" )), 1.0);\n                        }"});this._handler.addShaderPrograms([e,t,i])}setSize(e,t){e==this._width&&t==this._height||(this._width=e,this._height=t,this._handler.setSize(e,t),this._framebuffer0.setSize(e,t),this._framebuffer1.setSize(e,t))}createSDF(e,t,i){var r=this._handler,s=r.gl;r.setSize(this._width,this._height),s.deleteTexture(this._sourceTexture),this._sourceTexture=r.createTexture_l(e),r.shaderPrograms.vfield.activate();var n=(o=r.shaderPrograms.vfield._program).attributes,a=o.uniforms;s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._sourceTexture),s.uniform1i(a.uTex1._pName,0),s.uniform2fv(a.uTexSize._pName,[this._width,this._height]),s.bindBuffer(s.ARRAY_BUFFER,this._vertexBuffer),s.vertexAttribPointer(n.aPos._pName,this._vertexBuffer.itemSize,s.FLOAT,!1,0,0),this._framebuffer0.activate(),s.uniform1i(a.uDistance._pName,this._outsideDistance),s.uniform2fv(a.uNeg._pName,[0,-1]),s.drawArrays(s.TRIANGLE_STRIP,0,4),this._framebuffer0.deactivate(),this._framebuffer2.activate(),s.uniform2fv(a.uNeg._pName,[1,1]),s.uniform1i(a.uDistance._pName,this._insideDistance),s.drawArrays(s.TRIANGLE_STRIP,0,4),this._framebuffer2.deactivate(),r.shaderPrograms.hfield.activate();n=(o=r.shaderPrograms.hfield._program).attributes,a=o.uniforms;s.uniform2fv(a.uTexSize._pName,[this._width,this._height]),s.bindBuffer(s.ARRAY_BUFFER,this._vertexBuffer),s.vertexAttribPointer(n.aPos._pName,this._vertexBuffer.itemSize,s.FLOAT,!1,0,0),this._framebuffer1.activate(),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._framebuffer0.texture),s.uniform1i(a.uTex1._pName,0),s.uniform1i(a.uDistance._pName,this._outsideDistance),s.drawArrays(s.TRIANGLE_STRIP,0,4),this._framebuffer1.deactivate(),this._framebuffer0.activate(),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._framebuffer2.texture),s.uniform1i(a.uTex1._pName,0),s.uniform1i(a.uDistance._pName,this._insideDistance),s.drawArrays(s.TRIANGLE_STRIP,0,4),this._framebuffer0.deactivate(),r.setSize(t||this._width,i||this._height),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),r.shaderPrograms.sum.activate();var o;n=(o=r.shaderPrograms.sum._program).attributes,a=o.uniforms;return s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._framebuffer1.texture),s.uniform1i(a.outside._pName,0),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,this._framebuffer0.texture),s.uniform1i(a.inside._pName,1),s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_2D,this._sourceTexture),s.uniform1i(a.source._pName,2),s.bindBuffer(s.ARRAY_BUFFER,this._vertexBuffer),s.vertexAttribPointer(n.aPos._pName,this._vertexBuffer.itemSize,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLE_STRIP,0,4),r.canvas}}const en=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","а","б","в","г","д","е","ё","ж","з","и","к","л","м","н","о","п","р","с","т","у","ф","х","ц","ч","ш","щ","ь","э","ъ","ю","я","й","А","Б","В","Г","Д","Е","Ё","Ж","З","И","К","Л","М","Н","О","П","Р","С","Т","У","Ф","Х","Ц","Ч","Ш","Щ","Ь","Э","Ъ","Ю","Я","Й","1","2","3","4","5","6","7","8","9","0","`","!","@","#","$","%","^","&","*","(",")","_","+","-","=","[","]","{","}","\\","|",";",":",'"',",",".","/","<",">","?"," ","    ","'"];class tn{constructor(){this.atlasesArr=[],this.atlasIndexes={},this.tokenImageSize=64,this.samplerArr=[0],this._handler=null,this.defaultFace="arial",this._counter=0,this._pendingsQueue=new Ms,this.fontDetector=new Js,this._sdfCreator=new $s(256,256)}assignHandler(e){this._handler=e}getFontIndex(e,t,i){return this.atlasIndexes[this.getFullIndex(e,t,i)]}getFullIndex(e,t,i){return(!(e=e&&e.trim().toLowerCase())||e&&!this.fontDetector.detect(e))&&(e=this.defaultFace),e+" "+(t&&t.toLowerCase()||"normal")+" "+(i&&i.toLowerCase()||"normal")}createFont(e,t,i){var r=this.getFontIndex(e,t,i);if(void 0==r){var s=this.tokenImageSize,n=this.getFullIndex(e,t,i);r=this.atlasIndexes[n]=this.atlasesArr.length;var a=new Qs(1024,1024);a.assignHandler(this._handler),a.borderSize=6,this.samplerArr[this.atlasesArr.length]=this.atlasesArr.length,this.atlasesArr.push(a),a.canvas.fillColor("black");for(var o=en,h=new oi(512,512),l=this._sdfCreator,u=Math.round(337.92),d=(t||"normal")+" "+(i||"normal")+" "+u+"px "+(e||this.defaultFace),c=0;c<o.length;c++){var _=o[c];h.fillColor("black"),h.drawText(_,49,u,d,"white");var f=l.createSDF(h._canvas,s,s);f.__nodeIndex=_;var p=a.addImage(f,!0),v=h.getTextWidth(_);p.emptySize=v/512}a.createTexture(),h.destroy(),h=null}return r}createFontAsync(e,t,i,r){var s={face:e,style:t,weight:i,callback:r};this._counter>=1?this._pendingsQueue.push(s):this._exec(s)}_exec(e){this._counter++;var t=this;setTimeout(function(){var i=t.createFont(e.face,e.style,e.weight);e.callback(i),t._dequeueRequest()},0)}_dequeueRequest(){var e;(this._counter--,this._pendingsQueue.length&&this._counter<1)&&((e=this._whilePendings())&&this._exec(e))}_whilePendings(){for(;this._pendingsQueue.length;){var e=this._pendingsQueue.pop(),t=this.getFontIndex(e.face,e.style,e.weight);if(void 0==t)return e;e.callback(t)}}}class rn extends js{constructor(e){super(e),this.renderer=null,this.drawMode=null,this.show=!0,this._isActive=!0,this.lightEnabled=!1,this._lights=[],this._lightsTransformedPositions=[],this._lightsParamsv=[],this._lightsParamsf=[],this._lightsNames=[],this.entityCollections=[],this.billboardsTextureAtlas=new Qs,this.fontAtlas=new tn,this.events=new ni}assignRenderer(e){this.renderer=e,this.billboardsTextureAtlas.assignHandler(e.handler),this.fontAtlas.assignHandler(e.handler),e.addPickingCallback(this,this._entityCollectionPickingCallback);for(var t=0;t<this.entityCollections.length;t++)this.entityCollections[t].setRenderer(e);this.initialization&&this.initialization()}addEntityCollection(e,t){return e.addTo(this,t),this}removeEntityCollection(e){e.remove()}addLight(e){return e.addTo(this),this}getLightByName(e){var t=this._lightsNames.indexOf(e);return this._lights[t]}removeLight(e){e.remove()}drawNode(){this._isActive&&this._drawNodes()}isActive(){return this._isActive}setActive(e){this._isActive=e;for(var t=0;t<this.childNodes.length;t++)this.childNodes[t].setActive(e)}setDrawMode(e){this.drawMode=e;for(var t=0;t<this.childNodes.length;t++)this.childNodes[t].setDrawMode(e)}transformLights(){for(var e=this.renderer,t=0;t<this._lights.length;t++){var i,r=4*t;this._lights[t].directional?(i=e.activeCamera._normalMatrix.mulVec(this._lights[t]._position),this._lightsTransformedPositions[r+3]=0):(i=e.activeCamera._viewMatrix.mulVec3(this._lights[t]._position),this._lightsTransformedPositions[r+3]=1),this._lightsTransformedPositions[r]=i.x,this._lightsTransformedPositions[r+1]=i.y,this._lightsTransformedPositions[r+2]=i.z}}updateBillboardsTexCoords(){for(var e=0;e<this.entityCollections.length;e++)this.entityCollections[e].billboardHandler.refreshTexCoordsArr()}_drawNodes(){for(var e=0;e<this.childNodes.length;e++)this.childNodes[e]._isActive&&this.childNodes[e]._drawNodes();this.show&&(this.frame&&this.frame(),this.drawEntityCollections(this.entityCollections))}drawEntityCollections(e){if(e.length){var t=this.renderer.handler.gl;t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE),t.disable(t.CULL_FACE),t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,-637e3),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.billboardsTextureAtlas.texture);for(var i=e.length;i--;){(s=e[i])._animatedOpacity&&(s.events.dispatch(s.events.draw,s),s.billboardHandler.draw())}var r=this.fontAtlas.atlasesArr;for(i=0;i<r.length;i++)t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,r[i].texture);for(i=e.length;i--;)e[i]._animatedOpacity&&e[i].labelHandler.draw();for(i=e.length;i--;)e[i]._animatedOpacity&&e[i].polylineHandler.draw();for(t.polygonOffset(0,0),t.disable(t.POLYGON_OFFSET_FILL),t.enable(t.CULL_FACE),i=e.length;i--;){var s;(s=e[i])._animatedOpacity&&(s.shapeHandler.draw(),s.events.dispatch(s.events.drawend,s))}for(i=e.length;i--;)e[i]._animatedOpacity&&e[i].pointCloudHandler.draw()}}drawPickingEntityCollections(e){if(e.length){var t=this.renderer.handler.gl;t.disable(t.CULL_FACE),t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,-637e3);for(var i=e.length;i--;)e[i]._visibility&&e[i].billboardHandler.drawPicking();for(i=e.length;i--;)e[i]._visibility&&e[i].labelHandler.drawPicking();t.polygonOffset(0,0),t.disable(t.POLYGON_OFFSET_FILL),t.enable(t.CULL_FACE)}}_entityCollectionPickingCallback(){this.drawPickingEntityCollections(this.entityCollections)}}const sn=function(e,t,i,r){this.node=e,this.planet=t,this.handler=t.renderer.handler,this.bbox=new class{constructor(){this.vertices=[new Ge,new Ge,new Ge,new Ge,new Ge,new Ge,new Ge,new Ge]}setFromBounds(e){var t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],a=e[5];this.vertices[0].set(t,r,n),this.vertices[1].set(i,r,n),this.vertices[2].set(i,r,a),this.vertices[3].set(t,r,a),this.vertices[4].set(t,s,n),this.vertices[5].set(i,s,n),this.vertices[6].set(i,s,a),this.vertices[7].set(t,s,a)}setFromExtent(e,t){this.setFromBounds(t.getCartesianBounds(e))}},this.bsphere=new Dr,this._extent=r,this.gridSize=t.terrain.gridSizeByZoom[i],this.tileZoom=i,this.tileX=null,this.tileY=null,this.tileIndex="",this._assignTileIndexes(),this.materials=[],this.ready=!1,this.initialized=!1,this.normalMapReady=!1,this.parentNormalMapReady=!1,this.terrainReady=!1,this.terrainIsLoading=!1,this.terrainExists=!1,this.plainIndexes=null,this.plainVertices=null,this.plainNormals=null,this.terrainVertices=null,this.tempVertices=null,this.normalMapTexture=null,this.normalMapTextureBias=new Float32Array(3),this.normalMapVertices=null,this.normalMapNormals=null,this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexTextureCoordBuffer=null,this._globalTextureCoordinates=new Float32Array(4),this._projection=Wi,this._inTheQueue=!1,this._appliedNeighborsZoom=[0,0,0,0],this._renderingSlices=[],this._indexBuffer=null};sn.prototype.acceptForRendering=function(e){return e.projectedSize(this.bsphere.center,this.bsphere.radius)<256/this.planet.RATIO_LOD},sn.prototype.getEntityTerrainPoint=function(e,t){return this.getTerrainPoint(t,e._cartesian,e._lonlatMerc)},sn.prototype.isEntityInside=function(e){return this._extent.isInside(e._lonlatMerc)},sn.prototype.getTerrainPoint=function(e,t,i){var r=this._extent.northEast,s=this._extent.southWest,n=this.gridSize,a=r.lon,o=r.lat,h=s.lon,l=s.lat,u=(a-h)/n,d=(o-l)/n,c=i.lon-h,_=i.lat-l,f=Math.floor(c/u),p=Math.floor(n-_/d),v=this.terrainReady?this.terrainVertices:this.tempVertices,g=new Xs(t,t.negateTo());if(v&&v.length){var m=3*((n+1)*p+f),x=3*((n+1)*(p+1)+f),y=new Ge(v[m],v[m+1],v[m+2]),C=new Ge(v[m+3],v[m+4],v[m+5]),b=new Ge(v[x],v[x+1],v[x+2]),T=g.hitTriangle(y,C,b,e);if(T===Xs.INSIDE)return t.distance(e);var A=new Ge(v[x+3],v[x+4],v[x+5]);return(T=g.hitTriangle(C,A,b,e))===Xs.INSIDE?t.distance(e):T===Xs.AWAY?-t.distance(e):t.distance(e)}return e.copy(this.planet.ellipsoid.hitRay(g.origin,g.direction)),t.distance(e)},sn.prototype.projectNative=function(e){return e.forwardMercator()},sn.prototype.loadTerrain=function(){this.tileZoom>=this.planet.terrain.minZoom?this.terrainIsLoading||this.terrainReady||this.planet.terrain.handleSegmentTerrain(this):(this.terrainReady=!0,this._inTheQueue||this.planet._normalMapCreator.queue(this))},sn.prototype.elevationsExists=function(e){this.ready&&this.terrainIsLoading&&this.planet._terrainWorker.make(this,e)},sn.prototype._terrainWorkerCallback=function(e){if(this.ready){if(this.normalMapNormals=null,this.normalMapVertices=null,this.terrainVertices=null,this.tempVertices=null,this.normalMapNormals=e.normalMapNormals,this.normalMapVertices=e.normalMapVertices,this.terrainVertices=e.terrainVertices,this.tempVertices=e.terrainVertices,this.terrainReady=!0,this.terrainIsLoading=!1,this.parentNormalMapReady=!0,!this.normalMapTexturePtr){var t=this.planet._normalMapCreator;this.normalMapTexturePtr=this.planet.renderer.handler.createEmptyTexture_l(t._width,t._height)}this.planet.lightEnabled&&this.planet._normalMapCreator.queue(this);var i=this.planet.terrain.gridSizeByZoom[this.tileZoom];this.createCoordsBuffers(this.terrainVertices,i),this.bsphere.setFromBounds(e.bounds),this.gridSize=i,this.terrainExists=!0,this.node.appliedTerrainNodeId=this.node.nodeId}},sn.prototype.elevationsNotExists=function(){if(this.tileZoom<=this.planet.terrain.maxZoom){this.ready&&this.terrainIsLoading&&(this.terrainIsLoading=!1,this.terrainReady=!0,this.terrainExists=!1,this.node.appliedTerrainNodeId=this.node.nodeId,this.gridSize=this.planet.terrain.gridSizeByZoom[this.tileZoom],this.planet.lightEnabled&&!this._inTheQueue&&this.planet._normalMapCreator.queue(this),this.createCoordsBuffers(this.terrainVertices,this.gridSize));for(var e=C,t=b,i=C,r=b,s=C,n=b,a=this.terrainVertices,o=0;o<a.length;o+=3){var h=a[o],l=a[o+1],u=a[o+2];h<e&&(e=h),h>t&&(t=h),l<i&&(i=l),l>r&&(r=l),u<s&&(s=u),u>n&&(n=u)}this.bsphere.setFromBounds([e,t,i,r,s,n])}},sn.prototype._normalMapEdgeEqualize=function(e,t,i){var r=this.node.neighbors,s=r[e],n=this.planet.terrain.maxZoom;this.tileZoom===n&&(r[0]||r[1]||r[2]||r[3]||(s=this.node.getEqualNeighbor(e)));var a=s&&s.segment;if(s&&a&&a.terrainReady&&a.terrainExists&&a.tileZoom<=n&&this._appliedNeighborsZoom[e]!==a.tileZoom){var o=this,h=a;o._appliedNeighborsZoom[e]=h.tileZoom;var l=o.normalMapNormals,u=h.normalMapNormals;if(!l||!u)return;var d,c,_,f,p=Math.sqrt(o.normalMapNormals.length/3),v=Math.sqrt(h.normalMapNormals.length/3),g=p-1,m=v-1;if(t*=g,o.tileZoom===h.tileZoom){var x=g-t;if(i)for(var y=0;y<p;y++){var C=3*(y*p+x);d=l[b=3*(y*p+t)]+u[C],c=l[b+1]+u[C+1],_=l[b+2]+u[C+2],f=1/Math.sqrt(d*d+c*c+_*_),u[C]=l[b]=d*f,u[C+1]=l[b+1]=c*f,u[C+2]=l[b+2]=_*f}else for(y=0;y<p;y++){var b;C=3*(x*p+y);d=l[b=3*(t*p+y)]+u[C],c=l[b+1]+u[C+1],_=l[b+2]+u[C+2],f=1/Math.sqrt(d*d+c*c+_*_),u[C]=l[b]=d*f,u[C+1]=l[b+1]=c*f,u[C+2]=l[b+2]=_*f}h._inTheQueue||h._appliedNeighborsZoom[Ai[e]]===o.tileZoom||this.planet._normalMapCreator.queue(h),h._appliedNeighborsZoom[Ai[e]]=o.tileZoom}else{var T;if(t?(1,T=0):(0,T=1),o.tileZoom<h.tileZoom){h._inTheQueue||h._appliedNeighborsZoom[Ai[e]]===o.tileZoom||this.planet._normalMapCreator.queue(h),h._appliedNeighborsZoom[Ai[e]]=o.tileZoom,e=Ai[e];var A;A=o,o=h,h=A,1,T^=1}o.normalMapNormals,h.normalMapNormals;var E=1/(2<<o.tileZoom-h.tileZoom-1);if(i){var w=o.tileY*E-h.tileY;for(y=0;y<p;y++){Math.round(y*E);d=l[b]+u[C],c=l[b+1]+u[C+1],_=l[b+2]+u[C+2],f=1/Math.sqrt(d*d+c*c+_*_),u[C]=l[b]=d*f,u[C+1]=l[b+1]=c*f,u[C+2]=l[b+2]=_*f}}else{var M=o.tileX*E-h.tileX;for(y=0;y<p;y++){Math.round(y*E);d=l[b]+u[C],c=l[b+1]+u[C+1],_=l[b+2]+u[C+2],f=1/Math.sqrt(d*d+c*c+_*_),u[C]=l[b]=d*f,u[C+1]=l[b+1]=c*f,u[C+2]=l[b+2]=_*f}}}}},sn.prototype.applyTerrain=function(e){this.ready&&(e.length?this.elevationsExists(e):this.elevationsNotExists())},sn.prototype.deleteBuffers=function(){var e=this.handler.gl;e.deleteBuffer(this.vertexNormalBuffer),e.deleteBuffer(this.vertexPositionBuffer),e.deleteBuffer(this.vertexTextureCoordBuffer),this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexTextureCoordBuffer=null},sn.prototype.deleteMaterials=function(){for(var e=this.materials,t=0;t<e.length;t++){var i=e[t];i&&i.clear()}this.materials.length=0},sn.prototype.deleteElevations=function(){this.terrainExists=!1,this.terrainReady=!1,this.terrainIsLoading=!1,this.normalMapVertices=null,this.normalMapNormals=null,this.tempVertices=null,this.terrainVertices=null,this.plainVertices=null,this.plainNormals=null,this.normalMapReady&&this.handler.gl.deleteTexture(this.normalMapTexture),this.normalMapReady=!1,this.parentNormalMapReady=!1,this._appliedNeighborsZoom=[0,0,0,0],this.normalMapTextureBias[0]=0,this.normalMapTextureBias[1]=0,this.normalMapTextureBias[2]=1,this._inTheQueue=!1},sn.prototype.clearSegment=function(){this.ready=!1,this.initialized=!1,this.deleteBuffers(),this.deleteMaterials(),this.deleteElevations()},sn.prototype._freeCache=function(){this.planet._quadTreeNodesCacheMerc[this.tileIndex]=null,delete this.planet._quadTreeNodesCacheMerc[this.tileIndex]},sn.prototype.destroySegment=function(){this._freeCache(),this.clearSegment();for(var e=this._renderingSlices.length;e--;)this._renderingSlices[e].clear();this._renderingSlices=null,this.node=null,this.planet=null,this.handler=null,this.bbox=null,this.bsphere=null,this._extent=null,this.materials=null,this.plainIndexes=null,this.plainVertices=null,this.plainNormals=null,this.terrainVertices=null,this.tempVertices=null,this.normalMapTexture=null,this.normalMapTextureBias=null,this.normalMapVertices=null,this.normalMapNormals=null,this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexTextureCoordBuffer=null,this._tileOffsetArr=null,this._visibleExtentOffsetArr=null,this._projection=null,this._appliedNeighborsZoom=null,this._globalTextureCoordinates=null},sn.prototype.createBoundsByExtent=function(){for(var e=this.planet.ellipsoid,t=this._extent,i=C,r=b,s=C,n=b,a=C,o=b,h=[De.inverseMercator(t.southWest.lon,t.southWest.lat),De.inverseMercator(t.southWest.lon,t.northEast.lat),De.inverseMercator(t.northEast.lon,t.northEast.lat),De.inverseMercator(t.northEast.lon,t.southWest.lat)],l=0;l<h.length;l++){var u=e.lonLatToCartesian(h[l]),d=u.x,c=u.y,_=u.z;d<i&&(i=d),d>r&&(r=d),c<s&&(s=c),c>n&&(n=c),_<a&&(a=_),_>o&&(o=_)}this.bsphere.setFromBounds([i,r,s,n,a,o])},sn.prototype.createCoordsBuffers=function(e,t){var i=(t+1)*(t+1),r=this.handler;r.gl.deleteBuffer(this.vertexPositionBuffer),r.gl.deleteBuffer(this.vertexTextureCoordBuffer),this.vertexTextureCoordBuffer=r.createArrayBuffer(Li[t],2,i),this.vertexPositionBuffer=r.createArrayBuffer(e,3,i)},sn.prototype._addViewExtent=function(){var e=this._extent;if(this.planet._viewExtentMerc){var t=this.planet._viewExtentMerc;e.southWest.lon<t.southWest.lon&&(t.southWest.lon=e.southWest.lon),e.northEast.lon>t.northEast.lon&&(t.northEast.lon=e.northEast.lon),e.southWest.lat<t.southWest.lat&&(t.southWest.lat=e.southWest.lat),e.northEast.lat>t.northEast.lat&&(t.northEast.lat=e.northEast.lat)}else this.planet._viewExtentMerc=new Oe(new De(e.southWest.lon,e.southWest.lat),new De(e.northEast.lon,e.northEast.lat))},sn.prototype._assignTileIndexes=function(){var e=this.tileZoom,t=this._extent,i=we;this.tileX=Math.round(Math.abs(-i-t.southWest.lon)/(t.northEast.lon-t.southWest.lon)),this.tileY=Math.round(Math.abs(i-t.northEast.lat)/(t.northEast.lat-t.southWest.lat)),this.tileIndex=Es.getTileIndex(this.tileX,this.tileY,e),this.planet._quadTreeNodesCacheMerc[this.tileIndex]=this.node},sn.prototype.initializePlainSegment=function(){var e=this.planet,t=this.node;if(t.sideSize[0]=t.sideSize[1]=t.sideSize[2]=t.sideSize[3]=this.gridSize=e.terrain.gridSizeByZoom[this.tileZoom],this.initialized=!0,this.tileZoom<=e.terrain.maxZoom){var i=this.planet._normalMapCreator;this.normalMapTexturePtr=e.renderer.handler.createEmptyTexture_l(i._width,i._height)}},sn.prototype.createPlainSegment=function(){this.initializePlainSegment(),this.createPlainVertices(this.gridSize),this.createCoordsBuffers(this.plainVertices,this.gridSize),this.ready=!0},sn.prototype.createPlainVertices=function(e){var t=this._extent,i=this.planet.terrain.fileGridSize,r=t.getWidth()/Math.max(i,e),s=t.southWest.lon,n=t.northEast.lat,a=Math.max(i/e,1),o=Math.max(i,e)+1,h=this.planet.ellipsoid._invRadii2,l=0,u=0,d=(e+1)*(e+1)*3;this.plainNormals=new Float32Array(d),this.plainVertices=new Float32Array(d);var c=o*o*3;this.normalMapNormals=new Float32Array(c),this.normalMapVertices=new Float32Array(c);for(var _=this.plainVertices,f=this.plainNormals,p=this.normalMapVertices,v=this.normalMapNormals,g=0;g<o;g++)for(var m=0;m<o;m++){var x=this.planet.ellipsoid.lonLatToCartesian(De.inverseMercator(s+m*r,n-g*r)),y=x.x*h.x,C=x.y*h.y,b=x.z*h.z,T=1/Math.sqrt(y*y+C*C+b*b),A=y*T,E=C*T,w=b*T;p[u]=x.x,v[u++]=A,p[u]=x.y,v[u++]=E,p[u]=x.z,v[u++]=w,g%a==0&&m%a==0&&(_[l]=x.x,f[l++]=A,_[l]=x.y,f[l++]=E,_[l]=x.z,f[l++]=w)}this.normalMapTexture=this.planet.transparentTexture,this.terrainVertices=_,this.tempVertices=_,this._globalTextureCoordinates[0]=(t.southWest.lon+we)*Pe,this._globalTextureCoordinates[1]=(we-t.northEast.lat)*Pe,this._globalTextureCoordinates[2]=(t.northEast.lon+we)*Pe,this._globalTextureCoordinates[3]=(we-t.southWest.lat)*Pe},sn.prototype.getMaterialByLayer=function(e){return this.materials[e._id]},sn.prototype._getLayerExtentOffset=function(e){var t=e._extentMerc,i=this._extent,r=t.northEast.lon-t.southWest.lon,s=t.northEast.lat-t.southWest.lat;return[(i.southWest.lon-t.southWest.lon)/r,(t.northEast.lat-i.northEast.lat)/s,(i.northEast.lon-i.southWest.lon)/r,(i.northEast.lat-i.southWest.lat)/s]},sn.prototype._multiRendering=function(e,t,i,r){if(this.ready){var s,n,a=this.handler.gl,o=e.attributes,h=e.uniforms,l=this.materials,u=this.planet;a.activeTexture(a.TEXTURE0+2*u.SLICE_SIZE+2),a.bindTexture(a.TEXTURE_2D,i||this._getDefaultTexture()),a.uniform1i(h.defaultTexture._pName,2*u.SLICE_SIZE+2),s=t?(n=t[0])._height:0;for(var d=0,c=0,_=!1;n;){if(this.layerOverlap(n)&&n.minZoom<=u.minCurrZoom&&n.maxZoom>=u.maxCurrZoom){_=!0;var f=l[n._id];f||(f=l[n._id]=n.createMaterial(this));var p=4*d,v=3*d,g=n.applyMaterial(f);u._tileOffsetArr[p]=g[0],u._tileOffsetArr[p+1]=g[1],u._tileOffsetArr[p+2]=g[2],u._tileOffsetArr[p+3]=g[3],g=this._getLayerExtentOffset(n),u._visibleExtentOffsetArr[p]=g[0],u._visibleExtentOffsetArr[p+1]=g[1],u._visibleExtentOffsetArr[p+2]=g[2],u._visibleExtentOffsetArr[p+3]=g[3],u._transparentColorArr[p]=n.transparentColor[0],u._transparentColorArr[p+1]=n.transparentColor[1],u._transparentColorArr[p+2]=n.transparentColor[2],u._transparentColorArr[p+3]=n.opacity,u._pickingColorArr[v]=n._pickingColor.x/255,u._pickingColorArr[v+1]=n._pickingColor.y/255,u._pickingColorArr[v+2]=n._pickingColor.z/255,u._diffuseMaterialArr[v+3]=n.diffuse.x,u._diffuseMaterialArr[v+1+3]=n.diffuse.y,u._diffuseMaterialArr[v+2+3]=n.diffuse.z,u._ambientMaterialArr[v+3]=n.ambient.x,u._ambientMaterialArr[v+1+3]=n.ambient.y,u._ambientMaterialArr[v+2+3]=n.ambient.z,u._specularMaterialArr[p+4]=n.specular.x,u._specularMaterialArr[p+1+4]=n.specular.y,u._specularMaterialArr[p+2+4]=n.specular.z,u._specularMaterialArr[p+3+4]=n.shininess,u._samplerArr[d]=d,a.activeTexture(a.TEXTURE0+d),a.bindTexture(a.TEXTURE_2D,f.texture&&a.isTexture(f.texture)&&f.texture||this.planet.transparentTexture),u._pickingMaskArr[d]=d+u.SLICE_SIZE,a.activeTexture(a.TEXTURE0+d+u.SLICE_SIZE),a.bindTexture(a.TEXTURE_2D,f.pickingMask&&a.isTexture(f.pickingMask)&&f.pickingMask||this.planet.transparentTexture),d++}n=t[++c]}if(_||!r){u.lightEnabled&&(a.uniform3fv(h.uNormalMapBias._pName,this.normalMapTextureBias),a.activeTexture(a.TEXTURE0+2*u.SLICE_SIZE+3),a.bindTexture(a.TEXTURE_2D,this.normalMapTexture||this.planet.transparentTexture),a.uniform1i(h.uNormalMap._pName,2*u.SLICE_SIZE+3),a.uniform4fv(h.uGlobalTextureCoord._pName,this._globalTextureCoordinates),a.uniform3fv(h.diffuseMaterial._pName,u._diffuseMaterialArr),a.uniform3fv(h.ambientMaterial._pName,u._ambientMaterialArr),a.uniform4fv(h.specularMaterial._pName,u._specularMaterialArr)),a.uniform1i(h.samplerCount._pName,d),a.uniform1f(h.height._pName,s),a.uniform1iv(h.samplerArr._pName,u._samplerArr),a.uniform1iv(h.pickingMaskArr._pName,u._pickingMaskArr),a.uniform4fv(h.tileOffsetArr._pName,u._tileOffsetArr),a.uniform4fv(h.visibleExtentOffsetArr._pName,u._visibleExtentOffsetArr),a.uniform4fv(h.transparentColorArr._pName,u._transparentColorArr),a.uniform3fv(h.pickingColorArr._pName,u._pickingColorArr),a.bindBuffer(a.ARRAY_BUFFER,this.vertexPositionBuffer),a.vertexAttribPointer(o.aVertexPosition._pName,this.vertexPositionBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.vertexTextureCoordBuffer),a.vertexAttribPointer(o.aTextureCoord._pName,this.vertexTextureCoordBuffer.itemSize,a.FLOAT,!1,0,0);var m=this._getIndexBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,m),a.drawElements(u.drawMode,m.numItems,a.UNSIGNED_SHORT,0)}}this.node.hasNeighbor[0]=!1,this.node.hasNeighbor[1]=!1,this.node.hasNeighbor[2]=!1,this.node.hasNeighbor[3]=!1},sn.prototype._screenRendering=function(e,t,i,r,s){if(this.ready){var n,a,o=this.handler.gl,h=e.attributes,l=e.uniforms,u=this.materials,d=this.planet;n=t?(a=t[0])._height:0,o.activeTexture(o.TEXTURE0+d.SLICE_SIZE+2),o.bindTexture(o.TEXTURE_2D,r||this._getDefaultTexture()),o.uniform1i(l.defaultTexture._pName,d.SLICE_SIZE+2);var c=0,_=0,f=!1,p=this._renderingSlices[i];for(p?p.layers=[]:p=this._renderingSlices[i]=new function(e){this.layers=[],this.tileOffsetArr=new Float32Array(e.SLICE_SIZE_4),this.visibleExtentOffsetArr=new Float32Array(e.SLICE_SIZE_4),this.transparentColorArr=new Float32Array(e.SLICE_SIZE_4),this.clear=function(){this.layers.length=0,this.tileOffsetArr.length=0,this.visibleExtentOffsetArr.length=0,this.transparentColorArr.length=0,this.layers=null,this.tileOffsetArr=null,this.visibleExtentOffsetArr=null,this.transparentColorArr=null}}(d),this._indexBuffer=this._getIndexBuffer();a;){if(this.layerOverlap(a)&&a.minZoom<=d.minCurrZoom&&a.maxZoom>=d.maxCurrZoom){f=!0;var v=u[a._id];v||(v=u[a._id]=a.createMaterial(this)),p.layers.push(a);var g=4*c,m=3*c,x=a.applyMaterial(v);p.tileOffsetArr[g]=x[0],p.tileOffsetArr[g+1]=x[1],p.tileOffsetArr[g+2]=x[2],p.tileOffsetArr[g+3]=x[3],x=this._getLayerExtentOffset(a),p.visibleExtentOffsetArr[g]=x[0],p.visibleExtentOffsetArr[g+1]=x[1],p.visibleExtentOffsetArr[g+2]=x[2],p.visibleExtentOffsetArr[g+3]=x[3],p.transparentColorArr[g]=a.transparentColor[0],p.transparentColorArr[g+1]=a.transparentColor[1],p.transparentColorArr[g+2]=a.transparentColor[2],p.transparentColorArr[g+3]=a.opacity,d._diffuseMaterialArr[m+3]=a.diffuse.x,d._diffuseMaterialArr[m+1+3]=a.diffuse.y,d._diffuseMaterialArr[m+2+3]=a.diffuse.z,d._ambientMaterialArr[m+3]=a.ambient.x,d._ambientMaterialArr[m+1+3]=a.ambient.y,d._ambientMaterialArr[m+2+3]=a.ambient.z,d._specularMaterialArr[g+4]=a.specular.x,d._specularMaterialArr[g+1+4]=a.specular.y,d._specularMaterialArr[g+2+4]=a.specular.z,d._specularMaterialArr[g+3+4]=a.shininess,d._samplerArr[c]=c,o.activeTexture(o.TEXTURE0+c),o.bindTexture(o.TEXTURE_2D,v.texture||d.transparentTexture),c++}a=t[++_]}!f&&s||(o.uniform1i(l.samplerCount._pName,c),o.uniform1f(l.height._pName,n),o.uniform1iv(l.samplerArr._pName,d._samplerArr),o.uniform4fv(l.tileOffsetArr._pName,p.tileOffsetArr),o.uniform4fv(l.visibleExtentOffsetArr._pName,p.visibleExtentOffsetArr),o.uniform4fv(l.transparentColorArr._pName,p.transparentColorArr),d.lightEnabled&&(o.activeTexture(o.TEXTURE0+d.SLICE_SIZE+3),o.bindTexture(o.TEXTURE_2D,this.normalMapTexture||d.transparentTexture),o.uniform1i(l.uNormalMap._pName,d.SLICE_SIZE+3),o.uniform3fv(l.uNormalMapBias._pName,this.normalMapTextureBias),o.uniform4fv(l.uGlobalTextureCoord._pName,this._globalTextureCoordinates),o.uniform3fv(l.diffuseMaterial._pName,d._diffuseMaterialArr),o.uniform3fv(l.ambientMaterial._pName,d._ambientMaterialArr),o.uniform4fv(l.specularMaterial._pName,d._specularMaterialArr)),o.bindBuffer(o.ARRAY_BUFFER,this.vertexPositionBuffer),o.vertexAttribPointer(h.aVertexPosition._pName,this.vertexPositionBuffer.itemSize,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this.vertexTextureCoordBuffer),o.vertexAttribPointer(h.aTextureCoord._pName,this.vertexTextureCoordBuffer.itemSize,o.FLOAT,!1,0,0),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,this._indexBuffer),o.drawElements(d.drawMode,this._indexBuffer.numItems,o.UNSIGNED_SHORT,0))}this.node.hasNeighbor[0]=!1,this.node.hasNeighbor[1]=!1,this.node.hasNeighbor[2]=!1,this.node.hasNeighbor[3]=!1},sn.prototype._colorPickingRendering=function(e,t,i,r,s){if(this.ready){var n,a=this.handler.gl,o=e.attributes,h=e.uniforms,l=this.materials,u=this.planet;n=t?t[0]._height:0;for(var d=!1,c=this._renderingSlices[i],_=0;_<c.layers.length;_++){d=!0;var f=c.layers[_],p=3*_;u._pickingColorArr[p]=f._pickingColor.x/255,u._pickingColorArr[p+1]=f._pickingColor.y/255,u._pickingColorArr[p+2]=f._pickingColor.z/255,u._samplerArr[_]=_,a.activeTexture(a.TEXTURE0+_),a.bindTexture(a.TEXTURE_2D,l[f._id].texture||this.planet.transparentTexture),u._pickingMaskArr[_]=_+u.SLICE_SIZE,a.activeTexture(a.TEXTURE0+_+u.SLICE_SIZE),a.bindTexture(a.TEXTURE_2D,l[f._id].pickingMask||this.planet.transparentTexture)}!d&&s||(a.uniform1i(h.samplerCount._pName,_),a.uniform1f(h.height._pName,n),a.uniform1iv(h.samplerArr._pName,u._samplerArr),a.uniform1iv(h.pickingMaskArr._pName,u._pickingMaskArr),a.uniform4fv(h.tileOffsetArr._pName,c.tileOffsetArr),a.uniform4fv(h.visibleExtentOffsetArr._pName,c.visibleExtentOffsetArr),a.uniform4fv(h.transparentColorArr._pName,c.transparentColorArr),a.uniform3fv(h.pickingColorArr._pName,u._pickingColorArr),a.bindBuffer(a.ARRAY_BUFFER,this.vertexPositionBuffer),a.vertexAttribPointer(o.aVertexPosition._pName,this.vertexPositionBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.vertexTextureCoordBuffer),a.vertexAttribPointer(o.aTextureCoord._pName,this.vertexTextureCoordBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this._indexBuffer),a.drawElements(u.drawMode,this._indexBuffer.numItems,a.UNSIGNED_SHORT,0))}},sn.prototype._heightPickingRendering=function(e,t,i,r,s){if(this.ready){var n,a=this.handler.gl,o=e.attributes,h=e.uniforms,l=this.materials,u=this.planet;a.activeTexture(a.TEXTURE0+u.SLICE_SIZE),a.bindTexture(a.TEXTURE_2D,r||u.solidTextureOne),a.uniform1i(h.defaultTexture._pName,u.SLICE_SIZE),n=t?t[0]._height:0;var d=0,c=this._renderingSlices[i],_=!1;for(d=0;d<c.layers.length;d++)_=!0,u._samplerArr[d]=d,a.activeTexture(a.TEXTURE0+d),a.bindTexture(a.TEXTURE_2D,l[c.layers[d]._id].texture||u.transparentTexture);!_&&s||(a.uniform1i(h.samplerCount._pName,d),a.uniform1f(h.height._pName,n),a.uniform1iv(h.samplerArr._pName,u._samplerArr),a.uniform4fv(h.tileOffsetArr._pName,c.tileOffsetArr),a.uniform4fv(h.visibleExtentOffsetArr._pName,c.visibleExtentOffsetArr),a.uniform4fv(h.transparentColorArr._pName,c.transparentColorArr),a.bindBuffer(a.ARRAY_BUFFER,this.vertexPositionBuffer),a.vertexAttribPointer(o.aVertexPosition._pName,this.vertexPositionBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.vertexTextureCoordBuffer),a.vertexAttribPointer(o.aTextureCoord._pName,this.vertexTextureCoordBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this._indexBuffer),a.drawElements(u.drawMode,this._indexBuffer.numItems,a.UNSIGNED_SHORT,0))}},sn.prototype._getIndexBuffer=function(){var e=this.node.sideSize,t=this.planet._indexesCache[this.gridSize][e[0]][e[1]][e[2]][e[3]];return t.buffer||(t.buffer=this.planet.renderer.handler.createElementArrayBuffer(t.indexes,1)),t.buffer},sn.prototype._collectRenderNodes=function(){this.planet._visibleNodes[this.node.nodeId]=this.node},sn.prototype.layerOverlap=function(e){return this._extent.overlaps(e._extentMerc)},sn.prototype._getDefaultTexture=function(){return this.planet.solidTextureOne},sn.prototype.getExtentLonLat=function(){return this._extent.inverseMercator()},sn.prototype.getExtentMerc=function(){return this._extent},sn.prototype.getExtent=function(){return this._extent},sn.prototype.getNodeState=function(){var e=this.planet._visibleNodes[this.node.nodeId];return e&&e.state||bi},sn.prototype.getTileIndex=function(){return this.tileZoom+"_"+this.tileX+"_"+this.tileY};const nn=(90-ze)/Math.pow(2,7),an=function(e,t,i,r){this._isNorth=!1,sn.call(this,e,t,i,r),this._projection=Fs,this._extentMerc=new Oe(r.southWest.forwardMercatorEPS01(),r.northEast.forwardMercatorEPS01())};kr(an,sn),an.prototype.projectNative=function(e){return e},an.prototype.getTerrainPoint=function(e,t){return e.copy(this.planet.ellipsoid.hitRay(t,t.negateTo().normalize())),t.distance(e)},an.prototype.acceptForRendering=function(e){var t,i=this._extent.northEast.lat;if(this._isNorth){var r=Math.floor((90-i)/nn);t=Math.floor(r/16)+7}else{r=Math.floor((ke-i)/nn);t=12-Math.floor(r/16)}return sn.prototype.acceptForRendering.call(this,e)||this.tileZoom>=t},an.prototype._assignTileIndexes=function(){var e=this.tileZoom,t=this._extent;this.tileX=Math.round(Math.abs(-180-t.southWest.lon)/(t.northEast.lon-t.southWest.lon));var i=t.northEast.lat;i>0?(this._isNorth=!0,this.tileY=Math.round((90-i)/(t.northEast.lat-t.southWest.lat))):this.tileY=Math.round((ke-i)/(t.northEast.lat-t.southWest.lat)),this.tileIndex=Es.getTileIndex(this.tileX,this.tileY,e)},an.prototype._addViewExtent=function(){var e=this._extent;if(this.planet._viewExtentWGS84){var t=this.planet._viewExtentWGS84;e.southWest.lon<t.southWest.lon&&(t.southWest.lon=e.southWest.lon),e.northEast.lon>t.northEast.lon&&(t.northEast.lon=e.northEast.lon),e.southWest.lat<t.southWest.lat&&(t.southWest.lat=e.southWest.lat),e.northEast.lat>t.northEast.lat&&(t.northEast.lat=e.northEast.lat)}else this.planet._viewExtentWGS84=new Oe(new De(e.southWest.lon,e.southWest.lat),new De(e.northEast.lon,e.northEast.lat))},an.prototype.createPlainVertices=function(e){var t=0,i=this._extent,r=i.getWidth()/e,s=i.getHeight()/e,n=i.southWest.lon,a=i.northEast.lat,o=this.planet.ellipsoid._invRadii2;this.plainNormals=new Float32Array((e+1)*(e+1)*3),this.plainVertices=new Float32Array((e+1)*(e+1)*3);for(var h=this.plainNormals,l=this.plainVertices,u=0;u<=e;u++)for(var d=0;d<=e;d++){var c=this.planet.ellipsoid.lonLatToCartesian(new De(n+d*r,a-u*s)),_=c.x*o.x,f=c.y*o.y,p=c.z*o.z,v=1/Math.sqrt(_*_+f*f+p*p);l[t]=c.x,h[t++]=_*v,l[t]=c.y,h[t++]=f*v,l[t]=c.z,h[t++]=p*v}this.normalMapVertices=l,this.normalMapNormals=h,this.terrainVertices=l,this.tempVertices=l,this.normalMapTexture=this.planet.transparentTexture,this._globalTextureCoordinates[0]=(i.southWest.lon+180)/360,this._globalTextureCoordinates[1]=(90-i.northEast.lat)/180,this._globalTextureCoordinates[2]=(i.northEast.lon+180)/360,this._globalTextureCoordinates[3]=(90-i.southWest.lat)/180},an.prototype.createBoundsByExtent=function(){for(var e=this.planet.ellipsoid,t=this._extent,i=C,r=b,s=C,n=b,a=C,o=b,h=[new De(t.southWest.lon,t.southWest.lat),new De(t.southWest.lon,t.northEast.lat),new De(t.northEast.lon,t.northEast.lat),new De(t.northEast.lon,t.southWest.lat)],l=0;l<h.length;l++){var u=e.lonLatToCartesian(h[l]),d=u.x,c=u.y,_=u.z;d<i&&(i=d),d>r&&(r=d),c<s&&(s=c),c>n&&(n=c),_<a&&(a=_),_>o&&(o=_)}this.bsphere.setFromBounds([i,r,s,n,a,o])},an.prototype._collectRenderNodes=function(){this._isNorth?this.planet._visibleNodesNorth[this.node.nodeId]=this.node:this.planet._visibleNodesSouth[this.node.nodeId]=this.node},an.prototype.isEntityInside=function(e){return this._extent.isInside(e._lonlat)},an.prototype._getLayerExtentOffset=function(e){var t=e._extent,i=this._extent,r=t.northEast.lon-t.southWest.lon,s=t.northEast.lat-t.southWest.lat;return[(i.southWest.lon-t.southWest.lon)/r,(t.northEast.lat-i.northEast.lat)/s,(i.northEast.lon-i.southWest.lon)/r,(i.northEast.lat-i.southWest.lat)/s]},an.prototype.layerOverlap=function(e){return this._extent.overlaps(e._extent)},an.prototype._getDefaultTexture=function(){return this.planet.solidTextureTwo},an.prototype.getExtentLonLat=function(){return this._extent},an.prototype.getExtentMerc=function(){return this._extentMerc},an.prototype.getNodeState=function(){var e;return(e=this._isNorth?this.planet._visibleNodesNorth[this.node.nodeId]:this.planet._visibleNodesSouth[this.node.nodeId])&&e.state||bi},an.prototype._freeCache=function(){};class on{constructor(e=2){this._workerQueue=new Ms(e);var t=new Blob([hn],{type:"application/javascript"});for(let i=0;i<e;i++)this._workerQueue.push(new Worker(URL.createObjectURL(t)));this._pendingQueue=new Ms(512)}make(e,t){if(e.ready&&e.terrainIsLoading){var i=new Float32Array(t.length);if(i.set(t),this._workerQueue.length){var r=this,s=this._workerQueue.pop();s.onmessage=function(t){if(e._terrainWorkerCallback(t.data),r._workerQueue.unshift(this),r._pendingQueue.length){var i=r._pendingQueue.pop();r.make(i.segment,i.elevations)}},s.postMessage({elevations:i,this_plainVertices:e.plainVertices,this_plainNormals:e.plainNormals,this_normalMapVertices:e.normalMapVertices,this_normalMapNormals:e.normalMapNormals,heightFactor:e.planet._heightFactor,gridSize:e.planet.terrain.gridSizeByZoom[e.tileZoom]},[i.buffer,e.plainVertices.buffer,e.plainNormals.buffer,e.normalMapVertices.buffer,e.normalMapNormals.buffer])}else this._pendingQueue.push({segment:e,elevations:i})}}}const hn="self.onmessage = function (e) {\n        \n        var Vector3 = function(x, y, z) {\n            this.x = x;\n            this.y = y;\n            this.z = z;\n        };\n        Vector3.prototype.sub = function(v) {\n            return new Vector3(this.x - v.x, this.y - v.y, this.z - v.z);\n        };\n        Vector3.prototype.add = function(v) {\n            return new Vector3(this.x + v.x, this.y + v.y, this.z + v.z);\n        };\n        Vector3.prototype.cross = function(v) {\n            return new Vector3(\n                this.y * v.z - this.z * v.y,\n                this.z * v.x - this.x * v.z,\n                this.x * v.y - this.y * v.x\n            );\n        };\n        Vector3.prototype.normalize = function(v) {\n            var x = this.x, y = this.y, z = this.z;\n            var length = 1.0 / Math.sqrt(x * x + y * y + z * z);\n            this.x = x * length;\n            this.y = y * length;\n            this.z = z * length;\n            return this;\n        };\n        \n        var slice = function (t, h1, h0) {\n          return t * (h1 - h0);\n        };\n        \n        var elevations = e.data.elevations,\n            this_plainVertices = e.data.this_plainVertices,\n            this_plainNormals = e.data.this_plainNormals,\n            this_normalMapVertices = e.data.this_normalMapVertices,\n            this_normalMapNormals = e.data.this_normalMapNormals,\n            heightFactor =  e.data.heightFactor,\n            //fileGridSize = e.data.fileGridSize,\n            gridSize = e.data.gridSize;\n        \n        var xmin = 549755748352, xmax = -549755748352, ymin = 549755748352, ymax = -549755748352, zmin = 549755748352, zmax = -549755748352;\n\n        fileGridSize = Math.sqrt(elevations.length) - 1;\n\n        var fileGridSize_one = fileGridSize + 1,\n            tgs = gridSize,\n            dg = fileGridSize / tgs,\n            gs = tgs + 1,\n            hf = heightFactor;\n\n        var nmvInd = 0;\n        var vInd = 0;\n\n        var terrainVertices = new Float32Array(gs * gs * 3);\n        var normalMapNormals = new Float32Array(fileGridSize_one * fileGridSize_one * 3);\n        var normalMapVertices = new Float32Array(fileGridSize_one * fileGridSize_one * 3);\n\n        var nv = this_normalMapVertices,\n            nn = this_normalMapNormals;\n\n        if (fileGridSize >= tgs) {\n            for (var i = 0; i < fileGridSize_one; i++) {\n                for (var j = 0; j < fileGridSize_one; j++) {\n                    var hInd0 = i * fileGridSize_one + j;\n                    var vInd0 = hInd0 * 3;\n                    var h0 = hf * elevations[hInd0];\n                    var v0 = new Vector3(nv[vInd0] + h0 * nn[vInd0], nv[vInd0 + 1] + h0 * nn[vInd0 + 1], nv[vInd0 + 2] + h0 * nn[vInd0 + 2]);\n                    normalMapVertices[vInd0] = v0.x;\n                    normalMapVertices[vInd0 + 1] = v0.y;\n                    normalMapVertices[vInd0 + 2] = v0.z;\n\n                    if (i % dg == 0 && j % dg == 0) {\n                        terrainVertices[vInd++] = v0.x;\n                        terrainVertices[vInd++] = v0.y;\n                        terrainVertices[vInd++] = v0.z;\n\n                        if (v0.x < xmin) xmin = v0.x; if (v0.x > xmax) xmax = v0.x;\n                        if (v0.y < ymin) ymin = v0.y; if (v0.y > ymax) ymax = v0.y;\n                        if (v0.z < zmin) zmin = v0.z; if (v0.z > zmax) zmax = v0.z;\n                    }\n\n                    if (i != fileGridSize && j != fileGridSize) {\n                        var hInd1 = i * fileGridSize_one + j + 1;\n                        var vInd1 = hInd1 * 3;\n                        var h1 = hf * elevations[hInd1];\n                        var v1 = new Vector3(nv[vInd1] + h1 * nn[vInd1], nv[vInd1 + 1] + h1 * nn[vInd1 + 1], nv[vInd1 + 2] + h1 * nn[vInd1 + 2]);\n                        normalMapVertices[vInd1] = v1.x;\n                        normalMapVertices[vInd1 + 1] = v1.y;\n                        normalMapVertices[vInd1 + 2] = v1.z;\n\n                        var hInd2 = (i + 1) * fileGridSize_one + j;\n                        var vInd2 = hInd2 * 3;\n                        var h2 = hf * elevations[hInd2];\n                        var v2 = new Vector3(\n                            nv[vInd2] + h2 * nn[vInd2],\n                            nv[vInd2 + 1] + h2 * nn[vInd2 + 1],\n                            nv[vInd2 + 2] + h2 * nn[vInd2 + 2]);\n                        normalMapVertices[vInd2] = v2.x;\n                        normalMapVertices[vInd2 + 1] = v2.y;\n                        normalMapVertices[vInd2 + 2] = v2.z;\n\n                        var hInd3 = (i + 1) * fileGridSize_one + (j + 1);\n                        var vInd3 = hInd3 * 3;\n                        var h3 = hf * elevations[hInd3];\n                        var v3 = new Vector3(nv[vInd3] + h3 * nn[vInd3], nv[vInd3 + 1] + h3 * nn[vInd3 + 1], nv[vInd3 + 2] + h3 * nn[vInd3 + 2]);\n                        normalMapVertices[vInd3] = v3.x;\n                        normalMapVertices[vInd3 + 1] = v3.y;\n                        normalMapVertices[vInd3 + 2] = v3.z;\n\n                        var e10 = v1.sub(v0),\n                            e20 = v2.sub(v0),\n                            e30 = v3.sub(v0);\n                        var sw = e20.cross(e30).normalize();\n                        var ne = e30.cross(e10).normalize();\n                        var n0 = ne.add(sw).normalize();\n\n                        normalMapNormals[vInd0] += n0.x;\n                        normalMapNormals[vInd0 + 1] += n0.y;\n                        normalMapNormals[vInd0 + 2] += n0.z;\n\n                        normalMapNormals[vInd1] += ne.x;\n                        normalMapNormals[vInd1 + 1] += ne.y;\n                        normalMapNormals[vInd1 + 2] += ne.z;\n\n                        normalMapNormals[vInd2] += sw.x;\n                        normalMapNormals[vInd2 + 1] += sw.y;\n                        normalMapNormals[vInd2 + 2] += sw.z;\n\n                        normalMapNormals[vInd3] += n0.x;\n                        normalMapNormals[vInd3 + 1] += n0.y;\n                        normalMapNormals[vInd3 + 2] += n0.z;\n                    }\n                }\n            }\n\n        } else {\n\n            var plain_verts = this_plainVertices;\n            var plainNormals = this_plainNormals;\n\n            var oneSize = tgs / fileGridSize;\n            var h, inside_i, inside_j, v_i, v_j;\n\n            for (var i = 0; i < gs; i++) {\n                if (i == gs - 1) {\n                    inside_i = oneSize;\n                    v_i = Math.floor(i / oneSize) - 1;\n                } else {\n                    inside_i = i % oneSize;\n                    v_i = Math.floor(i / oneSize);\n                }\n\n                for (var j = 0; j < gs; j++) {\n                    if (j == gs - 1) {\n                        inside_j = oneSize;\n                        v_j = Math.floor(j / oneSize) - 1;\n                    } else {\n                        inside_j = j % oneSize;\n                        v_j = Math.floor(j / oneSize);\n                    }\n\n                    var hvlt = elevations[v_i * fileGridSize_one + v_j],\n                        hvrt = elevations[v_i * fileGridSize_one + v_j + 1],\n                        hvlb = elevations[(v_i + 1) * fileGridSize_one + v_j],\n                        hvrb = elevations[(v_i + 1) * fileGridSize_one + v_j + 1];\n\n                    if (inside_i + inside_j < oneSize) {\n                        h = hf * (hvlt + slice(inside_j / oneSize, hvrt, hvlt) + slice(inside_i / oneSize, hvlb, hvlt));\n                    } else {\n                        h = hf * (hvrb + slice((oneSize - inside_j) / oneSize, hvlb, hvrb) + slice((oneSize - inside_i) / oneSize, hvrt, hvrb));\n                    }\n\n                    var x = plain_verts[vInd] + h * plainNormals[vInd],\n                        y = plain_verts[vInd + 1] + h * plainNormals[vInd + 1],\n                        z = plain_verts[vInd + 2] + h * plainNormals[vInd + 2];\n\n                    terrainVertices[vInd] = x;\n                    terrainVertices[vInd + 1] = y;\n                    terrainVertices[vInd + 2] = z;\n\n                    vInd += 3;\n\n                    if (x < xmin) xmin = x; if (x > xmax) xmax = x;\n                    if (y < ymin) ymin = y; if (y > ymax) ymax = y;\n                    if (z < zmin) zmin = z; if (z > zmax) zmax = z;\n\n                }\n            }\n\n            normalMapNormals = this_plainNormals;\n        }\n        self.postMessage({ \n                normalMapNormals: normalMapNormals,\n                normalMapVertices: normalMapVertices,\n                terrainVertices: terrainVertices,\n                bounds: [xmin, xmax, ymin, ymax, zmin, zmax],\n             }, [normalMapNormals.buffer, normalMapVertices.buffer, terrainVertices.buffer]);\n    }",ln=function(e,t,i,r){this._width=i||256,this._height=r||256,this._handler=e.renderer.handler,this._planet=e,this._framebuffer=null,this.MAX_FRAMES=t||5,this._currentFrame=0,this._queue=[],this._initialize()};ln.prototype._initialize=function(){this._handler.shaderPrograms.vectorTileLineRasterization||this._handler.addShaderProgram(new vi("vectorTileLineRasterization",{uniforms:{viewport:{type:fi.VEC2},thicknessOutline:{type:fi.FLOAT},alpha:{type:fi.FLOAT},extentParams:{type:fi.VEC4}},attributes:{prev:{type:fi.VEC2},current:{type:fi.VEC2},next:{type:fi.VEC2},order:{type:fi.FLOAT},color:{type:fi.VEC4},thickness:{type:fi.FLOAT}},vertexShader:"attribute vec2 prev;                attribute vec2 current;                attribute vec2 next;                attribute float order;                attribute float thickness;                attribute vec4 color;                uniform float thicknessOutline;                uniform vec2 viewport;                uniform vec4 extentParams;                varying vec4 vColor;                                vec2 proj(vec2 coordinates){                    return vec2(-1.0 + (coordinates - extentParams.xy) * extentParams.zw) * vec2(1.0, -1.0);                }                                void main(){                    vColor = color;                    vec2 _next = next;                    vec2 _prev = prev;                    if(prev == current){                        if(next == current){                            _next = current + vec2(1.0, 0.0);                            _prev = current - next;                        }else{                            _prev = current + normalize(current - next);                        }                    }                    if(next == current){                        _next = current + normalize(current - _prev);                    }                                        vec2 sNext = proj(_next),                         sCurrent = proj(current),                         sPrev = proj(_prev);                    vec2 dirNext = normalize(sNext - sCurrent);                    vec2 dirPrev = normalize(sPrev - sCurrent);                    float dotNP = dot(dirNext, dirPrev);                                        vec2 normalNext = normalize(vec2(-dirNext.y, dirNext.x));                    vec2 normalPrev = normalize(vec2(dirPrev.y, -dirPrev.x));                    vec2 d = (thickness + thicknessOutline) * 0.5 * sign(order) / viewport;                                        vec2 m;                    if(dotNP >= 0.99991){                        m = sCurrent - normalPrev * d;                    }else{                        vec2 dir = normalPrev + normalNext;                        m = sCurrent + dir * d / (dirNext.x * dir.y - dirNext.y * dir.x);                                                if( dotNP > 0.5 && dot(dirNext + dirPrev, m - sCurrent) < 0.0 ){                            float occw = order * sign(dirNext.x * dirPrev.y - dirNext.y * dirPrev.x);                            if(occw == -1.0){                                m = sCurrent + normalPrev * d;                            }else if(occw == 1.0){                                m = sCurrent + normalNext * d;                            }else if(occw == -2.0){                                m = sCurrent + normalNext * d;                            }else if(occw == 2.0){                                m = sCurrent + normalPrev * d;                            }                        }else if(distance(sCurrent, m) > min(distance(sCurrent, sNext), distance(sCurrent, sPrev))){                            m = sCurrent + normalNext * d;                        }                    }                    gl_Position = vec4(m.x, m.y, 0.0, 1.0);                }",fragmentShader:"precision highp float;                uniform float alpha;                varying vec4 vColor;                void main() {                    gl_FragColor = vec4(vColor.rgb, alpha * vColor.a);                }"})),this._handler.shaderPrograms.vectorTilePolygonRasterization||this._handler.addShaderProgram(new vi("vectorTilePolygonRasterization",{uniforms:{extentParams:{type:fi.VEC4}},attributes:{coordinates:{type:fi.VEC2},colors:{type:fi.VEC4}},vertexShader:"attribute vec2 coordinates;                       attribute vec4 colors;                       uniform vec4 extentParams;                       varying vec4 color;                      void main() {                           color = colors;                          gl_Position = vec4((-1.0 + (coordinates - extentParams.xy) * extentParams.zw) * vec2(1.0, -1.0), 0.0, 1.0);                       }",fragmentShader:"precision highp float;                        varying vec4 color;                        void main () {                              gl_FragColor = color;                         }"})),this._framebuffer=new Gi(this._handler,{width:this._width,height:this._height,useDepth:!1}),this._framebuffer.init()},ln.prototype.frame=function(){if(this._planet.layerLock.isFree()&&this._queue.length){var e=this._handler,t=e.gl;t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);for(var i,r,s,n,a=e.shaderPrograms.vectorTileLineRasterization,o=e.shaderPrograms.vectorTilePolygonRasterization,h=new Array(4),l=this._framebuffer.activate(),u=2*this._width,d=2*this._height,c=0,_=window.performance.now();this._planet.layerLock.isFree()&&this._queue.length&&c<.25;){var f=this._queue.shift();if(f.isLoading&&f.segment.node.getState()===Ti){f.segment.tileZoom<=3?(i=u,r=d):(i=this._width,r=this._height),n=f._updateTexture&&f._updateTexture||e.createEmptyTexture_l(i,r),l.setSize(i,r),l.bindOutputTexture(n),t.clearColor(1,1,1,0),t.clear(t.COLOR_BUFFER_BIT);var p=f.segment.getExtentMerc();h[0]=p.southWest.lon,h[1]=p.southWest.lat,h[2]=2/p.getWidth(),h[3]=2/p.getHeight(),o.activate();var v=o._program,g=v.attributes,m=v.uniforms,x=f.layer._geometryHandler;t.uniform4fv(m.extentParams._pName,h),t.bindBuffer(t.ARRAY_BUFFER,x._polyVerticesBufferMerc),t.vertexAttribPointer(g.coordinates._pName,x._polyVerticesBufferMerc.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,x._polyColorsBuffer),t.vertexAttribPointer(g.colors._pName,x._polyColorsBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,x._polyIndexesBuffer),t.drawElements(t.TRIANGLES,x._polyIndexesBuffer.numItems,t.UNSIGNED_INT,0),f.layer._pickingEnabled&&(f.pickingReady?s=f.pickingMask:(s=f._updatePickingMask?f._updatePickingMask:e.createEmptyTexture_n(i,r),l.bindOutputTexture(s),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),t.bindBuffer(t.ARRAY_BUFFER,x._polyPickingColorsBuffer),t.vertexAttribPointer(g.colors._pName,x._polyPickingColorsBuffer.itemSize,t.FLOAT,!1,0,0),t.drawElements(t.TRIANGLES,x._polyIndexesBuffer.numItems,t.UNSIGNED_INT,0))),l.bindOutputTexture(n),a.activate(),g=(v=a._program).attributes,m=v.uniforms,t.uniform2fv(m.viewport._pName,[i,r]),t.uniform4fv(m.extentParams._pName,h);var y=x._lineVerticesBufferMerc;t.bindBuffer(t.ARRAY_BUFFER,y),t.vertexAttribPointer(g.prev._pName,y.itemSize,t.FLOAT,!1,8,0),t.vertexAttribPointer(g.current._pName,y.itemSize,t.FLOAT,!1,8,32),t.vertexAttribPointer(g.next._pName,y.itemSize,t.FLOAT,!1,8,64),t.bindBuffer(t.ARRAY_BUFFER,x._lineOrdersBuffer),t.vertexAttribPointer(g.order._pName,x._lineOrdersBuffer.itemSize,t.FLOAT,!1,4,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,x._lineIndexesBuffer),t.bindBuffer(t.ARRAY_BUFFER,x._lineStrokesBuffer),t.vertexAttribPointer(g.thickness._pName,x._lineStrokesBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,x._lineStrokeColorsBuffer),t.vertexAttribPointer(g.color._pName,x._lineStrokeColorsBuffer.itemSize,t.FLOAT,!1,0,0),t.uniform1f(m.thicknessOutline._pName,2),t.uniform1f(m.alpha._pName,.54),t.drawElements(t.TRIANGLE_STRIP,x._lineIndexesBuffer.numItems,t.UNSIGNED_INT,0),t.uniform1f(m.thicknessOutline._pName,1),t.uniform1f(m.alpha._pName,1),t.drawElements(t.TRIANGLE_STRIP,x._lineIndexesBuffer.numItems,t.UNSIGNED_INT,0),t.bindBuffer(t.ARRAY_BUFFER,x._lineThicknessBuffer),t.vertexAttribPointer(g.thickness._pName,x._lineThicknessBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,x._lineColorsBuffer),t.vertexAttribPointer(g.color._pName,x._lineColorsBuffer.itemSize,t.FLOAT,!1,0,0),t.uniform1f(m.thicknessOutline._pName,2),t.uniform1f(m.alpha._pName,.54),t.drawElements(t.TRIANGLE_STRIP,x._lineIndexesBuffer.numItems,t.UNSIGNED_INT,0),t.uniform1f(m.thicknessOutline._pName,1),t.uniform1f(m.alpha._pName,1),t.drawElements(t.TRIANGLE_STRIP,x._lineIndexesBuffer.numItems,t.UNSIGNED_INT,0),f.layer._pickingEnabled&&!f.pickingReady&&(l.bindOutputTexture(s),t.uniform1f(m.thicknessOutline._pName,8),t.bindBuffer(t.ARRAY_BUFFER,x._linePickingColorsBuffer),t.vertexAttribPointer(g.color._pName,x._linePickingColorsBuffer.itemSize,t.FLOAT,!1,0,0),t.drawElements(t.TRIANGLE_STRIP,x._lineIndexesBuffer.numItems,t.UNSIGNED_INT,0)),f.applyTexture(n,s)}else f.isLoading=!1;c=window.performance.now()-_,f.layer._id}t.disable(t.BLEND),t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),l.deactivate()}},ln.prototype.add=function(e){this._queue.push(e)},ln.prototype.remove=function(e){};class un{constructor(e,t){this._a=e,this._b=t,this._flattening=e/t,this._a2=e*e,this._b2=t*t;var i=Math.sqrt(this._a2-this._b2);this._e=i/e,this._e2=this._e*this._e,this._e22=this._e2*this._e2,this._k=i/t,this._k2=this._k*this._k,this._radii=new Ge(e,t,e),this._radii2=new Ge(this._a2,this._b2,this._a2),this._invRadii=new Ge(1/e,1/t,1/e),this._invRadii2=new Ge(1/this._a2,1/this._b2,1/this._a2)}getEquatorialSize(){return this._a}getPolarSize(){return this._b}lonLatToCartesian(e){var t=T*e.lat,i=T*e.lon,r=Math.sin(t),s=this._a/Math.sqrt(1-this._e2*r*r),n=(s+e.height)*Math.cos(t);return new Ge(n*Math.sin(i),(s*(1-this._e2)+e.height)*r,n*Math.cos(i))}cartesianToLonLat(e){var t=e.z,i=e.x,r=e.y,s=this._e2,n=this._e22,a=t*t+i*i,o=Math.sqrt(a),h=this._a2-this._b2,l=r*r,u=54*this._b2*l,d=a+(1-s)*l+s*h,c=d*d,_=n*u*a/(c*d),f=Math.pow(1+_+Math.sqrt(_*(_+2)),.3333333333333333),p=u/(3*Math.pow(1+f+1/f,2)*c),v=Math.sqrt(1+2*n*p),g=o-s*(-p*s*o/1+v+Math.sqrt(.5*this._a2*(1+1/v)-p*(1-s)*l/(v*(1+v))-.5*p*a)),m=g*g,x=Math.sqrt(m+l),y=Math.sqrt(m+(1-s)*l),C=this._b2*r/(this._a*y),b=x*(1-this._b2/(this._a*y)),T=Math.atan((r+this._k2*C)/o),E=Math.atan2(i,t);return new De(E*A,T*A,b)}getSurfaceNormal3v(e){var t=this._invRadii2,i=e.x*t.x,r=e.y*t.y,s=e.z*t.z,n=1/Math.sqrt(i*i+r*r+s*s);return new Ge(i*n,r*n,s*n)}getSurfaceHeight3v(e,t){var i=this._invRadii2,r=e.x*i.x,s=e.y*i.y,n=e.z*i.z,a=1/Math.sqrt(r*r+s*s+n*n);return new Ge(e.x+t*r*a,e.y+t*s*a,e.z+t*n*a)}getGreatCircleDistance(e,t){var i=(t.lat-e.lat)*T,r=(t.lon-e.lon)*T,s=Math.sin(i/2)*Math.sin(i/2)+Math.sin(r/2)*Math.sin(r/2)*Math.cos(e.lat*T)*Math.cos(t.lat*T);return 2*this._a*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))}getMiddlePointOnGreatCircle(e,t){var i=e.lat*T,r=e.lon*T,s=t.lat*T,n=(t.lon-e.lon)*T,a=Math.cos(s)*Math.cos(n),o=Math.cos(s)*Math.sin(n),h=Math.sqrt((Math.cos(i)+a)*(Math.cos(i)+a)+o*o),l=Math.sin(i)+Math.sin(s),u=Math.atan2(l,h),d=r+Math.atan2(o,Math.cos(i)+a);return new De((d*A+540)%360-180,u*A)}getIntermediatePointOnGreatCircle(e,t,i){var r=e.lat*T,s=e.lon*T,n=t.lat*T,a=t.lon*T,o=Math.sin(r),h=Math.cos(r),l=Math.sin(s),u=Math.cos(s),d=Math.sin(n),c=Math.cos(n),_=Math.sin(a),f=Math.cos(a),p=n-r,v=a-s,g=Math.sin(p/2)*Math.sin(p/2)+Math.cos(r)*Math.cos(n)*Math.sin(v/2)*Math.sin(v/2),m=2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)),x=Math.sin((1-i)*m)/Math.sin(m),y=Math.sin(i*m)/Math.sin(m),C=x*h*u+y*c*f,b=x*h*l+y*c*_,E=x*o+y*d,w=Math.atan2(E,Math.sqrt(C*C+b*b)),M=Math.atan2(b,C);return new De((M*A+540)%360-180,w*A)}getRhumbBearing(e,t){var i=(t.lon-e.lon)*T,r=Math.log(Math.tan(t.lat*T/2+Math.PI/4)/Math.tan(e.lat*T/2+Math.PI/4));return Math.abs(i)>Math.PI&&(i=i>0?-1*(2*Math.PI-i):2*Math.PI+i),(Math.atan2(i,r)*A+360)%360}getBearing(e,t){var i=e.lat*T,r=e.lon*T,s=t.lat*T,n=t.lon*T,a=Math.sin(n-r)*Math.cos(s),o=Math.cos(i)*Math.sin(s)-Math.sin(i)*Math.cos(s)*Math.cos(n-r);return Math.atan2(a,o)*A}getBearingDestination(e,t,i){t*=T;var r=(e.lon+540)%360-180,s=e.lat*T,n=r*T,a=i/this._a,o=Math.asin(Math.sin(s)*Math.cos(a)+Math.cos(s)*Math.sin(a)*Math.cos(t));return new De((n+Math.atan2(Math.sin(t)*Math.sin(a)*Math.cos(s),Math.cos(a)-Math.sin(s)*Math.sin(o)))*A,o*A)}getInitialBearing(e,t){var i=e.lat*T,r=t.lat*T,s=(t.lon-e.lon)*T,n=Math.sin(s)*Math.cos(r),a=Math.cos(i)*Math.sin(r)-Math.sin(i)*Math.cos(r)*Math.cos(s);return(Math.atan2(n,a)*A+360)%360}getFinalBearing(e,t){return(this.getInitialBearing(t,e)+180)%360}intersection(e,t,i,r){var s=e.lat*T,n=e.lon*T,a=i.lat*T,o=i.lon*T,h=t*T,l=r*T,u=a-s,d=o-n,c=2*Math.asin(Math.sqrt(Math.sin(u/2)*Math.sin(u/2)+Math.cos(s)*Math.cos(a)*Math.sin(d/2)*Math.sin(d/2)));if(0==c)return null;var _=Math.acos((Math.sin(a)-Math.sin(s)*Math.cos(c))/(Math.sin(c)*Math.cos(s)));isNaN(_)&&(_=0);var f=Math.acos((Math.sin(s)-Math.sin(a)*Math.cos(c))/(Math.sin(c)*Math.cos(a))),p=Math.sin(o-n)>0?_:2*Math.PI-_,v=Math.sin(o-n)>0?2*Math.PI-f:f,g=(h-p+Math.PI)%(2*Math.PI)-Math.PI,m=(v-l+Math.PI)%(2*Math.PI)-Math.PI;if(0==Math.sin(g)&&0==Math.sin(m))return null;if(Math.sin(g)*Math.sin(m)<0)return null;var x=Math.acos(-Math.cos(g)*Math.cos(m)+Math.sin(g)*Math.sin(m)*Math.cos(c)),y=Math.atan2(Math.sin(c)*Math.sin(g)*Math.sin(m),Math.cos(m)+Math.cos(g)*Math.cos(x)),C=Math.asin(Math.sin(s)*Math.cos(y)+Math.cos(s)*Math.sin(y)*Math.cos(h)),b=Math.atan2(Math.sin(h)*Math.sin(y)*Math.cos(s),Math.cos(y)-Math.sin(s)*Math.sin(C));return new De(((n+b)*A+540)%360-180,C*A)}hitRay(e,t){var i,r,s,n,a,o=this._invRadii.mul(e),h=this._invRadii.mul(t),l=o.dot(o),u=o.dot(h);if(l>1){if(u>=0)return null;var d=u*u;if(i=l-1,d<(s=(r=h.dot(h))*i))return null;if(d>s){n=u*u-s;var c=(a=-u+Math.sqrt(n))/r,_=i/a;return c<_?e.add(t.scaleTo(c)):e.add(t.scaleTo(_))}var f=Math.sqrt(i/r);return e.add(t.scaleTo(f))}return l<1?(i=l-1,n=u*u-(s=(r=h.dot(h))*i),a=-u+Math.sqrt(n),e.add(t.scaleTo(a/r))):u<0?(r=h.dot(h),e.add(t.scaleTo(-u/r))):null}}const dn=new un(6378137,6356752.3142),cn="",_n=250,fn=["draw","layeradd","baselayerchange","layerremove","layervisibilitychange"];class pn extends rn{constructor(e,t){super(e),this.ellipsoid=t||dn,this._planetRadius2=this.ellipsoid.getPolarSize()*this.ellipsoid.getPolarSize(),this.layers=[],this.visibleTileLayers=[],this._visibleTileLayerSlices=[],this.visibleVectorLayers=[],this._frustumEntityCollections=[],this.baseLayer=null,this.terrain=null,this.camera=null,this.mousePositionOnEarth=new Ge,this.emptyTexture=null,this.transparentTexture=null,this.defaultTexture=null,this.minCurrZoom=C,this.maxCurrZoom=b,this._viewExtentWGS84=null,this._viewExtentMerc=null,this._createdNodesCount=0,this._renderedNodes=[],this._quadTreeNodesCacheMerc={},this._visibleNodes={},this._visibleNodesNorth={},this._visibleNodesSouth={},this.layerLock=new Ns,this.terrainLock=new Ns,this._tcolorArr=[],this._heightFactor=1,this._indexesCache=[],this._indexesBuffers=[],this._heightPickingFramebuffer=null,this._currentDistanceFromPixel=0,this._viewChanged=!0,this._quadTree=null,this._quadTreeNorth=null,this._quadTreeSouth=null,this._nightTexture=null,this._specularTexture=null,this._useNightTexture=!0,this._useSpecularTexture=!0,this.SLICE_SIZE=4,this.SLICE_SIZE_4=4*this.SLICE_SIZE,this.SLICE_SIZE_3=3*this.SLICE_SIZE,this.RATIO_LOD=1.12,this._diffuseMaterialArr=new Float32Array(this.SLICE_SIZE_3+3),this._ambientMaterialArr=new Float32Array(this.SLICE_SIZE_3+3),this._specularMaterialArr=new Float32Array(this.SLICE_SIZE_4+4),this._tileOffsetArr=new Float32Array(this.SLICE_SIZE_4),this._visibleExtentOffsetArr=new Float32Array(this.SLICE_SIZE_4),this._transparentColorArr=new Float32Array(this.SLICE_SIZE_4),this._pickingColorArr=new Float32Array(this.SLICE_SIZE_3),this._samplerArr=new Int32Array(this.SLICE_SIZE),this._pickingMaskArr=new Int32Array(this.SLICE_SIZE),this._geoImageCreator=null,this._vectorTileCreator=null,this._normalMapCreator=null,this._terrainWorker=new on(12),this._imageBitmapLoader=new Ss({maxRequests:20,numWorkers:5}),this._fnRendering=null,this._memKey=new Is,this.events.registerNames(fn)}addControl(e){e.planet=this,e.addTo(this.renderer)}addControls(e){for(var t=0;t<e.length;t++)this.addControl(e[t])}getLayerByName(e){for(var t=this.layers.length;t--;)if(this.layers[t].name===e)return this.layers[t]}addLayer(e){e.addTo(this)}_onLayerVisibilityChanged(e){this.events.dispatch(this.events.layervisibilitychange,e)}addLayers(e){for(var t=0;t<e.length;t++)this.addLayer(e[t])}removeLayer(e){return e.remove()}_clearLayerMaterial(e){var t=e._id;this._quadTree.traverseTree(function(e){var i=e.segment.materials;i[t]&&(i[t].clear(),i[t]=null)})}getLayers(){return this.layers}setBaseLayer(e){this.baseLayer?this.baseLayer.isEqual(e)||(this.baseLayer.setVisibility(!1),this.baseLayer=e,e.setVisibility(!0),this.events.dispatch(this.events.baselayerchange,e)):(this.baseLayer=e,this.baseLayer.setVisibility(!0),this.events.dispatch(this.events.baselayerchange,e))}setHeightFactor(e){if(this._heightFactor!==e){this._heightFactor=e;var t=this._quadTree.nodes;this._quadTree.nodes=[];for(var i=0;i<t.length;i++)t[i].destroyBranches()}}getHeightFactor(){return this._heightFactor}setTerrain(e){this.terrain=e,this.terrain._planet=this}_initializeShaders(){var e=this.renderer.handler;this.renderer.isMultiFramebufferCompatible()?(e.addShaderProgram(new vi("drawnode_nl",{uniforms:{projectionViewMatrix:{type:fi.MAT4},samplerCount:{type:fi.INT},tileOffsetArr:{type:fi.VEC4},visibleExtentOffsetArr:{type:fi.VEC4},samplerArr:{type:fi.SAMPLER2DXX},pickingMaskArr:{type:fi.SAMPLER2DXX},transparentColorArr:{type:fi.VEC4},pickingColorArr:{type:fi.VEC3},defaultTexture:{type:fi.SAMPLER2D},height:{type:fi.FLOAT},cameraPosition:{type:fi.VEC3}},attributes:{aVertexPosition:{type:fi.VEC3,enableArray:!0},aTextureCoord:{type:fi.VEC2,enableArray:!0}},vertexShader:"attribute vec3 aVertexPosition;            attribute vec2 aTextureCoord;            uniform mat4 projectionViewMatrix;            uniform float height;            uniform vec3 cameraPosition;            varying vec2 vTextureCoord;            varying float range;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main(void) {                range = distance(cameraPosition, aVertexPosition + normalize(aVertexPosition) * height);                vTextureCoord = aTextureCoord;                gl_Position = projectionViewMatrix * vec4(aVertexPosition + normalize(aVertexPosition) * height, 1.0);                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;            }",fragmentShader:"#extension GL_EXT_draw_buffers : require\n            precision highp float;\n            uniform vec4 tileOffsetArr[5];            uniform vec4 visibleExtentOffsetArr[5];            uniform vec4 transparentColorArr[5];            uniform vec3 pickingColorArr[5];            uniform sampler2D defaultTexture;            uniform sampler2D samplerArr[5];            uniform sampler2D pickingMaskArr[5];            uniform int samplerCount;            varying vec2 vTextureCoord;            varying float range;            const float oneBy255 = 1.0 / 255.0;            /* return 1 if v inside the box, return 0 otherwise */            float insideBox(vec2 v, vec2 bottomLeft, vec2 topRight) {                vec2 s = step(bottomLeft, v) - step(topRight, v);                return s.x * s.y;            }            vec3 encode24(highp float f) {                float F = abs(f);                float s = step( 0.0, -f );                float e = floor( log2(F) );                float m = exp2(- e) * F;                e = floor( log2(F) + 127.0 ) + floor( log2(m) );                return vec3(                    ( 128.0 * s + floor( e * exp2(-1.0) ) ) / 255.0,                    ( 128.0 * mod( e, 2.0 ) + mod( floor( m * 128.0 ), 128.0 ) ) / 255.0,                    floor( mod( floor( m * exp2( 23.0 - 8.0) ), exp2(8.0) ) ) / 255.0);            }            const vec2 BOTTOMLEFT = vec2(0.0);            const vec2 TOPRIGHT = vec2(1.0);            void main(void) {                gl_FragData[0] = texture2D( defaultTexture, vTextureCoord );                gl_FragData[1] = vec4(0.0);                gl_FragData[2] = vec4(encode24(range), gl_FragData[0].a);                if( samplerCount == 0 ) return;                vec2 tc = tileOffsetArr[0].xy + vTextureCoord.xy * tileOffsetArr[0].zw;                float ins = insideBox(visibleExtentOffsetArr[0].xy + vTextureCoord.xy * visibleExtentOffsetArr[0].zw, BOTTOMLEFT, TOPRIGHT);                vec4 t = texture2D( samplerArr[0], tc ) * ins;                vec4 p = texture2D( pickingMaskArr[0], tc ) * ins;                float emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[0].rgb ));                gl_FragData[0] = mix( gl_FragData[0], vec4(t.rgb, 1.0), transparentColorArr[0].a * t.a * emptiness);                emptiness = 1.0 - step(0.0, -emptiness);                gl_FragData[1] = vec4(max(pickingColorArr[0], p.rgb), emptiness);                gl_FragData[2] = mix( gl_FragData[2], vec4(encode24(range), 1.0), emptiness);                if( samplerCount == 1 ) return;                tc = tileOffsetArr[1].xy + vTextureCoord.xy * tileOffsetArr[1].zw;                ins = insideBox(visibleExtentOffsetArr[1].xy + vTextureCoord.xy * visibleExtentOffsetArr[1].zw, BOTTOMLEFT, TOPRIGHT);                t = texture2D( samplerArr[1], tc ) * ins;                p = texture2D( pickingMaskArr[1], tc ) * ins;                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[1].rgb ));                gl_FragData[0] = mix( gl_FragData[0], vec4(t.rgb, 1.0), transparentColorArr[1].a * t.a * emptiness);                emptiness = 1.0 - step(0.0, -emptiness);                gl_FragData[1] = mix( gl_FragData[1], vec4(max(pickingColorArr[1], p.rgb), 1.0), emptiness);                gl_FragData[2] = mix( gl_FragData[2], vec4(encode24(range), 1.0), emptiness);                if( samplerCount == 2 ) return;                tc = tileOffsetArr[2].xy + vTextureCoord.xy * tileOffsetArr[2].zw;                ins = insideBox(visibleExtentOffsetArr[2].xy + vTextureCoord.xy * visibleExtentOffsetArr[2].zw, BOTTOMLEFT, TOPRIGHT);                t = texture2D( samplerArr[2], tc ) * ins;                p = texture2D( pickingMaskArr[2], tc ) * ins;                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[2].rgb ));                gl_FragData[0] = mix( gl_FragData[0], vec4(t.rgb, 1.0), transparentColorArr[2].a * t.a * emptiness);                emptiness = 1.0 - step(0.0, -emptiness);                gl_FragData[1] = mix( gl_FragData[1], vec4(max(pickingColorArr[2], p.rgb), 1.0), emptiness);                gl_FragData[2] = mix( gl_FragData[2], vec4(encode24(range), 1.0), emptiness);                if( samplerCount == 3 ) return;                tc = tileOffsetArr[3].xy + vTextureCoord.xy * tileOffsetArr[3].zw;                ins = insideBox(visibleExtentOffsetArr[3].xy + vTextureCoord.xy * visibleExtentOffsetArr[3].zw, BOTTOMLEFT, TOPRIGHT);                t = texture2D( samplerArr[3], tc ) * ins;                p = texture2D( pickingMaskArr[3], tc ) * ins;                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[3].rgb ));                gl_FragData[0] = mix( gl_FragData[0], vec4(t.rgb, 1.0), transparentColorArr[3].a * t.a * emptiness);                emptiness = 1.0 - step(0.0, -emptiness);                gl_FragData[1] = mix( gl_FragData[1], vec4(max(pickingColorArr[3], p.rgb), 1.0), emptiness);                gl_FragData[2] = mix( gl_FragData[2], vec4(encode24(range), 1.0), emptiness);                if( samplerCount == 4 ) return;                tc = tileOffsetArr[4].xy + vTextureCoord.xy * tileOffsetArr[4].zw;                ins = insideBox(visibleExtentOffsetArr[4].xy + vTextureCoord.xy * visibleExtentOffsetArr[4].zw, BOTTOMLEFT, TOPRIGHT);                t = texture2D( samplerArr[4], tc ) * ins;                p = texture2D( pickingMaskArr[4], tc ) * ins;                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[4].rgb ));                gl_FragData[0] = mix( gl_FragData[0], vec4(t.rgb, 1.0), transparentColorArr[4].a * t.a * emptiness);                emptiness = 1.0 - step(0.0, -emptiness);                gl_FragData[1] = mix( gl_FragData[1], vec4(max(pickingColorArr[4], p.rgb), 1.0), emptiness);                gl_FragData[2] = mix( gl_FragData[2], vec4(encode24(range), 1.0), emptiness);            }"}),!0),e.addShaderProgram(new vi("drawnode_wl",{uniforms:{projectionMatrix:{type:fi.MAT4},viewMatrix:{type:fi.MAT4},samplerCount:{type:fi.INT},tileOffsetArr:{type:fi.VEC4},visibleExtentOffsetArr:{type:fi.VEC4},samplerArr:{type:fi.SAMPLER2DXX},pickingMaskArr:{type:fi.SAMPLER2DXX},transparentColorArr:{type:fi.VEC4},pickingColorArr:{type:fi.VEC3},defaultTexture:{type:fi.SAMPLER2D},height:{type:fi.FLOAT},cameraPosition:{type:fi.VEC3},uGlobalTextureCoord:{type:fi.VEC4},normalMatrix:{type:fi.MAT3},uNormalMap:{type:fi.SAMPLER2D},uNormalMapBias:{type:fi.VEC3},nightTexture:{type:fi.SAMPLER2D},specularTexture:{type:fi.SAMPLER2D},lightsPositions:{type:fi.VEC4},diffuseMaterial:{type:fi.VEC3},ambientMaterial:{type:fi.VEC3},specularMaterial:{type:fi.VEC4}},attributes:{aVertexPosition:{type:fi.VEC3,enableArray:!0},aTextureCoord:{type:fi.VEC2,enableArray:!0}},vertexShader:"attribute vec3 aVertexPosition;            attribute vec2 aTextureCoord;            uniform mat4 projectionMatrix;            uniform mat4 viewMatrix;            uniform float height;            uniform vec3 cameraPosition;            uniform vec4 uGlobalTextureCoord;            uniform vec3 uNormalMapBias;            varying vec4 vTextureCoord;            varying float range;            varying vec2 vGlobalTextureCoord;            varying vec4 v_vertex;            varying float v_height;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main(void) {                v_height = height;                vec3 heightVertex = aVertexPosition + normalize(aVertexPosition) * height;                v_vertex = viewMatrix * vec4(heightVertex, 1.0);                range = distance(cameraPosition, heightVertex);                vTextureCoord.xy = aTextureCoord;                vGlobalTextureCoord = uGlobalTextureCoord.xy + (uGlobalTextureCoord.zw - uGlobalTextureCoord.xy) * aTextureCoord;                vTextureCoord.zw = uNormalMapBias.z * ( aTextureCoord + uNormalMapBias.xy );                gl_Position = projectionMatrix * v_vertex;                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;            }",fragmentShader:"#extension GL_EXT_draw_buffers : require\n            precision highp float;\n\n            #define MAX_POINT_LIGHTS 1\n            #define MAX_OVERLAYS 5\n            #define MAX_OVERLAYS_PLUS_ONE 6\n            uniform vec3 diffuseMaterial[MAX_OVERLAYS_PLUS_ONE];            uniform vec3 ambientMaterial[MAX_OVERLAYS_PLUS_ONE];            uniform vec4 specularMaterial[MAX_OVERLAYS_PLUS_ONE];            uniform sampler2D uNormalMap;            uniform vec4 lightsPositions[MAX_POINT_LIGHTS];            uniform mat3 normalMatrix;            uniform sampler2D nightTexture;            uniform sampler2D specularTexture;            uniform vec4 tileOffsetArr[MAX_OVERLAYS];            uniform vec4 visibleExtentOffsetArr[MAX_OVERLAYS];            uniform vec4 transparentColorArr[MAX_OVERLAYS];            uniform vec3 pickingColorArr[MAX_OVERLAYS];            uniform sampler2D defaultTexture;            uniform sampler2D samplerArr[MAX_OVERLAYS];            uniform sampler2D pickingMaskArr[MAX_OVERLAYS];            uniform int samplerCount;            varying vec4 vTextureCoord;            varying float range;            varying vec2 vGlobalTextureCoord;            varying vec4 v_vertex;            varying float v_height;            /* return 1 if v inside the box, return 0 otherwise */            float insideBox(vec2 v, vec2 bottomLeft, vec2 topRight) {                vec2 s = step(bottomLeft, v) - step(topRight, v);                return s.x * s.y;            }            vec3 encode24(highp float f) {                float F = abs(f);                float s = step( 0.0, -f );                float e = floor( log2(F) );                float m = exp2(- e) * F;                e = floor( log2(F) + 127.0 ) + floor( log2(m) );                return vec3(                    ( 128.0 * s + floor( e * exp2(-1.0) ) ) / 255.0,                    ( 128.0 * mod( e, 2.0 ) + mod( floor( m * 128.0 ), 128.0 ) ) / 255.0,                    floor( mod( floor( m * exp2( 23.0 - 8.0) ), exp2(8.0) ) ) / 255.0);            }            const vec2 BOTTOMLEFT = vec2(0.0);            const vec2 TOPRIGHT = vec2(1.0);            const vec3 nightStep = 10.0 * vec3(0.58, 0.48, 0.25);            void main(void) {                vec3 range24 = encode24(range);                float overGround = 1.0 - step(0.1, v_height);                vec3 normal = normalize(normalMatrix * ((texture2D(uNormalMap, vTextureCoord.zw).rgb - 0.5) * 2.0));                vec3 lightDirection = normalize(lightsPositions[0].xyz - v_vertex.xyz * lightsPositions[0].w);                vec3 eyeDirection = normalize(-v_vertex.xyz);                vec3 reflectionDirection = reflect(-lightDirection, normal);                vec4 nightImageColor = texture2D( nightTexture, vGlobalTextureCoord );                float shininess = texture2D( specularTexture, vGlobalTextureCoord ).r * 255.0 * overGround;                float reflection = max( dot(reflectionDirection, eyeDirection), 0.0);                float diffuseLightWeighting = max(dot(normal, lightDirection), 0.0);                vec3 night = nightStep * (0.3 - diffuseLightWeighting) * nightImageColor.rgb;                night *= overGround * step(0.0, night);                vec3 spec = specularMaterial[0].rgb * pow( reflection, specularMaterial[0].w) * shininess;                vec3 lightWeighting = ambientMaterial[0] + diffuseMaterial[0] * diffuseLightWeighting + spec;                vec4 t = texture2D( defaultTexture, vTextureCoord.xy );                gl_FragData[0] = vec4(t.rgb * lightWeighting + night + spec, t.a);                gl_FragData[1] = vec4(0.0);                gl_FragData[2] = vec4(range24, gl_FragData[0].a);                if( samplerCount == 0 ) return;                spec = specularMaterial[1].rgb * pow( reflection, specularMaterial[1].w) * (1.0 + shininess);                lightWeighting = ambientMaterial[1] + diffuseMaterial[1] * diffuseLightWeighting + spec;                vec2 tc = tileOffsetArr[0].xy + vTextureCoord.xy * tileOffsetArr[0].zw;                float ins = insideBox(visibleExtentOffsetArr[0].xy + vTextureCoord.xy * visibleExtentOffsetArr[0].zw, BOTTOMLEFT, TOPRIGHT);                t = texture2D( samplerArr[0], tc ) * ins;                vec4 p = texture2D( pickingMaskArr[0], tc ) * ins;                float emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[0].rgb ));                gl_FragData[0] = mix( gl_FragData[0], vec4(t.rgb * lightWeighting + night + spec, 1.0), transparentColorArr[0].a * t.a * emptiness);                emptiness = 1.0 - step(0.0, -emptiness);                gl_FragData[1] = vec4(max(pickingColorArr[0], p.rgb), emptiness);                gl_FragData[2] = mix( gl_FragData[2], vec4(range24, 1.0), emptiness);                if( samplerCount == 1 ) return;                spec = specularMaterial[2].rgb * pow( reflection, specularMaterial[2].w);                lightWeighting = ambientMaterial[2] + diffuseMaterial[2] * diffuseLightWeighting + spec;                tc = tileOffsetArr[1].xy + vTextureCoord.xy * tileOffsetArr[1].zw;                ins = insideBox(visibleExtentOffsetArr[1].xy + vTextureCoord.xy * visibleExtentOffsetArr[1].zw, BOTTOMLEFT, TOPRIGHT);                t = texture2D( samplerArr[1], tc ) * ins;                p = texture2D( pickingMaskArr[1], tc ) * ins;                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[1].rgb ));                gl_FragData[0] = mix( gl_FragData[0], vec4(t.rgb * lightWeighting + night + spec, 1.0), transparentColorArr[1].a * t.a * emptiness);                emptiness = 1.0 - step(0.0, -emptiness);                gl_FragData[1] = mix( gl_FragData[1], vec4(max(pickingColorArr[1], p.rgb), 1.0), emptiness);                gl_FragData[2] = mix( gl_FragData[2], vec4(range24, 1.0), emptiness);                if( samplerCount == 2 ) return;                spec = specularMaterial[3].rgb * pow( reflection, specularMaterial[3].w);                lightWeighting = ambientMaterial[3] + diffuseMaterial[3] * diffuseLightWeighting + spec;                tc = tileOffsetArr[2].xy + vTextureCoord.xy * tileOffsetArr[2].zw;                ins = insideBox(visibleExtentOffsetArr[2].xy + vTextureCoord.xy * visibleExtentOffsetArr[2].zw, BOTTOMLEFT, TOPRIGHT);                t = texture2D( samplerArr[2], tc ) * ins;                p = texture2D( pickingMaskArr[2], tc ) * ins;                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[2].rgb ));                gl_FragData[0] = mix( gl_FragData[0], vec4(t.rgb * lightWeighting + night + spec, 1.0), transparentColorArr[2].a * t.a * emptiness);                emptiness = 1.0 - step(0.0, -emptiness);                gl_FragData[1] = mix( gl_FragData[1], vec4(max(pickingColorArr[2], p.rgb), 1.0), emptiness);                gl_FragData[2] = mix( gl_FragData[2], vec4(range24, 1.0), emptiness);                if( samplerCount == 3 ) return;                spec = specularMaterial[4].rgb * pow( reflection, specularMaterial[4].w);                lightWeighting = ambientMaterial[4] + diffuseMaterial[4] * diffuseLightWeighting + spec;                tc = tileOffsetArr[3].xy + vTextureCoord.xy * tileOffsetArr[3].zw;                ins = insideBox(visibleExtentOffsetArr[3].xy + vTextureCoord.xy * visibleExtentOffsetArr[3].zw, BOTTOMLEFT, TOPRIGHT);                t = texture2D( samplerArr[3], tc ) * ins;                p = texture2D( pickingMaskArr[3], tc ) * ins;                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[3].rgb ));                gl_FragData[0] = mix( gl_FragData[0], vec4(t.rgb * lightWeighting + night + spec, 1.0), transparentColorArr[3].a * t.a * emptiness);                emptiness = 1.0 - step(0.0, -emptiness);                gl_FragData[1] = mix( gl_FragData[1], vec4(max(pickingColorArr[3], p.rgb), 1.0), emptiness);                gl_FragData[2] = mix( gl_FragData[2], vec4(range24, 1.0), emptiness);                if( samplerCount == 4 ) return;                spec = specularMaterial[5].rgb * pow( reflection, specularMaterial[5].w);                lightWeighting = ambientMaterial[5] + diffuseMaterial[5] * diffuseLightWeighting + spec;                tc = tileOffsetArr[4].xy + vTextureCoord.xy * tileOffsetArr[4].zw;                ins = insideBox(visibleExtentOffsetArr[4].xy + vTextureCoord.xy * visibleExtentOffsetArr[4].zw, BOTTOMLEFT, TOPRIGHT);                t = texture2D( samplerArr[4], tc ) * ins;                p = texture2D( pickingMaskArr[4], tc ) * ins;                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[4].rgb ));                gl_FragData[0] = mix( gl_FragData[0], vec4(t.rgb * lightWeighting + night + spec, 1.0), transparentColorArr[4].a * t.a * emptiness);                emptiness = 1.0 - step(0.0, -emptiness);                gl_FragData[1] = mix( gl_FragData[1], vec4(max(pickingColorArr[4], p.rgb), 1.0), emptiness);                gl_FragData[2] = mix( gl_FragData[2], vec4(range24, 1.0), emptiness);            }"}),!0),this._fnRendering=this._multiframebufferRendering):(e.addShaderProgram(new vi("drawnode_screen_nl",{uniforms:{projectionViewMatrix:{type:fi.MAT4},samplerCount:{type:fi.INT},tileOffsetArr:{type:fi.VEC4},visibleExtentOffsetArr:{type:fi.VEC4},samplerArr:{type:fi.SAMPLER2DXX},transparentColorArr:{type:fi.VEC4},defaultTexture:{type:fi.SAMPLER2D},height:{type:fi.FLOAT}},attributes:{aVertexPosition:{type:fi.VEC3,enableArray:!0},aTextureCoord:{type:fi.VEC2,enableArray:!0}},vertexShader:"attribute vec3 aVertexPosition;            attribute vec2 aTextureCoord;            uniform mat4 projectionViewMatrix;            uniform float height;            varying vec2 vTextureCoord;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main(void) {                vTextureCoord = aTextureCoord;                gl_Position = projectionViewMatrix * vec4(aVertexPosition + normalize(aVertexPosition) * height, 1.0);                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;            }",fragmentShader:"precision highp float;\n            uniform vec4 tileOffsetArr[5];            uniform vec4 visibleExtentOffsetArr[5];            uniform vec4 transparentColorArr[5];            uniform sampler2D defaultTexture;            uniform sampler2D samplerArr[5];            uniform int samplerCount;            varying vec2 vTextureCoord;            /* return 1 if v inside the box, return 0 otherwise */            float insideBox(vec2 v, vec2 bottomLeft, vec2 topRight) {                vec2 s = step(bottomLeft, v) - step(topRight, v);                return s.x * s.y;            }            const vec2 BOTTOMLEFT = vec2(0.0);            const vec2 TOPRIGHT = vec2(1.0);            void main(void) {                gl_FragColor = texture2D( defaultTexture, vTextureCoord );                if( samplerCount == 0 ) return;                vec4 t = texture2D( samplerArr[0], tileOffsetArr[0].xy + vTextureCoord * tileOffsetArr[0].zw ) * insideBox(visibleExtentOffsetArr[0].xy + vTextureCoord * visibleExtentOffsetArr[0].zw, BOTTOMLEFT, TOPRIGHT);                float emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[0].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(t.rgb, 1.0), transparentColorArr[0].a * t.a * emptiness);                if( samplerCount == 1 ) return;                t = texture2D( samplerArr[1], tileOffsetArr[1].xy + vTextureCoord * tileOffsetArr[1].zw ) * insideBox(visibleExtentOffsetArr[1].xy + vTextureCoord * visibleExtentOffsetArr[1].zw, BOTTOMLEFT, TOPRIGHT);                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[1].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(t.rgb, 1.0), transparentColorArr[1].a * t.a * emptiness);                if( samplerCount == 2 ) return;                t = texture2D( samplerArr[2], tileOffsetArr[2].xy + vTextureCoord * tileOffsetArr[2].zw ) * insideBox(visibleExtentOffsetArr[2].xy + vTextureCoord * visibleExtentOffsetArr[2].zw, BOTTOMLEFT, TOPRIGHT);                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[2].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(t.rgb, 1.0), transparentColorArr[2].a * t.a * emptiness);                if( samplerCount == 3 ) return;                t = texture2D( samplerArr[3], tileOffsetArr[3].xy + vTextureCoord * tileOffsetArr[3].zw ) * insideBox(visibleExtentOffsetArr[3].xy + vTextureCoord * visibleExtentOffsetArr[3].zw, BOTTOMLEFT, TOPRIGHT);                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[3].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(t.rgb, 1.0), transparentColorArr[3].a * t.a * emptiness);                if( samplerCount == 4 ) return;                t = texture2D( samplerArr[4], tileOffsetArr[4].xy + vTextureCoord * tileOffsetArr[4].zw ) * insideBox(visibleExtentOffsetArr[4].xy + vTextureCoord * visibleExtentOffsetArr[4].zw, BOTTOMLEFT, TOPRIGHT);                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[4].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(t.rgb, 1.0), transparentColorArr[4].a * t.a * emptiness);            }"}),!0),e.addShaderProgram(new vi("drawnode_screen_wl",{uniforms:{projectionMatrix:{type:fi.MAT4},viewMatrix:{type:fi.MAT4},samplerCount:{type:fi.INT},tileOffsetArr:{type:fi.VEC4},visibleExtentOffsetArr:{type:fi.VEC4},samplerArr:{type:fi.SAMPLER2DXX},transparentColorArr:{type:fi.VEC4},defaultTexture:{type:fi.SAMPLER2D},height:{type:fi.FLOAT},normalMatrix:{type:fi.MAT3},uNormalMap:{type:fi.SAMPLER2D},uNormalMapBias:{type:fi.VEC3},uGlobalTextureCoord:{type:fi.VEC4},nightTexture:{type:fi.SAMPLER2D},specularTexture:{type:fi.SAMPLER2D},lightsPositions:{type:fi.VEC4},diffuseMaterial:{type:fi.VEC3},ambientMaterial:{type:fi.VEC3},specularMaterial:{type:fi.VEC4}},attributes:{aVertexPosition:{type:fi.VEC3,enableArray:!0},aTextureCoord:{type:fi.VEC2,enableArray:!0}},vertexShader:"attribute vec3 aVertexPosition;            attribute vec2 aTextureCoord;            uniform mat4 projectionMatrix;            uniform mat4 viewMatrix;            uniform float height;            uniform vec4 uGlobalTextureCoord;            uniform vec3 uNormalMapBias;            varying vec4 vTextureCoord;            varying vec2 vGlobalTextureCoord;            varying vec4 v_vertex;            varying float v_height;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main(void) {                v_height = height;                vec3 heightVertex = aVertexPosition + normalize(aVertexPosition) * height;                v_vertex = viewMatrix * vec4(heightVertex, 1.0);                vTextureCoord.xy = aTextureCoord;                vGlobalTextureCoord = uGlobalTextureCoord.xy + (uGlobalTextureCoord.zw - uGlobalTextureCoord.xy) * aTextureCoord;                vTextureCoord.zw = uNormalMapBias.z * ( aTextureCoord + uNormalMapBias.xy );                gl_Position = projectionMatrix * v_vertex;                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;            }",fragmentShader:"precision highp float;\n\n            #define MAX_POINT_LIGHTS 1\n            #define MAX_OVERLAYS 5\n            #define MAX_OVERLAYS_PLUS_ONE 6\n            uniform vec3 diffuseMaterial[MAX_OVERLAYS_PLUS_ONE];            uniform vec3 ambientMaterial[MAX_OVERLAYS_PLUS_ONE];            uniform vec4 specularMaterial[MAX_OVERLAYS_PLUS_ONE];            uniform sampler2D uNormalMap;            uniform vec4 lightsPositions[MAX_POINT_LIGHTS];            uniform mat3 normalMatrix;            uniform sampler2D nightTexture;            uniform sampler2D specularTexture;            uniform vec4 tileOffsetArr[MAX_OVERLAYS];            uniform vec4 visibleExtentOffsetArr[MAX_OVERLAYS];            uniform vec4 transparentColorArr[MAX_OVERLAYS];            uniform sampler2D defaultTexture;            uniform sampler2D samplerArr[MAX_OVERLAYS];            uniform int samplerCount;            varying vec4 vTextureCoord;            varying vec2 vGlobalTextureCoord;            varying vec4 v_vertex;            varying float v_height;            /* return 1 if v inside the box, return 0 otherwise */            float insideBox(vec2 v, vec2 bottomLeft, vec2 topRight) {                vec2 s = step(bottomLeft, v) - step(topRight, v);                return s.x * s.y;            }            const vec2 BOTTOMLEFT = vec2(0.0);            const vec2 TOPRIGHT = vec2(1.0);            const vec3 nightStep = 10.0 * vec3(0.58, 0.48, 0.25);            void main(void) {                float overGround = 1.0 - step(0.1, v_height);                vec3 normal = normalize(normalMatrix * ((texture2D(uNormalMap, vTextureCoord.zw).rgb - 0.5) * 2.0));                vec3 lightDirection = normalize(lightsPositions[0].xyz - v_vertex.xyz * lightsPositions[0].w);                vec3 eyeDirection = normalize(-v_vertex.xyz);                vec3 reflectionDirection = reflect(-lightDirection, normal);                vec4 nightImageColor = texture2D( nightTexture, vGlobalTextureCoord.st );                float shininess = texture2D( specularTexture, vGlobalTextureCoord.st ).r * 255.0 * overGround;                float reflection = max( dot(reflectionDirection, eyeDirection), 0.0);                float diffuseLightWeighting = max(dot(normal, lightDirection), 0.0);                vec3 night = nightStep * (0.3 - diffuseLightWeighting) * nightImageColor.rgb;                night *= overGround * step(0.0, night);                vec3 spec = specularMaterial[0].rgb * pow( reflection, specularMaterial[0].w) * shininess;                vec3 lightWeighting = ambientMaterial[0] + diffuseMaterial[0] * diffuseLightWeighting + spec;                vec4 t = texture2D( defaultTexture, vTextureCoord.xy );                gl_FragColor = vec4(t.rgb * lightWeighting + night + spec, t.a);                if( samplerCount == 0 ) return;                spec = specularMaterial[1].rgb * pow( reflection, specularMaterial[1].w) * (1.0 + shininess);                lightWeighting = ambientMaterial[1] + diffuseMaterial[1] * diffuseLightWeighting + spec;                t = texture2D( samplerArr[0], tileOffsetArr[0].xy + vTextureCoord.xy * tileOffsetArr[0].zw ) * insideBox(visibleExtentOffsetArr[0].xy + vTextureCoord.xy * visibleExtentOffsetArr[0].zw, BOTTOMLEFT, TOPRIGHT);                float emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[0].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(t.rgb * lightWeighting + night + spec, 1.0), transparentColorArr[0].a * t.a * emptiness);                if( samplerCount == 1 ) return;                spec = specularMaterial[2].rgb * pow( reflection, specularMaterial[2].w);                lightWeighting = ambientMaterial[2] + diffuseMaterial[2] * diffuseLightWeighting + spec;                t = texture2D( samplerArr[1], tileOffsetArr[1].xy + vTextureCoord.xy * tileOffsetArr[1].zw ) * insideBox(visibleExtentOffsetArr[1].xy + vTextureCoord.xy * visibleExtentOffsetArr[1].zw, BOTTOMLEFT, TOPRIGHT);                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[1].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(t.rgb * lightWeighting + night + spec, 1.0), transparentColorArr[1].a * t.a * emptiness);                if( samplerCount == 2 ) return;                spec = specularMaterial[3].rgb * pow( reflection, specularMaterial[3].w);                lightWeighting = ambientMaterial[3] + diffuseMaterial[3] * diffuseLightWeighting + spec;                t = texture2D( samplerArr[2], tileOffsetArr[2].xy + vTextureCoord.xy * tileOffsetArr[2].zw ) * insideBox(visibleExtentOffsetArr[2].xy + vTextureCoord.xy * visibleExtentOffsetArr[2].zw, BOTTOMLEFT, TOPRIGHT);                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[2].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(t.rgb * lightWeighting + night + spec, 1.0), transparentColorArr[2].a * t.a * emptiness);                if( samplerCount == 3 ) return;                spec = specularMaterial[4].rgb * pow( reflection, specularMaterial[4].w);                lightWeighting = ambientMaterial[4] + diffuseMaterial[4] * diffuseLightWeighting + spec;                t = texture2D( samplerArr[3], tileOffsetArr[3].xy + vTextureCoord.xy * tileOffsetArr[3].zw ) * insideBox(visibleExtentOffsetArr[3].xy + vTextureCoord.xy * visibleExtentOffsetArr[3].zw, BOTTOMLEFT, TOPRIGHT);                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[3].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(t.rgb * lightWeighting + night + spec, 1.0), transparentColorArr[3].a * t.a * emptiness);                if( samplerCount == 4 ) return;                spec = specularMaterial[5].rgb * pow( reflection, specularMaterial[5].w);                lightWeighting = ambientMaterial[5] + diffuseMaterial[5] * diffuseLightWeighting + spec;                t = texture2D( samplerArr[4], tileOffsetArr[4].xy + vTextureCoord.xy * tileOffsetArr[4].zw ) * insideBox(visibleExtentOffsetArr[4].xy + vTextureCoord.xy * visibleExtentOffsetArr[4].zw, BOTTOMLEFT, TOPRIGHT);                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[4].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(t.rgb * lightWeighting + night + spec, 1.0), transparentColorArr[4].a * t.a * emptiness);            }"}),!0),e.addShaderProgram(new vi("drawnode_colorPicking",{uniforms:{projectionViewMatrix:{type:fi.MAT4},samplerCount:{type:fi.INT},tileOffsetArr:{type:fi.VEC4},visibleExtentOffsetArr:{type:fi.VEC4},samplerArr:{type:fi.SAMPLER2DXX},pickingMaskArr:{type:fi.SAMPLER2DXX},transparentColorArr:{type:fi.VEC4},pickingColorArr:{type:fi.VEC3},height:{type:fi.FLOAT}},attributes:{aVertexPosition:{type:fi.VEC3,enableArray:!0},aTextureCoord:{type:fi.VEC2,enableArray:!0}},vertexShader:"attribute vec3 aVertexPosition;            attribute vec2 aTextureCoord;            uniform mat4 projectionViewMatrix;            uniform float height;            varying vec2 vTextureCoord;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main(void) {                vTextureCoord = aTextureCoord;                gl_Position = projectionViewMatrix * vec4(aVertexPosition + normalize(aVertexPosition) * height, 1.0);                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;            }",fragmentShader:"precision highp float;\n            uniform vec4 tileOffsetArr[5];            uniform vec4 visibleExtentOffsetArr[5];            uniform vec4 transparentColorArr[5];            uniform vec3 pickingColorArr[5];            uniform sampler2D samplerArr[5];            uniform sampler2D pickingMaskArr[5];            uniform int samplerCount;            varying vec2 vTextureCoord;            /* return 1 if v inside the box, return 0 otherwise */            float insideBox(vec2 v, vec2 bottomLeft, vec2 topRight) {                vec2 s = step(bottomLeft, v) - step(topRight, v);                return s.x * s.y;            }            const vec2 BOTTOMLEFT = vec2(0.0);            const vec2 TOPRIGHT = vec2(1.0);            void main(void) {                gl_FragColor = vec4(0.0);                if( samplerCount == 0 ) return;                vec2 tc = tileOffsetArr[0].xy + vTextureCoord.xy * tileOffsetArr[0].zw;                float ins = insideBox(visibleExtentOffsetArr[0].xy + vTextureCoord.xy * visibleExtentOffsetArr[0].zw, BOTTOMLEFT, TOPRIGHT);                vec4 t = texture2D( samplerArr[0], tc ) * ins;                vec4 p = texture2D( pickingMaskArr[0], tc ) * ins;                float emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[0].rgb ));                gl_FragColor = vec4(max(pickingColorArr[0], p.rgb), 1.0 - step(0.0, -emptiness));                if( samplerCount == 1 ) return;                tc = tileOffsetArr[1].xy + vTextureCoord.xy * tileOffsetArr[1].zw;                ins = insideBox(visibleExtentOffsetArr[1].xy + vTextureCoord.xy * visibleExtentOffsetArr[1].zw, BOTTOMLEFT, TOPRIGHT);                t = texture2D( samplerArr[1], tc ) * ins;                p = texture2D( pickingMaskArr[1], tc ) * ins;                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[1].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(max(pickingColorArr[1], p.rgb), 1.0), 1.0 - step(0.0, -emptiness));                if( samplerCount == 2 ) return;                tc = tileOffsetArr[2].xy + vTextureCoord.xy * tileOffsetArr[2].zw;                ins = insideBox(visibleExtentOffsetArr[2].xy + vTextureCoord.xy * visibleExtentOffsetArr[2].zw, BOTTOMLEFT, TOPRIGHT);                t = texture2D( samplerArr[2], tc ) * ins;                p = texture2D( pickingMaskArr[2], tc ) * ins;                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[2].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(max(pickingColorArr[2], p.rgb), 1.0), 1.0 - step(0.0, -emptiness));                if( samplerCount == 3 ) return;                tc = tileOffsetArr[3].xy + vTextureCoord.xy * tileOffsetArr[3].zw;                ins = insideBox(visibleExtentOffsetArr[3].xy + vTextureCoord.xy * visibleExtentOffsetArr[3].zw, BOTTOMLEFT, TOPRIGHT);                t = texture2D( samplerArr[3], tc ) * ins;                p = texture2D( pickingMaskArr[3], tc ) * ins;                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[3].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(max(pickingColorArr[3], p.rgb), 1.0), 1.0 - step(0.0, -emptiness));                if( samplerCount == 4 ) return;                tc = tileOffsetArr[4].xy + vTextureCoord.xy * tileOffsetArr[4].zw;                ins = insideBox(visibleExtentOffsetArr[4].xy + vTextureCoord.xy * visibleExtentOffsetArr[4].zw, BOTTOMLEFT, TOPRIGHT);                t = texture2D( samplerArr[4], tc ) * ins;                p = texture2D( pickingMaskArr[4], tc ) * ins;                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[4].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(max(pickingColorArr[4], p.rgb), 1.0), 1.0 - step(0.0, -emptiness));            }"}),!0),e.addShaderProgram(new vi("drawnode_heightPicking",{uniforms:{projectionViewMatrix:{type:fi.MAT4},samplerCount:{type:fi.INT},tileOffsetArr:{type:fi.VEC4},visibleExtentOffsetArr:{type:fi.VEC4},samplerArr:{type:fi.SAMPLER2DXX},transparentColorArr:{type:fi.VEC4},defaultTexture:{type:fi.SAMPLER2D},height:{type:fi.FLOAT},cameraPosition:{type:fi.VEC3}},attributes:{aVertexPosition:{type:fi.VEC3,enableArray:!0},aTextureCoord:{type:fi.VEC2,enableArray:!0}},vertexShader:"attribute vec3 aVertexPosition;            attribute vec2 aTextureCoord;            uniform mat4 projectionViewMatrix;            uniform float height;            uniform vec3 cameraPosition;            varying vec2 vTextureCoord;            varying float range;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main(void) {                range = distance(cameraPosition, aVertexPosition + normalize(aVertexPosition) * height);                vTextureCoord = aTextureCoord;                gl_Position = projectionViewMatrix * vec4(aVertexPosition + normalize(aVertexPosition) * height, 1.0);                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;            }",fragmentShader:"precision highp float;\n            uniform sampler2D defaultTexture;            uniform vec4 tileOffsetArr[5];            uniform vec4 visibleExtentOffsetArr[5];            uniform vec4 transparentColorArr[5];            uniform sampler2D samplerArr[5];            uniform int samplerCount;            varying vec2 vTextureCoord;            varying float range;            const float oneBy255 = 1.0 / 255.0;            /* return 1 if v inside the box, return 0 otherwise */            float insideBox(vec2 v, vec2 bottomLeft, vec2 topRight) {                vec2 s = step(bottomLeft, v) - step(topRight, v);                return s.x * s.y;            }            vec3 encode24(highp float f) {                float F = abs(f);                float s = step( 0.0, -f );                float e = floor( log2(F) );                float m = exp2(- e) * F;                e = floor( log2(F) + 127.0 ) + floor( log2(m) );                return vec3(                    ( 128.0 * s + floor( e * exp2(-1.0) ) ) / 255.0,                    ( 128.0 * mod( e, 2.0 ) + mod( floor( m * 128.0 ), 128.0 ) ) / 255.0,                    floor( mod( floor( m * exp2( 23.0 - 8.0) ), exp2(8.0) ) ) / 255.0);            }            const vec2 BOTTOMLEFT = vec2(0.0);            const vec2 TOPRIGHT = vec2(1.0);            void main(void) {                gl_FragColor = vec4(encode24(range), texture2D( defaultTexture, vTextureCoord ).a);                if( samplerCount == 0 ) return;                vec4 t = texture2D( samplerArr[0], tileOffsetArr[0].xy + vTextureCoord * tileOffsetArr[0].zw ) * insideBox(visibleExtentOffsetArr[0].xy + vTextureCoord * visibleExtentOffsetArr[0].zw, BOTTOMLEFT, TOPRIGHT);                float emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[0].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(encode24(range), 1.0), 1.0 - step(0.0, -emptiness));                if( samplerCount == 1 ) return;                t = texture2D( samplerArr[1], tileOffsetArr[1].xy + vTextureCoord * tileOffsetArr[1].zw ) * insideBox(visibleExtentOffsetArr[1].xy + vTextureCoord * visibleExtentOffsetArr[1].zw, BOTTOMLEFT, TOPRIGHT);                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[1].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(encode24(range), 1.0), 1.0 - step(0.0, -emptiness));                if( samplerCount == 2 ) return;                t = texture2D( samplerArr[2], tileOffsetArr[2].xy + vTextureCoord * tileOffsetArr[2].zw ) * insideBox(visibleExtentOffsetArr[2].xy + vTextureCoord * visibleExtentOffsetArr[2].zw, BOTTOMLEFT, TOPRIGHT);                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[2].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(encode24(range), 1.0), 1.0 - step(0.0, -emptiness));                if( samplerCount == 3 ) return;                t = texture2D( samplerArr[3], tileOffsetArr[3].xy + vTextureCoord * tileOffsetArr[3].zw ) * insideBox(visibleExtentOffsetArr[3].xy + vTextureCoord * visibleExtentOffsetArr[3].zw, BOTTOMLEFT, TOPRIGHT);                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[3].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(encode24(range), 1.0), 1.0 - step(0.0, -emptiness));                if( samplerCount == 4 ) return;                t = texture2D( samplerArr[4], tileOffsetArr[4].xy + vTextureCoord * tileOffsetArr[4].zw ) * insideBox(visibleExtentOffsetArr[4].xy + vTextureCoord * visibleExtentOffsetArr[4].zw, BOTTOMLEFT, TOPRIGHT);                emptiness = t.a * smoothstep(0.35, 0.5, distance( t.rgb, transparentColorArr[4].rgb ));                gl_FragColor = mix( gl_FragColor, vec4(encode24(range), 1.0), 1.0 - step(0.0, -emptiness));            }"}),!0),this._fnRendering=this._singleframebufferRendering,this.renderer.addPickingCallback(this,this._renderColorPickingFramebufferPASS),this._heightPickingFramebuffer=new Gi(this.renderer.handler,{width:320,height:240}),this._heightPickingFramebuffer.init())}initialization(){for(var e=Mi,t=0;t<=e;t++){var i=Math.pow(2,t);!this._indexesCache[i]&&(this._indexesCache[i]=[]);for(var r=0;r<=e;r++){var s=Math.pow(2,r);!this._indexesCache[i][s]&&(this._indexesCache[i][s]=[]);for(var n=0;n<=e;n++){var a=Math.pow(2,n);!this._indexesCache[i][s][a]&&(this._indexesCache[i][s][a]=[]);for(var o=0;o<=e;o++){var h=Math.pow(2,o);!this._indexesCache[i][s][a][h]&&(this._indexesCache[i][s][a][h]=[]);for(var l=0;l<=e;l++){var u=Math.pow(2,l),d=Ri(i,[s,a,h,u]),c=null;i===s&&i===a&&i===h&&i===u&&(c=this.renderer.handler.createElementArrayBuffer(d,1)),this._indexesCache[i][s][a][h][u]={indexes:d,buffer:c}}}}}}var _=this;if(this.renderer.handler.createDefaultTexture(null,function(e){_.solidTextureOne=e,_.solidTextureTwo=e}),this.transparentTexture=this.renderer.handler.transparentTexture,this.camera=this.renderer.activeCamera=new Ys(this,{eye:new Ge(0,0,28e6),look:new Ge(0,0,0),up:new Ge(0,1,0)}),this._quadTree=new ks(sn,this,gi,null,0,0,Oe.createFromArray([-20037508.34,-20037508.34,20037508.34,20037508.34])),this._quadTreeNorth=new ks(an,this,gi,null,0,0,Oe.createFromArray([-180,ze,180,90])),this._quadTreeSouth=new ks(an,this,gi,null,0,0,Oe.createFromArray([-180,-90,180,ke])),this.drawMode=this.renderer.handler.gl.TRIANGLE_STRIP,this._initializeShaders(),this.updateVisibleLayers(),this.renderer.activeCamera.events.on("viewchange",function(e){this._viewChanged=!0},this),this.renderer.events.on("mousemove",function(e){this._viewChanged=!0},this),this.renderer.events.on("touchmove",function(e){this._viewChanged=!0},this),this.renderer.addPickingCallback(this,this._frustumEntityCollectionPickingCallback),this._useNightTexture){var f=new Image;f.crossOrigin="",f.onload=function(){_._nightTexture=_.renderer.handler.createTexture_mm(this)},f.src=cn+"night.png"}if(this._useSpecularTexture){var p=new Image;p.crossOrigin="",p.onload=function(){_._specularTexture=_.renderer.handler.createTexture_l(this)},p.src=cn+"spec.png"}this._geoImageCreator=new Xi(this.renderer.handler),this._vectorTileCreator=new ln(this),this._normalMapCreator=new Vs(this),this._preRender()}_preRender(){this._quadTree.traverseNodes(),this._quadTree.renderNode(),this._normalMapCreator.drawSingle(this._quadTree.segment),this._quadTreeNorth.traverseNodes(),this._quadTreeNorth.renderNode(),this._quadTreeSouth.traverseNodes(),this._quadTreeSouth.renderNode()}createDefaultTextures(e,t){this.renderer.handler.gl.deleteTexture(this.solidTextureOne),this.renderer.handler.gl.deleteTexture(this.solidTextureTwo);var i=this;this.renderer.handler.createDefaultTexture(e,function(e){i.solidTextureOne=e}),this.renderer.handler.createDefaultTexture(t,function(e){i.solidTextureTwo=e})}updateAttributionsList(){for(var e="",t=0;t<this.layers.length;t++){var i=this.layers[t];i._visibility&&i._attribution.length&&(e+="<li>"+i._attribution+"</li>")}this.renderer&&(e.length?(this.renderer.div.attributions.style.display="block",this.renderer.div.attributions.innerHTML="<ul>"+e+"</ul>"):(this.renderer.div.attributions.style.display="none",this.renderer.div.attributions.innerHTML=""))}updateVisibleLayers(){this.visibleTileLayers=[],this.visibleTileLayers.length=0,this.visibleVectorLayers=[],this.visibleVectorLayers.length=0;for(var e="",t=0;t<this.layers.length;t++){var i=this.layers[t];i._visibility&&(i._isBaseLayer&&(this.baseLayer=i),i.hasImageryTiles()&&this.visibleTileLayers.push(i),i.isVector&&this.visibleVectorLayers.push(i),i._attribution.length&&(e+="<li>"+i._attribution+"</li>"))}this.renderer&&(e.length?(this.renderer.div.attributions.style.display="block",this.renderer.div.attributions.innerHTML="<ul>"+e+"</ul>"):(this.renderer.div.attributions.style.display="none",this.renderer.div.attributions.innerHTML="")),this._sortLayers()}_sortLayers(){if(this.visibleVectorLayers.sort(function(e,t){return e._zIndex-t._zIndex||e._height-t._height}),this.visibleTileLayers.length){this.visibleTileLayers.sort(function(e,t){return e._height-t._height||e._zIndex-t._zIndex}),this._visibleTileLayerSlices=[],this._visibleTileLayerSlices.length=0;for(var e=-1,t=this.visibleTileLayers[0]._height,i=0;i<this.visibleTileLayers.length;i++)i%this.SLICE_SIZE!=0&&this.visibleTileLayers[i]._height===t||(e++,this._visibleTileLayerSlices[e]=[],t=this.visibleTileLayers[i]._height),this._visibleTileLayerSlices[e].push(this.visibleTileLayers[i])}}_collectRenderNodes(){if(this._renderedNodes.length=0,this._renderedNodes=[],this._viewExtentWGS84=null,this._viewExtentMerc=null,this._visibleNodes={},this._visibleNodesNorth={},this._visibleNodesSouth={},this._frustumEntityCollections.length=0,this._frustumEntityCollections=[],this.minCurrZoom=C,this.maxCurrZoom=b,this._quadTreeNorth.renderTree(),this._quadTreeSouth.renderTree(),this._quadTree.renderTree(),this.renderer.activeCamera.slope>.72&&this.renderer.activeCamera._lonLat.height<85e4){this.minCurrZoom=this.maxCurrZoom;var e=this._renderedNodes;this._renderedNodes=[];for(var t=0;t<e.length;t++){var i=e[t];i.segment.tileZoom===this.maxCurrZoom&&this._renderedNodes.push(i)}for(t=0;t<e.length;t++){var r=e[t].segment;r._projection.id===Wi.id&&r.tileZoom<this.maxCurrZoom&&r.node.renderTree(this.maxCurrZoom)}}}frame(){this._collectRenderNodes(),this.events.dispatch(this.events.draw,this),this.renderer.activeCamera.prepareFrame(),this.transformLights(),this._normalMapCreator.frame(),this._fnRendering(),this._geoImageCreator.frame(),this._createdNodesCount>_n&&this.memClear()}_multiframebufferRendering(){this._multiRenderNodesPASS(),this._renderVectorLayersPASS()}_singleframebufferRendering(){this._renderScreenNodesPASS(),this._renderHeightPickingFramebufferPASS(),this._renderVectorLayersPASS()}_renderScreenNodesPASS(){var e,t=this.renderer,i=t.handler,r=i.gl;if(r.blendEquation(r.FUNC_ADD),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.enable(r.BLEND),this.lightEnabled){i.shaderPrograms.drawnode_screen_wl.activate(),e=i.shaderPrograms.drawnode_screen_wl._program,shu=e.uniforms,r.uniform4fv(shu.lightsPositions._pName,this._lightsTransformedPositions),r.uniformMatrix3fv(shu.normalMatrix._pName,!1,t.activeCamera._normalMatrix._m),r.uniformMatrix4fv(shu.viewMatrix._pName,!1,t.activeCamera._viewMatrix._m),r.uniformMatrix4fv(shu.projectionMatrix._pName,!1,t.activeCamera._projectionMatrix._m),r.activeTexture(r.TEXTURE0+this.SLICE_SIZE),r.bindTexture(r.TEXTURE_2D,this.camera._lonLat.height>329958&&(this._nightTexture||this.transparentTexture)||this.transparentTexture),r.uniform1i(shu.nightTexture._pName,this.SLICE_SIZE),r.activeTexture(r.TEXTURE0+this.SLICE_SIZE+1),r.bindTexture(r.TEXTURE_2D,this._specularTexture||this.transparentTexture),r.uniform1i(shu.specularTexture._pName,this.SLICE_SIZE+1);var s=this.baseLayer;s?(this._diffuseMaterialArr[0]=s.diffuse.x,this._diffuseMaterialArr[1]=s.diffuse.y,this._diffuseMaterialArr[2]=s.diffuse.z,this._ambientMaterialArr[0]=s.ambient.x,this._ambientMaterialArr[1]=s.ambient.y,this._ambientMaterialArr[2]=s.ambient.z,this._specularMaterialArr[0]=s.specular.x,this._specularMaterialArr[1]=s.specular.y,this._specularMaterialArr[2]=s.specular.z,this._specularMaterialArr[3]=s.shininess):(this._diffuseMaterialArr[0]=.89,this._diffuseMaterialArr[1]=.9,this._diffuseMaterialArr[2]=.83,this._ambientMaterialArr[0]=0,this._ambientMaterialArr[1]=0,this._ambientMaterialArr[2]=0,this._specularMaterialArr[0]=3e-4,this._specularMaterialArr[1]=12e-5,this._specularMaterialArr[2]=1e-5,this._specularMaterialArr[3]=20)}else i.shaderPrograms.drawnode_screen_nl.activate(),e=i.shaderPrograms.drawnode_screen_nl._program,r.uniformMatrix4fv(e.uniforms.projectionViewMatrix._pName,!1,t.activeCamera._projectionViewMatrix._m);for(var n=this._renderedNodes,a=this._visibleTileLayerSlices,o=n.length;o--;)n[o].segment._screenRendering(e,a[0],0);for(r.enable(r.POLYGON_OFFSET_FILL),j=1;j<a.length;j++)for(o=n.length,r.polygonOffset(0,-j);o--;)n[o].segment._screenRendering(e,a[j],j,this.transparentTexture,!0);r.disable(r.POLYGON_OFFSET_FILL),r.disable(r.BLEND)}_renderHeightPickingFramebufferPASS(){var e;this._heightPickingFramebuffer.activate();var t=this.renderer,i=t.handler,r=i.gl;r.clearColor(0,0,0,1),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.enable(r.CULL_FACE),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.enable(r.BLEND),i.shaderPrograms.drawnode_heightPicking.activate(),e=i.shaderPrograms.drawnode_heightPicking._program,r.uniformMatrix4fv(e.uniforms.projectionViewMatrix._pName,!1,t.activeCamera._projectionViewMatrix._m),i.gl.uniform3fv(e.uniforms.cameraPosition._pName,t.activeCamera.eye.toVec());for(var s=this._renderedNodes,n=this._visibleTileLayerSlices,a=s.length;a--;)s[a].segment._heightPickingRendering(e,n[0],0);for(r.enable(r.POLYGON_OFFSET_FILL),j=1;j<n.length;j++)for(a=s.length,r.polygonOffset(0,-j);a--;)s[a].segment._heightPickingRendering(e,n[j],j,this.transparentTexture,!0);r.disable(r.POLYGON_OFFSET_FILL),r.disable(r.BLEND),this._heightPickingFramebuffer.deactivate()}_renderColorPickingFramebufferPASS(){var e,t=this.renderer,i=t.handler,r=i.gl;r.blendEquation(r.FUNC_ADD),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.enable(r.BLEND),r.enable(r.POLYGON_OFFSET_FILL),r.polygonOffset(0,-637e3),i.shaderPrograms.drawnode_colorPicking.activate(),e=i.shaderPrograms.drawnode_colorPicking._program,r.uniformMatrix4fv(e.uniforms.projectionViewMatrix._pName,!1,t.activeCamera._projectionViewMatrix._m);for(var s=this._renderedNodes,n=this._visibleTileLayerSlices,a=s.length;a--;)s[a].segment._colorPickingRendering(e,n[0],0);for(r.enable(r.POLYGON_OFFSET_FILL),j=1;j<n.length;j++)for(a=s.length,r.polygonOffset(0,-637e3-j);a--;)s[a].segment._colorPickingRendering(e,n[j],j,this.transparentTexture,!0);r.disable(r.POLYGON_OFFSET_FILL),r.disable(r.BLEND)}_multiRenderNodesPASS(){var e,t,i=this.renderer,r=i.handler,s=r.gl;if(s.blendEquation(s.FUNC_ADD),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),s.enable(s.BLEND),this.lightEnabled){r.shaderPrograms.drawnode_wl.activate(),t=(e=r.shaderPrograms.drawnode_wl._program).uniforms,s.uniform4fv(t.lightsPositions._pName,this._lightsTransformedPositions),s.uniformMatrix3fv(t.normalMatrix._pName,!1,i.activeCamera._normalMatrix._m),s.uniformMatrix4fv(t.viewMatrix._pName,!1,i.activeCamera._viewMatrix._m),s.uniformMatrix4fv(t.projectionMatrix._pName,!1,i.activeCamera._projectionMatrix._m),s.activeTexture(s.TEXTURE0+2*this.SLICE_SIZE),s.bindTexture(s.TEXTURE_2D,this.camera._lonLat.height>329958&&(this._nightTexture||this.transparentTexture)||this.transparentTexture),s.uniform1i(t.nightTexture._pName,2*this.SLICE_SIZE),s.activeTexture(s.TEXTURE0+2*this.SLICE_SIZE+1),s.bindTexture(s.TEXTURE_2D,this._specularTexture||this.transparentTexture),s.uniform1i(t.specularTexture._pName,2*this.SLICE_SIZE+1);var n=this.baseLayer;n?(this._diffuseMaterialArr[0]=n.diffuse.x,this._diffuseMaterialArr[1]=n.diffuse.y,this._diffuseMaterialArr[2]=n.diffuse.z,this._ambientMaterialArr[0]=n.ambient.x,this._ambientMaterialArr[1]=n.ambient.y,this._ambientMaterialArr[2]=n.ambient.z,this._specularMaterialArr[0]=n.specular.x,this._specularMaterialArr[1]=n.specular.y,this._specularMaterialArr[2]=n.specular.z,this._specularMaterialArr[3]=n.shininess):(this._diffuseMaterialArr[0]=.89,this._diffuseMaterialArr[1]=.9,this._diffuseMaterialArr[2]=.83,this._ambientMaterialArr[0]=0,this._ambientMaterialArr[1]=0,this._ambientMaterialArr[2]=0,this._specularMaterialArr[0]=3e-4,this._specularMaterialArr[1]=12e-5,this._specularMaterialArr[2]=1e-5,this._specularMaterialArr[3]=20)}else r.shaderPrograms.drawnode_nl.activate(),e=r.shaderPrograms.drawnode_nl._program,s.uniformMatrix4fv(e.uniforms.projectionViewMatrix._pName,!1,i.activeCamera._projectionViewMatrix._m);r.gl.uniform3fv(e.uniforms.cameraPosition._pName,i.activeCamera.eye.toVec());for(var a=this._renderedNodes,o=this._visibleTileLayerSlices,h=a.length;h--;)a[h].segment._multiRendering(e,o[0]);s.enable(s.POLYGON_OFFSET_FILL);for(let t=1;t<o.length;t++)for(h=a.length,s.polygonOffset(0,-t);h--;)a[h].segment._multiRendering(e,o[t],this.transparentTexture,!0);s.disable(s.POLYGON_OFFSET_FILL),s.disable(s.BLEND)}_renderVectorLayersPASS(){for(var e=this.visibleVectorLayers.length;e--;)this.visibleVectorLayers[e].update();this.drawEntityCollections(this._frustumEntityCollections),this._vectorTileCreator.frame()}_frustumEntityCollectionPickingCallback(){this.drawPickingEntityCollections(this._frustumEntityCollections)}memClear(){this.layerLock.lock(this._memKey),this.terrainLock.lock(this._memKey),this._normalMapCreator.lock(this._memKey),this._normalMapCreator.clear(),this.terrain.abortLoading();var e=this;setTimeout(function(){e._quadTree.clearTree(),e._quadTreeNorth.clearTree(),e._quadTreeSouth.clearTree(),e.layerLock.free(e._memKey),e.terrainLock.free(e._memKey),e._normalMapCreator.free(e._memKey)},0),this._createdNodesCount=0}getRayIntersectionEllipsoid(e){return this.ellipsoid.hitRay(e.origin,e.direction)}getCartesianFromPixelEllipsoid(e){var t=this.renderer.activeCamera;return this.ellipsoid.hitRay(t.eye,t.unproject(e.x,e.y))}getLonLatFromPixelEllipsoid(e){var t=this.getCartesianFromPixelEllipsoid(e);return t?this.ellipsoid.cartesianToLonLat(t):null}getCartesianFromMouseTerrain(e){var t=this.renderer.events.mouseState,i=this.getDistanceFromPixel(t,e);return i?t.direction.scaleTo(i).addA(this.renderer.activeCamera.eye):null}getCartesianFromPixelTerrain(e,t){var i=this.getDistanceFromPixel(e,t);return i?this.renderer.activeCamera.unproject(e.x,e.y).scaleTo(i).addA(this.renderer.activeCamera.eye):null}getLonLatFromPixelTerrain(e,t){var i=this.getCartesianFromPixelTerrain(e,t);return i?this.ellipsoid.cartesianToLonLat(i):null}getPixelFromCartesian(e){return this.renderer.activeCamera.project(e)}getPixelFromLonLat(e){var t=this.ellipsoid.lonLatToCartesian(e);return t?this.renderer.activeCamera.project(t):null}getDistanceFromPixelEllipsoid(e){var t=this.getCartesianFromPixelEllipsoid(e);return t?t.distance(this.renderer.activeCamera.eye):null}getDistanceFromPixel(e,t){if(this._viewChanged||t){this._viewChanged=!1;var i=this.renderer.handler.canvas,r=this.renderer._drawBuffersExtension&&Ve.fromVec(this.renderer.sceneFramebuffer.readPixel(e.x/i.width,(i.height-e.y)/i.height,2))||Ve.fromVec(this._heightPickingFramebuffer.readPixel(e.x/i.width,(i.height-e.y)/i.height));return r.x|r.y|r.z?(r.w=0,this._currentDistanceFromPixel=(n=1-2*_e(128,(s=r).x),a=2*de(s.x,128)+_e(128,s.y)-127,o=65536*de(s.y,128)+256*s.z+s.w+8388608,n*ve(a)*(1.1920928955078125e-7*o)),this._currentDistanceFromPixel):this._currentDistanceFromPixel=this.getDistanceFromPixelEllipsoid(e)}var s,n,a,o;return this._currentDistanceFromPixel}viewExtent(e){this.renderer.activeCamera.viewExtent(e)}viewExtentArr(e){this.renderer.activeCamera.viewExtent(new Oe(new De(e[0],e[1]),new De(e[2],e[3])))}getViewExtent(){if(this._viewExtentMerc){var e=this._viewExtentMerc.northEast.inverseMercator(),t=this._viewExtentMerc.southWest.inverseMercator();if(this._viewExtentWGS84){var i=this._viewExtentWGS84;i.northEast.lon>e.lon&&(e.lon=i.northEast.lon),i.northEast.lat>e.lat&&(e.lat=i.northEast.lat),i.southWest.lon<t.lon&&(t.lon=i.southWest.lon),i.southWest.lat<t.lat&&(t.lat=i.southWest.lat)}return new Oe(t,e)}if(this._viewExtentWGS84)return this._viewExtentWGS84}viewLonLat(e,t){this.renderer.activeCamera.setLonLat(e,t)}flyExtent(e,t){this.renderer.activeCamera.flyExtent(e,t)}flyCartesian(e,t,i){this.renderer.activeCamera.flyCartesian(e,t,i)}flyLonLat(e,t,i){this.renderer.activeCamera.flyLonLat(e,t,i)}stopFlying(){this.renderer.activeCamera.stopFlying()}updateBillboardsTexCoords(){for(var e=0;e<this.entityCollections.length;e++)this.entityCollections[e].billboardHandler.refreshTexCoordsArr();var t={};for(e=0;e<this.layers.length;e++){var i=this.layers[e];i instanceof Ps&&i.each(function(e){e._entityCollection&&!t[e._entityCollection.id]&&(e._entityCollection.billboardHandler.refreshTexCoordsArr(),t[e._entityCollection.id]=!0)})}}}const vn=function(e,t){t=t||{},this.handler=e,this._fbo=null,this._pFbo=[],this._rbo=null,this._size=t.size||1,this._width=t.width||256,this._height=t.height||256,this.textures=[],this._active=!1};vn.prototype.destroy=function(){var e=this.handler.gl;e.deleteFramebuffer(this._fbo),this._fbo=null,e.deleteRenderbuffer(this._rbo),this._rbo=null;for(var t=0;t<this._size;t++)e.deleteTexture(this.textures[t]),e.deleteFramebuffer(this._pFbo[t]);this.textures.length=0,this.textures=[],this._pFbo.length=0,this._pFbo=[]},vn.prototype.init=function(){var e=this.handler.gl,t=this.handler.extensions.WEBGL_draw_buffers;this._fbo=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._fbo);for(var i=[],r=0;r<this._size;r++)i[r]=t.COLOR_ATTACHMENT0_WEBGL+r;t.drawBuffersWEBGL(i);for(r=0;r<this._size;r++)this.textures[r]=this.handler.createEmptyTexture_l(this._width,this._height),e.bindTexture(e.TEXTURE_2D,this.textures[r]),e.framebufferTexture2D(e.FRAMEBUFFER,t.COLOR_ATTACHMENT0_WEBGL+r,e.TEXTURE_2D,this.textures[r],0),e.bindTexture(e.TEXTURE_2D,null),i[r]=t.COLOR_ATTACHMENT0_WEBGL+r;this._rbo=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this._rbo),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this._width,this._height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this._rbo),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null);for(r=0;r<this._size;r++)this._pFbo[r]=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._pFbo[r]),e.bindTexture(e.TEXTURE_2D,this.textures[r]),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.textures[r],0),e.bindTexture(e.TEXTURE_2D,null);e.bindFramebuffer(e.FRAMEBUFFER,null)},vn.prototype.setSize=function(e,t){this._width=e,this._height=t,this.destroy(),this.init()},vn.prototype.readAllPixels=function(e){var t=this.handler.gl;t.bindFramebuffer(t.FRAMEBUFFER,this._pFbo[e||0]);var i=new Uint8Array(4*this._width*this._height);return t.readPixels(0,0,this._width,this._height,t.RGBA,t.UNSIGNED_BYTE,i),t.bindFramebuffer(t.FRAMEBUFFER,null),i},vn.prototype.readPixel=function(e,t,i){var r=this.handler.gl;r.bindFramebuffer(r.FRAMEBUFFER,this._pFbo[i||0]);var s=new Uint8Array(4);return r.readPixels(e*this._width,t*this._height,1,1,r.RGBA,r.UNSIGNED_BYTE,s),r.bindFramebuffer(r.FRAMEBUFFER,null),s},vn.prototype.isComplete=function(){var e=this.handler.gl;return e.bindFramebuffer(e.FRAMEBUFFER,this._fbo),e.checkFramebufferStatus(e.FRAMEBUFFER)==e.FRAMEBUFFER_COMPLETE?(e.bindFramebuffer(e.FRAMEBUFFER,null),!0):(e.bindFramebuffer(e.FRAMEBUFFER,null),!1)},vn.prototype.activate=function(){var e=this.handler,t=e.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),t.viewport(0,0,this._width,this._height),this._active=!0;var i=this.handler.framebufferStack.current().data;return i&&(i._active=!1),e.framebufferStack.push(this),this},vn.prototype.deactivate=function(){var e=this.handler,t=e.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,e.canvas.width,e.canvas.height),this._active=!1;var i=e.framebufferStack.popPrev();i?(t.bindFramebuffer(t.FRAMEBUFFER,i._fbo),t.viewport(0,0,i._width,i._height)):t.viewport(0,0,e.canvas.width,e.canvas.height)},vn.prototype.getImage=function(e){var t=this.readAllPixels(e),i=new oi(this._width,this._height);return i.setData(t),i.getImage()},vn.prototype.openImage=function(e){var t=this.getImage(e),i="<!DOCTYPE html>";i+="<html>",i+="<head><title>Print</title></head>",i+="<body>",i+='<img src="'+t.src+'">',i+="</body>",i+="</html>";var r=window.open("","","width="+t.width+"px ,height="+t.height+"px");r.document.open(),r.document.write(i),r.document.close(),r.focus()};const gn={KEY_SHIFT:16,KEY_SPACE:32,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_A:65,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_H:72,KEY_L:76,KEY_Q:81,KEY_S:83,KEY_V:86,KEY_W:87,KEY_X:88,KEY_F1:112,KEY_APOSTROPHE:192,MB_LEFT:0,MB_RIGHT:2,MB_MIDDLE:1},mn=function(){var e={},t={},i={},r=this,s=null,n=null;if(mn.prototype._instance)return mn.prototype._instance;mn.prototype._instance=this,document.onkeydown=function(e){n=e,r.handleKeyDown.call(r)},document.onkeyup=function(e){n=e,r.handleKeyUp.call(r)};var a=function(e,t){return e.priority<t.priority};this.addEvent=function(e,n,o,h,l){switch(void 0===l&&(l=1600),e){case"keypress":null==h?s={callback:o,sender:n||r}:(t[h]||(t[h]=[]),t[h].push({callback:o,sender:n,priority:l}),t[h].sort(a));break;case"charkeypress":i[h]||(i[h]=[]),i[h].push({callback:o,sender:n,priority:l}),i[h].sort(a)}},this.isKeyPressed=function(t){return e[t]},this.handleKeyDown=function(){for(var t in s&&s.callback.call(s.sender,n),e[n.keyCode]=!0,i)if(String.fromCharCode(n.keyCode)==String.fromCharCode(t))for(var r=i[t],a=0;a<r.length;a++)r[a].callback.call(r[a].sender,n)},this.handleKeyUp=function(){e[n.keyCode]=!1},this.handleEvents=function(){for(var i in t)if(e[i])for(var r=t[i],s=0;s<r.length;s++)r[s].callback.call(r[s].sender,n)}},xn=function(e){this._htmlObject=e};xn.prototype.setEvent=function(e,t,i){switch(e){case"mousewheel":this._htmlObject.addEventListener("mousewheel",function(e){var r=e.deltaY||e.detail||e.wheelDelta;void 0==e.wheelDelta&&(e.wheelDelta=-120*r),i.call(t,e),e.preventDefault()},!1),this._htmlObject.addEventListener("wheel",function(e){var r=e.deltaY||e.detail||e.wheelDelta;void 0==e.wheelDelta&&(e.wheelDelta=-120*r),i.call(t,e),e.preventDefault()},!1);break;case"mousedown":this._htmlObject.addEventListener("mousedown",function(e){i.call(t,e)}),this._htmlObject.addEventListener("contextmenu",function(e){return e.preventDefault(),!1});break;case"mouseup":this._htmlObject.addEventListener("mouseup",function(e){i.call(t,e)});break;case"mousemove":this._htmlObject.addEventListener("mousemove",function(e){var r=this.getBoundingClientRect();i.call(t,{clientX:e.clientX-r.left,clientY:e.clientY-r.top})})}};const yn=function(e){this._htmlObject=e};yn.prototype.setEvent=function(e,t,i){switch(e){case"touchcancel":this._htmlObject.addEventListener("touchcancel",function(e){e.preventDefault();var r=this.getBoundingClientRect();e.offsetLeft=r.left,e.offsetTop=r.top,i.call(t,e),e.preventDefault()});break;case"touchstart":this._htmlObject.addEventListener("touchstart",function(e){e.preventDefault();var r=this.getBoundingClientRect();e.offsetLeft=r.left,e.offsetTop=r.top,i.call(t,e),e.preventDefault()});break;case"touchend":this._htmlObject.addEventListener("touchend",function(e){e.preventDefault();var r=this.getBoundingClientRect();e.offsetLeft=r.left,e.offsetTop=r.top,i.call(t,e),e.preventDefault()});break;case"touchmove":this._htmlObject.addEventListener("touchmove",function(e){e.preventDefault();var r=this.getBoundingClientRect();e.offsetLeft=r.left,e.offsetTop=r.top,i.call(t,e),e.preventDefault()})}};const Cn=["draw","resize","mousemove","mousestop","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchstart","touchend","touchcancel","touchmove","doubletouch","touchleave","touchenter"],bn=function(e,t){if(t=t||{},this.div=null,this.handler=e,this._renderNodesArr=[],this.renderNodes={},this.cameras=[],this.activeCamera=null,this.events=new class extends ni{constructor(e){super(Cn),this.renderer=e,this._touchHandler=new yn(e.handler.canvas),this._mouseHandler=new xn(e.handler.canvas),this._keyboardHandler=new mn,this.mouseState={x:0,y:0,nx:0,ny:0,prev_x:0,prev_y:0,direction:new Ge,leftButtonUp:!1,rightButtonUp:!1,middleButtonUp:!1,leftButtonDown:!1,rightButtonDown:!1,middleButtonDown:!1,leftButtonHold:!1,rightButtonHold:!1,middleButtonHold:!1,leftButtonDoubleClick:!1,rightButtonDoubleClick:!1,middleButtonDoubleClick:!1,leftButtonClick:!1,rightButtonClick:!1,middleButtonClick:!1,moving:!1,justStopped:!1,doubleClickDelay:300,wheelDelta:0,sys:null,pickingObject:null,renderer:e},this.touchState={moving:!1,touchEnd:!1,touchStart:!1,touchCancel:!1,doubleTouch:!1,doubleTouchDelay:550,doubleTouchRadius:10,x:0,y:0,nx:0,ny:0,prev_x:0,prev_y:0,sys:null,pickingObject:null,renderer:e},this._dblTchCoords=new Xe,this._oneTouchStart=!1,this._dblTchBegins=0,this._mousestopThread=null,this._ldblClkBegins=0,this._rdblClkBegins=0,this._mdblClkBegins=0,this._lclickX=0,this._lclickY=0,this._rclickX=0,this._rclickY=0,this._mclickX=0,this._mclickY=0}handleEvents(){this.mouseState.direction=this.renderer.activeCamera.unproject(this.mouseState.x,this.mouseState.y),this.entityPickingEvents(),this._keyboardHandler.handleEvents(),this.handleMouseEvents(),this.handleTouchEvents()}on(e,t,i,r,s){"keypress"==e||"charkeypress"==e?this._keyboardHandler.addEvent(e,r,i,t,s):super.on(e,t,i)}isKeyPressed(e){return this._keyboardHandler.isKeyPressed(e)}initialize(){this._mouseHandler.setEvent("mouseup",this,this.onMouseUp),this._mouseHandler.setEvent("mousemove",this,this.onMouseMove),this._mouseHandler.setEvent("mousedown",this,this.onMouseDown),this._mouseHandler.setEvent("mousewheel",this,this.onMouseWheel),this._touchHandler.setEvent("touchstart",this,this.onTouchStart),this._touchHandler.setEvent("touchend",this,this.onTouchEnd),this._touchHandler.setEvent("touchcancel",this,this.onTouchCancel),this._touchHandler.setEvent("touchmove",this,this.onTouchMove)}onMouseWheel(e){this.mouseState.wheelDelta=e.wheelDelta}onMouseMove(e){var t=this.mouseState;if(t.sys=e,t.x!==e.clientX||t.y!==e.clientY){this._ldblClkBegins=0,this._rdblClkBegins=0,this._mdblClkBegins=0,t.x=e.clientX,t.y=e.clientY;var i=this.renderer.handler.canvas;t.nx=t.x/i.width,t.ny=t.y/i.height,t.moving=!0,clearTimeout(this._mousestopThread),this._mousestopThread=setTimeout(function(){t.justStopped=!0},100)}}onMouseDown(e){e.button===gn.MB_LEFT?(this._lclickX=e.clientX,this._lclickY=e.clientY,this.mouseState.sys=e,this.mouseState.leftButtonDown=!0):e.button===gn.MB_RIGHT?(this._rclickX=e.clientX,this._rclickY=e.clientY,this.mouseState.sys=e,this.mouseState.rightButtonDown=!0):e.button===gn.MB_MIDDLE&&(this._mclickX=e.clientX,this._mclickY=e.clientY,this.mouseState.sys=e,this.mouseState.middleButtonDown=!0)}onMouseUp(e){var t=this.mouseState;t.sys=e,e.button===gn.MB_LEFT?(t.leftButtonDown=!1,t.leftButtonUp=!0,this._lclickX===e.clientX&&this._lclickY===e.clientY&&(this._ldblClkBegins?((new Date).getTime()-this._ldblClkBegins<=t.doubleClickDelay&&(t.leftButtonDoubleClick=!0),this._ldblClkBegins=0):this._ldblClkBegins=(new Date).getTime(),t.leftButtonClick=!0)):e.button===gn.MB_RIGHT?(t.rightButtonDown=!1,t.rightButtonUp=!0,this._rclickX===e.clientX&&this._rclickY===e.clientY&&(this._rdblClkBegins?((new Date).getTime()-this._rdblClkBegins<=t.doubleClickDelay&&(t.rightButtonDoubleClick=!0),this._rdblClkBegins=0):this._rdblClkBegins=(new Date).getTime(),t.rightButtonClick=!0)):e.button===gn.MB_MIDDLE&&(t.middleButtonDown=!1,t.middleButtonUp=!0,this._mclickX===e.clientX&&this._mclickY===e.clientY)&&(this._mdblClkBegins?((new Date).getTime()-this._mdblClkBegins<=t.doubleClickDelay&&(t.middleButtonDoubleClick=!0),this._mdblClkBegins=0):this._mdblClkBegins=(new Date).getTime(),t.middleButtonClick=!0)}onTouchStart(e){var t=this.touchState;t.sys=e,t.x=e.touches.item(0).clientX-e.offsetLeft,t.y=e.touches.item(0).clientY-e.offsetTop;var i=this.renderer.handler.canvas;t.nx=t.x/i.width,t.ny=t.y/i.height,t.prev_x=t.x,t.prev_y=t.y,t.touchStart=!0,1===e.touches.length?(this._dblTchCoords.x=t.x,this._dblTchCoords.y=t.y,this._oneTouchStart=!0):this._oneTouchStart=!1}onTouchEnd(e){var t=this.touchState;t.sys=e,t.touchEnd=!0,0===e.touches.length&&(t.prev_x=t.x,t.prev_y=t.y,this._oneTouchStart)&&(this._dblTchBegins&&((new Date).getTime()-this._dblTchBegins<=t.doubleTouchDelay&&(t.doubleTouch=!0),this._dblTchBegins=0),this._dblTchBegins=(new Date).getTime(),this._oneTouchStart=!1)}onTouchCancel(e){var t=this.touchState;t.sys=e,t.touchCancel=!0}onTouchMove(e){var t=this.touchState;t.x=e.touches.item(0).clientX-e.offsetLeft,t.y=e.touches.item(0).clientY-e.offsetTop;var i=this.renderer.handler.canvas;t.nx=t.x/i.width,t.ny=t.y/i.height,t.sys=e,t.moving=!0,this._dblTchBegins=0,this._oneTouchStart=!1}entityPickingEvents(){var e=this.touchState,t=this.mouseState;if(!(t.leftButtonHold||t.rightButtonHold||t.middleButtonHold)){var i=this.renderer,r=i.colorObjects,s=i._currPickingColor,n=i._prevPickingColor;t.pickingObject=null,e.pickingObject=null;var a=r&&r[s[0]+"_"+s[1]+"_"+s[2]];if(t.pickingObject=a,e.pickingObject=a,s[0]!=n[0]||s[1]!=n[1]||s[2]!=n[2])if(s[0]||s[1]||s[2]){if((n[0]||n[1]||n[2])&&(h=r[n[0]+"_"+n[1]+"_"+n[2]])&&(l=h.events||h._entityCollection&&h._entityCollection.events||h._layer.events,t.pickingObject=h,l.dispatch(l.mouseleave,t),e.pickingObject=h,l.dispatch(l.touchleave,e)),a){var o=a.events||a._entityCollection&&a._entityCollection.events||a._layer.events;t.pickingObject=a,o.dispatch(o.mouseenter,t),e.pickingObject=a,o.dispatch(o.touchenter,e)}}else{var h;if(h=r[n[0]+"_"+n[1]+"_"+n[2]]){var l=h.events||h._entityCollection&&h._entityCollection.events||h._layer.events;t.pickingObject=h,l.dispatch(l.mouseleave,t),e.pickingObject=h,l.dispatch(l.touchleave,e)}}}}handleMouseEvents(){let e=this.mouseState,t=e.pickingObject,i=null;e.leftButtonClick&&(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.lclick,e),this.dispatch(this.lclick,e),e.leftButtonClick=!1),e.rightButtonClick&&(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.rclick,e),this.dispatch(this.rclick,e),e.rightButtonClick=!1),e.middleButtonClick&&(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.mclick,e),this.dispatch(this.mclick,e),e.middleButtonClick=!1),e.leftButtonDown&&(e.leftButtonHold?(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.lhold,e),this.dispatch(this.lhold,e)):(e.leftButtonHold=!0,t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.ldown,e),this.dispatch(this.ldown,e))),e.rightButtonDown&&(e.rightButtonHold?(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.rhold,e),this.dispatch(this.rhold,e)):(e.rightButtonHold=!0,t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.rdown,e),this.dispatch(this.rdown,e))),e.middleButtonDown&&(e.middleButtonHold?(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.mhold,e),this.dispatch(this.mhold,e)):(e.middleButtonHold=!0,t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.mdown,e),this.dispatch(this.mdown,e))),e.leftButtonUp&&(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.lup,e),this.dispatch(this.lup,e),e.leftButtonUp=!1,e.leftButtonHold=!1),e.rightButtonUp&&(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.rup,e),this.dispatch(this.rup,e),e.rightButtonUp=!1,e.rightButtonHold=!1),e.middleButtonUp&&(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.mup,e),this.dispatch(this.mup,e),e.middleButtonUp=!1,e.middleButtonHold=!1),e.leftButtonDoubleClick&&(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.ldblclick,e),this.dispatch(this.ldblclick,e),e.leftButtonDoubleClick=!1),e.rightButtonDoubleClick&&(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.rdblclick,e),this.dispatch(this.rdblclick,e),e.rightButtonDoubleClick=!1),e.middleButtonDoubleClick&&(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.mdblclick,e),this.dispatch(this.mdblclick,e),e.middleButtonDoubleClick=!1),e.wheelDelta&&(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.mousewheel,e),this.dispatch(this.mousewheel,e),e.wheelDelta=0),e.moving&&(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.mousemove,e),this.dispatch(this.mousemove,e),e.prev_x=e.x,e.prev_y=e.y),e.justStopped&&(this.dispatch(this.mousestop,e),e.justStopped=!1)}handleTouchEvents(){var e=this.touchState,t=e.pickingObject,i=null;if(e.touchCancel&&(this.dispatch(this.touchcancel,e),e.touchCancel=!1),e.touchStart){var r=this.renderer;r._currPickingColor=r._drawBuffersExtension?r.pickingFramebuffer.readPixel(e.nx,1-e.ny,1):r.pickingFramebuffer.readPixel(e.nx,1-e.ny);var s=r.colorObjects,n=r._currPickingColor,a=s[n[0]+"_"+n[1]+"_"+n[2]];(t=e.pickingObject=a)&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.touchstart,e),this.dispatch(this.touchstart,e),e.touchStart=!1}e.doubleTouch&&(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.doubletouch,e),this.dispatch(this.doubletouch,e),e.doubleTouch=!1),e.touchEnd&&(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.touchend,e),this.dispatch(this.touchend,e),e.x=0,e.y=0,e.touchEnd=!1),e.moving&&(t&&(i=t.events||t._entityCollection&&t._entityCollection.events||t._layer.events).dispatch(i.touchmove,e),this.dispatch(this.touchmove,e),e.prev_x=e.x,e.prev_y=e.y)}}(this),this.controls={},t.controls)for(let e in t.controls)this.controls[t.controls[e].name]=t.controls[e];this.controlsBag={},this.colorObjects={},this._pickingCallbacks=[],this.pickingFramebuffer=null,this.sceneFramebuffer=null,this._currPickingColor=[0,0,0],this._prevPickingColor=[0,0,0],this._fnScreenFrame=null,t.autoActivate&&(this.initialize(),this.start())};bn.prototype.addPickingCallback=function(e,t){this._pickingCallbacks.push({callback:t,sender:e})},bn.prototype.assignPickingColor=function(e){if(!e._pickingColor||e._pickingColor.isZero()){for(var t=0,i=0,r=0,s="0_0_0";!(t||i||r)||this.colorObjects[s];)s=(t=he(1,255))+"_"+(i=he(1,255))+"_"+(r=he(1,255));e._pickingColor?e._pickingColor.set(t,i,r):e._pickingColor=new Ge(t,i,r),this.colorObjects[s]=e}},bn.prototype.clearPickingColor=function(e){if(!e._pickingColor.isZero()){var t=e._pickingColor;t.isZero()||(this.colorObjects[t.x+"_"+t.y+"_"+t.z]=null,delete this.colorObjects[t.x+"_"+t.y+"_"+t.z],t.x=t.y=t.z=0)}},bn.prototype.getWidth=function(){return this.handler.canvas.width},bn.prototype.getHeight=function(){return this.handler.canvas.height},bn.prototype.getCenter=function(){var e=this.handler.canvas;return new Xe(Math.round(.5*e.width),Math.round(.5*e.height))},bn.prototype.addControl=function(e){e.addTo(this)},bn.prototype.addControls=function(e){for(var t=0;t<e.length;t++)e[t].addTo(this)},bn.prototype.removeControl=function(e){var t=this.controls[e.name];return t&&e.isEqual(t)&&(this.controls[e.name]=null,delete this.controls[e.name],t.remove()),this},bn.prototype.initialize=function(){var e=this;this.handler.setFrameCallback(function(){e.draw()}),this.activeCamera=new Hs(this,{eye:new Ge(0,0,0),look:new Ge(0,0,-1),up:new Ge(0,1,0)}),this.events.initialize(),this.events.on("charkeypress",gn.KEY_APOSTROPHE,function(){si.setVisibility(!si.getVisibility())}),this.handler.onCanvasResize=function(t){e.activeCamera.setAspectRatio(t.clientWidth/t.clientHeight),e.sceneFramebuffer.setSize(t.clientWidth,t.clientHeight),e.events.dispatch(e.events.resize,t)},this.pickingFramebuffer=new Gi(this.handler,{width:640,height:480}),this.pickingFramebuffer.init(),this.handler.addShaderProgram(new vi("screenFrame",{uniforms:{texture:{type:fi.SAMPLER2D}},attributes:{corners:{type:fi.VEC3,enableArray:!0}},vertexShader:"attribute vec2 corners;                        varying vec2 tc;            void main(void) {                gl_Position = vec4(corners, 0.0, 1.0);                tc = corners * 0.5 + 0.5;            }",fragmentShader:"precision highp float;            uniform sampler2D texture;                        varying vec2 tc;                        void main(void) {                gl_FragColor = texture2D( texture, tc );            }"})),this._drawBuffersExtension=this.handler.initializeExtension("WEBGL_draw_buffers"),this._drawBuffersExtension?(this.sceneFramebuffer=new vn(this.handler,{size:3}),this.sceneFramebuffer.init(),this._fnScreenFrame=this._multiframebufferScreenFrame):(this.sceneFramebuffer=new Gi(this.handler),this.sceneFramebuffer.init(),this._fnScreenFrame=this._singleframebufferScreenFrame),this._screenFrameCornersBuffer=this.handler.createArrayBuffer(new Float32Array([1,1,-1,1,1,-1,-1,-1]),2,4);let t=this.controls;this.controls={};for(let e in t)this.addControl(t[e])},bn.prototype.addRenderNode=function(e){this.renderNodes[e.name]?si.logWrn("og.Renderer(370) - node name: "+e.name+" allready exists."):(e.assignRenderer(this),this._renderNodesArr.unshift(e),this.renderNodes[e.name]=e)},bn.prototype.addRenderNodes=function(e){for(var t=0;t<e.length;t++)this.addRenderNode(e[t])},bn.prototype.draw=function(){this.activeCamera.checkMoveEnd();var e=this.events;e.handleEvents(),e.dispatch(e.draw,this);var t=this.sceneFramebuffer;t.activate();var i=this.handler;i.clearFrame(),i.gl.activeTexture(i.gl.TEXTURE0),i.gl.bindTexture(i.gl.TEXTURE_2D,i.transparentTexture);for(var r=this._renderNodesArr,s=r.length;s--;)r[s].drawNode();t.deactivate(),this._drawPickingBuffer(),this._fnScreenFrame(),e.mouseState.moving=!1,e.touchState.moving=!1},bn.prototype._multiframebufferScreenFrame=function(){var e=this.handler,t=e.shaderPrograms.screenFrame,i=t._program,r=e.gl;r.disable(r.DEPTH_TEST),t.activate(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.sceneFramebuffer.textures[0]),r.uniform1i(i.uniforms.texture._pName,0),r.bindBuffer(r.ARRAY_BUFFER,this._screenFrameCornersBuffer),r.vertexAttribPointer(i.attributes.corners._pName,2,r.FLOAT,!1,0,0),r.drawArrays(r.TRIANGLE_STRIP,0,4),r.enable(r.DEPTH_TEST)},bn.prototype._singleframebufferScreenFrame=function(){var e=this.handler,t=e.shaderPrograms.screenFrame,i=t._program,r=e.gl;r.disable(r.DEPTH_TEST),t.activate(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.sceneFramebuffer.texture),r.uniform1i(i.uniforms.texture._pName,0),r.bindBuffer(r.ARRAY_BUFFER,this._screenFrameCornersBuffer),r.vertexAttribPointer(i.attributes.corners._pName,2,r.FLOAT,!1,0,0),r.drawArrays(r.TRIANGLE_STRIP,0,4),r.enable(r.DEPTH_TEST)},bn.prototype.getPickingObject=function(e,t){var i,r=this.renderer.handler.canvas;return i=this._drawBuffersExtension?this.sceneFramebuffer.readPixel(e/r.width,(r.height-t)/r.height,1):this.sceneFramebuffer.readPixel(e/r.width,(r.height-t)/r.height),this.colorObjects[i[0]+"_"+i[1]+"_"+i[2]]},bn.prototype.isMultiFramebufferCompatible=function(){return!!this._drawBuffersExtension},bn.prototype._drawPickingBuffer=function(){this.pickingFramebuffer.activate();var e=this.handler,t=e.gl;t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.disable(e.gl.BLEND);for(var i=this._pickingCallbacks,r=i.length;r--;)i[r].callback.call(i[r].sender);this.pickingFramebuffer.deactivate();var s,n=this.events.mouseState,a=this.events.touchState;n.leftButtonHold||n.rightButtonHold||n.middleButtonHold||(this._prevPickingColor[0]=this._currPickingColor[0],this._prevPickingColor[1]=this._currPickingColor[1],this._prevPickingColor[2]=this._currPickingColor[2],a.x||a.y?(s=this.pickingFramebuffer.readPixel(a.nx,1-a.ny))[0]||s[1]||s[2]||!this._drawBuffersExtension||(s=this.sceneFramebuffer.readPixel(a.nx,1-a.ny,1)):(s=this.pickingFramebuffer.readPixel(n.nx,1-n.ny))[0]||s[1]||s[2]||!this._drawBuffersExtension||(s=this.sceneFramebuffer.readPixel(n.nx,1-n.ny,1)),this._currPickingColor=s)},bn.prototype.start=function(){this.handler.start()};class Tn{constructor(e){e=e||{},this._id=Tn.__staticCounter++,this._name=e.name||"_control_"+this._id,this._initialized=!1,this.renderer=null,this.autoActivate=void 0==e.autoActivate||e.autoActivate,this._active=!1}static get __staticCounter(){return this.__counter||0===this.__counter||(this.__counter=0),this.__counter}static set __staticCounter(e){this.__counter=e}get name(){return this._name}oninit(){}onadd(){}onremove(){}onactivate(){}ondeactivate(){}addTo(e){e&&(this.renderer=e,e.controls[this.name]=this,this.onadd&&this.onadd(),this.autoActivate&&(this.oninit&&this.oninit(),this._initialized=!0,this._active=!0))}remove(){this.onremove&&this.onremove(),this.renderer=null,this._active=!1,this._initialized=!1}activate(){this._active=!0,this.onactivate&&this.onactivate()}deactivate(){this._active=!1,this.ondeactivate&&this.ondeactivate()}isActive(){return this._active}isEqual(e){return e._id===this._id}}function An(e){var t,i=e<0?Math.ceil(e):Math.floor(e),r=Math.floor(t=60*Math.abs(e-i)),s=Math.floor(6e3*(t-r));return s/=100,En(i,3)+"°"+En(r,2)+"'"+En(s.toFixed(2),2)+'"'}function En(e,t){for(var i="&nbsp;",r=e.toString().split(".")[0].length;r<t;r++)i+="&nbsp;&nbsp;";return i+e.toString()}const wn=[function(e){return e.lat.toFixed(5)+", "+e.lon.toFixed(5)},function(e){return An(e.lat)+", "+An(e.lon)},function(e){var t=e.forwardMercator();return t.lat.toFixed(5)+", "+t.lon.toFixed(5)}];class Mn extends Tn{constructor(e){super(e),e=e||{},this._displayType=e.type||0,this._converter=wn[0],this._display=null;var t=!1;/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(t=!0),this._center=e.center||t,this.position=null}oninit(){this._display=document.createElement("div"),this._display.className="ogEarthCoordinatesControl";var e=this;function t(t){e._displayType>=wn.length&&(e._displayType=0),0==e._displayType?t.style.width="275px":1==e._displayType?t.style.width="355px":2==e._displayType&&(t.style.width="350px"),e._converter=wn[e._displayType],e._showPosition()}this._display.onclick=function(i){e._displayType+=1,t(this)},this.renderer.div.appendChild(this._display),t(this._display);let i=document.createElement("div");i.className="ogCenterIcon",i.innerHTML='<svg width="12" height="12"><g><path stroke-width="1" stroke-opacity="1" d="M6 0L6 12M0 6L12 6" stroke="#009DFF"></path></g></svg>',this.renderer.div.appendChild(i),this._center?(this.renderer.activeCamera.events.on("moveend",this._grabCoordinates,this),i.style.display="block"):(this.renderer.events.on("mousemove",this._onMouseMove,this),i.style.display="none")}setCenter(e){e!=this._center&&(this._center=e,e?(this.renderer.events.off("mousemove",this._onMouseMove),this.renderer.activeCamera.events.on("moveend",this._grabCoordinates,this),centerDiv.style.display="block"):(this.renderer.events.off("draw",this._draw),this.renderer.events.on("mousemove",this._onMouseMove,this),centerDiv.style.display="none"))}_showPosition(){this.position?(this.position.height=this.position.height>1e4||this.position.height<-1e4?0:this.position.height,this._display.innerHTML="Lat/Lon: "+this._converter(this.position)+" h(km): "+(this.position.height>0?"~"+(Math.round(this.position.height)/1e3).toFixed(2):"-")):this._display.innerHTML="Lat/Lon: _____________________"}_grabCoordinates(){var e=this.renderer;e.events.touchState;this.position=this.planet.getLonLatFromPixelTerrain(e.handler.getCenter()),this._showPosition()}_onMouseMove(){var e=this.renderer,t=e.events.mouseState;!t.leftButtonDown&&!t.rightButtonDown&&e.controlsBag.scaleRot<=0&&!e.activeCamera._flying&&(this.position=this.planet.getLonLatFromPixelTerrain(t,!0),this._showPosition())}}class Pn extends Tn{constructor(e){super(e),this._name="mouseNavigation",e=e||{},this.grabbedPoint=new Ge,this._eye0=new Ge,this.pointOnEarth=new Ge,this.earthUp=new Ge,this.inertia=.007,this.grabbedSpheroid=new Dr,this.planet=null,this.qRot=new We,this.scaleRot=0,this.distDiff=.33,this.stepsCount=5,this.stepsForward=null,this.stepIndex=0,this._keyLock=new Is}static getMovePointsFromPixelTerrain(e,t,i,r,s,n,a){var o=[],h=e.eye.clone(),l=e._n.clone(),u=e._u.clone(),d=e._v.clone(),c=t.getCartesianFromPixelTerrain(s,!0);a||(a=Ge.sub(c,e.eye).normalize());var _=c?r*e.eye.distance(c)/i:1e3;n?_=-_:_*=2;var f=l.scaleTo(_);if(c&&e._lonLat.height>9e3&&e.slope>.6){var p=new Dr;p.radius=c.length();for(var v=[],g=[],m=!1,x=0;x<i;x++){h.addA(f);var y=new Xs(h,a).hitSphere(p);if(g[x]=h.clone(),!y){m=!0;break}v[x]=(new He).rotateBetweenVectors(c.normal(),y.normal())}if(m){h=e.eye.clone();for(x=0;x<i;x++)o[x]={},o[x].eye=h.addA(f).clone(),o[x].v=d,o[x].u=u,o[x].n=l}else for(var x=0;x<i;x++){var C=v[x];o[x]={},o[x].eye=C.mulVec3(g[x]),o[x].v=C.mulVec3(d),o[x].u=C.mulVec3(u),o[x].n=C.mulVec3(l)}}else for(x=0;x<i;x++)o[x]={},o[x].eye=h.addA(a.scaleTo(-_)).clone(),o[x].v=d,o[x].u=u,o[x].n=l;return o}onactivate(){this.renderer.events.on("mousewheel",this.onMouseWheel,this),this.renderer.events.on("lhold",this.onMouseLeftButtonDown,this),this.renderer.events.on("rhold",this.onMouseRightButtonDown,this),this.renderer.events.on("ldown",this.onMouseLeftButtonClick,this),this.renderer.events.on("lup",this.onMouseLeftButtonUp,this),this.renderer.events.on("rdown",this.onMouseRightButtonClick,this),this.renderer.events.on("ldblclick",this.onMouseLeftButtonDoubleClick,this),this.renderer.events.on("draw",this.onDraw,this)}ondeactivate(){this.renderer.events.off("mousewheel",this.onMouseWheel),this.renderer.events.off("lhold",this.onMouseLeftButtonDown),this.renderer.events.off("rhold",this.onMouseRightButtonDown),this.renderer.events.off("ldown",this.onMouseLeftButtonClick),this.renderer.events.off("lup",this.onMouseLeftButtonUp),this.renderer.events.off("rdown",this.onMouseRightButtonClick),this.renderer.events.off("ldblclick",this.onMouseLeftButtonDoubleClick),this.renderer.events.off("draw",this.onDraw)}onMouseWheel(e){if(!this.stepIndex){this.planet.stopFlying(),this.stopRotation(),this._deactivate=!0,this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock);var t=this.renderer.events.mouseState;this.stepIndex=this.stepsCount,this.stepsForward=Pn.getMovePointsFromPixelTerrain(this.renderer.activeCamera,this.planet,this.stepsCount,this.distDiff,t,e.wheelDelta>0,t.direction)}}oninit(){this.activate()}onMouseLeftButtonDoubleClick(){this.planet.stopFlying(),this.stopRotation();var e=this.planet.getCartesianFromPixelTerrain(this.renderer.events.mouseState,!0),t=this.planet.ellipsoid.cartesianToLonLat(e);this.renderer.events.isKeyPressed(gn.KEY_SHIFT)?this.planet.flyLonLat(new De(t.lon,t.lat,2*this.renderer.activeCamera.eye.distance(e))):this.planet.flyLonLat(new De(t.lon,t.lat,.57*this.renderer.activeCamera.eye.distance(e)))}onMouseLeftButtonClick(){this._active&&(this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"),this.grabbedPoint=this.planet.getCartesianFromMouseTerrain(!0),this.grabbedPoint&&(this._eye0.copy(this.renderer.activeCamera.eye),this.grabbedSpheroid.radius=this.grabbedPoint.length(),this.stopRotation()))}stopRotation(){this.qRot.clear(),this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock)}onMouseLeftButtonUp(e){this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")}onMouseLeftButtonDown(e){if(this._active){if(!this.grabbedPoint)return;if(this.planet.stopFlying(),this.renderer.events.mouseState.moving){var t=this.renderer.activeCamera;if(t.slope>.28){var i=new Xs(t.eye,e.direction).hitSphere(this.grabbedSpheroid);if(i){this.scaleRot=1,this.qRot=We.getRotationBetweenVectors(i.normal(),this.grabbedPoint.normal());var r=this.qRot;t.eye=r.mulVec3(t.eye),t._v=r.mulVec3(t._v),t._u=r.mulVec3(t._u),t._n=r.mulVec3(t._n),t.update()}}else{var s=this.grabbedPoint,n=Ge.add(s,t._u),a=Ge.add(s,s.normal()),o=new Ge;new Xs(t.eye,e.direction).hitPlane(s,n,a,o)===Xs.INSIDE&&(t.eye=this._eye0.addA(o.subA(s).negate()),t.update())}}else this.scaleRot=0}}onMouseRightButtonClick(e){this.stopRotation(),this.planet.stopFlying(),this.pointOnEarth=this.planet.getCartesianFromPixelTerrain({x:e.x,y:e.y},!0),this.pointOnEarth&&(this.earthUp=this.pointOnEarth.normal())}onMouseRightButtonDown(e){var t=this.renderer.activeCamera;if(this.pointOnEarth&&this.renderer.events.mouseState.moving){this.renderer.controlsBag.scaleRot=1;var i=.5/t.eye.distance(this.pointOnEarth)*t._lonLat.height*T;i>.007&&(i=.007),t.rotateHorizontal(i*(e.x-e.prev_x),!1,this.pointOnEarth,this.earthUp),t.rotateVertical(i*(e.y-e.prev_y),this.pointOnEarth),t.update()}}onDraw(e){if(this._active){var t=this.renderer,i=t.activeCamera,r=i.eye.clone();if(this.stepIndex){t.controlsBag.scaleRot=1;var s=this.stepsForward[this.stepsCount-this.stepIndex--];i.eye=s.eye,i._v=s.v,i._u=s.u,i._n=s.n,i.update()}else this._deactivate&&(this._deactivate=!1,this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock));if(t.events.mouseState.leftButtonDown||!this.scaleRot)return;if(this.scaleRot-=this.inertia,this.scaleRot<=0)this.scaleRot=0;else{t.controlsBag.scaleRot=this.scaleRot;var n=this.qRot.slerp(We.IDENTITY,1-this.scaleRot*this.scaleRot*this.scaleRot).normalize();n.x||n.y||n.z||(this.scaleRot=0),i.eye=n.mulVec3(i.eye),i._v=n.mulVec3(i._v),i._u=n.mulVec3(i._u),i._n=n.mulVec3(i._n),i.update()}i.eye.distance(r)/i._terrainAltitude>.01?(this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock)):(this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock))}}}class Bn extends Tn{constructor(e){super(e),this.grabbedPoint=new Ge,this.inertia=.007,this.grabbedSpheroid=new Dr,this.planet=null,this.qRot=new We,this.scaleRot=0,this.rot=1,this._eye0=new Ge,this.stepsCount=5,this.stepsForward=null,this.stepIndex=0;var t=function(){this.x=0,this.y=0,this.prev_x=0,this.prev_y=0,this.grabbedPoint=new Ge,this.grabbedSpheroid=new Dr,this.dX=function(){return this.x-this.prev_x},this.dY=function(){return this.y-this.prev_y}};this.pointOnEarth=null,this.earthUp=null,this.touches=[new t,new t],this._keyLock=new Is}oninit(){this.renderer.events.on("touchstart",this.onTouchStart,this),this.renderer.events.on("touchend",this.onTouchEnd,this),this.renderer.events.on("doubletouch",this.onDoubleTouch,this),this.renderer.events.on("touchcancel",this.onTouchCancel,this),this.renderer.events.on("touchmove",this.onTouchMove,this),this.renderer.events.on("draw",this.onDraw,this)}onTouchStart(e){if(this._touching=!0,2===e.sys.touches.length){var t=this.touches[0],i=this.touches[1];t.x=e.sys.touches.item(0).clientX-e.sys.offsetLeft,t.y=e.sys.touches.item(0).clientY-e.sys.offsetTop,t.prev_x=e.sys.touches.item(0).clientX-e.sys.offsetLeft,t.prev_y=e.sys.touches.item(0).clientY-e.sys.offsetTop,t.grabbedPoint=this.planet.getCartesianFromPixelTerrain(t,!0),i.x=e.sys.touches.item(1).clientX-e.sys.offsetLeft,i.y=e.sys.touches.item(1).clientY-e.sys.offsetTop,i.prev_x=e.sys.touches.item(1).clientX-e.sys.offsetLeft,i.prev_y=e.sys.touches.item(1).clientY-e.sys.offsetTop,i.grabbedPoint=this.planet.getCartesianFromPixelTerrain(i,!0),this.pointOnEarth=this.planet.getCartesianFromPixelTerrain(this.renderer.handler.getCenter(),!0),this.pointOnEarth&&(this.earthUp=this.pointOnEarth.normal()),t.grabbedPoint&&i.grabbedPoint&&(t.grabbedSpheroid.radius=t.grabbedPoint.length(),i.grabbedSpheroid.radius=i.grabbedPoint.length(),this.stopRotation())}else 1===e.sys.touches.length&&this._startTouchOne(e)}_startTouchOne(e){var t=this.touches[0];t.x=e.sys.touches.item(0).clientX-e.sys.offsetLeft,t.y=e.sys.touches.item(0).clientY-e.sys.offsetTop,t.prev_x=e.sys.touches.item(0).clientX-e.sys.offsetLeft,t.prev_y=e.sys.touches.item(0).clientY-e.sys.offsetTop,t.grabbedPoint=this.planet.getCartesianFromPixelTerrain(t,!0),this._eye0.copy(this.renderer.activeCamera.eye),t.grabbedPoint&&(t.grabbedSpheroid.radius=t.grabbedPoint.length(),this.stopRotation())}stopRotation(){this.qRot.clear(),this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock)}onDoubleTouch(e){if(!this.stepIndex){this.planet.stopFlying(),this.stopRotation();var t=this.planet.getCartesianFromPixelTerrain(this.touches[0],!0),i=this.planet.ellipsoid.cartesianToLonLat(t);this.planet.flyLonLat(new De(i.lon,i.lat,.57*this.renderer.activeCamera.eye.distance(t)))}}onTouchEnd(e){0===e.sys.touches.length&&(this._touching=!1),1===e.sys.touches.length&&this._startTouchOne(e),Math.abs(this.touches[0].x-this.touches[0].prev_x)<3&&Math.abs(this.touches[0].y-this.touches[0].prev_y)<3&&(this.scaleRot=0)}onTouchCancel(e){}onTouchMove(e){var t=this.renderer.activeCamera;if(2===e.sys.touches.length){this.renderer.controlsBag.scaleRot=1;var i=this.touches[0],r=this.touches[1];if(!i.grabbedPoint||!r.grabbedPoint)return;if(this.planet.stopFlying(),i.prev_x=i.x,i.prev_y=i.y,i.x=e.sys.touches.item(0).clientX-e.sys.offsetLeft,i.y=e.sys.touches.item(0).clientY-e.sys.offsetTop,r.prev_x=r.x,r.prev_y=r.y,r.x=e.sys.touches.item(1).clientX-e.sys.offsetLeft,r.y=e.sys.touches.item(1).clientY-e.sys.offsetTop,i.dY()>0&&r.dY()>0||i.dY()<0&&r.dY()<0||i.dX()>0&&r.dX()>0||i.dX()<0&&r.dX()<0){var s=.5/t.eye.distance(this.pointOnEarth)*t._lonLat.height*T;s>.007&&(s=.007),t.rotateHorizontal(s*i.dX(),!1,this.pointOnEarth,this.earthUp),t.rotateVertical(s*i.dY(),this.pointOnEarth),t.update()}this.scaleRot=0}else if(1===e.sys.touches.length){var n=this.touches[0];if(n.prev_x=n.x,n.prev_y=n.y,n.x=e.sys.touches.item(0).clientX-e.sys.offsetLeft,n.y=e.sys.touches.item(0).clientY-e.sys.offsetTop,!n.grabbedPoint)return;this.planet.stopFlying();var a=t.unproject(n.x,n.y),o=new Xs(t.eye,a).hitSphere(n.grabbedSpheroid);if(o)if(t._n.dot(t.eye.normal())>.28){this.qRot=We.getRotationBetweenVectors(o.normal(),n.grabbedPoint.normal());var h=this.qRot;t.eye=h.mulVec3(t.eye),t._v=h.mulVec3(t._v),t._u=h.mulVec3(t._u),t._n=h.mulVec3(t._n),t.update(),this.scaleRot=1}else{var l=n.grabbedPoint,u=Ge.add(l,t._u),d=Ge.add(l,l.normal()),c=t.unproject(n.x,n.y),_=new Ge;new Xs(t.eye,c).hitPlane(l,u,d,_)===Xs.INSIDE&&(t.eye=this._eye0.addA(_.subA(l).negate()),t.update(),this.scaleRot=0)}}}onDraw(e){if(this.renderer.controlsBag.scaleRot=this.scaleRot,!this._touching){var t=this.renderer,i=(s=t.activeCamera).eye.clone();if(this.stepIndex){t.controlsBag.scaleRot=1;var r=this.stepsForward[this.stepsCount-this.stepIndex--];(s=this.renderer.activeCamera).eye=r.eye,s._v=r.v,s._u=r.u,s._n=r.n,s.update()}if(!t.events.mouseState.leftButtonDown&&this.scaleRot){if(this.scaleRot-=this.inertia,this.scaleRot<=0)this.scaleRot=0;else{t.controlsBag.scaleRot=this.scaleRot;var s=t.activeCamera,n=this.qRot.slerp(We.IDENTITY,1-this.scaleRot*this.scaleRot*this.scaleRot).normalize();n.x||n.y||n.z||(this.scaleRot=0),s.eye=n.mulVec3(s.eye),s._v=n.mulVec3(s._v),s._u=n.mulVec3(s._u),s._n=n.mulVec3(s._n),s.update()}s.eye.distance(i)/s._terrainAltitude>.01?(this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock)):(this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock))}}}}const Ln=23.4392911,Rn=14959787e4;function Sn(e){var t=e-Nt,i=282.9404+470935e-10*t,r=.016709-1.151e-9*t,s=Ce(356.047+.9856002585*t),n=Ln-3.563e-7*t,a=(Ce(i+s),s+A*r*Math.sin(s*T)*(1+r*Math.cos(s*T))),o=Math.cos(a*T)-r,h=Math.sin(a*T)*Math.sqrt(1-r*r),l=Math.sqrt(o*o+h*h),d=Ce(Math.atan2(h,o)*A+i),c=o=l*Math.cos(d*T),_=(h=l*Math.sin(d*T))*Math.cos(n*T),f=h*Math.sin(n*T),p=u*(24*t/23.9344694-259.853/360);return We.yRotation(-p).mulVec3(new Ge(-_*Rn,f*Rn,-c*Rn))}class Nn{static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}constructor(e,t){t=t||{},this._name=e||"light_"+Nn._staticCounter++,this._renderNode=null,this._position=t.position||new Ge,this.directional=void 0==t.derectional||t.derectional,this._ambient=t.ambient||new Ge,this._diffuse=t.diffuse||new Ge(.8,.8,.8),this._specular=t.specular||new Ge(.18,.18,.18),this._shininess=void 0!=t.shininess?t.shininess:3.3,this._active=!0,this._tempAmbient=this._ambient.clone(),this._tempDiffuse=this._diffuse.clone(),this._tempSpecular=this._specular.clone(),this._tempShininess=this._shininess}clone(){}setActive(e){if(e&&!this._active){var t=this._renderNode;if(t){var i=t._lightsNames.indexOf(this._name);this._shininess=t._lightsParamsf[i]=this._tempShininess,-1!=i&&(i*=9,this._ambient.x=t._lightsParamsv[i]=this._tempAmbient.x,this._ambient.y=t._lightsParamsv[i+1]=this._tempAmbient.y,this._ambient.z=t._lightsParamsv[i+2]=this._tempAmbient.z,this._diffuse.x=t._lightsParamsv[i+3]=this._tempDiffuse.x,this._diffuse.y=t._lightsParamsv[i+4]=this._tempDiffuse.y,this._diffuse.z=t._lightsParamsv[i+5]=this._tempDiffuse.z,this._specular.x=t._lightsParamsv[i+6]=this._tempSpecular.x,this._specular.y=t._lightsParamsv[i+7]=this._tempSpecular.y,this._specular.z=t._lightsParamsv[i+8]=this._tempSpecular.z)}this._active=!0}else!e&&this._active&&(this._tempAmbient=this._ambient.clone(),this._tempDiffuse=this._diffuse.clone(),this._tempSpecular=this._specular.clone(),this._tempShininess=this._shininess,this.setBlack(),this._active=!1)}isActive(){return this._active}setPosition(e){return this._position.x=e.x,this._position.y=e.y,this._position.z=e.z,this}getPosition(){return this._position.clone()}setAmbient(e){this._ambient=e;var t=this._renderNode;if(t){var i=9*t._lightsNames.indexOf(this._name);-1!=i&&(t._lightsParamsv[i]=e.x,t._lightsParamsv[i+1]=e.y,t._lightsParamsv[i+2]=e.z)}return this}setDiffuse(e){this._diffuse=e;var t=this._renderNode;if(t){var i=9*t._lightsNames.indexOf(this._name);-1!=i&&(t._lightsParamsv[i+3]=e.x,t._lightsParamsv[i+4]=e.y,t._lightsParamsv[i+5]=e.z)}return this}setSpecular(e){this._specular=e;var t=this._renderNode;if(t){var i=9*t._lightsNames.indexOf(this._name);-1!=i&&(t._lightsParamsv[i+6]=e.x,t._lightsParamsv[i+7]=e.y,t._lightsParamsv[i+8]=e.z)}return this}setShininess(e){this._shininess=e;var t=this._renderNode;if(t){var i=t._lightsNames.indexOf(this._name);-1!=i&&(t._lightsParamsf[i]=e)}return this}setBlack(){this._ambient.clear(),this._diffuse.clear(),this._specular.clear(),this._shininess=0;var e=this._renderNode;if(e){var t=9*e._lightsNames.indexOf(this._name);-1!=t&&(e._lightsParamsv[t]=e._lightsParamsv[t+1]=e._lightsParamsv[t+2]=e._lightsParamsv[t+3]=e._lightsParamsv[t+4]=e._lightsParamsv[t+5]=e._lightsParamsv[t+6]=e._lightsParamsv[t+7]=e._lightsParamsv[t+8]=0)}return this}addTo(e){return this._renderNode=e,e._lights.push(this),e._lightsNames.push(this._name),e._lightsParamsf.push(this._shininess),e._lightsParamsv.push.apply(e._lightsParamsv,this._ambient.toVec()),e._lightsParamsv.push.apply(e._lightsParamsv,this._diffuse.toVec()),e._lightsParamsv.push.apply(e._lightsParamsv,this._specular.toVec()),this}remove(){var e=this.renderNode;if(e){var t=e.getLightById(this._name);-1!=t&&(e._lights.splice(t,1),e._lightsNames.splice(t,1),e._lightsParamsf.splice(t,1),e._lightsParamsv.splice(t,9))}this._renderNode=null}}class In extends Tn{constructor(e){super(e),this._name="sun",e=e||{},this.planet=null,this.offsetVertical=e.offsetVertical||-5e6,this.offsetHorizontal=e.offsetHorizontal||5e6,this.sunlight=null,this._currDate=0,this._prevDate=0,this._clockPtr=null,this._lightOn=!1,this._stopped=e.stopped||!1}oninit(){this.planet.lightEnabled=!0,this.sunlight=new Nn("Sun",{ambient:new Ge(.15,.15,.25),diffuse:new Ge(.9,.9,.8),specular:new Ge(.1,.1,.06),shininess:110}),this.sunlight.addTo(this.planet);var e=this;this.renderer.events.on("draw",this._draw,this),this.renderer.events.on("charkeypress",gn.KEY_L,function(){e.planet.lightEnabled=!e.planet.lightEnabled}),this._clockPtr||(this._clockPtr=this.renderer.handler.defaultClock)}stop(){this._stopped=!0}onactivate(){this._stopped=!1}bindClock(e){this._clockPtr=e}_draw(){if(!this._stopped){this._currDate=this._clockPtr.currentDate;var e=this.renderer.activeCamera;if(e.getHeight()<465e4||!this._active){this._lightOn=!0,this._f=1;var t=e.eye.normal(),i=Ge.proj_b_to_plane(e._v,t,e._v).normalize().scale(this.offsetVertical),r=Ge.proj_b_to_plane(e._u,t,e._u).normalize().scale(this.offsetHorizontal),s=i.add(r),n=e.eye.add(s);if(this._k>0){this._k-=.01;var a=We.getRotationBetweenVectors(this.sunlight._position.normal(),n.normal()).slerp(We.IDENTITY,this._k).normalize();this.sunlight.setPosition(a.mulVec3(this.sunlight._position))}else this.sunlight.setPosition(n)}else if(this._k=1,this._f>0){this._f-=.01;a=We.getRotationBetweenVectors(this.sunlight._position.normal(),Sn(this._currDate).normal()).slerp(We.IDENTITY,this._f).normalize();this.sunlight.setPosition(a.mulVec3(this.sunlight._position))}else(Math.abs(this._currDate-this._prevDate)>34e-5&&this._active||this._lightOn)&&(this._lightOn=!1,this._prevDate=this._currDate,this.sunlight.setPosition(Sn(this._currDate)),this._f=0)}}}class Fn extends Tn{constructor(e){super(e),e=e||{},this.distDiff=.33,this.stepsCount=5,this.stepsForward=null,this.stepIndex=0,this._keyLock=new Is,this.planet=null}oninit(){var e=document.createElement("div"),t=document.createElement("button"),i=document.createElement("button");e.className="ogZoomControl",t.className="ogZoomButton ogZoomIn",i.className="ogZoomButton ogZoomOut",e.appendChild(t),e.appendChild(i),this.renderer.div.appendChild(e);var r=this;t.onclick=function(e){r.zoomIn()},i.onclick=function(e){r.zoomOut()},this.renderer.events.on("draw",this._draw,this)}zoomIn(){this._deactivate=!0,this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock),this.stepIndex=this.stepsCount,this.stepsForward=Pn.getMovePointsFromPixelTerrain(this.renderer.activeCamera,this.planet,this.stepsCount,1.7*this.distDiff,this.renderer.getCenter(),!0,this.renderer.activeCamera._n.negateTo())}zoomOut(){this._deactivate=!0,this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock),this.stepIndex=this.stepsCount,this.stepsForward=Pn.getMovePointsFromPixelTerrain(this.renderer.activeCamera,this.planet,this.stepsCount,2*this.distDiff,this.renderer.getCenter(),!1,this.renderer.activeCamera._n.negateTo())}_draw(e){var t=this.renderer.activeCamera;if(this.stepIndex){var i=this.stepsForward[this.stepsCount-this.stepIndex--];t.eye=i.eye,t._v=i.v,t._u=i.u,t._n=i.n,t.update()}else t._flying||this._deactivate&&(this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock),this._deactivate=!1)}}const zn="globus_viewport_",kn="globus_planet_";class Dn{constructor(e){var t=zn+Dn._staticCounter++;function i(){return!1}function r(){return!0}this._canvas=document.createElement("canvas"),this._canvas.id=t,this._canvas.style.width="100%",this._canvas.style.height="100%",this._canvas.style.display="block",this._canvas.style.opacity="1.0",this.div=document.getElementById(e.target),this.div.appendChild(this._canvas),this.div.classList.add("ogViewport"),this.div.onmouseenter=function(){document.onmousewheel=i},this.div.onmouseleave=function(){document.onmousewheel=r};var s=new ci(t,{alpha:!1,antialias:!1});s.initialize(),this.renderer=new bn(s),this.renderer.initialize(),this.renderer.div=this.div,this.renderer.div.attributions=document.createElement("div"),this.renderer.div.attributions.classList.add("ogAttribution"),this.div.appendChild(this.renderer.div.attributions),e.skybox&&this.renderer.addRenderNode(e.skybox),this._planetName=e.name?e.name:kn+Dn._staticCounter,e.atmosphere||(this.planet=new pn(this._planetName,e.ellipsoid?e.ellipsoid:dn)),e.terrain?this.planet.setTerrain(e.terrain):this.planet.setTerrain(new ri),this.renderer.addRenderNode(this.planet),this.sun,e.controls?this.planet.addControls(e.controls):this.planet.addControls([new Pn,new Bn,new Fn,new Mn]);var n=this.renderer.controls;for(var a in n)if(n[a]instanceof In){this.sun=n[a];break}this.sun||(this.sun=new In,this.planet.addControl(this.sun)),e.sun&&(void 0===e.sun.active||e.sun.active||this.sun.deactivate()),e.layers&&this.planet.addLayers(e.layers),e.viewExtent&&this.planet.viewToExtent(e.viewExtent),this._opacityCounter=0,this._fadeHandler=null,this._stopHandler=null,(Dn.isUndefined(e.autoActivate)||e.autoActivate)&&(this.fadeIn(500),this.renderer.start())}fadeIn(e){clearInterval(this._stopHandler),clearInterval(this._fadeHandler),this._canvas.style.opacity=0,this._opacityCounter=0;var t=1/(e/10);this._fadeHandler=setInterval(()=>{this._opacityCounter+=t,this._opacityCounter>=1&&(this._opacityCounter=1,clearInterval(this._fadeHandler)),this._canvas.style.opacity=this._opacityCounter},10)}fadeOut(e){clearInterval(this._stopHandler),clearInterval(this._fadeHandler),this._canvas.style.opacity=1,this._opacityCounter=1;var t=1/(e/10);this._fadeHandler=setInterval(()=>{this._opacityCounter-=t,this._opacityCounter<=0&&(this._opacityCounter=0,clearInterval(this._fadeHandler)),this._canvas.style.opacity=this._opacityCounter},10)}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(e){this._counter=e}static isUndefined(e){return void 0===e}}const On=7,Vn=["load","loadend"];class Un extends Es{constructor(e,t){super(e,t=t||{}),this.events.registerNames(Vn),this._counter=0,this._pendingsQueue=[],this.drawTile=t.drawTile||null}abortLoading(){for(var e=this._pendingsQueue,t=e._shiftIndex+1;t<e._popIndex+1;t++)e._array[t]&&this.abortMaterialLoading(e._array[t]);this._pendingsQueue=[]}setVisibility(e){e!=this._visibility&&(this._visibility=e,this._isBaseLayer&&e?this._planet.setBaseLayer(this):e||this.abortLoading(),this._planet.updateVisibleLayers(),this.events.dispatch(this.events.visibilitychange,this))}loadMaterial(e){var t=e.segment;this._isBaseLayer?e.texture=t._isNorth?t.planet.solidTextureOne:t.planet.solidTextureTwo:e.texture=t.planet.transparentTexture,this._planet.layerLock.isFree()&&(e.isReady=!1,e.isLoading=!0,Un.__requestsCounter>=On&&this._counter?this._pendingsQueue.push(e):this._exec(e))}_exec(e){Un.__requestsCounter++,this._counter++;var t=this;this.drawTile?setTimeout(function(){var i=t.events.load;i.handlers.length&&t.events.dispatch(i,e),t.drawTile(e,function(i){t._counter--,og.layer.CanvasTiles.__requestsCounter--,e.isLoading&&e.applyImage(i),t._dequeueRequest()})},50):e.textureNotExists()}abortMaterialLoading(e){e.isLoading&&e.image&&(e.image.src="",this._counter--,og.layer.CanvasTiles.__requestsCounter--,this._dequeueRequest()),e.isLoading=!1,e.isReady=!1}_dequeueRequest(){var e;this._pendingsQueue.length?Un.__requestsCounter<On&&(e=this._whilePendings())&&this._exec.call(this,e):0===this._counter&&this.events.dispatch(this.events.loadend)}_whilePendings(){for(;this._pendingsQueue.length;){var e=this._pendingsQueue.pop();if(e.segment.node){if(e.segment.ready&&e.segment.node.getState()===Ti)return e;e.isLoading=!1}}return null}applyMaterial(e){if(e.isReady)return[0,0,1,1];!e.isLoading&&this.loadMaterial(e);for(var t=e.segment,i=t.node,r=!1,s=this._id,n=e;i.parentNode;){if(n&&n.isReady){r=!0;break}n=(i=i.parentNode).segment.materials[s]}if(r){e.appliedNodeId=i.nodeId,e.texture=n.texture;var a=1/(2<<t.tileZoom-i.segment.tileZoom-1);return[t.tileX*a-i.segment.tileX,t.tileY*a-i.segment.tileY,a,a]}return e.texture=t.planet.transparentTexture,[0,0,1,1]}clearMaterial(e){e.isReady&&(e.isReady=!1,!e.texture.default&&e.segment.handler.gl.deleteTexture(e.texture),e.texture=null),this.abortMaterialLoading(e),e.isLoading=!1,e.textureExists=!1,e.image&&(e.image.src="",e.image=null)}}class Hn extends Es{constructor(e,t){super(e,t),this._projType=0,this._frameWidth=256,this._frameHeight=256,this._sourceReady=!1,this._sourceTexture=null,this._materialTexture=null,this._gridBuffer=null,this._extentWgs84Params=null,this._refreshFrame=!0,this._frameCreated=!1,this._sourceCreated=!1,this._animate=!1,this._ready=!1,this._creationProceeding=!1,this._isRendering=!1,this._extentWgs84=new Oe,this._cornersWgs84=null,this.rendering=null,t.corners&&this.setCorners(t.corners)}getCornersLonLat(){var e=this._cornersWgs84;return[new De(e[0].lon,e[0].lat),new De(e[1].lon,e[1].lat),new De(e[2].lon,e[2].lat),new De(e[3].lon,e[3].lat)]}getCorners(){var e=this._cornersWgs84;return[[e[0].lon,e[0].lat],[e[1].lon,e[1].lat],[e[2].lon,e[2].lat],[e[3].lon,e[3].lat]]}setCorners(e){this.setCornersLonLat(De.join(e))}setCornersLonLat(e){this._refreshFrame=!0,this._cornersWgs84=[e[0].clone(),e[1].clone(),e[2].clone(),e[3].clone()]||[0,0,0,0];for(var t=0;t<this._cornersWgs84.length;t++)this._cornersWgs84[t].lat>=89.9&&(this._cornersWgs84[t].lat=89.9),this._cornersWgs84[t].lat<=-89.9&&(this._cornersWgs84[t].lat=-89.9);this._extent.setByCoordinates(this._cornersWgs84);var i=this._extent;i.southWest.lat>ze||i.northEast.lat<ke?(this._projType=0,this.rendering=this._renderingProjType0):(this._projType=1,this.rendering=this._renderingProjType1),this._ready&&!this._creationProceeding&&this._planet._geoImageCreator.add(this)}_createFrame(){if(this._extentWgs84=this._extent.clone(),this._cornersMerc=[this._cornersWgs84[0].forwardMercatorEPS01(),this._cornersWgs84[1].forwardMercatorEPS01(),this._cornersWgs84[2].forwardMercatorEPS01(),this._cornersWgs84[3].forwardMercatorEPS01()],this._extentMerc=new Oe(this._extentWgs84.southWest.forwardMercatorEPS01(),this._extentWgs84.northEast.forwardMercatorEPS01()),0==this._projType?this._extentWgs84Params=[this._extentWgs84.southWest.lon,this._extentWgs84.southWest.lat,2/this._extentWgs84.getWidth(),2/this._extentWgs84.getHeight()]:this._extentMercParams=[this._extentMerc.southWest.lon,this._extentMerc.southWest.lat,2/this._extentMerc.getWidth(),2/this._extentMerc.getHeight()],this._planet){var e=this._planet.renderer.handler;e.gl.deleteTexture(this._materialTexture),this._materialTexture=e.createEmptyTexture_l(this._frameWidth,this._frameHeight),this._gridBuffer=this._planet._geoImageCreator.createGridBuffer(this._cornersWgs84,this._projType),this._refreshFrame=!1}}abortMaterialLoading(e){this._creationProceeding=!1,e.isLoading=!1,e.isReady=!1}clear(){var e=this._planet;if(e){var t=e.renderer.handler.gl;this._creationProceeding&&e._geoImageCreator.remove(this),e._clearLayerMaterial(this),t.deleteBuffer(this._gridBuffer),t.deleteTexture(this._sourceTexture),!this._materialTexture.default&&t.deleteTexture(this._materialTexture)}this._sourceTexture=null,this._materialTexture=null,this._gridBuffer=null,this._refreshFrame=!0,this._sourceCreated=!1,this._ready=!1,this._creationProceeding=!1}setVisibility(e){e!=this._visibility&&(this._visibility=e,this._isBaseLayer&&e&&this._planet.setBaseLayer(this),this._planet.updateVisibleLayers(),this.events.dispatch(this.events.visibilitychange,this),e?this._sourceReady&&this._planet._geoImageCreator.add(this):this._sourceReady&&this._planet._geoImageCreator.remove(this))}clearMaterial(e){e.image=null,e.texture=null,e.isLoading=!1,e.isReady=!1}applyMaterial(e){var t=e.segment;if(this._ready?e.applyTexture(this._materialTexture):(e.texture=this._planet.transparentTexture,!this._creationProceeding&&this.loadMaterial(e)),0===this._projType)var i=this._extentWgs84,r=t._extent;else i=this._extentMerc,r=t.getExtentMerc();var s=i.northEast.lon-i.southWest.lon,n=i.northEast.lat-i.southWest.lat;return[(r.southWest.lon-i.southWest.lon)/s,(i.northEast.lat-r.northEast.lat)/n,(r.northEast.lon-r.southWest.lon)/s,(r.northEast.lat-r.southWest.lat)/n]}getFrameWidth(){return this._frameWidth}getFrameHeight(){return this._frameHeight}}class Wn extends Es{constructor(e,t){super(e,t),this.events.registerNames(Gn),t.extent||this.setExtent(new Oe(new De(-180,ke),new De(180,ze))),this.transparentColor=t.transparentColor||[-1,-1,-1],this.url=t.url||"",this._counter=0,this._pendingsQueue=new Ms,this._s=t.subdomains||["a","b","c"],this._crossOrigin=void 0===t.crossOrigin?"":t.crossOrigin,this._urlRewriteCallback=t.urlRewrite||null}static get __requestsCounter(){return this.__reqcounter}static set __requestsCounter(e){this.__reqcounter=e}static get MAX_REQUESTS(){return 7}abortLoading(){var e=this;this._pendingsQueue.each(function(t){t&&e.abortMaterialLoading(t)}),this._pendingsQueue.clear()}setVisibility(e){e!==this._visibility&&(this._visibility=e,this._isBaseLayer&&e?this._planet.setBaseLayer(this):e||this.abortLoading(),this._planet.updateVisibleLayers(),this.events.dispatch(this.events.visibilitychange,this))}setUrl(e){this.url=e}loadMaterial(e){var t=e.segment;this._isBaseLayer?e.texture=t._isNorth?t.planet.solidTextureOne:t.planet.solidTextureTwo:e.texture=t.planet.transparentTexture,this._planet.layerLock.isFree()&&(e.isReady=!1,e.isLoading=!0,e.segment._projection.id===Wi.id?Wn.__requestsCounter>=Wn.MAX_REQUESTS&&this._counter?this._pendingsQueue.push(e):this._exec(e):e.textureNotExists())}_createUrl(e){return Je(this.url,{s:this._s[Math.floor(Math.random()*this._s.length)],x:e.tileX.toString(),y:e.tileY.toString(),z:e.tileZoom.toString()})}_getHTTPRequestString(e){var t=this._createUrl(e);return this._urlRewriteCallback?this._urlRewriteCallback(e,t):t}setUrlRewriteCallback(e){this._urlRewriteCallback=e}_exec(e){Wn.__requestsCounter++,this._counter++,e.image=new Image,e.image.crossOrigin=this._crossOrigin;var t=this;e.image.onload=function(i){if(t._counter--,Wn.__requestsCounter--,e.isLoading){var r=t.events.load;r.handlers.length&&t.events.dispatch(r,e),this.onerror=null,this.onload=null,e.applyImage(this)}t._dequeueRequest()},e.image.onerror=function(i){t._counter--,Wn.__requestsCounter--,this.onerror=null,this.onload=null,e.isLoading&&e.image&&e.textureNotExists.call(e),t._dequeueRequest()},e.image.src=this._getHTTPRequestString(e.segment)}abortMaterialLoading(e){e.isLoading&&e.image?(e.image.src="",e.image.__og_canceled=!0,e.image=null):this._dequeueRequest()}_dequeueRequest(){if(this._pendingsQueue.length){if(Wn.__requestsCounter<Wn.MAX_REQUESTS){var e=this._whilePendings();e&&this._exec.call(this,e)}}else 0===this._counter&&this.events.dispatch(this.events.loadend)}_whilePendings(){for(;this._pendingsQueue.length;){var e=this._pendingsQueue.pop();if(e.segment.node){if(e.segment.ready&&e.segment.node.getState()===Ti)return e;e.isLoading=!1}}return null}applyMaterial(e){if(e.isReady)return[0,0,1,1];!e.isLoading&&this.loadMaterial(e);for(var t=e.segment,i=t.node,r=!1,s=this._id,n=e;i.parentNode;){if(n&&n.isReady){r=!0;break}n=(i=i.parentNode).segment.materials[s]}if(r){e.appliedNodeId=i.nodeId,e.texture=n.texture;var a=1/(2<<t.tileZoom-i.segment.tileZoom-1);return[t.tileX*a-i.segment.tileX,t.tileY*a-i.segment.tileY,a,a]}return e.texture=t.planet.transparentTexture,[0,0,1,1]}clearMaterial(e){e.isReady?(e.isReady=!1,!e.texture.default&&e.segment.handler.gl.deleteTexture(e.texture),e.texture=null):this.abortMaterialLoading(e),e.textureExists=!1,e.image&&(e.image.onload=null,e.image.onerror=null,e.image.src="",e.image=null)}_correctFullExtent(){var e=this._extent,t=this._extentMerc,i=we+5e4,r=we+5e4;90===e.northEast.lat&&(t.northEast.lat=r),180===e.northEast.lon&&(t.northEast.lon=i),-90===e.southWest.lat&&(t.southWest.lat=-r),-180===e.southWest.lon&&(t.southWest.lon=-i),e.northEast.lat>=ze&&(e.northEast.lat=ze),e.northEast.lat<=ke&&(e.northEast.lat=ke)}}const Gn=["load","loadend"];class Xn extends Wn{constructor(e,t){super(e,t),t.extent||this.setExtent(new Oe(new De(-180,-90),new De(180,90))),this.layers=t.layers,this.imageWidth=t.imageWidth||256,this.imageHeight=t.imageHeight||256,this.setVersion(t.version)}loadMaterial(e){e.segment;e.isLoading||this._planet.layerLock.isFree()&&(e.isReady=!1,e.isLoading=!0,Xn.__requestsCounter>=Xn.MAX_REQUESTS&&this.counter?this.pendingsQueue.push(e):this._exec(e))}_createUrl(e){return this.url+"wms?LAYERS="+this.layers+"&FORMAT=image/jpeg&SERVICE=WMS&VERSION="+this._version+"&REQUEST=GetMap&SRS="+e._projection.code+"&BBOX="+this._getBbox(e)+"&WIDTH="+this.imageWidth+"&HEIGHT="+this.imageHeight}setVersion(e){this._version=e||"1.1.1","1.1.1"===this._version?this._getBbox=this._getBbox111:this._getBbox="1.3.0"===e?this._getBbox130:this._getBbox111}_getBbox111(e){return e._extent.getWest()+","+e._extent.getSouth()+","+e._extent.getEast()+","+e._extent.getNorth()}_getBbox130(e){return e._extent.getSouth()+","+e._extent.getWest()+","+e._extent.getNorth()+","+e._extent.getEast()}_correctFullExtent(){var e=this._extent,t=this._extentMerc,i=we+5e4,r=we+5e4;90===e.northEast.lat&&(t.northEast.lat=r),180===e.northEast.lon&&(t.northEast.lon=i),-90===e.southWest.lat&&(t.southWest.lat=-r),-180===e.southWest.lon&&(t.southWest.lon=-i)}}class Yn extends Tn{constructor(e){super(e=e||{})}oninit(){this.renderer.events.on("keypress",gn.KEY_W,this.onCameraMoveForward,this),this.renderer.events.on("keypress",gn.KEY_S,this.onCameraMoveBackward,this),this.renderer.events.on("keypress",gn.KEY_A,this.onCameraStrifeLeft,this),this.renderer.events.on("keypress",gn.KEY_D,this.onCameraStrifeRight,this),this.renderer.events.on("keypress",gn.KEY_UP,this.onCameraLookUp,this),this.renderer.events.on("keypress",gn.KEY_DOWN,this.onCameraLookDown,this),this.renderer.events.on("keypress",gn.KEY_LEFT,this.onCameraTurnLeft,this),this.renderer.events.on("keypress",gn.KEY_RIGHT,this.onCameraTurnRight,this),this.renderer.events.on("keypress",gn.KEY_Q,this.onCameraRollLeft,this),this.renderer.events.on("keypress",gn.KEY_E,this.onCameraRollRight,this)}onCameraMoveForward(e){var t=this.renderer.activeCamera;t.slide(0,0,-t._lonLat.height/30),t.update()}onCameraMoveBackward(e){var t=this.renderer.activeCamera;t.slide(0,0,t._lonLat.height/30),t.update()}onCameraStrifeLeft(e){var t=this.renderer.activeCamera;t.slide(-t._lonLat.height/30,0,0),t.update()}onCameraStrifeRight(e){var t=this.renderer.activeCamera;t.slide(t._lonLat.height/30,0,0),t.update()}onCameraLookUp(e){var t=this.renderer.activeCamera;this.renderer.events.isKeyPressed(gn.KEY_SHIFT)?t.pitch(5):t.rotateVertical(t._lonLat.height/3e6*T,Ge.ZERO),t.update()}onCameraLookDown(e){var t=this.renderer.activeCamera;this.renderer.events.isKeyPressed(gn.KEY_SHIFT)?t.pitch(-5):t.rotateVertical(-t._lonLat.height/3e6*T,Ge.ZERO),t.update()}onCameraTurnLeft(e){var t=this.renderer.activeCamera;this.renderer.events.isKeyPressed(gn.KEY_SHIFT)?t.yaw(5):t.rotateHorizontal(t._lonLat.height/3e6*T,!1,Ge.ZERO),t.update()}onCameraTurnRight(e){var t=this.renderer.activeCamera;this.renderer.events.isKeyPressed(gn.KEY_SHIFT)?t.yaw(-5):t.rotateHorizontal(-t._lonLat.height/3e6*T,!1,Ge.ZERO),t.update()}onCameraRollLeft(e){this.renderer.activeCamera.roll(-5),this.renderer.activeCamera.update()}onCameraRollRight(e){this.renderer.activeCamera.roll(5),this.renderer.activeCamera.update()}}class jn extends Tn{constructor(e){super(e),this.dialog=null,this.baseLayersDiv=null,this.overlaysDiv=null,this._id=jn.numSwitches++}static get numSwitches(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set numSwitches(e){this._counter=e}oninit(){this.planet.events.on("layeradd",this.onLayerAdded,this),this.planet.events.on("layerremove",this.onLayerRemoved,this),this.createSwitcher(),this.createDialog()}onLayerAdded(e){e.displayInLayerSwitcher&&(e.isBaseLayer()?this.addSwitcher("radio",e,this.baseLayersDiv):this.addSwitcher("checkbox",e,this.overlaysDiv,this._id))}onLayerRemoved(e){e._removeCallback(),e._removeCallback=null}addSwitcher(e,t,i,r){var s=document.createElement("div"),n=this,a=document.createElement("div");a.classList.add("ogViewExtentBtn"),a.onclick=function(){n.planet.flyExtent(t.getExtent())};var o=document.createElement("input");o.type=e,o.name="ogBaseLayerRadiosId"+(r||""),o.checked=t.getVisibility(),o.className="ogLayerSwitcherInput",o.onclick=function(){t.setVisibility(this.checked)},t.events&&t.events.on("visibilitychange",function(e){o.checked=e.getVisibility()});var h=document.createElement("label");h.className="ogLayerSwitcherLabel",h.innerHTML=(t.name||t.src||"noname")+"</br>",t._removeCallback=function(){i.removeChild(s)},s.appendChild(a),s.appendChild(o),s.appendChild(h),i.appendChild(s)}createBaseLayersContainer(){var e=document.createElement("div");e.className="layersDiv",this.dialog.appendChild(e);var t=document.createElement("div");t.className="layersDiv",t.innerHTML="Base Layer",e.appendChild(t),this.baseLayersDiv=document.createElement("div"),e.appendChild(this.baseLayersDiv)}createOverlaysContainer(){var e=document.createElement("div");e.className="layersDiv",this.dialog.appendChild(e);var t=document.createElement("div");t.className="layersDiv",t.innerHTML="Overlays",e.appendChild(t),this.overlaysDiv=document.createElement("div"),e.appendChild(this.overlaysDiv)}createDialog(){if(this.dialog=document.createElement("div"),this.dialog.id="ogLayerSwitcherDialog",this.dialog.className="displayNone",this.renderer.div.appendChild(this.dialog),this.createBaseLayersContainer(),this.createOverlaysContainer(),this.planet)for(var e=0;e<this.planet.layers.length;e++)this.onLayerAdded(this.planet.layers[e])}createSwitcher(){var e=document.createElement("div");e.className="ogLayerSwitcherButton",e.id="ogLayerSwitcherButtonMaximize";var t=this;e.onclick=function(e){"ogLayerSwitcherButtonMaximize"===this.id?(this.id="ogLayerSwitcherButtonMinimize",t.dialog.className="displayBlock"):(this.id="ogLayerSwitcherButtonMaximize",t.dialog.className="displayNone")},this.renderer.div.appendChild(e)}}class qn extends Tn{constructor(e){super(e=e||{}),this.camera=null,this.speed=e.speed||1}oninit(){this.camera=this.renderer.activeCamera,this.renderer.events.on("keypress",gn.KEY_W,this.onCameraMoveForward,this),this.renderer.events.on("keypress",gn.KEY_S,this.onCameraMoveBackward,this),this.renderer.events.on("keypress",gn.KEY_A,this.onCameraStrifeLeft,this),this.renderer.events.on("keypress",gn.KEY_D,this.onCameraStrifeRight,this),this.renderer.events.on("keypress",gn.KEY_UP,this.onCameraLookUp,this),this.renderer.events.on("keypress",gn.KEY_DOWN,this.onCameraLookDown,this),this.renderer.events.on("keypress",gn.KEY_LEFT,this.onCameraTurnLeft,this),this.renderer.events.on("keypress",gn.KEY_RIGHT,this.onCameraTurnRight,this),this.renderer.events.on("keypress",gn.KEY_Q,this.onCameraRollLeft,this),this.renderer.events.on("keypress",gn.KEY_E,this.onCameraRollRight,this)}onCameraMoveForward(e){var t=this.camera;t.slide(0,0,-this.speed),t.update()}onCameraMoveBackward(e){var t=this.camera;t.slide(0,0,this.speed),t.update()}onCameraStrifeLeft(e){var t=this.camera;t.slide(-this.speed,0,0),t.update()}onCameraStrifeRight(e){var t=this.camera;t.slide(this.speed,0,0),t.update()}onCameraLookUp(e){var t=this.camera;t.pitch(.5),t.update()}onCameraLookDown(e){var t=this.camera;t.pitch(-.5),t.update()}onCameraTurnLeft(e){var t=this.camera;t.yaw(.5),t.update()}onCameraTurnRight(e){var t=this.camera;t.yaw(-.5),t.update()}onCameraRollLeft(e){var t=this.camera;t.roll(-.5),t.update()}onCameraRollRight(e){var t=this.camera;t.roll(.5),t.update()}}class Zn extends Tn{constructor(e){super(e)}oninit(){var e=document.createElement("div");e.className="defaultText ",e.id="ogShowFpsControl",document.body.appendChild(e),this.renderer.events.on("draw",this._draw,this)}_draw(){var e,t,i,r,s;e="ogShowFpsControl",t=(1e3/this.renderer.handler.deltaTime).toFixed(1),i=this.renderer.handler.canvas.clientWidth-60,r=0,(s=document.getElementById(e))||((s=document.createElement("div")).id=e,s.classList.add("defaultText"),document.body.appendChild(s)),s.innerHTML=t,s.style.left=i,s.style.top=r}}const Qn=["load","loadend"];const Kn=function(e,t,i){this.a=e||0,this.b=t||0,this.c=i||0};Kn.get=function(e,t){return new Kn(t.y-e.y,e.x-t.x,t.x*e.y-e.x*t.y)},Kn.getParallel=function(e,t){return new Kn(e.a,e.b,-e.a*t.x-e.b*t.y)},Kn.getIntersection=function(e,t){var i=(t.b*e.c-e.b*t.c)/(e.b*t.a-t.b*e.a);return new Xe(i,-(e.c+e.a*i)/e.b)},Kn.prototype.intersects=function(e){return Kn.getIntersection(this,e)};const Jn=function(e,t){this.p0=e?e.clone():new Ge,this.p1=t?t.clone():new Ge};Jn.prototype.getSphereIntersection=function(e){var t=this.p0,i=this.p1,r=e.x,s=e.y,n=e.z,a=t.x,o=t.y,h=t.z,l=i.x-a,u=i.y-o,d=i.z-h,c=l*l+u*u+d*d,_=2*(a*l+o*u+h*d-l*r-u*s-d*n),f=_*_-4*c*(a*a-2*a*r+r*r+o*o-2*o*s+s*s+h*h-2*h*n+n*n-e.radius*e.radius);if(f<0)return null;var p=(-_-Math.Sqrt(f))/(2*c),v=new Ge(t.x*(1-p)+p*i.x,t.y*(1-p)+p*i.y,t.z*(1-p)+p*i.z);if(0==f)return v;var g=(-_+Math.Sqrt(f))/(2*c),m=new Ge(t.x*(1-g)+g*i.x,t.y*(1-g)+g*i.y,t.z*(1-g)+g*i.z);return Math.Abs(p-.5)<Math.abs(g-.5)?[v,m]:[m,v]};class $n{constructor(e,t){this.p=e?e.clone():new Ge,this.n=t?t.clone():new Ge}set(e,t){this.p.copy(e),this.n.copy(t)}getNormal(){return this.n}getIntersection(e,t,i){var r,s=e.n.cross(t.n),n=s.x>=0?s.x:-s.x,a=s.y>=0?s.y:-s.y,o=s.z>=0?s.z:-s.z;if(n+a+o<O){var h=t.p.sub(e.p);return 0==e.n.dot(h)?1:0}r=n>a?n>o?1:3:a>o?2:3;var l,u,d=new Ge;return l=-e.n.dot(e.p),u=-t.n.dot(t.p),1===r?(d.x=0,d.y=(u*e.n.z-l*t.n.z)/s.x,d.z=(l*t.n.y-u*e.n.y)/s.x):2===r?(d.x=(l*t.n.z-u*e.n.z)/s.y,d.y=0,d.z=(u*e.n.x-l*t.n.x)/s.y):3===r&&(d.x=(u*e.n.y-l*t.n.y)/s.z,d.y=(l*t.n.x-u*e.n.x)/s.z,d.z=0),i.p0.copy(d),i.p1.copy(d.add(s)),2}}i.d(t,"layer",function(){return ea}),i.d(t,"terrain",function(){return ra}),i.d(t,"control",function(){return ta}),i.d(t,"entity",function(){return ia}),i.d(t,"webgl",function(){return sa}),i.d(t,"jd",function(){return a}),i.d(t,"math",function(){return r}),i.d(t,"mercator",function(){return s}),i.d(t,"utils",function(){return n}),i.d(t,"input",function(){return gn}),i.d(t,"wgs84",function(){return dn}),i.d(t,"Camera",function(){return Hs}),i.d(t,"Ellipsoid",function(){return un}),i.d(t,"PlanetCamera",function(){return Ys}),i.d(t,"Globe",function(){return Dn}),i.d(t,"LightSource",function(){return Nn}),i.d(t,"EntityCollection",function(){return Fr}),i.d(t,"Handler",function(){return ci}),i.d(t,"Renderer",function(){return bn}),i.d(t,"Clock",function(){return ai}),i.d(t,"Events",function(){return ni}),i.d(t,"Extent",function(){return Oe}),i.d(t,"LonLat",function(){return De}),i.d(t,"Planet",function(){return pn}),i.d(t,"RenderNode",function(){return rn}),i.d(t,"Line2",function(){return Kn}),i.d(t,"Line3",function(){return Jn}),i.d(t,"Mat3",function(){return Ue}),i.d(t,"Mat4",function(){return He}),i.d(t,"Plane",function(){return $n}),i.d(t,"Quat",function(){return We}),i.d(t,"Ray",function(){return Xs}),i.d(t,"Vec2",function(){return Xe}),i.d(t,"Vec3",function(){return Ge}),i.d(t,"Vec4",function(){return Ve});const ea={CanvasTiles:Un,GeoImage:class extends Hn{constructor(e,t){super(e,t),this._image=t.image||null,this._src=t.src||null}setSrc(e){this._planet&&this._planet._geoImageCreator.remove(this),this._src=e,this._sourceReady=!1}setImage(e){this._planet&&this._planet._geoImageCreator.remove(this),this._image=e,this._src=e.src,this._sourceReady=!1}_createSourceTexture(){this._sourceCreated||(this._sourceTexture=this._planet.renderer.handler.createTexture_n(this._image),this._sourceCreated=!0)}_onLoad(e){this._frameWidth=e.width,this._frameHeight=e.height,this._sourceReady=!0,this._planet._geoImageCreator.add(this)}loadMaterial(e){if(e.isLoading=!0,this._creationProceeding=!0,!this._sourceReady&&this._src)if(this._image){if(this._image.complete)this._onLoad(this._image);else if(this._image.src){var t=this;this._image.addEventListener("load",function(e){t._onLoad(this)})}}else t=this,this._image=new Image,this._image.addEventListener("load",function(e){t._onLoad(this)}),this._image.src=this._src;else this._planet._geoImageCreator.add(this)}abortMaterialLoading(e){this._image&&(this._image.src=""),this._creationProceeding=!1,e.isLoading=!1,e.isReady=!1}_renderingProjType1(){var e=this._planet,t=e.renderer.handler,i=t.gl,r=e._geoImageCreator;this._refreshFrame&&this._createFrame(),this._createSourceTexture();var s=r._framebuffer;s.setSize(this._frameWidth,this._frameHeight),s.activate(),t.shaderPrograms.geoImageTransform.activate();var n=t.shaderPrograms.geoImageTransform._program,a=n.attributes,o=n.uniforms,h=this.transparentColor[0],l=this.transparentColor[1],u=this.transparentColor[2];i.disable(i.CULL_FACE),s.bindOutputTexture(this._materialTexture),i.clearColor(h,l,u,0),i.clear(i.COLOR_BUFFER_BIT),i.bindBuffer(i.ARRAY_BUFFER,r._texCoordsBuffer),i.vertexAttribPointer(a.texCoords._pName,r._texCoordsBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._gridBuffer),i.vertexAttribPointer(a.corners._pName,this._gridBuffer.itemSize,i.FLOAT,!1,0,0),i.uniform4fv(o.extentParams._pName,this._extentMercParams),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this._sourceTexture),i.uniform1i(o.sourceTexture._pName,0),n.drawIndexBuffer(i.TRIANGLE_STRIP,r._indexBuffer),s.deactivate(),i.enable(i.CULL_FACE),this._ready=!0,this._creationProceeding=!1}_renderingProjType0(){var e=this._planet,t=e.renderer.handler,i=t.gl,r=e._geoImageCreator;this._refreshFrame&&this._createFrame(),this._createSourceTexture();var s=r._framebuffer;s.setSize(this._frameWidth,this._frameHeight),s.activate(),t.shaderPrograms.geoImageTransform.activate();var n=t.shaderPrograms.geoImageTransform._program,a=n.attributes,o=n.uniforms,h=this.transparentColor[0],l=this.transparentColor[1],u=this.transparentColor[2];i.disable(i.CULL_FACE),s.bindOutputTexture(this._materialTexture),i.clearColor(h,l,u,0),i.clear(i.COLOR_BUFFER_BIT),i.bindBuffer(i.ARRAY_BUFFER,r._texCoordsBuffer),i.vertexAttribPointer(a.texCoords._pName,r._texCoordsBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._gridBuffer),i.vertexAttribPointer(a.corners._pName,this._gridBuffer.itemSize,i.FLOAT,!1,0,0),i.uniform4fv(o.extentParams._pName,this._extentWgs84Params),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this._sourceTexture),i.uniform1i(o.sourceTexture._pName,0),n.drawIndexBuffer(i.TRIANGLE_STRIP,r._indexBuffer),s.deactivate(),i.enable(i.CULL_FACE),this._ready=!0,this._creationProceeding=!1}},GeoTexture2d:class extends Hn{constructor(e,t){super(e,t),this._sourceTexture=t.texture||null,t.texture&&(this._sourceReady=!0,this._sourceCreated=!0),this._frameWidth=t.frameWidth?oe(t.frameWidth):256,this._frameHeight=t.frameHeight?oe(t.frameHeight):256,this._animate=!0}loadMaterial(e){this._planet._geoImageCreator.add(this)}bindTexture(e){this._sourceReady=!0,this._sourceCreated=!0,this._sourceTexture=e}setSize(e,t){this._frameWidth=e,this._frameHeight=t,this._frameCreated=!1}abortMaterialLoading(e){this._creationProceeding=!1,e.isLoading=!1,e.isReady=!1}_renderingProjType1(){var e=this._planet,t=e.renderer.handler,i=t.gl,r=e._geoImageCreator;this._refreshFrame&&this._createFrame();var s=r._framebuffer;s.setSize(this._frameWidth,this._frameHeight),s.activate(),t.shaderPrograms.geoImageTransform.activate();var n=t.shaderPrograms.geoImageTransform._program,a=n.attributes,o=n.uniforms,h=this.transparentColor[0],l=this.transparentColor[1],u=this.transparentColor[2];i.disable(i.CULL_FACE),s.bindOutputTexture(this._materialTexture),i.clearColor(h,l,u,0),i.clear(i.COLOR_BUFFER_BIT),i.bindBuffer(i.ARRAY_BUFFER,r._texCoordsBuffer),i.vertexAttribPointer(a.texCoords._pName,r._texCoordsBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._gridBuffer),i.vertexAttribPointer(a.corners._pName,this._gridBuffer.itemSize,i.FLOAT,!1,0,0),i.uniform4fv(o.extentParams._pName,this._extentMercParams),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this._sourceTexture),i.uniform1i(o.sourceTexture._pName,0),n.drawIndexBuffer(i.TRIANGLE_STRIP,r._indexBuffer),s.deactivate(),i.enable(i.CULL_FACE),this._ready=!0,this._creationProceeding=!1}_renderingProjType0(){var e=this._planet,t=e.renderer.handler,i=t.gl,r=e._geoImageCreator,s=this._frameWidth,n=this._frameHeight;this._refreshFrame&&this._createFrame();var a=r._framebuffer;a.setSize(s,n),a.activate(),t.shaderPrograms.geoImageTransform.activate();var o=t.shaderPrograms.geoImageTransform._program,h=o.attributes,l=o.uniforms,u=this.transparentColor[0],d=this.transparentColor[1],c=this.transparentColor[2];i.disable(i.CULL_FACE),a.bindOutputTexture(this._materialTexture),i.clearColor(u,d,c,0),i.clear(i.COLOR_BUFFER_BIT),i.bindBuffer(i.ARRAY_BUFFER,r._texCoordsBuffer),i.vertexAttribPointer(h.texCoords._pName,r._texCoordsBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._gridBuffer),i.vertexAttribPointer(h.corners._pName,this._gridBuffer.itemSize,i.FLOAT,!1,0,0),i.uniform4fv(l.extentParams._pName,this._extentWgs84Params),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this._sourceTexture),i.uniform1i(l.sourceTexture._pName,0),o.drawIndexBuffer(i.TRIANGLE_STRIP,r._indexBuffer),a.deactivate(),i.enable(i.CULL_FACE),this._ready=!0,this._creationProceeding=!1}},GeoVideo:class extends Hn{constructor(e,t){super(e,t),this._animate=!0,this._video=t.videoElement||null,this._src=t.src||null}setSrc(e){this._planet&&this._planet._geoImageCreator.remove(this),this._src=e,this._sourceReady=!1}setVideoElement(e){this._planet&&this._planet._geoImageCreator.remove(this),this._video=e,this._src=e.src,this._sourceReady=!1}setVisibility(e){e!=this._visibility&&(this._visibility=e,this._isBaseLayer&&e&&this._planet.setBaseLayer(this),this._planet.updateVisibleLayers(),this.events.dispatch(this.events.visibilitychange,this),e?(this._sourceReady&&this._planet._geoImageCreator.add(this),this._video&&this._video.play()):(this._sourceReady&&this._planet._geoImageCreator.remove(this),this._video&&this._video.pause()))}_createSourceTexture(){if(this._sourceCreated){var e=this._planet.renderer.handler.gl;e.bindTexture(e.TEXTURE_2D,this._sourceTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this._video)}else this._sourceTexture=this._planet.renderer.handler.createTexture_n(this._video),this._sourceCreated=!0}_onCanPlay(e){this._frameWidth=e.videoWidth,this._frameHeight=e.videoHeight,e.width=e.videoWidth,e.height=e.videoHeight,e.play(),this._sourceReady=!0,this._planet._geoImageCreator.add(this)}_onError(e){var t="unknown error";switch(e.error.code){case 1:t="video loading aborted";break;case 2:t="network loading error";break;case 3:t="video decoding failed / corrupted data or unsupported codec";break;case 4:t="video not supported"}console.log("Error: "+t+" (errorcode="+e.error.code+")")}loadMaterial(e){if(e.isLoading=!0,this._creationProceeding=!0,!this._sourceReady&&this._src){if(this._video){if(this._video.readyState===this._video.HAVE_ENOUGH_DATA)this._onCanPlay(this._video);else if(this._video.src){var t=this;this._video.addEventListener("canplay",function(e){t._onCanPlay(this)})}}else this._video=document.createElement("video"),t=this,this._video.addEventListener("canplay",function(){t._onCanPlay(this)}),this._video.addEventListener("error",function(){t._onError(this)});this._video.autoplay=!0,this._video.loop=!0,this._video.src=this._src,this._video.setAttribute("playsinline",""),this._video.setAttribute("webkit-playsinline","")}else this._planet._geoImageCreator.add(this)}abortMaterialLoading(e){this._video&&(this._video.src=""),this._creationProceeding=!1,e.isLoading=!1,e.isReady=!1}_renderingProjType1(){var e=this._planet,t=e.renderer.handler,i=t.gl,r=e._geoImageCreator;this._refreshFrame&&this._createFrame(),this._sourceCreated?((i=this._planet.renderer.handler.gl).bindTexture(i.TEXTURE_2D,this._sourceTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,this._video)):(this._sourceTexture=this._planet.renderer.handler.createTexture_n(this._video),this._sourceCreated=!0);var s=r._framebuffer;s.setSize(this._frameWidth,this._frameHeight),s.activate(),t.shaderPrograms.geoImageTransform.activate();var n=t.shaderPrograms.geoImageTransform._program,a=n.attributes,o=n.uniforms,h=this.transparentColor[0],l=this.transparentColor[1],u=this.transparentColor[2];i.disable(i.CULL_FACE),s.bindOutputTexture(this._materialTexture),i.clearColor(h,l,u,0),i.clear(i.COLOR_BUFFER_BIT),i.bindBuffer(i.ARRAY_BUFFER,r._texCoordsBuffer),i.vertexAttribPointer(a.texCoords._pName,r._texCoordsBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._gridBuffer),i.vertexAttribPointer(a.corners._pName,this._gridBuffer.itemSize,i.FLOAT,!1,0,0),i.uniform4fv(o.extentParams._pName,this._extentMercParams),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this._sourceTexture),i.uniform1i(o.sourceTexture._pName,0),n.drawIndexBuffer(i.TRIANGLE_STRIP,r._indexBuffer),s.deactivate(),i.enable(i.CULL_FACE),this._ready=!0,this._creationProceeding=!1}_renderingProjType0(){var e=this._planet,t=e.renderer.handler,i=t.gl,r=e._geoImageCreator;this._refreshFrame&&this._createFrame(),this._sourceCreated?((i=this._planet.renderer.handler.gl).bindTexture(i.TEXTURE_2D,this._sourceTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,this._video)):(this._sourceTexture=this._planet.renderer.handler.createTexture_n(this._video),this._sourceCreated=!0);var s=r._framebuffer;s.setSize(this._frameWidth,this._frameHeight),s.activate(),t.shaderPrograms.geoImageTransform.activate();var n=t.shaderPrograms.geoImageTransform._program,a=n.attributes,o=n.uniforms,h=this.transparentColor[0],l=this.transparentColor[1],u=this.transparentColor[2];i.disable(i.CULL_FACE),s.bindOutputTexture(this._materialTexture),i.clearColor(h,l,u,0),i.clear(i.COLOR_BUFFER_BIT),i.bindBuffer(i.ARRAY_BUFFER,r._texCoordsBuffer),i.vertexAttribPointer(a.texCoords._pName,r._texCoordsBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._gridBuffer),i.vertexAttribPointer(a.corners._pName,this._gridBuffer.itemSize,i.FLOAT,!1,0,0),i.uniform4fv(o.extentParams._pName,this._extentWgs84Params),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this._sourceTexture),i.uniform1i(o.sourceTexture._pName,0),n.drawIndexBuffer(i.TRIANGLE_STRIP,r._indexBuffer),s.deactivate(),i.enable(i.CULL_FACE),this._ready=!0,this._creationProceeding=!1}},Layer:Es,Vector:Ps,WMS:Xn,XYZ:Wn},ta={BaseControl:Tn,EarthCoordinates:Mn,GeoImageDragControl:class extends Tn{constructor(e){super(e),e=e||{},this._cornerIndex=-1,this._catchCorner=!1}oninit(){var e=this,t=this.planet;t.events.on("layeradd",function(i){i instanceof Hn&&(i.events.on("mousemove",function(r){if(e._active)if(e._catchCorner){var s=i.getCornersLonLat();s[e._cornerIndex]=t.getLonLatFromPixelTerrain(r,!0),i.setCornersLonLat(s)}else{e._cornerIndex=-1;for(var n=0;n<i._cornersWgs84.length;n++){var a=t.getLonLatFromPixelTerrain(r,!0);if(a&&t.ellipsoid.getGreatCircleDistance(i._cornersWgs84[n],a)/t.getDistanceFromPixel(r,!0)<=.05){e._cornerIndex=n;break}}}}),i.events.on("ldown",function(i){e._active&&-1!=e._cornerIndex&&(e._catchCorner=!0,t.renderer.controls.mouseNavigation.deactivate())}),i.events.on("lup",function(i){e._active&&(e._catchCorner=!1,t.renderer.controls.mouseNavigation.activate())}))})}},KeyboardNavigation:Yn,LayerSwitcher:jn,MouseNavigation:Pn,ToggleWireframe:class extends Tn{constructor(e){super(e)}oninit(){this.renderer.events.on("charkeypress",gn.KEY_X,this.toogleWireframe,this)}toogleWireframe(e){this.planet.drawMode===this.renderer.handler.gl.LINE_STRIP?this.planet.setDrawMode(this.renderer.handler.gl.TRIANGLE_STRIP):this.planet.setDrawMode(this.renderer.handler.gl.LINE_STRIP)}},TouchNavigation:Bn,SimpleNavigation:qn,ShowFps:Zn,Sun:In,ZoomControl:Fn},ia={Entity:hr,Billboard:ji,Geometry:Zi,Label:Ji,PointCloud:nr,Polyline:tr},ra={EmptyTerrain:ri,GlobusTerrain:class extends ri{constructor(e,t){super(),t=t||{},this.name=e||"",this.minZoom=t.minZoom||3,this.maxZoom=t.maxZoom||14,this.url=t.url||"http://earth3.openglobus.org/{z}/{y}/{x}.ddm",this.gridSizeByZoom=t.gridSizeByZoom||[64,32,32,16,16,8,8,8,8,16,16,16,16,32,32,32,32,32,32,32,32],this.fileGridSize=t.fileGridSize||32,this.responseType=t.responseType||"arraybuffer",this.MAX_LOADING_TILES=t.MAX_LOADING_TILES||8,this.events=new ni(Qn),this._elevationCache={},this._counter=0,this._pendingsQueue=new Ms,this._urlRewriteCallback=null}abort(){this._pendingsQueue.length=0}setUrl(e){this.url=e}setName(e){this.name=e}handleSegmentTerrain(e){if(this._planet.terrainLock.isFree()){if(e.terrainReady=!1,e.terrainIsLoading=!0,e._projection.id===Wi.id){var t=this._elevationCache[e.getTileIndex()];t?this._applyElevationsData(e,t,!0):this._counter>=this.MAX_LOADING_TILES?this._pendingsQueue.push(e):this._exec(e)}}else e.terrainIsLoading=!1}_createUrl(e){return Je(this.url,{x:e.tileX.toString(),y:e.tileY.toString(),z:e.tileZoom.toString()})}_getHTTPRequestString(e){var t=this._createUrl(e);return this._urlRewriteCallback?this._urlRewriteCallback(e,t):t}setUrlRewriteCallback(e){this._urlRewriteCallback=e}getElevations(e){return new Float32Array(e)}_exec(e){this._counter++,o.request(this._getHTTPRequestString(e),{responseType:this.responseType,sender:this,success:function(t){this._elevationCache[e.getTileIndex()]=t,this._applyElevationsData(e,t)},error:function(){this._applyElevationsData(e,[])},abort:function(){e.terrainIsLoading=!1}})}_applyElevationsData(e,t,i){if(e){var r=this.getElevations(t),s=this.events.load;s.length&&this.events.dispatch(s,{elevations:r,segment:e}),e.applyTerrain(r)}!i&&this._dequeueRequest()}_dequeueRequest(){var e;this._counter--,this._pendingsQueue.length?this._counter<this.MAX_LOADING_TILES&&(e=this._whilePendings())&&this._exec.call(this,e):0===this._counter&&this.events.dispatch(this.events.loadend)}_whilePendings(){for(;this._pendingsQueue.length;){var e=this._pendingsQueue.pop();if(e.node){if(e.ready&&e.node.getState()!==bi)return e;e.terrainIsLoading=!1}}return null}abortLoading(){this._pendingsQueue.each(function(e){e&&(e.terrainIsLoading=!1)}),this._pendingsQueue.clear()}}},sa={Framebuffer:Gi,Handler:ci,MultiFramebuffer:vn,types:fi,ShaderProgram:vi}},5:function(e,t){}})});