!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("og",[],e):"object"==typeof exports?exports.og=e():t.og=e()}(window,function(){return function(t){var e={};function i(r){if(e[r])return e[r].exports;var n=e[r]={i:r,l:!1,exports:{}};return t[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=t,i.c=e,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(r,n,function(e){return t[e]}.bind(null,n));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);var r={};i.r(r),i.d(r,"TWO_PI",function(){return l}),i.d(r,"PI_TWO",function(){return u}),i.d(r,"X",function(){return c}),i.d(r,"Y",function(){return _}),i.d(r,"Z",function(){return f}),i.d(r,"W",function(){return d}),i.d(r,"MAX_FLOAT",function(){return p}),i.d(r,"LOG2",function(){return v}),i.d(r,"MAX32",function(){return g}),i.d(r,"MAX",function(){return m}),i.d(r,"MIN",function(){return b}),i.d(r,"RADIANS",function(){return A}),i.d(r,"DEGREES",function(){return C}),i.d(r,"DEGREES_DOUBLE",function(){return E}),i.d(r,"RADIANS_HALF",function(){return T}),i.d(r,"ARCSECONDS_TO_RADIANS",function(){return B}),i.d(r,"RADIANS_TO_HOURS",function(){return P}),i.d(r,"HOURS_TO_RADIANS",function(){return R}),i.d(r,"HOURS_TO_DEGREES",function(){return L}),i.d(r,"DEGREES_TO_HOURS",function(){return M}),i.d(r,"SQRT_HALF",function(){return F}),i.d(r,"EPSILON1",function(){return D}),i.d(r,"EPSILON2",function(){return S}),i.d(r,"EPSILON3",function(){return N}),i.d(r,"EPSILON4",function(){return k}),i.d(r,"EPSILON5",function(){return I}),i.d(r,"EPSILON6",function(){return O}),i.d(r,"EPSILON7",function(){return U}),i.d(r,"EPSILON8",function(){return H}),i.d(r,"EPSILON9",function(){return V}),i.d(r,"EPSILON10",function(){return W}),i.d(r,"EPSILON11",function(){return X}),i.d(r,"EPSILON12",function(){return Y}),i.d(r,"EPSILON13",function(){return j}),i.d(r,"EPSILON14",function(){return G}),i.d(r,"EPSILON15",function(){return q}),i.d(r,"EPSILON16",function(){return K}),i.d(r,"EPSILON17",function(){return Z}),i.d(r,"EPSILON18",function(){return Q}),i.d(r,"EPSILON19",function(){return J}),i.d(r,"EPSILON20",function(){return $}),i.d(r,"log",function(){return tt}),i.d(r,"clamp",function(){return et}),i.d(r,"DEG2RAD",function(){return it}),i.d(r,"RAD2DEG",function(){return rt}),i.d(r,"isPowerOfTwo",function(){return nt}),i.d(r,"nextHighestPowerOfTwo",function(){return st}),i.d(r,"randomi",function(){return ot}),i.d(r,"random",function(){return at}),i.d(r,"degToDec",function(){return ht}),i.d(r,"mod",function(){return lt}),i.d(r,"zeroTwoPI",function(){return ut}),i.d(r,"step",function(){return ct}),i.d(r,"frac",function(){return _t}),i.d(r,"log2",function(){return ft}),i.d(r,"exp2",function(){return dt}),i.d(r,"pow2i",function(){return pt}),i.d(r,"slice",function(){return vt}),i.d(r,"lerp",function(){return gt}),i.d(r,"bezier",function(){return mt}),i.d(r,"rev",function(){return yt}),i.d(r,"norm_lon",function(){return xt}),i.d(r,"negativePItoPI",function(){return bt}),i.d(r,"solve_iteration_fixed",function(){return At}),i.d(r,"solve_iteration",function(){return Ct});var n={};i.r(n),i.d(n,"getDefault",function(){return jt}),i.d(n,"isEmpty",function(){return Gt}),i.d(n,"stamp",function(){return Kt}),i.d(n,"isString",function(){return Zt}),i.d(n,"readTextFile",function(){return Qt}),i.d(n,"htmlColorToRgba",function(){return Jt}),i.d(n,"htmlColorToFloat32Array",function(){return $t}),i.d(n,"htmlColorToRgb",function(){return te}),i.d(n,"stringTemplate",function(){return ee}),i.d(n,"print2d",function(){return ie}),i.d(n,"defaultString",function(){return re}),i.d(n,"createVector3",function(){return ne}),i.d(n,"createVector4",function(){return se}),i.d(n,"createColorRGBA",function(){return oe}),i.d(n,"createColorRGB",function(){return ae}),i.d(n,"createExtent",function(){return he}),i.d(n,"createLonLat",function(){return le}),i.d(n,"binarySearch",function(){return ue}),i.d(n,"binaryInsert",function(){return ce}),i.d(n,"getLinesIntersection2v",function(){return _e}),i.d(n,"getLinesIntersectionLonLat",function(){return fe}),i.d(n,"xmlToJson",function(){return de}),i.d(n,"castType",function(){return pe}),i.d(n,"base64toBlob",function(){return ve}),i.d(n,"cartesianToBarycentricLonLat",function(){return ge}),i.d(n,"throttle",function(){return me});var s={};i.r(s),i.d(s,"SECONDS_PER_MILLISECOND",function(){return ye}),i.d(s,"MILLISECONDS_PER_SECOND",function(){return xe}),i.d(s,"SECONDS_PER_MINUTE",function(){return be}),i.d(s,"ONE_BY_SECONDS_PER_MINUTE",function(){return Ae}),i.d(s,"MINUTES_PER_HOUR",function(){return Ce}),i.d(s,"HOURS_PER_DAY",function(){return we}),i.d(s,"ONE_BY_HOURS_PER_DAY",function(){return Ee}),i.d(s,"SECONDS_PER_HOUR",function(){return Te}),i.d(s,"ONE_BY_SECONDS_PER_HOUR",function(){return Be}),i.d(s,"SECONDS_PER_12_HOURS",function(){return Pe}),i.d(s,"MINUTES_PER_DAY",function(){return Re}),i.d(s,"ONE_BY_MINUTES_PER_DAY",function(){return ze}),i.d(s,"SECONDS_PER_DAY",function(){return Le}),i.d(s,"MILLISECONDS_PER_DAY",function(){return Me}),i.d(s,"ONE_BY_MILLISECONDS_PER_DAY",function(){return Fe}),i.d(s,"ONE_BY_SECONDS_PER_DAY",function(){return De}),i.d(s,"DAYS_PER_JULIAN_CENTURY",function(){return Se}),i.d(s,"DAYS_PER_JULIAN_YEAR",function(){return Ne}),i.d(s,"PICOSECOND",function(){return ke}),i.d(s,"MODIFIED_JULIAN_DATE_DIFFERENCE",function(){return Ie}),i.d(s,"J2000",function(){return Oe}),i.d(s,"T",function(){return Ue}),i.d(s,"getDayNumber",function(){return He}),i.d(s,"DateToUTC",function(){return Ve}),i.d(s,"DateToTAI",function(){return We}),i.d(s,"UTCtoTAI",function(){return Xe}),i.d(s,"TAItoUTC",function(){return Ye}),i.d(s,"UTCtoDate",function(){return je}),i.d(s,"TAItoDate",function(){return Ge}),i.d(s,"addMilliseconds",function(){return qe}),i.d(s,"addSeconds",function(){return Ke}),i.d(s,"addHours",function(){return Ze}),i.d(s,"addMinutes",function(){return Qe}),i.d(s,"addDays",function(){return Je}),i.d(s,"getMilliseconds",function(){return $e}),i.d(s,"getSeconds",function(){return ti}),i.d(s,"getHours",function(){return ei}),i.d(s,"getMinutes",function(){return ii}),i.d(s,"getDays",function(){return ri}),i.d(s,"secondsToDays",function(){return ni}),i.d(s,"daysToSeconds",function(){return si}),i.d(s,"J2000TAI",function(){return hi});const o={ReadyState:{Uninitialized:0,Loading:1,Loaded:2,Interactive:3,Complete:4},Status:{OK:200,Created:201,Accepted:202,NoContent:204,BadRequest:400,Forbidden:403,NotFound:404,Gone:410,ServerError:500},Method:{Get:"GET",Post:"POST"},Asynchronous:!0,Synchronous:!1},a={type:o.Method.Get,async:o.Asynchronous,data:null,sender:null,responseType:"text"};o.request=function(t,e){e=e||{};var i,r={};for(i in a)r[i]=a[i];for(i in e)r[i]=e[i];r.data=e.data;var n,s=function(){if(void 0!==typeof XMLHttpRequest)return new XMLHttpRequest;if(window.ActiveXObject)for(var t=["MSXML2.XMLHttp.5.0","MSXML2.XMLHttp.4.0","MSXML2.XMLHttp.3.0","MSXML2.XMLHttp","Microsoft.XMLHttp"],e=0;e<t.length;e++)try{return new ActiveXObject(t[e])}catch(t){console.log("error: og.ajax.createXMLHttp creation filed.")}}(),h=new function(t){var e=t;this.abort=function(){e.aborted=!0,e.abort()}}(s),l=null;if(r.type===o.Method.Post){if(r.data){l="";for(let t in r.data)n=r.data[t],l+=t+"="+encodeURIComponent(n instanceof Object?JSON.stringify(n):n)+"&";l=l.slice(0,-1)}s.open(r.type,t,r.async),s.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}else if(r.data){var u="?";for(let t in r.data)n=r.data[t],u+=t+"="+encodeURIComponent(n instanceof Object?JSON.stringify(n):n)+"&";u=u.slice(0,-1),s.open(r.type,t+u,r.async)}else s.open(r.type,t,r.async);return r.async&&(s.responseType=r.responseType),s.overrideMimeType("text/plain"),s.onreadystatechange=function(){s.readyState===o.ReadyState.Complete&&(s.status===o.Status.OK?e.success&&e.success.call(e.sender||h,s.response):s.aborted?e.abort&&e.abort.call(e.sender||h,s.response,s.status):e.error&&e.error.call(e.sender||h,s.response,s.status),delete s.onreadystatechange,s.onreadystatechange=null,s=null)},s.send(l),h};const h={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},l=2*Math.PI,u=Math.PI/2,c=0,_=1,f=2,d=3,p=Number.MAX_VALUE||1.7976931348623157e308,v=Math.log(2),g=2147483647,m=549755748352,b=-m,A=Math.PI/180,C=180/Math.PI,E=2*C,T=.5*A,B=484813681109536e-20,P=3.819718634205488,R=.26179938779914946,L=15,M=1/15,F=Math.sqrt(.5),D=.1,S=.01,N=.001,k=1e-4,I=1e-5,O=1e-6,U=1e-7,H=1e-8,V=1e-9,W=1e-10,X=1e-11,Y=1e-12,j=1e-13,G=1e-14,q=1e-15,K=1e-16,Z=1e-17,Q=1e-18,J=1e-19,$=1e-20;function tt(t,e){return Math.log(t)/Math.log(e)}function et(t,e,i){return Math.max(e,Math.min(t,i))}function it(t){return t*A}function rt(t){return t*C}function nt(t){return 0==(t&t-1)}function st(t){--t;for(var e=1;e<32;e<<=1)t|=t>>e;return t+1}function ot(t,e){return Math.floor(Math.random()*(e-t))+t}function at(t,e){return Math.random()*(e-t)+t}function ht(t,e,i,r){return r?t+e/60+i/3600:-t-e/60-i/3600}function lt(t,e){return(t%e+e)%e}function ut(t){var e=og.math.mod(t,og.math.TWO_PI);return Math.abs(e)<og.math.EPSILON14&&Math.abs(t)>og.math.EPSILON14?og.math.TWO_PI:e}function ct(t,e){return e<t?0:1}function _t(t){return t-Math.floor(t)}function ft(t){return Math.log(t)/og.math.LOG2}function dt(t){return Math.pow(2,t)}function pt(t){return 2<<t-1}function vt(t,e,i){return t*(e-i)}function gt(t,e,i){return i+t*(e-i)}function mt(t,e,i,r,n){var s=1-t,o=t*t,a=s*s,h=a*s,l=o*t;return e.scaleTo(h).addA(i.scaleTo(3*a*t)).addA(r.scaleTo(3*s*o)).addA(n.scaleTo(l))}function yt(t){return t-360*Math.floor(t/360)}function xt(t){return t>180?(t+180)%360-180:t<-180?(t-180)%360+180:t}function bt(t){return og.math.zeroTwoPI(t+Math.PI)-Math.PI}function At(t,e,i){for(var r=e,n=0;n<i;n++)r=t(r);return r}function Ct(t,e,i,r){r=r||50;for(var n=0,s=e,o=0;o<r;o++)if(s=t(n=s),Math.abs(s-n)<i)return s;return s}const wt=.5*Math.PI,Et=(Math.PI,180/Math.PI),Tt=2*Et,Bt=Math.PI/360,Pt=Et*wt,Rt=function(t,e,i){this.lon=t||0,this.lat=e||0,this.height=i||0};Rt.prototype.isZero=function(){return 0===this.lon&&0===this.lat&&0===this.height},Rt.join=function(t){for(var e=[],i=0;i<t.length;i++){var r=t[i];e[i]=new Rt(r[0],r[1],r[2])}return e},Rt.createFromArray=function(t){return new Rt(t[0],t[1],t[2])},Rt.forwardMercator=function(t,e,i){return new Rt(t*Dt,Math.log(Math.tan((90+e)*Bt))*Mt,i)},Rt.inverseMercator=function(t,e,i){return new Rt(t*St,Tt*Math.atan(Math.exp(e*Lt))-Pt,i)},Rt.prototype.set=function(t,e,i){return this.lon=t||0,this.lat=e||0,this.height=i||0,this},Rt.prototype.copy=function(t){return this.lon=t.lon,this.lat=t.lat,this.height=t.height,this},Rt.prototype.clone=function(){return new Rt(this.lon,this.lat,this.height)},Rt.prototype.forwardMercator=function(){return Rt.forwardMercator(this.lon,this.lat,this.height)},Rt.prototype.forwardMercatorEPS01=function(){var t=this.lat;return t>89.9?t=89.9:t<-89.9&&(t=-89.9),new Rt(this.lon*Dt,Math.log(Math.tan((90+t)*Bt))*Mt)},Rt.prototype.inverseMercator=function(){return Rt.inverseMercator(this.lon,this.lat,this.height)},Rt.prototype.equal=function(t){return t.height?this.lon===t.lon&&this.lat===t.lat&&this.height===t.height:this.lon===t.lon&&this.lat===t.lat};const zt=20037508.34,Lt=Math.PI/zt,Mt=zt/Math.PI,Ft=.5*Math.PI,Dt=zt/180,St=180/zt,Nt=(Math.PI,Math.PI,180/Math.PI),kt=2*zt;const It=function(t){return Nt*(2*Math.atan(Math.exp(t*Lt))-Ft)}(zt),Ot=function(t,e){this.southWest=t||new Rt,this.northEast=e||new Rt};Ot.FULL_MERC=new Ot(Rt.SW_MERC,Rt.NE_MERC),Ot.NORTH_POLE_DEG=new Ot(Rt.NW_MERC_DEG,new Rt(180,90)),Ot.SOUTH_POLE_DEG=new Ot(new Rt(-180,-90),Rt.SE_MERC_DEG),Ot.createFromArray=function(t){return new Ot(new Rt(t[0],t[1]),new Rt(t[2],t[3]))},Ot.createByCoordinates=function(t){for(var e=m,i=b,r=m,n=b,s=0;s<t.length;s++){var o=t[s];o.lon<e&&(e=o.lon),o.lon>i&&(i=o.lon),o.lat<r&&(r=o.lat),o.lat>n&&(n=o.lat)}return new Ot(new Rt(e,r),new Rt(i,n))},Ot.createByCoordinatesArr=function(t){for(var e=m,i=b,r=m,n=b,s=0;s<t.length;s++){var o=t[s];o[0]<e&&(e=o[0]),o[0]>i&&(i=o[0]),o[1]<r&&(r=o[1]),o[1]>n&&(n=o[1])}return new Ot(new Rt(e,r),new Rt(i,n))},Ot.fromTile=function(t,e,i,r,n){r=r||kt,n=n||kt;var s=Math.pow(2,i),o=r/Math.pow(2,i),a=n/s,h=.5*-r+t*o,l=.5*n-e*a,u=h+o;return new Ot(new Rt(h,l-a),new Rt(u,l))},Ot.prototype.setByCoordinates=function(t){for(var e=m,i=b,r=m,n=b,s=0;s<t.length;s++){var o=t[s];o.lon<e&&(e=o.lon),o.lon>i&&(i=o.lon),o.lat<r&&(r=o.lat),o.lat>n&&(n=o.lat)}return this.southWest.lon=e,this.southWest.lat=r,this.northEast.lon=i,this.northEast.lat=n,this},Ot.prototype.isInside=function(t){var e=this.southWest,i=this.northEast;return t.lon>=e.lon&&t.lon<=i.lon&&t.lat>=e.lat&&t.lat<=i.lat},Ot.prototype.overlaps=function(t){var e=this.southWest,i=this.northEast;return e.lon<=t.northEast.lon&&i.lon>=t.southWest.lon&&e.lat<=t.northEast.lat&&i.lat>=t.southWest.lat},Ot.prototype.getWidth=function(){return this.northEast.lon-this.southWest.lon},Ot.prototype.getHeight=function(){return this.northEast.lat-this.southWest.lat},Ot.prototype.clone=function(){return new Ot(this.southWest.clone(),this.northEast.clone())},Ot.prototype.getCenter=function(){var t=this.southWest,e=this.northEast;return new Rt(t.lon+.5*(e.lon-t.lon),t.lat+.5*(e.lat-t.lat))},Ot.prototype.getNorthWest=function(){return new Rt(this.southWest.lon,this.northEast.lat)},Ot.prototype.getNorthEast=function(){return new Rt(this.northEast.lon,this.northEast.lat)},Ot.prototype.getSouthWest=function(){return new Rt(this.southWest.lon,this.southWest.lat)},Ot.prototype.getSouthEast=function(){return new Rt(this.northEast.lon,this.southWest.lat)},Ot.prototype.getNorth=function(){return this.northEast.lat},Ot.prototype.getEast=function(){return this.northEast.lon},Ot.prototype.getWest=function(){return this.southWest.lon},Ot.prototype.getSouth=function(){return this.southWest.lat},Ot.prototype.equals=function(t){return this.southWest.lon===t.southWest.lon&&this.southWest.lat===t.southWest.lat&&this.northEast.lon===t.northEast.lon&&this.northEast.lat===t.northEast.lat},Ot.prototype.forwardMercator=function(){return new Ot(this.southWest.forwardMercator(),this.northEast.forwardMercator())},Ot.prototype.inverseMercator=function(){return new Ot(this.southWest.inverseMercator(),this.northEast.inverseMercator())},Ot.prototype.getCartesianBounds=function(t){for(var e=m,i=b,r=m,n=b,s=m,o=b,a=[new Rt(this.southWest.lon,this.southWest.lat),new Rt(this.southWest.lon,this.northEast.lat),new Rt(this.northEast.lon,this.northEast.lat),new Rt(this.northEast.lon,this.southWest.lat)],h=0;h<a.length;h++){var l=t.lonLatToCartesian(a[h]),u=l.x,c=l.y,_=l.z;u<e&&(e=u),u>i&&(i=u),c<r&&(r=c),c>n&&(n=c),_<s&&(s=_),_>o&&(o=_)}return[e,r,s,i,n,o]},Ot.prototype.toString=function(){return"["+this.southWest.lon+", "+this.southWest.lat+", "+this.northEast.lon+", "+this.northEast.lat+"]"};const Ut=function(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=r||0};Ut.identity=new Ut(0,0,0,1),Ut.fromVec=function(t){return new Ut(t[0],t[1],t[2],t[3])},Ut.prototype.toVec3=function(){return new Xt(this.x,this.y,this.z)},Ut.prototype.clone=function(t){return new Ut(this.x,this.y,this.z,this.w)},Ut.prototype.equal=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},Ut.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},Ut.prototype.toVec=function(){return[this.x,this.y,this.z,this.w]},Ut.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},Ut.prototype.set=function(t,e,i,r){return this.x=t,this.y=e,this.z=i,this.w=r,this},Ut.prototype.addA=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},Ut.prototype.subA=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},Ut.prototype.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},Ut.prototype.affinity=function(){var t=1/this.w;return this.x*=t,this.y*=t,this.z*=t,this.w=1,this},Ut.prototype.scaleTo=function(t){return new Ut(this.x*t,this.y*t,this.z*t,this.w*t)},Ut.prototype.getStep=function(t){return new Ut(this.x<t?0:1,this.y<t?0:1,this.z<t?0:1,this.w<t?0:1)},Ut.prototype.getFrac=function(t){return new Ut(og.math.frac(t.x),og.math.frac(t.y),og.math.frac(t.z),og.math.frac(t.w))},Ut.prototype.dot=function(t){return t.x*this.x+t.y*this.y+t.z*this.z+t.w*this.w};const Ht=function(){this._m=new Array(9)};Ht.prototype.set=function(t){return this._m[0]=t[0],this._m[1]=t[1],this._m[2]=t[2],this._m[3]=t[3],this._m[4]=t[4],this._m[5]=t[5],this._m[6]=t[6],this._m[7]=t[7],this._m[8]=t[8],this},Ht.prototype.clone=function(){var t=new Ht;return t.set(this),t},Ht.prototype.copy=function(t){return this.set(t._m)},Ht.prototype.transposeTo=function(){var t=new Ht,e=this._m;return t._m[0]=e[0],t._m[1]=e[3],t._m[2]=e[6],t._m[3]=e[1],t._m[4]=e[4],t._m[5]=e[7],t._m[6]=e[2],t._m[7]=e[5],t._m[8]=e[8],t},Ht.prototype.setIdentity=function(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=1,this._m[5]=0,this._m[6]=0,this._m[7]=0,this._m[8]=1,this},Ht.prototype.mulVec=function(t){var e=t.x,i=t.y,r=t.z,n=this._m;return new Xt(n[0]*e+n[3]*i+n[6]*r,n[1]*e+n[4]*i+n[7]*r,n[2]*e+n[5]*i+n[8]*r)},Ht.prototype.toMatrix4=function(){var t=new Vt,e=t._m,i=this._m;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=0,e[4]=i[3],e[5]=i[4],e[6]=i[5],e[7]=0,e[8]=i[6],e[9]=i[7],e[10]=i[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,t};const Vt=function(){this._m=new Array(16),this.left,this.right,this.bottom,this.top,this.near,this.far};Vt.identity=function(){var t=new Vt;return t._m[0]=1,t._m[1]=0,t._m[2]=0,t._m[3]=0,t._m[4]=0,t._m[5]=1,t._m[6]=0,t._m[7]=0,t._m[8]=0,t._m[9]=0,t._m[10]=1,t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t},Vt.prototype.set=function(t){return this._m[0]=t[0],this._m[1]=t[1],this._m[2]=t[2],this._m[3]=t[3],this._m[4]=t[4],this._m[5]=t[5],this._m[6]=t[6],this._m[7]=t[7],this._m[8]=t[8],this._m[9]=t[9],this._m[10]=t[10],this._m[11]=t[11],this._m[12]=t[12],this._m[13]=t[13],this._m[14]=t[14],this._m[15]=t[15],this},Vt.prototype.clone=function(){var t=new Vt;return t.set(this),t},Vt.prototype.copy=function(t){this.set(t._m)},Vt.prototype.toMatrix3=function(){var t=new Ht,e=this._m,i=t._m;return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[4],i[4]=e[5],i[5]=e[6],i[6]=e[8],i[7]=e[9],i[8]=e[10],t},Vt.prototype.mulVec3=function(t){var e=t.x,i=t.y,r=t.z;return new Xt(this._m[0]*e+this._m[4]*i+this._m[8]*r+this._m[12],this._m[1]*e+this._m[5]*i+this._m[9]*r+this._m[13],this._m[2]*e+this._m[6]*i+this._m[10]*r+this._m[14])},Vt.prototype.mulVec4=function(t){var e=t.x,i=t.y,r=t.z,n=t.w;return new Ut(this._m[0]*e+this._m[4]*i+this._m[8]*r+this._m[12]*n,this._m[1]*e+this._m[5]*i+this._m[9]*r+this._m[13]*n,this._m[2]*e+this._m[6]*i+this._m[10]*r+this._m[14]*n,this._m[3]*e+this._m[7]*i+this._m[11]*r+this._m[15]*n)},Vt.prototype.toInverseMatrix3=function(){var t=this._m,e=t[0],i=t[1],r=t[2],n=t[4],s=t[5],o=t[6],a=t[8],h=t[9],l=t[10],u=l*s-o*h,c=-l*n+o*a,_=h*n-s*a,f=e*u+i*c+r*_;if(!f)return null;f=1/f;var d=new Ht;return d._m[0]=u*f,d._m[1]=(-l*i+r*h)*f,d._m[2]=(o*i-r*s)*f,d._m[3]=c*f,d._m[4]=(l*e-r*a)*f,d._m[5]=(-o*e+r*n)*f,d._m[6]=_*f,d._m[7]=(-h*e+i*a)*f,d._m[8]=(s*e-i*n)*f,d},Vt.prototype.inverseTo=function(){var t=this._m[0],e=this._m[1],i=this._m[2],r=this._m[3],n=this._m[4],s=this._m[5],o=this._m[6],a=this._m[7],h=this._m[8],l=this._m[9],u=this._m[10],c=this._m[11],_=this._m[12],f=this._m[13],d=this._m[14],p=this._m[15],v=t*s-e*n,g=t*o-i*n,m=t*a-r*n,y=e*o-i*s,x=e*a-r*s,b=i*a-r*o,A=h*f-l*_,C=h*d-u*_,w=h*p-c*_,E=l*d-u*f,T=l*p-c*f,B=u*p-c*d,P=1/(v*B-g*T+m*E+y*w-x*C+b*A),R=new Vt;return R._m[0]=(s*B-o*T+a*E)*P,R._m[1]=(-e*B+i*T-r*E)*P,R._m[2]=(f*b-d*x+p*y)*P,R._m[3]=(-l*b+u*x-c*y)*P,R._m[4]=(-n*B+o*w-a*C)*P,R._m[5]=(t*B-i*w+r*C)*P,R._m[6]=(-_*b+d*m-p*g)*P,R._m[7]=(h*b-u*m+c*g)*P,R._m[8]=(n*T-s*w+a*A)*P,R._m[9]=(-t*T+e*w-r*A)*P,R._m[10]=(_*x-f*m+p*v)*P,R._m[11]=(-h*x+l*m-c*v)*P,R._m[12]=(-n*E+s*C-o*A)*P,R._m[13]=(t*E-e*C+i*A)*P,R._m[14]=(-_*y+f*g-d*v)*P,R._m[15]=(h*y-l*g+u*v)*P,R},Vt.prototype.transposeTo=function(){var t=new Vt;return t._m[0]=this._m[0],t._m[1]=this._m[4],t._m[2]=this._m[8],t._m[3]=this._m[12],t._m[4]=this._m[1],t._m[5]=this._m[5],t._m[6]=this._m[9],t._m[7]=this._m[13],t._m[8]=this._m[2],t._m[9]=this._m[6],t._m[10]=this._m[10],t._m[11]=this._m[14],t._m[12]=this._m[3],t._m[13]=this._m[7],t._m[14]=this._m[11],t._m[15]=this._m[15],t},Vt.prototype.setIdentity=function(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=0,this._m[5]=1,this._m[6]=0,this._m[7]=0,this._m[8]=0,this._m[9]=0,this._m[10]=1,this._m[11]=0,this._m[12]=0,this._m[13]=0,this._m[14]=0,this._m[15]=1,this},Vt.prototype.mul=function(t){let e=this._m[0],i=this._m[1],r=this._m[2],n=this._m[3],s=this._m[4],o=this._m[5],a=this._m[6],h=this._m[7],l=this._m[8],u=this._m[9],c=this._m[10],_=this._m[11],f=this._m[12],d=this._m[13],p=this._m[14],v=this._m[15],g=t._m[0],m=t._m[1],y=t._m[2],x=t._m[3],b=t._m[4],A=t._m[5],C=t._m[6],w=t._m[7],E=t._m[8],T=t._m[9],B=t._m[10],P=t._m[11],R=t._m[12],z=t._m[13],L=t._m[14],M=t._m[15];var F=new Vt;return F._m[0]=g*e+m*s+y*l+x*f,F._m[1]=g*i+m*o+y*u+x*d,F._m[2]=g*r+m*a+y*c+x*p,F._m[3]=g*n+m*h+y*_+x*v,F._m[4]=b*e+A*s+C*l+w*f,F._m[5]=b*i+A*o+C*u+w*d,F._m[6]=b*r+A*a+C*c+w*p,F._m[7]=b*n+A*h+C*_+w*v,F._m[8]=E*e+T*s+B*l+P*f,F._m[9]=E*i+T*o+B*u+P*d,F._m[10]=E*r+T*a+B*c+P*p,F._m[11]=E*n+T*h+B*_+P*v,F._m[12]=R*e+z*s+L*l+M*f,F._m[13]=R*i+z*o+L*u+M*d,F._m[14]=R*r+z*a+L*c+M*p,F._m[15]=R*n+z*h+L*_+M*v,F},Vt.prototype.translate=function(t){var e=t.x,i=t.y,r=t.z,n=this._m;return n[12]=n[0]*e+n[4]*i+n[8]*r+n[12],n[13]=n[1]*e+n[5]*i+n[9]*r+n[13],n[14]=n[2]*e+n[6]*i+n[10]*r+n[14],n[15]=n[3]*e+n[7]*i+n[11]*r+n[15],this},Vt.prototype.translateToPosition=function(t){var e=this._m;return e[12]=t.x,e[13]=t.y,e[14]=t.z,this},Vt.prototype.rotate=function(t,e){var i=Math.cos(e),r=Math.sin(e),n=new Vt,s=n._m;return s[0]=i+(1-i)*t.x*t.x,s[1]=(1-i)*t.y*t.x-r*t.z,s[2]=(1-i)*t.z*t.x+r*t.y,s[3]=0,s[4]=(1-i)*t.x*t.y+r*t.z,s[5]=i+(1-i)*t.y*t.y,s[6]=(1-i)*t.z*t.y-r*t.x,s[7]=0,s[8]=(1-i)*t.x*t.z-r*t.y,s[9]=(1-i)*t.y*t.z+r*t.x,s[10]=i+(1-i)*t.z*t.z,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this.mul(n)},Vt.prototype.setRotation=function(t,e){var i=Math.cos(e),r=Math.sin(e),n=this._m;return n[0]=i+(1-i)*t.x*t.x,n[1]=(1-i)*t.y*t.x-r*t.z,n[2]=(1-i)*t.z*t.x+r*t.y,n[3]=0,n[4]=(1-i)*t.x*t.y+r*t.z,n[5]=i+(1-i)*t.y*t.y,n[6]=(1-i)*t.z*t.y-r*t.x,n[7]=0,n[8]=(1-i)*t.x*t.z-r*t.y,n[9]=(1-i)*t.y*t.z+r*t.x,n[10]=i+(1-i)*t.z*t.z,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,this},Vt.prototype.rotateBetweenVectors=function(t,e){return Wt.getRotationBetweenVectors(t,e).getMat4()},Vt.prototype.scale=function(t){var e=this._m;return e[0]=e[0]*t.x,e[1]=e[1]*t.x,e[2]=e[2]*t.x,e[3]=e[3]*t.x,e[4]=e[4]*t.y,e[5]=e[5]*t.y,e[6]=e[6]*t.y,e[7]=e[7]*t.y,e[8]=e[8]*t.z,e[9]=e[9]*t.z,e[10]=e[10]*t.z,e[11]=e[11]*t.z,e[12]=e[12],e[13]=e[13],e[14]=e[14],e[15]=e[15],this},Vt.prototype.setFrustum=function(t,e,i,r,n,s){var o=e-t,a=r-i,h=s-n;return this._m[0]=2*n/o,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=0,this._m[5]=2*n/a,this._m[6]=0,this._m[7]=0,this._m[8]=(e+t)/o,this._m[9]=(r+i)/a,this._m[10]=-(s+n)/h,this._m[11]=-1,this._m[12]=0,this._m[13]=0,this._m[14]=-s*n*2/h,this._m[15]=0,this},Vt.prototype.setPerspective=function(t,e,i,r){return e*=t=i*Math.tan(t*Math.PI/360),this.setFrustum(-e,e,-t,t,i,r)},Vt.prototype.setOrtho=function(t,e,i,r,n,s){var o=1/(t-e),a=1/(i-r),h=1/(n-s),l=this._m;return l[0]=-2*o,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=-2*a,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=2*h,l[11]=0,l[12]=(t+e)*o,l[13]=(r+i)*a,l[14]=(s+n)*h,l[15]=1,this},Vt.prototype.eulerToMatrix=function(t,e,i){var r=Math.cos(t),n=Math.sin(t),s=Math.cos(e),o=Math.sin(e),a=Math.cos(i),h=Math.sin(i),l=r*o,u=n*o,c=this._m;return c[0]=s*a,c[1]=-s*h,c[2]=-o,c[4]=-u*a+r*h,c[5]=u*h+r*a,c[6]=-n*s,c[8]=l*a+n*h,c[9]=-l*h+n*a,c[10]=r*s,c[3]=c[7]=c[11]=c[12]=c[13]=c[14]=0,c[15]=1,this};const Wt=function(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=r||0};Wt.IDENTITY=new Wt(0,0,0,1),Wt.xRotation=function(t){return t*=.5,new Wt(Math.sin(t),0,0,Math.cos(t))},Wt.yRotation=function(t){return t*=.5,new Wt(0,Math.sin(t),0,Math.cos(t))},Wt.zRotation=function(t){return t*=.5,new Wt(0,0,Math.sin(t),Math.cos(t))},Wt.axisAngleToQuat=function(t,e){e=e||0;var i=t.normal(),r=.5*e,n=Math.sin(r);return new Wt(i.x*n,i.y*n,i.z*n,Math.cos(r))},Wt.getLookRotation=function(t,e){var i=t.normal().negate(),r=e.cross(i).normalize(),n=i.cross(r),s=1+r.x+n.y+i.z;if(s>1e-6){let t=1/(2*Math.sqrt(s));return new Wt((i.y-n.z)*t,(r.z-i.x)*t,(n.x-r.y)*t,.25/t)}if(r.x>n.y&&r.x>i.z){let t=1/(2*Math.sqrt(1+r.x-n.y-i.z));return new Wt(.25/t,(n.x+r.y)*t,(r.z+i.x)*t,(i.y-n.z)*t)}if(n.y>i.z){let t=1/(2*Math.sqrt(1+n.y-r.x-i.z));return new Wt((n.x+r.y)*t,.25/t,(i.y+n.z)*t,(r.z-i.x)*t)}let o=1/(2*Math.sqrt(1+i.z-r.x-n.y));return new Wt((r.z+i.x)*o,(i.y+n.z)*o,.25/o,(n.x-r.y)*o)},Wt.getLookAtSourceDest=function(t,e){var i=e.subA(t).normalize(),r=Xt.FORWARD.dot(i);if(Math.abs(r- -1)<1e-6)return Wt.axisAngleToQuat(Xt.UP,Math.PI);if(Math.abs(r-1)<1e-6)return new Wt(0,0,0,1);var n=Math.acos(r),s=Xt.FORWARD.cross(i).normalize();return Wt.axisAngleToQuat(s,n)},Wt.getRotationBetweenVectors=function(t,e){var i=t.cross(e);return new Wt(i.x,i.y,i.z,1+t.dot(e)).normalize()},Wt.getRotationBetweenVectorsUp=function(t,e,i){var r=t.dot(e);if(Math.abs(r+1)<1e-6)return Wt.axisAngleToQuat(i,Math.PI);if(Math.abs(r-1)<1e-6)return new Wt(0,0,0,1);var n=Math.acos(r),s=t.cross(e).normalize();return Wt.axisAngleToQuat(s,n)},Wt.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z&&0===this.w},Wt.prototype.clear=function(){return this.x=this.y=this.z=this.w=0,this},Wt.prototype.set=function(t,e,i,r){return this.x=t,this.y=e,this.z=i,this.w=r,this},Wt.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},Wt.prototype.setIdentity=function(){return this.x=0,this.y=0,this.z=0,this.w=1,this},Wt.prototype.clone=function(){return new Wt(this.x,this.y,this.z,this.w)},Wt.prototype.add=function(t){return new Wt(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)},Wt.prototype.sub=function(t){return new Wt(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)},Wt.prototype.scaleTo=function(t){return new Wt(this.x*t,this.y*t,this.z*t,this.w*t)},Wt.prototype.scale=function(t){return this.x,this.y,this.z,this.w*t},Wt.prototype.toVec=function(){return[this.x,this.y,this.z,this.w]},Wt.prototype.setFromSphericalCoords=function(t,e,i){var r=Math.sin(i/2),n=Math.cos(i/2),s=Math.sin(t),o=Math.cos(t),a=Math.sin(e),h=Math.cos(e);return this.x=r*o*a,this.y=r*s,this.z=r*s*h,this.w=n,this},Wt.prototype.setLookRotation=function(t,e){var i=t.normal().negate(),r=e.cross(i).normalize(),n=i.cross(r),s=1+r.x+n.y+i.z;if(s>1e-6){let t=1/(2*Math.sqrt(s));this.x=(i.y-n.z)*t,this.y=(r.z-i.x)*t,this.z=(n.x-r.y)*t,this.w=.25/t}else if(r.x>n.y&&r.x>i.z){let t=1/(2*Math.sqrt(1+r.x-n.y-i.z));this.x=.25/t,this.y=(n.x+r.y)*t,this.z=(r.z+i.x)*t,this.w=(i.y-n.z)*t}else if(n.y>i.z){let t=1/(2*Math.sqrt(1+n.y-r.x-i.z));this.x=(n.x+r.y)*t,this.y=.25/t,this.z=(i.y+n.z)*t,this.w=(r.z-i.x)*t}else{let t=1/(2*Math.sqrt(1+i.z-r.x-n.y));this.x=(r.z+i.x)*t,this.y=(i.y+n.z)*t,this.z=.25/t,this.w=(n.x-r.y)*t}return this},Wt.prototype.toSphericalCoords=function(){var t=this.w,e=Math.sqrt(1-t*t);Math.acos(t);Math.abs(e)<5e-4&&(e=1);var i,r=this.x/e,n=this.y/e,s=this.z/e,o=-Math.asin(n);return(i=r*r+s*s<5e-4?0:Math.atan2(r,s))<0&&(i+=360),{lat:o,lon:i,alpha:Math.acos(t)}},Wt.prototype.setFromAxisAngle=function(t,e){var i=t.normal(),r=.5*e,n=Math.sin(r);return this.set(i.x*n,i.y*n,i.z*n,Math.cos(r)),this},Wt.prototype.getAxisAngle=function(){var t,e,i=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);if(i>1e-7){var r=1/i;t=new Xt(x*r,y*r,z*r),e=this.w<0?2*Math.atan2(-i,-w):2*Math.atan2(i,w)}else t=new Xt(0,0,0),e=0;return{axis:t,angle:e}},Wt.prototype.setFromEulerAngles=function(t,e,i){var r=t*T,n=e*T,s=i*T,o=Math.cos(r),a=Math.cos(n),h=Math.cos(s),l=Math.sin(r),u=Math.sin(n),c=Math.sin(s),_=a*h,f=u*c;return this.w=o*_+l*f,this.x=l*_-o*f,this.y=o*u*h+l*a*c,this.z=o*a*c-l*u*h,this.normalize()},Wt.prototype.getEulerAngles=function(){let t=this.x,e=this.y,i=this.z,r=this.w,n=e*e,s=Math.atan2(2*(r*t+e*i),1-2*(t*t+n)),o=r*e-i*t;return o<-1?o=-1:o>1&&(o=1),{roll:s,pitch:Math.asin(2*o),yaw:Math.atan2(2*(r*i+t*e),1-2*(n+i*i))}},Wt.prototype.setFromMatrix4=function(t){var e,i,r,n,s,o=[],a=[1,2,0];return(e=(t=t._m)[0]+t[5]+t[10])>0?(i=Math.sqrt(e+1),this.w=i/2,i=.5/i,this.x=(t[6]-t[9])*i,this.y=(t[8]-t[2])*i,this.z=(t[1]-t[4])*i):(r=0,t[5]>t[0]&&(r=1),t[10]>t[5*r]&&(r=2),s=a[n=a[r]],i=Math.sqrt(t[5*r]-(t[5*n]+t[5*s])+1),o[r]=.5*i,0!==i&&(i=.5/i),o[3]=(t[4*n+s]-t[4*s+n])*i,o[n]=(t[4*r+n]+t[4*n+r])*i,o[s]=(t[4*r+s]+t[4*s+r])*i,this.x=o[0],this.y=o[1],this.z=o[2],this.w=o[3]),this},Wt.prototype.getMat4=function(t){var e=this.x+this.x,i=this.y+this.y,r=this.z+this.z,n=this.w*e,s=this.w*i,o=this.w*r,a=this.x*e,h=this.x*i,l=this.x*r,u=this.y*i,c=this.y*r,_=this.z*r;return(t||new Vt).set([1-(u+_),h-o,l+s,0,h+o,1-(a+_),c-n,0,l-s,c+n,1-(a+u),0,0,0,0,1])},Wt.prototype.getMat3=function(){var t=new Ht,e=t._m,i=this.x,r=this.y,n=this.z,s=this.w,o=i+i,a=r+r,h=n+n,l=i*o,u=i*a;i*=h;var c=r*a;return r*=h,n*=h,o*=s,a*=s,s*=h,e[0]=1-(c+n),e[1]=u-s,e[2]=i+a,e[3]=u+s,e[4]=1-(l+n),e[5]=r-o,e[6]=i-a,e[7]=r+o,e[8]=1-(l+c),t},Wt.prototype.mulVec3=function(t){var e=t.x,i=t.y,r=t.z,n=this.x,s=this.y,o=this.z,a=this.w,h=a*e+s*r-o*i,l=a*i+o*e-n*r,u=a*r+n*i-s*e;return new Xt(h*a+(e=-n*e-s*i-o*r)*-n+l*-o-u*-s,l*a+e*-s+u*-n-h*-o,u*a+e*-o+h*-s-l*-n)},Wt.prototype.mul=function(t){var e=this.x,i=this.y,r=this.z,n=this.w,s=t.x,o=t.y,a=t.z,h=t.w;return new Wt(e*h+n*s+i*a-r*o,i*h+n*o+r*s-e*a,r*h+n*a+e*o-i*s,n*h-e*s-i*o-r*a)},Wt.prototype.mulA=function(t){var e=this.x,i=this.y,r=this.z,n=this.w,s=t.x,o=t.y,a=t.z,h=t.w;return this.x=e*h+n*s+i*a-r*o,this.y=i*h+n*o+r*s-e*a,this.z=r*h+n*a+e*o-i*s,this.w=n*h-e*s-i*o-r*a,this},Wt.prototype.conjugate=function(){return new Wt(-this.x,-this.y,-this.z,this.w)},Wt.prototype.inverse=function(){var t=1/this.magnitude2();return new Wt(-this.x*t,-this.y*t,-this.z*t,this.w*t)},Wt.prototype.magnitude=function(){var t=this.x,e=this.y,i=this.z,r=this.w;return Math.sqrt(t*t+e*e+i*i+r*r)},Wt.prototype.magnitude2=function(){var t=this.x,e=this.y,i=this.z,r=this.w;return t*t+e*e+i*i+r*r},Wt.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},Wt.prototype.normalize=function(){var t=this.x,e=this.y,i=this.z,r=this.w,n=Math.sqrt(t*t+e*e+i*i+r*r);return 0===n?(this.x=0,this.y=0,this.z=0,this.w=0,this):(n=1/n,this.x=t*n,this.y=e*n,this.z=i*n,this.w=r*n,this)},Wt.prototype.isEqual=function(t){var e=this.dot(t);return Math.abs(e-1)<.001},Wt.prototype.slerp=function(t,e){var i,r,n,s,o,a=this.x,h=this.y,l=this.z,u=this.w,c=t.x,_=t.y,f=t.z,d=t.w;return(r=a*c+h*_+l*f+u*d)<0&&(r=-r,c=-c,_=-_,f=-f,d=-d),1-r>1e-6?(i=Math.acos(r),n=Math.sin(i),s=Math.sin((1-e)*i)/n,o=Math.sin(e*i)/n):(s=1-e,o=e),new Wt(s*a+o*c,s*h+o*_,s*l+o*f,s*u+o*d)},Wt.prototype.getRoll=function(t){var e=this.x,i=this.y,r=this.z,n=this.w;if(t){var s=2*i,o=2*r,a=o*n,h=s*e,l=s*i,u=o*r;return Math.atan2(h+a,1-(l+u))}return Math.atan2(2*(e*i+n*r),n*n+e*e-i*i-r*r)},Wt.prototype.getPitch=function(t){var e=this.x,i=this.y,r=this.z,n=this.w;if(t){var s=2*e,o=2*r,a=s*n,h=s*e,l=o*i,u=o*r;return Math.atan2(l+a,1-(h+u))}return Math.atan2(2*(i*r+n*e),n*n-e*e-i*i+r*r)},Wt.prototype.getYaw=function(t){var e=this.x,i=this.y,r=this.z,n=this.w;if(t){var s=2*i,o=s*n,a=2*e*e,h=2*r*e,l=s*i;return Math.atan2(h+o,1-(a+l))}return Math.asin(-2*(e*r-n*i))};const Xt=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0};Xt.UP=new Xt(0,1,0),Xt.DOWN=new Xt(0,-1,0),Xt.RIGHT=new Xt(1,0,0),Xt.LEFT=new Xt(-1,0,0),Xt.FORWARD=new Xt(0,0,-1),Xt.BACKWARD=new Xt(0,0,1),Xt.ZERO=new Xt,Xt.UNIT_X=new Xt(1,0,0),Xt.UNIT_Y=new Xt(0,1,0),Xt.UNIT_Z=new Xt(0,0,1),Xt.doubleToTwoFloats=function(t,e,i){let r=t.x,n=t.y,s=t.z;if(r>=0){var o=65536*Math.floor(r/65536);e.x=Math.fround(o),i.x=Math.fround(r-o)}else{o=65536*Math.floor(-r/65536);e.x=Math.fround(-o),i.x=Math.fround(r+o)}if(n>=0){o=65536*Math.floor(n/65536);e.y=Math.fround(o),i.y=Math.fround(n-o)}else{o=65536*Math.floor(-n/65536);e.y=Math.fround(-o),i.y=Math.fround(n+o)}if(s>=0){o=65536*Math.floor(s/65536);e.z=Math.fround(o),i.z=Math.fround(s-o)}else{o=65536*Math.floor(-s/65536);e.z=Math.fround(-o),i.z=Math.fround(s+o)}},Xt.doubleToTwoFloat32Array=function(t,e,i){let r=t.x,n=t.y,s=t.z;if(r>=0){var o=65536*Math.floor(r/65536);e[0]=Math.fround(o),i[0]=Math.fround(r-o)}else{o=65536*Math.floor(-r/65536);e[0]=Math.fround(-o),i[0]=Math.fround(r+o)}if(n>=0){o=65536*Math.floor(n/65536);e[1]=Math.fround(o),i[1]=Math.fround(n-o)}else{o=65536*Math.floor(-n/65536);e[1]=Math.fround(-o),i[1]=Math.fround(n+o)}if(s>=0){o=65536*Math.floor(s/65536);e[2]=Math.fround(o),i[2]=Math.fround(s-o)}else{o=65536*Math.floor(-s/65536);e[2]=Math.fround(-o),i[2]=Math.fround(s+o)}},Xt.fromVec=function(t){return new Xt(t[0],t[1],t[2])},Xt.angle=function(t,e){return Math.acos(t.dot(e)/Math.sqrt(t.length2()*e.length2()))},Xt.lerp=function(t,e,i){return Xt(t.x+(e.x-t.x)*i,t.y+(e.y-t.y)*i,t.z+(e.z-t.z)*i)},Xt.add=function(t,e){var i=new Xt(t.x,t.y,t.z);return i.addA(e),i},Xt.sub=function(t,e){var i=new Xt(t.x,t.y,t.z);return i.subA(e),i},Xt.scale=function(t,e){var i=new Xt(t.x,t.y,t.z);return i.scale(e),i},Xt.mul=function(t,e){var i=new Xt(t.x,t.y,t.z);return i.mulA(e),i},Xt.noncollinear=function(t,e){return t.y*e.z-t.z*e.y||t.z*e.x-t.x*e.z||t.x*e.y-t.y*e.z},Xt.proj_b_to_plane=function(t,e,i){var r=t.sub(e.scaleTo(e.dot(t)/e.dot(e)));return i&&r.isZero()?new Xt(i.x,i.y,i.z):r},Xt.proj_b_to_a=function(t,e){return e.scaleTo(e.dot(t)/e.dot(e))},Xt.orthoNormalize=function(t,e){return(t=t.normal()).scale(e.dot(t)),e.subA(t).normalize()},Xt.div=function(t,e){var i=new Xt(t.x,t.y,t.z);return i.divA(e),i},Xt.prototype.toVec4=function(){return new Ut(this.x,this.y,this.z,1)},Xt.prototype.clone=function(){return new Xt(this.x,this.y,this.z)},Xt.prototype.toString=function(){return"("+this.x+","+this.y+","+this.z+")"},Xt.prototype.isZero=function(){return!(this.x||this.y||this.z)},Xt.prototype.projToVec=function(t){return t.scaleTo(t.dot(this)/t.dot(t))},Xt.prototype.equal=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},Xt.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},Xt.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},Xt.prototype.length2=function(){return this.x*this.x+this.y*this.y+this.z*this.z},Xt.prototype.getQuat=function(){return new Wt(this.x,this.y,this.z)},Xt.prototype.addA=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},Xt.prototype.add=function(t){return new Xt(this.x+t.x,this.y+t.y,this.z+t.z)},Xt.prototype.subA=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},Xt.prototype.sub=function(t){return new Xt(this.x-t.x,this.y-t.y,this.z-t.z)},Xt.prototype.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this},Xt.prototype.scaleTo=function(t){return new Xt(this.x*t,this.y*t,this.z*t)},Xt.prototype.mulA=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},Xt.prototype.mul=function(t){return new Xt(this.x*t.x,this.y*t.y,this.z*t.z)},Xt.prototype.divA=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},Xt.prototype.div=function(t){return new Xt(this.x/t.x,this.y/t.y,this.z/t.z)},Xt.prototype.dot=function(t){return t.x*this.x+t.y*this.y+t.z*this.z},Xt.prototype.dotArr=function(t){return t[0]*this.x+t[1]*this.y+t[2]*this.z},Xt.prototype.cross=function(t){return new Xt(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},Xt.prototype.clear=function(){return this.x=this.y=this.z=0,this},Xt.prototype.normal=function(){var t=new Xt;t.copy(this);var e=1/t.length();return t.x*=e,t.y*=e,t.z*=e,t},Xt.prototype.normalNegate=function(){var t=new Xt;t.copy(this);var e=-1/t.length();return t.x*=e,t.y*=e,t.z*=e,t},Xt.prototype.normalNegateScale=function(t){var e=new Xt;e.copy(this);var i=-t/e.length();return e.x*=i,e.y*=i,e.z*=i,e},Xt.prototype.normalScale=function(t){var e=new Xt;e.copy(this);var i=t/e.length();return e.x*=i,e.y*=i,e.z*=i,e},Xt.prototype.normalize=function(){var t=1/this.length();return this.x*=t,this.y*=t,this.z*=t,this},Xt.prototype.toVec=function(){return[this.x,this.y,this.z]},Xt.prototype.toArray=function(){return[this.x,this.y,this.z]},Xt.prototype.distance=function(t){return Xt.sub(this,t).length()},Xt.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},Xt.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},Xt.prototype.negateTo=function(){return new Xt(-this.x,-this.y,-this.z)},Xt.prototype.projToRay=function(t,e){var i=Xt.proj_b_to_a(Xt.sub(this,t),e);return i.addA(t),i},Xt.prototype.angle=function(t){return Xt.angle(this,t)},Xt.prototype.lerp=function(t,e){return new Xt(this.x+(t.x-this.x)*e,this.y+(t.y-this.y)*e,this.z+(t.z-this.z)*e)},Xt.prototype.smerp=function(t,e){var i=1-e;return new Xt(this.x*e+t.x*i,this.y*e+t.y*i,this.z*e+t.z*i)},Xt.LERP_DELTA=1e-6,Xt.prototype.slerp=function(t,e){var i=new Xt;if(e<=0)i.copy(this);else{if(!(e>=1)){var r,n,s,o,a=this.dot(t);return 1-a>Xt.LERP_DELTA?(r=Math.acos(a),n=Math.sin(r),s=Math.sin((1-e)*r)/n,o=Math.sin(e*r)/n):(s=1-e,o=e),Xt.add(this.scaleTo(s),t.scale(o))}i.copy(t)}},Xt.prototype.getRotationTo=function(t,e){let i=this.clone(),r=t.clone();i.normalize(),r.normalize();let n=i.dot(r);if(n>=1)return Wt.IDENTITY.clone();if(n<1e-6-1){if(e.isEqual(Xt.ZERO)){let t=Xt.UNIT_X.cross(i);return t.isZero()&&(t=Xt.UNIT_Y.cross(i)),t.normalize(),Wt.axisAngleToQuat(Math.PI,t)}return Wt.axisAngleToQuat(Math.PI,e)}{let t=Math.sqrt(2*(1+n)),e=1/t,s=i.cross(r),o=new Wt(s.x*e,s.y*e,s.z*e,.5*t);return o.normalise(),o}};const Yt=function(t,e){this.x=t||0,this.y=e||0};function jt(t,e){return void 0!=t?t:e}function Gt(t){return null==t}Yt.UP=new Yt(0,1),Yt.DOWN=new Yt(0,-1),Yt.RIGHT=new Yt(1,0),Yt.LEFT=new Yt(-1,0),Yt.ZERO=new Yt,Yt.add=function(t,e){var i=new Yt(t.x,t.y);return i.addA(e),i},Yt.sub=function(t,e){var i=new oVec2(t.x,t.y);return i.subA(e),i},Yt.scale=function(t,e){var i=new Yt(t.x,t.y);return i.scale(e),i},Yt.mul=function(t,e){var i=new Yt(t.x,t.y);return i.mulA(e),i},Yt.div=function(t,e){var i=new Yt(t.x,t.y);return i.divA(e),i},Yt.proj_b_to_a=function(t,e){return e.scaleTo(e.dot(t)/e.dot(e))},Yt.angle=function(t,e){return Math.acos(t.dot(e)/Math.sqrt(t.length2()*e.length2()))},Yt.orthoNormalize=function(t,e){return(t=t.norm()).scale(e.dot(t)),e.sub(t).normalize()},Yt.prototype.toVector3=function(){return new Xt(this.x,this.y,0)},Yt.prototype.clone=function(){return new Yt(this.x,this.y)},Yt.prototype.equal=function(t){return this.x===t.x&&this.y===t.y},Yt.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this},Yt.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Yt.prototype.length2=function(){return this.x*this.x+this.y*this.y},Yt.prototype.addA=function(t){return this.x+=t.x,this.y+=t.y,this},Yt.prototype.add=function(t){return new Yt(this.x+t.x,this.y+t.y)},Yt.prototype.subA=function(t){return this.x-=t.x,this.y-=t.y,this},Yt.prototype.sub=function(t){return new Yt(this.x-t.x,this.y-t.y)},Yt.prototype.scale=function(t){return this.x*=t,this.y*=t,this},Yt.prototype.scaleTo=function(t){return new Yt(this.x*t,this.y*t)},Yt.prototype.mulA=function(t){return this.x*=t.x,this.y*=t.y,this},Yt.prototype.mul=function(t){return new Yt(this.x*t.x,this.y*t.y)},Yt.prototype.divA=function(t){return this.x/=t.x,this.y/=t.y,this},Yt.prototype.dot=function(t){return t.x*this.x+t.y*this.y},Yt.prototype.dotArr=function(t){return t[0]*this.x+t[1]*this.y},Yt.prototype.cross=function(t){return this.x*t.y-this.y*t.x},Yt.prototype.clear=function(){return this.x=this.y=0,this},Yt.prototype.normal=function(){var t=new Yt;t.copy(this);var e=1/t.length();return t.x*=e,t.y*=e,t},Yt.prototype.normalize=function(){var t=1/this.length();return this.x*=t,this.y*=t,this},Yt.prototype.toVec=function(){return[this.x,this.y]},Yt.prototype.distance=function(t){return Yt.sub(this,t).length()},Yt.prototype.set=function(t,e){return this.x=t,this.y=e,this},Yt.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},Yt.prototype.negateTo=function(){return new Yt(-this.x,-this.y)},Yt.prototype.projToRay=function(t,e){var i=Yt.proj_b_to_a(Yt.sub(this,t),e);return i.add(t),i},Yt.prototype.angle=function(t){return Yt.angle(this,t)},Yt.prototype.lerp=function(t,e,i){var r=Yt.clone(this);return i<=0?r.copy(t):i>=1?r.copy(e):r=Yt.add(t,Yt.sub(e,t).scale(i)),r},Yt.LERP_DELTA=1e-6,Yt.prototype.slerp=function(t,e){var i=new Yt;if(e<=0)i.copy(this);else{if(!(e>=1)){var r,n,s,o,a=this.dot(t);return 1-a>Yt.LERP_DELTA?(r=Math.acos(a),n=Math.sin(r),s=Math.sin((1-e)*r)/n,o=Math.sin(e*r)/n):(s=1-e,o=e),Yt.add(this.scale(s),t.scale(o))}i.copy(t)}},"createImageBitmap"in window||(window.createImageBitmap=function(t){return new Promise((e,i)=>{let r=document.createElement("img");r.addEventListener("load",function(){e(this)}),r.src=URL.createObjectURL(t)})});let qt=0;function Kt(t){var e=t._openglobus_id;return e||(e=t._openglobus_id=++qt),e}function Zt(t){return"string"==typeof t||t instanceof String}function Qt(t){var e="";return o.request(t,{async:!1,success:function(t){e=t}}),e}function Jt(t,e){var i=h[t];if(i&&(t=i),"#"===t[0]){var r=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(t,e,i,r){return e+e+i+i+r+r}),n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(r);return new Ut(parseInt(n[1],16)/255,parseInt(n[2],16)/255,parseInt(n[3],16)/255,Gt(e)?1:e)}Gt(e)&&(e=1);var s=t.split(",");return new Ut(parseInt(s[0].split("(")[1])/255,parseInt(s[1])/255,parseInt(s[2])/255,Gt(s[3])?e:parseFloat(s[3]))}function $t(t,e){let i=Jt(t,e);return new Float32Array([i.x,i.y,i.z,i.w])}function te(t){var e=h[t];if(e&&(t=e),"#"===t[0]){var i=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(t,e,i,r){return e+e+i+i+r+r}),r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(i);return new Ut(parseInt(r[1],16)/255,parseInt(r[2],16)/255,parseInt(r[3],16)/255)}var n=t.split(",");return new Xt(parseInt(n[0].split("(")[1])/255,parseInt(n[1])/255,parseInt(n[2])/255)}function ee(t,e){return t.replace(/{[^{}]+}/g,function(t){return e[t.replace(/[{}]+/g,"")]||""})}function ie(t,e,i,r){var n=document.getElementById(t);n||((n=document.createElement("div")).id=t,n.classList.add("defaultText"),document.body.appendChild(n)),n.innerHTML=e,n.style.left=i,n.style.top=r}function re(t,e){return t?t.trim().toLowerCase():e}function ne(t,e){if(t){if(t instanceof Xt)return t.clone();if(t instanceof Array)return Xt.fromVec(t)}else if(e)return e;return new Xt}function se(t,e){if(t){if(t instanceof Ut)return t.clone();if(t instanceof Array)return Ut.fromVec(t)}else if(e)return e;return new Ut}function oe(t,e){if(t){if(Zt(t))return Jt(t);if(t instanceof Array)return new Ut.fromVec(t);if(t instanceof Ut)return t.clone()}else if(e)return e;return new Ut(1,1,1,1)}function ae(t,e){if(t){if(Zt(t))return te(t);if(t instanceof Array)return new Xt.fromVec(t);if(t instanceof Xt)return t.clone()}else if(e)return e;return new Xt(1,1,1)}function he(t,e){if(t){if(t instanceof Array)return new Ot(le(t[0]),le(t[1]));if(t instanceof Ot)return t.clone()}else if(e)return e;return new Ot}function le(t,e){if(t){if(t instanceof Array)return new Rt(t[0],t[1],t[2]);if(t instanceof Rt)return t.clone()}else if(e)return e;return new Rt}function ue(t,e,i){for(var r=0,n=t.length-1;r<=n;){var s=n+r>>1,o=i(e,t[s],s);if(o>0)r=s+1;else{if(!(o<0))return s;n=s-1}}return-r-1}function ce(t,e,i){var r=ue(t,e,i);return r<0&&(r=~r),t.splice(r,0,e),r}function _e(t,e,i,r,n){var s=e.sub(t),o=r.sub(i),a=-s.y,h=+s.x,l=-(a*t.x+h*t.y),u=-o.y,c=+o.x,_=-(u*i.x+c*i.y),f=u*t.x+c*t.y+_,d=u*e.x+c*e.y+_,p=a*i.x+h*i.y+l,v=a*r.x+h*r.y+l;if(n&&(f*d>0||p*v>0))return null;var g=f/(f-d);return new Yt(t.x+g*s.x,t.y+g*s.y)}function fe(t,e,i,r,n){var s=new Rt(e.lon-t.lon,e.lat-t.lat),o=new Rt(r.lon-i.lon,r.lat-i.lat),a=-s.lat,h=+s.lon,l=-(a*t.lon+h*t.lat),u=-o.lat,c=+o.lon,_=-(u*i.lon+c*i.lat),f=u*t.lon+c*t.lat+_,d=u*e.lon+c*e.lat+_,p=a*i.lon+h*i.lat+l,v=a*r.lon+h*r.lat+l;if(n&&(f*d>0||p*v>0))return null;var g=f/(f-d);return new Rt(t.lon+g*s.lon,t.lat+g*s.lat)}function de(t){var e={};if(1===t.nodeType){if(t.attributes.length>0){e["@attributes"]={};for(var i=0;i<t.attributes.length;i++){var r=t.attributes.item(i);e["@attributes"][r.nodeName]=r.nodeValue}}}else 3===t.nodeType&&(e=t.nodeValue);if(t.hasChildNodes())for(var n=0;n<t.childNodes.length;n++){var s=t.childNodes.item(n),o=s.nodeName;if(void 0===e[o])e[o]=de(s);else{if(void 0===e[o].push){var a=e[o];e[o]=[],e[o].push(a)}e[o].push(de(s))}}return e}const pe={string:function(t){return Gt(t)?t:t.toString()},date:function(t){return Gt(t)?t:new Date(1e3*t)},datetime:function(t){return Gt(t)?t:new Date(1e3*t)},time:function(t){return Gt(t)?t:parseInt(t)},integer:function(t){return Gt(t)?t:parseInt(t)},float:function(t){return Gt(t)?t:parseFloat(t)},boolean:function(t){if(null===t)return t;if("boolean"==typeof t)return!0===t;if("string"==typeof t){if(""===t)return!1;if("true"===(t=t.replace(/^\s+|\s+$/g,"")).toLowerCase()||"yes"===t.toLowerCase())return!0;t=(t=t.replace(/,/g,".")).replace(/^\s*\-\s*/g,"-")}return!isNaN(t)&&0!==parseFloat(t)}};function ve(t,e){e=e||"";for(var i=atob(t),r=i.length,n=Math.ceil(r/1024),s=new Array(n),o=0;o<n;++o){for(var a=1024*o,h=Math.min(a+1024,r),l=new Array(h-a),u=a,c=0;u<h;++c,++u)l[c]=i[u].charCodeAt(0);s[o]=new Uint8Array(l)}return new Blob(s,{type:e})}function ge(t,e,i,r,n){const s=i.lat-r.lat,o=r.lon-i.lon,a=e.lon-r.lon,h=e.lat-r.lat,l=r.lat-e.lat,u=t.lon-r.lon,c=t.lat-r.lat,_=s*a+o*h,f=(s*u+o*c)/_,d=(l*u+a*c)/_;return n[0]=f,n[1]=d,n[2]=1-f-d,0<=n[0]&&n[0]<=1&&0<=f&&f<=1&&0<=d&&d<=1}function me(t,e,i){let r,n;return function(){const s=this,o=arguments;n?(i&&clearTimeout(r),r=setTimeout(function(){Date.now()-n>=e&&(t.apply(s,o),n=Date.now())},e-(Date.now()-n))):(t.apply(s,o),n=Date.now())}}const ye=.001,xe=1e3,be=60,Ae=1/be,Ce=60,we=24,Ee=1/we,Te=3600,Be=1/Te,Pe=12*Te,Re=1440,ze=1/Re,Le=86400,Me=864e5,Fe=1/Me,De=1/Le,Se=36525,Ne=365.25,ke=1e-9,Ie=2400000.5,Oe=2451545;function Ue(t){return(t-Oe)/Se}function He(t,e,i){var r=(e-14)/12|0,n=t+4800+r;return(1461*n/4|0)+(367*(e-2-12*r)/12|0)-(3*((n+100)/100|0)/4|0)+i-32075}function Ve(t){var e=He(t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate()),i=t.getUTCHours()-12;i<0&&(i+=24);var r=t.getUTCSeconds()+i*Te+t.getUTCMinutes()*be+t.getUTCMilliseconds()*ye;r>=Pe&&e--;var n=r*De|0;return e+=n,(r-=Le*n)<0&&(e--,r+=Le),e+r*De}function We(t){return Xe(Ve(t))}function Xe(t){var e=ai,i=ue(e,t,function(t,e){return t-e.jd});i<0&&(i=~i),i>=e.length&&(i=e.length-1);var r=e[i].leapSeconds;return 0!==i&&(e[i].jd-t)*Le>r&&(r=e[i-1].leapSeconds),t+r*De}function Ye(t){var e=ai,i=ue(e,t,function(t,e){return t-e.jd});if(i<0&&(i=~i),i>=e.length)return t-e[i-1].leapSeconds*De;if(0===i)return t-e[0].leapSeconds*De;var r=(e[i].jd-t)*Le;return 0===r?t-e[i].leapSeconds*De:r<=1?null:t-e[i-1].leapSeconds*De}function je(t){var e=0|t,i=(t-e)*Le;i>=Pe&&e++;var r=e+68569|0,n=4*r/146097|0,s=4e3*((r=r-((146097*n+3)/4|0)|0)+1)/1461001|0,o=80*(r=r-(1461*s/4|0)+31|0)/2447|0,a=r-(2447*o/80|0)|0,h=o+2-12*(r=o/11|0)|0,l=100*(n-49)+s+r|0,u=i*Be|0,c=i-u*Te,_=c*Ae|0,f=0|(c-=_*be),d=(c-f)*xe|0;return(u+=12)>23&&(u-=24),new Date(Date.UTC(l,h-1,a,u,_,f,d))}function Ge(t){var e=Ye(t);return e||(e=Ye(Ke(t,-1)),og.console.logWrn("TAItoDate:336 - can't conv utc.")),je(e)}function qe(t,e){return t+e*Fe}function Ke(t,e){return t+e*De}function Ze(t,e){return t+e*Ee}function Qe(t,e){return t+e*Re}function Je(t,e){return t+e}function $e(t){var e=t-(0|t);return((e*=Le)-(0|e))*xe|0}function ti(t){return(t-(0|t))*Le}function ei(t){var e=(t-(0|t))*Le,i=e*Be|0,r=e-i*Te,n=r*Ae|0,s=0|(r-=n*be);return(i+=12+n/60+s/3600+((r-s)*xe|0)/1e3)>23&&(i-=24),i}function ii(t){return(t-(0|t))*Re|0}function ri(t){return 0|t}function ni(t){return t*De}function si(t){return t*Le}function oi(t,e){return{jd:t,leapSeconds:e}}const ai=[oi(2441317.5,10),oi(2441499.5,11),oi(2441683.5,12),oi(2442048.5,13),oi(2442413.5,14),oi(2442778.5,15),oi(2443144.5,16),oi(2443509.5,17),oi(2443874.5,18),oi(2444239.5,19),oi(2444786.5,20),oi(2445151.5,21),oi(2445516.5,22),oi(2446247.5,23),oi(2447161.5,24),oi(2447892.5,25),oi(2448257.5,26),oi(2448804.5,27),oi(2449169.5,28),oi(2449534.5,29),oi(2450083.5,30),oi(2450630.5,31),oi(2451179.5,32),oi(2453736.5,33),oi(2454832.5,34),oi(2456109.5,35),oi(2457204.5,36)],hi=Xe(Oe);class li{constructor(t){t=t||{},this._id=li.__staticCounter++,this._name=t.name||"_control_"+this._id,this._initialized=!1,this.renderer=null,this.autoActivate=void 0==t.autoActivate||t.autoActivate,this._active=!1}static get __staticCounter(){return this.__counter||0===this.__counter||(this.__counter=0),this.__counter}static set __staticCounter(t){this.__counter=t}get name(){return this._name}oninit(){}onadd(){}onremove(){}onactivate(){}ondeactivate(){}addTo(t){t&&(this.renderer=t,t.controls[this.name]=this,this.onadd&&this.onadd(),this.autoActivate&&(this._initialized=!0,this.oninit&&this.oninit(),this._active=!0))}remove(){this.onremove&&this.onremove();let t=this.renderer,e=this.name,i=t.controls[e];i&&this.isEqual(i)&&(t.controls[e]=null,delete t.controls[e]),this.renderer=null,this._active=!1,this._initialized=!1}activate(){this._initialized||(this._initialized=!0,this.oninit&&this.oninit()),this._active=!0,this.onactivate&&this.onactivate()}deactivate(){this._active=!1,this.ondeactivate&&this.ondeactivate()}isActive(){return this._active}isEqual(t){return t._id===this._id}}class ui extends li{constructor(t){(t=t||{}).name&&""!==t.name||(t.name="DebugInfo"),super(t),this.el=null,this._watch=t.watch||[]}addWatches(t){for(var e=0;e<t.length;e++)this.addWatch(t[e])}addWatch(t){this._watch.push(t);let e=document.createElement("div");e.classList.add("og-watch-line"),e.innerHTML='<div class="og-watch-label">'+t.label+'</div><div class="og-watch-value"></div>',t.valEl=e.querySelector(".og-watch-value"),this.el.appendChild(e)}oninit(){this.el=document.createElement("div"),this.el.className="og-debug-info";var t=this._watch;this._watch=[];for(var e=0;e<t.length;e++)this.addWatch(t[e]);this.renderer.div.appendChild(this.el),this.renderer.events.on("draw",this._frame,this);let i=this.planet;i&&this.addWatches([{label:"Nodes count",frame:()=>i._renderedNodes.length},{label:"createdNodes",frame:()=>i._createdNodesCount},{label:"distBeforeMemClear",frame:()=>i._distBeforeMemClear},{label:"maxZoom/minZoom",frame:()=>i.maxCurrZoom+"/"+i.minCurrZoom},{label:"height/alt (km)",frame:()=>(i.camera._lonLat.height/1e3).toFixed(2)+"/"+(i.camera.getAltitude()/1e3).toFixed(2)},{label:"cam.slope",frame:()=>i.camera.slope},{label:"lodRatio",frame:()=>i._lodRatio},{label:"deltaTime",frame:()=>i.renderer.handler.deltaTime},{label:"-------------------------"},{label:"PlainWorker",frame:()=>i._plainSegmentWorker._pendingQueue.length},{label:"TileLoader",frame:()=>i._tileLoader._loading+" "+i._tileLoader._queue.length},{label:"TerrainLoader",frame:()=>i.terrain&&i.terrain._loader?i.terrain._loader._loading+" "+i.terrain._loader._queue.length:""},{label:"TerrainWorker",frame:()=>i._terrainWorker._pendingQueue.length},{label:"NormalMapCreator",frame:()=>i._normalMapCreator._queue.length}])}_frame(){for(var t=0;t<this._watch.length;t++){var e=this._watch[t];e.valEl.innerHTML=e.frame?e.frame():""}}}const ci={KEY_ALT:18,KEY_SHIFT:16,KEY_SPACE:32,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_A:65,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_H:72,KEY_I:73,KEY_K:75,KEY_L:76,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_S:83,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Z:90,KEY_F1:112,KEY_APOSTROPHE:192,MB_LEFT:0,MB_RIGHT:2,MB_MIDDLE:1};class _i extends li{constructor(t){super(t=t||{}),this.camera=null,this.speed=t.speed||1}oninit(){this.camera=this.renderer.activeCamera,this.renderer.events.on("keypress",ci.KEY_W,this.onCameraMoveForward,this),this.renderer.events.on("keypress",ci.KEY_S,this.onCameraMoveBackward,this),this.renderer.events.on("keypress",ci.KEY_A,this.onCameraStrifeLeft,this),this.renderer.events.on("keypress",ci.KEY_D,this.onCameraStrifeRight,this),this.renderer.events.on("keypress",ci.KEY_UP,this.onCameraLookUp,this),this.renderer.events.on("keypress",ci.KEY_DOWN,this.onCameraLookDown,this),this.renderer.events.on("keypress",ci.KEY_LEFT,this.onCameraTurnLeft,this),this.renderer.events.on("keypress",ci.KEY_RIGHT,this.onCameraTurnRight,this),this.renderer.events.on("keypress",ci.KEY_Q,this.onCameraRollLeft,this),this.renderer.events.on("keypress",ci.KEY_E,this.onCameraRollRight,this)}onCameraMoveForward(t){var e=this.camera;e.slide(0,0,-this.speed),e.update()}onCameraMoveBackward(t){var e=this.camera;e.slide(0,0,this.speed),e.update()}onCameraStrifeLeft(t){var e=this.camera;e.slide(-this.speed,0,0),e.update()}onCameraStrifeRight(t){var e=this.camera;e.slide(this.speed,0,0),e.update()}onCameraLookUp(t){var e=this.camera;e.pitch(.5),e.update()}onCameraLookDown(t){var e=this.camera;e.pitch(-.5),e.update()}onCameraTurnLeft(t){var e=this.camera;e.yaw(.5),e.update()}onCameraTurnRight(t){var e=this.camera;e.yaw(-.5),e.update()}onCameraRollLeft(t){var e=this.camera;e.roll(-.5),e.update()}onCameraRollRight(t){var e=this.camera;e.roll(.5),e.update()}}class fi extends li{constructor(t){super(t)}oninit(){var t=document.createElement("div");t.className="defaultText ",t.id="ogShowFpsControl",document.body.appendChild(t),this.renderer.events.on("draw",this._draw,this)}_draw(){ie("ogShowFpsControl",(1e3/this.renderer.handler.deltaTime).toFixed(1),this.renderer.handler.canvas.clientWidth-60,0)}}class di{constructor(t){t=t||{},this.id=di._staticCounter++,this._position=ne(t.position),this._positionHigh=new Xt,this._positionLow=new Xt,Xt.doubleToTwoFloats(this._position,this._positionHigh,this._positionLow),this._rotation=t.rotation||0,this._color=oe(t.color),this._alignedAxis=ne(t.alignedAxis),this._offset=ne(t.offset),this._visibility=void 0==t.visibility||t.visibility,this._entity=null,this._handler=null,this._handlerIndex=-1}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}setPosition(t,e,i){this._position.x=t,this._position.y=e,this._position.z=i,Xt.doubleToTwoFloats(position,this._positionHigh,this._positionLow),this._handler&&this._handler.setPositionArr(this._handlerIndex,this._positionHigh,this._positionLow)}setPosition3v(t){this._position.x=t.x,this._position.y=t.y,this._position.z=t.z,Xt.doubleToTwoFloats(t,this._positionHigh,this._positionLow),this._handler&&this._handler.setPositionArr(this._handlerIndex,this._positionHigh,this._positionLow)}getPosition(){return this._position}setOffset(t,e,i){this._offset.x=t,this._offset.y=e,void 0!=i&&(this._offset.z=i),this._handler&&this._handler.setOffsetArr(this._handlerIndex,this._offset)}setOffset3v(t){this._offset.x=t.x,this._offset.y=t.y,void 0!=t.z&&(this._offset.z=t.z),this._handler&&this._handler.setOffsetArr(this._handlerIndex,t)}getOffset(){return this._offset}setRotation(t){this._rotation=t,this._handler&&this._handler.setRotationArr(this._handlerIndex,t)}getRotation(){return this._rotation}setOpacity(t){this._color.w=t,this.setColor(this._color.x,this._color.y,this._color.z,t)}setColor(t,e,i,r){this._color.x=t,this._color.y=e,this._color.z=i,void 0!=r&&(this._color.w=r),this._handler&&this._handler.setRgbaArr(this._handlerIndex,this._color)}setColor4v(t){this._color.x=t.x,this._color.y=t.y,this._color.z=t.z,void 0!=t.w&&(this._color.w=t.w),this._handler&&this._handler.setRgbaArr(this._handlerIndex,t)}setColorHTML(t){this.setColor4v(Jt(t))}getColor(){return this._color}setVisibility(t){this._visibility=t,this._handler&&this._handler.setVisibility(this._handlerIndex,t)}getVisibility(){return this._visibility}setAlignedAxis(t,e,i){this._alignedAxis.x=t,this._alignedAxis.y=e,this._alignedAxis.z=i,this._handler&&this._handler.setAlignedAxisArr(this._handlerIndex,this._alignedAxis)}setAlignedAxis3v(t){this._alignedAxis.x=t.x,this._alignedAxis.y=t.y,this._alignedAxis.z=t.z,this._handler&&this._handler.setAlignedAxisArr(this._handlerIndex,t)}getAlignedAxis(){return this._alignedAxis}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._handler&&this._handler.setPickingColorArr(this._handlerIndex,t)}}class pi extends di{constructor(t){super(t),t=t||{},this._src=t.src||null,this._image=t.image||null,this._scale=1,this._width=t.width||(t.size?t.size[0]:30),this._height=t.height||(t.size?t.size[1]:30)}setSrc(t){this._src=t;var e=this._handler;if(e&&t){var i=e._entityCollection.renderNode;if(i){var r=i.renderer.billboardsTextureAtlas,n=this;r.loadImage(t,function(t){r.nodes[t.__nodeIndex]?(n._image=t,e.setTexCoordArr(n._handlerIndex,r.nodes[n._image.__nodeIndex].texCoords)):(r.addImage(t),r.createTexture(),n._image=t,i.updateBillboardsTexCoords())})}}}setImage(t){this.setSrc(t.src)}setSize(t,e){this._width=t,this._height=e,this._handler&&this._handler.setSizeArr(this._handlerIndex,t*this._scale,e*this._scale)}getSize(){return{width:this._width,height:this._height}}setWidth(t){this.setSize(t,this._height)}getWidth(){return this._width}setHeight(t){this.setSize(this._width,t)}getHeight(){return this._height}}const vi=function(t,e){this.p0=t||new Xt,this.p1=e||new Xt};vi.prototype.getSphereIntersection=function(t){var e=this.p0,i=this.p1,r=t.x,n=t.y,s=t.z,o=e.x,a=e.y,h=e.z,l=i.x-o,u=i.y-a,c=i.z-h,_=l*l+u*u+c*c,f=2*(o*l+a*u+h*c-l*r-u*n-c*s),d=f*f-4*_*(o*o-2*o*r+r*r+a*a-2*a*n+n*n+h*h-2*h*s+s*s-t.radius*t.radius);if(d<0)return null;var p=(-f-Math.Sqrt(d))/(2*_),v=new Xt(e.x*(1-p)+p*i.x,e.y*(1-p)+p*i.y,e.z*(1-p)+p*i.z);if(0==d)return v;var g=(-f+Math.Sqrt(d))/(2*_),m=new Xt(e.x*(1-g)+g*i.x,e.y*(1-g)+g*i.y,e.z*(1-g)+g*i.z);return Math.Abs(p-.5)<Math.abs(g-.5)?[v,m]:[m,v]},vi.prototype.intersects=function(t,e,i){let r=this.p0.sub(t.p0),n=t.p1.sub(t.p0);if(Math.abs(n.x)<W&&Math.abs(n.y)<W&&Math.abs(n.z)<W)return!1;let s=this.p1.sub(this.p0);if(Math.abs(s.x)<W&&Math.abs(s.y)<W&&Math.abs(s.z)<W)return!1;let o=r.x*n.x+r.y*n.y+r.z*n.z,a=n.x*s.x+n.y*s.y+n.z*s.z,h=r.x*s.x+r.y*s.y+r.z*s.z,l=n.x*n.x+n.y*n.y+n.z*n.z,u=(s.x*s.x+s.y*s.y+s.z*s.z)*l-a*a;if(Math.abs(u)<W)return!1;let c=(o*a-h*l)/u;if(e.x=this.p0.x+c*s.x,e.y=this.p0.y+c*s.y,e.z=this.p0.z+c*s.z,i){let e=(o+a*c)/l;i.x=t.p0.x+e*n.x,i.y=t.p0.y+e*n.y,i.z=t.p0.z+e*n.z}return!0};let gi=new Xt,mi=new Xt;class yi{constructor(t){t=t||{},this.id=yi._staticCounter++,this.visibility=void 0==t.visibility||t.visibility,this.color=new Float32Array([1,1,1,.5]),t.color&&this.setColor(t.color[0],t.color[1],t.color[2],t.color[3]),t.opacity&&this.setOpacity(t.opacity),this._renderNode=null,this._entity=null,this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._indexesBuffer=null,this._verticesHigh=[],this._verticesLow=[],this._indexes=[],this._path=[],this._pickingColor=new Uint8Array(4),this._gridSize=16,this._handler=null,this._handlerIndex=-1,t.path&&this.setPath(t.path)}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}setPickingColor3v(t){this._pickingColor[0]=t.x/255,this._pickingColor[1]=t.y/255,this._pickingColor[2]=t.z/255,this._pickingColor[3]=1}clear(){this._path.length=0,this._path=[],this._verticesHigh.length=0,this._verticesHigh=[],this._verticesLow.length=0,this._verticesLow=[],this._indexes.length=0,this._indexes=[],this._deleteBuffers()}setColor(t,e,i,r){r=r||this.color[3],this.color[0]=t,this.color[1]=e,this.color[2]=i,this.color[3]=r}setOpacity(t){this.color[3]=t||0}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){this._renderNode=t,this._createBuffers()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}draw(){if(this.visibility&&this._verticesHigh.length){var t=this._renderNode.renderer,e=t.handler.gl,i=t.handler.programs.strip,r=i._program,n=r.attributes,s=r.uniforms;e.disable(e.CULL_FACE),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.enable(e.BLEND),i.activate(),e.uniformMatrix4fv(s.viewMatrix,!1,t.activeCamera._viewMatrix._m),e.uniformMatrix4fv(s.projectionMatrix,!1,t.activeCamera._projectionMatrix._m),e.uniform3fv(s.eyePositionHigh,t.activeCamera.eyeHigh),e.uniform3fv(s.eyePositionLow,t.activeCamera.eyeLow),e.uniform4fv(s.uColor,this.color),e.bindBuffer(e.ARRAY_BUFFER,this._verticesHighBuffer),e.vertexAttribPointer(n.aVertexPositionHigh,this._verticesHighBuffer.itemSize,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this._verticesLowBuffer),e.vertexAttribPointer(n.aVertexPositionLow,this._verticesLowBuffer.itemSize,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._indexBuffer),e.drawElements(t.handler.gl.TRIANGLE_STRIP,this._indexBuffer.numItems,e.UNSIGNED_INT,0),e.enable(e.CULL_FACE)}}drawPicking(){if(this.visibility&&this._verticesHigh.length){var t=this._renderNode.renderer,e=t.handler.gl,i=t.handler.programs.strip,r=i._program,n=r.attributes,s=r.uniforms;e.disable(e.CULL_FACE),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.enable(e.BLEND),i.activate(),e.uniformMatrix4fv(s.viewMatrix,!1,t.activeCamera._viewMatrix._m),e.uniformMatrix4fv(s.projectionMatrix,!1,t.activeCamera._projectionMatrix._m),e.uniform3fv(s.eyePositionHigh,t.activeCamera.eyeHigh),e.uniform3fv(s.eyePositionLow,t.activeCamera.eyeLow),e.uniform4fv(s.uColor,this._pickingColor),e.bindBuffer(e.ARRAY_BUFFER,this._verticesHighBuffer),e.vertexAttribPointer(n.aVertexPositionHigh,this._verticesHighBuffer.itemSize,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this._verticesLowBuffer),e.vertexAttribPointer(n.aVertexPositionLow,this._verticesLowBuffer.itemSize,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._indexBuffer),e.drawElements(t.handler.gl.TRIANGLE_STRIP,this._indexBuffer.numItems,e.UNSIGNED_SHORT,0),e.enable(e.CULL_FACE)}}_deleteBuffers(){if(this._renderNode&&this._renderNode.renderer){var t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._indexBuffer),t.deleteBuffer(this._verticesHighBuffer),t.deleteBuffer(this._verticesLowBuffer)}this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._indexBuffer=null}_createBuffers(){if(this._renderNode&&this._renderNode.renderer){var t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._indexBuffer),t.deleteBuffer(this._verticesHighBuffer),t.deleteBuffer(this._verticesLowBuffer),this._verticesHighBuffer=this._renderNode.renderer.handler.createArrayBuffer(new Float32Array(this._verticesHigh),3,this._verticesHigh.length/3),this._verticesLowBuffer=this._renderNode.renderer.handler.createArrayBuffer(new Float32Array(this._verticesLow),3,this._verticesLow.length/3),this._indexBuffer=this._renderNode.renderer.handler.createElementArrayBuffer(new Uint32Array(this._indexes),1,this._indexes.length)}}addEdge3v(t,e){let i=this._path.length;if(0===i)this._path.push([t.clone(),e.clone()]);else{let r=this._path[i-1][0],n=this._path[i-1][1];this._path.push([t.clone(),e.clone()]);let s=this._verticesHigh,o=this._verticesLow,a=this._gridSize,h=a+1,l=new Xt,u=this._verticesHigh.length/3,c=u,_=Math.abs(r.sub(n).normal().dot(t.sub(r).normal()));for(let i=0;i<h;i++){let f=i/a,d=r.lerp(t,f),p=n.lerp(e,f);for(let f=0;f<h;f++){let v=f/a,g=r.lerp(n,v),m=t.lerp(e,v);1!==_?new vi(d,p).intersects(new vi(g,m),l):l=m,c=u+i*h+f,Xt.doubleToTwoFloats(l,gi,mi);let y=3*c;s[y]=gi.x,s[y+1]=gi.y,s[y+2]=gi.z,o[y]=mi.x,o[y+1]=mi.y,o[y+2]=mi.z,i<a&&this._indexes.push(c,c+h)}i<a&&this._indexes.push(c+h,c+1)}this._createBuffers()}}setEdge3v(t,e,i){if(i!==this._path.length){if(this._path[i][0]=t,this._path[i][1]=e,this._path.length>1){let r=this._gridSize,n=r+1,s=n*n,o=new Xt,a=this._verticesHigh,h=this._verticesLow;if(i===this._path.length-1){let l=this._path[i-1][0],u=this._path[i-1][1],c=this._verticesHigh.length/3-s,_=c,f=Math.abs(l.sub(u).normal().dot(t.sub(l).normal()));for(let i=0;i<n;i++){let s=i/r,d=l.lerp(t,s),p=u.lerp(e,s);for(let s=0;s<n;s++){let v=s/r,g=l.lerp(u,v),m=t.lerp(e,v);1!==f?new vi(d,p).intersects(new vi(g,m),o):o=m,_=c+i*n+s,Xt.doubleToTwoFloats(o,gi,mi);let y=3*_;a[y]=gi.x,a[y+1]=gi.y,a[y+2]=gi.z,h[y]=mi.x,h[y+1]=mi.y,h[y+2]=mi.z}}}else if(0===i){let i=0,s=t,l=e;t=this._path[1][0],e=this._path[1][1];for(let u=0;u<n;u++){let c=u/r,_=s.lerp(t,c),f=l.lerp(e,c);for(let c=0;c<n;c++){let d=c/r,p=s.lerp(l,d),v=t.lerp(e,d);new vi(_,f).intersects(new vi(p,v),o),i=u*n+c,Xt.doubleToTwoFloats(o,gi,mi);let g=3*i;a[g]=gi.x,a[g+1]=gi.y,a[g+2]=gi.z,h[g]=mi.x,h[g+1]=mi.y,h[g+2]=mi.z}}}else if(i>0&&i<this._path.length){let l=this._path[i-1][0],u=this._path[i-1][1],c=this._path[i+1][0],_=this._path[i+1][1],f=i*s,d=(i-1)*s,p=d;for(let i=0;i<n;i++){let s=i/r,v=l.lerp(t,s),g=e.lerp(_,s),m=t.lerp(c,s),y=u.lerp(e,s);for(let s=0;s<n;s++){let x=s/r,b=l.lerp(u,x),A=t.lerp(e,x);new vi(v,y).intersects(new vi(b,A),o);let C=i*n+s;p=d+C,Xt.doubleToTwoFloats(o,gi,mi);let w=3*p;a[w]=gi.x,a[w+1]=gi.y,a[w+2]=gi.z,h[w]=mi.x,h[w+1]=mi.y,h[w+2]=mi.z;let E=c.lerp(_,x);A=t.lerp(e,x),new vi(m,g).intersects(new vi(A,E),o),p=f+C,Xt.doubleToTwoFloats(o,gi,mi),a[w=3*p]=gi.x,a[w+1]=gi.y,a[w+2]=gi.z,h[w]=mi.x,h[w+1]=mi.y,h[w+2]=mi.z}}}this._createBuffers()}}else this.addEdge3v(t,e)}removeEdge(t){this._path.splice(t,1),this.setPath([].concat(this._path))}setGridSize(t){this._gridSize=t,this.setPath([].concat(this._path))}getPath(){return this._path}setPath(t){this._verticesHigh=[],this._verticesLow=[],this._indexes=[],this._path=[];for(let e=0;e<t.length;e++){let i=t[e][0],r=t[e][1];i instanceof Array&&(i=new Xt(i[0],i[1],i[2])),r instanceof Array&&(r=new Xt(r[0],r[1],r[2])),this.addEdge3v(i,r)}}}const xi={POINT:1,LINESTRING:2,POLYGON:3,MULTIPOLYGON:4,MULTILINESTRING:5};class bi{constructor(t){this._id=bi._staticCounter++,(t=t||{}).style=t.style||{},this._entity=null,this._handler=null,this._handlerIndex=-1,this._polyVerticesMerc=[],this._polyVerticesLength=-1,this._polyIndexesLength=-1,this._polyVerticesHandlerIndex=-1,this._polyIndexesHandlerIndex=-1,this._lineVerticesMerc=[],this._lineVerticesLength=-1,this._lineOrdersLength=-1,this._lineIndexesLength=-1,this._lineColorsLength=-1,this._lineThicknessLength=-1,this._lineVerticesHandlerIndex=-1,this._lineOrdersHandlerIndex=-1,this._lineIndexesHandlerIndex=-1,this._lineThicknessHandlerIndex=-1,this._lineColorsHandlerIndex=-1,this._type=t.type&&bi.getType(t.type)||xi.POINT,this._coordinates=[],this._extent=bi.getExtent({type:t.type||"Point",coordinates:t.coordinates||[]},this._coordinates),this._style=t.style||{},this._style.fillColor=oe(t.style.fillColor,new Ut(.19,.62,.85,.4)),this._style.lineColor=oe(t.style.lineColor,new Ut(.19,.62,.85,1)),this._style.strokeColor=oe(t.style.strokeColor,new Ut(1,1,1,.95)),this._style.lineWidth=t.style.lineWidth||3,this._style.strokeWidth=t.style.strokeWidth||0,this._visibility=t.visibility||!0,this._pickingReady=!1}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}static getType(t){return xi[t.toUpperCase()]}static getExtent(t,e){var i=new Ot(new Rt(180,90),new Rt(-180,-90)),r=bi.getType(t.type);if(r===xi.POINT){let t=i.coordinates[0],r=i.coordinates[1];i.southWest.lon=t,i.southWest.lat=r,i.northEast.lon=t,i.northEast.lat=r,e&&(e[0]=t)&&(e[1]=r)}else if(r===xi.LINESTRING){let r=t.coordinates;for(let t=0;t<r.length;t++){let n=r[t][0],s=r[t][1];n<i.southWest.lon&&(i.southWest.lon=n),s<i.southWest.lat&&(i.southWest.lat=s),n>i.northEast.lon&&(i.northEast.lon=n),s>i.northEast.lat&&(i.northEast.lat=s),e&&(e[t]=[n,s])}}else if(r===xi.POLYGON){let r=t.coordinates;for(let t=0;t<r.length;t++){let n=r[t];e&&(e[t]=[]);for(let r=0;r<n.length;r++){let s=n[r],o=s[0],a=s[1];o<i.southWest.lon&&(i.southWest.lon=o),a<i.southWest.lat&&(i.southWest.lat=a),o>i.northEast.lon&&(i.northEast.lon=o),a>i.northEast.lat&&(i.northEast.lat=a),e&&(e[t][r]=[o,a])}}}else if(r===xi.MULTIPOLYGON){let r=t.coordinates;for(let t=0;t<r.length;t++){let n=r[t];e&&(e[t]=[]);for(let r=0;r<n.length;r++){let s=n[r];e&&(e[t][r]=[]);for(let n=0;n<s.length;n++){let o=s[n],a=o[0],h=o[1];a<i.southWest.lon&&(i.southWest.lon=a),h<i.southWest.lat&&(i.southWest.lat=h),a>i.northEast.lon&&(i.northEast.lon=a),h>i.northEast.lat&&(i.northEast.lat=h),e&&(e[t][r][n]=[a,h])}}}}else if(r===xi.MULTILINESTRING){let r=t.coordinates;for(let t=0;t<r.length;t++){let n=r[t];e&&(e[t]=[]);for(let r=0;r<n.length;r++){let s=n[r],o=s[0],a=s[1];o<i.southWest.lon&&(i.southWest.lon=o),a<i.southWest.lat&&(i.southWest.lat=a),o>i.northEast.lon&&(i.northEast.lon=o),a>i.northEast.lat&&(i.northEast.lat=a),e&&(e[t][r]=[o,a])}}}else i.southWest.lon=i.southWest.lat=i.northEast.lon=i.northEast.lat=0,e&&(e[0]=lon)&&(e[1]=lat);return i}setGeometry(t){var e=this._handler;return this.remove(),this._type=bi.getType(t.type||"Point"),this._extent=bi.getExtent(t,this._coordinates),e.add(this),this}setFillColor(t,e,i,r){var n=this._style.fillColor;return(0===n.w&&0!==r||0!==n.w&&0===r)&&(this._pickingReady=!1),n.x=t,n.y=e,n.z=i,n.w=r,this._handler&&this._handler.setPolyColorArr(this,n),this}setFillColor4v(t){return this.setFillColor(t.x,t.y,t.z,t.w)}setStrokeColor(t,e,i,r){var n=this._style.strokeColor;return(0===n.w&&0!==r||0!==n.w&&0===r)&&(this._pickingReady=!1),n.x=t,n.y=e,n.z=i,n.w=r,this._handler&&this._handler.setStrokeColorArr(this,n),this}setLineColor(t,e,i,r){var n=this._style.lineColor;return(0===n.w&&0!==r||0!==n.w&&0===r)&&(this._pickingReady=!1),n.x=t,n.y=e,n.z=i,n.w=r,this._handler&&this._handler.setLineColorArr(this,n),this}setStrokeColor4v(t){return this.setStrokeColor(t.x,t.y,t.z,t.w)}setLineColor4v(t){return this.setLineColor(t.x,t.y,t.z,t.w)}setStrokeOpacity(t){var e=this._style.strokeColor;return e.w=t,this.setStrokeColor(e.x,e.y,e.z,t)}setLineOpacity(t){var e=this._style.lineColor;return e.w=t,this.setLineColor(e.x,e.y,e.z,t)}setStrokeWidth(t){return this._style.strokeWidth=t,this._pickingReady=!1,this._handler&&this._handler.setLineStrokeArr(this,t),this}bringToFront(){return this._handler&&this._handler.bringToFront(this),this}setLineWidth(t){return this._style.lineWidth=t,this._pickingReady=!1,this._handler&&this._handler.setLineThicknessArr(this,t),this}setFillOpacity(t){var e=this._style.fillColor;return(0===e.w&&0!==t||0!==e.w&&0===t)&&(this._pickingReady=!1),e.w=t,this._handler&&this._handler.setPolyColorArr(this,e),this}setVisibility(t){return this._visibility=t,this._handler&&this._handler.setGeometryVisibility(this),this}getVisibility(){return this._visibility}remove(){this._handler&&this._handler.remove(this)}getExtent(){return this._extent.clone()}getType(){return this._type}}const Ai={RIGHT:0,LEFT:1,CENTER:2},Ci={left:Ai.LEFT,right:Ai.RIGHT,center:Ai.CENTER};class wi extends di{constructor(t){super(t),t=t||{},this._text=t.text,this._face=re(t.face,null),this._size=t.size||33,this._style=re(t.style,null),this._weight=re(t.weight,null),this._outline=void 0!=t.outline?t.outline:.5,this._outlineColor=oe(t.outlineColor,new Ut(0,0,0,1)),this._align=t.align&&Ci[t.align.trim().toLowerCase()]||Ai.RIGHT,this._fontIndex=0,this._fontAtlas=null}setText(t){this._text=t.toString(),this._handler&&this._handler.setText(this._handlerIndex,t,this._fontIndex,this._align)}getText(){return this._text}setAlign(t){this._align=Ci[t.trim().toLowerCase()],this._handler&&this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align)}getAlign(){return this._align}setFace(t){this._face=t.trim().toLowerCase(),this.update()}getFace(){return this._face}setSize(t){this._size=t,this._handler&&this._handler.setSizeArr(this._handlerIndex,t)}getSize(){return this._size}setStyle(t){this._style=t.trim().toLowerCase(),this.update()}getStyle(){return this._style}setWeight(t){this._weight=t.trim().toLowerCase(),this.update()}getWeight(){return this._wight}setOutline(t){this._outline=t,this._handler&&this._handler.setOutlineArr(this._handlerIndex,1-t)}getOutline(){return this._outline}setOpacity(t){this._color.w=t,this.setColor4v(this._color),this._outlineColor.w=t,this.setOutlineColor4v(this._outlineColor)}setOutlineColor(t,e,i,r){this._outlineColor.x=t,this._outlineColor.y=e,this._outlineColor.z=i,this._outlineColor.w=r,this._handler&&this._handler.setOutlineColorArr(this._handlerIndex,this._outlineColor)}setOutlineColor4v(t){this._outlineColor.x=t.x,this._outlineColor.y=t.y,this._outlineColor.z=t.z,this._outlineColor.w=t.w,this._handler&&this._handler.setOutlineColorArr(this._handlerIndex,t)}setOutlineColorHTML(t){this.setOutlineColor4v(Jt(t))}getOutlineColor(){return this._outlineColor}setOutlineOpacity(t){this._outlineColor.w=t,this._handler&&this._handler.setOutlineColorArr(this._handlerIndex,this._outlineColor)}getOutlineOpacity(){return this._outlineColor.w}update(){if(this._fontAtlas){var t=this._fontAtlas.getFontIndex(this._face,this._style,this._weight);void 0==t?this._fontAtlas.createFontAsync(this._face,this._style,this._weight,this._applyFontIndex.bind(this)):this._applyFontIndex(t)}}_applyFontIndex(t){this._fontIndex=t,this._handler&&(this._handler.setFontIndexArr(this._handlerIndex,this._fontIndex),this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align))}assignFontAtlas(t){!this._fontAtlas&&(this._fontAtlas=t),this.update()}}const Ei=0,Ti=1,Bi=2,Pi=[0,0,0,1],Ri=0,zi=1,Li=2,Mi=3;class Fi{constructor(t){t=t||{},this.id=Fi._staticCounter++,this.altitude=0,this.thickness=t.thickness||1.5,this.color=oe(t.color,new Ut(1,1,1,1)),this.color.w=void 0!=t.opacity?t.opacity:this.color.w,this.visibility=void 0==t.visibility||t.visibility,this._closedLine=t.isClosed||!1,this._path3v=[],this._pathLonLat=[],this._pathLonLatMerc=[],this._pathColors=t.pathColors||[],this._extent=new Ot,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._ordersBuffer=null,this._indexesBuffer=null,this._colorsBuffer=null,this._pickingColor=[0,0,0],this._renderNode=null,this._entity=null,this._handler=null,this._handlerIndex=-1,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[Ei]=this._createVerticesBuffer,this._buffersUpdateCallbacks[Ti]=this._createIndexBuffer,this._buffersUpdateCallbacks[Bi]=this._createColorsBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),t.pathLonLat?this.setPathLonLat(t.pathLonLat):t.path3v&&this.setPath3v(t.path3v),this._refresh()}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}static appendLineData3v(t,e,i,r,n,s,o,a,h,l,u,c,_){var f=0,d=new Xt,p=new Xt;c&&(c.southWest.set(180,90),c.northEast.set(-180,-90)),o.length>0?(f=o[o.length-5]+9,o.push(f,f)):o.push(0,0);for(var v=0,g=t.length;v<g;v++){var m=t[v],y=e[v];if(h[v]=[],u[v]=[],l[v]=[],0===m.length)continue;var x,b=f;if(i)(x=m[m.length-1])instanceof Array&&(x=new Xt(x[0],x[1],x[2]));else{var A=m[0],C=m[1]||A;A instanceof Array&&(A=new Xt(A[0],A[1],A[2])),C instanceof Array&&(C=new Xt(C[0],C[1],C[2])),x=new Xt(A.x+A.x-C.x,A.y+A.y-C.y,A.z+A.z-C.z)}let g=Pi;y&&y[0]&&(g=y[0]),Xt.doubleToTwoFloats(x,d,p),r.push(d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z),n.push(p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z);let B=g[Ri],P=g[zi],R=g[Li],z=void 0!=g[Mi]?g[Mi]:1;v>0&&_.push(B,P,R,z,B,P,R,z,B,P,R,z,B,P,R,z),s.push(1,-1,2,-2);for(let t=0,e=m.length;t<e;t++){var w=m[t];if(w instanceof Array&&(w=new Xt(w[0],w[1],w[2])),l[v].push(w),a){var E=a.cartesianToLonLat(w);h[v].push(E),u[v].push(E.forwardMercator()),E.lon<c.southWest.lon&&(c.southWest.lon=E.lon),E.lat<c.southWest.lat&&(c.southWest.lat=E.lat),E.lon>c.northEast.lon&&(c.northEast.lon=E.lon),E.lat>c.northEast.lat&&(c.northEast.lat=E.lat)}y&&y[t]&&(g=y[t]),B=g[Ri],P=g[zi],R=g[Li],z=void 0!=g[Mi]?g[Mi]:1,Xt.doubleToTwoFloats(w,d,p),r.push(d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z),n.push(p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z),_.push(B,P,R,z,B,P,R,z,B,P,R,z,B,P,R,z),s.push(1,-1,2,-2),o.push(f++,f++,f++,f++)}var T;if(i)(T=m[0])instanceof Array&&(T=new Xt(T[0],T[1],T[2])),o.push(b,b+1,b+1,b+1);else{let t=m[m.length-1],e=m[m.length-2]||t;t instanceof Array&&(t=new Xt(t[0],t[1],t[2])),e instanceof Array&&(e=new Xt(e[0],e[1],e[2])),T=new Xt(t.x+t.x-e.x,t.y+t.y-e.y,t.z+t.z-e.z),o.push(f-1,f-1,f-1,f-1)}y&&y[m.length-1]&&(g=y[m.length-1]),B=g[Ri],P=g[zi],R=g[Li],z=void 0!=g[Mi]?g[Mi]:1,Xt.doubleToTwoFloats(T,d,p),r.push(d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z),n.push(p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z),_.push(B,P,R,z,B,P,R,z,B,P,R,z,B,P,R,z),s.push(1,-1,2,-2),v<t.length-1&&0!==t[v+1].length&&(f+=8,o.push(f,f))}}static appendPoint3v(t,e,i,r,n,s,o,a,h,l,u,c,_,f){var d=new Xt,p=new Xt,v=l.length-4,g=l[v-1]+1;0===t.length?(t.push([]),i[0]||(i[0]=[])):i[t.length-1]||(i[t.length-1]=[]);var m=t[t.length-1],y=m.length;m.push(e);let x=r[Ri],b=r[zi],A=r[Li],C=void 0!=r[Mi]?r[Mi]:1,w=i[t.length-1];if(w[y]?(w[y][Ri]=x,w[y][zi]=b,w[y][Li]=A,w[y][Mi]=C):w.push(r),1===y){var E;if(n)(E=m[y-1])instanceof Array&&(E=new Xt(E[0],E[1],E[2]));else{var T=m[0],B=m[1]||T;T instanceof Array&&(T=new Xt(T[0],T[1],T[2])),B instanceof Array&&(B=new Xt(B[0],B[1],B[2])),E=new Xt(T.x+T.x-B.x,T.y+T.y-B.y,T.z+T.z-B.z)}Xt.doubleToTwoFloats(E,d,p);let t=s.length-36;s[t]=d.x,s[t+1]=d.y,s[t+2]=d.z,s[t+3]=d.x,s[t+4]=d.y,s[t+5]=d.z,s[t+6]=d.x,s[t+7]=d.y,s[t+8]=d.z,s[t+9]=d.x,s[t+10]=d.y,s[t+11]=d.z,o[t]=p.x,o[t+1]=p.y,o[t+2]=p.z,o[t+3]=p.x,o[t+4]=p.y,o[t+5]=p.z,o[t+6]=p.x,o[t+7]=p.y,o[t+8]=p.z,o[t+9]=p.x,o[t+10]=p.y,o[t+11]=p.z}var P=g;if(u){var R=c[c.length-1],z=_[_.length-1];let t=u.cartesianToLonLat(e);R.push(t),z.push(t.forwardMercator()),t.lon<f.southWest.lon&&(f.southWest.lon=t.lon),t.lat<f.southWest.lat&&(f.southWest.lat=t.lat),t.lon>f.northEast.lon&&(f.northEast.lon=t.lon),t.lat>f.northEast.lat&&(f.northEast.lat=t.lat)}Xt.doubleToTwoFloats(e,d,p);let L=s.length-12;s[L]=d.x,s[L+1]=d.y,s[L+2]=d.z,s[L+3]=d.x,s[L+4]=d.y,s[L+5]=d.z,s[L+6]=d.x,s[L+7]=d.y,s[L+8]=d.z,s[L+9]=d.x,s[L+10]=d.y,s[L+11]=d.z,o[L]=p.x,o[L+1]=p.y,o[L+2]=p.z,o[L+3]=p.x,o[L+4]=p.y,o[L+5]=p.z,o[L+6]=p.x,o[L+7]=p.y,o[L+8]=p.z,o[L+9]=p.x,o[L+10]=p.y,o[L+11]=p.z;let M=a.length-16;var F;if(a[M]=x,a[M+1]=b,a[M+2]=A,a[M+3]=C,a[M+4]=x,a[M+5]=b,a[M+6]=A,a[M+7]=C,a[M+8]=x,a[M+9]=b,a[M+10]=A,a[M+11]=C,a[M+12]=x,a[M+13]=b,a[M+14]=A,a[M+15]=C,l[v]=g++,l[v+1]=g++,l[v+2]=g++,l[v+3]=g++,n)F=m[0],l.push(P,P+1,P+1,P+1);else{let t=m[m.length-1],e=m[m.length-2]||t;F=new Xt(t.x+t.x-e.x,t.y+t.y-e.y,t.z+t.z-e.z),l.push(g-1,g-1,g-1,g-1)}Xt.doubleToTwoFloats(F,d,p),s.push(d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z),o.push(p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z),a.push(x,b,A,C,x,b,A,C,x,b,A,C,x,b,A,C),h.push(1,-1,2,-2)}static appendLineDataLonLat(t,e,i,r,n,s,o,a,h,l,u,c,_){var f=0,d=new Xt,p=new Xt;c&&(c.southWest.set(180,90),c.northEast.set(-180,-90)),o.length>0?(f=o[o.length-5]+9,o.push(f,f)):o.push(0,0);for(var v=0,g=t.length;v<g;v++){var m=t[v],y=e[v];if(h[v]=[],u[v]=[],l[v]=[],0===m.length)continue;var x,b=f;if(i){let t=m[m.length-1];x=t instanceof Array?a.lonLatToCartesian(new Rt(t[0],t[1],t[2])):a.lonLatToCartesian(t)}else{let t,e,i=m[0];t=i instanceof Array?a.lonLatToCartesian(new Rt(i[0],i[1],i[2])):a.lonLatToCartesian(i),(i=m[1])||(i=m[0]),e=i instanceof Array?a.lonLatToCartesian(new Rt(i[0],i[1],i[2])):a.lonLatToCartesian(i),x=new Xt(t.x+t.x-e.x,t.y+t.y-e.y,t.z+t.z-e.z)}let g=Pi;y&&y[0]&&(g=y[0]),Xt.doubleToTwoFloats(x,d,p),r.push(d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z),n.push(p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z);let E=g[Ri],T=g[zi],B=g[Li],P=void 0!=g[Mi]?g[Mi]:1;v>0&&_.push(E,T,B,P,E,T,B,P,E,T,B,P,E,T,B,P),s.push(1,-1,2,-2);for(let t=0,e=m.length;t<e;t++){var A=m[t];A instanceof Array&&(A=new Rt(A[0],A[1],A[2])),y&&y[t]&&(g=y[t]),E=g[Ri],T=g[zi],B=g[Li],P=void 0!=g[Mi]?g[Mi]:1;var C=a.lonLatToCartesian(A);h[v].push(C),l[v].push(A),u[v].push(A.forwardMercator()),Xt.doubleToTwoFloats(C,d,p),r.push(d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z),n.push(p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z),_.push(E,T,B,P,E,T,B,P,E,T,B,P,E,T,B,P),s.push(1,-1,2,-2),o.push(f++,f++,f++,f++),A.lon<c.southWest.lon&&(c.southWest.lon=A.lon),A.lat<c.southWest.lat&&(c.southWest.lat=A.lat),A.lon>c.northEast.lon&&(c.northEast.lon=A.lon),A.lat>c.northEast.lat&&(c.northEast.lat=A.lat)}var w;if(i){let t=m[0];w=t instanceof Array?a.lonLatToCartesian(new Rt(t[0],t[1],t[2])):a.lonLatToCartesian(t),o.push(b,b+1,b+1,b+1)}else{let t,e,i=m[m.length-1];t=i instanceof Array?a.lonLatToCartesian(new Rt(i[0],i[1],i[2])):a.lonLatToCartesian(i),(i=m[m.length-2])||(i=m[0]),e=i instanceof Array?a.lonLatToCartesian(new Rt(i[0],i[1],i[2])):a.lonLatToCartesian(i),w=new Xt(t.x+t.x-e.x,t.y+t.y-e.y,t.z+t.z-e.z),o.push(f-1,f-1,f-1,f-1)}y&&y[m.length-1]&&(g=y[m.length-1]),E=g[Ri],T=g[zi],B=g[Li],P=void 0!=g[Mi]?g[Mi]:1,Xt.doubleToTwoFloats(w,d,p),r.push(d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z),n.push(p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z),_.push(E,T,B,P,E,T,B,P,E,T,B,P,E,T,B,P),s.push(1,-1,2,-2),v<t.length-1&&0!==t[v+1].length&&(f+=8,o.push(f,f))}}_setEqualPath3v(t){var e=this._extent;e.southWest.set(180,90),e.northEast.set(-180,-90);for(var i=new Xt,r=new Xt,n=this._verticesHigh,s=this._verticesLow,o=this._pathLonLat,a=this._pathLonLatMerc,h=0,l=this._renderNode.ellipsoid,u=0;u<t.length;u++){var c,_,f=t[u];c=this._closedLine?f[f.length-1]:new Xt(f[0].x+f[0].x-f[1].x,f[0].y+f[0].y-f[1].y,f[0].z+f[0].z-f[1].z),Xt.doubleToTwoFloats(c,i,r),n[h]=i.x,s[h++]=r.x,n[h]=i.y,s[h++]=r.y,n[h]=i.z,s[h++]=r.z,n[h]=i.x,s[h++]=r.x,n[h]=i.y,s[h++]=r.y,n[h]=i.z,s[h++]=r.z,n[h]=i.x,s[h++]=r.x,n[h]=i.y,s[h++]=r.y,n[h]=i.z,s[h++]=r.z,n[h]=i.x,s[h++]=r.x,n[h]=i.y,s[h++]=r.y,n[h]=i.z,s[h++]=r.z;for(var d=0;d<f.length;d++){var p=f[d],v=this._path3v[u][d];if(v.x=p.x,v.y=p.y,v.z=p.z,l){var g=l.cartesianToLonLat(p);this._pathLonLat[u][d]=g,o[u][d]=g,a[u][d]=g.forwardMercator(),g.lon<e.southWest.lon&&(e.southWest.lon=g.lon),g.lat<e.southWest.lat&&(e.southWest.lat=g.lat),g.lon>e.northEast.lon&&(e.northEast.lon=g.lon),g.lat>e.northEast.lat&&(e.northEast.lat=g.lat)}Xt.doubleToTwoFloats(p,i,r),n[h]=i.x,s[h++]=r.x,n[h]=i.y,s[h++]=r.y,n[h]=i.z,s[h++]=r.z,n[h]=i.x,s[h++]=r.x,n[h]=i.y,s[h++]=r.y,n[h]=i.z,s[h++]=r.z,n[h]=i.x,s[h++]=r.x,n[h]=i.y,s[h++]=r.y,n[h]=i.z,s[h++]=r.z,n[h]=i.x,s[h++]=r.x,n[h]=i.y,s[h++]=r.y,n[h]=i.z,s[h++]=r.z}if(this._closedLine)_=f[0];else{var m=f.length-1;_=new Xt(f[m].x+f[m].x-f[m-1].x,f[m].y+f[m].y-f[m-1].y,f[m].z+f[m].z-f[m-1].z)}Xt.doubleToTwoFloats(_,i,r),n[h]=i.x,s[h++]=r.x,n[h]=i.y,s[h++]=r.y,n[h]=i.z,s[h++]=r.z,n[h]=i.x,s[h++]=r.x,n[h]=i.y,s[h++]=r.y,n[h]=i.z,s[h++]=r.z,n[h]=i.x,s[h++]=r.x,n[h]=i.y,s[h++]=r.y,n[h]=i.z,s[h++]=r.z,n[h]=i.x,s[h++]=r.x,n[h]=i.y,s[h++]=r.y,n[h]=i.z,s[h++]=r.z}}_setEqualPathLonLat(t){var e=this._extent;e.southWest.set(180,90),e.northEast.set(-180,-90);for(var i=new Xt,r=new Xt,n=this._verticesHigh,s=this._verticesLow,o=this._pathLonLat,a=this._pathLonLatMerc,h=this._path3v,l=0,u=this._renderNode.ellipsoid,c=0;c<t.length;c++){var _,f,d=t[c];if(this._closedLine)_=u.lonLatToCartesian(d[d.length-1]);else{let t=u.lonLatToCartesian(d[0]),e=u.lonLatToCartesian(d[1]);_=new Xt(t.x+t.x-e.x,t.y+t.y-e.y,t.z+t.z-e.z)}Xt.doubleToTwoFloats(_,i,r),n[l]=i.x,s[l++]=r.x,n[l]=i.y,s[l++]=r.y,n[l]=i.z,s[l++]=r.z,n[l]=i.x,s[l++]=r.x,n[l]=i.y,s[l++]=r.y,n[l]=i.z,s[l++]=r.z,n[l]=i.x,s[l++]=r.x,n[l]=i.y,s[l++]=r.y,n[l]=i.z,s[l++]=r.z,n[l]=i.x,s[l++]=r.x,n[l]=i.y,s[l++]=r.y,n[l]=i.z,s[l++]=r.z;for(var p=0;p<d.length;p++){var v=d[p],g=u.lonLatToCartesian(v);h[c][p]=g,a[c][p]=v.forwardMercator(),o[c][p]=v,Xt.doubleToTwoFloats(g,i,r),n[l]=i.x,s[l++]=r.x,n[l]=i.y,s[l++]=r.y,n[l]=i.z,s[l++]=r.z,n[l]=i.x,s[l++]=r.x,n[l]=i.y,s[l++]=r.y,n[l]=i.z,s[l++]=r.z,n[l]=i.x,s[l++]=r.x,n[l]=i.y,s[l++]=r.y,n[l]=i.z,s[l++]=r.z,n[l]=i.x,s[l++]=r.x,n[l]=i.y,s[l++]=r.y,n[l]=i.z,s[l++]=r.z,v.lon<e.southWest.lon&&(e.southWest.lon=v.lon),v.lat<e.southWest.lat&&(e.southWest.lat=v.lat),v.lon>e.northEast.lon&&(e.northEast.lon=v.lon),v.lat>e.northEast.lat&&(e.northEast.lat=v.lat)}if(this._closedLine)f=u.lonLatToCartesian(d[0]);else{let t=u.lonLatToCartesian(d[d.length-1]),e=u.lonLatToCartesian(d[d.length-2]);f=new Xt(t.x+t.x-e.x,t.y+t.y-e.y,t.z+t.z-e.z)}Xt.doubleToTwoFloats(f,i,r),n[l]=i.x,s[l++]=r.x,n[l]=i.y,s[l++]=r.y,n[l]=i.z,s[l++]=r.z,n[l]=i.x,s[l++]=r.x,n[l]=i.y,s[l++]=r.y,n[l]=i.z,s[l++]=r.z,n[l]=i.x,s[l++]=r.x,n[l]=i.y,s[l++]=r.y,n[l]=i.z,s[l++]=r.z,n[l]=i.x,s[l++]=r.x,n[l]=i.y,s[l++]=r.y,n[l]=i.z,s[l++]=r.z}}setPointLonLat(t,e,i){if(this._renderNode&&this._renderNode.ellipsoid){let l=this._pathLonLat,u=this._pathLonLatMerc;l[i][e]=t,u[i][e]=t.forwardMercator();var r=this._extent;r.southWest.set(180,90),r.northEast.set(-180,-90);for(var n=0;n<l.length;n++)for(var s=l[n],o=0;o<s.length;o++){var a=s[o].lon,h=s[o].lat;a>r.northEast.lon&&(r.northEast.lon=a),h>r.northEast.lat&&(r.northEast.lat=h),a<r.southWest.lon&&(r.southWest.lon=a),h<r.southWest.lat&&(r.southWest.lat=h)}this.setPoint3v(this._renderNode.ellipsoid.lonLatToCartesian(t),e,i,!0)}else{let r=this._pathLonLat[i];r[e].lon=t.lon,r[e].lat=t.lat,r[e].height=t.height}}setPoint3v(t,e,i,r){if(i=i||0,this._renderNode){for(var n=new Xt,s=new Xt,o=this._verticesHigh,a=this._verticesLow,h=this._pathLonLat,l=this._pathLonLatMerc,u=0,c=0,_=0;_<i;_++)c+=12*this._path3v[_].length+24;let A=this._path3v[i];if(A[e].x=t.x,A[e].y=t.y,A[e].z=t.z,1===A.length)return;var f;if(0===e||1===e)f=this._closedLine?A[A.length-1]:new Xt(A[0].x+A[0].x-A[1].x,A[0].y+A[0].y-A[1].y,A[0].z+A[0].z-A[1].z),u=c,Xt.doubleToTwoFloats(f,n,s),o[u]=n.x,o[u+1]=n.y,o[u+2]=n.z,o[u+3]=n.x,o[u+4]=n.y,o[u+5]=n.z,o[u+6]=n.x,o[u+7]=n.y,o[u+8]=n.z,o[u+9]=n.x,o[u+10]=n.y,o[u+11]=n.z,a[u]=s.x,a[u+1]=s.y,a[u+2]=s.z,a[u+3]=s.x,a[u+4]=s.y,a[u+5]=s.z,a[u+6]=s.x,a[u+7]=s.y,a[u+8]=s.z,a[u+9]=s.x,a[u+10]=s.y,a[u+11]=s.z;if(!r&&this._renderNode.ellipsoid){var d=this._renderNode.ellipsoid.cartesianToLonLat(t);h[i][e]=d,l[i][e]=d.forwardMercator();var p=this._extent;p.southWest.set(180,90),p.northEast.set(-180,-90);for(_=0;_<h.length;_++)for(var v=h[_],g=0;g<v.length;g++){var m=v[g].lon,y=v[g].lat;m>p.northEast.lon&&(p.northEast.lon=m),y>p.northEast.lat&&(p.northEast.lat=y),m<p.southWest.lon&&(p.southWest.lon=m),y<p.southWest.lat&&(p.southWest.lat=y)}}if(u=c+12*e+12,Xt.doubleToTwoFloats(t,n,s),o[u]=n.x,o[u+1]=n.y,o[u+2]=n.z,o[u+3]=n.x,o[u+4]=n.y,o[u+5]=n.z,o[u+6]=n.x,o[u+7]=n.y,o[u+8]=n.z,o[u+9]=n.x,o[u+10]=n.y,o[u+11]=n.z,a[u]=s.x,a[u+1]=s.y,a[u+2]=s.z,a[u+3]=s.x,a[u+4]=s.y,a[u+5]=s.z,a[u+6]=s.x,a[u+7]=s.y,a[u+8]=s.z,a[u+9]=s.x,a[u+10]=s.y,a[u+11]=s.z,e===A.length-1||e===A.length-2){var x;if(this._closedLine)x=A[0];else{var b=A.length-1;x=new Xt(A[b].x+A[b].x-A[b-1].x,A[b].y+A[b].y-A[b-1].y,A[b].z+A[b].z-A[b-1].z)}u=c+12*A.length+12,Xt.doubleToTwoFloats(x,n,s),o[u]=n.x,o[u+1]=n.y,o[u+2]=n.z,o[u+3]=n.x,o[u+4]=n.y,o[u+5]=n.z,o[u+6]=n.x,o[u+7]=n.y,o[u+8]=n.z,o[u+9]=n.x,o[u+10]=n.y,o[u+11]=n.z,a[u]=s.x,a[u+1]=s.y,a[u+2]=s.z,a[u+3]=s.x,a[u+4]=s.y,a[u+5]=s.z,a[u+6]=s.x,a[u+7]=s.y,a[u+8]=s.z,a[u+9]=s.x,a[u+10]=s.y,a[u+11]=s.z}this._changedBuffers[Ei]=!0}else{let r=this._path3v[i];r[e].x=t.x,r[e].y=t.y,r[e].z=t.z}}removePoint(t,e){e=e||0,this._path3v[e].splice(t,1),this.setPath3v([].concat(this._path3v))}appendPoint3v(t,e,i){Fi.appendPoint3v(this._path3v,t,this._pathColors,e,this._closedLine,this._verticesHigh,this._verticesLow,this._colors,this._orders,this._indexes,!i&&this._renderNode.ellipsoid,this._pathLonLat,this._pathLonLatMerc,this._extent),this._changedBuffers[Ei]=!0,this._changedBuffers[Bi]=!0,this._changedBuffers[Ti]=!0}addPoint3v(t,e){(e=e||0)>=this._path3v.length&&this._path3v.push([]),this._path3v[e].push(t),this.setPath3v([].concat(this._path3v))}addPointLonLat(t,e){(e=e||0)>=this._pathLonLat.length&&this._pathLonLat.push([]),this._pathLonLat[e].push(t),this.setPathLonLat([].concat(this._pathLonLat))}clear(){this._clearData()}setPointColor(t,e,i=0){if(this._renderNode){let n=this._pathColors[i];if(!n){if(!(this._path3v[i]&&e<this._path3v[i].length))return;this._pathColors[i]=new Array(this._path3v[i].length)}n[e]?(n[e][Ri]=t[Ri],n[e][zi]=t[zi],n[e][Li]=t[Li],n[e][Mi]=t[Mi]||1):n[e]=new Array(t[Ri],t[zi],t[Li],t[Mi]||1);let s=this._colors,o=0,a=0;for(var r=0;r<i;r++)a+=16*this._path3v[r].length+32;o=a;let h=t[Ri],l=t[zi],u=t[Li],c=t[Mi]||1;s[o]=h,s[o+1]=l,s[o+2]=u,s[o+3]=c,s[o+4]=h,s[o+5]=l,s[o+6]=u,s[o+7]=c,s[o+8]=h,s[o+9]=l,s[o+10]=u,s[o+11]=c,s[o+12]=h,s[o+13]=l,s[o+14]=u,s[o+15]=c,this._changedBuffers[Bi]=!0}else{this._pathColors[i][e]=t}}setOpacity(t){this.color.w=t}setThickness(t){this.thickness=t}getThickness(){return this.thickness}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){this._renderNode=t,this._pathLonLat.length?this._createDataLonLat([].concat(this._pathLonLat)):this._createData3v([].concat(this._path3v))}_clearData(){this._verticesHigh.length=0,this._verticesLow.length=0,this._orders.length=0,this._indexes.length=0,this._colors.length=0,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._path3v.length=0,this._pathLonLat.length=0,this._pathLonLatMerc.length=0,this._path3v=[],this._pathLonLat=[],this._pathLonLatMerc=[]}_createData3v(t){this._clearData(),Fi.appendLineData3v(t,this._pathColors,this._closedLine,this._verticesHigh,this._verticesLow,this._orders,this._indexes,this._renderNode.ellipsoid,this._pathLonLat,this._path3v,this._pathLonLatMerc,this._extent,this._colors)}_createDataLonLat(t){this._clearData(),Fi.appendLineDataLonLat(t,this._pathColors,this._closedLine,this._verticesHigh,this._verticesLow,this._orders,this._indexes,this._renderNode.ellipsoid,this._path3v,this._pathLonLat,this._pathLonLatMerc,this._extent,this._colors)}remove(){this._entity=null,this._verticesHigh.length=0,this._verticesLow.length=0,this._orders.length=0,this._indexes.length=0,this._colors.length=0,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._deleteBuffers(),this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._pickingColor[0]=t.x/255,this._pickingColor[1]=t.y/255,this._pickingColor[2]=t.z/255}getExtent(){return this._extent.clone()}getPath3v(){return this._path3v}getPathLonLat(){return this._pathLonLat}getPathColors(){return this._pathColors}setPathColors(t){this._renderNode}setPointColor(t,e,i){let r=this._pathColors[i];r&&(r[e][0]=t[0],r[e][1]=t[1],r[e][2]=t[2],r[e][3]=t[3])}setPathLonLat(t,e){this._renderNode&&this._renderNode.ellipsoid?e?(this._setEqualPathLonLat(t),this._changedBuffers[Ei]=!0,this._changedBuffers[Bi]=!0):(this._createDataLonLat(t),this._changedBuffers[Ei]=!0,this._changedBuffers[Ti]=!0,this._changedBuffers[Bi]=!0):this._pathLonLat=[].concat(t)}setPath3v(t,e,i){e&&(this._pathColors=[].concat(e)),this._renderNode?i?(this._setEqualPath3v(t),this._changedBuffers[Ei]=!0,this._changedBuffers[Bi]=!0):(this._createData3v(t),this._changedBuffers[Ei]=!0,this._changedBuffers[Ti]=!0,this._changedBuffers[Bi]=!0):this._path3v=[].concat(t)}draw(){if(this.visibility&&this._path3v.length){this._update();var t=this._renderNode,e=t.renderer,i=e.handler.programs.polyline_screen,r=i._program,n=e.handler.gl,s=r.attributes,o=r.uniforms;i.activate(),n.polygonOffset(this._handler._entityCollection.polygonOffsetFactor,this._handler._entityCollection.polygonOffsetUnits),n.enable(n.BLEND),n.blendEquationSeparate(n.FUNC_ADD,n.FUNC_ADD),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA),n.disable(n.CULL_FACE),n.uniformMatrix4fv(o.proj,!1,e.activeCamera._projectionMatrix._m),n.uniformMatrix4fv(o.view,!1,e.activeCamera._viewMatrix._m),n.uniform3fv(o.eyePositionHigh,e.activeCamera.eyeHigh),n.uniform3fv(o.eyePositionLow,e.activeCamera.eyeLow),n.uniform2fv(o.uFloatParams,[t._planetRadius2||0,e.activeCamera._tanViewAngle_hradOneByHeight]),n.uniform2fv(o.viewport,[e.handler.canvas.width,e.handler.canvas.height]),n.uniform1f(o.thickness,.5*this.thickness),n.bindBuffer(n.ARRAY_BUFFER,this._colorsBuffer),n.vertexAttribPointer(s.color,this._colorsBuffer.itemSize,n.FLOAT,!1,0,0);var a=this._verticesHighBuffer;n.bindBuffer(n.ARRAY_BUFFER,a),n.vertexAttribPointer(s.prevHigh,a.itemSize,n.FLOAT,!1,12,0),n.vertexAttribPointer(s.currentHigh,a.itemSize,n.FLOAT,!1,12,48),n.vertexAttribPointer(s.nextHigh,a.itemSize,n.FLOAT,!1,12,96),a=this._verticesLowBuffer,n.bindBuffer(n.ARRAY_BUFFER,a),n.vertexAttribPointer(s.prevLow,a.itemSize,n.FLOAT,!1,12,0),n.vertexAttribPointer(s.currentLow,a.itemSize,n.FLOAT,!1,12,48),n.vertexAttribPointer(s.nextLow,a.itemSize,n.FLOAT,!1,12,96),n.bindBuffer(n.ARRAY_BUFFER,this._ordersBuffer),n.vertexAttribPointer(s.order,this._ordersBuffer.itemSize,n.FLOAT,!1,4,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._indexesBuffer),n.drawElements(n.TRIANGLE_STRIP,this._indexesBuffer.numItems,n.UNSIGNED_INT,0)}}drawPicking(){if(this.visibility&&this._path3v.length){var t=this._renderNode,e=t.renderer,i=e.handler.programs.polyline_picking,r=i._program,n=e.handler.gl,s=r.attributes,o=r.uniforms;i.activate(),n.polygonOffset(this._handler._entityCollection.polygonOffsetFactor,this._handler._entityCollection.polygonOffsetUnits),n.enable(n.BLEND),n.blendEquationSeparate(n.FUNC_ADD,n.FUNC_ADD),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA),n.disable(n.CULL_FACE),n.uniformMatrix4fv(o.proj,!1,e.activeCamera._projectionMatrix._m),n.uniformMatrix4fv(o.view,!1,e.activeCamera._viewMatrix._m),n.uniform4fv(o.color,[this._pickingColor[0],this._pickingColor[1],this._pickingColor[2],1]),n.uniform3fv(o.eyePositionHigh,e.activeCamera.eyeHigh),n.uniform3fv(o.eyePositionLow,e.activeCamera.eyeLow),n.uniform2fv(o.uFloatParams,[t._planetRadius2||0,e.activeCamera._tanViewAngle_hradOneByHeight]),n.uniform2fv(o.viewport,[e.handler.canvas.width,e.handler.canvas.height]),n.uniform1f(o.thickness,.5*this.thickness);var a=this._verticesHighBuffer;n.bindBuffer(n.ARRAY_BUFFER,a),n.vertexAttribPointer(s.prevHigh,a.itemSize,n.FLOAT,!1,12,0),n.vertexAttribPointer(s.currentHigh,a.itemSize,n.FLOAT,!1,12,48),n.vertexAttribPointer(s.nextHigh,a.itemSize,n.FLOAT,!1,12,96),a=this._verticesLowBuffer,n.bindBuffer(n.ARRAY_BUFFER,a),n.vertexAttribPointer(s.prevLow,a.itemSize,n.FLOAT,!1,12,0),n.vertexAttribPointer(s.currentLow,a.itemSize,n.FLOAT,!1,12,48),n.vertexAttribPointer(s.nextLow,a.itemSize,n.FLOAT,!1,12,96),n.bindBuffer(n.ARRAY_BUFFER,this._ordersBuffer),n.vertexAttribPointer(s.order,this._ordersBuffer.itemSize,n.FLOAT,!1,4,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._indexesBuffer),n.drawElements(n.TRIANGLE_STRIP,this._indexesBuffer.numItems,n.UNSIGNED_INT,0)}}_refresh(){for(var t=this._changedBuffers.length;t--;)this._changedBuffers[t]=!0}_update(){if(this._renderNode)for(var t=this._changedBuffers.length;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}_deleteBuffers(){if(this._renderNode){var t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._verticesHighBuffer),t.deleteBuffer(this._verticesLowBuffer),t.deleteBuffer(this._ordersBuffer),t.deleteBuffer(this._indexesBuffer),t.deleteBuffer(this._colorsBuffer),this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._ordersBuffer=null,this._indexesBuffer=null,this._colorsBuffer=null}}_createVerticesBuffer(){var t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._verticesHighBuffer),t.gl.deleteBuffer(this._verticesLowBuffer),this._verticesHighBuffer=t.createArrayBuffer(new Float32Array(this._verticesHigh),3,this._verticesHigh.length/3),this._verticesLowBuffer=t.createArrayBuffer(new Float32Array(this._verticesLow),3,this._verticesLow.length/3)}_createIndexBuffer(){var t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._ordersBuffer),t.gl.deleteBuffer(this._indexesBuffer),this._ordersBuffer=t.createArrayBuffer(new Float32Array(this._orders),1,this._orders.length/2),this._indexesBuffer=t.createElementArrayBuffer(new Uint32Array(this._indexes),1,this._indexes.length)}_createColorsBuffer(){var t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._colorsBuffer),this._colorsBuffer=t.createArrayBuffer(new Float32Array(this._colors),4,this._colors.length/4)}}const Di=0,Si=1,Ni=2;class ki{constructor(t){t=t||{},this.id=ki._staticCounter++,this.visibility=void 0==t.visibility||t.visibility,this.pointSize=t.pointSize||3,this.pickingDistance=t.pickingDistance||0,this._renderNode=null,this._entity=null,this._points=[],this._coordinatesData=[],this._colorData=[],this._pickingColorData=[],this._coordinatesBuffer=null,this._colorBuffer=null,this._pickingColorBuffer=null,this._handler=null,this._handlerIndex=-1,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[Di]=this._createCoordinatesBuffer,this._buffersUpdateCallbacks[Si]=this._createColorBuffer,this._buffersUpdateCallbacks[Ni]=this._createPickingColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),this.setPoints(t.points)}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}clear(){this._points.length=0,this._points=[],this._coordinatesData.length=0,this._coordinatesData=[],this._colorData.length=0,this._colorData=[],this._pickingColorData.length=0,this._pickingColorData=[],this._deleteBuffers()}setOpacity(t){this.opacity=t}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){this._renderNode=t,this._setPickingColors()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPoints(t){this.clear();for(var e=0;e<t.length;e++){var i=t[e],r=new Xt(i[0],i[1],i[2]),n=new Ut(i[3],i[4],i[5],void 0==i[6]?255:i[6]);this._coordinatesData.push(r.x,r.y,r.z),this._colorData.push(n.x/255,n.y/255,n.z/255,n.w/255);var s={_pickingColor:new Xt,_entityCollection:this._entity&&this._entity._entityCollection,index:e,position:r,color:n,pointCloud:this,properties:i[7]||{}};this._points.push(s),this._renderNode&&(this._renderNode.renderer.assignPickingColor(s),this._pickingColorData.push(s._pickingColor.x/255,s._pickingColor.y/255,s._pickingColor.z/255,1))}this._changedBuffers[Di]=!0,this._changedBuffers[Si]=!0,this._changedBuffers[Ni]=!0}setPointPosition(t,e,i,r){this._changedBuffers[Di]=!0}setPointColor(t,e,i,r,n){this._changedBuffers[Si]=!0}addPoints(t){this._changedBuffers[Di]=!0,this._changedBuffers[Si]=!0,this._changedBuffers[Ni]=!0}addPoint(t,e){this._changedBuffers[Di]=!0,this._changedBuffers[Si]=!0,this._changedBuffers[Ni]=!0}getPoint(t){return this._points[t]}removePoint(t){this._changedBuffers[Di]=!0,this._changedBuffers[Si]=!0,this._changedBuffers[Ni]=!0}insertPoint(t,e){this._changedBuffers[Di]=!0,this._changedBuffers[Si]=!0,this._changedBuffers[Ni]=!0}each(t){for(var e=this._points.length;e--;)t&&t(this._points[e])}draw(){if(this.visibility&&this._coordinatesData.length){this._update();var t=this._renderNode.renderer,e=t.handler.programs.pointCloud,i=e._program,r=t.handler.gl,n=i.attributes,s=i.uniforms;r.polygonOffset(this._handler._entityCollection.polygonOffsetFactor,this._handler._entityCollection.polygonOffsetUnits),e.activate(),r.uniformMatrix4fv(s.projectionViewMatrix,!1,t.activeCamera._projectionViewMatrix._m),r.uniform1f(s.opacity,this._handler._entityCollection._fadingOpacity),r.uniform1f(s.pointSize,this.pointSize),r.bindBuffer(r.ARRAY_BUFFER,this._coordinatesBuffer),r.vertexAttribPointer(n.coordinates,this._coordinatesBuffer.itemSize,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this._colorBuffer),r.vertexAttribPointer(n.colors,this._colorBuffer.itemSize,r.FLOAT,!1,0,0),r.drawArrays(r.POINTS,0,this._coordinatesBuffer.numItems)}}drawPicking(){if(this.visibility&&this._coordinatesData.length){var t=this._renderNode.renderer,e=t.handler.programs.pointCloud,i=e._program,r=t.handler.gl,n=i.attributes,s=i.uniforms;e.activate(),r.polygonOffset(this._handler._entityCollection.polygonOffsetFactor,this._handler._entityCollection.polygonOffsetUnits),r.uniformMatrix4fv(s.projectionViewMatrix,!1,t.activeCamera._projectionViewMatrix._m),r.uniform1f(s.opacity,this._handler._entityCollection._fadingOpacity),r.uniform1f(s.pointSize,this.pointSize+this.pickingDistance),r.bindBuffer(r.ARRAY_BUFFER,this._coordinatesBuffer),r.vertexAttribPointer(n.coordinates,this._coordinatesBuffer.itemSize,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this._pickingColorBuffer),r.vertexAttribPointer(n.colors,this._pickingColorBuffer.itemSize,r.FLOAT,!1,0,0),r.drawArrays(r.POINTS,0,this._coordinatesBuffer.numItems)}}_update(){if(this._renderNode)for(var t=this._changedBuffers.length;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}_deleteBuffers(){if(this._renderNode){var t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._coordinatesBuffer),t.deleteBuffer(this._colorBuffer),t.deleteBuffer(this._pickingColorBuffer)}this._coordinatesBuffer=null,this._colorBuffer=null,this._pickingColorBuffer=null}_createCoordinatesBuffer(){var t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._coordinatesBuffer),this._coordinatesBuffer=t.createArrayBuffer(new Float32Array(this._coordinatesData),3,this._coordinatesData.length/3)}_createColorBuffer(){var t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._colorBuffer),this._colorBuffer=t.createArrayBuffer(new Float32Array(this._colorData),4,this._colorData.length/4)}_createPickingColorBuffer(){var t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorBuffer=t.createArrayBuffer(new Float32Array(this._pickingColorData),4,this._pickingColorData.length/4)}_setPickingColors(){if(this._renderNode){for(var t=0;t<this._points.length;t++){var e=this._points[t];e._entity=this._entity,e._entityCollection=this._entity._entityCollection,this._renderNode.renderer.assignPickingColor(e),this._pickingColorData.push(e._pickingColor.x/255,e._pickingColor.y/255,e._pickingColor.z/255,1)}this._changedBuffers[Ni]=!0}}}class Ii{constructor(t){t=t||{},this.id=Ii.__staticId++,this.position=t.position||new Xt,this.orientation=t.orientation||new Wt(0,0,0,1),this.scale=t.scale||new Xt(1,1,1),this.color=t.color||[1,1,1,1],this.visibility=void 0==t.visibility||t.visibility,this._src=t.src||null,this._positionBuffer=null,this._normalBuffer=null,this._indexBuffer=null,this._textureCoordBuffer=null,this._positionData=[],this._normalData=[],this._indexData=[],this._textureCoordData=[],this._mxScale=(new Vt).setIdentity(),this._mxTranslation=(new Vt).setIdentity(),this._mxModel=(new Vt).setIdentity(),this.texture=null,this._renderNode=null,this._pickingColor=[0,0,0,0],this._entity=null,this._handler=null,this._handlerIndex=-1}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}clear(){this.position.set(0,0,0),this.orientation.set(0,0,0,1),this.scale.set(1,1,1),this._positionData.length=0,this._normalData.length=0,this._indexData.length=0,this._mxScale.setIdentity(),this._mxTranslation.setIdentity(),this._mxModel.setIdentity(),this._renderNode.handler.gl.deleteTexture(this.texture),this.texture=null,this._deleteBuffers()}setColor(t){this.color[0]=t[0],this.color[1]=t[1],this.color[2]=t[2],this.color[3]=t[3]}setColor4v(t){this.color[0]=t.x,this.color[1]=t.y,this.color[2]=t.z,this.color[3]=t.w}setOpacity(t){this.color[3]=t}_deleteBuffers(){var t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._positionBuffer),t.deleteBuffer(this._normalBuffer),t.deleteBuffer(this._indexBuffer),this._positionBuffer=null,this._normalBuffer=null,this._indexBuffer=null}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){if(this._renderNode=t,this._createBuffers(),this._src){var e=new Image,i=this;e.onload=function(){i.texture=t.renderer.handler.createTexture(this)},e.src=this._src}}setPosition3v(t){this.position.copy(t),this._mxTranslation.translateToPosition(t),this.refresh()}translate3v(t){this.position.addA(t),this._mxTranslation.translate(t)}setScale3v(t){this.scale.copy(t),this._mxScale.scale(t)}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._pickingColor[0]=t.x/255,this._pickingColor[1]=t.y/255,this._pickingColor[2]=t.z/255,this._pickingColor[3]=1}_createBuffers(){this._deleteBuffers();var t=this._renderNode.renderer;this._positionBuffer=t.handler.createArrayBuffer(new Float32Array(this._positionData),3,this._positionData.length/3),this._normalBuffer=t.handler.createArrayBuffer(new Float32Array(this._normalData),3,this._normalData.length/3),this._indexBuffer=t.handler.createElementArrayBuffer(new Uint16Array(this._indexData),1,this._indexData.length),this._textureCoordBuffer=t.handler.createArrayBuffer(new Float32Array(this._textureCoordData),2,this._textureCoordData.length/2)}refresh(){this._mxModel=this._mxTranslation.mul(this.orientation.getMat4().mul(this._mxScale))}draw(){if(this.visibility){var t,e,i=this._renderNode,r=i.renderer,n=r.handler.gl;i.lightEnabled?(e=(t=r.handler.programs.shape_wl)._program,sha=e.attributes,shu=e.uniforms,t.activate(),n.uniform4fv(shu.lightsPositions,i._lightsTransformedPositions),n.uniform3fv(shu.lightsParamsv,i._lightsParamsv),n.uniform1fv(shu.lightsParamsf,i._lightsParamsf),n.uniformMatrix4fv(shu.projectionMatrix,!1,r.activeCamera._projectionMatrix._m),n.uniformMatrix4fv(shu.viewMatrix,!1,r.activeCamera._viewMatrix._m),n.uniformMatrix3fv(shu.normalMatrix,!1,r.activeCamera._normalMatrix._m),n.bindBuffer(n.ARRAY_BUFFER,this._normalBuffer),n.vertexAttribPointer(sha.aVertexNormal,this._normalBuffer.itemSize,n.FLOAT,!1,0,0)):(e=(t=r.handler.programs.shape_nl)._program,sha=e.attributes,shu=e.uniforms,t.activate(),n.uniformMatrix4fv(shu.projectionViewMatrix,!1,r.activeCamera._projectionViewMatrix._m)),n.uniform4fv(shu.uColor,this.color),n.bindBuffer(n.ARRAY_BUFFER,this._positionBuffer),n.vertexAttribPointer(sha.aVertexPosition,this._positionBuffer.itemSize,n.FLOAT,!1,0,0),n.uniformMatrix4fv(shu.modelMatrix,!1,this._mxModel._m),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this.texture),n.uniform1i(shu.uSampler,0),n.bindBuffer(n.ARRAY_BUFFER,this._textureCoordBuffer),n.vertexAttribPointer(sha.aTextureCoord,this._textureCoordBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._indexBuffer),n.drawElements(r.handler.gl.TRIANGLES,this._indexBuffer.numItems,n.UNSIGNED_SHORT,0)}}}class Oi extends Ii{constructor(t){this._radius=t.radius||100,this._latBands=t.latBands||16,this._lonBands=t.lonBands||16,this._createData()}_createData(){for(let u=0;u<=this._latBands;u++){var t=u*Math.PI/this._latBands,e=Math.sin(t),i=Math.cos(t);for(let t=0;t<=this._lonBands;t++){var r=2*t*Math.PI/this._lonBands,n=Math.sin(r),s=Math.cos(r)*e,o=i,a=n*e,h=1-t/this._lonBands,l=u/this._latBands;this._normalData.push(s),this._normalData.push(o),this._normalData.push(a),this._textureCoordData.push(h),this._textureCoordData.push(l),this._positionData.push(this._radius*s),this._positionData.push(this._radius*o),this._positionData.push(this._radius*a)}}for(let t=0;t<this._latBands;t++)for(let e=0;e<this._lonBands;e++){var u=t*(this._lonBands+1)+e,c=u+this._lonBands+1;this._indexData.push(u),this._indexData.push(u+1),this._indexData.push(c),this._indexData.push(c),this._indexData.push(u+1),this._indexData.push(c+1)}}}class Ui{constructor(t){(t=t||{}).properties=t.properties||{},this.id=Ui._staticCounter++,this.properties=t.properties||{},this.properties.name=this.properties.name||t.name||"",this.childrenNodes=[],this.parent=null,this._cartesian=ne(t.cartesian),this._lonlat=le(t.lonlat),this._lonlatMerc=null,this._altitude=t.altitude||0,this._visibility=void 0==t.visibility||t.visibility,this._entityCollection=null,this._entityCollectionIndex=-1,this._layer=null,this._layerIndex=-1,this._pickingColor=new Xt(0,0,0),this._featureConstructorArray={billboard:[pi,this.setBillboard],label:[wi,this.setLabel],sphere:[Oi,this.setShape],polyline:[Fi,this.setPolyline],pointCloud:[ki,this.setPointCloud],geometry:[bi,this.setGeometry],strip:[yi,this.setStrip]},this.billboard=this._createOptionFeature("billboard",t.billboard),this.label=this._createOptionFeature("label",t.label),this.shape=this._createOptionFeature("sphere",t.sphere||t.box),this.polyline=this._createOptionFeature("polyline",t.polyline),this.pointCloud=this._createOptionFeature("pointCloud",t.pointCloud),this.geometry=this._createOptionFeature("geometry",t.geometry),this.strip=this._createOptionFeature("strip",t.strip)}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}get instanceName(){return"Entity"}_createOptionFeature(t,e){if(e){var i=this._featureConstructorArray[t];return i[1].call(this,new i[0](e))}return null}getCollectionIndex(){return this._entityCollectionIndex}addTo(t,e){return t.add(this,e),this}remove(){this._layer&&this._layer.removeEntity(this),this._entityCollection&&this._entityCollection.removeEntity(this)}setVisibility(t){this._visibility=t,this.billboard&&this.billboard.setVisibility(t),this.label&&this.label.setVisibility(t),this.shape&&this.shape.setVisibility(t),this.polyline&&this.polyline.setVisibility(t),this.geometry&&this.geometry.setVisibility(t);for(var e=0;e<this.childrenNodes.length;e++)this.childrenNodes[e].setVisibility(t)}getVisibility(){return this._visibility}setCartesian3v(t){this.setCartesian(t.x,t.y,t.z)}setCartesian(t,e,i){var r=this._cartesian;r.x=t,r.y=e,r.z=i,this.billboard&&this.billboard.setPosition3v(r),this.label&&this.label.setPosition3v(r),this.shape&&this.shape.setPosition3v(r);for(var n=0;n<this.childrenNodes.length;n++)this.childrenNodes[n].setCartesian(t,e,i);var s=this._entityCollection;s&&s.renderNode&&s.renderNode.ellipsoid&&(this._lonlat=s.renderNode.ellipsoid.cartesianToLonLat(r),Math.abs(this._lonlat.lat)<It?this._lonlatMerc=this._lonlat.forwardMercator():this._lonlatMerc=null),s&&s.events.dispatch(s.events.entitymove,this)}_setCartesian3vSilent(t,e){var i=this._cartesian;i.x=t.x,i.y=t.y,i.z=t.z,this.billboard&&this.billboard.setPosition3v(i),this.label&&this.label.setPosition3v(i),this.shape&&this.shape.setPosition3v(i);for(var r=0;r<this.childrenNodes.length;r++)this.childrenNodes[r].setCartesian(x,y,z);var n=this._entityCollection;!e&&n&&n.renderNode&&n.renderNode.ellipsoid&&(this._lonlat=n.renderNode.ellipsoid.cartesianToLonLat(i),Math.abs(this._lonlat.lat)<It?this._lonlatMerc=this._lonlat.forwardMercator():this._lonlatMerc=null)}getLonLat(){return this._lonlat.clone()}setLonLat(t){var e=this._lonlat;e.lon=t.lon,e.lat=t.lat,e.height=t.height;var i=this._entityCollection;i&&i.renderNode&&i.renderNode.ellipsoid&&(Math.abs(t.lat)<It?this._lonlatMerc=t.forwardMercator():this._lonlatMerc=null,this._cartesian=i.renderNode.ellipsoid.lonLatToCartesian(t),this.setCartesian3v(this._cartesian))}setAltitude(t){this._altitude=t}getAltitude(){return this._altitude}getCartesian(){return this._cartesian.clone()}setBillboard(t){return this.billboard&&this.billboard.remove(),this.billboard=t,this.billboard._entity=this,this.billboard.setPosition3v(this._cartesian),this.billboard.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._billboardHandler.add(t),t}setLabel(t){return this.label&&this.label.remove(),this.label=t,this.label._entity=this,this.label.setPosition3v(this._cartesian),this.label.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._labelHandler.add(t),t}setShape(t){return this.shape&&this.shape.remove(),this.shape=t,this.shape._entity=this,this.shape.setPosition3v(this._cartesian),this.shape.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._shapeHandler.add(t),t}setPolyline(t){return this.polyline&&this.polyline.remove(),this.polyline=t,this.polyline._entity=this,this.polyline.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._polylineHandler.add(t),t}setPointCloud(t){return this.pointCloud&&this.pointCloud.remove(),this.pointCloud=t,this.pointCloud._entity=this,this.pointCloud.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._pointCloudHandler.add(t),t}setGeometry(t){return this.geometry&&this.geometry.remove(),this.geometry=t,this.geometry._entity=this,this.geometry.setVisibility(this._visibility),this._layer&&this._layer.add(this),t}setStrip(t){return this.strip&&this.strip.remove(),this.strip=t,this.strip._entity=this,this.strip.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._stripHandler.add(t),t}get layer(){return this._layer}appendChild(t){t._entityCollection=this._entityCollection,t._pickingColor=this._pickingColor,t.parent=this,this.childrenNodes.push(t),this._entityCollection&&this._entityCollection._addRecursively(t)}setPickingColor(){var t=this._pickingColor;this.billboard&&this.billboard.setPickingColor3v(t),this.label&&this.label.setPickingColor3v(t),this.shape&&this.shape.setPickingColor3v(t),this.polyline&&this.polyline.setPickingColor3v(t),this.strip&&this.strip.setPickingColor3v(t);for(var e=0;e<this.childrenNodes.length;e++)this.childrenNodes[e].setPickingColor()}getExtent(){var t,e=this._lonlat,i=(t=this.billboard||this.label?new Ot(new Rt(e.lon,e.lat),new Rt(e.lon,e.lat)):new Ot(new Rt(180,90),new Rt(-180,-90))).southWest,r=t.northEast;this.polyline&&((s=this.polyline.getExtent()).southWest.lon<i.lon&&(i.lon=s.southWest.lon),s.southWest.lat<i.lat&&(i.lat=s.southWest.lat),s.northEast.lon>r.lon&&(r.lon=s.northEast.lon),s.northEast.lat>r.lat&&(r.lat=s.northEast.lat));this.geometry&&((s=this.geometry.getExtent()).southWest.lon<i.lon&&(i.lon=s.southWest.lon),s.southWest.lat<i.lat&&(i.lat=s.southWest.lat),s.northEast.lon>r.lon&&(r.lon=s.northEast.lon),s.northEast.lat>r.lat&&(r.lat=s.northEast.lat));for(var n=0;n<this.childrenNodes.length;n++){var s;(s=this.childrenNodes[n].getExtent()).southWest.lon<i.lon&&(i.lon=s.southWest.lon),s.southWest.lat<i.lat&&(i.lat=s.southWest.lat),s.northEast.lon>r.lon&&(r.lon=s.northEast.lon),s.northEast.lat>r.lat&&(r.lat=s.northEast.lat)}return t}}let Hi=["FLOAT","DOUBLE","BOOL","INT","UINT","VEC2","VEC3","VEC4","DVEC2","DVEC3","DVEC4","BVEC2","BVEC3","BVEC4","IVEC2","IVEC3","IVEC4","UVEC2","UVEC3","UVEC4","MAT2","DMAT2","MAT3","DMAT3","MAT4","DMAT4","MAT2X3","MAT2X4","MAT3X2","MAT3X4","MAT4X2","MAT4X3","DMAT2X3","DMAT2X4","DMAT3X2","DMAT3X4","DMAT4X2","DMAT4X3","SAMPLER1D","SAMPLER2D","SAMPLER3D","SAMPLERCUBE","SAMPLER2DSHADOW","SAMPLER2DXX","INTXX","FLOATXX"];const Vi={};for(let t=0;t<Hi.length;t++)Vi[Hi[t]]=t;const Wi={};for(let t=0;t<Hi.length;t++)Wi[Hi[t].toLowerCase()]=Vi[Hi[t]];const Xi={u:[],a:[]};Xi.u[Vi.MAT4]=function(t,e){t.gl.uniformMatrix4fv(e._pName,!1,e.value)},Xi.u[Vi.MAT3]=function(t,e){t.gl.uniformMatrix3fv(e._pName,!1,e.value)},Xi.u[Vi.FLOAT]=function(t,e){t.gl.uniform1f(e._pName,e.value)},Xi.u[Vi.INT]=function(t,e){t.gl.uniform1i(e._pName,e.value)},Xi.u[Vi.VEC2]=function(t,e){t.gl.uniform2fv(e._pName,e.value)},Xi.u[Vi.VEC3]=function(t,e){t.gl.uniform3fv(e._pName,e.value)},Xi.u[Vi.VEC4]=function(t,e){t.gl.uniform4fv(e._pName,e.value)},Xi.u[Vi.SAMPLER2D]=function(t,e){let i=t.gl;i.activeTexture(i.TEXTURE0+t._textureID),i.bindTexture(i.TEXTURE_2D,e.value),i.uniform1i(e._pName,t._textureID),t._textureID++},Xi.u[Vi.SAMPLERCUBE]=function(t,e){let i=t.gl;i.activeTexture(i.TEXTURE0+t._textureID),i.bindTexture(i.TEXTURE_CUBE_MAP,e.value),i.uniform1i(e._pName,t._textureID),t._textureID++},Xi.u[Vi.SAMPLER2DXX]=function(t,e){let i=t.gl,r=e.value.length,n=new Int32Array(r);for(let s=0;s<r;s++)i.activeTexture(i.TEXTURE0+t._textureID+s),i.bindTexture(i.TEXTURE_2D,e.value[s]),n[s]=s;i.uniform1iv(e._pName,n)},Xi.u[Vi.INTXX]=function(t,e){pgl.uniform1iv(e._pName,e.value)},Xi.u[Vi.FLOATXX]=function(t,e){t.gl.uniform1fv(e._pName,e.value)},Xi.a[Vi.FLOAT]=function(t,e){t.gl.vertexAttrib1f(e._pName,e.value)},Xi.a[Vi.VEC2]=function(t,e){t.gl.vertexAttrib2fv(e._pName,e.value)},Xi.a[Vi.VEC3]=function(t,e){t.gl.vertexAttrib3fv(e._pName,e.value)},Xi.a[Vi.VEC4]=function(t,e){t.gl.vertexAttrib4fv(e._pName,e.value)};const Yi=new class{constructor(){this._container=document.createElement("div"),this._container.classList.add("ogConsole"),this._container.style.display="none",document.body&&document.body.appendChild(this._container),this._visibility=!1}getVisibility(){return this._visibility}setVisibility(t){this._visibility!=t&&(this._visibility=t,this._visibility?this.show():this.hide())}show(){this._container.parentNode||document.body&&document.body.appendChild(this._container),this._container.style.display="block",this._visibility=!0}hide(){this._container.style.display="none",this._visibility=!1}logErr(t){var e=document.createElement("div");e.classList.add("ogConsole-text"),e.classList.add("ogConsole-error"),e.innerHTML="error: "+t,console.log(e.innerHTML),this._container.appendChild(e),this.show()}logWrn(t){var e=document.createElement("div");e.classList.add("ogConsole-text"),e.classList.add("ogConsole-warning"),e.innerHTML="warning: "+t,console.log(e.innerHTML),this._container.appendChild(e),this.show()}log(t,e){var i=document.createElement("div");if(i.classList.add("ogConsole-text"),e)for(var r in e)i.style[r]=e[r];i.innerHTML=t,console.log(t),this._container.appendChild(i),this.show()}};class ji{constructor(t,e){this.name=t,this.attributes={},this.uniforms={},this._attributes={};for(let t in e.attributes)"string"==typeof e.attributes[t]||"number"==typeof e.attributes[t]?this._attributes[t]={type:e.attributes[t]}:this._attributes[t]=e.attributes[t];this._uniforms={};for(let t in e.uniforms)"string"==typeof e.uniforms[t]||"number"==typeof e.uniforms[t]?this._uniforms[t]={type:e.uniforms[t]}:this._uniforms[t]=e.uniforms[t];this.vertexShader=e.vertexShader,this.fragmentShader=e.fragmentShader,this.gl=null,this._variables={},this._p=null,this._textureID=0,this._attribArrays=[]}use(){this.gl.useProgram(this._p)}set(t){for(var e in this._textureID=0,t)this._variables[e].value=t[e],this._variables[e]._callback(this,this._variables[e])}apply(){this._textureID=0;var t=this._variables;for(var e in t)t[e]._callback(this,t[e])}drawIndexBuffer(t,e){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,e),this.gl.drawElements(t,e.numItems,this.gl.UNSIGNED_SHORT,0)}drawArrays(t,e){this.gl.drawArrays(t,0,e)}_getShaderCompileStatus(t,e){return this.gl.shaderSource(t,e),this.gl.compileShader(t),!!this.gl.getShaderParameter(t,this.gl.COMPILE_STATUS)||(Yi.logErr("og/Program/Program:"+this.name+" - "+this.gl.getShaderInfoLog(t)+"."),!1)}_createVertexShader(t){var e=this.gl.createShader(this.gl.VERTEX_SHADER);return this._getShaderCompileStatus(e,t)?e:null}_createFragmentShader(t){var e=this.gl.createShader(this.gl.FRAGMENT_SHADER);return this._getShaderCompileStatus(e,t)?e:null}disableAttribArrays(){for(var t=this.gl,e=this._attribArrays,i=e.length;i--;)t.disableVertexAttribArray(e[i])}enableAttribArrays(){for(var t=this.gl,e=this._attribArrays,i=e.length;i--;)t.enableVertexAttribArray(e[i])}delete(){this.gl.deleteProgram(this._p)}createProgram(t){this.gl=t,this._p=this.gl.createProgram();var e=this._createFragmentShader(this.fragmentShader),i=this._createVertexShader(this.vertexShader);if(t.attachShader(this._p,e),t.attachShader(this._p,i),t.linkProgram(this._p),!t.getProgramParameter(this._p,t.LINK_STATUS))return Yi.logErr("og/Program/Program:"+this.name+" - couldn't initialise shaders. "+t.getProgramInfoLog(this._p)+"."),void t.deleteProgram(this._p);for(var r in this.use(),this._attributes){if(this._variables[r]=this._attributes[r],this._attributes[r].enableArray=void 0==this._attributes[r].enableArray||this._attributes[r].enableArray,this._attributes[r].enableArray?this._attributes[r]._callback=ji.bindBuffer:"string"==typeof this._attributes[r].type?this._attributes[r]._callback=Xi.a[Wi[this._attributes[r].type.trim().toLowerCase()]]:this._attributes[r]._callback=Xi.a[this._attributes[r].type],this._p[r]=t.getAttribLocation(this._p,r),void 0==this._p[r])return Yi.logErr("og/Program/Program:"+this.name+" - attribute '"+r+"' is not exists."),void t.deleteProgram(this._p);this._attributes[r].enableArray&&(this._attribArrays.push(this._p[r]),t.enableVertexAttribArray(this._p[r])),this._attributes[r]._pName=this._p[r],this.attributes[r]=this._p[r]}for(var n in this._uniforms){if("string"==typeof this._uniforms[n].type?this._uniforms[n]._callback=Xi.u[Wi[this._uniforms[n].type.trim().toLowerCase()]]:this._uniforms[n]._callback=Xi.u[this._uniforms[n].type],this._variables[n]=this._uniforms[n],this._p[n]=t.getUniformLocation(this._p,n),void 0==this._p[n])return Yi.logErr("og/Program/Program:"+this.name+" - uniform '"+n+"' is not exists."),void t.deleteProgram(this._p);this._uniforms[n]._pName=this._p[n],this.uniforms[n]=this._p[n]}t.detachShader(this._p,e),t.detachShader(this._p,i),t.deleteShader(e),t.deleteShader(i)}static bindBuffer(t,e){var i=t.gl;i.bindBuffer(i.ARRAY_BUFFER,e.value),i.vertexAttribPointer(e._pName,e.value.itemSize,i.FLOAT,!1,0,0)}}const Gi=0,qi=1,Ki=2,Zi=3,Qi=4,Ji=5,$i=6,tr=7,er=8;class ir{constructor(t){this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._billboards=[],this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._texCoordBuffer=null,this._vertexBuffer=null,this._alignedAxisBuffer=null,this._texCoordArr=[],this._vertexArr=[],this._positionHighArr=[],this._positionLowArr=[],this._sizeArr=[],this._offsetArr=[],this._rgbaArr=[],this._rotationArr=[],this._alignedAxisArr=[],this._pickingColorBuffer=null,this._pickingColorArr=[],this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[Gi]=this.createPickingColorBuffer,this._buffersUpdateCallbacks[qi]=this.createPositionBuffer,this._buffersUpdateCallbacks[Ki]=this.createSizeBuffer,this._buffersUpdateCallbacks[Zi]=this.createOffsetBuffer,this._buffersUpdateCallbacks[Qi]=this.createRgbaBuffer,this._buffersUpdateCallbacks[Ji]=this.createRotationBuffer,this._buffersUpdateCallbacks[$i]=this.createTexCoordBuffer,this._buffersUpdateCallbacks[tr]=this.createVertexBuffer,this._buffersUpdateCallbacks[er]=this.createAlignedAxisBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),this.__staticId=ir._staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}static concArr(t,e){for(var i=0;i<e.length;i++)t.push(e[i])}initProgram(){this._renderer.handler&&(this._renderer.handler.programs.billboard||this._renderer.handler.addProgram(new ji("billboard",{uniforms:{u_texture:"sampler2d",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",uFloatParams:"vec2",uScaleByDistance:"vec3",uOpacity:"float"},attributes:{a_vertices:"vec2",a_texCoord:"vec2",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_size:"vec2",a_offset:"vec3",a_rgba:"vec4",a_rotation:"float",a_alignedAxis:"vec3"},vertexShader:"precision highp float;\n            attribute vec2 a_vertices;\n            attribute vec2 a_texCoord;\n            attribute vec3 a_positionsHigh;\n            attribute vec3 a_positionsLow;\n            attribute vec3 a_offset;\n            attribute vec2 a_size;\n            attribute float a_rotation;\n            attribute vec4 a_rgba;\n            attribute vec3 a_alignedAxis;\n\n            varying vec2 v_texCoords;\n            varying vec4 v_rgba;\n\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n            //uniform vec3 uCamPos;\n            uniform vec3 eyePositionHigh;\n            uniform vec3 eyePositionLow;\n            uniform vec2 uFloatParams;\n            uniform vec3 uScaleByDistance;\n            uniform float uOpacity;\n\n            const vec3 ZERO3 = vec3(0.0);\n            const float C = 0.1;\n            const float far = 149.6e+9;\n            float logc = 2.0 / log( C * far + 1.0 );\n\n            void main() {\n                \n                vec3 a_positions = a_positionsHigh + a_positionsLow;\n                vec3 uCamPos = eyePositionHigh + eyePositionLow;\n\n                v_texCoords = a_texCoord;\n                vec3 look = a_positions - uCamPos;\n                float lookLength = length(look);\n                v_rgba = a_rgba;\n                /*v_rgba.a *= uOpacity * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions,a_positions) - uFloatParams[0]));*/\n                if(uOpacity * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions,a_positions) - uFloatParams[0])) == 0.0){\n                    return;\n                }\n                vec3 right, up;\n                if(a_alignedAxis == ZERO3){\n                    up = vec3( viewMatrix[0][1], viewMatrix[1][1], viewMatrix[2][1] );\n                    right = vec3( viewMatrix[0][0], viewMatrix[1][0], viewMatrix[2][0] );\n                }else{\n                    up = normalize(a_alignedAxis);\n                    right = normalize(cross(look,up));\n                    look = cross(up,right);\n                }\n                float dist = dot(uCamPos - a_positions, vec3(viewMatrix[0][2], viewMatrix[1][2], viewMatrix[2][2]));\n                float focalSize = 2.0 * dist * uFloatParams[1];\n                vec2 offset = a_offset.xy * focalSize;\n                float scd = (1.0 - smoothstep(uScaleByDistance[0], uScaleByDistance[1], lookLength)) * (1.0 - step(uScaleByDistance[2], lookLength));\n                vec2 scale = a_size * focalSize * scd;\n                float cosRot = cos(a_rotation);\n                float sinRot = sin(a_rotation);\n                vec3 rr = (right * cosRot - up * sinRot) * (scale.x * a_vertices.x + scd * offset.x) + (right * sinRot + up * cosRot) * (scale.y * a_vertices.y + scd * offset.y);\n\n                vec3 highDiff = a_positionsHigh - eyePositionHigh;\n                vec3 lowDiff = a_positionsLow + rr - eyePositionLow;\n\n                mat4 viewMatrixRTE = viewMatrix;\n                viewMatrixRTE[3] = vec4(0.0, 0.0, 0.0, 1.0);\n\n                gl_Position = projectionMatrix * viewMatrixRTE * vec4(highDiff + lowDiff, 1.0);\n                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;\n                gl_Position.z += a_offset.z;\n            }",fragmentShader:"precision highp float;\n            uniform sampler2D u_texture;\n            varying vec2 v_texCoords;\n            varying vec4 v_rgba;\n            void main () {\n                vec4 color = texture2D(u_texture, v_texCoords);\n                if(color.a < 0.1)\n                    discard;\n                gl_FragColor = color * v_rgba;\n            }"})),this._renderer.handler.programs.billboardPicking||this._renderer.handler.addProgram(new ji("billboardPicking",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",uFloatParams:"vec2",uScaleByDistance:"vec3",uOpacity:"float",pickingScale:"float"},attributes:{a_vertices:"vec2",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_size:"vec2",a_offset:"vec3",a_pickingColor:"vec3",a_rotation:"float",a_alignedAxis:"vec3"},vertexShader:"precision highp float;\n\n            attribute vec2 a_vertices;\n            attribute vec3 a_positionsHigh;\n            attribute vec3 a_positionsLow;\n            attribute vec3 a_offset;\n            attribute vec2 a_size;\n            attribute float a_rotation;\n            attribute vec3 a_pickingColor;\n            attribute vec3 a_alignedAxis;\n\n            varying vec4 v_color;\n\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n            //uniform vec3 uCamPos;\n            uniform vec3 eyePositionHigh;\n            uniform vec3 eyePositionLow;\n            uniform vec2 uFloatParams;\n            uniform vec3 uScaleByDistance;\n            uniform float uOpacity;\n            uniform float pickingScale;\n\n            const vec3 ZERO3 = vec3(0.0);\n            const float C = 0.1;\n            const float far = 149.6e+9;\n            float logc = 2.0 / log( C * far + 1.0 );\n\n            void main() {\n                \n                vec3 a_positions = a_positionsHigh + a_positionsLow;\n                vec3 uCamPos = eyePositionHigh + eyePositionLow;\n\n                vec3 look = a_positions - uCamPos;\n                float lookLength = length(look);\n                if( uOpacity == 0.0 ) {\n                    gl_Position = vec4(0.0);\n                    return;\n                }\n                v_color = vec4(a_pickingColor.rgb, 1.0) * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions, a_positions) - uFloatParams[0]));\n                vec3 right, up;\n                if(a_alignedAxis == ZERO3){\n                    up = vec3( viewMatrix[0][1], viewMatrix[1][1], viewMatrix[2][1] );\n                    right = vec3( viewMatrix[0][0], viewMatrix[1][0], viewMatrix[2][0] );\n                }else{\n                    up = normalize(a_alignedAxis);\n                    right = normalize(cross(look,up));\n                    look = cross(up,right);\n                }\n                float dist = dot(uCamPos - a_positions, vec3(viewMatrix[0][2], viewMatrix[1][2], viewMatrix[2][2]));\n                float focalSize = 2.0 * dist * uFloatParams[1];\n                vec2 offset = a_offset.xy * focalSize;\n                float scd = (1.0 - smoothstep(uScaleByDistance[0], uScaleByDistance[1], lookLength)) *(1.0 - step(uScaleByDistance[2], lookLength));\n                vec2 scale = a_size * focalSize * scd * pickingScale;\n                float cosRot = cos(a_rotation);\n                float sinRot = sin(a_rotation);\n                vec3 rr = (right * cosRot - up * sinRot) * (scale.x * a_vertices.x + scd * offset.x) + (right * sinRot + up * cosRot) * (scale.y * a_vertices.y + scd * offset.y) + a_positions;\n                gl_Position = projectionMatrix * viewMatrix * vec4(rr, 1);\n                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;\n                gl_Position.z += a_offset.z;\n            }",fragmentShader:"precision highp float;\n            varying vec4 v_color;\n            void main () {\n                gl_FragColor = v_color;\n            }"})))}setRenderer(t){this._renderer=t,this.initProgram()}refresh(){for(var t=this._changedBuffers.length;t--;)this._changedBuffers[t]=!0}_removeBillboards(){for(var t=this._billboards.length;t--;){var e=this._billboards[t];e._handlerIndex=-1,e._handler=null}this._billboards.length=0,this._billboards=[]}clear(){this._texCoordArr.length=0,this._vertexArr.length=0,this._positionHighArr.length=0,this._positionLowArr.length=0,this._sizeArr.length=0,this._offsetArr.length=0,this._rgbaArr.length=0,this._rotationArr.length=0,this._alignedAxisArr.length=0,this._pickingColorArr.length=0,this._texCoordArr=[],this._vertexArr=[],this._positionHighArr=[],this._positionLowArr=[],this._sizeArr=[],this._offsetArr=[],this._rgbaArr=[],this._rotationArr=[],this._alignedAxisArr=[],this._pickingColorArr=[],this._removeBillboards(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){var t=this._renderer.handler.gl;t.deleteBuffer(this._positionHighBuffer),t.deleteBuffer(this._positionLowBuffer),t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._offsetBuffer),t.deleteBuffer(this._rgbaBuffer),t.deleteBuffer(this._rotationBuffer),t.deleteBuffer(this._vertexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._alignedAxisBuffer),t.deleteBuffer(this._pickingColorBuffer),this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._alignedAxisBuffer=null,this._pickingColorBuffer=null}update(){if(this._renderer)for(var t=this._changedBuffers.length;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}add(t){-1==t._handlerIndex&&(t._handler=this,t._handlerIndex=this._billboards.length,this._billboards.push(t),this._addBillboardToArrays(t),this.refresh(),t.setSrc(t._src||t._image&&t._image.src))}_addBillboardToArrays(t){t._visibility?ir.concArr(this._vertexArr,[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]):ir.concArr(this._vertexArr,[0,0,0,0,0,0,0,0,0,0,0,0]),ir.concArr(this._texCoordArr,[0,0,0,0,0,0,0,0,0,0,0,0]);var e,i=t._positionHigh.x,r=t._positionHigh.y,n=t._positionHigh.z;ir.concArr(this._positionHighArr,[i,r,n,i,r,n,i,r,n,i,r,n,i,r,n,i,r,n]),i=t._positionLow.x,r=t._positionLow.y,n=t._positionLow.z,ir.concArr(this._positionLowArr,[i,r,n,i,r,n,i,r,n,i,r,n,i,r,n,i,r,n]),i=t._width,r=t._height,ir.concArr(this._sizeArr,[i,r,i,r,i,r,i,r,i,r,i,r]),i=t._offset.x,r=t._offset.y,n=t._offset.z,ir.concArr(this._offsetArr,[i,r,n,i,r,n,i,r,n,i,r,n,i,r,n,i,r,n]),i=t._color.x,r=t._color.y,n=t._color.z,e=t._color.w,ir.concArr(this._rgbaArr,[i,r,n,e,i,r,n,e,i,r,n,e,i,r,n,e,i,r,n,e,i,r,n,e]),i=t._rotation,ir.concArr(this._rotationArr,[i,i,i,i,i,i]),i=t._alignedAxis.x,r=t._alignedAxis.y,n=t._alignedAxis.z,ir.concArr(this._alignedAxisArr,[i,r,n,i,r,n,i,r,n,i,r,n,i,r,n,i,r,n]),i=t._entity._pickingColor.x/255,r=t._entity._pickingColor.y/255,n=t._entity._pickingColor.z/255,ir.concArr(this._pickingColorArr,[i,r,n,i,r,n,i,r,n,i,r,n,i,r,n,i,r,n])}_displayPASS(){var t=this._renderer,e=t.handler;e.programs.billboard.activate();var i=e.programs.billboard._program,r=i.attributes,n=i.uniforms,s=e.gl,o=this._entityCollection;s.polygonOffset(o.polygonOffsetFactor,o.polygonOffsetUnits),s.uniform1i(n.u_texture,0),s.uniformMatrix4fv(n.viewMatrix,!1,t.activeCamera._viewMatrix._m),s.uniformMatrix4fv(n.projectionMatrix,!1,t.activeCamera._projectionMatrix._m),s.uniform3fv(n.eyePositionHigh,t.activeCamera.eyeHigh),s.uniform3fv(n.eyePositionLow,t.activeCamera.eyeLow),s.uniform3fv(n.uScaleByDistance,o.scaleByDistance),s.uniform1f(n.uOpacity,o._fadingOpacity),s.uniform2fv(n.uFloatParams,[o.renderNode._planetRadius2||0,t.activeCamera._tanViewAngle_hradOneByHeight]),s.bindBuffer(s.ARRAY_BUFFER,this._texCoordBuffer),s.vertexAttribPointer(r.a_texCoord,this._texCoordBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._vertexBuffer),s.vertexAttribPointer(r.a_vertices,this._vertexBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._positionHighBuffer),s.vertexAttribPointer(r.a_positionsHigh,this._positionHighBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._positionLowBuffer),s.vertexAttribPointer(r.a_positionsLow,this._positionLowBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._rgbaBuffer),s.vertexAttribPointer(r.a_rgba,this._rgbaBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._sizeBuffer),s.vertexAttribPointer(r.a_size,this._sizeBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._offsetBuffer),s.vertexAttribPointer(r.a_offset,this._offsetBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._rotationBuffer),s.vertexAttribPointer(r.a_rotation,this._rotationBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._alignedAxisBuffer),s.vertexAttribPointer(r.a_alignedAxis,this._alignedAxisBuffer.itemSize,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLES,0,this._vertexBuffer.numItems)}_pickingPASS(){var t=this._renderer,e=t.handler;e.programs.billboardPicking.activate();var i=e.programs.billboardPicking._program,r=i.attributes,n=i.uniforms,s=e.gl,o=(s=e.gl,this._entityCollection);s.polygonOffset(o.polygonOffsetFactor,o.polygonOffsetUnits),s.uniformMatrix4fv(n.viewMatrix,!1,t.activeCamera._viewMatrix._m),s.uniformMatrix4fv(n.projectionMatrix,!1,t.activeCamera._projectionMatrix._m),s.uniform3fv(n.eyePositionHigh,t.activeCamera.eyeHigh),s.uniform3fv(n.eyePositionLow,t.activeCamera.eyeLow),s.uniform3fv(n.uScaleByDistance,o.scaleByDistance),s.uniform1f(n.uOpacity,o._fadingOpacity),s.uniform1f(n.pickingScale,o.pickingScale),s.uniform2fv(n.uFloatParams,[o.renderNode._planetRadius2||0,t.activeCamera._tanViewAngle_hradOneByHeight]),s.bindBuffer(s.ARRAY_BUFFER,this._vertexBuffer),s.vertexAttribPointer(r.a_vertices,this._vertexBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._positionHighBuffer),s.vertexAttribPointer(r.a_positionsHigh,this._positionHighBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._positionLowBuffer),s.vertexAttribPointer(r.a_positionsLow,this._positionLowBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._pickingColorBuffer),s.vertexAttribPointer(r.a_pickingColor,this._pickingColorBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._sizeBuffer),s.vertexAttribPointer(r.a_size,this._sizeBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._offsetBuffer),s.vertexAttribPointer(r.a_offset,this._offsetBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._rotationBuffer),s.vertexAttribPointer(r.a_rotation,this._rotationBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._alignedAxisBuffer),s.vertexAttribPointer(r.a_alignedAxis,this._alignedAxisBuffer.itemSize,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLES,0,this._vertexBuffer.numItems)}draw(){this._billboards.length&&(this.update(),this._displayPASS())}drawPicking(){this._billboards.length&&this.pickingEnabled&&this._pickingPASS()}reindexBillbordsArray(t){for(var e=this._billboards,i=t;i<e.length;i++)e[i]._handlerIndex=i}_removeBillboard(t){var e=t._handlerIndex;this._billboards.splice(e,1);var i=24*e;this._rgbaArr.splice(i,24),i=18*e,this._positionHighArr.splice(i,18),this._positionLowArr.splice(i,18),this._offsetArr.splice(i,18),this._alignedAxisArr.splice(i,18),this._pickingColorArr.splice(i,18),i=12*e,this._vertexArr.splice(i,12),this._sizeArr.splice(i,12),this._texCoordArr.splice(i,12),i=6*e,this._rotationArr.splice(i,6),this.reindexBillbordsArray(e),this.refresh(),t._handlerIndex=-1,t._handler=null}remove(t){t._handler&&this.__staticId==t._handler.__staticId&&this._removeBillboard(t)}setPositionArr(t,e,i){var r=18*t,n=this._positionHighArr,s=e.x,o=e.y,a=e.z;n[r]=s,n[r+1]=o,n[r+2]=a,n[r+3]=s,n[r+4]=o,n[r+5]=a,n[r+6]=s,n[r+7]=o,n[r+8]=a,n[r+9]=s,n[r+10]=o,n[r+11]=a,n[r+12]=s,n[r+13]=o,n[r+14]=a,n[r+15]=s,n[r+16]=o,n[r+17]=a,n=this._positionLowArr,s=i.x,o=i.y,a=i.z,n[r]=s,n[r+1]=o,n[r+2]=a,n[r+3]=s,n[r+4]=o,n[r+5]=a,n[r+6]=s,n[r+7]=o,n[r+8]=a,n[r+9]=s,n[r+10]=o,n[r+11]=a,n[r+12]=s,n[r+13]=o,n[r+14]=a,n[r+15]=s,n[r+16]=o,n[r+17]=a,this._changedBuffers[qi]=!0}setPickingColorArr(t,e){var i=18*t,r=this._pickingColorArr,n=e.x/255,s=e.y/255,o=e.z/255;r[i]=n,r[i+1]=s,r[i+2]=o,r[i+3]=n,r[i+4]=s,r[i+5]=o,r[i+6]=n,r[i+7]=s,r[i+8]=o,r[i+9]=n,r[i+10]=s,r[i+11]=o,r[i+12]=n,r[i+13]=s,r[i+14]=o,r[i+15]=n,r[i+16]=s,r[i+17]=o,this._changedBuffers[Gi]=!0}setSizeArr(t,e,i){var r=12*t,n=this._sizeArr,s=e,o=i;n[r]=s,n[r+1]=o,n[r+2]=s,n[r+3]=o,n[r+4]=s,n[r+5]=o,n[r+6]=s,n[r+7]=o,n[r+8]=s,n[r+9]=o,n[r+10]=s,n[r+11]=o,this._changedBuffers[Ki]=!0}setOffsetArr(t,e){var i=18*t,r=this._offsetArr,n=e.x,s=e.y,o=e.z;r[i]=n,r[i+1]=s,r[i+2]=o,r[i+3]=n,r[i+4]=s,r[i+5]=o,r[i+6]=n,r[i+7]=s,r[i+8]=o,r[i+9]=n,r[i+10]=s,r[i+11]=o,r[i+12]=n,r[i+13]=s,r[i+14]=o,r[i+15]=n,r[i+16]=s,r[i+17]=o,this._changedBuffers[Zi]=!0}setRgbaArr(t,e){var i=24*t,r=this._rgbaArr,n=e.x,s=e.y,o=e.z,a=e.w;r[i]=n,r[i+1]=s,r[i+2]=o,r[i+3]=a,r[i+4]=n,r[i+5]=s,r[i+6]=o,r[i+7]=a,r[i+8]=n,r[i+9]=s,r[i+10]=o,r[i+11]=a,r[i+12]=n,r[i+13]=s,r[i+14]=o,r[i+15]=a,r[i+16]=n,r[i+17]=s,r[i+18]=o,r[i+19]=a,r[i+20]=n,r[i+21]=s,r[i+22]=o,r[i+23]=a,this._changedBuffers[Qi]=!0}setRotationArr(t,e){var i=6*t,r=this._rotationArr;r[i]=e,r[i+1]=e,r[i+2]=e,r[i+3]=e,r[i+4]=e,r[i+5]=e,this._changedBuffers[Ji]=!0}setTexCoordArr(t,e){var i=12*t,r=this._texCoordArr;r[i]=e[0],r[i+1]=e[1],r[i+2]=e[2],r[i+3]=e[3],r[i+4]=e[4],r[i+5]=e[5],r[i+6]=e[6],r[i+7]=e[7],r[i+8]=e[8],r[i+9]=e[9],r[i+10]=e[10],r[i+11]=e[11],this._changedBuffers[$i]=!0}setVisibility(t,e){var i;i=e?[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(t,i)}setVertexArr(t,e){var i=12*t,r=this._vertexArr;r[i]=e[0],r[i+1]=e[1],r[i+2]=e[2],r[i+3]=e[3],r[i+4]=e[4],r[i+5]=e[5],r[i+6]=e[6],r[i+7]=e[7],r[i+8]=e[8],r[i+9]=e[9],r[i+10]=e[10],r[i+11]=e[11],this._changedBuffers[tr]=!0}setAlignedAxisArr(t,e){var i=18*t,r=this._alignedAxisArr,n=e.x,s=e.y,o=e.z;r[i]=n,r[i+1]=s,r[i+2]=o,r[i+3]=n,r[i+4]=s,r[i+5]=o,r[i+6]=n,r[i+7]=s,r[i+8]=o,r[i+9]=n,r[i+10]=s,r[i+11]=o,r[i+12]=n,r[i+13]=s,r[i+14]=o,r[i+15]=n,r[i+16]=s,r[i+17]=o,this._changedBuffers[er]=!0}createPositionBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._positionHighBuffer),this._positionHighBuffer=t.createArrayBuffer(new Float32Array(this._positionHighArr),3,this._positionHighArr.length/3,t.gl.DYNAMIC_DRAW),t.gl.deleteBuffer(this._positionLowBuffer),this._positionLowBuffer=t.createArrayBuffer(new Float32Array(this._positionLowArr),3,this._positionLowArr.length/3,t.gl.DYNAMIC_DRAW)}createSizeBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=t.createArrayBuffer(new Float32Array(this._sizeArr),2,this._sizeArr.length/2)}createOffsetBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._offsetBuffer),this._offsetBuffer=t.createArrayBuffer(new Float32Array(this._offsetArr),3,this._offsetArr.length/3)}createRgbaBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._rgbaBuffer),this._rgbaBuffer=t.createArrayBuffer(new Float32Array(this._rgbaArr),4,this._rgbaArr.length/4)}createRotationBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._rotationBuffer),this._rotationBuffer=t.createArrayBuffer(new Float32Array(this._rotationArr),1,this._rotationArr.length,t.gl.DYNAMIC_DRAW)}createVertexBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._vertexBuffer),this._vertexBuffer=t.createArrayBuffer(new Float32Array(this._vertexArr),2,this._vertexArr.length/2,t.gl.DYNAMIC_DRAW)}createTexCoordBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=t.createArrayBuffer(new Float32Array(this._texCoordArr),2,this._texCoordArr.length/2,t.gl.DYNAMIC_DRAW)}createAlignedAxisBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._alignedAxisBuffer),this._alignedAxisBuffer=t.createArrayBuffer(new Float32Array(this._alignedAxisArr),3,this._alignedAxisArr.length/3)}createPickingColorBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorBuffer=t.createArrayBuffer(new Float32Array(this._pickingColorArr),3,this._pickingColorArr.length/3)}refreshTexCoordsArr(){if(this._entityCollection&&this._renderer)for(var t=this._renderer.billboardsTextureAtlas,e=0;e<this._billboards.length;e++){var i=this._billboards[e];if(i._image){var r=t.nodes[i._image.__nodeIndex];r&&this.setTexCoordArr(i._handlerIndex,r.texCoords)}}}}class rr{constructor(t,e){this._eventNames=[],t&&this.registerNames(t),this._sender=e||this,this._stopPropagation=!1,this._stampCache={},this.__id=rr._staticCounter++}static get _staticCounter(){return this.__counter__||0===this.__counter__||(this.__counter__=0),this.__counter__}static set _staticCounter(t){this.__counter__=t}bindSender(t){this._sender=t||this}registerNames(t){for(var e=0;e<t.length;e++)this[t[e]]={active:!0,handlers:[]},this._eventNames.push(t[e])}_getStamp(t,e,i){return`${t}_${e}_${i}`}_stamp(t,e){var i=Kt(e),r=this._getStamp(t,this.__id,i);return!this._stampCache[r]&&(this._stampCache[r]=i,!0)}on(t,e,i,r=0){if(this._stamp(t,e)&&this[t]){let n=e.bind(i||this._sender);n._openglobus_id=e._openglobus_id,n._openglobus_priority=r,ce(this[t].handlers,n,(t,e)=>e._openglobus_priority-t._openglobus_priority)}}off(t,e){if(e){var i=this._getStamp(t,this.__id,e._openglobus_id);if(e._openglobus_id&&this._stampCache[i]){for(var r=this[t].handlers,n=r.length,s=-1;n--;){if(r[n]._openglobus_id===e._openglobus_id){s=n;break}}-1!==s&&(r.splice(s,1),this._stampCache[i]=void 0,delete this._stampCache[i])}}}dispatch(t,...e){if(t&&t.active)for(var i=t.handlers,r=i.length;r--&&!this._stopPropagation;)i[r](...e);this._stopPropagation=!1}stopPropagation(){this._stopPropagation=!0}clear(){for(var t=0;t<this._eventNames.length;t++){var e=this[this._eventNames[t]];e.handlers.length=0,e.handlers=[]}this._eventNames.length=0,this._eventNames=[]}}const nr=0,sr=1,or=2,ar=3,hr=4,lr=5,ur=6,cr=7,_r=8,fr=9,dr=10,pr=11;class vr extends ir{constructor(t){super(t),this._fontIndexBuffer=null,this._noOutlineBuffer=null,this._outlineBuffer=null,this._outlineColorBuffer=null,this._fontIndexArr=[],this._noOutlineArr=[],this._outlineArr=[],this._outlineColorArr=[],this._buffersUpdateCallbacks[fr]=this.createFontIndexBuffer,this._buffersUpdateCallbacks[dr]=this.createOutlineBuffer,this._buffersUpdateCallbacks[pr]=this.createOutlineColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),this._maxLetters=25}initProgram(){this._renderer.handler&&(this._renderer.handler.programs.label||("webgl2"===this._renderer.handler.gl.type?this._renderer.handler.addProgram(new ji("label",{uniforms:{u_fontTextureArr:"sampler2dxx",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",uFloatParams:"vec2",uZ:"float",uScaleByDistance:"vec3",uOpacity:"float"},attributes:{a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_size:"float",a_offset:"vec3",a_rgba:"vec4",a_rotation:"float",a_alignedAxis:"vec3",a_fontIndex:"float",a_bufferAA:"vec2"},vertexShader:"#version 300 es\n\n            in vec2 a_vertices;\n            in vec4 a_texCoord;\n            in vec3 a_positionsHigh;\n            in vec3 a_positionsLow;\n            in vec3 a_offset;\n            in float a_size;\n            in float a_rotation;\n            in vec4 a_rgba;\n            in vec3 a_alignedAxis;\n            in float a_fontIndex;\n            in vec2 a_bufferAA;\n\n            out vec2 v_texCoords;\n            out vec4 v_rgba;\n            out float v_fontIndex;\n            out vec3 v_bufferAA;\n\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n            //uniform vec3 uCamPos;\n            uniform vec3 eyePositionHigh;\n            uniform vec3 eyePositionLow;\n            /*0 - planetRadius^2, 1 - tan(fov), 2 - screen ratio*/\n            uniform vec2 uFloatParams;\n            uniform float uZ;\n            uniform vec3 uScaleByDistance;\n            uniform float uOpacity;\n\n            const vec3 ZERO3 = vec3(0.0);\n            const float C = 0.1;\n            const float far = 149.6e+9;\n            float logc = 2.0 / log( C * far + 1.0 );\n\n            void main() {\n                vec3 a_positions = a_positionsHigh + a_positionsLow;\n                vec3 uCamPos = eyePositionHigh + eyePositionLow;\n\n                if(a_texCoord.z == -1.0 || a_bufferAA.x == 1.0){\n                    gl_Position = vec4(0.0);\n                    return;\n                }\n\n                v_fontIndex = a_fontIndex;\n                v_texCoords = vec2(a_texCoord.xy);\n                vec3 look = a_positions - uCamPos;\n                float lookDist = length(look);\n                v_rgba = a_rgba;\n                /*v_rgba.a *= uOpacity * step(lookDist, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions,a_positions) - uFloatParams[0]));*/\n                if(uOpacity * step(lookDist, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions,a_positions) - uFloatParams[0]))==0.0){\n                    return;\n                }\n\n                v_rgba.a *= uOpacity;\n\n                vec3 right, up;\n\n                if(a_alignedAxis == ZERO3){\n                    up = vec3( viewMatrix[0][1], viewMatrix[1][1], viewMatrix[2][1] );\n                    right = vec3( viewMatrix[0][0], viewMatrix[1][0], viewMatrix[2][0] );\n                }else{\n                    up = normalize(a_alignedAxis);\n                    right = normalize(cross(look,up));\n                    look = cross(up,right);\n                }\n\n                v_bufferAA = vec3(a_bufferAA, 8.0 * a_bufferAA.y / a_size);\n                float dist = dot(uCamPos - a_positions, vec3(viewMatrix[0][2], viewMatrix[1][2], viewMatrix[2][2]));\n                float focalSize = 2.0 * dist * uFloatParams[1];\n                vec2 offset = a_offset.xy * focalSize;\n\n                float scd = (1.0 - smoothstep(uScaleByDistance[0], uScaleByDistance[1], lookDist)) * (1.0 - step(uScaleByDistance[2], lookDist));\n                float scale = a_size * focalSize * scd;\n                float cosRot = cos(a_rotation);\n                float sinRot = sin(a_rotation);\n                vec3 rr = (right * cosRot - up * sinRot) * (scale * (a_vertices.x + a_texCoord.z + a_texCoord.w) + scd * offset.x) + (right * sinRot + up * cosRot) * (scale * a_vertices.y + scd * offset.y);\n\n                vec3 highDiff = a_positionsHigh - eyePositionHigh;\n                vec3 lowDiff = a_positionsLow + rr - eyePositionLow;\n\n                mat4 viewMatrixRTE = viewMatrix;\n                viewMatrixRTE[3] = vec4(0.0, 0.0, 0.0, 1.0);\n\n                gl_Position = projectionMatrix * viewMatrixRTE * vec4(highDiff + lowDiff, 1.0);\n                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;\n                gl_Position.z += a_offset.z + uZ;\n            }",fragmentShader:"#version 300 es\n\n            precision highp float;\n\n            const int MAX_SIZE = 12;\n\n            uniform sampler2D u_fontTextureArr[MAX_SIZE];\n\n            in float v_fontIndex;\n            in vec2 v_texCoords;\n            in vec4 v_rgba;\n            in vec3 v_bufferAA;\n            in vec3 v_pickingColor;\n\n            layout(location = 0) out vec4 outScreen;\n\n            void main () {\n                int fi = int(v_fontIndex);\n                vec4 color;\n                if (fi == 0) {\n                    color = texture(u_fontTextureArr[0], v_texCoords);\n                } else if (fi == 1) {\n                    color = texture(u_fontTextureArr[1], v_texCoords);\n                } else if (fi == 2) {\n                    color = texture(u_fontTextureArr[2], v_texCoords);\n                } else if (fi == 3) {\n                    color = texture(u_fontTextureArr[3], v_texCoords);\n                } else if (fi == 4) {\n                    color = texture(u_fontTextureArr[4], v_texCoords);\n                } else if (fi == 5) {\n                    color = texture(u_fontTextureArr[5], v_texCoords);\n                } else if (fi == 6) {\n                    color = texture(u_fontTextureArr[6], v_texCoords);\n                } else if (fi == 7) {\n                    color = texture(u_fontTextureArr[7], v_texCoords);\n                } else if (fi == 8) {\n                    color = texture(u_fontTextureArr[8], v_texCoords);\n                } else if (fi == 9) {\n                    color = texture(u_fontTextureArr[9], v_texCoords);\n                }else{\n                    color = texture(u_fontTextureArr[10], v_texCoords);\n                }\n                float afwidth = step(0.5, v_bufferAA.x) * (1.0 - v_bufferAA.y) * v_bufferAA.x * fwidth( color.r );\n                float alpha = smoothstep ( v_bufferAA.x - afwidth - v_bufferAA.z, v_bufferAA.x + afwidth + v_bufferAA.z, color.r );\n                if( alpha < 0.2 )\n                    discard;\n                outScreen = vec4(v_rgba.rgb, alpha * v_rgba.a);\n            }"})):this._renderer.handler.addProgram(new ji("label",{uniforms:{u_fontTextureArr:"sampler2dxx",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",uFloatParams:"vec2",uZ:"float",uScaleByDistance:"vec3",uOpacity:"float"},attributes:{a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_size:"float",a_offset:"vec3",a_rgba:"vec4",a_rotation:"float",a_alignedAxis:"vec3",a_fontIndex:"float",a_bufferAA:"vec2"},vertexShader:"attribute vec2 a_vertices;\n            attribute vec4 a_texCoord;\n            attribute vec3 a_positionsHigh;\n            attribute vec3 a_positionsLow;\n            attribute vec3 a_offset;\n            attribute float a_size;\n            attribute float a_rotation;\n            attribute vec4 a_rgba;\n            attribute vec3 a_alignedAxis;\n            attribute float a_fontIndex;\n            attribute vec2 a_bufferAA;\n            varying vec2 v_texCoords;\n            varying vec4 v_rgba;\n            varying float v_fontIndex;\n            varying vec3 v_bufferAA;\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n            //uniform vec3 uCamPos;\n            uniform vec3 eyePositionHigh;\n            uniform vec3 eyePositionLow;\n            /*0 - planetRadius^2, 1 - tan(fov), 2 - screen ratio*/\n            uniform vec2 uFloatParams;\n            uniform float uZ;\n            uniform vec3 uScaleByDistance;\n            uniform float uOpacity;\n            const vec3 ZERO3 = vec3(0.0);\n            const float C = 0.1;\n            const float far = 149.6e+9;\n            float logc = 2.0 / log( C * far + 1.0 );\n            void main() {\n\n                vec3 a_positions = a_positionsHigh + a_positionsLow;\n                vec3 uCamPos = eyePositionHigh + eyePositionLow;\n\n                if(a_texCoord.z == -1.0 || a_bufferAA.x == 1.0){\n                    gl_Position = vec4(0.0);\n                    return;\n                }\n                v_fontIndex = a_fontIndex;\n                v_texCoords = vec2(a_texCoord.xy);\n                vec3 look = a_positions - uCamPos;\n                float lookDist = length(look);                \n                v_rgba = a_rgba;\n                /*v_rgba.a *= uOpacity * step(lookDist, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions,a_positions) - uFloatParams[0]));*/\n                if(uOpacity * step(lookDist, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions,a_positions) - uFloatParams[0]))==0.0){\n                    return;\n                }\n                v_rgba.a *= uOpacity;\n                vec3 right, up;\n                if(a_alignedAxis == ZERO3){\n                    up = vec3( viewMatrix[0][1], viewMatrix[1][1], viewMatrix[2][1] );\n                    right = vec3( viewMatrix[0][0], viewMatrix[1][0], viewMatrix[2][0] );\n                }else{\n                    up = normalize(a_alignedAxis);\n                    right = normalize(cross(look,up));\n                    look = cross(up,right);\n                }\n                v_bufferAA = vec3(a_bufferAA, 8.0 * a_bufferAA.y / a_size);\n                float dist = dot(uCamPos - a_positions, vec3(viewMatrix[0][2], viewMatrix[1][2], viewMatrix[2][2]));\n                float focalSize = 2.0 * dist * uFloatParams[1];\n                vec2 offset = a_offset.xy * focalSize;\n                float scd = (1.0 - smoothstep(uScaleByDistance[0], uScaleByDistance[1], lookDist)) * (1.0 - step(uScaleByDistance[2], lookDist));\n                float scale = a_size * focalSize * scd;\n                float cosRot = cos(a_rotation);\n                float sinRot = sin(a_rotation);\n                vec3 rr = (right * cosRot - up * sinRot) * (scale * (a_vertices.x + a_texCoord.z + a_texCoord.w) + scd * offset.x) + (right * sinRot + up * cosRot) * (scale * a_vertices.y + scd * offset.y);\n\n                vec3 highDiff = a_positionsHigh - eyePositionHigh;\n                vec3 lowDiff = a_positionsLow + rr - eyePositionLow;\n\n                mat4 viewMatrixRTE = viewMatrix;\n                viewMatrixRTE[3] = vec4(0.0, 0.0, 0.0, 1.0);\n\n                gl_Position = projectionMatrix * viewMatrixRTE * vec4(highDiff + lowDiff, 1.0);\n                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;\n                gl_Position.z += a_offset.z + uZ;\n            }",fragmentShader:"#extension GL_OES_standard_derivatives : enable\n        precision highp float;\n        const int MAX_SIZE = 12;\n        uniform sampler2D u_fontTextureArr[MAX_SIZE];\n        varying float v_fontIndex;\n        varying vec2 v_texCoords;\n        varying vec4 v_rgba;\n        varying vec3 v_bufferAA;\n        varying vec3 v_pickingColor;\n        void main () {\n            int fi = int(v_fontIndex);\n            vec4 color;\n            if (fi == 0) {\n                color = texture2D(u_fontTextureArr[0], v_texCoords);\n            } else if (fi == 1) {\n                color = texture2D(u_fontTextureArr[1], v_texCoords);\n            } else if (fi == 2) {\n                color = texture2D(u_fontTextureArr[2], v_texCoords);\n            } else if (fi == 3) {\n                color = texture2D(u_fontTextureArr[3], v_texCoords);\n            } else if (fi == 4) {\n                color = texture2D(u_fontTextureArr[4], v_texCoords);\n            } else if (fi == 5) {\n                color = texture2D(u_fontTextureArr[5], v_texCoords);\n            } else if (fi == 6) {\n                color = texture2D(u_fontTextureArr[6], v_texCoords);\n            } else if (fi == 7) {\n                color = texture2D(u_fontTextureArr[7], v_texCoords);\n            } else if (fi == 8) {\n                color = texture2D(u_fontTextureArr[8], v_texCoords);\n            } else if (fi == 9) {\n                color = texture2D(u_fontTextureArr[9], v_texCoords);\n            }else{\n                color = texture2D(u_fontTextureArr[10], v_texCoords);\n            }\n            float afwidth = step(0.5, v_bufferAA.x) * (1.0 - v_bufferAA.y) * v_bufferAA.x * fwidth( color.r );\n            float alpha = smoothstep ( v_bufferAA.x - afwidth - v_bufferAA.z, v_bufferAA.x + afwidth + v_bufferAA.z, color.r );\n            if( alpha < 0.2 )\n                discard;\n            gl_FragColor = vec4(v_rgba.rgb, alpha * v_rgba.a);\n        }"}))),this._renderer.handler.programs.labelPicking||this._renderer.handler.addProgram(new ji("labelPicking",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",uFloatParams:"vec2",uScaleByDistance:"vec3",uOpacity:"float"},attributes:{a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_size:"float",a_offset:"vec3",a_pickingColor:"vec3",a_rotation:"float",a_alignedAxis:"vec3"},vertexShader:"precision highp float;\n            attribute vec2 a_vertices;\n            attribute vec4 a_texCoord;\n            attribute vec3 a_positionsHigh;\n            attribute vec3 a_positionsLow;\n            attribute vec3 a_offset;\n            attribute float a_size;\n            attribute float a_rotation;\n            attribute vec3 a_pickingColor;\n            attribute vec3 a_alignedAxis;\n            varying vec4 v_color;\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n            //uniform vec3 uCamPos;\n            uniform vec3 eyePositionHigh;\n            uniform vec3 eyePositionLow;\n            /*0 - planetRadius^2, 1 - tan(fov), 2 - screen ratio*/\n            uniform vec2 uFloatParams;\n            uniform vec3 uScaleByDistance;\n            uniform float uOpacity;\n            const vec3 ZERO3 = vec3(0.0);\n            const float C = 0.1;\n            const float far = 149.6e+9;\n            float logc = 2.0 / log( C * far + 1.0 );\n            void main() {\n                vec3 a_positions = a_positionsHigh + a_positionsLow;\n                vec3 uCamPos = eyePositionHigh + eyePositionLow;\n\n                if( uOpacity == 0.0 ){\n                    gl_Position = vec4(0.0);\n                    return;\n                }\n                if(a_texCoord.z == -1.0){\n                    gl_Position = vec4(0.0);\n                    return;\n                }\n                vec3 look = a_positions - uCamPos;\n                float lookLength = length(look);\n                v_color = vec4(a_pickingColor.rgb, 1.0) * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions, a_positions) - uFloatParams[0]));\n                vec3 right, up;\n                if(a_alignedAxis == ZERO3){\n                    up = vec3( viewMatrix[0][1], viewMatrix[1][1], viewMatrix[2][1] );\n                    right = vec3( viewMatrix[0][0], viewMatrix[1][0], viewMatrix[2][0] );\n                }else{\n                    up = normalize(a_alignedAxis);\n                    right = normalize(cross(look,up));\n                    look = cross(up,right);\n                }\n                float dist = dot(uCamPos - a_positions, vec3(viewMatrix[0][2], viewMatrix[1][2], viewMatrix[2][2]));\n                float focalSize = 2.0 * dist * uFloatParams[1];\n                vec2 offset = a_offset.xy * focalSize;\n                float scd = (1.0 - smoothstep(uScaleByDistance[0], uScaleByDistance[1], lookLength)) *(1.0 - step(uScaleByDistance[2], lookLength));\n                float scale = a_size * focalSize * scd;\n                float cosRot = cos(a_rotation);\n                float sinRot = sin(a_rotation);\n                vec3 rr = (right * cosRot - up * sinRot) * (scale * (a_vertices.x + a_texCoord.z + a_texCoord.w) + scd * offset.x) + (right * sinRot + up * cosRot) * (scale * a_vertices.y + scd * offset.y) + a_positions;\n                gl_Position = projectionMatrix * viewMatrix * vec4(rr, 1);\n                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;\n                gl_Position.z += a_offset.z;\n            }",fragmentShader:"precision highp float;\n            varying vec4 v_color;\n            void main () {\n                gl_FragColor = v_color;\n            }"})))}add(t){-1===t._handlerIndex&&(t._handler=this,t._handlerIndex=this._billboards.length,this._billboards.push(t),this._addBillboardToArrays(t),this.refresh(),this.assignFontAtlas(t))}assignFontAtlas(t){this._entityCollection&&this._renderer&&t.assignFontAtlas(this._renderer.fontAtlas)}clear(){this._texCoordArr.length=0,this._vertexArr.length=0,this._positionHighArr.length=0,this._positionLowArr.length=0,this._sizeArr.length=0,this._offsetArr.length=0,this._rgbaArr.length=0,this._rotationArr.length=0,this._alignedAxisArr.length=0,this._fontIndexArr.length=0,this._noOutlineArr.length=0,this._outlineArr.length=0,this._outlineColorArr.length=0,this._texCoordArr=[],this._vertexArr=[],this._positionHighArr=[],this._positionLowArr=[],this._sizeArr=[],this._offsetArr=[],this._rgbaArr=[],this._rotationArr=[],this._alignedAxisArr=[],this._fontIndexArr=[],this._noOutlineArr=[],this._outlineArr=[],this._outlineColorArr=[],this._removeBillboards(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){var t=this._renderer.handler.gl;t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._fontIndexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._outlineBuffer),t.deleteBuffer(this._noOutlineBuffer),t.deleteBuffer(this._outlineColorBuffer),t.deleteBuffer(this._positionHighBuffer),t.deleteBuffer(this._positionLowBuffer),t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._offsetBuffer),t.deleteBuffer(this._rgbaBuffer),t.deleteBuffer(this._rotationBuffer),t.deleteBuffer(this._vertexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._alignedAxisBuffer),t.deleteBuffer(this._pickingColorBuffer),this._sizeBuffer=null,this._fontIndexBuffer=null,this._texCoordBuffer=null,this._outlineBuffer=null,this._outlineColorBuffer=null,this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._alignedAxisBuffer=null,this._pickingColorBuffer=null}_addBillboardToArrays(t){for(var e=0;e<this._maxLetters;e++){t._visibility?ir.concArr(this._vertexArr,[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]):ir.concArr(this._vertexArr,[0,0,0,0,0,0,0,0,0,0,0,0]),ir.concArr(this._texCoordArr,[0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0]);var i,r=t._positionHigh.x,n=t._positionHigh.y,s=t._positionHigh.z;ir.concArr(this._positionHighArr,[r,n,s,r,n,s,r,n,s,r,n,s,r,n,s,r,n,s]),r=t._positionLow.x,n=t._positionLow.y,s=t._positionLow.z,ir.concArr(this._positionLowArr,[r,n,s,r,n,s,r,n,s,r,n,s,r,n,s,r,n,s]),r=t._size,ir.concArr(this._sizeArr,[r,r,r,r,r,r]),r=t._offset.x,n=t._offset.y,s=t._offset.z-.05,ir.concArr(this._offsetArr,[r,n,s,r,n,s,r,n,s,r,n,s,r,n,s,r,n,s]),r=t._color.x,n=t._color.y,s=t._color.z,i=t._color.w,ir.concArr(this._rgbaArr,[r,n,s,i,r,n,s,i,r,n,s,i,r,n,s,i,r,n,s,i,r,n,s,i]),r=t._rotation,ir.concArr(this._rotationArr,[r,r,r,r,r,r]),r=t._alignedAxis.x,n=t._alignedAxis.y,s=t._alignedAxis.z,ir.concArr(this._alignedAxisArr,[r,n,s,r,n,s,r,n,s,r,n,s,r,n,s,r,n,s]),r=t._fontIndex,ir.concArr(this._fontIndexArr,[0,0,0,0,0,0]),r=1-t._outline,n=0,ir.concArr(this._outlineArr,[r,n,r,n,r,n,r,n,r,n,r,n]),r=.75,n=.7,ir.concArr(this._noOutlineArr,[r,n,r,n,r,n,r,n,r,n,r,n]),r=t._outlineColor.x,n=t._outlineColor.y,s=t._outlineColor.z,i=t._outlineColor.w,ir.concArr(this._outlineColorArr,[r,n,s,i,r,n,s,i,r,n,s,i,r,n,s,i,r,n,s,i,r,n,s,i]),r=t._entity._pickingColor.x/255,n=t._entity._pickingColor.y/255,s=t._entity._pickingColor.z/255,ir.concArr(this._pickingColorArr,[r,n,s,r,n,s,r,n,s,r,n,s,r,n,s,r,n,s])}}_displayPASS(){var t=this._renderer,e=t.handler;e.programs.label.activate();var i=e.programs.label._program,r=i.attributes,n=i.uniforms,s=e.gl,o=this._entityCollection;s.polygonOffset(o.polygonOffsetFactor,o.polygonOffsetUnits);var a=o.renderNode;s.uniform1iv(n.u_fontTextureArr,t.fontAtlas.samplerArr),s.uniformMatrix4fv(n.viewMatrix,!1,t.activeCamera._viewMatrix._m),s.uniformMatrix4fv(n.projectionMatrix,!1,t.activeCamera._projectionMatrix._m),s.uniform3fv(n.eyePositionHigh,t.activeCamera.eyeHigh),s.uniform3fv(n.eyePositionLow,t.activeCamera.eyeLow),s.uniform3fv(n.uScaleByDistance,o.scaleByDistance),s.uniform1f(n.uOpacity,o._fadingOpacity),s.uniform2fv(n.uFloatParams,[a._planetRadius2||0,t.activeCamera._tanViewAngle_hradOneByHeight]),s.bindBuffer(s.ARRAY_BUFFER,this._texCoordBuffer),s.vertexAttribPointer(r.a_texCoord,this._texCoordBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._vertexBuffer),s.vertexAttribPointer(r.a_vertices,this._vertexBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._positionHighBuffer),s.vertexAttribPointer(r.a_positionsHigh,this._positionHighBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._positionLowBuffer),s.vertexAttribPointer(r.a_positionsLow,this._positionLowBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._sizeBuffer),s.vertexAttribPointer(r.a_size,this._sizeBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._offsetBuffer),s.vertexAttribPointer(r.a_offset,this._offsetBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._rotationBuffer),s.vertexAttribPointer(r.a_rotation,this._rotationBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._alignedAxisBuffer),s.vertexAttribPointer(r.a_alignedAxis,this._alignedAxisBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._fontIndexBuffer),s.vertexAttribPointer(r.a_fontIndex,this._fontIndexBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._outlineColorBuffer),s.vertexAttribPointer(r.a_rgba,this._outlineColorBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._outlineBuffer),s.vertexAttribPointer(r.a_bufferAA,this._outlineBuffer.itemSize,s.FLOAT,!1,0,0),s.uniform1f(n.uZ,-2),s.drawArrays(s.TRIANGLES,0,this._vertexBuffer.numItems),s.bindBuffer(s.ARRAY_BUFFER,this._rgbaBuffer),s.vertexAttribPointer(r.a_rgba,this._rgbaBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._noOutlineBuffer),s.vertexAttribPointer(r.a_bufferAA,this._noOutlineBuffer.itemSize,s.FLOAT,!1,0,0),s.uniform1f(n.uZ,-10),s.drawArrays(s.TRIANGLES,0,this._vertexBuffer.numItems)}_pickingPASS(){var t=this._renderer,e=t.handler;e.programs.labelPicking.activate();var i=e.programs.labelPicking._program,r=i.attributes,n=i.uniforms,s=e.gl,o=this._entityCollection;s.polygonOffset(o.polygonOffsetFactor,o.polygonOffsetUnits),s.uniformMatrix4fv(n.viewMatrix,!1,t.activeCamera._viewMatrix._m),s.uniformMatrix4fv(n.projectionMatrix,!1,t.activeCamera._projectionMatrix._m),s.uniform3fv(n.eyePositionHigh,t.activeCamera.eyeHigh),s.uniform3fv(n.eyePositionLow,t.activeCamera.eyeLow),s.uniform3fv(n.uScaleByDistance,o.scaleByDistance),s.uniform1f(n.uOpacity,o._fadingOpacity),s.uniform2fv(n.uFloatParams,[o.renderNode._planetRadius2||0,t.activeCamera._tanViewAngle_hradOneByHeight]),s.bindBuffer(s.ARRAY_BUFFER,this._vertexBuffer),s.vertexAttribPointer(r.a_vertices,this._vertexBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._texCoordBuffer),s.vertexAttribPointer(r.a_texCoord,this._texCoordBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._positionHighBuffer),s.vertexAttribPointer(r.a_positionsHigh,this._positionHighBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._positionLowBuffer),s.vertexAttribPointer(r.a_positionsLow,this._positionLowBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._sizeBuffer),s.vertexAttribPointer(r.a_size,this._sizeBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._offsetBuffer),s.vertexAttribPointer(r.a_offset,this._offsetBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._rotationBuffer),s.vertexAttribPointer(r.a_rotation,this._rotationBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._alignedAxisBuffer),s.vertexAttribPointer(r.a_alignedAxis,this._alignedAxisBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._pickingColorBuffer),s.vertexAttribPointer(r.a_pickingColor,this._pickingColorBuffer.itemSize,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLES,0,this._vertexBuffer.numItems)}_removeBillboard(t){var e=t._handlerIndex;this._billboards.splice(e,1);var i=24*this._maxLetters,r=e*i;this._rgbaArr.splice(r,i),this._outlineColorArr.splice(r,i),this._texCoordArr.splice(r,i),r=e*(i=18*this._maxLetters),this._positionHighArr.splice(r,i),this._positionLowArr.splice(r,i),this._offsetArr.splice(r,i),this._alignedAxisArr.splice(r,i),this._pickingColorArr.splice(r,i),r=e*(i=12*this._maxLetters),this._vertexArr.splice(r,i),this._outlineArr.splice(r,i),this._noOutlineArr.splice(r,i),r=e*(i=6*this._maxLetters),this._sizeArr.splice(r,i),this._rotationArr.splice(r,i),this._fontIndexArr.splice(r,i),this.reindexBillbordsArray(e),this.refresh(),t._handlerIndex=-1,t._handler=null}setText(t,e,i,r){var n=this._renderer.fontAtlas.atlasesArr[i];if(n){var s=24*t*this._maxLetters,o=this._texCoordArr,a=0,h=s+24*a,l=(c=n.nodes[e[a]])?c.emptySize:0,u=l;for(a=0;a<e.length;a++){h=s+24*a;var c,_=(c=n.nodes[e[a]]||n.nodes[" "]).texCoords;o[h]=_[0],o[h+1]=_[1],o[h+2]=u,o[h+3]=0,o[h+4]=_[2],o[h+5]=_[3],o[h+6]=u,o[h+7]=0,o[h+8]=_[4],o[h+9]=_[5],o[h+10]=u,o[h+11]=0,o[h+12]=_[6],o[h+13]=_[7],o[h+14]=u,o[h+15]=0,o[h+16]=_[8],o[h+17]=_[9],o[h+18]=u,o[h+19]=0,o[h+20]=_[10],o[h+21]=_[11],o[h+22]=u,o[h+23]=0,u+=c.emptySize}if(r===Ai.CENTER)for(u=.5*(l+49/512-u),a=0;a<e.length;a++){o[(h=s+24*a)+3]=u,o[h+7]=u,o[h+11]=u,o[h+15]=u,o[h+19]=u,o[h+23]=u}else if(r===Ai.LEFT)for(u=l+49/512-u,a=0;a<e.length;a++){o[(h=s+24*a)+3]=u,o[h+7]=u,o[h+11]=u,o[h+15]=u,o[h+19]=u,o[h+23]=u}for(;a<this._maxLetters;a++){o[(h=s+24*a)+2]=-1,o[h+6]=-1,o[h+10]=-1,o[h+14]=-1,o[h+18]=-1,o[h+17]=-1}this._changedBuffers[ur]=!0}}setPositionArr(t,e,i){for(var r=18*t*this._maxLetters,n=this._positionHighArr,s=e.x,o=e.y,a=e.z,h=this._positionLowArr,l=i.x,u=i.y,c=i.z,_=0;_<this._maxLetters;_++){var f=r+18*_;n[f]=s,n[f+1]=o,n[f+2]=a,n[f+3]=s,n[f+4]=o,n[f+5]=a,n[f+6]=s,n[f+7]=o,n[f+8]=a,n[f+9]=s,n[f+10]=o,n[f+11]=a,n[f+12]=s,n[f+13]=o,n[f+14]=a,n[f+15]=s,n[f+16]=o,n[f+17]=a,h[f]=l,h[f+1]=u,h[f+2]=c,h[f+3]=l,h[f+4]=u,h[f+5]=c,h[f+6]=l,h[f+7]=u,h[f+8]=c,h[f+9]=l,h[f+10]=u,h[f+11]=c,h[f+12]=l,h[f+13]=u,h[f+14]=c,h[f+15]=l,h[f+16]=u,h[f+17]=c}this._changedBuffers[sr]=!0}setPickingColorArr(t,e){for(var i=18*t*this._maxLetters,r=this._pickingColorArr,n=e.x/255,s=e.y/255,o=e.z/255,a=0;a<this._maxLetters;a++){var h=i+18*a;r[h]=n,r[h+1]=s,r[h+2]=o,r[h+3]=n,r[h+4]=s,r[h+5]=o,r[h+6]=n,r[h+7]=s,r[h+8]=o,r[h+9]=n,r[h+10]=s,r[h+11]=o,r[h+12]=n,r[h+13]=s,r[h+14]=o,r[h+15]=n,r[h+16]=s,r[h+17]=o}this._changedBuffers[nr]=!0}setSizeArr(t,e){for(var i=6*t*this._maxLetters,r=this._sizeArr,n=0;n<this._maxLetters;n++){var s=i+6*n;r[s]=e,r[s+1]=e,r[s+2]=e,r[s+3]=e,r[s+4]=e,r[s+5]=e}this._changedBuffers[or]=!0}setOffsetArr(t,e){for(var i=18*t*this._maxLetters,r=this._offsetArr,n=e.x,s=e.y,o=e.z,a=0;a<this._maxLetters;a++){var h=i+18*a;r[h]=n,r[h+1]=s,r[h+2]=o,r[h+3]=n,r[h+4]=s,r[h+5]=o,r[h+6]=n,r[h+7]=s,r[h+8]=o,r[h+9]=n,r[h+10]=s,r[h+11]=o,r[h+12]=n,r[h+13]=s,r[h+14]=o,r[h+15]=n,r[h+16]=s,r[h+17]=o}this._changedBuffers[ar]=!0}setRgbaArr(t,e){for(var i=24*t*this._maxLetters,r=this._rgbaArr,n=e.x,s=e.y,o=e.z,a=e.w,h=0;h<this._maxLetters;h++){var l=i+24*h;r[l]=n,r[l+1]=s,r[l+2]=o,r[l+3]=a,r[l+4]=n,r[l+5]=s,r[l+6]=o,r[l+7]=a,r[l+8]=n,r[l+9]=s,r[l+10]=o,r[l+11]=a,r[l+12]=n,r[l+13]=s,r[l+14]=o,r[l+15]=a,r[l+16]=n,r[l+17]=s,r[l+18]=o,r[l+19]=a,r[l+20]=n,r[l+21]=s,r[l+22]=o,r[l+23]=a}this._changedBuffers[hr]=!0}setOutlineColorArr(t,e){for(var i=24*t*this._maxLetters,r=this._outlineColorArr,n=e.x,s=e.y,o=e.z,a=e.w,h=0;h<this._maxLetters;h++){var l=i+24*h;r[l]=n,r[l+1]=s,r[l+2]=o,r[l+3]=a,r[l+4]=n,r[l+5]=s,r[l+6]=o,r[l+7]=a,r[l+8]=n,r[l+9]=s,r[l+10]=o,r[l+11]=a,r[l+12]=n,r[l+13]=s,r[l+14]=o,r[l+15]=a,r[l+16]=n,r[l+17]=s,r[l+18]=o,r[l+19]=a,r[l+20]=n,r[l+21]=s,r[l+22]=o,r[l+23]=a}this._changedBuffers[pr]=!0}setOutlineArr(t,e){for(var i=12*t*this._maxLetters,r=this._outlineArr,n=0;n<this._maxLetters;n++){var s=i+12*n;r[s]=e,r[s+2]=e,r[s+4]=e,r[s+6]=e,r[s+8]=e,r[s+10]=e}this._changedBuffers[dr]=!0}setRotationArr(t,e){for(var i=6*t*this._maxLetters,r=this._rotationArr,n=0;n<this._maxLetters;n++){var s=i+6*n;r[s]=e,r[s+1]=e,r[s+2]=e,r[s+3]=e,r[s+4]=e,r[s+5]=e}this._changedBuffers[lr]=!0}setVertexArr(t,e){for(var i=12*t*this._maxLetters,r=this._vertexArr,n=0;n<this._maxLetters;n++){var s=i+12*n;r[s]=e[0],r[s+1]=e[1],r[s+2]=e[2],r[s+3]=e[3],r[s+4]=e[4],r[s+5]=e[5],r[s+6]=e[6],r[s+7]=e[7],r[s+8]=e[8],r[s+9]=e[9],r[s+10]=e[10],r[s+11]=e[11]}this._changedBuffers[cr]=!0}setAlignedAxisArr(t,e){for(var i=18*t*this._maxLetters,r=this._alignedAxisArr,n=e.x,s=e.y,o=e.z,a=0;a<this._maxLetters;a++){var h=i+18*a;r[h]=n,r[h+1]=s,r[h+2]=o,r[h+3]=n,r[h+4]=s,r[h+5]=o,r[h+6]=n,r[h+7]=s,r[h+8]=o,r[h+9]=n,r[h+10]=s,r[h+11]=o,r[h+12]=n,r[h+13]=s,r[h+14]=o,r[h+15]=n,r[h+16]=s,r[h+17]=o}this._changedBuffers[_r]=!0}setFontIndexArr(t,e){for(var i=6*t*this._maxLetters,r=this._fontIndexArr,n=0;n<this._maxLetters;n++){var s=i+6*n;r[s]=e,r[s+1]=e,r[s+2]=e,r[s+3]=e,r[s+4]=e,r[s+5]=e}this._changedBuffers[fr]=!0}createSizeBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=t.createArrayBuffer(new Float32Array(this._sizeArr),1,this._sizeArr.length)}createFontIndexBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._fontIndexBuffer),this._fontIndexBuffer=t.createArrayBuffer(new Float32Array(this._fontIndexArr),1,this._fontIndexArr.length)}createTexCoordBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=t.createArrayBuffer(new Float32Array(this._texCoordArr),4,this._texCoordArr.length/4)}createOutlineBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._outlineBuffer),this._outlineBuffer=t.createArrayBuffer(new Float32Array(this._outlineArr),2,this._outlineArr.length/2),t.gl.deleteBuffer(this._noOutlineBuffer),this._noOutlineBuffer=t.createArrayBuffer(new Float32Array(this._noOutlineArr),2,this._noOutlineArr.length/2)}createOutlineColorBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._outlineColorBuffer),this._outlineColorBuffer=t.createArrayBuffer(new Float32Array(this._outlineColorArr),4,this._outlineColorArr.length/4)}setMaxLetters(t){this._maxLetters=t}refreshTexCoordsArr(){return null}}class gr{constructor(t){this._entityCollection=t,this._renderer=null,this._polylines=[],this.__staticId=gr._staticCounter++,this.pickingEnabled=!0}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}_initProgram(){this._renderer.handler&&(this._renderer.handler.programs.polyline_screen||this._renderer.handler.addProgram(new ji("polyline_screen",{uniforms:{viewport:"vec2",proj:"mat4",view:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",uFloatParams:"vec2",thickness:"float"},attributes:{prevHigh:"vec3",currentHigh:"vec3",nextHigh:"vec3",prevLow:"vec3",currentLow:"vec3",nextLow:"vec3",order:"float",color:"vec4"},vertexShader:"precision highp float;\n                \n                attribute vec3 prevHigh;\n                attribute vec3 currentHigh;\n                attribute vec3 nextHigh;\n                \n                attribute vec3 prevLow;\n                attribute vec3 currentLow;\n                attribute vec3 nextLow;\n\n                attribute float order;\n\n                attribute vec4 color;\n\n                uniform float thickness;\n                uniform mat4 proj;\n                uniform mat4 view;\n                uniform vec2 viewport;\n                uniform vec3 eyePositionHigh;\n                uniform vec3 eyePositionLow;\n\n                varying vec4 vColor;\n                varying vec3 vPos;\n                varying vec3 uCamPos;\n                \n                const float C = 0.1;\n                const float far = 149.6e+9;\n                float logc = 2.0 / log( C * far + 1.0 );\n                const float Fcoef = 2.0 / log2(far + 1.0);\n                \n                const float NEAR = -1.0;\n                \n                vec2 getIntersection(vec2 start1, vec2 end1, vec2 start2, vec2 end2){\n                    vec2 dir = end2 - start2;\n                    vec2 perp = vec2(-dir.y, dir.x);\n                    float d2 = dot(perp, start2);\n                    float seg = dot(perp, start1) - d2;\n                    float prl = seg - dot(perp, end1) + d2;\n                    if(prl > -1.0 && prl < 1.0){\n                        return start1;\n                    }\n                    float u = seg / prl;\n                    return start1 + u * (end1 - start1);\n                }\n                \n                vec2 project(vec4 p){\n                    return (0.5 * p.xyz / p.w + 0.5).xy * viewport;\n                }\n                \n                void main(){\n\n                    uCamPos = eyePositionHigh + eyePositionLow;\n\n                    vColor = color;\n\n                    vec3 current = currentHigh + currentLow;\n\n                    vPos = current;                    \n\n                    vec3 highDiff, lowDiff;\n\n                    mat4 viewMatrixRTE = view;\n                    viewMatrixRTE[3] = vec4(0.0, 0.0, 0.0, 1.0);\n\n                    highDiff = currentHigh - eyePositionHigh;\n                    lowDiff = currentLow - eyePositionLow;\n                    vec4 vCurrent = viewMatrixRTE * vec4(highDiff + lowDiff, 1.0);\n\n                    highDiff = prevHigh - eyePositionHigh;\n                    lowDiff = prevLow - eyePositionLow;    \n                    vec4 vPrev = viewMatrixRTE * vec4(highDiff + lowDiff, 1.0);\n\n                    highDiff = nextHigh - eyePositionHigh;\n                    lowDiff = nextLow - eyePositionLow;    \n                    vec4 vNext = viewMatrixRTE * vec4(highDiff + lowDiff, 1.0);\n\n                    /*Clip near plane*/\n                    if(vCurrent.z > NEAR) {\n                        if(vPrev.z < NEAR){\n                            /*to the begining path view*/\n                            vCurrent = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);\n                        }else if(vNext.z < NEAR){\n                            /*to the end path view*/\n                            vPrev = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);\n                            vCurrent = vNext + (vCurrent - vNext) * (NEAR - vNext.z) / (vCurrent.z - vNext.z);\n                        }\n                    } else if( vPrev.z > NEAR) {\n                        /*to the end path view*/\n                        vPrev = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);\n                    } else if( vNext.z > NEAR) {\n                        /*to the begining path view*/\n                        vNext = vNext + (vCurrent - vNext) * (NEAR - vNext.z) / (vCurrent.z - vNext.z);\n                    }\n                    \n                    vec4 dCurrent = proj * vCurrent;\n                    vec2 _next = project(proj * vNext);\n                    vec2 _prev = project(proj * vPrev);\n                    vec2 _current = project(dCurrent);\n                    if(_prev == _current){\n                        if(_next == _current){\n                            _next = _current + vec2(1.0, 0.0);\n                            _prev = _current - _next;\n                        }else{\n                            _prev = _current + normalize(_current - _next);\n                        }\n                    }\n                    if(_next == _current){\n                        _next = _current + normalize(_current - _prev);\n                    }\n                    \n                    vec2 sNext = _next,\n                         sCurrent = _current,\n                         sPrev = _prev;\n\n                    vec2 dirNext = normalize(sNext - sCurrent);\n                    vec2 dirPrev = normalize(sPrev - sCurrent);\n                    float dotNP = dot(dirNext, dirPrev);\n                    \n                    vec2 normalNext = normalize(vec2(-dirNext.y, dirNext.x));\n                    vec2 normalPrev = normalize(vec2(dirPrev.y, -dirPrev.x));\n                    \n                    float d = thickness * sign(order);\n                    \n                    vec2 m;\n                    if(dotNP >= 0.99991){\n                        m = sCurrent - normalPrev * d;\n                    }else{\n                        m = getIntersection( sCurrent + normalPrev * d, sPrev + normalPrev * d,\n                                sCurrent + normalNext * d, sNext + normalNext * d );\n                        \n                        if( dotNP > 0.5 && dot(dirNext + dirPrev, m - sCurrent) < 0.0 ){\n                            float occw = order * sign(dirNext.x * dirPrev.y - dirNext.y * dirPrev.x);\n                            if(occw == -1.0){\n                                m = sCurrent + normalPrev * d;\n                            }else if(occw == 1.0){\n                                m = sCurrent + normalNext * d;\n                            }else if(occw == -2.0){\n                                m = sCurrent + normalNext * d;\n                            }else if(occw == 2.0){\n                                m = sCurrent + normalPrev * d;\n                            }\n                        }else if(distance(sCurrent, m) > min(distance(sCurrent, sNext), distance(sCurrent, sPrev))){\n                            m = sCurrent + normalNext * d;\n                        }\n                    }\n\n                    gl_Position = vec4((2.0 * m / viewport - 1.0) * dCurrent.w, dCurrent.z, dCurrent.w);\n                    gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;\n                }",fragmentShader:"precision highp float;\n                uniform vec2 uFloatParams;\n                varying vec3 uCamPos;\n                varying vec4 vColor;\n                varying vec3 vPos;\n                void main() {\n                    vec3 look = vPos - uCamPos;\n                    float lookLength = length(look);\n                    float a = vColor.a * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(vPos,vPos) - uFloatParams[0]));                    \n                    gl_FragColor = vec4(vColor.rgb, a);\n                }"})),this._renderer.handler.programs.polyline_picking||this._renderer.handler.addProgram(new ji("polyline_picking",{uniforms:{viewport:"vec2",proj:"mat4",view:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",uFloatParams:"vec2",color:"vec4",thickness:"float"},attributes:{prevHigh:"vec3",currentHigh:"vec3",nextHigh:"vec3",prevLow:"vec3",currentLow:"vec3",nextLow:"vec3",order:"float"},vertexShader:"precision highp float;\n                \n                attribute vec3 prevHigh;\n                attribute vec3 currentHigh;\n                attribute vec3 nextHigh;\n                \n                attribute vec3 prevLow;\n                attribute vec3 currentLow;\n                attribute vec3 nextLow;\n\n                attribute float order;\n\n                uniform float thickness;\n                uniform vec4 color;\n                uniform mat4 proj;\n                uniform mat4 view;\n                uniform vec2 viewport;\n                uniform vec3 eyePositionHigh;\n                uniform vec3 eyePositionLow;\n\n                varying vec4 vColor;\n                varying vec3 vPos;\n                varying vec3 uCamPos;\n                \n                const float C = 0.1;\n                const float far = 149.6e+9;\n                float logc = 2.0 / log( C * far + 1.0 );\n                \n                const float NEAR = -1.0;\n                \n                vec2 getIntersection(vec2 start1, vec2 end1, vec2 start2, vec2 end2){\n                    vec2 dir = end2 - start2;\n                    vec2 perp = vec2(-dir.y, dir.x);\n                    float d2 = dot(perp, start2);\n                    float seg = dot(perp, start1) - d2;\n                    float prl = seg - dot(perp, end1) + d2;\n                    if(prl > -1.0 && prl < 1.0){\n                        return start1;\n                    }\n                    float u = seg / prl;\n                    return start1 + u * (end1 - start1);\n                }\n                \n                vec2 project(vec4 p){\n                    return (0.5 * p.xyz / p.w + 0.5).xy * viewport;\n                }\n                \n                void main(){\n\n                    uCamPos = eyePositionHigh + eyePositionLow;\n\n                    vColor = color;\n\n                    vec3 current = currentHigh + currentLow;\n\n                    vPos = current;                    \n\n                    vec3 highDiff, lowDiff;\n\n                    mat4 viewMatrixRTE = view;\n                    viewMatrixRTE[3] = vec4(0.0, 0.0, 0.0, 1.0);\n\n                    highDiff = currentHigh - eyePositionHigh;\n                    lowDiff = currentLow - eyePositionLow;\n                    vec4 vCurrent = viewMatrixRTE * vec4(highDiff + lowDiff, 1.0);\n\n                    highDiff = prevHigh - eyePositionHigh;\n                    lowDiff = prevLow - eyePositionLow;    \n                    vec4 vPrev = viewMatrixRTE * vec4(highDiff + lowDiff, 1.0);\n\n                    highDiff = nextHigh - eyePositionHigh;\n                    lowDiff = nextLow - eyePositionLow;    \n                    vec4 vNext = viewMatrixRTE * vec4(highDiff + lowDiff, 1.0);\n\n                    /*Clip near plane*/\n                    if(vCurrent.z > NEAR) {\n                        if(vPrev.z < NEAR){\n                            /*to the begining path view*/\n                            vCurrent = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);\n                        }else if(vNext.z < NEAR){\n                            /*to the end path view*/\n                            vPrev = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);\n                            vCurrent = vNext + (vCurrent - vNext) * (NEAR - vNext.z) / (vCurrent.z - vNext.z);\n                        }\n                    } else if( vPrev.z > NEAR) {\n                        /*to the end path view*/\n                        vPrev = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);\n                    } else if( vNext.z > NEAR) {\n                        /*to the begining path view*/\n                        vNext = vNext + (vCurrent - vNext) * (NEAR - vNext.z) / (vCurrent.z - vNext.z);\n                    }\n                    \n                    vec4 dCurrent = proj * vCurrent;\n                    vec2 _next = project(proj * vNext);\n                    vec2 _prev = project(proj * vPrev);\n                    vec2 _current = project(dCurrent);\n                    if(_prev == _current){\n                        if(_next == _current){\n                            _next = _current + vec2(1.0, 0.0);\n                            _prev = _current - _next;\n                        }else{\n                            _prev = _current + normalize(_current - _next);\n                        }\n                    }\n                    if(_next == _current){\n                        _next = _current + normalize(_current - _prev);\n                    }\n                    \n                    vec2 sNext = _next,\n                         sCurrent = _current,\n                         sPrev = _prev;\n\n                    vec2 dirNext = normalize(sNext - sCurrent);\n                    vec2 dirPrev = normalize(sPrev - sCurrent);\n                    float dotNP = dot(dirNext, dirPrev);\n                    \n                    vec2 normalNext = normalize(vec2(-dirNext.y, dirNext.x));\n                    vec2 normalPrev = normalize(vec2(dirPrev.y, -dirPrev.x));\n                    \n                    float d = thickness * sign(order);\n                    \n                    vec2 m;\n                    if(dotNP >= 0.99991){\n                        m = sCurrent - normalPrev * d;\n                    }else{\n                        m = getIntersection( sCurrent + normalPrev * d, sPrev + normalPrev * d,\n                                sCurrent + normalNext * d, sNext + normalNext * d );\n                        \n                        if( dotNP > 0.5 && dot(dirNext + dirPrev, m - sCurrent) < 0.0 ){\n                            float occw = order * sign(dirNext.x * dirPrev.y - dirNext.y * dirPrev.x);\n                            if(occw == -1.0){\n                                m = sCurrent + normalPrev * d;\n                            }else if(occw == 1.0){\n                                m = sCurrent + normalNext * d;\n                            }else if(occw == -2.0){\n                                m = sCurrent + normalNext * d;\n                            }else if(occw == 2.0){\n                                m = sCurrent + normalPrev * d;\n                            }\n                        }\n                        else if(distance(sCurrent, m) > min(distance(sCurrent, sNext), distance(sCurrent, sPrev))){\n                            m = sCurrent + normalNext * d;\n                        }\n                    }\n                    gl_Position = vec4((2.0 * m / viewport - 1.0) * dCurrent.w, dCurrent.z, dCurrent.w);\n                    gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;\n                }",fragmentShader:"precision highp float;\n                uniform vec2 uFloatParams;\n                varying vec3 uCamPos;\n                varying vec4 vColor;\n                varying vec3 vPos;\n                void main() {\n                    vec3 look = vPos - uCamPos;\n                    float lookLength = length(look);\n                    float a = vColor.a * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(vPos,vPos) - uFloatParams[0]));                    \n                    gl_FragColor = vec4(vColor.rgb, a);\n                }"})))}setRenderNode(t){this._renderer=t.renderer,this._initProgram();for(var e=0;e<this._polylines.length;e++)this._polylines[e].setRenderNode(t)}add(t){-1===t._handlerIndex&&(t._handler=this,t._handlerIndex=this._polylines.length,this._polylines.push(t),this._entityCollection&&this._entityCollection.renderNode&&t.setRenderNode(this._entityCollection.renderNode))}remove(t){var e=t._handlerIndex;-1!==e&&(t._deleteBuffers(),t._handlerIndex=-1,t._handler=null,this._polylines.splice(e,1),this.reindexPolylineArray(e))}reindexPolylineArray(t){for(var e=this._polylines,i=t;i<e.length;i++)e[i]._handlerIndex=i}draw(){let t=this._polylines.length;for(;t--;)this._polylines[t].draw()}drawPicking(){if(this.pickingEnabled){let t=this._polylines.length;for(;t--;)this._polylines[t].drawPicking()}}clear(){for(var t=this._polylines.length;t--;)this._polylines[t]._deleteBuffers(),this._polylines[t]._handler=null,this._polylines[t]._handlerIndex=-1;this._polylines.length=0,this._polylines=[]}}class mr{constructor(t){this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._pointClouds=[],this.__staticId=mr._staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}_initProgram(){this._renderer.handler&&(this._renderer.handler.programs.pointCloud||this._renderer.handler.addProgram(new ji("pointCloud",{uniforms:{projectionViewMatrix:{type:Vi.MAT4},opacity:{type:Vi.FLOAT},pointSize:{type:Vi.FLOAT}},attributes:{coordinates:{type:Vi.VEC3,enableArray:!0},colors:{type:Vi.VEC3,enableArray:!0}},vertexShader:"attribute vec3 coordinates;            attribute vec4 colors;            uniform mat4 projectionViewMatrix;            uniform float opacity;            uniform float pointSize;            varying vec4 color;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main() {                color = colors;                color.a *= opacity;                gl_Position = projectionViewMatrix * vec4(coordinates, 1.0);                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                gl_PointSize = pointSize;            }",fragmentShader:"precision highp float;\n            varying vec4 color;            void main(void) {                gl_FragColor = color;            }"})))}setRenderNode(t){this._renderer=t.renderer,this._initProgram();for(var e=0;e<this._pointClouds.length;e++)this._pointClouds[e].setRenderNode(t)}add(t){-1===t._handlerIndex&&(t._handler=this,t._handlerIndex=this._pointClouds.length,this._pointClouds.push(t),this._entityCollection&&this._entityCollection.renderNode&&t.setRenderNode(this._entityCollection.renderNode))}remove(t){var e=t._handlerIndex;-1!==e&&(t._deleteBuffers(),t._handlerIndex=-1,t._handler=null,this._pointClouds.splice(e,1),this.reindexPointCloudArray(e))}reindexPointCloudArray(t){for(var e=this._pointClouds,i=t;i<e.length;i++)e[i]._handlerIndex=i}draw(){for(var t=this._pointClouds.length;t--;)this._pointClouds[t].draw()}drawPicking(){if(this.pickingEnabled)for(var t=this._pointClouds.length;t--;)this._pointClouds[t].drawPicking()}clear(){for(var t=this._pointClouds.length;t--;)this._pointClouds[t]._deleteBuffers(),this._pointClouds[t]._handler=null,this._pointClouds[t]._handlerIndex=-1;this._pointClouds.length=0,this._pointClouds=[]}}class yr{constructor(t){this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._strips=[],this.__staticId=yr._staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}_initProgram(){this._renderer.handler&&!this._renderer.handler.programs.strip&&this._renderer.handler.addProgram(new ji("strip",{uniforms:{projectionMatrix:{type:"mat4"},viewMatrix:{type:"mat4"},eyePositionHigh:"vec3",eyePositionLow:"vec3",uColor:{type:"vec4"}},attributes:{aVertexPositionHigh:{type:"vec3"},aVertexPositionLow:{type:"vec3"}},vertexShader:"attribute vec3 aVertexPositionHigh;\n                        attribute vec3 aVertexPositionLow;\n                        uniform mat4 projectionMatrix;\n                        uniform mat4 viewMatrix;\n                        uniform vec3 eyePositionHigh;\n                        uniform vec3 eyePositionLow;\n                        const float C = 0.1;\n                        const float far = 149.6e+9;\n                        float logc = 2.0 / log( C * far + 1.0 );\n                        void main(void) {\n\n                            vec3 highDiff = aVertexPositionHigh - eyePositionHigh;\n                            vec3 lowDiff = aVertexPositionLow - eyePositionLow;\n\n                            mat4 viewMatrixRTE = viewMatrix;\n                            viewMatrixRTE[3] = vec4(0.0, 0.0, 0.0, 1.0);\n\n                            gl_Position = projectionMatrix * viewMatrixRTE * vec4(highDiff + lowDiff, 1.0);\n                            //gl_Position = projectionViewMatrix  * vec4(aVertexPositionHigh + aVertexPositionLow, 1.0);\n                            gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;\n                        }",fragmentShader:"precision highp float;\n                        uniform vec4 uColor;\n                        void main(void) {\n                            gl_FragColor = vec4(uColor);\n                        }"}))}setRenderNode(t){this._renderer=t.renderer,this._initProgram();for(var e=0;e<this._strips.length;e++)this._strips[e].setRenderNode(t)}add(t){-1===t._handlerIndex&&(t._handler=this,t._handlerIndex=this._strips.length,this._strips.push(t),this._entityCollection&&this._entityCollection.renderNode&&t.setRenderNode(this._entityCollection.renderNode))}remove(t){var e=t._handlerIndex;-1!==e&&(t._deleteBuffers(),t._handlerIndex=-1,t._handler=null,this._strips.splice(e,1),this.reindexStripArray(e))}reindexStripArray(t){for(var e=this._strips,i=t;i<e.length;i++)e[i]._handlerIndex=i}draw(){for(var t=this._strips.length;t--;)this._strips[t].draw()}drawPicking(){if(this.pickingEnabled)for(var t=this._strips.length;t--;)this._strips[t].drawPicking()}clear(){for(var t=this._strips.length;t--;)this._strips[t]._deleteBuffers(),this._strips[t]._handler=null,this._strips[t]._handlerIndex=-1;this._strips.length=0,this._strips=[]}}class xr{constructor(t){this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._shapes=[],this.__staticId=xr._staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}_initProgram(){this._renderer.handler&&(this._renderer.handler.programs.shape_nl||this._renderer.handler.addProgram(new ji("shape_nl",{uniforms:{projectionViewMatrix:{type:Vi.MAT4},modelMatrix:{type:Vi.MAT4},uColor:{type:Vi.VEC4},uSampler:{type:Vi.SAMPLER2D}},attributes:{aVertexPosition:{type:Vi.VEC3,enableArray:!0},aTextureCoord:{type:Vi.VEC2,enableArray:!0}},vertexShader:"attribute vec3 aVertexPosition;            attribute vec2 aTextureCoord;            uniform mat4 projectionViewMatrix;            uniform mat4 modelMatrix;            varying vec2 vTextureCoord;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main(void) {                gl_Position = projectionViewMatrix * (modelMatrix * vec4(aVertexPosition, 1.0));                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                vTextureCoord = aTextureCoord;            }",fragmentShader:"precision highp float;\n            uniform vec4 uColor;            uniform sampler2D uSampler;            varying vec2 vTextureCoord;            void main(void) {                gl_FragColor = uColor*texture2D( uSampler, vTextureCoord.st );            }"})),this._renderer.handler.programs.shape_wl||this._renderer.handler.addProgram(new ji("shape_wl",{uniforms:{viewMatrix:{type:Vi.MAT4},projectionMatrix:{type:Vi.MAT4},modelMatrix:{type:Vi.MAT4},normalMatrix:{type:Vi.MAT4},lightsPositions:{type:Vi.VEC4},lightsParamsv:{type:Vi.VEC3},lightsParamsf:{type:Vi.FLOAT},uColor:{type:Vi.VEC4},uSampler:{type:Vi.SAMPLER2D}},attributes:{aVertexNormal:{type:Vi.VEC3,enableArray:!0},aVertexPosition:{type:Vi.VEC3,enableArray:!0},aTextureCoord:{type:Vi.VEC2,enableArray:!0}},vertexShader:"attribute vec3 aVertexNormal;            attribute vec3 aVertexPosition;            attribute vec2 aTextureCoord;            uniform mat4 projectionMatrix;            uniform mat4 viewMatrix;            uniform mat4 modelMatrix;            uniform mat3 normalMatrix;            varying vec2 vTextureCoord;            varying vec3 vNormal;            varying vec4 vPosition;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main(void) {                vTextureCoord = aTextureCoord;                vNormal = normalMatrix * aVertexNormal;                vPosition = viewMatrix * modelMatrix * vec4(aVertexPosition, 1.0);                gl_Position = projectionMatrix * vPosition;                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;            }",fragmentShader:"precision highp float;\n            varying vec2 vTextureCoord;            varying vec3 vNormal;            varying vec4 vPosition;            uniform vec4 uColor;            uniform sampler2D uSampler;\n            #define MAX_POINT_LIGHTS 1\n            uniform int lightsQuantity;            uniform vec4 lightsPositions[MAX_POINT_LIGHTS];            uniform vec3 lightsParamsv[MAX_POINT_LIGHTS * 3];            uniform float lightsParamsf[MAX_POINT_LIGHTS];            void main(void) {                vec3 lightWeighting;                vec3 lightDirection;                vec3 normal;                vec3 eyeDirection;                vec3 reflectionDirection;                float specularLightWeighting;                float diffuseLightWeighting;                lightDirection = normalize(lightsPositions[0].xyz - vPosition.xyz * lightsPositions[0].w);                normal = normalize(vNormal);                eyeDirection = normalize(-vPosition.xyz);                reflectionDirection = reflect(-lightDirection, normal);                specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), lightsParamsf[0]);                diffuseLightWeighting = max(dot(normal, lightDirection), 0.0);                lightWeighting = lightsParamsv[0] + lightsParamsv[1] * diffuseLightWeighting + lightsParamsv[2] * specularLightWeighting;                vec4 cc = texture2D( uSampler, vTextureCoord.st );                gl_FragColor = vec4(lightWeighting, uColor.a) * cc * uColor;            }"})))}setRenderNode(t){this._renderer=t.renderer,this._initProgram();for(var e=0;e<this._shapes.length;e++)this._shapes[e].setRenderNode(t)}add(t){-1==t._handlerIndex&&(t._handler=this,t._handlerIndex=this._shapes.length,this._shapes.push(t),this._entityCollection&&this._entityCollection.renderNode&&t.setRenderNode(this._entityCollection.renderNode))}remove(t){}draw(){for(var t=this._shapes.length;t--;)this._shapes[t].draw()}drawPicking(){}clear(){}}class br{constructor(t){t=t||{},this.id=br._staticCounter++,this._renderNodeIndex=-1,this.renderNode=null,this._visibility=void 0==t.visibility||t.visibility,this.polygonOffsetFactor=void 0!=t.polygonOffsetFactor?t.polygonOffsetFactor:0,this.polygonOffsetUnits=void 0!=t.polygonOffsetUnits?t.polygonOffsetUnits:-637e3,this.billboardHandler=new ir(this),this.labelHandler=new vr(this),this.shapeHandler=new xr(this),this.polylineHandler=new gr(this),this.pointCloudHandler=new mr(this),this.stripHandler=new yr(this),void 0!=t.pickingEnabled&&this.setPickingEnabled(t.pickingEnabled),this._entities=t.entities||[],this.scaleByDistance=t.scaleByDistance||[g,g,g],this.pickingScale=t.pickingScale||1,this._opacity=void 0==t.opacity?1:t.opacity,this._fadingOpacity=this._opacity,this.events=new rr(Ar,this),this.addEntities(this._entities)}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}setPolygonOffset(t,e){this.polygonOffsetFactor=t,this.polygonOffsetUnits=e}setVisibility(t){this._visibility=t,this._fadingOpacity=this._opacity*(t?1:0),this.events.dispatch(this.events.visibilitychange,this)}getVisibility(){return this._visibility}setOpacity(t){this._opacity=t}setPickingEnabled(t){this.billboardHandler.pickingEnabled=t,this.labelHandler.pickingEnabled=t,this.polylineHandler.pickingEnabled=t,this.shapeHandler.pickingEnabled=t,this.pointCloudHandler.pickingEnabled=t,this.stripHandler.pickingEnabled=t}getOpacity(){return this._opacity}setScaleByDistance(t,e,i){this.scaleByDistance[0]=t,this.scaleByDistance[1]=e,this.scaleByDistance[2]=i||g}_addRecursively(t){t.billboard&&this.billboardHandler.add(t.billboard),t.label&&this.labelHandler.add(t.label),t.shape&&this.shapeHandler.add(t.shape),t.polyline&&this.polylineHandler.add(t.polyline),t.pointCloud&&this.pointCloudHandler.add(t.pointCloud),t.strip&&this.stripHandler.add(t.strip),this.events.dispatch(this.events.entityadd,t);for(var e=0;e<t.childrenNodes.length;e++)t.childrenNodes[e]._entityCollection=this,t.childrenNodes[e]._entityCollectionIndex=t._entityCollectionIndex,t.childrenNodes[e]._pickingColor=t._pickingColor,this._addRecursively(t.childrenNodes[e])}add(t){if(!t._entityCollection){t._entityCollection=this,t._entityCollectionIndex=this._entities.length,this._entities.push(t);var e=this.renderNode;e&&(e.renderer&&e.renderer.assignPickingColor(t),e.ellipsoid&&t._cartesian.isZero()&&t.setCartesian3v(e.ellipsoid.lonLatToCartesian(t._lonlat))),this._addRecursively(t),t.setPickingColor()}return this}addEntities(t){for(var e=t.length;e--;)this.add(t[e]);return this}belongs(t){return t._entityCollection&&this._renderNodeIndex===t._entityCollection._renderNodeIndex}_removeRecursively(t){t._entityCollection=null,t._entityCollectionIndex=-1,t.billboard&&this.billboardHandler.remove(t.billboard),t.label&&this.labelHandler.remove(t.label),t.shape&&this.shapeHandler.remove(t.shape),t.polyline&&this.polylineHandler.remove(t.polyline),t.pointCloud&&this.pointCloudHandler.remove(t.pointCloud),t.strip&&this.stripHandler.remove(t.strip);for(var e=0;e<t.childrenNodes.length;e++)this._removeRecursively(t.childrenNodes[e])}removeEntity(t){this._entities.splice(t._entityCollectionIndex,1),this.reindexEntitiesArray(t._entityCollectionIndex),this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(t),t._pickingColor.clear()),this.belongs(t)&&this._removeRecursively(t),this.events.dispatch(this.events.entityremove,t)}_removeEntitySilent(t){this._entities.splice(t._entityCollectionIndex,1),this.reindexEntitiesArray(t._entityCollectionIndex),this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(t),t._pickingColor.clear()),this.belongs(t)&&this._removeRecursively(t)}createPickingColors(){for(var t=this._entities,e=0;e<t.length;e++)t[e].parent||(this.renderNode.renderer.assignPickingColor(t[e]),t[e].setPickingColor())}reindexEntitiesArray(t){for(var e=this._entities,i=t;i<e.length;i++)e[i]._entityCollectionIndex=i}addTo(t,e){return this.renderNode||(this.renderNode=t,e||(this._renderNodeIndex=t.entityCollections.length,t.entityCollections.push(this)),t.ellipsoid&&this._updateGeodeticCoordinates(t.ellipsoid),this.bindRenderNode(t),this.events.dispatch(this.events.add,this)),this}bindRenderNode(t){t.renderer&&(this.billboardHandler.setRenderer(t.renderer),this.labelHandler.setRenderer(t.renderer),this.shapeHandler.setRenderNode(t),this.polylineHandler.setRenderNode(t),this.pointCloudHandler.setRenderNode(t),this.stripHandler.setRenderNode(t),this.updateBillboardsTextureAtlas(),this.updateLabelsFontAtlas(),this.createPickingColors())}_updateGeodeticCoordinates(t){for(var e=this._entities,i=e.length;i--;){var r=e[i];r._lonlat&&r.setCartesian3v(t.lonLatToCartesian(r._lonlat))}}updateBillboardsTextureAtlas(){for(var t=this.billboardHandler._billboards,e=0;e<t.length;e++)t[e].setSrc(t[e]._src)}updateLabelsFontAtlas(){if(this.renderNode)for(var t=this.labelHandler._billboards,e=0;e<t.length;e++)t[e].assignFontAtlas(this.renderNode.fontAtlas)}remove(){if(this.renderNode){if(-1!==this._renderNodeIndex){this.renderNode.entityCollections.splice(this._renderNodeIndex,1);for(var t=this._renderNodeIndex;t<this.renderNode.entityCollections.length;t++)this.renderNode.entityCollections._renderNodeIndex=t}this.renderNode=null,this._renderNodeIndex=-1,this.events.dispatch(this.events.remove,this)}}getEntities(){return[].concat(this._entities)}each(t){for(var e=this._entities.length;e--;){var i=this._entities[e];i&&t(i)}}clear(){this.billboardHandler.clear(),this.labelHandler.clear(),this.shapeHandler.clear(),this.polylineHandler.clear(),this.pointCloudHandler.clear(),this.stripHandler.clear();for(var t=this._entities.length;t--;){var e=this._entities[t];this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(e),e._pickingColor.clear()),this._clearEntity(e)}this._entities.length=0,this._entities=[]}_clearEntity(t){t._entityCollection=null,t._entityCollectionIndex=-1;for(var e=0;e<t.childrenNodes.length;e++)this._clearEntity(t.childrenNodes[e])}}const Ar=["entitymove","draw","drawend","add","remove","entityadd","entityremove","visibilitychange","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"],Cr=0,wr=1,Er=2,Tr=3,Br=4,Pr=5;class Rr{constructor(){this._f=new Array(6);for(var t=0;t<6;t++)this._f[t]=new Array(4)}static planeNormalize(t){var e=1/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e}getRight(){return this._f[Cr]}getLeft(){return this._f[wr]}getBottom(){return this._f[Er]}getTop(){return this._f[Tr]}getBackward(){return this._f[Br]}getForward(){return this._f[Pr]}setFrustum(t){let e=t._m;this._f[0][0]=e[3]-e[0],this._f[0][1]=e[7]-e[4],this._f[0][2]=e[11]-e[8],this._f[0][3]=e[15]-e[12],Rr.planeNormalize(this._f[0]),this._f[1][0]=e[3]+e[0],this._f[1][1]=e[7]+e[4],this._f[1][2]=e[11]+e[8],this._f[1][3]=e[15]+e[12],Rr.planeNormalize(this._f[1]),this._f[2][0]=e[3]+e[1],this._f[2][1]=e[7]+e[5],this._f[2][2]=e[11]+e[9],this._f[2][3]=e[15]+e[13],Rr.planeNormalize(this._f[2]),this._f[3][0]=e[3]-e[1],this._f[3][1]=e[7]-e[5],this._f[3][2]=e[11]-e[9],this._f[3][3]=e[15]-e[13],Rr.planeNormalize(this._f[3]),this._f[4][0]=e[3]-e[2],this._f[4][1]=e[7]-e[6],this._f[4][2]=e[11]-e[10],this._f[4][3]=e[15]-e[14],Rr.planeNormalize(this._f[4]),this._f[5][0]=e[3]+e[2],this._f[5][1]=e[7]+e[6],this._f[5][2]=e[11]+e[10],this._f[5][3]=e[15]+e[14],Rr.planeNormalize(this._f[5])}containsPoint(t){for(var e=0;e<6;e++)if(t.dotArr(this._f[e])+this._f[e][3]<=0)return!1;return!0}containsSphereBottomExc(t){var e=-t.radius,i=this._f;return!(t.center.dotArr(i[0])+i[0][3]<=e)&&(!(t.center.dotArr(i[1])+i[1][3]<=e)&&(!(t.center.dotArr(i[3])+i[3][3]<=e)&&(!(t.center.dotArr(i[4])+i[4][3]<=e)&&!(t.center.dotArr(i[5])+i[5][3]<=e))))}containsSphereButtom(t){var e=-t.radius,i=this._f;return!(t.center.dotArr(i[2])+i[2][3]<=e)}containsSphere(t){var e=-t.radius,i=this._f;return!(t.center.dotArr(i[0])+i[0][3]<=e)&&(!(t.center.dotArr(i[1])+i[1][3]<=e)&&(!(t.center.dotArr(i[2])+i[2][3]<=e)&&(!(t.center.dotArr(i[3])+i[3][3]<=e)&&(!(t.center.dotArr(i[4])+i[4][3]<=e)&&!(t.center.dotArr(i[5])+i[5][3]<=e)))))}containsSphere2(t,e){var i=-e;return!(t.dotArr(this._f[0])+this._f[0][3]<=i)&&(!(t.dotArr(this._f[1])+this._f[1][3]<=i)&&(!(t.dotArr(this._f[2])+this._f[2][3]<=i)&&(!(t.dotArr(this._f[3])+this._f[3][3]<=i)&&(!(t.dotArr(this._f[4])+this._f[4][3]<=i)&&!(t.dotArr(this._f[5])+this._f[5][3]<=i)))))}containsBox(t){for(var e,i,r=!0,n=0;n<6;n++){e=0,i=0;for(var s=0;s<8&&(0===i||0===e);s++){t.vertices[s].dotArr(this._f[n])+this._f[n][3]<0?e++:i++}if(0===i)return!1;e>0&&(r=!0)}return r}}class zr{constructor(t,e){this.renderer=null,this.events=new rr(Lr,this),this.eye=new Xt,this.eyeHigh=new Float32Array(3),this.eyeLow=new Float32Array(3),this.frustum=new Rr,this._aspect=e.aspect||0,this._nearDist=0,this._farDist=0,this._viewAngle=0,this._normalMatrix=new Ht,this._projectionMatrix=new Vt,this._viewMatrix=new Vt,this._projectionViewMatrix=new Vt,this._inverseProjectionViewMatrix=new Vt,this._projectionMatrixPrecise=new Vt,this._u=new Xt(0,1,0),this._v=new Xt(1,0,0),this.slope=0,this._n=new Xt(0,0,1),this._pu=this._u.clone(),this._pv=this._v.clone(),this._pn=this._n.clone(),this._peye=this.eye.clone(),this._moved=!1,this._tanViewAngle_hrad=0,this._tanViewAngle_hradOneByHeight=0,this.renderer=t,t&&this._initialize(e)}_setViewMatrix(){var t=this._u,e=this._v,i=this._n,r=this.eye;Xt.doubleToTwoFloat32Array(r,this.eyeHigh,this.eyeLow),this._viewMatrix.set([t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,-r.dot(t),-r.dot(e),-r.dot(i),1])}checkMoveEnd(){var t=this._u,e=this._v,i=this._n,r=this.eye;this.events.moveend.handlers.length&&(this._peye.equal(r)&&this._pu.equal(t)&&this._pv.equal(e)&&this._pn.equal(i)?(this._moved&&this.events.dispatch(this.events.moveend,this),this._moved=!1):this._moved=!0),this._pu.copy(t),this._pv.copy(e),this._pn.copy(i),this._peye.copy(r)}_initialize(t){this.setProjectionMatrix(t.viewAngle||Mr.viewAngle,this._aspect||this.renderer.handler.getClientAspect(),t.near||Mr.near,t.far||Mr.far),this.set(t.eye||Mr.eye.clone(),t.look||Mr.look.clone(),t.up||Mr.up.clone())}getUp(){return this._v.clone()}getDown(){return this._v.negateTo()}getRight(){return this._u.clone()}getLeft(){return this._u.negateTo()}getForward(){return this._n.negateTo()}getBackward(){return this._n.clone()}clone(){var t=new zr;return t.eye.copy(cam.eye),t._u.copy(cam._u),t._v.copy(cam._v),t._n.copy(cam._n),t.renderer=cam.renderer,t._projectionMatrix.copy(cam._projectionMatrix),t._viewMatrix.copy(cam._viewMatrix),t._projectionViewMatrix.copy(cam._projectionViewMatrix),t._inverseProjectionViewMatrix.copy(cam._inverseProjectionViewMatrix),t.frustum.setFrustum(t._projectionViewMatrix),t}update(){this._setViewMatrix(),this._projectionViewMatrix=this._projectionMatrix.mul(this._viewMatrix),this.frustum.setFrustum(this._projectionViewMatrix),this._inverseProjectionViewMatrix=this._projectionViewMatrix.inverseTo(),this._normalMatrix=this._viewMatrix.toMatrix3(),this.events.dispatch(this.events.viewchange,this)}refresh(){this.setProjectionMatrix(this._viewAngle,this._aspect,this._nearDist,this._farDist),this.update()}setAspectRatio(t){this._aspect=t,this.refresh()}getAspectRatio(){return this._aspect}setFar(t){this._farDist=t,this.refresh()}getFar(){return this._farDist}setNear(t){this._nearDist=t,this.refresh()}getNear(){return this._nearDist}setProjectionMatrix(t,e,i,r){this._viewAngle=t,this._aspect=e,this._nearDist=i,this._farDist=r,this._tanViewAngle_hrad=Math.tan(t*T),this._tanViewAngle_hradOneByHeight=this._tanViewAngle_hrad*this.renderer.handler._oneByHeight;var n=this.renderer.handler.canvas;this._projSizeConst=Math.min(n.clientWidth,n.clientHeight)/(this._viewAngle*A),this._projectionMatrix.setPerspective(t,e,i,r),this._projectionMatrixPrecise.setPerspective(t,e,1,100)}setViewAngle(t){this._viewAngle=t,this.refresh()}set(t,e,i){return this.eye.x=t.x,this.eye.y=t.y,this.eye.z=t.z,e=e||this._n,i=i||this._v,this._n.x=t.x-e.x,this._n.y=t.y-e.y,this._n.z=t.z-e.z,this._u.copy(i.cross(this._n)),this._n.normalize(),this._u.normalize(),this._v.copy(this._n.cross(this._u)),this}look(t,e){this._n.set(this.eye.x-t.x,this.eye.y-t.y,this.eye.z-t.z),this._u.copy((e||this._v).cross(this._n)),this._n.normalize(),this._u.normalize(),this._v.copy(this._n.cross(this._u))}slide(t,e,i){this.eye.x+=t*this._u.x+e*this._v.x+i*this._n.x,this.eye.y+=t*this._u.y+e*this._v.y+i*this._n.y,this.eye.z+=t*this._u.z+e*this._v.z+i*this._n.z}roll(t){var e=Math.cos(A*t),i=Math.sin(A*t),r=this._u.clone();this._u.set(e*r.x-i*this._v.x,e*r.y-i*this._v.y,e*r.z-i*this._v.z),this._v.set(i*r.x+e*this._v.x,i*r.y+e*this._v.y,i*r.z+e*this._v.z)}pitch(t){var e=Math.cos(A*t),i=Math.sin(A*t),r=this._n.clone();this._n.set(e*r.x-i*this._v.x,e*r.y-i*this._v.y,e*r.z-i*this._v.z),this._v.set(i*r.x+e*this._v.x,i*r.y+e*this._v.y,i*r.z+e*this._v.z)}yaw(t){var e=Math.cos(A*t),i=Math.sin(A*t),r=this._u.clone();this._u.set(e*r.x-i*this._n.x,e*r.y-i*this._n.y,e*r.z-i*this._n.z),this._n.set(i*r.x+e*this._n.x,i*r.y+e*this._n.y,i*r.z+e*this._n.z)}unproject(t,e){var i=this.renderer.handler.canvas,r=.5*i.width,n=.5*i.height,s=(t-r)/r,o=-(e-n)/n,a=this._inverseProjectionViewMatrix.mulVec4(new Ut(s,o,-1,1)).affinity();return this._inverseProjectionViewMatrix.mulVec4(new Ut(s,o,0,1)).affinity().subA(a).toVec3().normalize()}project(t){var e=this._projectionViewMatrix.mulVec4(t.toVec4()),i=this.renderer.handler.canvas;return new Yt((1+e.x/e.w)*i.width*.5,(1-e.y/e.w)*i.height*.5)}rotateAround(t,e,i,r){i=i||Xt.ZERO,r=r||Xt.UP;var n=(new Vt).setRotation(e?this._v:r,t),s=(new Vt).setIdentity().translate(i),o=(new Vt).setIdentity().translate(i.negateTo()),a=s.mul(n).mul(o);this.eye=a.mulVec3(this.eye),this._v=n.mulVec3(this._v).normalize(),this._u=n.mulVec3(this._u).normalize(),this._n=n.mulVec3(this._n).normalize()}rotateHorizontal(t,e,i,r){this.rotateAround(t,e,i,r)}rotateVertical(t,e){this.rotateAround(t,!1,e,this._u)}projectedSize(t,e){return Math.atan(e/this.eye.distance(t))*this._projSizeConst}getNormalMatrix(){return this._normalMatrix}getProjectionMatrix(){return this._projectionMatrix}getViewMatrix(){return this._viewMatrix}getProjectionViewMatrix(){return this._projectionViewMatrix}getInverseProjecttionViewMatrix(){return this._inverseProjectionViewMatrix}}const Lr=["viewchange","moveend"],Mr={viewAngle:30,near:1,far:5e8,eye:new Xt,look:new Xt,up:new Xt(0,1,0)},Fr=function(t,e,i){this.a=t||0,this.b=e||0,this.c=i||0};Fr.get=function(t,e){return new Fr(e.y-t.y,t.x-e.x,e.x*t.y-t.x*e.y)},Fr.getParallel=function(t,e){return new Fr(t.a,t.b,-t.a*e.x-t.b*e.y)},Fr.getIntersection=function(t,e){var i=(e.b*t.c-t.b*e.c)/(t.b*e.a-e.b*t.a);return new Yt(i,-(t.c+t.a*i)/t.b)},Fr.prototype.intersects=function(t){return Fr.getIntersection(this,t)};class Dr{constructor(t,e){this.p=t?t.clone():new Xt,this.n=e?e.clone():new Xt}set(t,e){this.p.copy(t),this.n.copy(e)}getNormal(){return this.n.clone()}getProjection(t,e){return Xt.proj_b_to_plane(t,this.n,e)}getIntersection(t,e,i){var r,n=t.n.cross(e.n),s=n.x>=0?n.x:-n.x,o=n.y>=0?n.y:-n.y,a=n.z>=0?n.z:-n.z;if(s+o+a<I){var h=e.p.sub(t.p);return 0==t.n.dot(h)?1:0}r=s>o?s>a?1:3:o>a?2:3;var l,u,c=new Xt;return l=-t.n.dot(t.p),u=-e.n.dot(e.p),1===r?(c.x=0,c.y=(u*t.n.z-l*e.n.z)/n.x,c.z=(l*e.n.y-u*t.n.y)/n.x):2===r?(c.x=(l*e.n.z-u*t.n.z)/n.y,c.y=0,c.z=(u*t.n.x-l*e.n.x)/n.y):3===r&&(c.x=(u*t.n.y-l*e.n.y)/n.z,c.y=(l*e.n.x-u*t.n.x)/n.z,c.z=0),i.p0.copy(c),i.p1.copy(c.add(n)),2}}const Sr=function(t,e){this.origin=t.clone(),this.direction=e.clone()};Sr.OUTSIDE=0,Sr.INSIDE=1,Sr.INPLANE=2,Sr.AWAY=3,Sr.prototype.set=function(t,e){return this.origin=t.clone(),this.direction=e.clone(),this},Sr.prototype.getPoint=function(t){return Xt.add(this.origin,this.direction.scaleTo(t))},Sr.prototype.hitTriangle=function(t,e,i,r,n){var s=e.sub(t),o=i.sub(t),a=s.cross(o),h=this.origin.sub(t),l=-a.dot(h),u=a.dot(this.direction);if(Math.abs(u)<W)return 0===l?(r.copy(this.origin),Sr.INPLANE):Sr.OUTSIDE;var c=l/u;if(r.copy(this.origin.add(this.direction.scaleTo(c))),c<0)return Sr.AWAY;var _=s.dot(s),f=s.dot(o),d=o.dot(o),p=r.sub(t),v=p.dot(s),g=p.dot(o),m=f*f-_*d,y=(f*g-d*v)/m;if(y<0||y>1)return Sr.OUTSIDE;var x=(f*v-_*g)/m;return x<0||y+x>1?Sr.OUTSIDE:Sr.INSIDE},Sr.prototype.hitPlane=function(t,e,i,r){var n=Xt.sub(e,t),s=Xt.sub(i,t),o=n.cross(s),a=Xt.sub(this.origin,t),h=-o.dot(a),l=o.dot(this.direction);if(Math.abs(l)<W&&0===h)return Sr.OUTSIDE;var u=h/l;if(u<0)return Sr.OUTSIDE;var c=this.direction.scaleTo(u);return r.x=this.origin.x+c.x,r.y=this.origin.y+c.y,r.z=this.origin.z+c.z,Sr.INSIDE},Sr.prototype.hitSphere=function(t){var e=t.radius,i=t.center,r=this.origin,n=this.direction,s=Xt.sub(i,r);if(s.dot(n)<0){var o=s.length();if(o>e)return null;if(o===e)return r.clone();var a=i.projToRay(r,s),h=Xt.sub(a,i).length(),l=(c=Math.sqrt(e*e-h*h))-Xt.sub(a,r).length();return Xt.add(r,n.scaleTo(l))}a=i.projToRay(r,n);var u=Xt.sub(i,a).length();if(u>t.radius)return null;var c=Math.sqrt(e*e-u*u);return a.subA(r),l=s.length()>e?a.length()-c:a.length()+c,Xt.add(r,n.scaleTo(l))},Sr.prototype.hitBox=function(t){};class Nr{constructor(t,e){this._canvas=document.createElement("canvas"),this._canvas.width=t||256,this._canvas.height=e||256,this._context=this._canvas.getContext("2d")}getCanvas(){return this._canvas}getContext(){return this._context}fillEmpty(){for(var t=this._context.getImageData(0,0,this._canvas.width,this._canvas.height),e=t.data,i=0,r=e.length;i<r;i+=4)e[i]=e[i+1]=e[i+2]=e[i+3]=0;this._context.putImageData(t,0,0)}getData(){return this._context.getImageData(0,0,this._canvas.width,this._canvas.height).data}fillColor(t){this._context.fillStyle=t,this._context.fillRect(0,0,this._canvas.width,this._canvas.height)}setData(t){var e=this._context.createImageData(this._canvas.width,this._canvas.height);e.data.set(t),this._context.putImageData(e,0,0)}resize(t,e){this._canvas.width=t,this._canvas.height=e,this._context=this._canvas.getContext("2d")}drawImage(t,e,i,r,n){this._context=this._canvas.getContext("2d"),this._context.drawImage(t,e||0,i||0,r||t.width,n||t.height)}getImage(){var t=new Image;return t.width=this.getWidth(),t.height=this.getHeight(),t.src=this._canvas.toDataURL("image/png"),t}getTextWidth(t){var e=this._context.measureText(t);return Math.round(e.width)}drawText(t,e,i,r,n){this._context.fillStyle=n||"black",this._context.font=r||"normal 14px Verdana",this._context.fillText(t,e||0,i||14)}getWidth(){return this._canvas.width}getHeight(){return this._canvas.height}load(t,e){var i=new Image,r=this;i.onload=function(){r.resize(i.width,i.height),r._context.drawImage(i,0,0,i.width,i.height),e&&e(i)},i.src=t}openImage(){var t=this.getImage(),e="<!DOCTYPE html>";e+="<html>",e+="<head><title>Print</title></head>",e+="<body>",e+='<img src="'+t.src+'">',e+="</body>",e+="</html>";var i=window.open("","","width="+t.width+"px ,height="+t.height+"px");i.document.open(),i.document.write(e),i.document.close(),i.focus()}destroy(){this._canvas.width=1,this._canvas.height=1,this._canvas=null,this._context=null}}const kr=function(t,e){e=e||{},this.handler=t,this._fbo=null,this._isBare=e.isBare||!1,this._depthRenderbuffer=null,this._filter=e.filter||"NEAREST",this._internalFormat=e.internalFormat||"RGBA",this._format=e.format||"RGBA",this._type=e.type||"UNSIGNED_BYTE",this._width=e.width||t.canvas.width,this._height=e.height||t.canvas.height,this._depthComponent=void 0!=e.depthComponent?e.depthComponent:"DEPTH_COMPONENT16",this._useDepth=void 0==e.useDepth||e.useDepth,this._active=!1,this._size=e.size||1,this.textures=e.textures||new Array(this._size)};kr.prototype.destroy=function(){for(var t=this.handler.gl,e=0;e<this.textures.length;e++)t.deleteTexture(this.textures[e]);this.textures=new Array(this._size),t.deleteFramebuffer(this._fbo),t.deleteRenderbuffer(this._depthRenderbuffer),this._depthRenderbuffer=null,this._fbo=null,this._active=!1},kr.prototype.init=function(){var t=this.handler.gl;if(this._fbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),!this._isBare)if(0===this.textures.length)this.bindOutputTexture(this.handler.createEmptyTexture2DExt(this._width,this._height,this._filter,this._internalFormat,this._format,this._type)),t.drawBuffers&&t.drawBuffers([t.COLOR_ATTACHMENT0]);else{let i=[];for(var e=0;e<this.textures.length;e++)this.bindOutputTexture(this.textures[e]||this.handler.createEmptyTexture2DExt(this._width,this._height,this._filter,this._internalFormat,this._format,this._type),e),i.push(t.COLOR_ATTACHMENT0+e);t.drawBuffers&&t.drawBuffers(i)}return this._useDepth&&(this._depthRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._depthRenderbuffer),t.renderbufferStorage(t.RENDERBUFFER,t[this._depthComponent],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this._depthRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null)),t.bindFramebuffer(t.FRAMEBUFFER,null),this},kr.prototype.bindOutputTexture=function(t,e=0){var i=this.handler.gl;i.bindTexture(i.TEXTURE_2D,t),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,i.TEXTURE_2D,t,0),i.bindTexture(i.TEXTURE_2D,null),this.textures[e]=t},kr.prototype.setSize=function(t,e,i){this._width=t,this._height=e,this._active&&this.handler.gl.viewport(0,0,this._width,this._height),(this._useDepth||i)&&(this.destroy(),this.init())},kr.prototype.isComplete=function(){var t=this.handler.gl;return t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE},kr.prototype.readPixels=function(t,e,i,r=0,n=1,s=1){var o=this.handler.gl;o.bindFramebuffer(o.FRAMEBUFFER,this._fbo),o.readBuffer&&o.readBuffer(o.COLOR_ATTACHMENT0+r||0),o.readPixels(e*this._width,i*this._height,n,s,o.RGBA,o[this._type],t),o.bindFramebuffer(o.FRAMEBUFFER,null)},kr.prototype.readAllPixels=function(t,e=0){var i=this.handler.gl;i.bindFramebuffer(i.FRAMEBUFFER,this._fbo),i.readBuffer&&i.readBuffer(i.COLOR_ATTACHMENT0+e),i.readPixels(0,0,this._width,this._height,i.RGBA,i[this._type],t),i.bindFramebuffer(i.FRAMEBUFFER,null)},kr.prototype.activate=function(){var t=this.handler.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),t.viewport(0,0,this._width,this._height),this._active=!0;var e=this.handler.framebufferStack.current().data;return e&&(e._active=!1),this.handler.framebufferStack.push(this),this},kr.prototype.deactivate=function(){var t=this.handler,e=t.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this._active=!1;var i=this.handler.framebufferStack.popPrev();i?(e.bindFramebuffer(e.FRAMEBUFFER,i._fbo),e.viewport(0,0,i._width,i._height)):e.viewport(0,0,t.canvas.width,t.canvas.height)},kr.prototype.getImage=function(){var t=new Uint8Array(4*this._width*this._height);this.readAllPixels(t);var e=new Nr(this._width,this._height);return e.setData(t),e.getImage()},kr.prototype.openImage=function(){var t=this.getImage(),e="<!DOCTYPE html>";e+="<html>",e+="<head><title>Print</title></head>",e+="<body>",e+='<img src="'+t.src+'">',e+="</body>",e+="</html>";var i=window.open("","","width="+t.width+"px ,height="+t.height+"px");i.document.open(),i.document.write(e),i.document.close(),i.focus()};class Ir{static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}constructor(t){t=t||{},this._id=Ir._staticCounter++,this.name=t.name||"",this.events=new rr(["tick","end"],this),this.startDate=t.startDate||0,this.endDate=t.endDate||0;var e=t.currentDate||Ve(new Date);t.startDate&&e<t.startDate&&(e=t.startDate),t.endDate&&e>t.endDate&&(e=t.endDate),this.currentDate=e,this.multiplier=void 0!==t.multiplier?t.multiplier:1,this.deltaTicks=0,this.active=!0,this._intervalDelay=0,this._intervalStart=0,this._intervalCallback=null}clearInterval(){this._intervalDelay=0,this._intervalStart=0,this._intervalCallback=null}setInterval(t,e){this._intervalStart=this.currentDate,this._intervalDelay=t*Fe,this._intervalCallback=e}setDate(t){var e=Ve(t);this.startDate&&e<this.startDate&&(e=this.startDate),this.endDate&&e>this.endDate&&(e=this.endDate),this.currentDate=e}getDate(){return je(this.currentDate)}reset(){this.startDate&&(this.currentDate=this.startDate)}_tick(t){if(this.deltaTicks=t*this.multiplier,this.active){var e=qe(this.currentDate,this.deltaTicks);this.multiplier>0?this.endDate&&e>this.endDate?(this.currentDate=this.startDate,this.events.dispatch(this.events.end,this)):this.currentDate=e:this.startDate&&e<this.startDate?(this.currentDate=this.endDate,this.events.dispatch(this.events.end,this)):this.currentDate=e,this._intervalCallback&&this.currentDate-this._intervalStart>=this._intervalDelay&&(this._intervalStart=this.currentDate,this._intervalCallback(this)),this.events.dispatch(this.events.tick,this)}}equal(t){return this._id===t._id}}const Or=function(t,e){this._program=e,this._handler=t,this._activated=!1};Or.prototype.initialize=function(){this._program.createProgram(this._handler.gl)},Or.prototype.getProgram=function(){return this._program},Or.prototype.activate=function(){if(!this._activated){this._handler.activeProgram.deactivate(),this._handler.activeProgram=this;var t=this._program;this._activated=!0,t.enableAttribArrays(),t.use()}return this},Or.prototype.remove=function(){var t=this._handler.programs;t[this._program.name]&&(this._activated&&this.deactivate(),this._program.delete(),t[this._program.name]=null,delete t[this._program.name])},Or.prototype.deactivate=function(){this._program.disableAttribArrays(),this._activated=!1},Or.prototype.isActive=function(){return this._activated},Or.prototype.set=function(t){return this.activate(),this._program.set(t),this},Or.prototype.drawIndexBuffer=function(t,e){return this._program.drawIndexBuffer(t,e),this},Or.prototype.drawArrays=function(t,e){return this._program.drawArrays(t,e),this};class Ur{constructor(){this.next=null,this.prev=null,this.data=null}}class Hr{constructor(t=256){this._current=new Ur,this._head=this._current;for(var e=0;e<t;e++){var i=new Ur;i.prev=this._current,this._current.next=i,this._current=i}this._current=this._head}current(){return this._current}push(t){this._current=this._current.next,this._current.data=t}pop(t){return this._current=this._current.prev,this._current.next.data}popPrev(t){return this._current=this._current.prev,this._current.data}}const Vr=["","WEBKIT_","MOZ_"],Wr=function(t,e){e=e||{},this.defaultClock=new Ir,this._clocks=[],this.deltaTime=0,this.canvas=null,this.gl=null,this.programs={},this.activeProgram=null,this._params=e||{},this._params.anisotropy=this._params.anisotropy||8;var i=this._params.width;i>4096&&(i=4096),this._params.width=i||256;var r=this._params.height;r>4096&&(r=4096),this._params.height=r||256,this._params.context=this._params.context||{},this._params.extensions=this._params.extensions||[],this._oneByHeight=1/this._params.height,this.extensions={},this._id=t,this._lastAnimationFrameTime=0,this._initialized=!1,this._frameCallback=function(){},this.transparentTexture=null,this.framebufferStack=new Hr,(e.autoActivate||Gt(e.autoActivate))&&this.initialize()};Wr.getExtension=function(t,e){var i,r;for(i in Vr)if(r=t.getExtension(Vr[i]+e))return r;return null};const Xr=["webgl2","webgl"];Wr.getContext=function(t,e){var i=null;try{for(let r=0;r<Xr.length;r++)if(i=t.getContext(Xr[r],e)){i.type=Xr[r];break}}catch(t){Yi.logErr("exception during the GL context initialization")}return i||Yi.logErr("could not initialise WebGL"),i},Wr.prototype.setFrameCallback=function(t){t&&(this._frameCallback=t)},Wr.prototype.createTexture_n=function(t){var e=this.gl,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),i},Wr.prototype.createEmptyTexture2DExt=function(t=1,e=1,i="NEAREST",r="RGBA",n="RGBA",s="UNSIGNED_BYTE",o=0){var a=this.gl,h=a.createTexture();return a.bindTexture(a.TEXTURE_2D,h),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),a.texImage2D(a.TEXTURE_2D,o,a[r.toUpperCase()],t,e,0,a[n.toUpperCase()],a[s.toUpperCase()],null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a[i.toUpperCase()]),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a[i.toUpperCase()]),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),h},Wr.prototype.createEmptyTexture_n=function(t,e){var i=this.gl,r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.bindTexture(i.TEXTURE_2D,null),r},Wr.prototype.createEmptyTexture_l=function(t,e){var i=this.gl,r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.bindTexture(i.TEXTURE_2D,null),r},Wr.prototype.createTexture_l=function(t){var e=this.gl,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),i},Wr.prototype.createTexture_mm=function(t){var e=this.gl,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.generateMipmap(e.TEXTURE_2D),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),i},Wr.prototype.createTexture_a=function(t){var e=this.gl,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.generateMipmap(e.TEXTURE_2D),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameterf(e.TEXTURE_2D,this.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._params.anisotropy),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),i},Wr.prototype.createTexture=function(t){return this.createTexture_a(t)},Wr.prototype.loadCubeMapTexture=function(t){var e=this.gl,i=e.createTexture();e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR);var r=[[t.px,e.TEXTURE_CUBE_MAP_POSITIVE_X],[t.nx,e.TEXTURE_CUBE_MAP_NEGATIVE_X],[t.py,e.TEXTURE_CUBE_MAP_POSITIVE_Y],[t.ny,e.TEXTURE_CUBE_MAP_NEGATIVE_Y],[t.pz,e.TEXTURE_CUBE_MAP_POSITIVE_Z],[t.nz,e.TEXTURE_CUBE_MAP_NEGATIVE_Z]],n=new Nr;n.fillEmpty();var s=n.getImage();for(let t=0;t<r.length;t++){let n=r[t][1];e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(n,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,s)}for(let t=0;t<r.length;t++){let n=r[t][1],s=new Image;s.crossOrigin="",s.onload=function(t,i,r){return function(){e.bindTexture(e.TEXTURE_CUBE_MAP,t),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(i,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r)}}(i,n,s),s.src=r[t][0]}return i},Wr.prototype.addProgram=function(t,e){if(this.programs[t.name])console.log("og.webgl.Handler:284 - shader program: '"+t.name+"' is allready exists.");else{var i=new Or(this,t);this.programs[t.name]=i,this._initProgramController(i),e&&(i._activated=!1)}return t},Wr.prototype.removeProgram=function(t){this.programs[t]&&this.programs[t].remove()},Wr.prototype.addPrograms=function(t){for(var e=0;e<t.length;e++)this.addProgram(t[e])},Wr.prototype._initProgramController=function(t){this._initialized&&(t.initialize(),this.activeProgram?(t.deactivate(),this.activeProgram._program.enableAttribArrays(),this.activeProgram._program.use()):(this.activeProgram=t,t.activate()))},Wr.prototype._initPrograms=function(){for(var t in this.programs)this._initProgramController(this.programs[t])},Wr.prototype.initializeExtension=function(t,e){if(!this.extensions||!this.extensions[t]){var i=Wr.getExtension(this.gl,t);i?this.extensions[t]=i:e&&console.log("og.webgl.Handler: extension '"+t+"' doesn't initialize.")}return this.extensions&&this.extensions[t]},Wr.prototype.initialize=function(){this._id?this.canvas=document.getElementById(this._id):(this.canvas=document.createElement("canvas"),this.canvas.width=this._params.width,this.canvas.height=this._params.height),this.gl=Wr.getContext(this.canvas,this._params.context),this._initialized=!0,this._params.extensions.push("EXT_texture_filter_anisotropic"),"webgl"===this.gl.type?(this._params.extensions.push("OES_standard_derivatives"),this._params.extensions.push("OES_element_index_uint")):(this._params.extensions.push("EXT_color_buffer_float"),this._params.extensions.push("OES_texture_float_linear"));for(var t=this._params.extensions.length;t--;)this.initializeExtension(this._params.extensions[t],!0);this.extensions.EXT_texture_filter_anisotropic||(this.createTexture=this.createTexture_mm),this._initPrograms(),this._setDefaults()},Wr.prototype._setDefaults=function(){this.activateDepthTest(),this.setSize(this._params.width,this._params.height),this.gl.frontFace(this.gl.CCW),this.gl.cullFace(this.gl.BACK),this.activateFaceCulling(),this.deactivateBlending();var t=this;this.createDefaultTexture({color:"rgba(0,0,0,0.0)"},function(e){t.transparentTexture=e})},Wr.prototype.activateDepthTest=function(){this.gl.enable(this.gl.DEPTH_TEST)},Wr.prototype.deactivateDepthTest=function(){this.gl.disable(this.gl.DEPTH_TEST)},Wr.prototype.activateFaceCulling=function(){this.gl.enable(this.gl.CULL_FACE)},Wr.prototype.deactivateFaceCulling=function(){this.gl.disable(this.gl.CULL_FACE)},Wr.prototype.activateBlending=function(){this.gl.enable(this.gl.BLEND)},Wr.prototype.deactivateBlending=function(){this.gl.disable(this.gl.BLEND)},Wr.prototype.createArrayBuffer=function(t,e,i,r){var n=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,n),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,r||this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),n.itemSize=e,n.numItems=i,n},Wr.prototype.createElementArrayBuffer=function(t,e,i,r){var n=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,n),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,t,r||this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null),n.itemSize=e,n.numItems=i||t.length,n},Wr.prototype.setSize=function(t,e){t>4096&&(t=4096),e>4096&&(e=4096),this._params.width=t,this._params.height=e,this.canvas.width=t,this.canvas.height=e,this._oneByHeight=1/e,this.gl&&this.gl.viewport(0,0,t,e),this.onCanvasResize&&this.onCanvasResize(this.canvas)},Wr.prototype.getWidth=function(){return this.canvas.width},Wr.prototype.getHeight=function(){return this.canvas.height},Wr.prototype.getClientAspect=function(){return this.canvas.clientWidth/this.canvas.clientHeight},Wr.prototype.getCenter=function(){var t=this.canvas;return new Yt(Math.round(.5*t.width),Math.round(.5*t.height))},Wr.prototype.drawFrame=function(){var t=(new Date).getTime();this.deltaTime=t-this._lastAnimationFrameTime,this._lastAnimationFrameTime=t,this.defaultClock._tick(this.deltaTime);for(var e=0;e<this._clocks.length;e++)this._clocks[e]._tick(this.deltaTime);var i=this.canvas;i.clientWidth===i.width&&i.clientHeight===i.height||this.setSize(i.clientWidth,i.clientHeight),this._frameCallback()},Wr.prototype.clearFrame=function(){var t=this.gl;this.gl.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)},Wr.prototype.start=function(){if(!this._requestAnimationFrameId&&this._initialized){var t=new Date;this._lastAnimationFrameTime=t.getTime(),this.defaultClock.setDate(t),this._animationFrameCallback()}},Wr.prototype.stop=function(){this._requestAnimationFrameId&&(window.cancelAnimationFrame(this._requestAnimationFrameId),this._requestAnimationFrameId=null)},Wr.prototype._animationFrameCallback=function(){this._requestAnimationFrameId=window.requestAnimationFrame(()=>{this.drawFrame(),this._animationFrameCallback()})},Wr.prototype.createDefaultTexture=function(t,e){var i,r;if(t&&t.color)(i=new Nr(2,2)).fillColor(t.color),(r=this.createTexture_n(i._canvas)).default=!0,e(r);else if(t&&t.url){var n=new Image,s=this;n.onload=function(){(r=s.createTexture(this)).default=!0,e(r)},n.src=t.url}else(i=new Nr(2,2)).fillColor("#C5C5C5"),(r=this.createTexture_n(i._canvas)).default=!0,e(r)},Wr.prototype.destroy=function(){var t=this.gl;for(var e in this.stop(),this.programs)this.removeProgram(e);t.deleteTexture(this.transparentTexture),this.transparentTexture=null,this.framebufferStack=null,this.framebufferStack=new Hr,this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null;var i=t.getParameter(t.MAX_VERTEX_ATTRIBS),r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r);for(let e=0;e<i;++e)t.disableVertexAttribArray(e),t.vertexAttribPointer(e,4,t.FLOAT,!1,0,0),t.vertexAttrib1f(e,0);t.deleteBuffer(r);var n=t.getParameter(t.MAX_TEXTlURE_IMAGE_UNITS);for(let e=0;e<n;++e)t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_CUBE_MAP,null),t.bindTexture(t.TEXTURE_2D,null);t.activeTexture(t.TEXTURE0),t.useProgram(null),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.DITHER),t.disable(t.SCISSOR_TEST),t.blendColor(0,0,0,0),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ZERO),t.clearColor(0,0,0,0),t.clearDepth(1),t.clearStencil(-1),this.gl=null,this._initialized=!1},Wr.prototype.addClock=function(t){t.__handler||(t.__handler=this,this._clocks.push(t))},Wr.prototype.addClocks=function(t){for(var e=0;e<t.length;e++)this.addClock(t[e])},Wr.prototype.removeClock=function(t){if(t.__handler)for(var e=this._clocks,i=e.length;i--;)if(e[i].equal(t)){t.__handler=null,e.splice(i,1);break}};const Yr=function(t,e){e=e||{},this.handler=t,this._internalFormat=e.internalFormat?e.internalFormat.toUpperCase():"RGBA8",this._fbo=null,this._depthRenderbuffer=null,this._width=e.width||t.canvas.width,this._height=e.height||t.canvas.height,this._msaa=void 0!=e.msaa?e.msaa:4,this._useDepth=void 0==e.useDepth||e.useDepth,this._depthComponent=void 0!=e.depthComponent?e.depthComponent:"DEPTH_COMPONENT16",this._active=!1,this._size=e.size||1,this._filter=e.filter||"NEAREST",this._glFilter=null,this.renderbuffers=new Array(this._size)};Yr.prototype.destroy=function(){for(var t=this.handler.gl,e=0;e<this.renderbuffers.length;e++)t.deleteRenderbuffer(this.renderbuffers[e]);this.renderbuffers=new Array(this._size),t.deleteFramebuffer(this._fbo),t.deleteRenderbuffer(this._depthRenderbuffer),this._depthRenderbuffer=null,this._fbo=null,this._active=!1},Yr.prototype.init=function(){var t=this.handler.gl;if(this._glFilter=t[this._filter],this._fbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),0===this.renderbuffers.length){let e=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,e),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._msaa,t[this._internalFormat],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,e),this.renderbuffers.push(e),t.bindRenderbuffer(t.RENDERBUFFER,null),t.drawBuffers([t.COLOR_ATTACHMENT0])}else{let i=[];for(var e=0;e<this.renderbuffers.length;e++){let r=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,r),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._msaa,t[this._internalFormat],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.RENDERBUFFER,r),i.push(t.COLOR_ATTACHMENT0+e),this.renderbuffers[e]=r,t.bindRenderbuffer(t.RENDERBUFFER,null)}t.drawBuffers(i)}return this._useDepth&&(this._depthRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._depthRenderbuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._msaa,t[this._depthComponent],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this._depthRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null)),t.bindFramebuffer(t.FRAMEBUFFER,null),this},Yr.prototype.blit=function(t,e=0){let i=this.handler.gl;i.bindFramebuffer(i.READ_FRAMEBUFFER,this._fbo),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._fbo),i.readBuffer(i.COLOR_ATTACHMENT0+e),i.clearBufferfv(i.COLOR,0,[0,0,0,1]),i.blitFramebuffer(0,0,this._width,this._height,0,0,t._width,t._height,i.COLOR_BUFFER_BIT,this._glFilter),i.bindFramebuffer(i.FRAMEBUFFER,null),i.bindFramebuffer(i.READ_FRAMEBUFFER,null),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,null)},Yr.prototype.setSize=function(t,e,i){this._width=t,this._height=e,this._active&&this.handler.gl.viewport(0,0,this._width,this._height),(this._useDepth||i)&&(this.destroy(),this.init())},Yr.prototype.isComplete=function(){var t=this.handler.gl;return t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE},Yr.prototype.activate=function(){var t=this.handler.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),t.viewport(0,0,this._width,this._height),this._active=!0;var e=this.handler.framebufferStack.current().data;return e&&(e._active=!1),this.handler.framebufferStack.push(this),this},Yr.prototype.deactivate=function(){var t=this.handler,e=t.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this._active=!1;var i=this.handler.framebufferStack.popPrev();i?(e.bindFramebuffer(e.FRAMEBUFFER,i._fbo),e.viewport(0,0,i._width,i._height)):e.viewport(0,0,t.canvas.width,t.canvas.height)};const jr=function(){var t={},e={},i={},r={},n=this,s=null,o=null,a=!0;if(jr.prototype._instance)return jr.prototype._instance;jr.prototype._instance=this,document.onkeydown=function(t){o=t,a&&n.handleKeyDown.call(n)},document.onkeyup=function(t){o=t,a&&n.handleKeyUp.call(n)};var h=function(t,e){return t.priority<e.priority};this.removeEvent=function(t,e){},this.setActivity=function(t){a=t},this.addEvent=function(t,o,a,l,u){switch(void 0===u&&(u=1600),t){case"keyfree":i[l]||(i[l]=[]),i[l].push({callback:a,sender:o,priority:u}),i[l].sort(h);break;case"keypress":null==l?s={callback:a,sender:o||n}:(e[l]||(e[l]=[]),e[l].push({callback:a,sender:o,priority:u}),e[l].sort(h));break;case"charkeypress":r[l]||(r[l]=[]),r[l].push({callback:a,sender:o,priority:u}),r[l].sort(h)}},this.isKeyPressed=function(e){return t[e]},this.handleKeyDown=function(){for(var e in s&&s.callback.call(s.sender,o),t[o.keyCode]=!0,r)if(String.fromCharCode(o.keyCode)==String.fromCharCode(e))for(var i=r[e],n=0;n<i.length;n++)i[n].callback.call(i[n].sender,o)},this.handleKeyUp=function(){if(t[o.keyCode])for(var e in i)if(t[e])for(var r=i[e],n=0;n<r.length;n++)r[n].callback.call(r[n].sender,o);t[o.keyCode]=!1},this.handleEvents=function(){for(var i in e)if(t[i])for(var r=e[i],n=0;n<r.length;n++)r[n].callback.call(r[n].sender,o)}},Gr=function(t){this._htmlObject=t};Gr.prototype.setEvent=function(t,e,i){switch(t){case"mousewheel":this._htmlObject.addEventListener("mousewheel",function(t){var r=t.deltaY||t.detail||t.wheelDelta;void 0==t.wheelDelta&&(t.wheelDelta=-120*r),i.call(e,t),t.preventDefault()},!1),this._htmlObject.addEventListener("wheel",function(t){var r=t.deltaY||t.detail||t.wheelDelta;void 0==t.wheelDelta&&(t.wheelDelta=-120*r),i.call(e,t),t.preventDefault()},!1);break;case"mousedown":this._htmlObject.addEventListener("mousedown",function(t){i.call(e,t)}),this._htmlObject.addEventListener("contextmenu",function(t){return t.preventDefault(),!1});break;case"mouseup":this._htmlObject.addEventListener("mouseup",function(t){i.call(e,t)});break;case"mousemove":this._htmlObject.addEventListener("mousemove",function(t){var r=this.getBoundingClientRect();i.call(e,{clientX:t.clientX-r.left,clientY:t.clientY-r.top})})}};const qr=function(t){this._htmlObject=t};qr.prototype.setEvent=function(t,e,i){switch(t){case"touchcancel":this._htmlObject.addEventListener("touchcancel",function(t){t.preventDefault();var r=this.getBoundingClientRect();t.offsetLeft=r.left,t.offsetTop=r.top,i.call(e,t),t.preventDefault()});break;case"touchstart":this._htmlObject.addEventListener("touchstart",function(t){t.preventDefault();var r=this.getBoundingClientRect();t.offsetLeft=r.left,t.offsetTop=r.top,i.call(e,t),t.preventDefault()});break;case"touchend":this._htmlObject.addEventListener("touchend",function(t){t.preventDefault();var r=this.getBoundingClientRect();t.offsetLeft=r.left,t.offsetTop=r.top,i.call(e,t),t.preventDefault()});break;case"touchmove":this._htmlObject.addEventListener("touchmove",function(t){t.preventDefault();var r=this.getBoundingClientRect();t.offsetLeft=r.left,t.offsetTop=r.top,i.call(e,t),t.preventDefault()})}};const Kr=["draw","resize","mousemove","mousestop","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchstart","touchend","touchcancel","touchmove","doubletouch","touchleave","touchenter"];class Zr{constructor(t,e,i,r){this.left=t||0,this.right=i||0,this.top=e||0,this.bottom=r||0}clone(){return new Zr(this.left,this.top,this.right,this.bottom)}getWidth(){return Math.abs(this.right-this.left)}getHeight(){return Math.abs(this.bottom-this.top)}getSquare(){return this.getHeight()*this.getWidth()}getDiagonal(){var t=this.getWidth(),e=this.getHeight();return Math.sqrt(e*e+t*t)}fit(t,e){return this.getWidth()==t&&this.getHeight()==e}isInside(t,e){return t>=this.left&&t<=this.right&&e>=this.top&&e<=this.bottom}}class Qr{constructor(t){this._size=t||2048,this._array=new Array(this._size),this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}reset(){this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}clear(){this._array.length=0,this._array=new Array(this._size),this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}push(t){this.length++,this._array[this._popIndex++]=t}pop(){if(this.length){this.length--;var t=this._array[--this._popIndex];return this._array[this._popIndex]=null,this._array[this._popIndex-1]||(this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex),t}}unshift(t){this.length++,this._array[--this._shiftIndex]=t}shift(){if(this.length){this.length--;var t=this._array[this._shiftIndex];return this._array[this._shiftIndex++]=null,this._array[this._shiftIndex]||(this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex),t}}each(t){for(var e=this._shiftIndex;e<this._popIndex;e++)t(this._array[e])}}class Jr{constructor(){this.imagesCache={},this._counter=0,this._pendingsQueue=new Qr,this._imageIndexCounter=0}load(t,e){if(this.imagesCache[t])e(this.imagesCache[t]);else{var i={src:t,success:e};this._counter>=1?this._pendingsQueue.push(i):this._exec(i)}}_exec(t){this._counter++;var e=this,i=new Image;i.crossOrigin="",i.onload=function(){e.imagesCache[t.src]=i,this.__nodeIndex=e._imageIndexCounter++,t.success(this),e._dequeueRequest()},i.onerror=function(){e._dequeueRequest()},i.src=t.src}_dequeueRequest(){if(this._counter--,this._pendingsQueue.length&&this._counter<1)for(;this._pendingsQueue.length;){var t=this._pendingsQueue.pop();if(t){if(!this.imagesCache[t.src]){this._exec(t);break}this._counter<=0?this._counter=0:this._counter--,t.success(this.imagesCache[t.src])}}}}class $r{constructor(t,e){this.nodes=[],this.texture=null,this.canvas=new Nr(t||1024,e||1024),this.clearCanvas(),this._handler=null,this._images=[],this._btree=null,this._imagesCacheManager=new Jr,this.borderSize=4}getImage(){return this.canvas.getImage()}getCanvas(){return this.canvas._canvas}clearCanvas(){this.canvas.fillEmpty("black")}assignHandler(t){this._handler=t,this.createTexture()}getDiagonal(t){var e=t.atlasWidth||t.width,i=t.atlasHeight||t.height;return Math.sqrt(e*e+i*i)}addImage(t,e){if(t.width&&t.height)return this._images.push(t),this._makeAtlas(e),this.nodes[t.__nodeIndex]}_completeNode(t,e){if(e){var i=this.canvas.getWidth(),r=this.canvas.getHeight(),n=e.image,s=e.rect,o=Math.round(.5*this.borderSize);this.canvas.drawImage(n,s.left+o,s.top+o,n.atlasWidth,n.atlasHeight);var a=e.texCoords;a[0]=(s.left+o)/i,a[1]=(s.top+o)/r,a[2]=(s.left+o)/i,a[3]=(s.bottom-o)/r,a[4]=(s.right-o)/i,a[5]=(s.bottom-o)/r,a[6]=(s.right-o)/i,a[7]=(s.bottom-o)/r,a[8]=(s.right-o)/i,a[9]=(s.top+o)/r,a[10]=(s.left+o)/i,a[11]=(s.top+o)/r,t[n.__nodeIndex]=e}}_makeAtlas(t){if(t&&this._btree){let t=this._images[this._images.length-1];this._completeNode(this.nodes,this._btree.insert(t))}else{let t=this._images.slice(0);t.sort(function(t,e){return(e.atlasWidth||e.width)-(t.atlasWidth||t.width)||(e.atlasHeight||e.height)-(t.atlasHeight||t.height)}),this._btree=new tn(new Zr(0,0,this.canvas.getWidth(),this.canvas.getHeight())),this._btree.atlas=this,this.clearCanvas();for(var e=[],i=0;i<t.length;i++)this._completeNode(e,this._btree.insert(t[i]));this.nodes=[],this.nodes=e}}createTexture(){this._handler&&(this._handler.gl.deleteTexture(this.texture),this.texture=this._handler.createTexture_n(this.canvas._canvas))}loadImage(t,e){this._imagesCacheManager.load(t,e)}getImageTexCoordinates(t){if(null!=t.__nodeIndex&&this.nodes[t.__nodeIndex])return this.nodes[t.__nodeIndex].texCoords}}class tn{constructor(t){this.childNodes=null,this.image=null,this.rect=t,this.texCoords=[],this.atlas=null}insert(t){if(this.childNodes){var e=this.childNodes[0].insert(t);return null!=e?e:this.childNodes[1].insert(t)}if(null!=this.image)return null;var i=this.rect,r=(t.atlasWidth||t.width)+this.atlas.borderSize,n=(t.atlasHeight||t.height)+this.atlas.borderSize;return r>i.getWidth()||n>i.getHeight()?null:i.fit(r,n)?(this.image=t,this):(this.childNodes=new Array(2),this.childNodes[0]=new tn,this.childNodes[0].atlas=this.atlas,this.childNodes[1]=new tn,this.childNodes[1].atlas=this.atlas,i.getWidth()-r>i.getHeight()-n?(this.childNodes[0].rect=new Zr(i.left,i.top,i.left+r,i.bottom),this.childNodes[1].rect=new Zr(i.left+r,i.top,i.right,i.bottom)):(this.childNodes[0].rect=new Zr(i.left,i.top,i.right,i.top+n),this.childNodes[1].rect=new Zr(i.left,i.top+n,i.right,i.bottom)),this.childNodes[0].insert(t))}}class en{constructor(){var t=["monospace","sans-serif","serif"],e=document.getElementsByTagName("body")[0],i=document.createElement("span");i.style.fontSize="72px",i.innerHTML="mmmmmmmmmmlli";var r={},n={};for(var s in t)i.style.fontFamily=t[s],e.appendChild(i),r[t[s]]=i.offsetWidth,n[t[s]]=i.offsetHeight,e.removeChild(i);this.detect=function(s){var o=!1;for(var a in t){i.style.fontFamily=s+","+t[a],e.appendChild(i);var h=i.offsetWidth!=r[t[a]]||i.offsetHeight!=n[t[a]];e.removeChild(i),o=o||h}return o}}}class rn{constructor(t,e){this._handler=null,this._framebuffer0=null,this._framebuffer1=null,this._framebuffer2=null,this._vertexBuffer=null,this._width=t||512,this._height=e||512;var i=Math.max(this._width,this._height);this._outsideDistance=Math.round(80*i/512),this._insideDistance=Math.round(10*i/512),this._outsideMix=.71,this._insideMix=.679,this._sourceTexture=null,this.initialize()}initialize(){this._initHandler(this._width,this._height),this._initShaders()}_initHandler(t,e){this._handler=new Wr(null,{width:t,height:e,context:{alpha:!0,depth:!1}}),this._handler.initialize(),this._handler.deactivateFaceCulling(),this._handler.deactivateDepthTest(),this._vertexBuffer=this._handler.createArrayBuffer(new Float32Array([-1,-1,-1,1,1,-1,1,1]),2,4),this._framebuffer0=new kr(this._handler,{useDepth:!1}),this._framebuffer1=new kr(this._handler,{useDepth:!1}),this._framebuffer2=new kr(this._handler,{useDepth:!1}),this._framebuffer0.init(),this._framebuffer1.init(),this._framebuffer2.init()}_initShaders(){var t=new ji("vfield",{uniforms:{uTexSize:{type:Vi.VEC2},uTex1:{type:Vi.SAMPLER2D},uDistance:{type:Vi.INT},uNeg:{type:Vi.VEC2}},attributes:{aPos:{type:Vi.VEC2,enableArray:!0}},vertexShader:"precision highp float;            attribute vec2 aPos;            uniform vec2 uTexSize;            varying vec2 TexCoord;            varying vec2 vTexSize;            void main() {                TexCoord = (aPos + 1.0) * 0.5;                TexCoord *= uTexSize;                vTexSize = uTexSize;                gl_Position.xy = aPos;                gl_Position.zw = vec2(0.0, 1.0);            }",fragmentShader:"precision highp float;            uniform sampler2D uTex1;            uniform int uDistance;            uniform vec2 uNeg;            varying vec2 TexCoord;            varying vec2 vTexSize;            const int maxDistance = "+this._outsideDistance+";            void main() {                if ( uNeg.x - uNeg.y * texture2D(uTex1, TexCoord / vTexSize).r > 0.5 ) {                    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);                    return;                }                for ( int i=1; i <= maxDistance; i++ ) {                    if(i > uDistance) break;                    if ( uNeg.x - uNeg.y * texture2D(uTex1, ( TexCoord + vec2(0.0, i) ) / vTexSize ).r > 0.5 ) {                        gl_FragColor = vec4( vec3(float(i)/float(uDistance)), 1.0 );                        return;                    }                    if ( uNeg.x - uNeg.y * texture2D(uTex1, ( TexCoord - vec2(0.0, i)) / vTexSize ).r > 0.5 ) {                        gl_FragColor = vec4(vec3(float(i)/float(uDistance)), 1.0);                        return;                    }                }                gl_FragColor = vec4(1.0);            }"}),e=new ji("hfield",{uniforms:{uTexSize:{type:Vi.VEC2},uTex1:{type:Vi.SAMPLER2D},uDistance:{type:Vi.INT}},attributes:{aPos:{type:Vi.VEC2,enableArray:!0}},vertexShader:"precision highp float;            attribute vec2 aPos;            uniform vec2 uTexSize;            varying vec2 TexCoord;            varying vec2 vTexSize;            void main() {\n                TexCoord = (aPos + 1.0) * 0.5;                TexCoord *= uTexSize;                vTexSize = uTexSize;                gl_Position.xy = aPos;                gl_Position.zw = vec2(0.0, 1.0);            }",fragmentShader:"precision highp float;            uniform sampler2D uTex1;            uniform int uDistance;            varying vec2 TexCoord;            varying vec2 vTexSize;            const int maxDistance = "+this._outsideDistance+";            float CalcC(float H, float V) {                return ( sqrt( H * H + V * V ) );            }            void main(){                float dist = CalcC( 0.0, texture2D( uTex1, TexCoord / vTexSize ).r );                for ( int i = 1; i <= maxDistance; i++ ) {                    if(i > uDistance) break;                    float H = float(i) / float(uDistance);                    dist = min( dist, CalcC( H, texture2D( uTex1, ( TexCoord + vec2( float(i), 0.0) ) / vTexSize ).r ) );                    dist = min( dist, CalcC( H, texture2D( uTex1, ( TexCoord - vec2( float(i), 0.0) ) / vTexSize ).r ) );                }                gl_FragColor = vec4(dist);                gl_FragColor.w = 1.0;            }"}),i=new ji("sum",{uniforms:{outside:{type:Vi.SAMPLER2D},inside:{type:Vi.SAMPLER2D},source:{type:Vi.SAMPLER2D}},attributes:{aPos:{type:Vi.VEC2,enableArray:!0}},vertexShader:"attribute vec2 aPos;\n                        varying vec2 TexCoord;\n                        void main(){\n                            TexCoord = (aPos * vec2(1.0,-1.0) + 1.0) * 0.5;\n                            gl_Position.xy = aPos;\n                            gl_Position.zw = vec2(0.0, 1.0);\n                        }",fragmentShader:"precision highp float;\n                        uniform sampler2D outside;\n                        uniform sampler2D inside;\n                        uniform sampler2D source;\n                        varying vec2 TexCoord;\n                        void main(){\n                            float o = texture2D(outside, TexCoord).r;\n                            float i = 1.0 - texture2D(inside, TexCoord).r;\n                            float s = texture2D(source, TexCoord).r;\n                            gl_FragColor = vec4( vec3(1.0 - mix(i, o, step(0.5, s) * "+this._outsideMix+" + (1.0 - step(0.5, s)) * "+this._insideMix+" )), 1.0);\n                        }"});this._handler.addPrograms([t,e,i])}setSize(t,e){t===this._width&&e===this._height||(this._width=t,this._height=e,this._handler.setSize(t,e),this._framebuffer0.setSize(t,e),this._framebuffer1.setSize(t,e))}createSDF(t,e,i){var r=this._handler,n=r.gl;r.setSize(this._width,this._height),n.deleteTexture(this._sourceTexture),this._sourceTexture=r.createTexture_l(t),r.programs.vfield.activate();var s=(a=r.programs.vfield._program).attributes,o=a.uniforms;n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._sourceTexture),n.uniform1i(o.uTex1,0),n.uniform2fv(o.uTexSize,[this._width,this._height]),n.bindBuffer(n.ARRAY_BUFFER,this._vertexBuffer),n.vertexAttribPointer(s.aPos,this._vertexBuffer.itemSize,n.FLOAT,!1,0,0),this._framebuffer0.activate(),n.uniform1i(o.uDistance,this._outsideDistance),n.uniform2fv(o.uNeg,[0,-1]),n.drawArrays(n.TRIANGLE_STRIP,0,4),this._framebuffer0.deactivate(),this._framebuffer2.activate(),n.uniform2fv(o.uNeg,[1,1]),n.uniform1i(o.uDistance,this._insideDistance),n.drawArrays(n.TRIANGLE_STRIP,0,4),this._framebuffer2.deactivate(),r.programs.hfield.activate();s=(a=r.programs.hfield._program).attributes,o=a.uniforms;n.uniform2fv(o.uTexSize,[this._width,this._height]),n.bindBuffer(n.ARRAY_BUFFER,this._vertexBuffer),n.vertexAttribPointer(s.aPos,this._vertexBuffer.itemSize,n.FLOAT,!1,0,0),this._framebuffer1.activate(),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._framebuffer0.textures[0]),n.uniform1i(o.uTex1,0),n.uniform1i(o.uDistance,this._outsideDistance),n.drawArrays(n.TRIANGLE_STRIP,0,4),this._framebuffer1.deactivate(),this._framebuffer0.activate(),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._framebuffer2.textures[0]),n.uniform1i(o.uTex1,0),n.uniform1i(o.uDistance,this._insideDistance),n.drawArrays(n.TRIANGLE_STRIP,0,4),this._framebuffer0.deactivate(),r.setSize(e||this._width,i||this._height),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),r.programs.sum.activate();var a;s=(a=r.programs.sum._program).attributes,o=a.uniforms;return n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._framebuffer1.textures[0]),n.uniform1i(o.outside,0),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,this._framebuffer0.textures[0]),n.uniform1i(o.inside,1),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,this._sourceTexture),n.uniform1i(o.source,2),n.bindBuffer(n.ARRAY_BUFFER,this._vertexBuffer),n.vertexAttribPointer(s.aPos,this._vertexBuffer.itemSize,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLE_STRIP,0,4),r.canvas}}const nn=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","а","б","в","г","д","е","ё","ж","з","и","к","л","м","н","о","п","р","с","т","у","ф","х","ц","ч","ш","щ","ь","э","ъ","ю","я","й","А","Б","В","Г","Д","Е","Ё","Ж","З","И","К","Л","М","Н","О","П","Р","С","Т","У","Ф","Х","Ц","Ч","Ш","Щ","Ь","Э","Ъ","Ю","Я","Й","1","2","3","4","5","6","7","8","9","0","`","!","@","#","$","%","^","&","*","(",")","_","+","-","=","[","]","{","}","\\","|",";",":",'"',",",".","/","<",">","?"," ","    ","'","Á","á","Ć","ć","É","é","Í","í","Ĺ","ĺ","Ń","ń","Ó","ó","Ŕ","ŕ","Ś","ś","Ú","ú","Ý","ý","Ź","ź","ď","Ľ","ľ","ť","Ă","ă","Ğ","ğ","Ŭ","ŭ","Č","č","Ď","Ě","ě","Ň","ň","Ř","ř","Š","š","Ť","Ž","ž","Ç","ç","Ģ","ģ","Ķ","ķ","Ļ","ļ","Ņ","ņ","Ŗ","ŗ","Ş","ş","Ţ","ţ","Â","â","Ĉ","ĉ","Ê","ê","Ĝ","ĝ","Ĥ","ĥ","Î","î","Ĵ","ĵ","Ô","ô","Ŝ","ŝ","Û","û","Ŵ","ŵ","Ŷ","ŷ","Ä","ä","Ë","ë","Ï","ï","Ö","ö","Ü","ü","Ÿ","ÿ","Ċ","ċ","Ė","ė","Ġ","ġ","İ","ı","Ż","ż","Ő","ő","Ű","ű","À","à","È","è","Ì","ì","Ò","ò","Ù","ù","Ơ","ơ","Ư","ư","Ā","ā","Ē","ē","Ī","ī","Ō","ō","Ū","ū","Ą","ą","Ę","ę","Į","į","Ų","ų","Å","å","Ů","ů","Đ","đ","Ħ","ħ","Ł","ł","Ø","ø","Ã","ã","Ñ","ñ","Õ","õ","Æ","æ","Œ","œ","Ð","ð","Þ","þ","ß","ſ","Α","Β","Γ","Δ","Ε","Ζ","Η","Θ","Ι","Κ","Λ","Μ","Ν","Ξ","Ο","Π","Ρ","Σ","Τ","Υ","Φ","Χ","Ψ","Ω","Ά","Έ","Ή","Ί","Ό","Ύ","Ώ","Ϊ","Ϋ","α","β","γ","δ","ε","ζ","η","θ","ι","κ","λ","μ","ν","ξ","ο","π","ρ","σ","ς","τ","υ","φ","χ","ψ","ω","ά","έ","ή","ί","ό","ύ","ώ","ϊ","ϋ","ΐ","ΰ","’","‘","ḩ","Ḩ","ţ","Ţ","bٍ","°","´"];window.SCREEN=0;const sn=function(t,e){if(e=e||{},this.div=null,this.handler=t,this.exposure=2.7,this.gamma=.43,this.whitepoint=1,this.brightThreshold=.9,this._renderNodesArr=[],this.renderNodes={},this.cameras=[],this.activeCamera=null,this.events=new class extends rr{constructor(t){super(Kr),this.renderer=t,this._touchHandler=new qr(t.handler.canvas),this._mouseHandler=new Gr(t.handler.canvas),this._keyboardHandler=new jr,this._active=!0,this.mouseState={x:0,y:0,nx:0,ny:0,prev_x:0,prev_y:0,direction:new Xt,leftButtonUp:!1,rightButtonUp:!1,middleButtonUp:!1,leftButtonDown:!1,rightButtonDown:!1,middleButtonDown:!1,leftButtonHold:!1,rightButtonHold:!1,middleButtonHold:!1,leftButtonDoubleClick:!1,rightButtonDoubleClick:!1,middleButtonDoubleClick:!1,leftButtonClick:!1,rightButtonClick:!1,middleButtonClick:!1,moving:!1,justStopped:!1,doubleClickDelay:300,clickDelay:150,wheelDelta:0,sys:null,pickingObject:null,renderer:t},this.touchState={moving:!1,touchEnd:!1,touchStart:!1,touchCancel:!1,doubleTouch:!1,doubleTouchDelay:550,doubleTouchRadius:10,x:0,y:0,nx:0,ny:0,prev_x:0,prev_y:0,sys:null,pickingObject:null,renderer:t},this._dblTchCoords=new Yt,this._oneTouchStart=!1,this._dblTchBegins=0,this._mousestopThread=null,this._ldblClkBegins=0,this._rdblClkBegins=0,this._mdblClkBegins=0,this._lClkBegins=0,this._rClkBegins=0,this._mClkBegins=0,this._lclickX=0,this._lclickY=0,this._rclickX=0,this._rclickY=0,this._mclickX=0,this._mclickY=0}get active(){return this._active}set active(t){this._active=t,this._keyboardHandler.setActivity(t)}handleEvents(){this._active&&(this.mouseState.direction=this.renderer.activeCamera.unproject(this.mouseState.x,this.mouseState.y),this.entityPickingEvents(),this._keyboardHandler.handleEvents(),this.handleMouseEvents(),this.handleTouchEvents())}on(t,e,i,r,n){"keypress"===t||"charkeypress"===t||"keyfree"===t?this._keyboardHandler.addEvent(t,r,i,e,n):super.on(t,e,i,r)}off(t,e){"keypress"===t||"charkeypress"===t||"keyfree"===t?this._keyboardHandler.removeEvent(t,e):super.off(t,e)}isKeyPressed(t){return this._keyboardHandler.isKeyPressed(t)}isKeyPressed(t){return this._keyboardHandler.isKeyPressed(t)}initialize(){this._mouseHandler.setEvent("mouseup",this,this.onMouseUp),this._mouseHandler.setEvent("mousemove",this,this.onMouseMove),this._mouseHandler.setEvent("mousedown",this,this.onMouseDown),this._mouseHandler.setEvent("mousewheel",this,this.onMouseWheel),this._touchHandler.setEvent("touchstart",this,this.onTouchStart),this._touchHandler.setEvent("touchend",this,this.onTouchEnd),this._touchHandler.setEvent("touchcancel",this,this.onTouchCancel),this._touchHandler.setEvent("touchmove",this,this.onTouchMove)}onMouseWheel(t){this.mouseState.wheelDelta=t.wheelDelta}onMouseMove(t){var e=this.mouseState;if(e.sys=t,e.x!==t.clientX||e.y!==t.clientY){this._ldblClkBegins=0,this._rdblClkBegins=0,this._mdblClkBegins=0,this._lClkBegins=0,this._rClkBegins=0,this._mClkBegins=0,e.x=t.clientX,e.y=t.clientY;var i=this.renderer.handler.canvas;e.nx=e.x/i.width,e.ny=e.y/i.height,e.moving=!0,clearTimeout(this._mousestopThread),this._mousestopThread=setTimeout(function(){e.justStopped=!0},100)}}onMouseDown(t){t.button===ci.MB_LEFT?(this._lClkBegins=(new Date).getTime(),this._lclickX=t.clientX,this._lclickY=t.clientY,this.mouseState.sys=t,this.mouseState.leftButtonDown=!0):t.button===ci.MB_RIGHT?(this._rClkBegins=(new Date).getTime(),this._rclickX=t.clientX,this._rclickY=t.clientY,this.mouseState.sys=t,this.mouseState.rightButtonDown=!0):t.button===ci.MB_MIDDLE&&(this._mClkBegins=(new Date).getTime(),this._mclickX=t.clientX,this._mclickY=t.clientY,this.mouseState.sys=t,this.mouseState.middleButtonDown=!0)}onMouseUp(t){var e=this.mouseState;e.sys=t;var i=(new Date).getTime();t.button===ci.MB_LEFT?(e.leftButtonDown=!1,e.leftButtonUp=!0,this._lclickX===t.clientX&&this._lclickY===t.clientY&&i-this._lClkBegins<=e.clickDelay&&(this._ldblClkBegins?((new Date).getTime()-this._ldblClkBegins<=e.doubleClickDelay&&(e.leftButtonDoubleClick=!0),this._ldblClkBegins=0):this._ldblClkBegins=(new Date).getTime(),e.leftButtonClick=!0,this._lClkBegins=0)):t.button===ci.MB_RIGHT?(e.rightButtonDown=!1,e.rightButtonUp=!0,this._rclickX===t.clientX&&this._rclickY===t.clientY&&i-this._rClkBegins<=e.clickDelay&&(this._rdblClkBegins?((new Date).getTime()-this._rdblClkBegins<=e.doubleClickDelay&&(e.rightButtonDoubleClick=!0),this._rdblClkBegins=0):this._rdblClkBegins=(new Date).getTime(),e.rightButtonClick=!0,this._rClkBegins=0)):t.button===ci.MB_MIDDLE&&(e.middleButtonDown=!1,e.middleButtonUp=!0,this._mclickX===t.clientX&&this._mclickY===t.clientY&&i-this._mClkBegins<=e.clickDelay)&&(this._mdblClkBegins?((new Date).getTime()-this._mdblClkBegins<=e.doubleClickDelay&&(e.middleButtonDoubleClick=!0),this._mdblClkBegins=0):this._mdblClkBegins=(new Date).getTime(),e.middleButtonClick=!0,this._mClkBegins=0)}onTouchStart(t){var e=this.touchState;e.sys=t,e.x=t.touches.item(0).clientX-t.offsetLeft,e.y=t.touches.item(0).clientY-t.offsetTop;var i=this.renderer.handler.canvas;e.nx=e.x/i.width,e.ny=e.y/i.height,e.prev_x=e.x,e.prev_y=e.y,e.touchStart=!0,1===t.touches.length?(this._dblTchCoords.x=e.x,this._dblTchCoords.y=e.y,this._oneTouchStart=!0):this._oneTouchStart=!1}onTouchEnd(t){var e=this.touchState;e.sys=t,e.touchEnd=!0,0===t.touches.length&&(e.prev_x=e.x,e.prev_y=e.y,this._oneTouchStart)&&(this._dblTchBegins&&((new Date).getTime()-this._dblTchBegins<=e.doubleTouchDelay&&(e.doubleTouch=!0),this._dblTchBegins=0),this._dblTchBegins=(new Date).getTime(),this._oneTouchStart=!1)}onTouchCancel(t){var e=this.touchState;e.sys=t,e.touchCancel=!0}onTouchMove(t){var e=this.touchState;e.x=t.touches.item(0).clientX-t.offsetLeft,e.y=t.touches.item(0).clientY-t.offsetTop;var i=this.renderer.handler.canvas;e.nx=e.x/i.width,e.ny=e.y/i.height,e.sys=t,e.moving=!0,this._dblTchBegins=0,this._oneTouchStart=!1}entityPickingEvents(){var t=this.touchState,e=this.mouseState;if(!(e.leftButtonHold||e.rightButtonHold||e.middleButtonHold)){var i=this.renderer,r=i.colorObjects,n=i._currPickingColor,s=i._prevPickingColor;e.pickingObject=null,t.pickingObject=null;var o=r&&r[n[0]+"_"+n[1]+"_"+n[2]];if(e.pickingObject=o,t.pickingObject=o,n[0]!=s[0]||n[1]!=s[1]||n[2]!=s[2])if(n[0]||n[1]||n[2]){if(s[0]||s[1]||s[2]){let i=r[s[0]+"_"+s[1]+"_"+s[2]];if(i){let r=i.events||i._entityCollection&&i._entityCollection.events||i._layer&&i._layer.events;e.pickingObject=i,r&&r.dispatch(r.mouseleave,e),t.pickingObject=i,r&&r.dispatch(r.touchleave,t)}}if(o){var a=o.events||o._entityCollection&&o._entityCollection.events||o._layer&&o._layer.events;e.pickingObject=o,a&&a.dispatch(a.mouseenter,e),t.pickingObject=o,a&&a.dispatch(a.touchenter,t)}}else{let i=r[s[0]+"_"+s[1]+"_"+s[2]];if(i){let r=i.events||i._entityCollection&&i._entityCollection.events||i._layer&&i._layer.events;e.pickingObject=i,r&&r.dispatch(r.mouseleave,e),t.pickingObject=i,r&&r.dispatch(r.touchleave,t)}}}}handleMouseEvents(){let t=this.mouseState,e=t.pickingObject,i=null;t.leftButtonClick&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.lclick,t),this.dispatch(this.lclick,t),t.leftButtonClick=!1),t.rightButtonClick&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.rclick,t),this.dispatch(this.rclick,t),t.rightButtonClick=!1),t.middleButtonClick&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.mclick,t),this.dispatch(this.mclick,t),t.middleButtonClick=!1),t.leftButtonDown&&(t.leftButtonHold?(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.lhold,t),this.dispatch(this.lhold,t)):(t.leftButtonHold=!0,e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.ldown,t),this.dispatch(this.ldown,t))),t.rightButtonDown&&(t.rightButtonHold?(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.rhold,t),this.dispatch(this.rhold,t)):(t.rightButtonHold=!0,e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.rdown,t),this.dispatch(this.rdown,t))),t.middleButtonDown&&(t.middleButtonHold?(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.mhold,t),this.dispatch(this.mhold,t)):(t.middleButtonHold=!0,e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.mdown,t),this.dispatch(this.mdown,t))),t.leftButtonUp&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.lup,t),this.dispatch(this.lup,t),t.leftButtonUp=!1,t.leftButtonHold=!1),t.rightButtonUp&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.rup,t),this.dispatch(this.rup,t),t.rightButtonUp=!1,t.rightButtonHold=!1),t.middleButtonUp&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.mup,t),this.dispatch(this.mup,t),t.middleButtonUp=!1,t.middleButtonHold=!1),t.leftButtonDoubleClick&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.ldblclick,t),this.dispatch(this.ldblclick,t),t.leftButtonDoubleClick=!1),t.rightButtonDoubleClick&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.rdblclick,t),this.dispatch(this.rdblclick,t),t.rightButtonDoubleClick=!1),t.middleButtonDoubleClick&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.mdblclick,t),this.dispatch(this.mdblclick,t),t.middleButtonDoubleClick=!1),t.wheelDelta&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.mousewheel,t),this.dispatch(this.mousewheel,t),t.wheelDelta=0),t.moving&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.mousemove,t),this.dispatch(this.mousemove,t),t.prev_x=t.x,t.prev_y=t.y),t.justStopped&&(this.dispatch(this.mousestop,t),t.justStopped=!1)}handleTouchEvents(){var t=this.touchState,e=t.pickingObject,i=null;if(t.touchCancel&&(this.dispatch(this.touchcancel,t),t.touchCancel=!1),t.touchStart){var r=this.renderer;r.pickingFramebuffer.readPixels(r._currPickingColor,t.nx,1-t.ny,1);var n=r.colorObjects,s=r._currPickingColor,o=n[s[0]+"_"+s[1]+"_"+s[2]];(e=t.pickingObject=o)&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.touchstart,t),this.dispatch(this.touchstart,t),t.touchStart=!1}t.doubleTouch&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.doubletouch,t),this.dispatch(this.doubletouch,t),t.doubleTouch=!1),t.touchEnd&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.touchend,t),this.dispatch(this.touchend,t),t.x=0,t.y=0,t.touchEnd=!1),t.moving&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.touchmove,t),this.dispatch(this.touchmove,t),t.prev_x=t.x,t.prev_y=t.y)}}(this),this.controls={},e.controls)for(let t in e.controls)this.controls[e.controls[t].name]=e.controls[t];this.controlsBag={},this.colorObjects={},this._pickingCallbacks=[],this.pickingFramebuffer=null,this._msaa=e.msaa||8,this._internalFormat="RGBA16F",this._format="RGBA",this._type="FLOAT",this._screenScale=e.screenScale||1,this.sceneFramebuffer=null,this.blitFramebuffer=null,this.bloomFramebuffer=null,this._currPickingColor=new Uint8Array(4),this._prevPickingColor=[0,0,0],this._tempPickingColor_=new Uint8Array(4),this._initialized=!1,this.billboardsTextureAtlas=new $r,this.fontAtlas=new class{constructor(){this.atlasesArr=[],this.atlasIndexes={},this.tokenImageSize=64,this.samplerArr=[0],this._handler=null,this.defaultFace="arial",this._counter=0,this._pendingsQueue=new Qr,this.fontDetector=new en,this._sdfCreator=new rn(256,256)}assignHandler(t){this._handler=t}getFontIndex(t,e,i){return this.atlasIndexes[this.getFullIndex(t,e,i)]}getFullIndex(t,e,i){return(!(t=t&&t.trim().toLowerCase())||t&&!this.fontDetector.detect(t))&&(t=this.defaultFace),t+" "+(e&&e.toLowerCase()||"normal")+" "+(i&&i.toLowerCase()||"normal")}createFont(t,e,i){var r=this.getFontIndex(t,e,i);if(void 0==r){var n=this.tokenImageSize,s=this.getFullIndex(t,e,i);r=this.atlasIndexes[s]=this.atlasesArr.length;var o=new $r(2048,2048);o.assignHandler(this._handler),o.borderSize=6,this.samplerArr[this.atlasesArr.length]=this.atlasesArr.length,this.atlasesArr.push(o),o.canvas.fillColor("black");for(var a=nn,h=new Nr(512,512),l=this._sdfCreator,u=Math.round(337.92),c=(e||"normal")+" "+(i||"normal")+" "+u+"px "+(t||this.defaultFace),_=0;_<a.length;_++){var f=a[_];h.fillColor("black"),h.drawText(f,49,u,c,"white");var d=l.createSDF(h._canvas,n,n);d.__nodeIndex=f;var p=o.addImage(d,!0),v=h.getTextWidth(f);p.emptySize=v/512}o.createTexture(),h.destroy(),h=null}return r}createFontAsync(t,e,i,r){var n={face:t,style:e,weight:i,callback:r};this._counter>=1?this._pendingsQueue.push(n):this._exec(n)}_exec(t){this._counter++;var e=this;setTimeout(function(){var i=e.createFont(t.face,t.style,t.weight);t.callback(i),e._dequeueRequest()},0)}_dequeueRequest(){var t;this._counter--,this._pendingsQueue.length&&this._counter<1&&(t=this._whilePendings())&&this._exec(t)}_whilePendings(){for(;this._pendingsQueue.length;){var t=this._pendingsQueue.pop(),e=this.getFontIndex(t.face,t.style,t.weight);if(void 0==e)return t;t.callback(e)}}},this._entityCollections=[],(e.autoActivate||Gt(e.autoActivate))&&(this.initialize(),this.start())};sn.__pickingCallbackCounter__=0,sn.prototype.setEventsActivity=function(t){this.events.active=t},sn.prototype.addPickingCallback=function(t,e){var i=sn.__pickingCallbackCounter__++;return this._pickingCallbacks.push({id:i,callback:e,sender:t}),i},sn.prototype.setScreenScale=function(t){this._screenScale=t,this._resize()},sn.prototype.removePickingCallback=function(t){for(var e=0;e<this._pickingCallbacks.length;e++)if(t===this._pickingCallbacks[e].id){this._pickingCallbacks.splice(e,1);break}},sn.prototype.getPickingObjectByColor=function(t,e,i){return this.colorObjects[t+"_"+e+"_"+i]},sn.prototype.assignPickingColor=function(t){if(!t._pickingColor||t._pickingColor.isZero()){for(var e=0,i=0,r=0,n="0_0_0";!(e||i||r)||this.colorObjects[n];)n=(e=ot(1,255))+"_"+(i=ot(1,255))+"_"+(r=ot(1,255));t._pickingColor?t._pickingColor.set(e,i,r):t._pickingColor=new Xt(e,i,r),t._pickingColorU=new Float32Array([e/255,i/255,r/255]),this.colorObjects[n]=t}},sn.prototype.clearPickingColor=function(t){if(!t._pickingColor.isZero()){var e=t._pickingColor;e.isZero()||(this.colorObjects[e.x+"_"+e.y+"_"+e.z]=null,delete this.colorObjects[e.x+"_"+e.y+"_"+e.z],e.x=e.y=e.z=0)}},sn.prototype.getWidth=function(){return this.handler.canvas.width},sn.prototype.getHeight=function(){return this.handler.canvas.height},sn.prototype.getCenter=function(){var t=this.handler.canvas;return new Yt(Math.round(.5*t.width),Math.round(.5*t.height))},sn.prototype.addControl=function(t){t.addTo(this)},sn.prototype.addControls=function(t){for(var e=0;e<t.length;e++)t[e].addTo(this)},sn.prototype.removeControl=function(t){t.remove()},sn.prototype.initialize=function(){if(this._initialized)return;this._initialized=!0;var t=this;if(this.billboardsTextureAtlas.assignHandler(this.handler),this.fontAtlas.assignHandler(this.handler),this.handler.setFrameCallback(function(){t.draw()}),this.activeCamera=new zr(this,{eye:new Xt(0,0,0),look:new Xt(0,0,-1),up:new Xt(0,1,0)}),this.events.initialize(),this.events.on("charkeypress",ci.KEY_APOSTROPHE,function(){Yi.setVisibility(!Yi.getVisibility())}),this.handler.addProgram(new ji("screenFrame",{uniforms:{texture:"sampler2d"},attributes:{corners:"vec3"},vertexShader:"attribute vec2 corners;\n            \n            varying vec2 tc;\n            void main(void) {\n                gl_Position = vec4(corners, 0.0, 1.0);\n                tc = corners * 0.5 + 0.5;\n            }",fragmentShader:"precision highp float;\n            uniform sampler2D texture;\n            \n            varying vec2 tc;\n            \n            void main(void) {\n                gl_FragColor = texture2D( texture, tc );\n            }"})),this.pickingFramebuffer=new kr(this.handler,{width:640,height:480}).init(),this.readPixels=(()=>{}),"webgl"===this.handler.gl.type)this.sceneFramebuffer=new kr(this.handler),this.sceneFramebuffer.init(),this._fnScreenFrame=this._screenFrameNoMSAA;else{let t=this.getMaxMSAA(this._internalFormat);this._msaa>t&&(this._msaa=t),this.handler.addPrograms([new ji("toneMapping",{uniforms:{hdrBuffer:"sampler2d",exposure:"float",gamma:"float",whitepoint:"float"},attributes:{corners:"vec3"},vertexShader:"#version 300 es\n            \n            in vec2 corners;\n            \n            out vec2 tc;\n\n            void main(void) {\n                gl_Position = vec4(corners, 0.0, 1.0);\n                tc = corners * 0.5 + 0.5;\n            }",fragmentShader:"#version 300 es\n\n            precision highp float;\n\n            #ifndef saturate\n                #define saturate(a) clamp(a, 0.0, 1.0)\n            #endif\n\n            uniform sampler2D hdrBuffer;\n\n            uniform float whitepoint;\n            uniform float exposure;\n            uniform float gamma;\n\n            vec3 LinearToneMapping(vec3 color) {\n                return exposure * color;\n            }\n\n            vec3 ReinhardToneMapping2(vec3 color) {\n                return vec3(1.0) - exp(-color * exposure);;\n            }\n\n            vec3 ReinhardToneMapping(vec3 color) {\n                color *= exposure;\n                return saturate(color / (vec3(1.0) + color));\n            }\n\n            #define Uncharted2Helper(x) max(((x * (0.15 * x + 0.10 * 0.50) + 0.20 * 0.02) / (x * (0.15 * x + 0.50) + 0.20 * 0.30)) - 0.02 / 0.30, vec3(0.0))\n\n            vec3 Uncharted2ToneMapping(vec3 color) {\n                color *= exposure;\n                return saturate(Uncharted2Helper(color) / Uncharted2Helper(vec3(whitepoint)));\n            }\n\n            vec3 OptimizedCineonToneMapping(vec3 color) {\n                color *= exposure;\n                color = max(vec3(0.0), color - 0.004);\n                return pow((color * (6.2 * color + 0.5)) / (color * (6.2 * color + 1.7) + 0.06), vec3(2.2));\n            }\n\n            vec3 ACESFilmicToneMapping(vec3 color) {\n                color *= exposure;\n                return saturate((color * (2.51 * color + 0.03)) / (color * (2.43 * color + 0.59) + 0.14));\n            }\n\n            in vec2 tc;\n\n            layout(location = 0) out vec4 fragColor;\n            \n            void main(void) {\n                vec3 hdrColor = texture(hdrBuffer, tc).rgb;\n                \n                float oneByGamma = gamma / gamma;\n                float oneByWhitePoint = whitepoint / whitepoint;\n\n                vec3 mapped = ReinhardToneMapping2(hdrColor) * oneByGamma * oneByWhitePoint;\n\n                mapped = pow(mapped, vec3(1.0 / gamma));\n\n                fragColor = vec4(mapped, 1.0);\n            }"})]),this.sceneFramebuffer=new Yr(this.handler,{size:1,msaa:this._msaa,internalFormat:this._internalFormat,filter:"LINEAR"}).init(),this.blitFramebuffer=new kr(this.handler,{useDepth:!1,internalFormat:this._internalFormat,format:this._format,type:this._type,filter:"LINEAR"}).init(),this.bloomFramebuffer=new kr(this.handler,{useDepth:!1}).init(),this._fnScreenFrame=this._screenFrameMSAA}this.handler.onCanvasResize=(()=>{this._resize(),this.events.dispatch(this.events.resize,this.handler.canvas)}),this._screenFrameCornersBuffer=this.handler.createArrayBuffer(new Float32Array([1,1,-1,1,1,-1,-1,-1]),2,4);let e=this.controls;this.controls={};for(let t in e)this.addControl(e[t])},sn.prototype._resize=function(){let t=this.handler.canvas;this.activeCamera.setAspectRatio(t.clientWidth/t.clientHeight),this.sceneFramebuffer.setSize(t.clientWidth*this._screenScale,t.clientHeight*this._screenScale),this.blitFramebuffer&&this.blitFramebuffer.setSize(t.clientWidth*this._screenScale,t.clientHeight*this._screenScale,!0),this.bloomFramebuffer&&this.bloomFramebuffer.setSize(t.clientWidth,t.clientHeight,!0)},sn.prototype.removeNode=function(t){t.remove()},sn.prototype.addNode=function(t){this.renderNodes[t.name]?Yi.logWrn("Node name "+t.name+" allready exists."):(t.assign(this),this._renderNodesArr.unshift(t),this.renderNodes[t.name]=t)},sn.prototype.addNodes=function(t){for(var e=0;e<t.length;e++)this.addNode(t[e])},sn.prototype.getMaxMSAA=function(t){var e=this.handler.gl;return e.getInternalformatParameter(e.RENDERBUFFER,e[t],e.SAMPLES)[0]},sn.prototype.getMSAA=function(){return this._msaa},sn.prototype.enqueueEntityCollectionsToDraw=function(t){this._entityCollections.push.apply(this._entityCollections,t)},sn.prototype._drawEntityCollections=function(){let t=this._entityCollections;if(t.length){var e=this.handler.gl;e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE),e.disable(e.CULL_FACE),e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.billboardsTextureAtlas.texture);for(var i=t.length;i--;){(n=t[i])._fadingOpacity&&(n.events.dispatch(n.events.draw,n),n.billboardHandler.draw())}var r=this.fontAtlas.atlasesArr;for(i=0;i<r.length;i++)e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_2D,r[i].texture);for(i=t.length;i--;)t[i]._fadingOpacity&&t[i].labelHandler.draw();for(i=t.length;i--;)t[i]._fadingOpacity&&t[i].polylineHandler.draw();for(e.enable(e.CULL_FACE),i=t.length;i--;)t[i]._fadingOpacity&&t[i].pointCloudHandler.draw();for(i=t.length;i--;){var n;(n=t[i])._fadingOpacity&&n.shapeHandler.draw()}for(i=t.length;i--;)t[i]._fadingOpacity&&(t[i].stripHandler.draw(),n.events.dispatch(n.events.drawend,n));e.disable(e.POLYGON_OFFSET_FILL),this._entityCollections.length=0,this._entityCollections=[]}},sn.prototype.draw=function(){this.activeCamera.checkMoveEnd();var t=this.events;t.handleEvents();let e=this.sceneFramebuffer;e.activate();var i=this.handler;i.gl.clearColor(115/255,203/255,249/255,1),i.gl.clear(i.gl.COLOR_BUFFER_BIT|i.gl.DEPTH_BUFFER_BIT),t.dispatch(t.draw,this),i.gl.activeTexture(i.gl.TEXTURE0),i.gl.bindTexture(i.gl.TEXTURE_2D,i.transparentTexture);for(var r=this._renderNodesArr,n=r.length;n--;)r[n].drawNode();this._drawEntityCollections(),e.deactivate(),this.blitFramebuffer&&e.blit(this.blitFramebuffer),this._drawPickingBuffer(),this._fnScreenFrame(),t.mouseState.moving=!1,t.touchState.moving=!1},sn.prototype._screenFrameMSAA=function(){var t=this.handler,e=t.programs.toneMapping,i=e._program,r=t.gl;r.disable(r.DEPTH_TEST),r.bindBuffer(r.ARRAY_BUFFER,this._screenFrameCornersBuffer),r.vertexAttribPointer(i.attributes.corners,2,r.FLOAT,!1,0,0),this.bloomFramebuffer.activate(),e.activate(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.blitFramebuffer.textures[0]),r.uniform1i(i.uniforms.hdrBuffer,0),r.uniform1f(i.uniforms.gamma,this.gamma),r.uniform1f(i.uniforms.exposure,this.exposure),r.uniform1f(i.uniforms.whitepoint,this.whitepoint),r.drawArrays(r.TRIANGLE_STRIP,0,4),this.bloomFramebuffer.deactivate(),i=(e=t.programs.screenFrame)._program,r=t.gl,e.activate(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.bloomFramebuffer.textures[0]),r.uniform1i(i.uniforms.texture,0),r.drawArrays(r.TRIANGLE_STRIP,0,4),r.enable(r.DEPTH_TEST)},sn.prototype._screenFrameNoMSAA=function(){var t=this.handler,e=t.programs.screenFrame,i=e._program,r=t.gl;r.disable(r.DEPTH_TEST),e.activate(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.sceneFramebuffer.textures[window.SCREEN]),r.uniform1i(i.uniforms.texture,0),r.bindBuffer(r.ARRAY_BUFFER,this._screenFrameCornersBuffer),r.vertexAttribPointer(i.attributes.corners,2,r.FLOAT,!1,0,0),r.drawArrays(r.TRIANGLE_STRIP,0,4),r.enable(r.DEPTH_TEST)},sn.prototype.getPickingObject=function(t,e){let i=this.renderer.handler.canvas,r=new Uint8Array(3);return this.readPixels(r,t/i.width,(i.height-e)/i.height,1),this.colorObjects[r[0]+"_"+r[1]+"_"+r[2]]},sn.prototype._drawPickingBuffer=function(){this.pickingFramebuffer.activate();var t=this.handler,e=t.gl;e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.disable(t.gl.BLEND);for(var i=this._pickingCallbacks,r=i.length;r--;)i[r].callback.call(i[r].sender);this.pickingFramebuffer.deactivate();var n=this.events.mouseState,s=this.events.touchState;if(!(n.leftButtonHold||n.rightButtonHold||n.middleButtonHold)){this._prevPickingColor[0]=this._currPickingColor[0],this._prevPickingColor[1]=this._currPickingColor[1],this._prevPickingColor[2]=this._currPickingColor[2];var o=this._currPickingColor;s.x||s.y?(this.pickingFramebuffer.readPixels(o,s.nx,1-s.ny),o[0]||o[1]||o[2]||this.readPixels(o,s.nx,1-s.ny,1)):(this.pickingFramebuffer.readPixels(o,n.nx,1-n.ny),o[0]||o[1]||o[2]||this.readPixels(o,n.nx,1-n.ny,1))}},sn.prototype.start=function(){this.handler.start()};class on{static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}constructor(t,e){e=e||{},this._name=t||"light_"+on._staticCounter++,this._renderNode=null,this._position=e.position||new Xt,this.directional=void 0==e.derectional||e.derectional,this._ambient=e.ambient||new Xt,this._diffuse=e.diffuse||new Xt(.8,.8,.8),this._specular=e.specular||new Xt(.18,.18,.18),this._shininess=void 0!=e.shininess?e.shininess:3.3,this._active=!0,this._tempAmbient=this._ambient.clone(),this._tempDiffuse=this._diffuse.clone(),this._tempSpecular=this._specular.clone(),this._tempShininess=this._shininess}clone(){}setActive(t){if(t&&!this._active){var e=this._renderNode;if(e){var i=e._lightsNames.indexOf(this._name);this._shininess=e._lightsParamsf[i]=this._tempShininess,-1!=i&&(i*=9,this._ambient.x=e._lightsParamsv[i]=this._tempAmbient.x,this._ambient.y=e._lightsParamsv[i+1]=this._tempAmbient.y,this._ambient.z=e._lightsParamsv[i+2]=this._tempAmbient.z,this._diffuse.x=e._lightsParamsv[i+3]=this._tempDiffuse.x,this._diffuse.y=e._lightsParamsv[i+4]=this._tempDiffuse.y,this._diffuse.z=e._lightsParamsv[i+5]=this._tempDiffuse.z,this._specular.x=e._lightsParamsv[i+6]=this._tempSpecular.x,this._specular.y=e._lightsParamsv[i+7]=this._tempSpecular.y,this._specular.z=e._lightsParamsv[i+8]=this._tempSpecular.z)}this._active=!0}else!t&&this._active&&(this._tempAmbient=this._ambient.clone(),this._tempDiffuse=this._diffuse.clone(),this._tempSpecular=this._specular.clone(),this._tempShininess=this._shininess,this.setBlack(),this._active=!1)}isActive(){return this._active}setPosition3v(t){return this._position.x=t.x,this._position.y=t.y,this._position.z=t.z,this}setPosition(t,e,i){return this._position.x=t,this._position.y=e,this._position.z=i,this}getPosition(){return this._position.clone()}setAmbient3v(t){return this.setAmbient(t.x,t.y,t.z)}setDiffuse3v(t){return this.setDiffuse(t.x,t.y,t.z)}setSpecular3v(t){return this.setSpecular(t.x,t.y,t.z)}setAmbient(t,e,i){this._ambient.set(t,e,i);var r=this._renderNode;if(r){var n=9*r._lightsNames.indexOf(this._name);-1!=n&&(r._lightsParamsv[n]=t,r._lightsParamsv[n+1]=e,r._lightsParamsv[n+2]=i)}return this}setDiffuse(t,e,i){this._diffuse.set(t,e,i);var r=this._renderNode;if(r){var n=9*r._lightsNames.indexOf(this._name);-1!=n&&(r._lightsParamsv[n+3]=t,r._lightsParamsv[n+4]=e,r._lightsParamsv[n+5]=i)}return this}setSpecular(t,e,i){this._specular.set(t,e,i);var r=this._renderNode;if(r){var n=9*r._lightsNames.indexOf(this._name);-1!=n&&(r._lightsParamsv[n+6]=t,r._lightsParamsv[n+7]=e,r._lightsParamsv[n+8]=i)}return this}setShininess(t){this._shininess=t;var e=this._renderNode;if(e){var i=e._lightsNames.indexOf(this._name);-1!=i&&(e._lightsParamsf[i]=t)}return this}setBlack(){this._ambient.clear(),this._diffuse.clear(),this._specular.clear(),this._shininess=0;var t=this._renderNode;if(t){var e=9*t._lightsNames.indexOf(this._name);-1!=e&&(t._lightsParamsv[e]=t._lightsParamsv[e+1]=t._lightsParamsv[e+2]=t._lightsParamsv[e+3]=t._lightsParamsv[e+4]=t._lightsParamsv[e+5]=t._lightsParamsv[e+6]=t._lightsParamsv[e+7]=t._lightsParamsv[e+8]=0)}return this}addTo(t){return this._renderNode=t,t._lights.push(this),t._lightsNames.push(this._name),t._lightsParamsf.push(this._shininess),t._lightsParamsv.push.apply(t._lightsParamsv,this._ambient.toVec()),t._lightsParamsv.push.apply(t._lightsParamsv,this._diffuse.toVec()),t._lightsParamsv.push.apply(t._lightsParamsv,this._specular.toVec()),this}remove(){var t=this.renderNode;if(t){var e=t.getLightById(this._name);-1!=e&&(t._lights.splice(e,1),t._lightsNames.splice(e,1),t._lightsParamsf.splice(e,1),t._lightsParamsv.splice(e,9))}this._renderNode=null}}class an{constructor(t){this.name=t,this.topNode=this,this._dictionary=[],this._dictionary[t]=this,this.childNodes=[],this.parentNode=null,this.__staticId=an._staticCounter++}static get _staticCounter(){return this.__counter__||0===this.__counter__||(this.__counter__=0),this.__counter__}static set _staticCounter(t){this.__counter__=t}addNode(t){null==this.parentNode?t.topNode=this:t.topNode=this.topNode,t.parentNode=this,t._dictionary=this.topNode._dictionary,this.childNodes.push(t),this.topNode._dictionary[t.name]=t}destroy(){for(var t=0;t<this.childNodes.length;t++)this.childNodes[t].destroy();this._clear()}getNodeByName(t){return this._dictionary[t]}_clear(){this.name="",this.parentNode=null,this.topNode=null,this.childNodes.length=0}isEqual(t){return t.__staticId===this.__staticId}}class hn extends an{constructor(t){super(t),this.renderer=null,this.drawMode=null,this.show=!0,this._isActive=!0,this.lightEnabled=!1,this._lights=[],this._lightsTransformedPositions=[],this._lightsParamsv=[],this._lightsParamsf=[],this._lightsNames=[],this.entityCollections=[],this.events=new rr(null,this)}addNode(t){super.addNode(t),t.assign(this.renderer)}setFontAtlas(t){this.fontAtlas=t,this.renderer&&this.fontAtlas.assignHandler(this.renderer.handler)}assign(t){this.renderer=t,this._pickingId=t.addPickingCallback(this,this._entityCollectionPickingCallback);for(var e=0;e<this.entityCollections.length;e++)this.entityCollections[e].bindRenderNode(this);this.init&&this.init()}onremove(){}remove(){var t=this.renderer,e=this.name;t.renderNodes[e]&&t.renderNodes[e].isEqual(this)&&(t.renderNodes[e]=null,delete t.renderNodes[e]);for(var i=0;i<t._renderNodesArr.length;i++)if(t._renderNodesArr[i].isEqual(this)){t._renderNodesArr.splice(i,1);break}this.renderer.removePickingCallback(this._pickingId),this._pickingId=null,this.onremove&&this.onremove()}addEntityCollection(t,e){return t.addTo(this,e),this}removeEntityCollection(t){t.remove()}addLight(t){return t.addTo(this),this}getLightByName(t){var e=this._lightsNames.indexOf(t);return this._lights[e]}removeLight(t){t.remove()}drawNode(){this._isActive&&this._drawNodes()}isActive(){return this._isActive}setActive(t){this._isActive=t;for(var e=0;e<this.childNodes.length;e++)this.childNodes[e].setActive(t)}setDrawMode(t){this.drawMode=t;for(var e=0;e<this.childNodes.length;e++)this.childNodes[e].setDrawMode(t)}transformLights(){for(var t=this.renderer,e=0;e<this._lights.length;e++){var i,r=4*e;this._lights[e].directional?(i=t.activeCamera._normalMatrix.mulVec(this._lights[e]._position),this._lightsTransformedPositions[r+3]=0):(i=t.activeCamera._viewMatrix.mulVec3(this._lights[e]._position),this._lightsTransformedPositions[r+3]=1),this._lightsTransformedPositions[r]=i.x,this._lightsTransformedPositions[r+1]=i.y,this._lightsTransformedPositions[r+2]=i.z}}updateBillboardsTexCoords(){for(var t=0;t<this.entityCollections.length;t++)this.entityCollections[t].billboardHandler.refreshTexCoordsArr()}_drawNodes(){for(var t=0;t<this.childNodes.length;t++)this.childNodes[t]._isActive&&this.childNodes[t]._drawNodes();this.show&&(this.frame&&this.frame(),this.drawEntityCollections(this.entityCollections))}drawEntityCollections(t){this.renderer.enqueueEntityCollectionsToDraw(t)}drawPickingEntityCollections(t){if(t.length){var e=this.renderer.handler.gl;e.disable(e.CULL_FACE),e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0);for(var i=t.length;i--;)t[i]._fadingOpacity&&t[i].billboardHandler.drawPicking();for(i=t.length;i--;)t[i]._fadingOpacity&&t[i].labelHandler.drawPicking();for(e.polygonOffset(0,0),e.disable(e.POLYGON_OFFSET_FILL),e.enable(e.CULL_FACE),i=t.length;i--;)t[i]._visibility&&t[i].polylineHandler.drawPicking()}}_entityCollectionPickingCallback(){this.drawPickingEntityCollections(this.entityCollections)}}i.d(e,"bv",function(){return ln}),i.d(e,"control",function(){return un}),i.d(e,"webgl",function(){return _n}),i.d(e,"scene",function(){return fn}),i.d(e,"entity",function(){return cn}),i.d(e,"jd",function(){return s}),i.d(e,"math",function(){return r}),i.d(e,"utils",function(){return n}),i.d(e,"input",function(){return ci}),i.d(e,"Control",function(){return li}),i.d(e,"Camera",function(){return zr}),i.d(e,"LightSource",function(){return on}),i.d(e,"EntityCollection",function(){return br}),i.d(e,"Handler",function(){return Wr}),i.d(e,"Renderer",function(){return sn}),i.d(e,"Clock",function(){return Ir}),i.d(e,"Events",function(){return rr}),i.d(e,"RenderNode",function(){return hn}),i.d(e,"Line2",function(){return Fr}),i.d(e,"Line3",function(){return vi}),i.d(e,"Mat3",function(){return Ht}),i.d(e,"Mat4",function(){return Vt}),i.d(e,"Plane",function(){return Dr}),i.d(e,"Quat",function(){return Wt}),i.d(e,"Ray",function(){return Sr}),i.d(e,"TextureAtlas",function(){return $r}),i.d(e,"Vec2",function(){return Yt}),i.d(e,"Vec3",function(){return Xt}),i.d(e,"Vec4",function(){return Ut}),i.d(e,"Entity",function(){return Ui});const ln={Box:class{constructor(t){this.vertices=[new Xt,new Xt,new Xt,new Xt,new Xt,new Xt,new Xt,new Xt],t&&this.setFromBounds(t)}setFromBounds(t){var e=t[0],i=t[3],r=t[1],n=t[4],s=t[2],o=t[5],a=this.vertices;a[0].set(e,r,s),a[1].set(i,r,s),a[2].set(i,r,o),a[3].set(e,r,o),a[4].set(e,n,s),a[5].set(i,n,s),a[6].set(i,n,o),a[7].set(e,n,o)}setFromExtent(t,e){this.setFromBounds(e.getCartesianBounds(t))}},Sphere:class{constructor(t,e){this.radius=t||0,this.center=e?e.clone():new Xt}setFromBounds(t){let e=new Xt(t[0],t[1],t[2]);this.center.set(e.x+.5*(t[3]-e.x),e.y+.5*(t[3]-e.y),e.z+.5*(t[5]-e.z)),this.radius=this.center.distance(e)}setFromExtent(t,e){this.setFromBounds(e.getCartesianBounds(t))}}},un={DebugInfo:ui,SimpleNavigation:_i,ShowFps:fi},cn={Billboard:pi,Label:wi,PointCloud:ki,Polyline:Fi},_n={Framebuffer:kr,Handler:Wr,Multisample:Yr,types:Vi,Program:ji},fn={Axes:class extends hn{constructor(t){super("Axes"),this.size=t||100,this.axesBuffer=null,this.axesColorBuffer=null}init(){this.createAxisBuffer(this.size),this.drawMode=this.renderer.handler.gl.LINES,this.renderer.handler.addProgram(new ji("axesShader",{uniforms:{projectionViewMatrix:"mat4"},attributes:{aVertexPosition:"vec3",aVertexColor:"vec4"},vertexShader:"attribute vec3 aVertexPosition;            attribute vec4 aVertexColor;            uniform mat4 projectionViewMatrix;            varying vec4 vColor;            void main(void) {                gl_Position = projectionViewMatrix * vec4(aVertexPosition, 1.0);                vColor = aVertexColor;            }",fragmentShader:"precision highp float;            varying vec4 vColor;            void main(void) {                gl_FragColor = vColor;            }"}))}frame(){this.renderer.handler.programs.axesShader.activate().set({projectionViewMatrix:this.renderer.activeCamera._projectionViewMatrix._m,aVertexPosition:this.axisBuffer,aVertexColor:this.axisColorBuffer}),this.renderer.handler.programs.axesShader.drawArrays(this.drawMode,this.axisBuffer.numItems)}createAxisBuffer(t){var e=[0,0,0,t-1,0,0,0,0,0,0,t-1,0,0,0,0,0,0,t-1];this.axisBuffer=this.renderer.handler.createArrayBuffer(new Float32Array(e),3,6),this.axisColorBuffer=this.renderer.handler.createArrayBuffer(new Float32Array([1,0,0,1,1,0,0,1,0,0,1,1,0,0,1,1,0,1,0,1,0,1,0,1]),4,6)}}}}])});