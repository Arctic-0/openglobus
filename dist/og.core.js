!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("og",[],e):"object"==typeof exports?exports.og=e():t.og=e()}(window,function(){return function(t){var e={};function i(r){if(e[r])return e[r].exports;var s=e[r]={i:r,l:!1,exports:{}};return t[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=t,i.c=e,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:r})},i.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);var r={};i.d(r,"TWO_PI",function(){return l}),i.d(r,"PI_TWO",function(){return u}),i.d(r,"X",function(){return c}),i.d(r,"Y",function(){return _}),i.d(r,"Z",function(){return d}),i.d(r,"W",function(){return f}),i.d(r,"MAX_FLOAT",function(){return p}),i.d(r,"LOG2",function(){return v}),i.d(r,"MAX32",function(){return g}),i.d(r,"MAX",function(){return m}),i.d(r,"MIN",function(){return b}),i.d(r,"RADIANS",function(){return A}),i.d(r,"DEGREES",function(){return C}),i.d(r,"DEGREES_DOUBLE",function(){return E}),i.d(r,"RADIANS_HALF",function(){return T}),i.d(r,"ARCSECONDS_TO_RADIANS",function(){return B}),i.d(r,"RADIANS_TO_HOURS",function(){return P}),i.d(r,"HOURS_TO_RADIANS",function(){return R}),i.d(r,"HOURS_TO_DEGREES",function(){return M}),i.d(r,"DEGREES_TO_HOURS",function(){return F}),i.d(r,"SQRT_HALF",function(){return S}),i.d(r,"EPSILON1",function(){return D}),i.d(r,"EPSILON2",function(){return L}),i.d(r,"EPSILON3",function(){return N}),i.d(r,"EPSILON4",function(){return I}),i.d(r,"EPSILON5",function(){return k}),i.d(r,"EPSILON6",function(){return O}),i.d(r,"EPSILON7",function(){return U}),i.d(r,"EPSILON8",function(){return V}),i.d(r,"EPSILON9",function(){return H}),i.d(r,"EPSILON10",function(){return X}),i.d(r,"EPSILON11",function(){return W}),i.d(r,"EPSILON12",function(){return Y}),i.d(r,"EPSILON13",function(){return j}),i.d(r,"EPSILON14",function(){return G}),i.d(r,"EPSILON15",function(){return q}),i.d(r,"EPSILON16",function(){return K}),i.d(r,"EPSILON17",function(){return Z}),i.d(r,"EPSILON18",function(){return Q}),i.d(r,"EPSILON19",function(){return J}),i.d(r,"EPSILON20",function(){return $}),i.d(r,"log",function(){return tt}),i.d(r,"clamp",function(){return et}),i.d(r,"DEG2RAD",function(){return it}),i.d(r,"RAD2DEG",function(){return rt}),i.d(r,"isPowerOfTwo",function(){return st}),i.d(r,"nextHighestPowerOfTwo",function(){return nt}),i.d(r,"randomi",function(){return ot}),i.d(r,"random",function(){return at}),i.d(r,"degToDec",function(){return ht}),i.d(r,"mod",function(){return lt}),i.d(r,"zeroTwoPI",function(){return ut}),i.d(r,"step",function(){return ct}),i.d(r,"frac",function(){return _t}),i.d(r,"log2",function(){return dt}),i.d(r,"exp2",function(){return ft}),i.d(r,"pow2i",function(){return pt}),i.d(r,"slice",function(){return vt}),i.d(r,"lerp",function(){return gt}),i.d(r,"bezier",function(){return mt}),i.d(r,"rev",function(){return yt}),i.d(r,"norm_lon",function(){return xt}),i.d(r,"negativePItoPI",function(){return bt}),i.d(r,"solve_iteration_fixed",function(){return At}),i.d(r,"solve_iteration",function(){return Ct});var s={};i.d(s,"isEmpty",function(){return jt}),i.d(s,"stamp",function(){return qt}),i.d(s,"isString",function(){return Kt}),i.d(s,"readTextFile",function(){return Zt}),i.d(s,"htmlColorToRgba",function(){return Qt}),i.d(s,"htmlColorToRgb",function(){return Jt}),i.d(s,"stringTemplate",function(){return $t}),i.d(s,"print2d",function(){return te}),i.d(s,"defaultString",function(){return ee}),i.d(s,"createVector3",function(){return ie}),i.d(s,"createVector4",function(){return re}),i.d(s,"createColorRGBA",function(){return se}),i.d(s,"createColorRGB",function(){return ne}),i.d(s,"createExtent",function(){return oe}),i.d(s,"createLonLat",function(){return ae}),i.d(s,"binarySearch",function(){return he}),i.d(s,"binaryInsert",function(){return le}),i.d(s,"getLinesIntersection2v",function(){return ue}),i.d(s,"getLinesIntersectionLonLat",function(){return ce}),i.d(s,"xmlToJson",function(){return _e}),i.d(s,"castType",function(){return de}),i.d(s,"base64toBlob",function(){return fe});var n={};i.d(n,"SECONDS_PER_MILLISECOND",function(){return pe}),i.d(n,"MILLISECONDS_PER_SECOND",function(){return ve}),i.d(n,"SECONDS_PER_MINUTE",function(){return ge}),i.d(n,"ONE_BY_SECONDS_PER_MINUTE",function(){return me}),i.d(n,"MINUTES_PER_HOUR",function(){return ye}),i.d(n,"HOURS_PER_DAY",function(){return xe}),i.d(n,"ONE_BY_HOURS_PER_DAY",function(){return be}),i.d(n,"SECONDS_PER_HOUR",function(){return Ae}),i.d(n,"ONE_BY_SECONDS_PER_HOUR",function(){return Ce}),i.d(n,"SECONDS_PER_12_HOURS",function(){return Ee}),i.d(n,"MINUTES_PER_DAY",function(){return Te}),i.d(n,"ONE_BY_MINUTES_PER_DAY",function(){return we}),i.d(n,"SECONDS_PER_DAY",function(){return Be}),i.d(n,"MILLISECONDS_PER_DAY",function(){return Pe}),i.d(n,"ONE_BY_MILLISECONDS_PER_DAY",function(){return Re}),i.d(n,"ONE_BY_SECONDS_PER_DAY",function(){return ze}),i.d(n,"DAYS_PER_JULIAN_CENTURY",function(){return Me}),i.d(n,"DAYS_PER_JULIAN_YEAR",function(){return Fe}),i.d(n,"PICOSECOND",function(){return Se}),i.d(n,"MODIFIED_JULIAN_DATE_DIFFERENCE",function(){return De}),i.d(n,"J2000",function(){return Le}),i.d(n,"T",function(){return Ne}),i.d(n,"getDayNumber",function(){return Ie}),i.d(n,"DateToUTC",function(){return ke}),i.d(n,"DateToTAI",function(){return Oe}),i.d(n,"UTCtoTAI",function(){return Ue}),i.d(n,"TAItoUTC",function(){return Ve}),i.d(n,"UTCtoDate",function(){return He}),i.d(n,"TAItoDate",function(){return Xe}),i.d(n,"addMilliseconds",function(){return We}),i.d(n,"addSeconds",function(){return Ye}),i.d(n,"addHours",function(){return je}),i.d(n,"addMinutes",function(){return Ge}),i.d(n,"addDays",function(){return qe}),i.d(n,"getMilliseconds",function(){return Ke}),i.d(n,"getSeconds",function(){return Ze}),i.d(n,"getHours",function(){return Qe}),i.d(n,"getMinutes",function(){return Je}),i.d(n,"getDays",function(){return $e}),i.d(n,"secondsToDays",function(){return ti}),i.d(n,"daysToSeconds",function(){return ei}),i.d(n,"J2000TAI",function(){return si});const o={ReadyState:{Uninitialized:0,Loading:1,Loaded:2,Interactive:3,Complete:4},Status:{OK:200,Created:201,Accepted:202,NoContent:204,BadRequest:400,Forbidden:403,NotFound:404,Gone:410,ServerError:500},Method:{Get:"GET",Post:"POST"},Asynchronous:!0,Synchronous:!1},a={type:o.Method.Get,async:o.Asynchronous,data:null,sender:null,responseType:"text"};o.request=function(t,e){e=e||{};var i,r={};for(i in a)r[i]=a[i];for(i in e)r[i]=e[i];r.data=e.data;var s,n=function(){if(void 0!==typeof XMLHttpRequest)return new XMLHttpRequest;if(window.ActiveXObject)for(var t=["MSXML2.XMLHttp.5.0","MSXML2.XMLHttp.4.0","MSXML2.XMLHttp.3.0","MSXML2.XMLHttp","Microsoft.XMLHttp"],e=0;e<t.length;e++)try{return new ActiveXObject(t[e])}catch(t){console.log("error: og.ajax.createXMLHttp creation filed.")}}(),h=new function(t){var e=t;this.abort=function(){e.aborted=!0,e.abort()}}(n),l=null;if(r.type===o.Method.Post){if(r.data){l="";for(let t in r.data)s=r.data[t],l+=t+"="+encodeURIComponent(s instanceof Object?JSON.stringify(s):s)+"&";l=l.slice(0,-1)}n.open(r.type,t,r.async),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}else if(r.data){var u="?";for(let t in r.data)s=r.data[t],u+=t+"="+encodeURIComponent(s instanceof Object?JSON.stringify(s):s)+"&";u=u.slice(0,-1),n.open(r.type,t+u,r.async)}else n.open(r.type,t,r.async);return r.async&&(n.responseType=r.responseType),n.overrideMimeType("text/plain"),n.onreadystatechange=function(){n.readyState===o.ReadyState.Complete&&(n.status===o.Status.OK?e.success&&e.success.call(e.sender||h,n.response):n.aborted?e.abort&&e.abort.call(e.sender||h,n.response,n.status):e.error&&e.error.call(e.sender||h,n.response,n.status),delete n.onreadystatechange,n.onreadystatechange=null,n=null)},n.send(l),h};const h={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},l=2*Math.PI,u=Math.PI/2,c=0,_=1,d=2,f=3,p=Number.MAX_VALUE||1.7976931348623157e308,v=Math.log(2),g=2147483647,m=549755748352,b=-m,A=Math.PI/180,C=180/Math.PI,E=2*C,T=.5*A,B=484813681109536e-20,P=3.819718634205488,R=.26179938779914946,M=15,F=1/15,S=Math.sqrt(.5),D=.1,L=.01,N=.001,I=1e-4,k=1e-5,O=1e-6,U=1e-7,V=1e-8,H=1e-9,X=1e-10,W=1e-11,Y=1e-12,j=1e-13,G=1e-14,q=1e-15,K=1e-16,Z=1e-17,Q=1e-18,J=1e-19,$=1e-20;function tt(t,e){return Math.log(t)/Math.log(e)}function et(t,e,i){return Math.max(e,Math.min(t,i))}function it(t){return t*A}function rt(t){return t*C}function st(t){return 0==(t&t-1)}function nt(t){--t;for(var e=1;e<32;e<<=1)t|=t>>e;return t+1}function ot(t,e){return Math.floor(Math.random()*(e-t))+t}function at(t,e){return Math.random()*(e-t)+t}function ht(t,e,i,r){return r?t+e/60+i/3600:-t-e/60-i/3600}function lt(t,e){return(t%e+e)%e}function ut(t){var e=og.math.mod(t,og.math.TWO_PI);return Math.abs(e)<og.math.EPSILON14&&Math.abs(t)>og.math.EPSILON14?og.math.TWO_PI:e}function ct(t,e){return e<t?0:1}function _t(t){return t-Math.floor(t)}function dt(t){return Math.log(t)/og.math.LOG2}function ft(t){return Math.pow(2,t)}function pt(t){return 2<<t-1}function vt(t,e,i){return t*(e-i)}function gt(t,e,i){return i+t*(e-i)}function mt(t,e,i,r,s){var n=1-t,o=t*t,a=n*n,h=a*n,l=o*t;return e.scaleTo(h).addA(i.scaleTo(3*a*t)).addA(r.scaleTo(3*n*o)).addA(s.scaleTo(l))}function yt(t){return t-360*Math.floor(t/360)}function xt(t){return t>180?(t+180)%360-180:t<-180?(t-180)%360+180:t}function bt(t){return og.math.zeroTwoPI(t+Math.PI)-Math.PI}function At(t,e,i){for(var r=e,s=0;s<i;s++)r=t(r);return r}function Ct(t,e,i,r){r=r||50;for(var s=0,n=e,o=0;o<r;o++)if(n=t(s=n),Math.abs(n-s)<i)return n;return n}const Et=20037508.34,Tt=Math.PI/Et,wt=Et/Math.PI,Bt=.5*Math.PI,Pt=Et/180,Rt=180/Et,zt=(Math.PI,Math.PI,180/Math.PI),Mt=2*Et;const Ft=function(t){return zt*(2*Math.atan(Math.exp(t*Tt))-Bt)}(Et),St=.5*Math.PI,Dt=(Math.PI,180/Math.PI),Lt=2*Dt,Nt=Math.PI/360,It=Dt*St,kt=function(t,e,i){this.lon=t||0,this.lat=e||0,this.height=i||0};kt.join=function(t){for(var e=[],i=0;i<t.length;i++){var r=t[i];e[i]=new kt(r[0],r[1],r[2])}return e},kt.createFromArray=function(t){return new kt(t[0],t[1],t[2])},kt.forwardMercator=function(t,e,i){return new kt(t*Pt,Math.log(Math.tan((90+e)*Nt))*wt,i)},kt.inverseMercator=function(t,e,i){return new kt(t*Rt,Lt*Math.atan(Math.exp(e*Tt))-It,i)},kt.prototype.set=function(t,e,i){return this.lon=t||0,this.lat=e||0,this.height=i||0,this},kt.prototype.copy=function(t){return this.lon=t.lon,this.lat=t.lat,this.height=t.height,this},kt.prototype.clone=function(){return new kt(this.lon,this.lat,this.height)},kt.prototype.forwardMercator=function(){return kt.forwardMercator(this.lon,this.lat,this.height)},kt.prototype.forwardMercatorEPS01=function(){var t=this.lat;return t>89.9?t=89.9:t<-89.9&&(t=-89.9),new kt(this.lon*Pt,Math.log(Math.tan((90+t)*Nt))*wt)},kt.prototype.inverseMercator=function(){return kt.inverseMercator(this.lon,this.lat,this.height)},kt.prototype.equal=function(t){return t.height?this.lon===t.lon&&this.lat===t.lat&&this.height===t.height:this.lon===t.lon&&this.lat===t.lat};const Ot=function(t,e){this.southWest=t||new kt,this.northEast=e||new kt};Ot.FULL_MERC=new Ot(kt.SW_MERC,kt.NE_MERC),Ot.NORTH_POLE_DEG=new Ot(kt.NW_MERC_DEG,new kt(180,90)),Ot.SOUTH_POLE_DEG=new Ot(new kt(-180,-90),kt.SE_MERC_DEG),Ot.createFromArray=function(t){return new Ot(new kt(t[0],t[1]),new kt(t[2],t[3]))},Ot.createByCoordinates=function(t){for(var e=m,i=b,r=m,s=b,n=0;n<t.length;n++){var o=t[n];o.lon<e&&(e=o.lon),o.lon>i&&(i=o.lon),o.lat<r&&(r=o.lat),o.lat>s&&(s=o.lat)}return new Ot(new kt(e,r),new kt(i,s))},Ot.createByCoordinatesArr=function(t){for(var e=m,i=b,r=m,s=b,n=0;n<t.length;n++){var o=t[n];o[0]<e&&(e=o[0]),o[0]>i&&(i=o[0]),o[1]<r&&(r=o[1]),o[1]>s&&(s=o[1])}return new Ot(new kt(e,r),new kt(i,s))},Ot.fromTile=function(t,e,i,r,s){r=r||Mt,s=s||Mt;var n=Math.pow(2,i),o=r/Math.pow(2,i),a=s/n,h=.5*-r+t*o,l=.5*s-e*a,u=h+o;return new Ot(new kt(h,l-a),new kt(u,l))},Ot.prototype.setByCoordinates=function(t){for(var e=m,i=b,r=m,s=b,n=0;n<t.length;n++){var o=t[n];o.lon<e&&(e=o.lon),o.lon>i&&(i=o.lon),o.lat<r&&(r=o.lat),o.lat>s&&(s=o.lat)}return this.southWest.lon=e,this.southWest.lat=r,this.northEast.lon=i,this.northEast.lat=s,this},Ot.prototype.isInside=function(t){var e=this.southWest,i=this.northEast;return t.lon>=e.lon&&t.lon<=i.lon&&t.lat>=e.lat&&t.lat<=i.lat},Ot.prototype.overlaps=function(t){var e=this.southWest,i=this.northEast;return e.lon<=t.northEast.lon&&i.lon>=t.southWest.lon&&e.lat<=t.northEast.lat&&i.lat>=t.southWest.lat},Ot.prototype.getWidth=function(){return this.northEast.lon-this.southWest.lon},Ot.prototype.getHeight=function(){return this.northEast.lat-this.southWest.lat},Ot.prototype.clone=function(){return new Ot(this.southWest.clone(),this.northEast.clone())},Ot.prototype.getCenter=function(){var t=this.southWest,e=this.northEast;return new kt(t.lon+.5*(e.lon-t.lon),t.lat+.5*(e.lat-t.lat))},Ot.prototype.getNorthWest=function(){return new kt(this.southWest.lon,this.northEast.lat)},Ot.prototype.getNorthEast=function(){return new kt(this.northEast.lon,this.northEast.lat)},Ot.prototype.getSouthWest=function(){return new kt(this.southWest.lon,this.southWest.lat)},Ot.prototype.getSouthEast=function(){return new kt(this.northEast.lon,this.southWest.lat)},Ot.prototype.getNorth=function(){return this.northEast.lat},Ot.prototype.getEast=function(){return this.northEast.lon},Ot.prototype.getWest=function(){return this.southWest.lon},Ot.prototype.getSouth=function(){return this.southWest.lat},Ot.prototype.equals=function(t){return this.southWest.lon===t.southWest.lon&&this.southWest.lat===t.southWest.lat&&this.northEast.lon===t.northEast.lon&&this.northEast.lat===t.northEast.lat},Ot.prototype.forwardMercator=function(){return new Ot(this.southWest.forwardMercator(),this.northEast.forwardMercator())},Ot.prototype.inverseMercator=function(){return new Ot(this.southWest.inverseMercator(),this.northEast.inverseMercator())},Ot.prototype.getCartesianBounds=function(t){for(var e=m,i=b,r=m,s=b,n=m,o=b,a=[new kt(this.southWest.lon,this.southWest.lat),new kt(this.southWest.lon,this.northEast.lat),new kt(this.northEast.lon,this.northEast.lat),new kt(this.northEast.lon,this.southWest.lat)],h=0;h<a.length;h++){var l=t.lonLatToCartesian(a[h]),u=l.x,c=l.y,_=l.z;u<e&&(e=u),u>i&&(i=u),c<r&&(r=c),c>s&&(s=c),_<n&&(n=_),_>o&&(o=_)}return[e,i,r,s,n,o]},Ot.prototype.toString=function(){return"["+this.southWest.lon+", "+this.southWest.lat+", "+this.northEast.lon+", "+this.northEast.lat+"]"};const Ut=function(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=r||0};Ut.identity=new Ut(0,0,0,1),Ut.fromVec=function(t){return new Ut(t[0],t[1],t[2],t[3])},Ut.prototype.toVec3=function(){return new Wt(this.x,this.y,this.z)},Ut.prototype.clone=function(t){return new Ut(this.x,this.y,this.z,this.w)},Ut.prototype.equal=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},Ut.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},Ut.prototype.toVec=function(){return[this.x,this.y,this.z,this.w]},Ut.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},Ut.prototype.set=function(t,e,i,r){return this.x=t,this.y=e,this.z=i,this.w=r,this},Ut.prototype.addA=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},Ut.prototype.subA=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},Ut.prototype.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},Ut.prototype.affinity=function(){var t=1/this.w;return this.x*=t,this.y*=t,this.z*=t,this.w=1,this},Ut.prototype.scaleTo=function(t){return new Ut(this.x*t,this.y*t,this.z*t,this.w*t)},Ut.prototype.getStep=function(t){return new Ut(this.x<t?0:1,this.y<t?0:1,this.z<t?0:1,this.w<t?0:1)},Ut.prototype.getFrac=function(t){return new Ut(og.math.frac(t.x),og.math.frac(t.y),og.math.frac(t.z),og.math.frac(t.w))},Ut.prototype.dot=function(t){return t.x*this.x+t.y*this.y+t.z*this.z+t.w*this.w};const Vt=function(){this._m=new Array(9)};Vt.prototype.set=function(t){return this._m[0]=t[0],this._m[1]=t[1],this._m[2]=t[2],this._m[3]=t[3],this._m[4]=t[4],this._m[5]=t[5],this._m[6]=t[6],this._m[7]=t[7],this._m[8]=t[8],this},Vt.prototype.clone=function(){var t=new Vt;return t.set(this),t},Vt.prototype.copy=function(t){return this.set(t._m)},Vt.prototype.transposeTo=function(){var t=new Vt,e=this._m;return t._m[0]=e[0],t._m[1]=e[3],t._m[2]=e[6],t._m[3]=e[1],t._m[4]=e[4],t._m[5]=e[7],t._m[6]=e[2],t._m[7]=e[5],t._m[8]=e[8],t},Vt.prototype.setIdentity=function(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=1,this._m[5]=0,this._m[6]=0,this._m[7]=0,this._m[8]=1,this},Vt.prototype.mulVec=function(t){var e=t.x,i=t.y,r=t.z,s=this._m;return new Wt(s[0]*e+s[3]*i+s[6]*r,s[1]*e+s[4]*i+s[7]*r,s[2]*e+s[5]*i+s[8]*r)},Vt.prototype.toMatrix4=function(){var t=new Ht,e=t._m,i=this._m;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=0,e[4]=i[3],e[5]=i[4],e[6]=i[5],e[7]=0,e[8]=i[6],e[9]=i[7],e[10]=i[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,t};const Ht=function(){this._m=new Array(16),this.left,this.right,this.bottom,this.top,this.near,this.far};Ht.identity=function(){var t=new Ht;return t._m[0]=1,t._m[1]=0,t._m[2]=0,t._m[3]=0,t._m[4]=0,t._m[5]=1,t._m[6]=0,t._m[7]=0,t._m[8]=0,t._m[9]=0,t._m[10]=1,t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t},Ht.prototype.set=function(t){return this._m[0]=t[0],this._m[1]=t[1],this._m[2]=t[2],this._m[3]=t[3],this._m[4]=t[4],this._m[5]=t[5],this._m[6]=t[6],this._m[7]=t[7],this._m[8]=t[8],this._m[9]=t[9],this._m[10]=t[10],this._m[11]=t[11],this._m[12]=t[12],this._m[13]=t[13],this._m[14]=t[14],this._m[15]=t[15],this},Ht.prototype.clone=function(){var t=new Ht;return t.set(this),t},Ht.prototype.copy=function(t){this.set(t._m)},Ht.prototype.toMatrix3=function(){var t=new Vt,e=this._m,i=t._m;return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[4],i[4]=e[5],i[5]=e[6],i[6]=e[8],i[7]=e[9],i[8]=e[10],t},Ht.prototype.mulVec3=function(t){var e=t.x,i=t.y,r=t.z;return new Wt(this._m[0]*e+this._m[4]*i+this._m[8]*r+this._m[12],this._m[1]*e+this._m[5]*i+this._m[9]*r+this._m[13],this._m[2]*e+this._m[6]*i+this._m[10]*r+this._m[14])},Ht.prototype.mulVec4=function(t){var e=t.x,i=t.y,r=t.z,s=t.w;return new Ut(this._m[0]*e+this._m[4]*i+this._m[8]*r+this._m[12]*s,this._m[1]*e+this._m[5]*i+this._m[9]*r+this._m[13]*s,this._m[2]*e+this._m[6]*i+this._m[10]*r+this._m[14]*s,this._m[3]*e+this._m[7]*i+this._m[11]*r+this._m[15]*s)},Ht.prototype.toInverseMatrix3=function(){var t=this._m,e=t[0],i=t[1],r=t[2],s=t[4],n=t[5],o=t[6],a=t[8],h=t[9],l=t[10],u=l*n-o*h,c=-l*s+o*a,_=h*s-n*a,d=e*u+i*c+r*_;if(!d)return null;d=1/d;var f=new Vt;return f._m[0]=u*d,f._m[1]=(-l*i+r*h)*d,f._m[2]=(o*i-r*n)*d,f._m[3]=c*d,f._m[4]=(l*e-r*a)*d,f._m[5]=(-o*e+r*s)*d,f._m[6]=_*d,f._m[7]=(-h*e+i*a)*d,f._m[8]=(n*e-i*s)*d,f},Ht.prototype.inverseTo=function(){var t=this._m[0],e=this._m[1],i=this._m[2],r=this._m[3],s=this._m[4],n=this._m[5],o=this._m[6],a=this._m[7],h=this._m[8],l=this._m[9],u=this._m[10],c=this._m[11],_=this._m[12],d=this._m[13],f=this._m[14],p=this._m[15],v=t*n-e*s,g=t*o-i*s,m=t*a-r*s,y=e*o-i*n,x=e*a-r*n,b=i*a-r*o,A=h*d-l*_,C=h*f-u*_,E=h*p-c*_,T=l*f-u*d,w=l*p-c*d,B=u*p-c*f,P=1/(v*B-g*w+m*T+y*E-x*C+b*A),R=new Ht;return R._m[0]=(n*B-o*w+a*T)*P,R._m[1]=(-e*B+i*w-r*T)*P,R._m[2]=(d*b-f*x+p*y)*P,R._m[3]=(-l*b+u*x-c*y)*P,R._m[4]=(-s*B+o*E-a*C)*P,R._m[5]=(t*B-i*E+r*C)*P,R._m[6]=(-_*b+f*m-p*g)*P,R._m[7]=(h*b-u*m+c*g)*P,R._m[8]=(s*w-n*E+a*A)*P,R._m[9]=(-t*w+e*E-r*A)*P,R._m[10]=(_*x-d*m+p*v)*P,R._m[11]=(-h*x+l*m-c*v)*P,R._m[12]=(-s*T+n*C-o*A)*P,R._m[13]=(t*T-e*C+i*A)*P,R._m[14]=(-_*y+d*g-f*v)*P,R._m[15]=(h*y-l*g+u*v)*P,R},Ht.prototype.transposeTo=function(){var t=new Ht;return t._m[0]=this._m[0],t._m[1]=this._m[4],t._m[2]=this._m[8],t._m[3]=this._m[12],t._m[4]=this._m[1],t._m[5]=this._m[5],t._m[6]=this._m[9],t._m[7]=this._m[13],t._m[8]=this._m[2],t._m[9]=this._m[6],t._m[10]=this._m[10],t._m[11]=this._m[14],t._m[12]=this._m[3],t._m[13]=this._m[7],t._m[14]=this._m[11],t._m[15]=this._m[15],t},Ht.prototype.setIdentity=function(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=0,this._m[5]=1,this._m[6]=0,this._m[7]=0,this._m[8]=0,this._m[9]=0,this._m[10]=1,this._m[11]=0,this._m[12]=0,this._m[13]=0,this._m[14]=0,this._m[15]=1,this},Ht.prototype.mul=function(t){let e=this._m[0],i=this._m[1],r=this._m[2],s=this._m[3],n=this._m[4],o=this._m[5],a=this._m[6],h=this._m[7],l=this._m[8],u=this._m[9],c=this._m[10],_=this._m[11],d=this._m[12],f=this._m[13],p=this._m[14],v=this._m[15],g=t._m[0],m=t._m[1],y=t._m[2],x=t._m[3],b=t._m[4],A=t._m[5],C=t._m[6],E=t._m[7],T=t._m[8],w=t._m[9],B=t._m[10],P=t._m[11],R=t._m[12],z=t._m[13],M=t._m[14],F=t._m[15];var S=new Ht;return S._m[0]=g*e+m*n+y*l+x*d,S._m[1]=g*i+m*o+y*u+x*f,S._m[2]=g*r+m*a+y*c+x*p,S._m[3]=g*s+m*h+y*_+x*v,S._m[4]=b*e+A*n+C*l+E*d,S._m[5]=b*i+A*o+C*u+E*f,S._m[6]=b*r+A*a+C*c+E*p,S._m[7]=b*s+A*h+C*_+E*v,S._m[8]=T*e+w*n+B*l+P*d,S._m[9]=T*i+w*o+B*u+P*f,S._m[10]=T*r+w*a+B*c+P*p,S._m[11]=T*s+w*h+B*_+P*v,S._m[12]=R*e+z*n+M*l+F*d,S._m[13]=R*i+z*o+M*u+F*f,S._m[14]=R*r+z*a+M*c+F*p,S._m[15]=R*s+z*h+M*_+F*v,S},Ht.prototype.translate=function(t){var e=t.x,i=t.y,r=t.z,s=this._m;return s[12]=s[0]*e+s[4]*i+s[8]*r+s[12],s[13]=s[1]*e+s[5]*i+s[9]*r+s[13],s[14]=s[2]*e+s[6]*i+s[10]*r+s[14],s[15]=s[3]*e+s[7]*i+s[11]*r+s[15],this},Ht.prototype.translateToPosition=function(t){var e=this._m;return e[12]=t.x,e[13]=t.y,e[14]=t.z,this},Ht.prototype.rotate=function(t,e){var i=Math.cos(e),r=Math.sin(e),s=new Ht,n=s._m;return n[0]=i+(1-i)*t.x*t.x,n[1]=(1-i)*t.y*t.x-r*t.z,n[2]=(1-i)*t.z*t.x+r*t.y,n[3]=0,n[4]=(1-i)*t.x*t.y+r*t.z,n[5]=i+(1-i)*t.y*t.y,n[6]=(1-i)*t.z*t.y-r*t.x,n[7]=0,n[8]=(1-i)*t.x*t.z-r*t.y,n[9]=(1-i)*t.y*t.z+r*t.x,n[10]=i+(1-i)*t.z*t.z,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,this.mul(s)},Ht.prototype.setRotation=function(t,e){var i=Math.cos(e),r=Math.sin(e),s=this._m;return s[0]=i+(1-i)*t.x*t.x,s[1]=(1-i)*t.y*t.x-r*t.z,s[2]=(1-i)*t.z*t.x+r*t.y,s[3]=0,s[4]=(1-i)*t.x*t.y+r*t.z,s[5]=i+(1-i)*t.y*t.y,s[6]=(1-i)*t.z*t.y-r*t.x,s[7]=0,s[8]=(1-i)*t.x*t.z-r*t.y,s[9]=(1-i)*t.y*t.z+r*t.x,s[10]=i+(1-i)*t.z*t.z,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this},Ht.prototype.rotateBetweenVectors=function(t,e){return Xt.getRotationBetweenVectors(t,e).getMat4()},Ht.prototype.scale=function(t){var e=this._m;return e[0]=e[0]*t.x,e[1]=e[1]*t.x,e[2]=e[2]*t.x,e[3]=e[3]*t.x,e[4]=e[4]*t.y,e[5]=e[5]*t.y,e[6]=e[6]*t.y,e[7]=e[7]*t.y,e[8]=e[8]*t.z,e[9]=e[9]*t.z,e[10]=e[10]*t.z,e[11]=e[11]*t.z,e[12]=e[12],e[13]=e[13],e[14]=e[14],e[15]=e[15],this},Ht.prototype.setFrustum=function(t,e,i,r,s,n){this.left=t,this.right=e,this.bottom=i,this.top=r,this.near=s,this.far=n;var o=e-t,a=r-i,h=n-s;return this._m[0]=2*s/o,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=0,this._m[5]=2*s/a,this._m[6]=0,this._m[7]=0,this._m[8]=(e+t)/o,this._m[9]=(r+i)/a,this._m[10]=-(n+s)/h,this._m[11]=-1,this._m[12]=0,this._m[13]=0,this._m[14]=-n*s*2/h,this._m[15]=0,this},Ht.prototype.setPerspective=function(t,e,i,r){return e*=t=i*Math.tan(t*Math.PI/360),this.setFrustum(-e,e,-t,t,i,r)},Ht.prototype.setOrtho=function(t,e,i,r,s,n){this.left=t,this.right=e,this.bottom=i,this.top=r,this.near=s,this.far=n;var o=1/(t-e),a=1/(i-r),h=1/(s-n),l=this._m;return l[0]=-2*o,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=-2*a,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=2*h,l[11]=0,l[12]=(t+e)*o,l[13]=(r+i)*a,l[14]=(n+s)*h,l[15]=1,this},Ht.prototype.eulerToMatrix=function(t,e,i){var r=Math.cos(t),s=Math.sin(t),n=Math.cos(e),o=Math.sin(e),a=Math.cos(i),h=Math.sin(i),l=r*o,u=s*o,c=this._m;return c[0]=n*a,c[1]=-n*h,c[2]=-o,c[4]=-u*a+r*h,c[5]=u*h+r*a,c[6]=-s*n,c[8]=l*a+s*h,c[9]=-l*h+s*a,c[10]=r*n,c[3]=c[7]=c[11]=c[12]=c[13]=c[14]=0,c[15]=1,this},Ht.prototype.getEulerAngles=function(){};const Xt=function(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=r||0};Xt.IDENTITY=new Xt(0,0,0,1),Xt.xRotation=function(t){return t*=.5,new Xt(Math.sin(t),0,0,Math.cos(t))},Xt.yRotation=function(t){return t*=.5,new Xt(0,Math.sin(t),0,Math.cos(t))},Xt.zRotation=function(t){return t*=.5,new Xt(0,0,Math.sin(t),Math.cos(t))},Xt.axisAngleToQuat=function(t,e){var i=new Xt,r=t.normal(),s=.5*e,n=Math.sin(s);return i.set(r.x*n,r.y*n,r.z*n,Math.cos(s)),i},Xt.getLookAtTargetUp=function(t,e){var i=t.normal();i=Wt.OrthoNormalize(e,i);var r=e.cross(i),s=new Xt;s.w=.5*Math.sqrt(1+r.x+e.y+i.z);var n=1/(4*s.w);return s.x=(i.y-e.z)*n,s.y=(r.z-i.x)*n,s.z=(e.x-r.y)*n,s},Xt.getLookAtSourceDest=function(t,e){var i=e.subA(t).normalize(),r=Wt.FORWARD.dot(i);if(Math.abs(r- -1)<1e-6)return Xt.axisAngleToQuat(Wt.UP,Math.PI);if(Math.abs(r-1)<1e-6)return new Xt(0,0,0,1);var s=Math.acos(r),n=Wt.FORWARD.cross(i).normalize();return Xt.axisAngleToQuat(n,s)},Xt.getRotationBetweenVectors=function(t,e){var i=t.cross(e);return new Xt(i.x,i.y,i.z,1+t.dot(e)).normalize()},Xt.getRotationBetweenVectorsUp=function(t,e,i){var r=t.dot(e);if(Math.abs(r+1)<1e-6)return Xt.axisAngleToQuat(i,Math.PI);if(Math.abs(r-1)<1e-6)return new Xt(0,0,0,1);var s=Math.acos(r),n=t.cross(e).normalize();return Xt.axisAngleToQuat(n,s)},Xt.prototype.clear=function(){return this.x=this.y=this.z=this.w=0,this},Xt.prototype.set=function(t,e,i,r){return this.x=t,this.y=e,this.z=i,this.w=r,this},Xt.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},Xt.prototype.setIdentity=function(){return this.x=0,this.y=0,this.z=0,this.w=1,this},Xt.prototype.clone=function(){return new Xt(this.x,this.y,this.z,this.w)},Xt.prototype.add=function(t){return new Xt(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)},Xt.prototype.sub=function(t){return new Xt(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)},Xt.prototype.scaleTo=function(t){return new Xt(this.x*t,this.y*t,this.z*t,this.w*t)},Xt.prototype.toVec=function(){return[this.x,this.y,this.z,this.w]},Xt.prototype.setFromSphericalCoords=function(t,e,i){var r=Math.sin(i/2),s=Math.cos(i/2),n=Math.sin(t),o=Math.cos(t),a=Math.sin(e),h=Math.cos(e);return this.x=r*o*a,this.y=r*n,this.z=r*n*h,this.w=s,this},Xt.prototype.toSphericalCoords=function(){var t=this.w,e=Math.sqrt(1-t*t);Math.acos(t);Math.abs(e)<5e-4&&(e=1);var i,r=this.x/e,s=this.y/e,n=this.z/e,o=-Math.asin(s);return(i=r*r+n*n<5e-4?0:Math.atan2(r,n))<0&&(i+=360),{lat:o,lon:i,alpha:Math.acos(t)}},Xt.prototype.setFromAxisAngle=function(t,e){var i=t.normal(),r=.5*e,s=Math.sin(r);return this.set(i.x*s,i.y*s,i.z*s,Math.cos(r)),this},Xt.prototype.getAxisAngle=function(){var t,e,i=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);if(i>1e-7){var r=1/i;t=new Wt(x*r,y*r,z*r),e=this.w<0?2*Math.atan2(-i,-w):2*Math.atan2(i,w)}else t=new Wt(0,0,0),e=0;return{axis:t,angle:e}},Xt.prototype.setFromEulerAngles=function(t,e,i){var r,s,n,o,a,h,l,u,c,_,d;return r=t*A/2,s=e*A/2,n=i*A/2,o=Math.cos(r),a=Math.cos(s),h=Math.cos(n),l=Math.sin(r),_=a*h,d=(u=Math.sin(s))*(c=Math.sin(n)),this.w=o*_+l*d,this.x=l*_-o*d,this.y=o*u*h+l*a*c,this.z=o*a*c-l*u*h,this.normalize()},Xt.prototype.getEulerAngles=function(){return this.getMat4().getEulerAngles()},Xt.prototype.setFromMatrix4=function(t){var e,i,r,s,n,o=[],a=[1,2,0];return(e=(t=t._m)[0]+t[5]+t[10])>0?(i=Math.sqrt(e+1),this.w=i/2,i=.5/i,this.x=(t[6]-t[9])*i,this.y=(t[8]-t[2])*i,this.z=(t[1]-t[4])*i):(r=0,t[5]>t[0]&&(r=1),t[10]>t[5*r]&&(r=2),n=a[s=a[r]],i=Math.sqrt(t[5*r]-(t[5*s]+t[5*n])+1),o[r]=.5*i,0!=i&&(i=.5/i),o[3]=(t[4*s+n]-t[4*n+s])*i,o[s]=(t[4*r+s]+t[4*s+r])*i,o[n]=(t[4*r+n]+t[4*n+r])*i,this.x=o[0],this.y=o[1],this.z=o[2],this.w=o[3]),this},Xt.prototype.getMat4=function(){var t=new Ht,e=t._m,i=this.x,r=this.y,s=this.z,n=this.w,o=i+i,a=r+r,h=s+s,l=i*o,u=i*a;i*=h;var c=r*a;return r*=h,s*=h,o*=n,a*=n,n*=h,e[0]=1-(c+s),e[1]=u-n,e[2]=i+a,e[3]=0,e[4]=u+n,e[5]=1-(l+s),e[6]=r-o,e[7]=0,e[8]=i-a,e[9]=r+o,e[10]=1-(l+c),e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,t},Xt.prototype.mulVec3=function(t){var e=t.x,i=t.y,r=t.z,s=this.x,n=this.y,o=this.z,a=this.w,h=a*e+n*r-o*i,l=a*i+o*e-s*r,u=a*r+s*i-n*e;return new Wt(h*a+(e=-s*e-n*i-o*r)*-s+l*-o-u*-n,l*a+e*-n+u*-s-h*-o,u*a+e*-o+h*-n-l*-s)},Xt.prototype.mul=function(t){var e=this.x,i=this.y,r=this.z,s=this.w,n=t.x,o=t.y,a=t.z,h=t.w;return new Xt(e*h+s*n+i*a-r*o,i*h+s*o+r*n-e*a,r*h+s*a+e*o-i*n,s*h-e*n-i*o-r*a)},Xt.prototype.conjugate=function(){return new Xt(-this.x,-this.y,-this.z,this.w)},Xt.prototype.inverse=function(){var t=1/this.magnitude2();return new Xt(-this.x*t,-this.y*t,-this.z*t,this.w*t)},Xt.prototype.magnitude=function(){var t=this.x,e=this.y,i=this.z,r=this.w;return Math.sqrt(t*t+e*e+i*i+r*r)},Xt.prototype.magnitude2=function(){var t=this.x,e=this.y,i=this.z,r=this.w;return t*t+e*e+i*i+r*r},Xt.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},Xt.prototype.normalize=function(){var t=this.x,e=this.y,i=this.z,r=this.w,s=Math.sqrt(t*t+e*e+i*i+r*r);return 0==s?(this.x=0,this.y=0,this.z=0,this.w=0,this):(s=1/s,this.x=t*s,this.y=e*s,this.z=i*s,this.w=r*s,this)},Xt.prototype.isEqual=function(t){var e=this.dot(t);return Math.abs(e-1)<.001},Xt.prototype.slerp=function(t,e){var i,r,s,n,o,a=this.x,h=this.y,l=this.z,u=this.w,c=t.x,_=t.y,d=t.z,f=t.w;return(r=a*c+h*_+l*d+u*f)<0&&(r=-r,c=-c,_=-_,d=-d,f=-f),1-r>1e-6?(i=Math.acos(r),s=Math.sin(i),n=Math.sin((1-e)*i)/s,o=Math.sin(e*i)/s):(n=1-e,o=e),new Xt(n*a+o*c,n*h+o*_,n*l+o*d,n*u+o*f)},Xt.prototype.getRoll=function(t){var e=this.x,i=this.y,r=this.z,s=this.w;if(t){var n=2*i,o=2*r,a=o*s,h=n*e,l=n*i,u=o*r;return Math.atan2(h+a,1-(l+u))}return Math.atan2(2*(e*i+s*r),s*s+e*e-i*i-r*r)},Xt.prototype.getPitch=function(t){var e=this.x,i=this.y,r=this.z,s=this.w;if(t){var n=2*e,o=2*r,a=n*s,h=n*e,l=o*i,u=o*r;return Math.atan2(l+a,1-(h+u))}return Math.atan2(2*(i*r+s*e),s*s-e*e-i*i+r*r)},Xt.prototype.getYaw=function(t){var e=this.x,i=this.y,r=this.z,s=this.w;if(t){var n=2*i,o=n*s,a=2*e*e,h=2*r*e,l=n*i;return Math.atan2(h+o,1-(a+l))}return Math.asin(-2*(e*r-s*i))};const Wt=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0};Wt.UP=new Wt(0,1,0),Wt.DOWN=new Wt(0,-1,0),Wt.RIGHT=new Wt(1,0,0),Wt.LEFT=new Wt(-1,0,0),Wt.FORWARD=new Wt(0,0,-1),Wt.BACKWARD=new Wt(0,0,1),Wt.ZERO=new Wt,Wt.fromVec=function(t){return new Wt(t[0],t[1],t[2])},Wt.angle=function(t,e){return Math.acos(t.dot(e)/Math.sqrt(t.length2()*e.length2()))},Wt.lerp=function(t,e,i){return Wt(t.x+(e.x-t.x)*i,t.y+(e.y-t.y)*i,t.z+(e.z-t.z)*i)},Wt.add=function(t,e){var i=new Wt(t.x,t.y,t.z);return i.addA(e),i},Wt.sub=function(t,e){var i=new Wt(t.x,t.y,t.z);return i.subA(e),i},Wt.scale=function(t,e){var i=new Wt(t.x,t.y,t.z);return i.scale(e),i},Wt.mul=function(t,e){var i=new Wt(t.x,t.y,t.z);return i.mulA(e),i},Wt.noncollinear=function(t,e){return t.y*e.z-t.z*e.y||t.z*e.x-t.x*e.z||t.x*e.y-t.y*e.z},Wt.proj_b_to_plane=function(t,e,i){var r=t.sub(e.scaleTo(e.dot(t)/e.dot(e)));return i&&r.isZero()?new Wt(i.x,i.y,i.z):r},Wt.proj_b_to_a=function(t,e){return e.scaleTo(e.dot(t)/e.dot(e))},Wt.orthoNormalize=function(t,e){return(t=t.normal()).scale(e.dot(t)),e.subA(t).normalize()},Wt.div=function(t,e){var i=new Wt(t.x,t.y,t.z);return i.divA(e),i},Wt.prototype.toVec4=function(){return new Ut(this.x,this.y,this.z,1)},Wt.prototype.clone=function(){return new Wt(this.x,this.y,this.z)},Wt.prototype.toString=function(){return"("+this.x+","+this.y+","+this.z+")"},Wt.prototype.isZero=function(){return!(this.x||this.y||this.z)},Wt.prototype.projToVec=function(t){return t.scaleTo(t.dot(this)/t.dot(t))},Wt.prototype.equal=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},Wt.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},Wt.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},Wt.prototype.length2=function(){return this.x*this.x+this.y*this.y+this.z*this.z},Wt.prototype.getQuat=function(){return new Xt(this.x,this.y,this.z)},Wt.prototype.addA=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},Wt.prototype.add=function(t){return new Wt(this.x+t.x,this.y+t.y,this.z+t.z)},Wt.prototype.subA=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},Wt.prototype.sub=function(t){return new Wt(this.x-t.x,this.y-t.y,this.z-t.z)},Wt.prototype.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this},Wt.prototype.scaleTo=function(t){return new Wt(this.x*t,this.y*t,this.z*t)},Wt.prototype.mulA=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},Wt.prototype.mul=function(t){return new Wt(this.x*t.x,this.y*t.y,this.z*t.z)},Wt.prototype.divA=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},Wt.prototype.div=function(t){return new Wt(this.x/t.x,this.y/t.y,this.z/t.z)},Wt.prototype.dot=function(t){return t.x*this.x+t.y*this.y+t.z*this.z},Wt.prototype.dotArr=function(t){return t[0]*this.x+t[1]*this.y+t[2]*this.z},Wt.prototype.cross=function(t){return new Wt(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},Wt.prototype.clear=function(){return this.x=this.y=this.z=0,this},Wt.prototype.normal=function(){var t=new Wt;t.copy(this);var e=1/t.length();return t.x*=e,t.y*=e,t.z*=e,t},Wt.prototype.normalize=function(){var t=1/this.length();return this.x*=t,this.y*=t,this.z*=t,this},Wt.prototype.toVec=function(){return[this.x,this.y,this.z]},Wt.prototype.toArray=function(){return[this.x,this.y,this.z]},Wt.prototype.distance=function(t){return Wt.sub(this,t).length()},Wt.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},Wt.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},Wt.prototype.negateTo=function(){return new Wt(-this.x,-this.y,-this.z)},Wt.prototype.projToRay=function(t,e){var i=Wt.proj_b_to_a(Wt.sub(this,t),e);return i.addA(t),i},Wt.prototype.angle=function(t){return Wt.angle(this,t)},Wt.prototype.lerp=function(t,e){return new Wt(this.x+(t.x-this.x)*e,this.y+(t.y-this.y)*e,this.z+(t.z-this.z)*e)},Wt.prototype.smerp=function(t,e){var i=1-e;return new Wt(this.x*e+t.x*i,this.y*e+t.y*i,this.z*e+t.z*i)},Wt.LERP_DELTA=1e-6,Wt.prototype.slerp=function(t,e){var i=new Wt;if(e<=0)i.copy(this);else{if(!(e>=1)){var r,s,n,o,a=this.dot(t);return 1-a>Wt.LERP_DELTA?(r=Math.acos(a),s=Math.sin(r),n=Math.sin((1-e)*r)/s,o=Math.sin(e*r)/s):(n=1-e,o=e),Wt.add(this.scaleTo(n),t.scale(o))}i.copy(t)}};const Yt=function(t,e){this.x=t||0,this.y=e||0};function jt(t){return null==t}Yt.UP=new Yt(0,1),Yt.DOWN=new Yt(0,-1),Yt.RIGHT=new Yt(1,0),Yt.LEFT=new Yt(-1,0),Yt.ZERO=new Yt,Yt.add=function(t,e){var i=new Yt(t.x,t.y);return i.addA(e),i},Yt.sub=function(t,e){var i=new oVec2(t.x,t.y);return i.subA(e),i},Yt.scale=function(t,e){var i=new Yt(t.x,t.y);return i.scale(e),i},Yt.mul=function(t,e){var i=new Yt(t.x,t.y);return i.mulA(e),i},Yt.div=function(t,e){var i=new Yt(t.x,t.y);return i.divA(e),i},Yt.proj_b_to_a=function(t,e){return e.scaleTo(e.dot(t)/e.dot(e))},Yt.angle=function(t,e){return Math.acos(t.dot(e)/Math.sqrt(t.length2()*e.length2()))},Yt.orthoNormalize=function(t,e){return(t=t.norm()).scale(e.dot(t)),e.sub(t).normalize()},Yt.prototype.toVector3=function(){return new Wt(this.x,this.y,0)},Yt.prototype.clone=function(){return new Yt(this.x,this.y)},Yt.prototype.equal=function(t){return this.x===t.x&&this.y===t.y},Yt.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this},Yt.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Yt.prototype.length2=function(){return this.x*this.x+this.y*this.y},Yt.prototype.addA=function(t){return this.x+=t.x,this.y+=t.y,this},Yt.prototype.add=function(t){return new Yt(this.x+t.x,this.y+t.y)},Yt.prototype.subA=function(t){return this.x-=t.x,this.y-=t.y,this},Yt.prototype.sub=function(t){return new Yt(this.x-t.x,this.y-t.y)},Yt.prototype.scale=function(t){return this.x*=t,this.y*=t,this},Yt.prototype.scaleTo=function(t){return new Yt(this.x*t,this.y*t)},Yt.prototype.mulA=function(t){return this.x*=t.x,this.y*=t.y,this},Yt.prototype.mul=function(t){return new Yt(this.x*t.x,this.y*t.y)},Yt.prototype.divA=function(t){return this.x/=t.x,this.y/=t.y,this},Yt.prototype.dot=function(t){return t.x*this.x+t.y*this.y},Yt.prototype.dotArr=function(t){return t[0]*this.x+t[1]*this.y},Yt.prototype.cross=function(t){return this.x*t.y-this.y*t.x},Yt.prototype.clear=function(){return this.x=this.y=0,this},Yt.prototype.normal=function(){var t=new Yt;t.copy(this);var e=1/t.length();return t.x*=e,t.y*=e,t},Yt.prototype.normalize=function(){var t=1/this.length();return this.x*=t,this.y*=t,this},Yt.prototype.toVec=function(){return[this.x,this.y]},Yt.prototype.distance=function(t){return Yt.sub(this,t).length()},Yt.prototype.set=function(t,e){return this.x=t,this.y=e,this},Yt.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},Yt.prototype.negateTo=function(){return new Yt(-this.x,-this.y)},Yt.prototype.projToRay=function(t,e){var i=Yt.proj_b_to_a(Yt.sub(this,t),e);return i.add(t),i},Yt.prototype.angle=function(t){return Yt.angle(this,t)},Yt.prototype.lerp=function(t,e,i){var r=Yt.clone(this);return i<=0?r.copy(t):i>=1?r.copy(e):r=Yt.add(t,Yt.sub(e,t).scale(i)),r},Yt.LERP_DELTA=1e-6,Yt.prototype.slerp=function(t,e){var i=new Yt;if(e<=0)i.copy(this);else{if(!(e>=1)){var r,s,n,o,a=this.dot(t);return 1-a>Yt.LERP_DELTA?(r=Math.acos(a),s=Math.sin(r),n=Math.sin((1-e)*r)/s,o=Math.sin(e*r)/s):(n=1-e,o=e),Yt.add(this.scale(n),t.scale(o))}i.copy(t)}},"createImageBitmap"in window||(window.createImageBitmap=function(t){return new Promise((e,i)=>{let r=document.createElement("img");r.addEventListener("load",function(){e(this)}),r.src=URL.createObjectURL(t)})});let Gt=0;function qt(t){var e=t._openglobus_id;return e||(e=t._openglobus_id=++Gt),e}function Kt(t){return"string"==typeof t||t instanceof String}function Zt(t){var e="";return o.request(t,{async:!1,success:function(t){e=t}}),e}function Qt(t,e){var i=h[t];if(i&&(t=i),"#"===t[0]){var r=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(t,e,i,r){return e+e+i+i+r+r}),s=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(r);return new Ut(parseInt(s[1],16)/255,parseInt(s[2],16)/255,parseInt(s[3],16)/255,jt(e)?1:e)}jt(e)&&(e=1);var n=t.split(",");return new Ut(parseInt(n[0].split("(")[1])/255,parseInt(n[1])/255,parseInt(n[2])/255,jt(n[3])?e:parseFloat(n[3]))}function Jt(t){var e=h[t];if(e&&(t=e),"#"===t[0]){var i=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(t,e,i,r){return e+e+i+i+r+r}),r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(i);return new Ut(parseInt(r[1],16)/255,parseInt(r[2],16)/255,parseInt(r[3],16)/255)}var s=t.split(",");return new Wt(parseInt(s[0].split("(")[1])/255,parseInt(s[1])/255,parseInt(s[2])/255)}function $t(t,e){return t.replace(/{[^{}]+}/g,function(t){return e[t.replace(/[{}]+/g,"")]||""})}function te(t,e,i,r){var s=document.getElementById(t);s||((s=document.createElement("div")).id=t,s.classList.add("defaultText"),document.body.appendChild(s)),s.innerHTML=e,s.style.left=i,s.style.top=r}function ee(t,e){return t?t.trim().toLowerCase():e}function ie(t,e){if(t){if(t instanceof Wt)return t.clone();if(t instanceof Array)return Wt.fromVec(t)}else if(e)return e;return new Wt}function re(t,e){if(t){if(t instanceof Ut)return t.clone();if(t instanceof Array)return Ut.fromVec(t)}else if(e)return e;return new Ut}function se(t,e){if(t){if(Kt(t))return Qt(t);if(t instanceof Array)return new Ut.fromVec(t);if(t instanceof Ut)return t.clone()}else if(e)return e;return new Ut(1,1,1,1)}function ne(t,e){if(t){if(Kt(t))return Jt(t);if(t instanceof Array)return new Wt.fromVec(t);if(t instanceof Wt)return t.clone()}else if(e)return e;return new Wt(1,1,1)}function oe(t,e){if(t){if(t instanceof Array)return new Ot(ae(t[0]),ae(t[1]));if(t instanceof Ot)return t.clone()}else if(e)return e;return new Ot}function ae(t,e){if(t){if(t instanceof Array)return new kt(t[0],t[1],t[2]);if(t instanceof kt)return t.clone()}else if(e)return e;return new kt}function he(t,e,i){for(var r=0,s=t.length-1;r<=s;){var n=s+r>>1,o=i(e,t[n],n);if(o>0)r=n+1;else{if(!(o<0))return n;s=n-1}}return-r-1}function le(t,e,i){var r=he(t,e,i);return r<0&&(r=~r),t.splice(r,0,e),r}function ue(t,e,i,r,s){var n=e.sub(t),o=r.sub(i),a=-n.y,h=+n.x,l=-(a*t.x+h*t.y),u=-o.y,c=+o.x,_=-(u*i.x+c*i.y),d=u*t.x+c*t.y+_,f=u*e.x+c*e.y+_,p=a*i.x+h*i.y+l,v=a*r.x+h*r.y+l;if(s&&(d*f>0||p*v>0))return null;var g=d/(d-f);return new Yt(t.x+g*n.x,t.y+g*n.y)}function ce(t,e,i,r,s){var n=new kt(e.lon-t.lon,e.lat-t.lat),o=new kt(r.lon-i.lon,r.lat-i.lat),a=-n.lat,h=+n.lon,l=-(a*t.lon+h*t.lat),u=-o.lat,c=+o.lon,_=-(u*i.lon+c*i.lat),d=u*t.lon+c*t.lat+_,f=u*e.lon+c*e.lat+_,p=a*i.lon+h*i.lat+l,v=a*r.lon+h*r.lat+l;if(s&&(d*f>0||p*v>0))return null;var g=d/(d-f);return new kt(t.lon+g*n.lon,t.lat+g*n.lat)}function _e(t){var e={};if(1===t.nodeType){if(t.attributes.length>0){e["@attributes"]={};for(var i=0;i<t.attributes.length;i++){var r=t.attributes.item(i);e["@attributes"][r.nodeName]=r.nodeValue}}}else 3===t.nodeType&&(e=t.nodeValue);if(t.hasChildNodes())for(var s=0;s<t.childNodes.length;s++){var n=t.childNodes.item(s),o=n.nodeName;if(void 0===e[o])e[o]=_e(n);else{if(void 0===e[o].push){var a=e[o];e[o]=[],e[o].push(a)}e[o].push(_e(n))}}return e}const de={string:function(t){return jt(t)?t:t.toString()},date:function(t){return jt(t)?t:new Date(1e3*t)},datetime:function(t){return jt(t)?t:new Date(1e3*t)},time:function(t){return jt(t)?t:parseInt(t)},integer:function(t){return jt(t)?t:parseInt(t)},float:function(t){return jt(t)?t:parseFloat(t)},boolean:function(t){if(null===t)return t;if("boolean"==typeof t)return!0===t;if("string"==typeof t){if(""===t)return!1;if("true"===(t=t.replace(/^\s+|\s+$/g,"")).toLowerCase()||"yes"===t.toLowerCase())return!0;t=(t=t.replace(/,/g,".")).replace(/^\s*\-\s*/g,"-")}return!isNaN(t)&&0!==parseFloat(t)}};function fe(t,e){e=e||"";for(var i=atob(t),r=i.length,s=Math.ceil(r/1024),n=new Array(s),o=0;o<s;++o){for(var a=1024*o,h=Math.min(a+1024,r),l=new Array(h-a),u=a,c=0;u<h;++c,++u)l[c]=i[u].charCodeAt(0);n[o]=new Uint8Array(l)}return new Blob(n,{type:e})}const pe=.001,ve=1e3,ge=60,me=1/ge,ye=60,xe=24,be=1/xe,Ae=3600,Ce=1/Ae,Ee=12*Ae,Te=1440,we=1/Te,Be=86400,Pe=864e5,Re=1/Pe,ze=1/Be,Me=36525,Fe=365.25,Se=1e-9,De=2400000.5,Le=2451545;function Ne(t){return(t-Le)/Me}function Ie(t,e,i){var r=(e-14)/12|0,s=t+4800+r;return(1461*s/4|0)+(367*(e-2-12*r)/12|0)-(3*((s+100)/100|0)/4|0)+i-32075}function ke(t){var e=Ie(t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate()),i=t.getUTCHours()-12;i<0&&(i+=24);var r=t.getUTCSeconds()+i*Ae+t.getUTCMinutes()*ge+t.getUTCMilliseconds()*pe;r>=Ee&&e--;var s=r*ze|0;return e+=s,(r-=Be*s)<0&&(e--,r+=Be),e+r*ze}function Oe(t){return Ue(ke(t))}function Ue(t){var e=ri,i=he(e,t,function(t,e){return t-e.jd});i<0&&(i=~i),i>=e.length&&(i=e.length-1);var r=e[i].leapSeconds;return 0!==i&&(e[i].jd-t)*Be>r&&(r=e[i-1].leapSeconds),t+r*ze}function Ve(t){var e=ri,i=he(e,t,function(t,e){return t-e.jd});if(i<0&&(i=~i),i>=e.length)return t-e[i-1].leapSeconds*ze;if(0===i)return t-e[0].leapSeconds*ze;var r=(e[i].jd-t)*Be;return 0===r?t-e[i].leapSeconds*ze:r<=1?null:t-e[i-1].leapSeconds*ze}function He(t){var e=0|t,i=(t-e)*Be;i>=Ee&&e++;var r=e+68569|0,s=4*r/146097|0,n=4e3*((r=r-((146097*s+3)/4|0)|0)+1)/1461001|0,o=80*(r=r-(1461*n/4|0)+31|0)/2447|0,a=r-(2447*o/80|0)|0,h=o+2-12*(r=o/11|0)|0,l=100*(s-49)+n+r|0,u=i*Ce|0,c=i-u*Ae,_=c*me|0,d=0|(c-=_*ge),f=(c-d)*ve|0;return(u+=12)>23&&(u-=24),new Date(Date.UTC(l,h-1,a,u,_,d,f))}function Xe(t){var e=Ve(t);return e||(e=Ve(Ye(t,-1)),og.console.logWrn("TAItoDate:336 - can't conv utc.")),He(e)}function We(t,e){return t+e*Re}function Ye(t,e){return t+e*ze}function je(t,e){return t+e*be}function Ge(t,e){return t+e*Te}function qe(t,e){return t+e}function Ke(t){var e=t-(0|t);return((e*=Be)-(0|e))*ve|0}function Ze(t){return(t-(0|t))*Be}function Qe(t){var e=(t-(0|t))*Be,i=e*Ce|0,r=e-i*Ae,s=r*me|0,n=0|(r-=s*ge);return(i+=12+s/60+n/3600+((r-n)*ve|0)/1e3)>23&&(i-=24),i}function Je(t){return(t-(0|t))*Te|0}function $e(t){return 0|t}function ti(t){return t*ze}function ei(t){return t*Be}function ii(t,e){return{jd:t,leapSeconds:e}}const ri=[ii(2441317.5,10),ii(2441499.5,11),ii(2441683.5,12),ii(2442048.5,13),ii(2442413.5,14),ii(2442778.5,15),ii(2443144.5,16),ii(2443509.5,17),ii(2443874.5,18),ii(2444239.5,19),ii(2444786.5,20),ii(2445151.5,21),ii(2445516.5,22),ii(2446247.5,23),ii(2447161.5,24),ii(2447892.5,25),ii(2448257.5,26),ii(2448804.5,27),ii(2449169.5,28),ii(2449534.5,29),ii(2450083.5,30),ii(2450630.5,31),ii(2451179.5,32),ii(2453736.5,33),ii(2454832.5,34),ii(2456109.5,35),ii(2457204.5,36)],si=Ue(Le);class ni{constructor(t){t=t||{},this._id=ni.__staticCounter++,this._name=t.name||"_control_"+this._id,this._initialized=!1,this.renderer=null,this.autoActivate=void 0==t.autoActivate||t.autoActivate,this._active=!1}static get __staticCounter(){return this.__counter||0===this.__counter||(this.__counter=0),this.__counter}static set __staticCounter(t){this.__counter=t}get name(){return this._name}oninit(){}onadd(){}onremove(){}onactivate(){}ondeactivate(){}addTo(t){t&&(this.renderer=t,t.controls[this.name]=this,this.onadd&&this.onadd(),this.autoActivate&&(this.oninit&&this.oninit(),this._initialized=!0,this._active=!0))}remove(){this.onremove&&this.onremove(),this.renderer=null,this._active=!1,this._initialized=!1}activate(){this._active=!0,this.onactivate&&this.onactivate()}deactivate(){this._active=!1,this.ondeactivate&&this.ondeactivate()}isActive(){return this._active}isEqual(t){return t._id===this._id}}"createImageBitmap"in window||(window.createImageBitmap=function(t){return new Promise((e,i)=>{let r=document.createElement("img");r.addEventListener("load",function(){e(this)}),r.src=URL.createObjectURL(t)})});class oi extends ni{constructor(t){(t=t||{}).name&&""!==t.name||(t.name="DebugInfo"),super(t),this.el=null,this._watch=t.watch||[]}addWatches(t){for(var e=0;e<t.length;e++)this.addWatch(t[e])}addWatch(t){this._watch.push(t);let e=document.createElement("div");e.classList.add("og-watch-line"),e.innerHTML='<div class="og-watch-label">'+t.label+'</div><div class="og-watch-value"></div>',t.valEl=e.querySelector(".og-watch-value"),this.el.appendChild(e)}oninit(){this.el=document.createElement("div"),this.el.className="og-debug-info";var t=this._watch;this._watch=[];for(var e=0;e<t.length;e++)this.addWatch(t[e]);this.renderer.div.appendChild(this.el),this.renderer.events.on("draw",this._frame,this);let i=this.planet;i&&this.addWatches([{label:"Nodes count",frame:()=>i._renderedNodes.length},{label:"createdNodes",frame:()=>i._createdNodesCount},{label:"maxZoom/minZoom",frame:()=>i.maxCurrZoom+"/"+i.minCurrZoom},{label:"height/alt (km)",frame:()=>(i.camera._lonLat.height/1e3).toFixed(2)+"/"+(i.camera.getAltitude()/1e3).toFixed(2)},{label:"cam.slope",frame:()=>i.camera.slope},{label:"lodRatio",frame:()=>i._lodRatio},{label:"-------------------------"},{label:"PlainWorker",frame:()=>i._plainSegmentWorker._pendingQueue.length},{label:"TileLoader",frame:()=>i._tileLoader._loading+" "+i._tileLoader._queue.length},{label:"TerrainLoader",frame:()=>i.terrain&&i.terrain._loader?i.terrain._loader._loading+" "+i.terrain._loader._queue.length:""},{label:"TerrainWorker",frame:()=>i._terrainWorker._pendingQueue.length},{label:"NormalMapCreator",frame:()=>i._normalMapCreator._queue.length}])}_frame(){for(var t=0;t<this._watch.length;t++){var e=this._watch[t];e.valEl.innerHTML=e.frame?e.frame():""}}}const ai={KEY_SHIFT:16,KEY_SPACE:32,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_A:65,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_H:72,KEY_L:76,KEY_Q:81,KEY_S:83,KEY_V:86,KEY_W:87,KEY_X:88,KEY_F1:112,KEY_APOSTROPHE:192,MB_LEFT:0,MB_RIGHT:2,MB_MIDDLE:1};class hi extends ni{constructor(t){super(t=t||{}),this.camera=null,this.speed=t.speed||1}oninit(){this.camera=this.renderer.activeCamera,this.renderer.events.on("keypress",ai.KEY_W,this.onCameraMoveForward,this),this.renderer.events.on("keypress",ai.KEY_S,this.onCameraMoveBackward,this),this.renderer.events.on("keypress",ai.KEY_A,this.onCameraStrifeLeft,this),this.renderer.events.on("keypress",ai.KEY_D,this.onCameraStrifeRight,this),this.renderer.events.on("keypress",ai.KEY_UP,this.onCameraLookUp,this),this.renderer.events.on("keypress",ai.KEY_DOWN,this.onCameraLookDown,this),this.renderer.events.on("keypress",ai.KEY_LEFT,this.onCameraTurnLeft,this),this.renderer.events.on("keypress",ai.KEY_RIGHT,this.onCameraTurnRight,this),this.renderer.events.on("keypress",ai.KEY_Q,this.onCameraRollLeft,this),this.renderer.events.on("keypress",ai.KEY_E,this.onCameraRollRight,this)}onCameraMoveForward(t){var e=this.camera;e.slide(0,0,-this.speed),e.update()}onCameraMoveBackward(t){var e=this.camera;e.slide(0,0,this.speed),e.update()}onCameraStrifeLeft(t){var e=this.camera;e.slide(-this.speed,0,0),e.update()}onCameraStrifeRight(t){var e=this.camera;e.slide(this.speed,0,0),e.update()}onCameraLookUp(t){var e=this.camera;e.pitch(.5),e.update()}onCameraLookDown(t){var e=this.camera;e.pitch(-.5),e.update()}onCameraTurnLeft(t){var e=this.camera;e.yaw(.5),e.update()}onCameraTurnRight(t){var e=this.camera;e.yaw(-.5),e.update()}onCameraRollLeft(t){var e=this.camera;e.roll(-.5),e.update()}onCameraRollRight(t){var e=this.camera;e.roll(.5),e.update()}}class li extends ni{constructor(t){super(t)}oninit(){var t=document.createElement("div");t.className="defaultText ",t.id="ogShowFpsControl",document.body.appendChild(t),this.renderer.events.on("draw",this._draw,this)}_draw(){te("ogShowFpsControl",(1e3/this.renderer.handler.deltaTime).toFixed(1),this.renderer.handler.canvas.clientWidth-60,0)}}class ui{constructor(t){t=t||{},this.id=ui._staticCounter++,this._position=ie(t.position),this._rotation=t.rotation||0,this._color=se(t.color),this._alignedAxis=ie(t.alignedAxis),this._offset=ie(t.offset),this._visibility=void 0==t.visibility||t.visibility,this._scale=t.scale||1,this._entity=null,this._handler=null,this._handlerIndex=-1}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}setPosition(t,e,i){this._position.x=t,this._position.y=e,this._position.z=i,this._handler&&this._handler.setPositionArr(this._handlerIndex,this._position)}setPosition3v(t){this._position.x=t.x,this._position.y=t.y,this._position.z=t.z,this._handler&&this._handler.setPositionArr(this._handlerIndex,t)}getPosition(){return this._position}setOffset(t,e,i){this._offset.x=t,this._offset.y=e,void 0!=i&&(this._offset.z=i),this._handler&&this._handler.setOffsetArr(this._handlerIndex,this._offset)}setScale(t){this._scale=t,this._handler&&this._handler.setScaleArr(this._handlerIndex,t)}getScale(){return this._scale}setOffset3v(t){this._offset.x=t.x,this._offset.y=t.y,void 0!=t.z&&(this._offset.z=t.z),this._handler&&this._handler.setOffsetArr(this._handlerIndex,t)}getOffset(){return this._offset}setRotation(t){this._rotation=t,this._handler&&this._handler.setRotationArr(this._handlerIndex,t)}getRotation(){return this._rotation}setOpacity(t){this._color.w=t,this.setColor(this._color.x,this._color.y,this._color.z,t)}setColor(t,e,i,r){this._color.x=t,this._color.y=e,this._color.z=i,void 0!=r&&(this._color.w=r),this._handler&&this._handler.setRgbaArr(this._handlerIndex,this._color)}setColor4v(t){this._color.x=t.x,this._color.y=t.y,this._color.z=t.z,void 0!=t.w&&(this._color.w=t.w),this._handler&&this._handler.setRgbaArr(this._handlerIndex,t)}setColorHTML(t){this.setColor4v(Qt(t))}getColor(){return this._color}setVisibility(t){this._visibility=t,this._handler&&this._handler.setVisibility(this._handlerIndex,t)}getVisibility(){return this._visibility}setAlignedAxis(t,e,i){this._alignedAxis.x=t,this._alignedAxis.y=e,this._alignedAxis.z=i,this._handler&&this._handler.setAlignedAxisArr(this._handlerIndex,this._alignedAxis)}setAlignedAxis3v(t){this._alignedAxis.x=t.x,this._alignedAxis.y=t.y,this._alignedAxis.z=t.z,this._handler&&this._handler.setAlignedAxisArr(this._handlerIndex,t)}getAlignedAxis(){return this._alignedAxis}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._handler&&this._handler.setPickingColorArr(this._handlerIndex,t)}}class ci extends ui{constructor(t){super(t),t=t||{},this._src=t.src||null,this._image=t.image||null,this._width=t.width||(t.size?t.size[0]:30),this._height=t.height||(t.size?t.size[1]:30)}setSrc(t){this._src=t;var e=this._handler;if(e&&t){var i=e._entityCollection.renderNode;if(i){var r=i.billboardsTextureAtlas,s=this;r.loadImage(t,function(t){r.nodes[t.__nodeIndex]?(s._image=t,e.setTexCoordArr(s._handlerIndex,r.nodes[s._image.__nodeIndex].texCoords)):(r.addImage(t),r.createTexture(),s._image=t,i.updateBillboardsTexCoords())})}}}setImage(t){this.setSrc(t.src)}setSize(t,e){this._width=t,this._height=e,this._handler&&this._handler.setSizeArr(this._handlerIndex,t*this._scale,e*this._scale)}getSize(){return{width:this._width,height:this._height}}setWidth(t){this.setSize(t,this._height)}getWidth(){return this._width}setHeight(t){this.setSize(this._width,t)}getHeight(){return this._height}}const _i={POINT:1,LINESTRING:2,POLYGON:3,MULTIPOLYGON:4,MULTILINESTRING:5};class di{constructor(t){this._id=di._staticCounter++,(t=t||{}).style=t.style||{},this._entity=null,this._handler=null,this._handlerIndex=-1,this._polyVerticesMerc=[],this._polyVerticesLength=-1,this._polyIndexesLength=-1,this._polyVerticesHandlerIndex=-1,this._polyIndexesHandlerIndex=-1,this._lineVerticesMerc=[],this._lineVerticesLength=-1,this._lineOrdersLength=-1,this._lineIndexesLength=-1,this._lineColorsLength=-1,this._lineThicknessLength=-1,this._lineVerticesHandlerIndex=-1,this._lineOrdersHandlerIndex=-1,this._lineIndexesHandlerIndex=-1,this._lineThicknessHandlerIndex=-1,this._lineColorsHandlerIndex=-1,this._type=t.type&&di.getType(t.type)||_i.POINT,this._coordinates=[],this._extent=di.getExtent({type:t.type||"Point",coordinates:t.coordinates||[]},this._coordinates),this._style=t.style||{},this._style.fillColor=se(t.style.fillColor,new Ut(.19,.62,.85,.4)),this._style.lineColor=se(t.style.lineColor,new Ut(.19,.62,.85,1)),this._style.strokeColor=se(t.style.strokeColor,new Ut(1,1,1,.95)),this._style.lineWidth=t.style.lineWidth||3,this._style.strokeWidth=t.style.strokeWidth||0,this._visibility=t.visibility||!0,this._pickingReady=!1}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}static getType(t){return _i[t.toUpperCase()]}static getExtent(t,e){var i=new Ot(new kt(180,90),new kt(-180,-90)),r=di.getType(t.type);if(r===_i.POINT){let t=i.coordinates[0],r=i.coordinates[1];i.southWest.lon=t,i.southWest.lat=r,i.northEast.lon=t,i.northEast.lat=r,e&&(e[0]=t)&&(e[1]=r)}else if(r===_i.LINESTRING){let r=t.coordinates;for(let t=0;t<r.length;t++){let s=r[t][0],n=r[t][1];s<i.southWest.lon&&(i.southWest.lon=s),n<i.southWest.lat&&(i.southWest.lat=n),s>i.northEast.lon&&(i.northEast.lon=s),n>i.northEast.lat&&(i.northEast.lat=n),e&&(e[t]=[s,n])}}else if(r===_i.POLYGON){let r=t.coordinates;for(let t=0;t<r.length;t++){let s=r[t];e&&(e[t]=[]);for(let r=0;r<s.length;r++){let n=s[r],o=n[0],a=n[1];o<i.southWest.lon&&(i.southWest.lon=o),a<i.southWest.lat&&(i.southWest.lat=a),o>i.northEast.lon&&(i.northEast.lon=o),a>i.northEast.lat&&(i.northEast.lat=a),e&&(e[t][r]=[o,a])}}}else if(r===_i.MULTIPOLYGON){let r=t.coordinates;for(let t=0;t<r.length;t++){let s=r[t];e&&(e[t]=[]);for(let r=0;r<s.length;r++){let n=s[r];e&&(e[t][r]=[]);for(let s=0;s<n.length;s++){let o=n[s],a=o[0],h=o[1];a<i.southWest.lon&&(i.southWest.lon=a),h<i.southWest.lat&&(i.southWest.lat=h),a>i.northEast.lon&&(i.northEast.lon=a),h>i.northEast.lat&&(i.northEast.lat=h),e&&(e[t][r][s]=[a,h])}}}}else if(r===_i.MULTILINESTRING){let r=t.coordinates;for(let t=0;t<r.length;t++){let s=r[t];e&&(e[t]=[]);for(let r=0;r<s.length;r++){let n=s[r],o=n[0],a=n[1];o<i.southWest.lon&&(i.southWest.lon=o),a<i.southWest.lat&&(i.southWest.lat=a),o>i.northEast.lon&&(i.northEast.lon=o),a>i.northEast.lat&&(i.northEast.lat=a),e&&(e[t][r]=[o,a])}}}else i.southWest.lon=i.southWest.lat=i.northEast.lon=i.northEast.lat=0,e&&(e[0]=lon)&&(e[1]=lat);return i}setGeometry(t){var e=this._handler;return this.remove(),this._type=di.getType(t.type||"Point"),this._extent=di.getExtent(t,this._coordinates),e.add(this),this}setFillColor(t,e,i,r){var s=this._style.fillColor;return(0===s.w&&0!==r||0!==s.w&&0===r)&&(this._pickingReady=!1),s.x=t,s.y=e,s.z=i,s.w=r,this._handler&&this._handler.setPolyColorArr(this,s),this}setFillColor4v(t){return this.setFillColor(t.x,t.y,t.z,t.w)}setStrokeColor(t,e,i,r){var s=this._style.strokeColor;return(0===s.w&&0!==r||0!==s.w&&0===r)&&(this._pickingReady=!1),s.x=t,s.y=e,s.z=i,s.w=r,this._handler&&this._handler.setStrokeColorArr(this,s),this}setLineColor(t,e,i,r){var s=this._style.lineColor;return(0===s.w&&0!==r||0!==s.w&&0===r)&&(this._pickingReady=!1),s.x=t,s.y=e,s.z=i,s.w=r,this._handler&&this._handler.setLineColorArr(this,s),this}setStrokeColor4v(t){return this.setStrokeColor(t.x,t.y,t.z,t.w)}setLineColor4v(t){return this.setLineColor(t.x,t.y,t.z,t.w)}setStrokeOpacity(t){var e=this._style.strokeColor;return e.w=t,this.setStrokeColor(e.x,e.y,e.z,t)}setLineOpacity(t){var e=this._style.lineColor;return e.w=t,this.setLineColor(e.x,e.y,e.z,t)}setStrokeWidth(t){return this._style.strokeWidth=t,this._pickingReady=!1,this._handler&&this._handler.setLineStrokeArr(this,t),this}bringToFront(){return this._handler&&this._handler.bringToFront(this),this}setLineWidth(t){return this._style.lineWidth=t,this._pickingReady=!1,this._handler&&this._handler.setLineThicknessArr(this,t),this}setFillOpacity(t){var e=this._style.fillColor;return(0===e.w&&0!==t||0!==e.w&&0===t)&&(this._pickingReady=!1),e.w=t,this._handler&&this._handler.setPolyColorArr(this,e),this}setVisibility(t){return this._visibility=t,this._handler&&this._handler.setGeometryVisibility(this),this}getVisibility(){return this._visibility}remove(){this._handler&&this._handler.remove(this)}getExtent(){return this._extent.clone()}getType(){return this._type}}const fi={RIGHT:0,LEFT:1,CENTER:2},pi={left:fi.LEFT,right:fi.RIGHT,center:fi.CENTER};class vi extends ui{constructor(t){super(t),t=t||{},this._text=t.text,this._face=ee(t.face,null),this._size=t.size||33,this._style=ee(t.style,null),this._weight=ee(t.weight,null),this._outline=void 0!=t.outline?t.outline:.5,this._outlineColor=se(t.outlineColor,new Ut(0,0,0,1)),this._align=t.align&&pi[t.align.trim().toLowerCase()]||fi.RIGHT,this._fontIndex=0,this._fontAtlas=null}setText(t){this._text=t,this._handler&&this._handler.setText(this._handlerIndex,t,this._fontIndex,this._align)}getText(){return this._text}setAlign(t){this._align=pi[t.trim().toLowerCase()],this._handler&&this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align)}getAlign(){return this._align}setFace(t){this._face=t.trim().toLowerCase(),this.update()}getFace(){return this._face}setSize(t){this._size=t,this._handler&&this._handler.setSizeArr(this._handlerIndex,t)}getSize(){return this._size}setStyle(t){this._style=t.trim().toLowerCase(),this.update()}getStyle(){return this._style}setWeight(t){this._weight=t.trim().toLowerCase(),this.update()}getWeight(){return this._wight}setOutline(t){this._outline=t,this._handler&&this._handler.setOutlineArr(this._handlerIndex,1-t)}getOutline(){return this._outline}setOpacity(t){this._color.w=t,this.setColor4v(this._color),this._outlineColor.w=t,this.setOutlineColor4v(this._outlineColor)}setOutlineColor(t,e,i,r){this._outlineColor.x=t,this._outlineColor.y=e,this._outlineColor.z=i,this._outlineColor.w=r,this._handler&&this._handler.setOutlineColorArr(this._handlerIndex,this._outlineColor)}setOutlineColor4v(t){this._outlineColor.x=t.x,this._outlineColor.y=t.y,this._outlineColor.z=t.z,this._outlineColor.w=t.w,this._handler&&this._handler.setOutlineColorArr(this._handlerIndex,t)}setOutlineColorHTML(t){this.setOutlineColor4v(Qt(t))}getOutlineColor(){return this._outlineColor}setOutlineOpacity(t){this._outlineColor.w=t,this._handler&&this._handler.setOutlineColorArr(this._handlerIndex,this._outlineColor)}getOutlineOpacity(){return this._outlineColor.w}update(){if(this._fontAtlas){var t=this._fontAtlas.getFontIndex(this._face,this._style,this._weight);void 0==t?this._fontAtlas.createFontAsync(this._face,this._style,this._weight,this._applyFontIndex.bind(this)):this._applyFontIndex(t)}}_applyFontIndex(t){this._fontIndex=t,this._handler&&(this._handler.setFontIndexArr(this._handlerIndex,this._fontIndex),this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align))}assignFontAtlas(t){!this._fontAtlas&&(this._fontAtlas=t),this.update()}}const gi=0,mi=1;class yi{constructor(t){t=t||{},this.id=yi._staticCounter++,this.altitude=0,this.thickness=t.thickness||1.5,this.color=se(t.color,new Ut(1,1,1,1)),this.visibility=void 0==t.visibility||t.visibility,this._closedLine=t.isClosed||!1,this._path3v=[],this._pathLonLat=[],this._pathLonLatMerc=[],this._extent=new Ot,this._vertices=[],this._orders=[],this._indexes=[],this._verticesBuffer=null,this._ordersBuffer=null,this._indexesBuffer=null,this._pickingColor=[0,0,0],this._renderNode=null,this._entity=null,this._handler=null,this._handlerIndex=-1,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[gi]=this._createVerticesBuffer,this._buffersUpdateCallbacks[mi]=this._createIndexBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),t.pathLonLat?this.setPathLonLat(t.pathLonLat):t.path3v&&this.setPath3v(t.path3v),this._refresh()}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}static appendLineData3v(t,e,i,r,s,n,o,a,h,l){var u=0;l&&(l.southWest.set(180,90),l.northEast.set(-180,-90)),s.length>0?(u=s[s.length-5]+9,s.push(u,u)):s.push(0,0);for(var c=0;c<t.length;c++){var _=t[c];if(0!==_.length){o[c]=[],h[c]=[],a[c]=[];var d,f,p=u;if(e)(d=_[_.length-1]).constructor===Array&&(d=new Wt(d[0],d[1],d[2]));else{var v=_[0],g=_[1];v.constructor===Array&&(v=new Wt(v[0],v[1],v[2])),g.constructor===Array&&(g=new Wt(g[0],g[1],g[2])),d=new Wt(v.x+v.x-g.x,v.y+v.y-g.y,v.z+v.z-g.z)}i.push(d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z),r.push(1,-1,2,-2);for(var m=0;m<_.length;m++){var y=_[m];if(y.constructor===Array&&(y=new Wt(y[0],y[1],y[2])),n){var x=n.cartesianToLonLat(y);o[c].push(x),a[c].push(y),h[c].push(x.forwardMercator()),x.lon<l.southWest.lon&&(l.southWest.lon=x.lon),x.lat<l.southWest.lat&&(l.southWest.lat=x.lat),x.lon>l.northEast.lon&&(l.northEast.lon=x.lon),x.lat>l.northEast.lat&&(l.northEast.lat=x.lat)}i.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),r.push(1,-1,2,-2),s.push(u++,u++,u++,u++)}if(e)(f=_[0]).constructor===Array&&(f=new Wt(f[0],f[1],f[2])),s.push(p,p+1,p+1,p+1);else{let t=_[_.length-1],e=_[_.length-2];t.constructor===Array&&(t=new Wt(t[0],t[1],t[2])),e.constructor===Array&&(e=new Wt(e[0],e[1],e[2])),f=new Wt(t.x+t.x-e.x,t.y+t.y-e.y,t.z+t.z-e.z),s.push(u-1,u-1,u-1,u-1)}i.push(f.x,f.y,f.z,f.x,f.y,f.z,f.x,f.y,f.z,f.x,f.y,f.z),r.push(1,-1,2,-2),c<t.length-1&&(u+=8,s.push(u,u))}}}static appendLineDataLonLat(t,e,i,r,s,n,o,a,h,l){var u=0;l&&(l.southWest.set(180,90),l.northEast.set(-180,-90)),s.length>0?(u=s[s.length-5]+9,s.push(u,u)):s.push(0,0);for(var c=0;c<t.length;c++){var _=t[c];if(0!==_.length){var d,f,p=u;if(o[c]=[],h[c]=[],a[c]=[],e){let t=_[_.length-1];d=t instanceof Array?n.lonLatToCartesian(new kt(t[0],t[1],t[2])):n.lonLatToCartesian(t)}else{let t,e,i=_[0];t=i instanceof Array?n.lonLatToCartesian(new kt(i[0],i[1],i[2])):n.lonLatToCartesian(i),(i=_[1])||(i=_[0]),e=i instanceof Array?n.lonLatToCartesian(new kt(i[0],i[1],i[2])):n.lonLatToCartesian(i),d=new Wt(t.x+t.x-e.x,t.y+t.y-e.y,t.z+t.z-e.z)}i.push(d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z),r.push(1,-1,2,-2);for(var v=0;v<_.length;v++){var g=_[v];g instanceof Array&&(g=new kt(g[0],g[1],g[2]));var m=n.lonLatToCartesian(g);o[c].push(m),a[c].push(g),h[c].push(g.forwardMercator()),i.push(m.x,m.y,m.z,m.x,m.y,m.z,m.x,m.y,m.z,m.x,m.y,m.z),r.push(1,-1,2,-2),s.push(u++,u++,u++,u++),g.lon<l.southWest.lon&&(l.southWest.lon=g.lon),g.lat<l.southWest.lat&&(l.southWest.lat=g.lat),g.lon>l.northEast.lon&&(l.northEast.lon=g.lon),g.lat>l.northEast.lat&&(l.northEast.lat=g.lat)}if(e){let t=_[0];f=t instanceof Array?n.lonLatToCartesian(new kt(t[0],t[1],t[2])):n.lonLatToCartesian(t),s.push(p,p+1,p+1,p+1)}else{let t,e,i=_[_.length-1];t=i instanceof Array?n.lonLatToCartesian(new kt(i[0],i[1],i[2])):n.lonLatToCartesian(i),(i=_[_.length-2])||(i=_[0]),e=i instanceof Array?n.lonLatToCartesian(new kt(i[0],i[1],i[2])):n.lonLatToCartesian(i),f=new Wt(t.x+t.x-e.x,t.y+t.y-e.y,t.z+t.z-e.z),s.push(u-1,u-1,u-1,u-1)}i.push(f.x,f.y,f.z,f.x,f.y,f.z,f.x,f.y,f.z,f.x,f.y,f.z),r.push(1,-1,2,-2),c<t.length-1&&(u+=8,s.push(u,u))}}}_setEqualPath3v(t){var e=this._extent;e.southWest.set(180,90),e.northEast.set(-180,-90);for(var i=this._vertices,r=this._pathLonLat,s=this._pathLonLatMerc,n=0,o=this._renderNode.ellipsoid,a=0;a<t.length;a++){var h,l,u=t[a];h=this._closedLine?u[u.length-1]:new Wt(u[0].x+u[0].x-u[1].x,u[0].y+u[0].y-u[1].y,u[0].z+u[0].z-u[1].z),i[n++]=h.x,i[n++]=h.y,i[n++]=h.z,i[n++]=h.x,i[n++]=h.y,i[n++]=h.z,i[n++]=h.x,i[n++]=h.y,i[n++]=h.z,i[n++]=h.x,i[n++]=h.y,i[n++]=h.z;for(var c=0;c<u.length;c++){var _=u[c];if(o){var d=o.cartesianToLonLat(_);r[a][c]=d,s[a][c]=d.forwardMercator(),d.lon<e.southWest.lon&&(e.southWest.lon=d.lon),d.lat<e.southWest.lat&&(e.southWest.lat=d.lat),d.lon>e.northEast.lon&&(e.northEast.lon=d.lon),d.lat>e.northEast.lat&&(e.northEast.lat=d.lat)}i[n++]=_.x,i[n++]=_.y,i[n++]=_.z,i[n++]=_.x,i[n++]=_.y,i[n++]=_.z,i[n++]=_.x,i[n++]=_.y,i[n++]=_.z,i[n++]=_.x,i[n++]=_.y,i[n++]=_.z}if(this._closedLine)l=u[0];else{var f=u.length-1;l=new Wt(u[f].x+u[f].x-u[f-1].x,u[f].y+u[f].y-u[f-1].y,u[f].z+u[f].z-u[f-1].z)}i[n++]=l.x,i[n++]=l.y,i[n++]=l.z,i[n++]=l.x,i[n++]=l.y,i[n++]=l.z,i[n++]=l.x,i[n++]=l.y,i[n++]=l.z,i[n++]=l.x,i[n++]=l.y,i[n++]=l.z}}_setEqualPathLonLat(t){var e=this._extent;e.southWest.set(180,90),e.northEast.set(-180,-90);for(var i=this._vertices,r=this._pathLonLat,s=this._pathLonLatMerc,n=this._path3v,o=0,a=this._renderNode.ellipsoid,h=0;h<t.length;h++){var l,u,c=t[h];if(this._closedLine)l=a.lonLatToCartesian(c[c.length-1]);else{let t=a.lonLatToCartesian(c[0]),e=a.lonLatToCartesian(c[1]);l=new Wt(t.x+t.x-e.x,t.y+t.y-e.y,t.z+t.z-e.z)}i[o++]=l.x,i[o++]=l.y,i[o++]=l.z,i[o++]=l.x,i[o++]=l.y,i[o++]=l.z,i[o++]=l.x,i[o++]=l.y,i[o++]=l.z,i[o++]=l.x,i[o++]=l.y,i[o++]=l.z;for(var _=0;_<c.length;_++){var d=c[_],f=a.lonLatToCartesian(d);n[h][_]=f,s[h][_]=d.forwardMercator(),r[h][_]=d,i[o++]=f.x,i[o++]=f.y,i[o++]=f.z,i[o++]=f.x,i[o++]=f.y,i[o++]=f.z,i[o++]=f.x,i[o++]=f.y,i[o++]=f.z,i[o++]=f.x,i[o++]=f.y,i[o++]=f.z,d.lon<e.southWest.lon&&(e.southWest.lon=d.lon),d.lat<e.southWest.lat&&(e.southWest.lat=d.lat),d.lon>e.northEast.lon&&(e.northEast.lon=d.lon),d.lat>e.northEast.lat&&(e.northEast.lat=d.lat)}if(this._closedLine)u=a.lonLatToCartesian(c[0]);else{let t=a.lonLatToCartesian(c[c.length-1]),e=a.lonLatToCartesian(c[c.length-2]);u=new Wt(t.x+t.x-e.x,t.y+t.y-e.y,t.z+t.z-e.z)}i[o++]=u.x,i[o++]=u.y,i[o++]=u.z,i[o++]=u.x,i[o++]=u.y,i[o++]=u.z,i[o++]=u.x,i[o++]=u.y,i[o++]=u.z,i[o++]=u.x,i[o++]=u.y,i[o++]=u.z}}setPointLonLat(t,e,i){if(this._renderNode&&this._renderNode.ellipsoid){let l=this._pathLonLat,u=this._pathLonLatMerc;l[i][e]=t,u[i][e]=t.forwardMercator();var r=this._extent;r.southWest.set(180,90),r.northEast.set(-180,-90);for(var s=0;s<l.length;s++)for(var n=l[s],o=0;o<n.length;o++){var a=n[o].lon,h=n[o].lat;a>r.northEast.lon&&(r.northEast.lon=a),h>r.northEast.lat&&(r.northEast.lat=h),a<r.southWest.lon&&(r.southWest.lon=a),h<r.southWest.lat&&(r.southWest.lat=h)}this.setPoint3v(this._renderNode.ellipsoid.lonLatToCartesian(t),e,i,!0)}else{let r=this._pathLonLat[i];r[e].lon=t.lon,r[e].lat=t.lat,r[e].height=t.height}}setPoint3v(t,e,i,r){if(i=i||0,this._renderNode){for(var s=this._vertices,n=this._pathLonLat,o=this._pathLonLatMerc,a=0,h=0,l=0;l<i;l++)h+=12*this._path3v[l].length+24;let y=this._path3v[i];var u;if(y[e].x=t.x,y[e].y=t.y,y[e].z=t.z,0===e||1===e)u=this._closedLine?y[y.length-1]:new Wt(y[0].x+y[0].x-y[1].x,y[0].y+y[0].y-y[1].y,y[0].z+y[0].z-y[1].z),s[a=h]=u.x,s[a+1]=u.y,s[a+2]=u.z,s[a+3]=u.x,s[a+4]=u.y,s[a+5]=u.z,s[a+6]=u.x,s[a+7]=u.y,s[a+8]=u.z,s[a+9]=u.x,s[a+10]=u.y,s[a+11]=u.z;if(!r&&this._renderNode.ellipsoid){var c=this._renderNode.ellipsoid.cartesianToLonLat(t);n[i][e]=c,o[i][e]=c.forwardMercator();var _=this._extent;_.southWest.set(180,90),_.northEast.set(-180,-90);for(l=0;l<n.length;l++)for(var d=n[l],f=0;f<d.length;f++){var p=d[f].lon,v=d[f].lat;p>_.northEast.lon&&(_.northEast.lon=p),v>_.northEast.lat&&(_.northEast.lat=v),p<_.southWest.lon&&(_.southWest.lon=p),v<_.southWest.lat&&(_.southWest.lat=v)}}if(s[a=h+12*e+12]=t.x,s[a+1]=t.y,s[a+2]=t.z,s[a+3]=t.x,s[a+4]=t.y,s[a+5]=t.z,s[a+6]=t.x,s[a+7]=t.y,s[a+8]=t.z,s[a+9]=t.x,s[a+10]=t.y,s[a+11]=t.z,e===y.length-1||e===y.length-2){var g;if(this._closedLine)g=y[0];else{var m=y.length-1;g=new Wt(y[m].x+y[m].x-y[m-1].x,y[m].y+y[m].y-y[m-1].y,y[m].z+y[m].z-y[m-1].z)}s[a=h+12*y.length+12]=g.x,s[a+1]=g.y,s[a+2]=g.z,s[a+3]=g.x,s[a+4]=g.y,s[a+5]=g.z,s[a+6]=g.x,s[a+7]=g.y,s[a+8]=g.z,s[a+9]=g.x,s[a+10]=g.y,s[a+11]=g.z}this._changedBuffers[gi]=!0}else{let r=this._path3v[i];r[e].x=t.x,r[e].y=t.y,r[e].z=t.z}}removePoint(t,e){e=e||0,this._path3v[e].splice(t,1),this.setPath3v([].concat(this._path3v))}addPoint3v(t,e){(e=e||0)>=this._path3v.length&&this._path3v.push([]),this._path3v[e].push(t),this.setPath3v([].concat(this._path3v))}addPointLonLat(t,e){(e=e||0)>=this._pathLonLat.length&&this._pathLonLat.push([]),this._pathLonLat[e].push(t),this.setPathLonLat([].concat(this._pathLonLat))}clear(){this._vertices.length=0,this._orders.length=0,this._indexes.length=0,this._vertices=[],this._orders=[],this._indexes=[],this._deleteBuffers()}setColorHTML(t,e){this.color=Qt(t),e&&(this.color.w=e)}setColor(t,e,i,r){this.color.x=t,this.color.y=e,this.color.z=i,r&&(this.color.w=r)}setColor3v(t){this.color.x=t.x,this.color.y=t.y,this.color.z=t.z}setColor4v(t){this.color.x=t.x,this.color.y=t.y,this.color.z=t.z,this.color.w=t.w}setOpacity(t){this.color.w=t}setThickness(t){this.thickness=t}getThickness(){return this.thickness}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){this._renderNode=t,this._pathLonLat.length?this._createDataLonLat([].concat(this._pathLonLat)):this._createData3v([].concat(this._path3v))}_clearData(){this._vertices.length=0,this._orders.length=0,this._indexes.length=0,this._vertices=[],this._orders=[],this._indexes=[],this._path3v.length=0,this._pathLonLat.length=0,this._pathLonLatMerc.length=0,this._path3v=[],this._pathLonLat=[],this._pathLonLatMerc=[]}_createData3v(t){this._clearData(),yi.appendLineData3v(t,this._closedLine,this._vertices,this._orders,this._indexes,this._renderNode.ellipsoid,this._pathLonLat,this._path3v,this._pathLonLatMerc,this._extent)}_createDataLonLat(t){this._clearData(),yi.appendLineDataLonLat(t,this._closedLine,this._vertices,this._orders,this._indexes,this._renderNode.ellipsoid,this._path3v,this._pathLonLat,this._pathLonLatMerc,this._extent)}remove(){this._entity=null,this.clear(),this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._pickingColor[0]=t.x/255,this._pickingColor[1]=t.y/255,this._pickingColor[2]=t.z/255}getExtent(){return this._extent.clone()}getPath3v(){return this._path3v}getPathLonLat(){return this._pathLonLat}setPathLonLat(t,e){this._renderNode&&this._renderNode.ellipsoid?e?(this._setEqualPathLonLat(t),this._changedBuffers[gi]=!0):(this._createDataLonLat(t),this._changedBuffers[gi]=!0,this._changedBuffers[mi]=!0):this._pathLonLat=[].concat(t)}setPath3v(t,e){this._renderNode?e?(this._setEqualPath3v(t),this._changedBuffers[gi]=!0):(this._createData3v(t),this._changedBuffers[gi]=!0,this._changedBuffers[mi]=!0):this._path3v=[].concat(t)}draw(){if(this.visibility&&this._path3v.length){this._update();var t=this._renderNode,e=t.renderer,i=e.handler.shaderPrograms.polyline,r=i._program,s=e.handler.gl,n=r.attributes,o=r.uniforms;i.activate(),s.enable(s.BLEND),s.blendEquationSeparate(s.FUNC_ADD,s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA),s.disable(s.CULL_FACE),s.uniformMatrix4fv(o.proj,!1,e.activeCamera._projectionMatrix._m),s.uniformMatrix4fv(o.view,!1,e.activeCamera._viewMatrix._m),e.isMultiFramebufferCompatible()&&s.uniform3fv(o.pickingColor,[this._pickingColor[0],this._pickingColor[1],this._pickingColor[2]]),s.uniform4fv(o.color,this.color.toVec()),s.uniform3fv(o.uCamPos,e.activeCamera.eye.toVec()),s.uniform2fv(o.uFloatParams,[t._planetRadius2||0,e.activeCamera._tanViewAngle_hradOneByHeight]),s.uniform2fv(o.viewport,[e.handler.canvas.width,e.handler.canvas.height]),s.uniform1f(o.thickness,.5*this.thickness);var a=this._verticesBuffer;s.bindBuffer(s.ARRAY_BUFFER,a),s.vertexAttribPointer(n.prev,a.itemSize,s.FLOAT,!1,12,0),s.vertexAttribPointer(n.current,a.itemSize,s.FLOAT,!1,12,48),s.vertexAttribPointer(n.next,a.itemSize,s.FLOAT,!1,12,96),s.bindBuffer(s.ARRAY_BUFFER,this._ordersBuffer),s.vertexAttribPointer(n.order,this._ordersBuffer.itemSize,s.FLOAT,!1,4,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this._indexesBuffer),s.drawElements(s.TRIANGLE_STRIP,this._indexesBuffer.numItems,s.UNSIGNED_INT,0)}}drawPicking(){if(this.visibility&&this._path3v.length){var t=this._renderNode,e=t.renderer,i=e.handler.shaderPrograms.polyline,r=i._program,s=e.handler.gl,n=r.attributes,o=r.uniforms;i.activate(),s.disable(s.BLEND),s.disable(s.CULL_FACE),s.uniformMatrix4fv(o.proj,!1,e.activeCamera._projectionMatrix._m),s.uniformMatrix4fv(o.view,!1,e.activeCamera._viewMatrix._m),s.uniform4fv(o.color,[this._pickingColor[0],this._pickingColor[1],this._pickingColor[2],1]),s.uniform3fv(o.uCamPos,e.activeCamera.eye.toVec()),s.uniform2fv(o.uFloatParams,[t._planetRadius2||0,e.activeCamera._tanViewAngle_hradOneByHeight]),s.uniform2fv(o.viewport,[e.handler.canvas.width,e.handler.canvas.height]),s.uniform1f(o.thickness,.5*this.thickness);var a=this._verticesBuffer;s.bindBuffer(s.ARRAY_BUFFER,a),s.vertexAttribPointer(n.prev,a.itemSize,s.FLOAT,!1,12,0),s.vertexAttribPointer(n.current,a.itemSize,s.FLOAT,!1,12,48),s.vertexAttribPointer(n.next,a.itemSize,s.FLOAT,!1,12,96),s.bindBuffer(s.ARRAY_BUFFER,this._ordersBuffer),s.vertexAttribPointer(n.order,this._ordersBuffer.itemSize,s.FLOAT,!1,4,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this._indexesBuffer),s.drawElements(s.TRIANGLE_STRIP,this._indexesBuffer.numItems,s.UNSIGNED_INT,0),s.enable(s.CULL_FACE),s.enable(s.BLEND)}}_refresh(){for(var t=this._changedBuffers.length;t--;)this._changedBuffers[t]=!0}_update(){if(this._renderNode)for(var t=this._changedBuffers.length;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}_deleteBuffers(){if(this._renderNode){var t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._verticesBuffer),t.deleteBuffer(this._ordersBuffer),t.deleteBuffer(this._indexesBuffer),this._verticesBuffer=null,this._ordersBuffer=null,this._indexesBuffer=null}}_createVerticesBuffer(){var t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._verticesBuffer),this._verticesBuffer=t.createArrayBuffer(new Float32Array(this._vertices),3,this._vertices.length/3)}_createIndexBuffer(){var t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._ordersBuffer),t.gl.deleteBuffer(this._indexesBuffer),this._ordersBuffer=t.createArrayBuffer(new Float32Array(this._orders),1,this._orders.length/2),this._indexesBuffer=t.createElementArrayBuffer(new Uint32Array(this._indexes),1,this._indexes.length)}}const xi=0,bi=1,Ai=2;class Ci{constructor(t){t=t||{},this.id=Ci._staticCounter++,this.visibility=void 0==t.visibility||t.visibility,this.pointSize=t.pointSize||3,this.pickingDistance=t.pickingDistance||0,this._renderNode=null,this._entity=null,this._points=[],this._coordinatesData=[],this._colorData=[],this._pickingColorData=[],this._coordinatesBuffer=null,this._colorBuffer=null,this._pickingColorBuffer=null,this._handler=null,this._handlerIndex=-1,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[xi]=this._createCoordinatesBuffer,this._buffersUpdateCallbacks[bi]=this._createColorBuffer,this._buffersUpdateCallbacks[Ai]=this._createPickingColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),this.setPoints(t.points)}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}clear(){this._points.length=0,this._points=[],this._coordinatesData.length=0,this._coordinatesData=[],this._colorData.length=0,this._colorData=[],this._pickingColorData.length=0,this._pickingColorData=[],this._deleteBuffers()}setOpacity(t){this.opacity=t}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){this._renderNode=t,this._setPickingColors()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPoints(t){this.clear();for(var e=0;e<t.length;e++){var i=t[e],r=new Wt(i[0],i[1],i[2]),s=new Ut(i[3],i[4],i[5],void 0==i[6]?255:i[6]);this._coordinatesData.push(r.x,r.y,r.z),this._colorData.push(s.x/255,s.y/255,s.z/255,s.w/255);var n={_pickingColor:new Wt,_entityCollection:this._entity&&this._entity._entityCollection,index:e,position:r,color:s,pointCloud:this,properties:i[7]||{}};this._points.push(n),this._renderNode&&(this._renderNode.renderer.assignPickingColor(n),this._pickingColorData.push(n._pickingColor.x/255,n._pickingColor.y/255,n._pickingColor.z/255,1))}this._changedBuffers[xi]=!0,this._changedBuffers[bi]=!0,this._changedBuffers[Ai]=!0}setPointPosition(t,e,i,r){this._changedBuffers[xi]=!0}setPointColor(t,e,i,r,s){this._changedBuffers[bi]=!0}addPoints(t){this._changedBuffers[xi]=!0,this._changedBuffers[bi]=!0,this._changedBuffers[Ai]=!0}addPoint(t,e){this._changedBuffers[xi]=!0,this._changedBuffers[bi]=!0,this._changedBuffers[Ai]=!0}getPoint(t){return this._points[t]}removePoint(t){this._changedBuffers[xi]=!0,this._changedBuffers[bi]=!0,this._changedBuffers[Ai]=!0}insertPoint(t,e){this._changedBuffers[xi]=!0,this._changedBuffers[bi]=!0,this._changedBuffers[Ai]=!0}each(t){for(var e=this._points.length;e--;)t&&t(this._points[e])}draw(){if(this.visibility&&this._coordinatesData.length){this._update();var t=this._renderNode.renderer,e=t.handler.shaderPrograms.pointCloud,i=e._program,r=t.handler.gl,s=i.attributes,n=i.uniforms;e.activate(),r.uniformMatrix4fv(n.projectionViewMatrix,!1,t.activeCamera._projectionViewMatrix._m),r.uniform1f(n.opacity,this._handler._entityCollection._fadingOpacity),r.uniform1f(n.pointSize,this.pointSize),r.bindBuffer(r.ARRAY_BUFFER,this._coordinatesBuffer),r.vertexAttribPointer(s.coordinates,this._coordinatesBuffer.itemSize,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this._colorBuffer),r.vertexAttribPointer(s.colors,this._colorBuffer.itemSize,r.FLOAT,!1,0,0),r.drawArrays(r.POINTS,0,this._coordinatesBuffer.numItems)}}drawPicking(){if(this.visibility&&this._coordinatesData.length){var t=this._renderNode.renderer,e=t.handler.shaderPrograms.pointCloud,i=e._program,r=t.handler.gl,s=i.attributes,n=i.uniforms;e.activate(),r.uniformMatrix4fv(n.projectionViewMatrix,!1,t.activeCamera._projectionViewMatrix._m),r.uniform1f(n.opacity,this._handler._entityCollection._fadingOpacity),r.uniform1f(n.pointSize,this.pointSize+this.pickingDistance),r.bindBuffer(r.ARRAY_BUFFER,this._coordinatesBuffer),r.vertexAttribPointer(s.coordinates,this._coordinatesBuffer.itemSize,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this._pickingColorBuffer),r.vertexAttribPointer(s.colors,this._pickingColorBuffer.itemSize,r.FLOAT,!1,0,0),r.drawArrays(r.POINTS,0,this._coordinatesBuffer.numItems)}}_update(){if(this._renderNode)for(var t=this._changedBuffers.length;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}_deleteBuffers(){if(this._renderNode){var t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._coordinatesBuffer),t.deleteBuffer(this._colorBuffer),t.deleteBuffer(this._pickingColorBuffer)}this._coordinatesBuffer=null,this._colorBuffer=null,this._pickingColorBuffer=null}_createCoordinatesBuffer(){var t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._coordinatesBuffer),this._coordinatesBuffer=t.createArrayBuffer(new Float32Array(this._coordinatesData),3,this._coordinatesData.length/3)}_createColorBuffer(){var t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._colorBuffer),this._colorBuffer=t.createArrayBuffer(new Float32Array(this._colorData),4,this._colorData.length/4)}_createPickingColorBuffer(){var t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorBuffer=t.createArrayBuffer(new Float32Array(this._pickingColorData),4,this._pickingColorData.length/4)}_setPickingColors(){if(this._renderNode){for(var t=0;t<this._points.length;t++){var e=this._points[t];e._entity=this._entity,e._entityCollection=this._entity._entityCollection,this._renderNode.renderer.assignPickingColor(e),this._pickingColorData.push(e._pickingColor.x/255,e._pickingColor.y/255,e._pickingColor.z/255,1)}this._changedBuffers[Ai]=!0}}}class Ei{constructor(t){t=t||{},this.id=Ei.__staticId++,this.position=t.position||new Wt,this.orientation=t.orientation||new Xt(0,0,0,1),this.scale=t.scale||new Wt(1,1,1),this.color=t.color||[1,1,1,1],this.visibility=void 0==t.visibility||t.visibility,this._src=t.src||null,this._positionBuffer=null,this._normalBuffer=null,this._indexBuffer=null,this._textureCoordBuffer=null,this._positionData=[],this._normalData=[],this._indexData=[],this._textureCoordData=[],this._mxScale=(new Ht).setIdentity(),this._mxTranslation=(new Ht).setIdentity(),this._mxModel=(new Ht).setIdentity(),this.texture=null,this._renderNode=null,this._pickingColor=[0,0,0,0],this._entity=null,this._handler=null,this._handlerIndex=-1}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}clear(){this.position.set(0,0,0),this.orientation.set(0,0,0,1),this.scale.set(1,1,1),this._positionData.length=0,this._normalData.length=0,this._indexData.length=0,this._mxScale.setIdentity(),this._mxTranslation.setIdentity(),this._mxModel.setIdentity(),this._renderNode.handler.gl.deleteTexture(this.texture),this.texture=null,this._deleteBuffers()}setColor(t){this.color[0]=t[0],this.color[1]=t[1],this.color[2]=t[2],this.color[3]=t[3]}setColor4v(t){this.color[0]=t.x,this.color[1]=t.y,this.color[2]=t.z,this.color[3]=t.w}setOpacity(t){this.color[3]=t}_deleteBuffers(){var t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._positionBuffer),t.deleteBuffer(this._normalBuffer),t.deleteBuffer(this._indexBuffer),this._positionBuffer=null,this._normalBuffer=null,this._indexBuffer=null}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){if(this._renderNode=t,this._createBuffers(),this._src){var e=new Image,i=this;e.onload=function(){i.texture=t.renderer.handler.createTexture(this)},e.src=this._src}}setPosition3v(t){this.position.copy(t),this._mxTranslation.translateToPosition(t),this.refresh()}translate3v(t){this.position.addA(t),this._mxTranslation.translate(t)}setScale3v(t){this.scale.copy(t),this._mxScale.scale(t)}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._pickingColor[0]=t.x/255,this._pickingColor[1]=t.y/255,this._pickingColor[2]=t.z/255,this._pickingColor[3]=1}_createBuffers(){this._deleteBuffers();var t=this._renderNode.renderer;this._positionBuffer=t.handler.createArrayBuffer(new Float32Array(this._positionData),3,this._positionData.length/3),this._normalBuffer=t.handler.createArrayBuffer(new Float32Array(this._normalData),3,this._normalData.length/3),this._indexBuffer=t.handler.createElementArrayBuffer(new Uint16Array(this._indexData),1,this._indexData.length),this._textureCoordBuffer=t.handler.createArrayBuffer(new Float32Array(this._textureCoordData),2,this._textureCoordData.length/2)}refresh(){this._mxModel=this._mxTranslation.mul(this.orientation.getMatrix4().mul(this._mxScale))}draw(){if(this.visibility){var t,e,i=this._renderNode,r=i.renderer,s=r.handler.gl;i.lightEnabled?(e=(t=r.handler.shaderPrograms.shape_wl)._program,sha=e.attributes,shu=e.uniforms,t.activate(),s.uniform4fv(shu.lightsPositions,i._lightsTransformedPositions),s.uniform3fv(shu.lightsParamsv,i._lightsParamsv),s.uniform1fv(shu.lightsParamsf,i._lightsParamsf),s.uniformMatrix4fv(shu.projectionMatrix,!1,r.activeCamera._projectionMatrix._m),s.uniformMatrix4fv(shu.viewMatrix,!1,r.activeCamera._viewMatrix._m),s.uniformMatrix3fv(shu.normalMatrix,!1,r.activeCamera._normalMatrix._m),s.bindBuffer(s.ARRAY_BUFFER,this._normalBuffer),s.vertexAttribPointer(sha.aVertexNormal,this._normalBuffer.itemSize,s.FLOAT,!1,0,0)):(e=(t=r.handler.shaderPrograms.shape_nl)._program,sha=e.attributes,shu=e.uniforms,t.activate(),s.uniformMatrix4fv(shu.projectionViewMatrix,!1,r.activeCamera._projectionViewMatrix._m)),s.uniform4fv(shu.uColor,this.color),s.bindBuffer(s.ARRAY_BUFFER,this._positionBuffer),s.vertexAttribPointer(sha.aVertexPosition,this._positionBuffer.itemSize,s.FLOAT,!1,0,0),s.uniformMatrix4fv(shu.modelMatrix,!1,this._mxModel._m),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.texture),s.uniform1i(shu.uSampler,0),s.bindBuffer(s.ARRAY_BUFFER,this._textureCoordBuffer),s.vertexAttribPointer(sha.aTextureCoord,this._textureCoordBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this._indexBuffer),s.drawElements(r.handler.gl.TRIANGLES,this._indexBuffer.numItems,s.UNSIGNED_SHORT,0)}}}class Ti extends Ei{constructor(t){this._radius=t.radius||100,this._latBands=t.latBands||16,this._lonBands=t.lonBands||16,this._createData()}_createData(){for(let u=0;u<=this._latBands;u++){var t=u*Math.PI/this._latBands,e=Math.sin(t),i=Math.cos(t);for(let t=0;t<=this._lonBands;t++){var r=2*t*Math.PI/this._lonBands,s=Math.sin(r),n=Math.cos(r)*e,o=i,a=s*e,h=1-t/this._lonBands,l=u/this._latBands;this._normalData.push(n),this._normalData.push(o),this._normalData.push(a),this._textureCoordData.push(h),this._textureCoordData.push(l),this._positionData.push(this._radius*n),this._positionData.push(this._radius*o),this._positionData.push(this._radius*a)}}for(let t=0;t<this._latBands;t++)for(let e=0;e<this._lonBands;e++){var u=t*(this._lonBands+1)+e,c=u+this._lonBands+1;this._indexData.push(u),this._indexData.push(u+1),this._indexData.push(c),this._indexData.push(c),this._indexData.push(u+1),this._indexData.push(c+1)}}}class wi{constructor(t){(t=t||{}).properties=t.properties||{},this.id=wi._staticCounter++,this.properties=t.properties||{},this.properties.name=this.properties.name||"noname",this.childrenNodes=[],this.parent=null,this._cartesian=ie(t.cartesian),this._lonlat=ae(t.lonlat),this._lonlatMerc=null,this._altitude=t.altitude||0,this._visibility=void 0==t.visibility||t.visibility,this._entityCollection=null,this._entityCollectionIndex=-1,this._layer=null,this._layerIndex=-1,this._pickingColor=new Wt(0,0,0),this._featureConstructorArray={billboard:[ci,this.setBillboard],label:[vi,this.setLabel],sphere:[Ti,this.setShape],polyline:[yi,this.setPolyline],pointCloud:[Ci,this.setPointCloud],geometry:[di,this.setGeometry]},this.billboard=this._createOptionFeature("billboard",t.billboard),this.label=this._createOptionFeature("label",t.label),this.shape=this._createOptionFeature("sphere",t.sphere||t.box),this.polyline=this._createOptionFeature("polyline",t.polyline),this.pointCloud=this._createOptionFeature("pointCloud",t.pointCloud),this.geometry=this._createOptionFeature("geometry",t.geometry)}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}get instanceName(){return"Entity"}_createOptionFeature(t,e){if(e){var i=this._featureConstructorArray[t];return i[1].call(this,new i[0](e))}return null}getCollectionIndex(){return this._entityCollectionIndex}addTo(t,e){return t.add(this,e),this}remove(){this._layer&&this._layer.removeEntity(this),this._entityCollection&&this._entityCollection.removeEntity(this)}setVisibility(t){this._visibility=t,this.billboard&&this.billboard.setVisibility(t),this.label&&this.label.setVisibility(t),this.shape&&this.shape.setVisibility(t),this.polyline&&this.polyline.setVisibility(t),this.geometry&&this.geometry.setVisibility(t);for(var e=0;e<this.childrenNodes.length;e++)this.childrenNodes[e].setVisibility(t)}getVisibility(){return this._visibility}setCartesian3v(t){this.setCartesian(t.x,t.y,t.z)}setCartesian(t,e,i){var r=this._cartesian;r.x=t,r.y=e,r.z=i,this.billboard&&this.billboard.setPosition3v(r),this.label&&this.label.setPosition3v(r),this.shape&&this.shape.setPosition3v(r);for(var s=0;s<this.childrenNodes.length;s++)this.childrenNodes[s].setCartesian(t,e,i);var n=this._entityCollection;n&&n.renderNode&&n.renderNode.ellipsoid&&(this._lonlat=n.renderNode.ellipsoid.cartesianToLonLat(r),Math.abs(this._lonlat.lat)<Ft?this._lonlatMerc=this._lonlat.forwardMercator():this._lonlatMerc=null),n&&n.events.dispatch(n.events.entitymove,this)}_setCartesian3vSilent(t,e){var i=this._cartesian;i.x=t.x,i.y=t.y,i.z=t.z,this.billboard&&this.billboard.setPosition3v(i),this.label&&this.label.setPosition3v(i),this.shape&&this.shape.setPosition3v(i);for(var r=0;r<this.childrenNodes.length;r++)this.childrenNodes[r].setCartesian(x,y,z);var s=this._entityCollection;!e&&s&&s.renderNode&&s.renderNode.ellipsoid&&(this._lonlat=s.renderNode.ellipsoid.cartesianToLonLat(i),Math.abs(this._lonlat.lat)<Ft?this._lonlatMerc=this._lonlat.forwardMercator():this._lonlatMerc=null)}getLonLat(){return this._lonlat.clone()}setLonLat(t){var e=this._lonlat;e.lon=t.lon,e.lat=t.lat,e.height=t.height;var i=this._entityCollection;i&&i.renderNode&&i.renderNode.ellipsoid&&(Math.abs(t.lat)<Ft?this._lonlatMerc=t.forwardMercator():this._lonlatMerc=null,this._cartesian=i.renderNode.ellipsoid.lonLatToCartesian(t),this.setCartesian3v(this._cartesian))}setAltitude(t){this._altitude=t}getAltitude(){return this._altitude}getCartesian(){return this._cartesian.clone()}setBillboard(t){return this.billboard&&this.billboard.remove(),this.billboard=t,this.billboard._entity=this,this.billboard.setPosition3v(this._cartesian),this.billboard.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._billboardHandler.add(t),t}setLabel(t){return this.label&&this.label.remove(),this.label=t,this.label._entity=this,this.label.setPosition3v(this._cartesian),this.label.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._labelHandler.add(t),t}setShape(t){return this.shape&&this.shape.remove(),this.shape=t,this.shape._entity=this,this.shape.setPosition3v(this._cartesian),this.shape.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._shapeHandler.add(t),t}setPolyline(t){return this.polyline&&this.polyline.remove(),this.polyline=t,this.polyline._entity=this,this.polyline.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._polylineHandler.add(t),t}setPointCloud(t){return this.pointCloud&&this.pointCloud.remove(),this.pointCloud=t,this.pointCloud._entity=this,this.pointCloud.setVisibility(this._visibility),this._entityCollection&&this._entityCollection._pointCloudHandler.add(t),t}setGeometry(t){return this.geometry&&this.geometry.remove(),this.geometry=t,this.geometry._entity=this,this.geometry.setVisibility(this._visibility),this._layer&&this._layer.add(this),t}get layer(){return this._layer}appendChild(t){t._entityCollection=this._entityCollection,t._pickingColor=this._pickingColor,t.parent=this,this.childrenNodes.push(t),this._entityCollection&&this._entityCollection._addRecursively(t)}setPickingColor(){var t=this._pickingColor;this.billboard&&this.billboard.setPickingColor3v(t),this.label&&this.label.setPickingColor3v(t),this.shape&&this.shape.setPickingColor3v(t),this.polyline&&this.polyline.setPickingColor3v(t);for(var e=0;e<this.childrenNodes.length;e++)this.childrenNodes[e].setPickingColor()}getExtent(){var t,e=this._lonlat,i=(t=this.billboard||this.label?new Ot(new kt(e.lon,e.lat),new kt(e.lon,e.lat)):new Ot(new kt(180,90),new kt(-180,-90))).southWest,r=t.northEast;this.polyline&&((n=this.polyline.getExtent()).southWest.lon<i.lon&&(i.lon=n.southWest.lon),n.southWest.lat<i.lat&&(i.lat=n.southWest.lat),n.northEast.lon>r.lon&&(r.lon=n.northEast.lon),n.northEast.lat>r.lat&&(r.lat=n.northEast.lat));this.geometry&&((n=this.geometry.getExtent()).southWest.lon<i.lon&&(i.lon=n.southWest.lon),n.southWest.lat<i.lat&&(i.lat=n.southWest.lat),n.northEast.lon>r.lon&&(r.lon=n.northEast.lon),n.northEast.lat>r.lat&&(r.lat=n.northEast.lat));for(var s=0;s<this.childrenNodes.length;s++){var n;(n=this.childrenNodes[s].getExtent()).southWest.lon<i.lon&&(i.lon=n.southWest.lon),n.southWest.lat<i.lat&&(i.lat=n.southWest.lat),n.northEast.lon>r.lon&&(r.lon=n.northEast.lon),n.northEast.lat>r.lat&&(r.lat=n.northEast.lat)}return t}}let Bi=["FLOAT","DOUBLE","BOOL","INT","UINT","VEC2","VEC3","VEC4","DVEC2","DVEC3","DVEC4","BVEC2","BVEC3","BVEC4","IVEC2","IVEC3","IVEC4","UVEC2","UVEC3","UVEC4","MAT2","DMAT2","MAT3","DMAT3","MAT4","DMAT4","MAT2X3","MAT2X4","MAT3X2","MAT3X4","MAT4X2","MAT4X3","DMAT2X3","DMAT2X4","DMAT3X2","DMAT3X4","DMAT4X2","DMAT4X3","SAMPLER1D","SAMPLER2D","SAMPLER3D","SAMPLERCUBE","SAMPLER2DSHADOW","SAMPLER2DXX","INTXX","FLOATXX"];const Pi={};for(let t=0;t<Bi.length;t++)Pi[Bi[t]]=t;const Ri={};for(let t=0;t<Bi.length;t++)Ri[Bi[t].toLowerCase()]=Pi[Bi[t]];const zi={u:[],a:[]};zi.u[Pi.MAT4]=function(t,e){t.gl.uniformMatrix4fv(e._pName,!1,e.value)},zi.u[Pi.MAT3]=function(t,e){t.gl.uniformMatrix3fv(e._pName,!1,e.value)},zi.u[Pi.FLOAT]=function(t,e){t.gl.uniform1f(e._pName,e.value)},zi.u[Pi.INT]=function(t,e){t.gl.uniform1i(e._pName,e.value)},zi.u[Pi.VEC2]=function(t,e){t.gl.uniform2fv(e._pName,e.value)},zi.u[Pi.VEC3]=function(t,e){t.gl.uniform3fv(e._pName,e.value)},zi.u[Pi.VEC4]=function(t,e){t.gl.uniform4fv(e._pName,e.value)},zi.u[Pi.SAMPLER2D]=function(t,e){let i=t.gl;i.activeTexture(i.TEXTURE0+t._textureID),i.bindTexture(i.TEXTURE_2D,e.value),i.uniform1i(e._pName,t._textureID),t._textureID++},zi.u[Pi.SAMPLERCUBE]=function(t,e){let i=t.gl;i.activeTexture(i.TEXTURE0+t._textureID),i.bindTexture(i.TEXTURE_CUBE_MAP,e.value),i.uniform1i(e._pName,t._textureID),t._textureID++},zi.u[Pi.SAMPLER2DXX]=function(t,e){let i=t.gl,r=e.value.length,s=new Int32Array(r);for(let n=0;n<r;n++)i.activeTexture(i.TEXTURE0+t._textureID+n),i.bindTexture(i.TEXTURE_2D,e.value[n]),s[n]=n;i.uniform1iv(e._pName,s)},zi.u[Pi.INTXX]=function(t,e){pgl.uniform1iv(e._pName,e.value)},zi.u[Pi.FLOATXX]=function(t,e){t.gl.uniform1fv(e._pName,e.value)},zi.a[Pi.FLOAT]=function(t,e){t.gl.vertexAttrib1f(e._pName,e.value)},zi.a[Pi.VEC2]=function(t,e){t.gl.vertexAttrib2fv(e._pName,e.value)},zi.a[Pi.VEC3]=function(t,e){t.gl.vertexAttrib3fv(e._pName,e.value)},zi.a[Pi.VEC4]=function(t,e){t.gl.vertexAttrib4fv(e._pName,e.value)};const Mi=new class{constructor(){this._container=document.createElement("div"),this._container.classList.add("ogConsole"),this._container.style.display="none",document.body&&document.body.appendChild(this._container),this._visibility=!1}getVisibility(){return this._visibility}setVisibility(t){this._visibility!=t&&(this._visibility=t,this._visibility?this.show():this.hide())}show(){this._container.parentNode||document.body&&document.body.appendChild(this._container),this._container.style.display="block",this._visibility=!0}hide(){this._container.style.display="none",this._visibility=!1}logErr(t){var e=document.createElement("div");e.classList.add("ogConsole-text"),e.classList.add("ogConsole-error"),e.innerHTML="error: "+t,console.log(e.innerHTML),this._container.appendChild(e),this.show()}logWrn(t){var e=document.createElement("div");e.classList.add("ogConsole-text"),e.classList.add("ogConsole-warning"),e.innerHTML="warning: "+t,console.log(e.innerHTML),this._container.appendChild(e),this.show()}log(t,e){var i=document.createElement("div");if(i.classList.add("ogConsole-text"),e)for(var r in e)i.style[r]=e[r];i.innerHTML=t,console.log(t),this._container.appendChild(i),this.show()}};class Fi{constructor(t,e){this.name=t,this.attributes={},this.uniforms={},this._attributes={};for(let t in e.attributes)"string"==typeof e.attributes[t]||"number"==typeof e.attributes[t]?this._attributes[t]={type:e.attributes[t]}:this._attributes[t]=e.attributes[t];this._uniforms={};for(let t in e.uniforms)"string"==typeof e.uniforms[t]||"number"==typeof e.uniforms[t]?this._uniforms[t]={type:e.uniforms[t]}:this._uniforms[t]=e.uniforms[t];this.vertexShader=e.vertexShader,this.fragmentShader=e.fragmentShader,this.gl=null,this._variables={},this._p=null,this._textureID=0,this._attribArrays=[]}use(){this.gl.useProgram(this._p)}set(t){for(var e in this._textureID=0,t)this._variables[e].value=t[e],this._variables[e]._callback(this,this._variables[e])}apply(){this._textureID=0;var t=this._variables;for(var e in t)t[e]._callback(this,t[e])}drawIndexBuffer(t,e){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,e),this.gl.drawElements(t,e.numItems,this.gl.UNSIGNED_SHORT,0)}drawArray(t,e){this.gl.drawArrays(t,0,e)}_getShaderCompileStatus(t,e){return this.gl.shaderSource(t,e),this.gl.compileShader(t),!!this.gl.getShaderParameter(t,this.gl.COMPILE_STATUS)||(Mi.logErr("og/shaderProgram/ShaderProgram:"+this.name+" - "+this.gl.getShaderInfoLog(t)+"."),!1)}_createVertexShader(t){var e=this.gl.createShader(this.gl.VERTEX_SHADER);return this._getShaderCompileStatus(e,t)?e:null}_createFragmentShader(t){var e=this.gl.createShader(this.gl.FRAGMENT_SHADER);return this._getShaderCompileStatus(e,t)?e:null}disableAttribArrays(){for(var t=this.gl,e=this._attribArrays,i=e.length;i--;)t.disableVertexAttribArray(e[i])}enableAttribArrays(){for(var t=this.gl,e=this._attribArrays,i=e.length;i--;)t.enableVertexAttribArray(e[i])}delete(){this.gl.deleteProgram(this._p)}createProgram(t){this.gl=t,this._p=this.gl.createProgram();var e=this._createFragmentShader(this.fragmentShader),i=this._createVertexShader(this.vertexShader);if(t.attachShader(this._p,e),t.attachShader(this._p,i),t.linkProgram(this._p),!t.getProgramParameter(this._p,t.LINK_STATUS))return Mi.logErr("og/shaderProgram/ShaderProgram:"+this.name+" - couldn't initialise shaders. "+t.getProgramInfoLog(this._p)+"."),void t.deleteProgram(this._p);for(var r in this.use(),this._attributes){if(this._variables[r]=this._attributes[r],this._attributes[r].enableArray=void 0==this._attributes[r].enableArray||this._attributes[r].enableArray,this._attributes[r].enableArray?this._attributes[r]._callback=Fi.bindBuffer:"string"==typeof this._attributes[r].type?this._attributes[r]._callback=zi.a[Ri[this._attributes[r].type.trim().toLowerCase()]]:this._attributes[r]._callback=zi.a[this._attributes[r].type],this._p[r]=t.getAttribLocation(this._p,r),void 0==this._p[r])return Mi.logErr("og/shaderProgram/ShaderProgram:"+this.name+" - attribute '"+r+"' is not exists."),void t.deleteProgram(this._p);this._attributes[r].enableArray&&(this._attribArrays.push(this._p[r]),t.enableVertexAttribArray(this._p[r])),this._attributes[r]._pName=this._p[r],this.attributes[r]=this._p[r]}for(var s in this._uniforms){if("string"==typeof this._uniforms[s].type?this._uniforms[s]._callback=zi.u[Ri[this._uniforms[s].type.trim().toLowerCase()]]:this._uniforms[s]._callback=zi.u[this._uniforms[s].type],this._variables[s]=this._uniforms[s],this._p[s]=t.getUniformLocation(this._p,s),void 0==this._p[s])return Mi.logErr("og/shaderProgram/ShaderProgram:"+this.name+" - uniform '"+s+"' is not exists."),void t.deleteProgram(this._p);this._uniforms[s]._pName=this._p[s],this.uniforms[s]=this._p[s]}t.detachShader(this._p,e),t.detachShader(this._p,i)}static bindBuffer(t,e){var i=t.gl;i.bindBuffer(i.ARRAY_BUFFER,e.value),i.vertexAttribPointer(e._pName,e.value.itemSize,i.FLOAT,!1,0,0)}}const Si=0,Di=1,Li=2,Ni=3,Ii=4,ki=5,Oi=6,Ui=7,Vi=8;class Hi{constructor(t){this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._billboards=[],this._positionBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._texCoordBuffer=null,this._vertexBuffer=null,this._alignedAxisBuffer=null,this._texCoordArr=[],this._vertexArr=[],this._positionArr=[],this._sizeArr=[],this._offsetArr=[],this._rgbaArr=[],this._rotationArr=[],this._alignedAxisArr=[],this._pickingColorBuffer=null,this._pickingColorArr=[],this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[Si]=this.createPickingColorBuffer,this._buffersUpdateCallbacks[Di]=this.createPositionBuffer,this._buffersUpdateCallbacks[Li]=this.createSizeBuffer,this._buffersUpdateCallbacks[Ni]=this.createOffsetBuffer,this._buffersUpdateCallbacks[Ii]=this.createRgbaBuffer,this._buffersUpdateCallbacks[ki]=this.createRotationBuffer,this._buffersUpdateCallbacks[Oi]=this.createTexCoordBuffer,this._buffersUpdateCallbacks[Ui]=this.createVertexBuffer,this._buffersUpdateCallbacks[Vi]=this.createAlignedAxisBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),this.__staticId=Hi._staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}static concArr(t,e){for(var i=0;i<e.length;i++)t.push(e[i])}initShaderProgram(){if(this._renderer.handler){if(!this._renderer.handler.shaderPrograms.billboard){var t=!this._renderer.isMultiFramebufferCompatible();this._renderer.handler.addShaderProgram(function(t){var e;return e=t?"precision highp float;\n            uniform sampler2D u_texture;            varying vec2 v_texCoords;            varying vec4 v_rgba;            void main () {                vec4 color = texture2D(u_texture, v_texCoords);                if(color.a < 0.1)                    discard;                gl_FragColor = color * v_rgba;            }":"#extension GL_EXT_draw_buffers : require\n            precision highp float;\n            uniform sampler2D u_texture;            varying vec2 v_texCoords;            varying vec4 v_rgba;            void main () {                vec4 color = texture2D(u_texture, v_texCoords);                if(color.a < 0.1)                    discard;                gl_FragData[0] = color * v_rgba;                gl_FragData[1] = vec4(0.0);            }",new Fi("billboard",{uniforms:{u_texture:{type:Pi.SAMPLER2D},projectionMatrix:{type:Pi.MAT4},viewMatrix:{type:Pi.MAT4},uCamPos:{type:Pi.VEC3},uFloatParams:{type:Pi.VEC2},uScaleByDistance:{type:Pi.VEC3},uOpacity:{type:Pi.FLOAT}},attributes:{a_vertices:{type:Pi.VEC2,enableArray:!0},a_texCoord:{type:Pi.VEC2,enableArray:!0},a_positions:{type:Pi.VEC4,enableArray:!0},a_size:{type:Pi.VEC2,enableArray:!0},a_offset:{type:Pi.VEC3,enableArray:!0},a_rgba:{type:Pi.VEC4,enableArray:!0},a_rotation:{type:Pi.FLOAT,enableArray:!0},a_alignedAxis:{type:Pi.VEC3,enableArray:!0}},vertexShader:"precision highp float;\n            attribute vec2 a_vertices;            attribute vec2 a_texCoord;            attribute vec4 a_positions;            attribute vec3 a_offset;            attribute vec2 a_size;            attribute float a_rotation;            attribute vec4 a_rgba;            attribute vec3 a_alignedAxis;            varying vec2 v_texCoords;            varying vec4 v_rgba;            uniform mat4 viewMatrix;            uniform mat4 projectionMatrix;            uniform vec3 uCamPos;            uniform vec2 uFloatParams;            uniform vec3 uScaleByDistance;            uniform float uOpacity;            const vec3 ZERO3 = vec3(0.0);            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main() {                v_texCoords = a_texCoord;                vec3 look = a_positions.xyz - uCamPos;                float lookLength = length(look);                v_rgba = a_rgba;                /*v_rgba.a *= uOpacity * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions.xyz,a_positions.xyz) - uFloatParams[0]));*/                if(uOpacity * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions.xyz,a_positions.xyz) - uFloatParams[0])) == 0.0){                    return;                }                v_rgba.a *= uOpacity;                vec3 right, up;                if(a_alignedAxis == ZERO3){                    up = vec3( viewMatrix[0][1], viewMatrix[1][1], viewMatrix[2][1] );                    right = vec3( viewMatrix[0][0], viewMatrix[1][0], viewMatrix[2][0] );                }else{                    up = normalize(a_alignedAxis);                    right = normalize(cross(look,up));                    look = cross(up,right);                }                float dist = dot(uCamPos - a_positions.xyz, vec3(viewMatrix[0][2], viewMatrix[1][2], viewMatrix[2][2]));                float focalSize = 2.0 * dist * uFloatParams[1];                vec2 offset = a_offset.xy * focalSize;                float scd = a_positions.w * (1.0 - smoothstep(uScaleByDistance[0], uScaleByDistance[1], lookLength)) * (1.0 - step(uScaleByDistance[2], lookLength));                vec2 scale = a_size * focalSize * scd;                float cosRot = cos(a_rotation);                float sinRot = sin(a_rotation);                vec3 rr = (right * cosRot - up * sinRot) * (scale.x * a_vertices.x + scd * offset.x) + (right * sinRot + up * cosRot) * (scale.y * a_vertices.y + scd * offset.y) + a_positions.xyz;                gl_Position = projectionMatrix * viewMatrix * vec4(rr, 1);                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                gl_Position.z += a_offset.z;            }",fragmentShader:e})}(t))}this._renderer.handler.shaderPrograms.billboardPicking||this._renderer.handler.addShaderProgram(new Fi("billboardPicking",{uniforms:{projectionMatrix:{type:Pi.MAT4},viewMatrix:{type:Pi.MAT4},uCamPos:{type:Pi.VEC3},uFloatParams:{type:Pi.VEC2},uScaleByDistance:{type:Pi.VEC3},uOpacity:{type:Pi.FLOAT}},attributes:{a_vertices:{type:Pi.VEC2,enableArray:!0},a_positions:{type:Pi.VEC4,enableArray:!0},a_size:{type:Pi.VEC2,enableArray:!0},a_offset:{type:Pi.VEC3,enableArray:!0},a_pickingColor:{type:Pi.VEC3,enableArray:!0},a_rotation:{type:Pi.FLOAT,enableArray:!0},a_alignedAxis:{type:Pi.VEC3,enableArray:!0}},vertexShader:"precision highp float;\n            attribute vec2 a_vertices;            attribute vec4 a_positions;            attribute vec3 a_offset;            attribute vec2 a_size;            attribute float a_rotation;            attribute vec3 a_pickingColor;            attribute vec3 a_alignedAxis;            varying vec4 v_color;            uniform mat4 viewMatrix;            uniform mat4 projectionMatrix;            uniform vec3 uCamPos;            uniform vec2 uFloatParams;            uniform vec3 uScaleByDistance;            uniform float uOpacity;            const vec3 ZERO3 = vec3(0.0);            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main() {                vec3 look = a_positions.xyz - uCamPos;                float lookLength = length(look);                if( uOpacity == 0.0 ) {                    gl_Position = vec4(0.0);                    return;                }                v_color = vec4(a_pickingColor.rgb, 1.0) * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions.xyz, a_positions.xyz) - uFloatParams[0]));                vec3 right, up;                if(a_alignedAxis == ZERO3){                    up = vec3( viewMatrix[0][1], viewMatrix[1][1], viewMatrix[2][1] );                    right = vec3( viewMatrix[0][0], viewMatrix[1][0], viewMatrix[2][0] );                }else{                    up = normalize(a_alignedAxis);                    right = normalize(cross(look,up));                    look = cross(up,right);                }                float dist = dot(uCamPos - a_positions.xyz, vec3(viewMatrix[0][2], viewMatrix[1][2], viewMatrix[2][2]));                float focalSize = 2.0 * dist * uFloatParams[1];                vec2 offset = a_offset.xy * focalSize;                float scd = a_positions.w * (1.0 - smoothstep(uScaleByDistance[0], uScaleByDistance[1], lookLength)) *(1.0 - step(uScaleByDistance[2], lookLength));                vec2 scale = a_size * focalSize * scd;                float cosRot = cos(a_rotation);                float sinRot = sin(a_rotation);                vec3 rr = (right * cosRot - up * sinRot) * (scale.x * a_vertices.x + scd * offset.x) + (right * sinRot + up * cosRot) * (scale.y * a_vertices.y + scd * offset.y) + a_positions.xyz;                gl_Position = projectionMatrix * viewMatrix * vec4(rr, 1);                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                gl_Position.z += a_offset.z;            }",fragmentShader:"precision highp float;\n            varying vec4 v_color;            void main () {                gl_FragColor = v_color;            }"}))}}setRenderer(t){this._renderer=t,this.initShaderProgram()}refresh(){for(var t=this._changedBuffers.length;t--;)this._changedBuffers[t]=!0}_removeBillboards(){for(var t=this._billboards.length;t--;){var e=this._billboards[t];e._handlerIndex=-1,e._handler=null}this._billboards.length=0,this._billboards=[]}clear(){this._texCoordArr.length=0,this._vertexArr.length=0,this._positionArr.length=0,this._sizeArr.length=0,this._offsetArr.length=0,this._rgbaArr.length=0,this._rotationArr.length=0,this._alignedAxisArr.length=0,this._pickingColorArr.length=0,this._texCoordArr=[],this._vertexArr=[],this._positionArr=[],this._sizeArr=[],this._offsetArr=[],this._rgbaArr=[],this._rotationArr=[],this._alignedAxisArr=[],this._pickingColorArr=[],this._removeBillboards(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){var t=this._renderer.handler.gl;t.deleteBuffer(this._positionBuffer),t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._offsetBuffer),t.deleteBuffer(this._rgbaBuffer),t.deleteBuffer(this._rotationBuffer),t.deleteBuffer(this._vertexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._alignedAxisBuffer),t.deleteBuffer(this._pickingColorBuffer),this._positionBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._alignedAxisBuffer=null,this._pickingColorBuffer=null}update(){if(this._renderer)for(var t=this._changedBuffers.length;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}add(t){-1==t._handlerIndex&&(t._handler=this,t._handlerIndex=this._billboards.length,this._billboards.push(t),this._addBillboardToArrays(t),this.refresh(),t.setSrc(t._src||t._image&&t._image.src))}_addBillboardToArrays(t){t._visibility?Hi.concArr(this._vertexArr,[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]):Hi.concArr(this._vertexArr,[0,0,0,0,0,0,0,0,0,0,0,0]),Hi.concArr(this._texCoordArr,[0,0,0,0,0,0,0,0,0,0,0,0]);var e=t._position.x,i=t._position.y,r=t._position.z,s=t._scale;Hi.concArr(this._positionArr,[e,i,r,s,e,i,r,s,e,i,r,s,e,i,r,s,e,i,r,s,e,i,r,s]),e=t._width,i=t._height,Hi.concArr(this._sizeArr,[e,i,e,i,e,i,e,i,e,i,e,i]),e=t._offset.x,i=t._offset.y,r=t._offset.z,Hi.concArr(this._offsetArr,[e,i,r,e,i,r,e,i,r,e,i,r,e,i,r,e,i,r]),e=t._color.x,i=t._color.y,r=t._color.z,s=t._color.w,Hi.concArr(this._rgbaArr,[e,i,r,s,e,i,r,s,e,i,r,s,e,i,r,s,e,i,r,s,e,i,r,s]),e=t._rotation,Hi.concArr(this._rotationArr,[e,e,e,e,e,e]),e=t._alignedAxis.x,i=t._alignedAxis.y,r=t._alignedAxis.z,Hi.concArr(this._alignedAxisArr,[e,i,r,e,i,r,e,i,r,e,i,r,e,i,r,e,i,r]),e=t._entity._pickingColor.x/255,i=t._entity._pickingColor.y/255,r=t._entity._pickingColor.z/255,Hi.concArr(this._pickingColorArr,[e,i,r,e,i,r,e,i,r,e,i,r,e,i,r,e,i,r])}_displayPASS(){var t=this._renderer,e=t.handler;e.shaderPrograms.billboard.activate();var i=e.shaderPrograms.billboard._program,r=i.attributes,s=i.uniforms,n=e.gl;n.uniform1i(s.u_texture,0),n.uniformMatrix4fv(s.viewMatrix,!1,t.activeCamera._viewMatrix._m),n.uniformMatrix4fv(s.projectionMatrix,!1,t.activeCamera._projectionMatrix._m),n.uniform3fv(s.uCamPos,t.activeCamera.eye.toVec()),n.uniform3fv(s.uScaleByDistance,this._entityCollection.scaleByDistance),n.uniform1f(s.uOpacity,this._entityCollection._fadingOpacity),n.uniform2fv(s.uFloatParams,[this._entityCollection.renderNode._planetRadius2||0,t.activeCamera._tanViewAngle_hradOneByHeight]),n.bindBuffer(n.ARRAY_BUFFER,this._texCoordBuffer),n.vertexAttribPointer(r.a_texCoord,this._texCoordBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._vertexBuffer),n.vertexAttribPointer(r.a_vertices,this._vertexBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._positionBuffer),n.vertexAttribPointer(r.a_positions,this._positionBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._rgbaBuffer),n.vertexAttribPointer(r.a_rgba,this._rgbaBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._sizeBuffer),n.vertexAttribPointer(r.a_size,this._sizeBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._offsetBuffer),n.vertexAttribPointer(r.a_offset,this._offsetBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._rotationBuffer),n.vertexAttribPointer(r.a_rotation,this._rotationBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._alignedAxisBuffer),n.vertexAttribPointer(r.a_alignedAxis,this._alignedAxisBuffer.itemSize,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLES,0,this._vertexBuffer.numItems)}_pickingPASS(){var t=this._renderer,e=t.handler;e.shaderPrograms.billboardPicking.activate();var i=e.shaderPrograms.billboardPicking._program,r=i.attributes,s=i.uniforms,n=e.gl;n.uniformMatrix4fv(s.viewMatrix,!1,t.activeCamera._viewMatrix._m),n.uniformMatrix4fv(s.projectionMatrix,!1,t.activeCamera._projectionMatrix._m),n.uniform3fv(s.uCamPos,t.activeCamera.eye.toVec()),n.uniform3fv(s.uScaleByDistance,this._entityCollection.scaleByDistance),n.uniform1f(s.uOpacity,this._entityCollection._fadingOpacity),n.uniform2fv(s.uFloatParams,[this._entityCollection.renderNode._planetRadius2||0,t.activeCamera._tanViewAngle_hradOneByHeight]),n.bindBuffer(n.ARRAY_BUFFER,this._vertexBuffer),n.vertexAttribPointer(r.a_vertices,this._vertexBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._positionBuffer),n.vertexAttribPointer(r.a_positions,this._positionBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._pickingColorBuffer),n.vertexAttribPointer(r.a_pickingColor,this._pickingColorBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._sizeBuffer),n.vertexAttribPointer(r.a_size,this._sizeBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._offsetBuffer),n.vertexAttribPointer(r.a_offset,this._offsetBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._rotationBuffer),n.vertexAttribPointer(r.a_rotation,this._rotationBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._alignedAxisBuffer),n.vertexAttribPointer(r.a_alignedAxis,this._alignedAxisBuffer.itemSize,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLES,0,this._vertexBuffer.numItems)}draw(){this._billboards.length&&(this.update(),this._displayPASS())}drawPicking(){this._billboards.length&&this.pickingEnabled&&this._pickingPASS()}reindexBillbordsArray(t){for(var e=this._billboards,i=t;i<e.length;i++)e[i]._handlerIndex=i}_removeBillboard(t){var e=t._handlerIndex;this._billboards.splice(e,1);var i=24*e;this._rgbaArr.splice(i,24),this._positionArr.splice(i,24),i=18*e,this._offsetArr.splice(i,18),this._alignedAxisArr.splice(i,18),this._pickingColorArr.splice(i,18),i=12*e,this._vertexArr.splice(i,12),this._sizeArr.splice(i,12),this._texCoordArr.splice(i,12),i=6*e,this._rotationArr.splice(i,6),this.reindexBillbordsArray(e),this.refresh(),t._handlerIndex=-1,t._handler=null}remove(t){t._handler&&this.__staticId==t._handler.__staticId&&this._removeBillboard(t)}setPositionArr(t,e){var i=24*t,r=this._positionArr,s=e.x,n=e.y,o=e.z;r[i]=s,r[i+1]=n,r[i+2]=o,r[i+4]=s,r[i+5]=n,r[i+6]=o,r[i+8]=s,r[i+9]=n,r[i+10]=o,r[i+12]=s,r[i+13]=n,r[i+14]=o,r[i+16]=s,r[i+17]=n,r[i+18]=o,r[i+20]=s,r[i+21]=n,r[i+22]=o,this._changedBuffers[Di]=!0}setScaleArr(t,e){var i=24*t,r=this._positionArr;r[i+3]=e,r[i+7]=e,r[i+11]=e,r[i+15]=e,r[i+19]=e,r[i+23]=e,this._changedBuffers[Di]=!0}setPickingColorArr(t,e){var i=18*t,r=this._pickingColorArr,s=e.x/255,n=e.y/255,o=e.z/255;r[i]=s,r[i+1]=n,r[i+2]=o,r[i+3]=s,r[i+4]=n,r[i+5]=o,r[i+6]=s,r[i+7]=n,r[i+8]=o,r[i+9]=s,r[i+10]=n,r[i+11]=o,r[i+12]=s,r[i+13]=n,r[i+14]=o,r[i+15]=s,r[i+16]=n,r[i+17]=o,this._changedBuffers[Si]=!0}setSizeArr(t,e,i){var r=12*t,s=this._sizeArr,n=e,o=i;s[r]=n,s[r+1]=o,s[r+2]=n,s[r+3]=o,s[r+4]=n,s[r+5]=o,s[r+6]=n,s[r+7]=o,s[r+8]=n,s[r+9]=o,s[r+10]=n,s[r+11]=o,this._changedBuffers[Li]=!0}setOffsetArr(t,e){var i=18*t,r=this._offsetArr,s=e.x,n=e.y,o=e.z;r[i]=s,r[i+1]=n,r[i+2]=o,r[i+3]=s,r[i+4]=n,r[i+5]=o,r[i+6]=s,r[i+7]=n,r[i+8]=o,r[i+9]=s,r[i+10]=n,r[i+11]=o,r[i+12]=s,r[i+13]=n,r[i+14]=o,r[i+15]=s,r[i+16]=n,r[i+17]=o,this._changedBuffers[Ni]=!0}setRgbaArr(t,e){var i=24*t,r=this._rgbaArr,s=e.x,n=e.y,o=e.z,a=e.w;r[i]=s,r[i+1]=n,r[i+2]=o,r[i+3]=a,r[i+4]=s,r[i+5]=n,r[i+6]=o,r[i+7]=a,r[i+8]=s,r[i+9]=n,r[i+10]=o,r[i+11]=a,r[i+12]=s,r[i+13]=n,r[i+14]=o,r[i+15]=a,r[i+16]=s,r[i+17]=n,r[i+18]=o,r[i+19]=a,r[i+20]=s,r[i+21]=n,r[i+22]=o,r[i+23]=a,this._changedBuffers[Ii]=!0}setRotationArr(t,e){var i=6*t,r=this._rotationArr;r[i]=e,r[i+1]=e,r[i+2]=e,r[i+3]=e,r[i+4]=e,r[i+5]=e,this._changedBuffers[ki]=!0}setTexCoordArr(t,e){var i=12*t,r=this._texCoordArr;r[i]=e[0],r[i+1]=e[1],r[i+2]=e[2],r[i+3]=e[3],r[i+4]=e[4],r[i+5]=e[5],r[i+6]=e[6],r[i+7]=e[7],r[i+8]=e[8],r[i+9]=e[9],r[i+10]=e[10],r[i+11]=e[11],this._changedBuffers[Oi]=!0}setVisibility(t,e){var i;i=e?[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(t,i)}setVertexArr(t,e){var i=12*t,r=this._vertexArr;r[i]=e[0],r[i+1]=e[1],r[i+2]=e[2],r[i+3]=e[3],r[i+4]=e[4],r[i+5]=e[5],r[i+6]=e[6],r[i+7]=e[7],r[i+8]=e[8],r[i+9]=e[9],r[i+10]=e[10],r[i+11]=e[11],this._changedBuffers[Ui]=!0}setAlignedAxisArr(t,e){var i=18*t,r=this._alignedAxisArr,s=e.x,n=e.y,o=e.z;r[i]=s,r[i+1]=n,r[i+2]=o,r[i+3]=s,r[i+4]=n,r[i+5]=o,r[i+6]=s,r[i+7]=n,r[i+8]=o,r[i+9]=s,r[i+10]=n,r[i+11]=o,r[i+12]=s,r[i+13]=n,r[i+14]=o,r[i+15]=s,r[i+16]=n,r[i+17]=o,this._changedBuffers[Vi]=!0}createPositionBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._positionBuffer),this._positionBuffer=t.createArrayBuffer(new Float32Array(this._positionArr),4,this._positionArr.length/4,t.gl.DYNAMIC_DRAW)}createSizeBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=t.createArrayBuffer(new Float32Array(this._sizeArr),2,this._sizeArr.length/2)}createOffsetBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._offsetBuffer),this._offsetBuffer=t.createArrayBuffer(new Float32Array(this._offsetArr),3,this._offsetArr.length/3)}createRgbaBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._rgbaBuffer),this._rgbaBuffer=t.createArrayBuffer(new Float32Array(this._rgbaArr),4,this._rgbaArr.length/4)}createRotationBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._rotationBuffer),this._rotationBuffer=t.createArrayBuffer(new Float32Array(this._rotationArr),1,this._rotationArr.length,t.gl.DYNAMIC_DRAW)}createVertexBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._vertexBuffer),this._vertexBuffer=t.createArrayBuffer(new Float32Array(this._vertexArr),2,this._vertexArr.length/2,t.gl.DYNAMIC_DRAW)}createTexCoordBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=t.createArrayBuffer(new Float32Array(this._texCoordArr),2,this._texCoordArr.length/2,t.gl.DYNAMIC_DRAW)}createAlignedAxisBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._alignedAxisBuffer),this._alignedAxisBuffer=t.createArrayBuffer(new Float32Array(this._alignedAxisArr),3,this._alignedAxisArr.length/3)}createPickingColorBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorBuffer=t.createArrayBuffer(new Float32Array(this._pickingColorArr),3,this._pickingColorArr.length/3)}refreshTexCoordsArr(){var t=this._entityCollection;if(t&&t.renderNode)for(var e=t.renderNode.billboardsTextureAtlas,i=0;i<this._billboards.length;i++){var r=this._billboards[i];if(r._image){var s=e.nodes[r._image.__nodeIndex];s&&this.setTexCoordArr(r._handlerIndex,s.texCoords)}}}}class Xi{constructor(t,e){this._eventNames=[],t&&this.registerNames(t),this._sender=e||this,this._counter=0,this._stopPropagation=!1,this._stampCache={},this.__id=Xi.__staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}bindSender(t){this._sender=t||this}registerNames(t){for(var e=0;e<t.length;e++)this[t[e]]={active:!0,handlers:[]},this._eventNames.push(t[e])}_stamp(t,e){var i=qt(e),r=t+"_"+this.__id+"_"+i;return!this._stampCache[r]&&(this._stampCache[r]=i,!0)}on(t,e,i){this._stamp(t,e)&&this[t]&&this[t].handlers.unshift(e.bind(i||this._sender))}off(t,e){var i=t+"_"+this.__id+"_"+e._openglobus_id;if(e._openglobus_id&&this._stampCache[i]){for(var r=this[t].handlers,s=r.length,n=-1;s--;){if(r[s]._openglobus_id===e._openglobus_id){n=s;break}}-1!==n&&(r.splice(n,1),this._stampCache[i]=void 0,delete this._stampCache[i])}}dispatch(t,e){if(t&&t.active)for(var i=t.handlers,r=i.length;r--&&!this._stopPropagation;)i[r](e);this._stopPropagation=!1}stopPropagation(){this._stopPropagation=!0}clear(){for(var t=0;t<this._eventNames.length;t++){var e=this[this._eventNames[t]];e.handlers.length=0,e.handlers=[]}this._eventNames.length=0,this._eventNames=[]}}const Wi=0,Yi=1,ji=2,Gi=3,qi=4,Ki=5,Zi=6,Qi=7,Ji=8,$i=9,tr=10,er=11;class ir extends Hi{constructor(t){super(t),this._fontIndexBuffer=null,this._noOutlineBuffer=null,this._outlineBuffer=null,this._outlineColorBuffer=null,this._fontIndexArr=[],this._noOutlineArr=[],this._outlineArr=[],this._outlineColorArr=[],this._buffersUpdateCallbacks[$i]=this.createFontIndexBuffer,this._buffersUpdateCallbacks[tr]=this.createOutlineBuffer,this._buffersUpdateCallbacks[er]=this.createOutlineColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),this._maxLetters=25}initShaderProgram(){if(this._renderer.handler){if(!this._renderer.handler.shaderPrograms.label){var t=!this._renderer.isMultiFramebufferCompatible();this._renderer.handler.addShaderProgram(function(t){var e;return e=t?"#extension GL_OES_standard_derivatives : enable\n            precision highp float;\n            const int MAX_SIZE = 12;\n            uniform sampler2D u_fontTextureArr[MAX_SIZE];\n            varying float v_fontIndex;\n            varying vec2 v_texCoords;\n            varying vec4 v_rgba;\n            varying vec3 v_bufferAA;\n            varying vec3 v_pickingColor;\n            void main () {\n                int fi = int(v_fontIndex);\n                vec4 color;\n                if (fi == 0) {\n                    color = texture2D(u_fontTextureArr[0], v_texCoords);\n                } else if (fi == 1) {\n                    color = texture2D(u_fontTextureArr[1], v_texCoords);\n                } else if (fi == 2) {\n                    color = texture2D(u_fontTextureArr[2], v_texCoords);\n                } else if (fi == 3) {\n                    color = texture2D(u_fontTextureArr[3], v_texCoords);\n                } else if (fi == 4) {\n                    color = texture2D(u_fontTextureArr[4], v_texCoords);\n                } else if (fi == 5) {\n                    color = texture2D(u_fontTextureArr[5], v_texCoords);\n                } else if (fi == 6) {\n                    color = texture2D(u_fontTextureArr[6], v_texCoords);\n                } else if (fi == 7) {\n                    color = texture2D(u_fontTextureArr[7], v_texCoords);\n                } else if (fi == 8) {\n                    color = texture2D(u_fontTextureArr[8], v_texCoords);\n                } else if (fi == 9) {\n                    color = texture2D(u_fontTextureArr[9], v_texCoords);\n                }else{\n                    color = texture2D(u_fontTextureArr[10], v_texCoords);\n                }\n                float afwidth = step(0.5, v_bufferAA.x) * (1.0 - v_bufferAA.y) * v_bufferAA.x * fwidth( color.r );\n                float alpha = smoothstep ( v_bufferAA.x - afwidth - v_bufferAA.z, v_bufferAA.x + afwidth + v_bufferAA.z, color.r );\n                if( alpha < 0.2 )\n                    discard;\n                gl_FragColor = vec4(v_rgba.rgb, alpha * v_rgba.a);\n            }":"#extension GL_OES_standard_derivatives : enable\n            #extension GL_EXT_draw_buffers : require\n            precision highp float;\n            const int MAX_SIZE = 12;\n            uniform sampler2D u_fontTextureArr[MAX_SIZE];\n            varying float v_fontIndex;\n            varying vec2 v_texCoords;\n            varying vec4 v_rgba;\n            varying vec3 v_bufferAA;\n            varying vec3 v_pickingColor;\n            void main () {\n                int fi = int(v_fontIndex);\n                vec4 color;\n                if (fi == 0) {\n                    color = texture2D(u_fontTextureArr[0], v_texCoords);\n                } else if (fi == 1) {\n                    color = texture2D(u_fontTextureArr[1], v_texCoords);\n                } else if (fi == 2) {\n                    color = texture2D(u_fontTextureArr[2], v_texCoords);\n                } else if (fi == 3) {\n                    color = texture2D(u_fontTextureArr[3], v_texCoords);\n                } else if (fi == 4) {\n                    color = texture2D(u_fontTextureArr[4], v_texCoords);\n                } else if (fi == 5) {\n                    color = texture2D(u_fontTextureArr[5], v_texCoords);\n                } else if (fi == 6) {\n                    color = texture2D(u_fontTextureArr[6], v_texCoords);\n                } else if (fi == 7) {\n                    color = texture2D(u_fontTextureArr[7], v_texCoords);\n                } else if (fi == 8) {\n                    color = texture2D(u_fontTextureArr[8], v_texCoords);\n                } else if (fi == 9) {\n                    color = texture2D(u_fontTextureArr[9], v_texCoords);\n                }else{\n                    color = texture2D(u_fontTextureArr[10], v_texCoords);\n                }\n                float afwidth = step(0.5, v_bufferAA.x) * (1.0 - v_bufferAA.y) * v_bufferAA.x * fwidth( color.r );\n                float alpha = smoothstep ( v_bufferAA.x - afwidth - v_bufferAA.z, v_bufferAA.x + afwidth + v_bufferAA.z, color.r );\n                if( alpha < 0.2 )\n                    discard;\n                gl_FragData[0] = vec4(v_rgba.rgb, alpha * v_rgba.a);\n                gl_FragData[1] = vec4(0.0);\n            }",new Fi("label",{uniforms:{u_fontTextureArr:{type:Pi.SAMPLER2DXX},projectionMatrix:{type:Pi.MAT4},viewMatrix:{type:Pi.MAT4},uCamPos:{type:Pi.VEC3},uFloatParams:{type:Pi.VEC2},uZ:{type:Pi.FLOAT},uScaleByDistance:{type:Pi.VEC3},uOpacity:{type:Pi.FLOAT}},attributes:{a_vertices:{type:Pi.VEC2,enableArray:!0},a_texCoord:{type:Pi.VEC4,enableArray:!0},a_positions:{type:Pi.VEC4,enableArray:!0},a_size:{type:Pi.FLOAT,enableArray:!0},a_offset:{type:Pi.VEC3,enableArray:!0},a_rgba:{type:Pi.VEC4,enableArray:!0},a_rotation:{type:Pi.FLOAT,enableArray:!0},a_alignedAxis:{type:Pi.VEC3,enableArray:!0},a_fontIndex:{type:Pi.FLOAT,enableArray:!0},a_bufferAA:{type:Pi.VEC2,enableArray:!0}},vertexShader:"attribute vec2 a_vertices;\n            attribute vec4 a_texCoord;\n            attribute vec4 a_positions;\n            attribute vec3 a_offset;\n            attribute float a_size;\n            attribute float a_rotation;\n            attribute vec4 a_rgba;\n            attribute vec3 a_alignedAxis;\n            attribute float a_fontIndex;\n            attribute vec2 a_bufferAA;\n            varying vec2 v_texCoords;\n            varying vec4 v_rgba;\n            varying float v_fontIndex;\n            varying vec3 v_bufferAA;\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n            uniform vec3 uCamPos;\n            /*0 - planetRadius^2, 1 - tan(fov), 2 - screen ratio*/\n            uniform vec2 uFloatParams;\n            uniform float uZ;\n            uniform vec3 uScaleByDistance;\n            uniform float uOpacity;\n            const vec3 ZERO3 = vec3(0.0);\n            const float C = 0.1;\n            const float far = 149.6e+9;\n            float logc = 2.0 / log( C * far + 1.0 );\n            void main() {\n                if(a_texCoord.z == -1.0 || a_bufferAA.x == 1.0){\n                    gl_Position = vec4(0.0);\n                    return;\n                }\n                v_fontIndex = a_fontIndex;\n                v_texCoords = vec2(a_texCoord.xy);\n                vec3 look = a_positions.xyz - uCamPos;\n                float lookDist = length(look);                \n                v_rgba = a_rgba;\n                /*v_rgba.a *= uOpacity * step(lookDist, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions.xyz,a_positions.xyz) - uFloatParams[0]));*/\n                if(uOpacity * step(lookDist, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions.xyz,a_positions.xyz) - uFloatParams[0]))==0.0){\n                    return;\n                }\n                v_rgba.a *= uOpacity;\n                vec3 right, up;\n                if(a_alignedAxis == ZERO3){\n                    up = vec3( viewMatrix[0][1], viewMatrix[1][1], viewMatrix[2][1] );\n                    right = vec3( viewMatrix[0][0], viewMatrix[1][0], viewMatrix[2][0] );\n                }else{\n                    up = normalize(a_alignedAxis);\n                    right = normalize(cross(look,up));\n                    look = cross(up,right);\n                }\n                v_bufferAA = vec3(a_bufferAA, 8.0 * a_bufferAA.y / a_size);\n                float dist = dot(uCamPos - a_positions.xyz, vec3(viewMatrix[0][2], viewMatrix[1][2], viewMatrix[2][2]));\n                float focalSize = 2.0 * dist * uFloatParams[1];\n                vec2 offset = a_offset.xy * focalSize;\n                float scd = a_positions.w * (1.0 - smoothstep(uScaleByDistance[0], uScaleByDistance[1], lookDist)) * (1.0 - step(uScaleByDistance[2], lookDist));\n                float scale = a_size * focalSize * scd;\n                float cosRot = cos(a_rotation);\n                float sinRot = sin(a_rotation);\n                vec3 rr = (right * cosRot - up * sinRot) * (scale * (a_vertices.x + a_texCoord.z + a_texCoord.w) + scd * offset.x) + (right * sinRot + up * cosRot) * (scale * a_vertices.y + scd * offset.y) + a_positions.xyz;\n                gl_Position = projectionMatrix * viewMatrix * vec4(rr, 1);\n                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;\n                gl_Position.z += a_offset.z + uZ;\n            }",fragmentShader:e})}(t))}this._renderer.handler.shaderPrograms.labelPicking||this._renderer.handler.addShaderProgram(new Fi("labelPicking",{uniforms:{projectionMatrix:{type:Pi.MAT4},viewMatrix:{type:Pi.MAT4},uCamPos:{type:Pi.VEC3},uFloatParams:{type:Pi.VEC2},uScaleByDistance:{type:Pi.VEC3},uOpacity:{type:Pi.FLOAT}},attributes:{a_vertices:{type:Pi.VEC2,enableArray:!0},a_texCoord:{type:Pi.VEC4,enableArray:!0},a_positions:{type:Pi.VEC4,enableArray:!0},a_size:{type:Pi.FLOAT,enableArray:!0},a_offset:{type:Pi.VEC3,enableArray:!0},a_pickingColor:{type:Pi.VEC3,enableArray:!0},a_rotation:{type:Pi.FLOAT,enableArray:!0},a_alignedAxis:{type:Pi.VEC3,enableArray:!0}},vertexShader:"precision highp float;\n            attribute vec2 a_vertices;\n            attribute vec4 a_texCoord;\n            attribute vec4 a_positions;\n            attribute vec3 a_offset;\n            attribute float a_size;\n            attribute float a_rotation;\n            attribute vec3 a_pickingColor;\n            attribute vec3 a_alignedAxis;\n            varying vec4 v_color;\n            uniform mat4 viewMatrix;\n            uniform mat4 projectionMatrix;\n            uniform vec3 uCamPos;\n            /*0 - planetRadius^2, 1 - tan(fov), 2 - screen ratio*/\n            uniform vec2 uFloatParams;\n            uniform vec3 uScaleByDistance;\n            uniform float uOpacity;\n            const vec3 ZERO3 = vec3(0.0);\n            const float C = 0.1;\n            const float far = 149.6e+9;\n            float logc = 2.0 / log( C * far + 1.0 );\n            void main() {\n                if( uOpacity == 0.0 ){\n                    gl_Position = vec4(0.0);\n                    return;\n                }\n                if(a_texCoord.z == -1.0){\n                    gl_Position = vec4(0.0);\n                    return;\n                }\n                vec3 look = a_positions.xyz - uCamPos;\n                float lookLength = length(look);\n                v_color = vec4(a_pickingColor.rgb, 1.0) * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(a_positions.xyz, a_positions.xyz) - uFloatParams[0]));\n                vec3 right, up;\n                if(a_alignedAxis == ZERO3){\n                    up = vec3( viewMatrix[0][1], viewMatrix[1][1], viewMatrix[2][1] );\n                    right = vec3( viewMatrix[0][0], viewMatrix[1][0], viewMatrix[2][0] );\n                }else{\n                    up = normalize(a_alignedAxis);\n                    right = normalize(cross(look,up));\n                    look = cross(up,right);\n                }\n                float dist = dot(uCamPos - a_positions.xyz, vec3(viewMatrix[0][2], viewMatrix[1][2], viewMatrix[2][2]));\n                float focalSize = 2.0 * dist * uFloatParams[1];\n                vec2 offset = a_offset.xy * focalSize;\n                float scd = a_positions.w * (1.0 - smoothstep(uScaleByDistance[0], uScaleByDistance[1], lookLength)) *(1.0 - step(uScaleByDistance[2], lookLength));\n                float scale = a_size * focalSize * scd;\n                float cosRot = cos(a_rotation);\n                float sinRot = sin(a_rotation);\n                vec3 rr = (right * cosRot - up * sinRot) * (scale * (a_vertices.x + a_texCoord.z + a_texCoord.w) + scd * offset.x) + (right * sinRot + up * cosRot) * (scale * a_vertices.y + scd * offset.y) + a_positions.xyz;\n                gl_Position = projectionMatrix * viewMatrix * vec4(rr, 1);\n                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;\n                gl_Position.z += a_offset.z;\n            }",fragmentShader:"precision highp float;\n            varying vec4 v_color;\n            void main () {\n                gl_FragColor = v_color;\n            }"}))}}add(t){-1===t._handlerIndex&&(t._handler=this,t._handlerIndex=this._billboards.length,this._billboards.push(t),this._addBillboardToArrays(t),this.refresh(),this.assignFontAtlas(t))}assignFontAtlas(t){this._entityCollection&&this._entityCollection.renderNode&&t.assignFontAtlas(this._entityCollection.renderNode.fontAtlas)}clear(){this._texCoordArr.length=0,this._vertexArr.length=0,this._positionArr.length=0,this._sizeArr.length=0,this._offsetArr.length=0,this._rgbaArr.length=0,this._rotationArr.length=0,this._alignedAxisArr.length=0,this._fontIndexArr.length=0,this._noOutlineArr.length=0,this._outlineArr.length=0,this._outlineColorArr.length=0,this._texCoordArr=[],this._vertexArr=[],this._positionArr=[],this._sizeArr=[],this._offsetArr=[],this._rgbaArr=[],this._rotationArr=[],this._alignedAxisArr=[],this._fontIndexArr=[],this._noOutlineArr=[],this._outlineArr=[],this._outlineColorArr=[],this._removeBillboards(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){var t=this._renderer.handler.gl;t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._fontIndexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._outlineBuffer),t.deleteBuffer(this._noOutlineBuffer),t.deleteBuffer(this._outlineColorBuffer),t.deleteBuffer(this._positionBuffer),t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._offsetBuffer),t.deleteBuffer(this._rgbaBuffer),t.deleteBuffer(this._rotationBuffer),t.deleteBuffer(this._vertexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._alignedAxisBuffer),t.deleteBuffer(this._pickingColorBuffer),this._sizeBuffer=null,this._fontIndexBuffer=null,this._texCoordBuffer=null,this._outlineBuffer=null,this._outlineColorBuffer=null,this._positionBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._alignedAxisBuffer=null,this._pickingColorBuffer=null}_addBillboardToArrays(t){for(var e=0;e<this._maxLetters;e++){t._visibility?Hi.concArr(this._vertexArr,[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]):Hi.concArr(this._vertexArr,[0,0,0,0,0,0,0,0,0,0,0,0]),Hi.concArr(this._texCoordArr,[0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0]);var i=t._position.x,r=t._position.y,s=t._position.z,n=t._scale;Hi.concArr(this._positionArr,[i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n]),i=t._size,Hi.concArr(this._sizeArr,[i,i,i,i,i,i]),i=t._offset.x,r=t._offset.y,s=t._offset.z-.05,Hi.concArr(this._offsetArr,[i,r,s,i,r,s,i,r,s,i,r,s,i,r,s,i,r,s]),i=t._color.x,r=t._color.y,s=t._color.z,n=t._color.w,Hi.concArr(this._rgbaArr,[i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n]),i=t._rotation,Hi.concArr(this._rotationArr,[i,i,i,i,i,i]),i=t._alignedAxis.x,r=t._alignedAxis.y,s=t._alignedAxis.z,Hi.concArr(this._alignedAxisArr,[i,r,s,i,r,s,i,r,s,i,r,s,i,r,s,i,r,s]),i=t._fontIndex,Hi.concArr(this._fontIndexArr,[0,0,0,0,0,0]),i=1-t._outline,r=0,Hi.concArr(this._outlineArr,[i,r,i,r,i,r,i,r,i,r,i,r]),i=.75,r=.7,Hi.concArr(this._noOutlineArr,[i,r,i,r,i,r,i,r,i,r,i,r]),i=t._outlineColor.x,r=t._outlineColor.y,s=t._outlineColor.z,n=t._outlineColor.w,Hi.concArr(this._outlineColorArr,[i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n,i,r,s,n]),i=t._entity._pickingColor.x/255,r=t._entity._pickingColor.y/255,s=t._entity._pickingColor.z/255,Hi.concArr(this._pickingColorArr,[i,r,s,i,r,s,i,r,s,i,r,s,i,r,s,i,r,s])}}_displayPASS(){var t=this._renderer,e=t.handler;e.shaderPrograms.label.activate();var i=e.shaderPrograms.label._program,r=i.attributes,s=i.uniforms,n=e.gl,o=this._entityCollection,a=o.renderNode;n.uniform1iv(s.u_fontTextureArr,a.fontAtlas.samplerArr),n.uniformMatrix4fv(s.viewMatrix,!1,t.activeCamera._viewMatrix._m),n.uniformMatrix4fv(s.projectionMatrix,!1,t.activeCamera._projectionMatrix._m),n.uniform3fv(s.uCamPos,t.activeCamera.eye.toVec()),n.uniform3fv(s.uScaleByDistance,o.scaleByDistance),n.uniform1f(s.uOpacity,o._fadingOpacity),n.uniform2fv(s.uFloatParams,[a._planetRadius2||0,t.activeCamera._tanViewAngle_hradOneByHeight]),n.bindBuffer(n.ARRAY_BUFFER,this._texCoordBuffer),n.vertexAttribPointer(r.a_texCoord,this._texCoordBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._vertexBuffer),n.vertexAttribPointer(r.a_vertices,this._vertexBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._positionBuffer),n.vertexAttribPointer(r.a_positions,this._positionBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._sizeBuffer),n.vertexAttribPointer(r.a_size,this._sizeBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._offsetBuffer),n.vertexAttribPointer(r.a_offset,this._offsetBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._rotationBuffer),n.vertexAttribPointer(r.a_rotation,this._rotationBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._alignedAxisBuffer),n.vertexAttribPointer(r.a_alignedAxis,this._alignedAxisBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._fontIndexBuffer),n.vertexAttribPointer(r.a_fontIndex,this._fontIndexBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._outlineColorBuffer),n.vertexAttribPointer(r.a_rgba,this._outlineColorBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._outlineBuffer),n.vertexAttribPointer(r.a_bufferAA,this._outlineBuffer.itemSize,n.FLOAT,!1,0,0),n.uniform1f(s.uZ,-2),n.drawArrays(n.TRIANGLES,0,this._vertexBuffer.numItems),n.bindBuffer(n.ARRAY_BUFFER,this._rgbaBuffer),n.vertexAttribPointer(r.a_rgba,this._rgbaBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._noOutlineBuffer),n.vertexAttribPointer(r.a_bufferAA,this._noOutlineBuffer.itemSize,n.FLOAT,!1,0,0),n.uniform1f(s.uZ,-10),n.drawArrays(n.TRIANGLES,0,this._vertexBuffer.numItems)}_pickingPASS(){var t=this._renderer,e=t.handler;e.shaderPrograms.labelPicking.activate();var i=e.shaderPrograms.labelPicking._program,r=i.attributes,s=i.uniforms,n=e.gl;n.uniformMatrix4fv(s.viewMatrix,!1,t.activeCamera._viewMatrix._m),n.uniformMatrix4fv(s.projectionMatrix,!1,t.activeCamera._projectionMatrix._m),n.uniform3fv(s.uCamPos,t.activeCamera.eye.toVec()),n.uniform3fv(s.uScaleByDistance,this._entityCollection.scaleByDistance),n.uniform1f(s.uOpacity,this._entityCollection._fadingOpacity),n.uniform2fv(s.uFloatParams,[this._entityCollection.renderNode._planetRadius2||0,t.activeCamera._tanViewAngle_hradOneByHeight]),n.bindBuffer(n.ARRAY_BUFFER,this._vertexBuffer),n.vertexAttribPointer(r.a_vertices,this._vertexBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._texCoordBuffer),n.vertexAttribPointer(r.a_texCoord,this._texCoordBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._positionBuffer),n.vertexAttribPointer(r.a_positions,this._positionBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._sizeBuffer),n.vertexAttribPointer(r.a_size,this._sizeBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._offsetBuffer),n.vertexAttribPointer(r.a_offset,this._offsetBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._rotationBuffer),n.vertexAttribPointer(r.a_rotation,this._rotationBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._alignedAxisBuffer),n.vertexAttribPointer(r.a_alignedAxis,this._alignedAxisBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._pickingColorBuffer),n.vertexAttribPointer(r.a_pickingColor,this._pickingColorBuffer.itemSize,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLES,0,this._vertexBuffer.numItems)}_removeBillboard(t){var e=t._handlerIndex;this._billboards.splice(e,1);var i=24*this._maxLetters,r=e*i;this._rgbaArr.splice(r,i),this._outlineColorArr.splice(r,i),this._texCoordArr.splice(r,i),this._positionArr.splice(r,i),r=e*(i=18*this._maxLetters),this._offsetArr.splice(r,i),this._alignedAxisArr.splice(r,i),this._pickingColorArr.splice(r,i),r=e*(i=12*this._maxLetters),this._vertexArr.splice(r,i),this._outlineArr.splice(r,i),this._noOutlineArr.splice(r,i),r=e*(i=6*this._maxLetters),this._sizeArr.splice(r,i),this._rotationArr.splice(r,i),this._fontIndexArr.splice(r,i),this.reindexBillbordsArray(e),this.refresh(),t._handlerIndex=-1,t._handler=null}setText(t,e,i,r){var s=this._entityCollection.renderNode.fontAtlas.atlasesArr[i];if(s){var n=24*t*this._maxLetters,o=this._texCoordArr,a=0,h=n+24*a,l=(c=s.nodes[e[a]])?c.emptySize:0,u=l;for(a=0;a<e.length;a++){h=n+24*a;var c,_=(c=s.nodes[e[a]]||s.nodes[" "]).texCoords;o[h]=_[0],o[h+1]=_[1],o[h+2]=u,o[h+3]=0,o[h+4]=_[2],o[h+5]=_[3],o[h+6]=u,o[h+7]=0,o[h+8]=_[4],o[h+9]=_[5],o[h+10]=u,o[h+11]=0,o[h+12]=_[6],o[h+13]=_[7],o[h+14]=u,o[h+15]=0,o[h+16]=_[8],o[h+17]=_[9],o[h+18]=u,o[h+19]=0,o[h+20]=_[10],o[h+21]=_[11],o[h+22]=u,o[h+23]=0,u+=c.emptySize}if(r===fi.CENTER)for(u=.5*(l+49/512-u),a=0;a<e.length;a++){o[(h=n+24*a)+3]=u,o[h+7]=u,o[h+11]=u,o[h+15]=u,o[h+19]=u,o[h+23]=u}else if(r===fi.LEFT)for(u=l+49/512-u,a=0;a<e.length;a++){o[(h=n+24*a)+3]=u,o[h+7]=u,o[h+11]=u,o[h+15]=u,o[h+19]=u,o[h+23]=u}for(;a<this._maxLetters;a++){o[(h=n+24*a)+2]=-1,o[h+6]=-1,o[h+10]=-1,o[h+14]=-1,o[h+18]=-1,o[h+17]=-1}this._changedBuffers[Zi]=!0}}setPositionArr(t,e){for(var i=24*t*this._maxLetters,r=this._positionArr,s=e.x,n=e.y,o=e.z,a=0;a<this._maxLetters;a++){var h=i+24*a;r[h]=s,r[h+1]=n,r[h+2]=o,r[h+4]=s,r[h+5]=n,r[h+6]=o,r[h+8]=s,r[h+9]=n,r[h+10]=o,r[h+12]=s,r[h+13]=n,r[h+14]=o,r[h+16]=s,r[h+17]=n,r[h+18]=o,r[h+20]=s,r[h+21]=n,r[h+22]=o}this._changedBuffers[Yi]=!0}setScaleArr(t,e){for(var i=24*t*this._maxLetters,r=this._positionArr,s=0;s<this._maxLetters;s++){var n=i+24*s;r[n+3]=e,r[n+7]=e,r[n+11]=e,r[n+15]=e,r[n+19]=e,r[n+23]=e}this._changedBuffers[Yi]=!0}setPickingColorArr(t,e){for(var i=18*t*this._maxLetters,r=this._pickingColorArr,s=e.x/255,n=e.y/255,o=e.z/255,a=0;a<this._maxLetters;a++){var h=i+18*a;r[h]=s,r[h+1]=n,r[h+2]=o,r[h+3]=s,r[h+4]=n,r[h+5]=o,r[h+6]=s,r[h+7]=n,r[h+8]=o,r[h+9]=s,r[h+10]=n,r[h+11]=o,r[h+12]=s,r[h+13]=n,r[h+14]=o,r[h+15]=s,r[h+16]=n,r[h+17]=o}this._changedBuffers[Wi]=!0}setSizeArr(t,e){for(var i=6*t*this._maxLetters,r=this._sizeArr,s=0;s<this._maxLetters;s++){var n=i+6*s;r[n]=e,r[n+1]=e,r[n+2]=e,r[n+3]=e,r[n+4]=e,r[n+5]=e}this._changedBuffers[ji]=!0}setOffsetArr(t,e){for(var i=18*t*this._maxLetters,r=this._offsetArr,s=e.x,n=e.y,o=e.z,a=0;a<this._maxLetters;a++){var h=i+18*a;r[h]=s,r[h+1]=n,r[h+2]=o,r[h+3]=s,r[h+4]=n,r[h+5]=o,r[h+6]=s,r[h+7]=n,r[h+8]=o,r[h+9]=s,r[h+10]=n,r[h+11]=o,r[h+12]=s,r[h+13]=n,r[h+14]=o,r[h+15]=s,r[h+16]=n,r[h+17]=o}this._changedBuffers[Gi]=!0}setRgbaArr(t,e){for(var i=24*t*this._maxLetters,r=this._rgbaArr,s=e.x,n=e.y,o=e.z,a=e.w,h=0;h<this._maxLetters;h++){var l=i+24*h;r[l]=s,r[l+1]=n,r[l+2]=o,r[l+3]=a,r[l+4]=s,r[l+5]=n,r[l+6]=o,r[l+7]=a,r[l+8]=s,r[l+9]=n,r[l+10]=o,r[l+11]=a,r[l+12]=s,r[l+13]=n,r[l+14]=o,r[l+15]=a,r[l+16]=s,r[l+17]=n,r[l+18]=o,r[l+19]=a,r[l+20]=s,r[l+21]=n,r[l+22]=o,r[l+23]=a}this._changedBuffers[qi]=!0}setOutlineColorArr(t,e){for(var i=24*t*this._maxLetters,r=this._outlineColorArr,s=e.x,n=e.y,o=e.z,a=e.w,h=0;h<this._maxLetters;h++){var l=i+24*h;r[l]=s,r[l+1]=n,r[l+2]=o,r[l+3]=a,r[l+4]=s,r[l+5]=n,r[l+6]=o,r[l+7]=a,r[l+8]=s,r[l+9]=n,r[l+10]=o,r[l+11]=a,r[l+12]=s,r[l+13]=n,r[l+14]=o,r[l+15]=a,r[l+16]=s,r[l+17]=n,r[l+18]=o,r[l+19]=a,r[l+20]=s,r[l+21]=n,r[l+22]=o,r[l+23]=a}this._changedBuffers[er]=!0}setOutlineArr(t,e){for(var i=12*t*this._maxLetters,r=this._outlineArr,s=0;s<this._maxLetters;s++){var n=i+12*s;r[n]=e,r[n+2]=e,r[n+4]=e,r[n+6]=e,r[n+8]=e,r[n+10]=e}this._changedBuffers[tr]=!0}setRotationArr(t,e){for(var i=6*t*this._maxLetters,r=this._rotationArr,s=0;s<this._maxLetters;s++){var n=i+6*s;r[n]=e,r[n+1]=e,r[n+2]=e,r[n+3]=e,r[n+4]=e,r[n+5]=e}this._changedBuffers[Ki]=!0}setVertexArr(t,e){for(var i=12*t*this._maxLetters,r=this._vertexArr,s=0;s<this._maxLetters;s++){var n=i+12*s;r[n]=e[0],r[n+1]=e[1],r[n+2]=e[2],r[n+3]=e[3],r[n+4]=e[4],r[n+5]=e[5],r[n+6]=e[6],r[n+7]=e[7],r[n+8]=e[8],r[n+9]=e[9],r[n+10]=e[10],r[n+11]=e[11]}this._changedBuffers[Qi]=!0}setAlignedAxisArr(t,e){for(var i=18*t*this._maxLetters,r=this._alignedAxisArr,s=e.x,n=e.y,o=e.z,a=0;a<this._maxLetters;a++){var h=i+18*a;r[h]=s,r[h+1]=n,r[h+2]=o,r[h+3]=s,r[h+4]=n,r[h+5]=o,r[h+6]=s,r[h+7]=n,r[h+8]=o,r[h+9]=s,r[h+10]=n,r[h+11]=o,r[h+12]=s,r[h+13]=n,r[h+14]=o,r[h+15]=s,r[h+16]=n,r[h+17]=o}this._changedBuffers[Ji]=!0}setFontIndexArr(t,e){for(var i=6*t*this._maxLetters,r=this._fontIndexArr,s=0;s<this._maxLetters;s++){var n=i+6*s;r[n]=e,r[n+1]=e,r[n+2]=e,r[n+3]=e,r[n+4]=e,r[n+5]=e}this._changedBuffers[$i]=!0}createSizeBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=t.createArrayBuffer(new Float32Array(this._sizeArr),1,this._sizeArr.length)}createFontIndexBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._fontIndexBuffer),this._fontIndexBuffer=t.createArrayBuffer(new Float32Array(this._fontIndexArr),1,this._fontIndexArr.length)}createTexCoordBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=t.createArrayBuffer(new Float32Array(this._texCoordArr),4,this._texCoordArr.length/4)}createOutlineBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._outlineBuffer),this._outlineBuffer=t.createArrayBuffer(new Float32Array(this._outlineArr),2,this._outlineArr.length/2),t.gl.deleteBuffer(this._noOutlineBuffer),this._noOutlineBuffer=t.createArrayBuffer(new Float32Array(this._noOutlineArr),2,this._noOutlineArr.length/2)}createOutlineColorBuffer(){var t=this._renderer.handler;t.gl.deleteBuffer(this._outlineColorBuffer),this._outlineColorBuffer=t.createArrayBuffer(new Float32Array(this._outlineColorArr),4,this._outlineColorArr.length/4)}setMaxLetters(t){this._maxLetters=t}refreshTexCoordsArr(){return null}}class rr{constructor(t){this._entityCollection=t,this._renderer=null,this._polylines=[],this.__staticId=rr._staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}_initShaderProgram(){var t;this._renderer.handler&&(this._renderer.handler.shaderPrograms.polyline||this._renderer.handler.addShaderProgram((t=this._renderer.isMultiFramebufferCompatible(),new Fi("polyline",t?{uniforms:{viewport:{type:Pi.VEC2},proj:{type:Pi.MAT4},view:{type:Pi.MAT4},viewport:{type:Pi.VEC2},uCamPos:{type:Pi.VEC3},uFloatParams:{type:Pi.VEC2},color:{type:Pi.VEC4},thickness:{type:Pi.FLOAT},pickingColor:{type:Pi.VEC3}},attributes:{prev:{type:Pi.VEC3},current:{type:Pi.VEC3},next:{type:Pi.VEC3},order:{type:Pi.FLOAT}},vertexShader:"attribute vec3 prev;                attribute vec3 current;                attribute vec3 next;                attribute float order;                uniform float thickness;                uniform vec4 color;                uniform mat4 proj;                uniform mat4 view;                uniform vec2 viewport;                varying vec4 vColor;                varying vec3 vPos;                                const float C = 0.1;                const float far = 149.6e+9;                float logc = 2.0 / log( C * far + 1.0 );                                const float NEAR = -1.0;                                vec2 project(vec4 p){                    return (0.5 * p.xyz / p.w + 0.5).xy * viewport;                }                                void main(){                    vColor = color;                    vPos = current;                                        vec4 vCurrent = view * vec4(current, 1.0);                    vec4 vPrev = view * vec4(prev, 1.0);                    vec4 vNext = view * vec4(next, 1.0);                                        /*Clip near plane*/                    if(vCurrent.z > NEAR) {                        if(vPrev.z < NEAR){                            /*to the begining path view*/                            vCurrent = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);                        }else if(vNext.z < NEAR){                            /*to the end path view*/                            vPrev = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);                            vCurrent = vNext + (vCurrent - vNext) * (NEAR - vNext.z) / (vCurrent.z - vNext.z);                        }                    } else if( vPrev.z > NEAR) {                        /*to the end path view*/                        vPrev = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);                    } else if( vNext.z > NEAR) {                        /*to the begining path view*/                        vNext = vNext + (vCurrent - vNext) * (NEAR - vNext.z) / (vCurrent.z - vNext.z);                    }                                        vec4 dCurrent = proj * vCurrent;                    vec2 _next = project(proj * vNext);                    vec2 _prev = project(proj * vPrev);                    vec2 _current = project(dCurrent);                    if(_prev == _current){                        if(_next == _current){                            _next = _current + vec2(1.0, 0.0);                            _prev = _current - _next;                        }else{                            _prev = _current + normalize(_current - _next);                        }                    }                    if(_next == _current){                        _next = _current + normalize(_current - _prev);                    }                                        vec2 sNext = _next,                         sCurrent = _current,                         sPrev = _prev;                    vec2 dirNext = normalize(sNext - sCurrent);                    vec2 dirPrev = normalize(sPrev - sCurrent);                    float dotNP = dot(dirNext, dirPrev);                                        vec2 normalNext = normalize(vec2(-dirNext.y, dirNext.x));                    vec2 normalPrev = normalize(vec2(dirPrev.y, -dirPrev.x));                                        float d = thickness * sign(order);                                        vec2 m;                    if(dotNP >= 0.99991){                        m = sCurrent - normalPrev * d;                    }else{                        vec2 dir = normalPrev + normalNext;                        m = sCurrent + dir * d / (dirNext.x * dir.y - dirNext.y * dir.x);                                                if( dotNP > 0.5 && dot(dirNext + dirPrev, m - sCurrent) < 0.0 ){                            float occw = order * sign(dirNext.x * dirPrev.y - dirNext.y * dirPrev.x);                            if(occw == -1.0){                                m = sCurrent + normalPrev * d;                            }else if(occw == 1.0){                                m = sCurrent + normalNext * d;                            }else if(occw == -2.0){                                m = sCurrent + normalNext * d;                            }else if(occw == 2.0){                                m = sCurrent + normalPrev * d;                            }                        }else if(distance(sCurrent, m) > min(distance(sCurrent, sNext), distance(sCurrent, sPrev))){                            m = sCurrent + normalNext * d;                        }                    }                    gl_Position = vec4((2.0 * m / viewport - 1.0) * dCurrent.w, dCurrent.z, dCurrent.w);                    gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                }",fragmentShader:"#extension GL_EXT_draw_buffers : require\n                precision highp float;\n                uniform vec3 pickingColor;                uniform vec2 uFloatParams;                uniform vec3 uCamPos;                varying vec4 vColor;                varying vec3 vPos;                void main() {                    vec3 look = vPos - uCamPos;                    float lookLength = length(look);                    float a = vColor.a * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(vPos,vPos) - uFloatParams[0]));                    gl_FragData[0] = vec4(vColor.rgb, a);                    gl_FragData[1] = vec4(pickingColor, 1.0);                }"}:{uniforms:{viewport:{type:Pi.VEC2},proj:{type:Pi.MAT4},view:{type:Pi.MAT4},viewport:{type:Pi.VEC2},uCamPos:{type:Pi.VEC3},uFloatParams:{type:Pi.VEC2},color:{type:Pi.VEC4},thickness:{type:Pi.FLOAT}},attributes:{prev:{type:Pi.VEC3},current:{type:Pi.VEC3},next:{type:Pi.VEC3},order:{type:Pi.FLOAT}},vertexShader:"attribute vec3 prev;                attribute vec3 current;                attribute vec3 next;                attribute float order;                uniform float thickness;                uniform vec4 color;                uniform mat4 proj;                uniform mat4 view;                uniform vec2 viewport;                varying vec4 vColor;                varying vec3 vPos;                                const float C = 0.1;                const float far = 149.6e+9;                float logc = 2.0 / log( C * far + 1.0 );                                const float NEAR = -1.0;                                vec2 getIntersection(vec2 start1, vec2 end1, vec2 start2, vec2 end2){                    vec2 dir = end2 - start2;                    vec2 perp = vec2(-dir.y, dir.x);                    float d2 = dot(perp, start2);                    float seg = dot(perp, start1) - d2;                    float prl = seg - dot(perp, end1) + d2;                    if(prl > -1.0 && prl < 1.0){                        return start1;                    }                    float u = seg / prl;                    return start1 + u * (end1 - start1);                }                                vec2 project(vec4 p){                    return (0.5 * p.xyz / p.w + 0.5).xy * viewport;                }                                void main(){                    vColor = color;                    vPos = current;                                        vec4 vCurrent = view * vec4(current, 1.0);                    vec4 vPrev = view * vec4(prev, 1.0);                    vec4 vNext = view * vec4(next, 1.0);                                        /*Clip near plane*/                    if(vCurrent.z > NEAR) {                        if(vPrev.z < NEAR){                            /*to the begining path view*/                            vCurrent = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);                        }else if(vNext.z < NEAR){                            /*to the end path view*/                            vPrev = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);                            vCurrent = vNext + (vCurrent - vNext) * (NEAR - vNext.z) / (vCurrent.z - vNext.z);                        }                    } else if( vPrev.z > NEAR) {                        /*to the end path view*/                        vPrev = vPrev + (vCurrent - vPrev) * (NEAR - vPrev.z) / (vCurrent.z - vPrev.z);                    } else if( vNext.z > NEAR) {                        /*to the begining path view*/                        vNext = vNext + (vCurrent - vNext) * (NEAR - vNext.z) / (vCurrent.z - vNext.z);                    }                                        vec4 dCurrent = proj * vCurrent;                    vec2 _next = project(proj * vNext);                    vec2 _prev = project(proj * vPrev);                    vec2 _current = project(dCurrent);                    if(_prev == _current){                        if(_next == _current){                            _next = _current + vec2(1.0, 0.0);                            _prev = _current - _next;                        }else{                            _prev = _current + normalize(_current - _next);                        }                    }                    if(_next == _current){                        _next = _current + normalize(_current - _prev);                    }                                        vec2 sNext = _next,                         sCurrent = _current,                         sPrev = _prev;                    vec2 dirNext = normalize(sNext - sCurrent);                    vec2 dirPrev = normalize(sPrev - sCurrent);                    float dotNP = dot(dirNext, dirPrev);                                        vec2 normalNext = normalize(vec2(-dirNext.y, dirNext.x));                    vec2 normalPrev = normalize(vec2(dirPrev.y, -dirPrev.x));                                        float d = thickness * sign(order);                                        vec2 m;                    if(dotNP >= 0.99991){                        m = sCurrent - normalPrev * d;                    }else{                        m = getIntersection( sCurrent + normalPrev * d, sPrev + normalPrev * d,                            sCurrent + normalNext * d, sNext + normalNext * d );                                                if( dotNP > 0.5 && dot(dirNext + dirPrev, m - sCurrent) < 0.0 ){                            float occw = order * sign(dirNext.x * dirPrev.y - dirNext.y * dirPrev.x);                            if(occw == -1.0){                                m = sCurrent + normalPrev * d;                            }else if(occw == 1.0){                                m = sCurrent + normalNext * d;                            }else if(occw == -2.0){                                m = sCurrent + normalNext * d;                            }else if(occw == 2.0){                                m = sCurrent + normalPrev * d;                            }                        }else if(distance(sCurrent, m) > min(distance(sCurrent, sNext), distance(sCurrent, sPrev))){                            m = sCurrent + normalNext * d;                        }                    }                    gl_Position = vec4((2.0 * m / viewport - 1.0) * dCurrent.w, dCurrent.z, dCurrent.w);                    gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                }",fragmentShader:"precision highp float;                uniform vec2 uFloatParams;                uniform vec3 uCamPos;                varying vec4 vColor;                varying vec3 vPos;                void main() {                    vec3 look = vPos - uCamPos;                    float lookLength = length(look);                    float a = vColor.a * step(lookLength, sqrt(dot(uCamPos,uCamPos) - uFloatParams[0]) + sqrt(dot(vPos,vPos) - uFloatParams[0]));                    gl_FragColor = vec4(vColor.rgb, a);                }"}))))}setRenderNode(t){this._renderer=t.renderer,this._initShaderProgram();for(var e=0;e<this._polylines.length;e++)this._polylines[e].setRenderNode(t)}add(t){-1===t._handlerIndex&&(t._handler=this,t._handlerIndex=this._polylines.length,this._polylines.push(t),this._entityCollection&&this._entityCollection.renderNode&&t.setRenderNode(this._entityCollection.renderNode))}remove(t){var e=t._handlerIndex;-1!==e&&(t._deleteBuffers(),t._handlerIndex=-1,t._handler=null,this._polylines.splice(e,1),this.reindexPolylineArray(e))}reindexPolylineArray(t){for(var e=this._polylines,i=t;i<e.length;i++)e[i]._handlerIndex=i}draw(){for(var t=this._polylines.length;t--;)this._polylines[t].draw()}clear(){for(var t=this._polylines.length;t--;)this._polylines[t]._deleteBuffers(),this._polylines[t]._handler=null,this._polylines[t]._handlerIndex=-1;this._polylines.length=0,this._polylines=[]}}class sr{constructor(t){this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._pointClouds=[],this.__staticId=sr._staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}_initShaderProgram(){this._renderer.handler&&(this._renderer.handler.shaderPrograms.pointCloud||this._renderer.handler.addShaderProgram(new Fi("pointCloud",{uniforms:{projectionViewMatrix:{type:Pi.MAT4},opacity:{type:Pi.FLOAT},pointSize:{type:Pi.FLOAT}},attributes:{coordinates:{type:Pi.VEC3,enableArray:!0},colors:{type:Pi.VEC3,enableArray:!0}},vertexShader:"attribute vec3 coordinates;            attribute vec4 colors;            uniform mat4 projectionViewMatrix;            uniform float opacity;            uniform float pointSize;            varying vec4 color;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main() {                color = colors;                color.a *= opacity;                gl_Position = projectionViewMatrix * vec4(coordinates, 1.0);                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                gl_PointSize = pointSize;            }",fragmentShader:"precision highp float;\n            varying vec4 color;            void main(void) {                gl_FragColor = color;            }"})))}setRenderNode(t){this._renderer=t.renderer,this._initShaderProgram();for(var e=0;e<this._pointClouds.length;e++)this._pointClouds[e].setRenderNode(t)}add(t){-1===t._handlerIndex&&(t._handler=this,t._handlerIndex=this._pointClouds.length,this._pointClouds.push(t),this._entityCollection&&this._entityCollection.renderNode&&t.setRenderNode(this._entityCollection.renderNode))}remove(t){var e=t._handlerIndex;-1!==e&&(t._deleteBuffers(),t._handlerIndex=-1,t._handler=null,this._pointClouds.splice(e,1),this.reindexPointCloudArray(e))}reindexPointCloudArray(t){for(var e=this._pointClouds,i=t;i<e.length;i++)e[i]._handlerIndex=i}draw(){for(var t=this._pointClouds.length;t--;)this._pointClouds[t].draw()}drawPicking(){if(this.pickingEnabled)for(var t=this._pointClouds.length;t--;)this._pointClouds[t].drawPicking()}clear(){for(var t=this._pointClouds.length;t--;)this._pointClouds[t]._deleteBuffers(),this._pointClouds[t]._handler=null,this._pointClouds[t]._handlerIndex=-1;this._pointClouds.length=0,this._pointClouds=[]}}class nr{constructor(t){this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._shapes=[],this.__staticId=nr._staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}_initShaderProgram(){this._renderer.handler&&(this._renderer.handler.shaderPrograms.shape_nl||this._renderer.handler.addShaderProgram(new Fi("shape_nl",{uniforms:{projectionViewMatrix:{type:Pi.MAT4},modelMatrix:{type:Pi.MAT4},uColor:{type:Pi.VEC4},uSampler:{type:Pi.SAMPLER2D}},attributes:{aVertexPosition:{type:Pi.VEC3,enableArray:!0},aTextureCoord:{type:Pi.VEC2,enableArray:!0}},vertexShader:"attribute vec3 aVertexPosition;            attribute vec2 aTextureCoord;            uniform mat4 projectionViewMatrix;            uniform mat4 modelMatrix;            varying vec2 vTextureCoord;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main(void) {                gl_Position = projectionViewMatrix * (modelMatrix * vec4(aVertexPosition, 1.0));                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;                vTextureCoord = aTextureCoord;            }",fragmentShader:"precision highp float;\n            uniform vec4 uColor;            uniform sampler2D uSampler;            varying vec2 vTextureCoord;            void main(void) {                gl_FragColor = uColor*texture2D( uSampler, vTextureCoord.st );            }"})),this._renderer.handler.shaderPrograms.shape_wl||this._renderer.handler.addShaderProgram(new Fi("shape_wl",{uniforms:{viewMatrix:{type:Pi.MAT4},projectionMatrix:{type:Pi.MAT4},modelMatrix:{type:Pi.MAT4},normalMatrix:{type:Pi.MAT4},lightsPositions:{type:Pi.VEC4},lightsParamsv:{type:Pi.VEC3},lightsParamsf:{type:Pi.FLOAT},uColor:{type:Pi.VEC4},uSampler:{type:Pi.SAMPLER2D}},attributes:{aVertexNormal:{type:Pi.VEC3,enableArray:!0},aVertexPosition:{type:Pi.VEC3,enableArray:!0},aTextureCoord:{type:Pi.VEC2,enableArray:!0}},vertexShader:"attribute vec3 aVertexNormal;            attribute vec3 aVertexPosition;            attribute vec2 aTextureCoord;            uniform mat4 projectionMatrix;            uniform mat4 viewMatrix;            uniform mat4 modelMatrix;            uniform mat3 normalMatrix;            varying vec2 vTextureCoord;            varying vec3 vNormal;            varying vec4 vPosition;            const float C = 0.1;            const float far = 149.6e+9;            float logc = 2.0 / log( C * far + 1.0 );            void main(void) {                vTextureCoord = aTextureCoord;                vNormal = normalMatrix * aVertexNormal;                vPosition = viewMatrix * modelMatrix * vec4(aVertexPosition, 1.0);                gl_Position = projectionMatrix * vPosition;                gl_Position.z = ( log( C * gl_Position.w + 1.0 ) * logc - 1.0 ) * gl_Position.w;            }",fragmentShader:"precision highp float;\n            varying vec2 vTextureCoord;            varying vec3 vNormal;            varying vec4 vPosition;            uniform vec4 uColor;            uniform sampler2D uSampler;\n            #define MAX_POINT_LIGHTS 1\n            uniform int lightsQuantity;            uniform vec4 lightsPositions[MAX_POINT_LIGHTS];            uniform vec3 lightsParamsv[MAX_POINT_LIGHTS * 3];            uniform float lightsParamsf[MAX_POINT_LIGHTS];            void main(void) {                vec3 lightWeighting;                vec3 lightDirection;                vec3 normal;                vec3 eyeDirection;                vec3 reflectionDirection;                float specularLightWeighting;                float diffuseLightWeighting;                lightDirection = normalize(lightsPositions[0].xyz - vPosition.xyz * lightsPositions[0].w);                normal = normalize(vNormal);                eyeDirection = normalize(-vPosition.xyz);                reflectionDirection = reflect(-lightDirection, normal);                specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), lightsParamsf[0]);                diffuseLightWeighting = max(dot(normal, lightDirection), 0.0);                lightWeighting = lightsParamsv[0] + lightsParamsv[1] * diffuseLightWeighting + lightsParamsv[2] * specularLightWeighting;                vec4 cc = texture2D( uSampler, vTextureCoord.st );                gl_FragColor = vec4(lightWeighting, uColor.a) * cc * uColor;            }"})))}setRenderNode(t){this._renderer=t.renderer,this._initShaderProgram();for(var e=0;e<this._shapes.length;e++)this._shapes[e].setRenderNode(t)}add(t){-1==t._handlerIndex&&(t._handler=this,t._handlerIndex=this._shapes.length,this._shapes.push(t),this._entityCollection&&this._entityCollection.renderNode&&t.setRenderNode(this._entityCollection.renderNode))}remove(t){}draw(){for(var t=this._shapes.length;t--;)this._shapes[t].draw()}drawPicking(){}clear(){}}class or{constructor(t){t=t||{},this.id=or._staticCounter++,this._renderNodeIndex=-1,this.renderNode=null,this._visibility=void 0==t.visibility||t.visibility,this.billboardHandler=new Hi(this),this.labelHandler=new ir(this),this.shapeHandler=new nr(this),this.polylineHandler=new rr(this),this.pointCloudHandler=new sr(this),void 0!=t.pickingEnabled&&this.setPickingEnabled(t.pickingEnabled),this._entities=t.entities||[],this.scaleByDistance=t.scaleByDistance||[g,g,g],this._opacity=void 0==t.opacity?1:t.opacity,this._fadingOpacity=this._opacity,this.events=new Xi(ar,this),this.addEntities(this._entities)}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}setVisibility(t){this._visibility=t,this._fadingOpacity=this._opacity*(t?1:0),this.events.dispatch(this.events.visibilitychange,this)}getVisibility(){return this._visibility}setOpacity(t){this._opacity=t}setPickingEnabled(t){this.billboardHandler.pickingEnabled=t,this.labelHandler.pickingEnabled=t,this.polylineHandler.pickingEnabled=t,this.shapeHandler.pickingEnabled=t,this.pointCloudHandler.pickingEnabled=t}getOpacity(){return this._opacity}setScaleByDistance(t,e,i){this.scaleByDistance[0]=t,this.scaleByDistance[1]=e,this.scaleByDistance[2]=i||g}_addRecursively(t){t.billboard&&this.billboardHandler.add(t.billboard),t.label&&this.labelHandler.add(t.label),t.shape&&this.shapeHandler.add(t.shape),t.polyline&&this.polylineHandler.add(t.polyline),t.pointCloud&&this.pointCloudHandler.add(t.pointCloud),this.events.dispatch(this.events.entityadd,t);for(var e=0;e<t.childrenNodes.length;e++)t.childrenNodes[e]._entityCollection=this,t.childrenNodes[e]._entityCollectionIndex=t._entityCollectionIndex,t.childrenNodes[e]._pickingColor=t._pickingColor,this._addRecursively(t.childrenNodes[e])}add(t){if(!t._entityCollection){t._entityCollection=this,t._entityCollectionIndex=this._entities.length,this._entities.push(t);var e=this.renderNode;e&&(e.renderer&&e.renderer.assignPickingColor(t),e.ellipsoid&&t._lonlat&&t.setCartesian3v(e.ellipsoid.lonLatToCartesian(t._lonlat))),this._addRecursively(t)}return this}addEntities(t){for(var e=t.length;e--;)this.add(t[e]);return this}belongs(t){return t._entityCollection&&this._renderNodeIndex==t._entityCollection._renderNodeIndex}_removeRecursively(t){t._entityCollection=null,t._entityCollectionIndex=-1,t.billboard&&this.billboardHandler.remove(t.billboard),t.label&&this.labelHandler.remove(t.label),t.shape&&this.shapeHandler.remove(t.shape),t.polyline&&this.polylineHandler.remove(t.polyline),t.pointCloud&&this.pointCloudHandler.remove(t.pointCloud);for(var e=0;e<t.childrenNodes.length;e++)this._removeRecursively(t.childrenNodes[e])}removeEntity(t){this._entities.splice(t._entityCollectionIndex,1),this.reindexEntitiesArray(t._entityCollectionIndex),this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(t),t._pickingColor.clear()),this.belongs(t)&&this._removeRecursively(t),this.events.dispatch(this.events.entityremove,t)}_removeEntitySilent(t){this._entities.splice(t._entityCollectionIndex,1),this.reindexEntitiesArray(t._entityCollectionIndex),this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(t),t._pickingColor.clear()),this.belongs(t)&&this._removeRecursively(t)}createPickingColors(){for(var t=this._entities,e=0;e<t.length;e++)t[e].parent||(this.renderNode.renderer.assignPickingColor(t[e]),t[e].setPickingColor())}reindexEntitiesArray(t){for(var e=this._entities,i=t;i<e.length;i++)e[i]._entityCollectionIndex=i}addTo(t,e){return this.renderNode||(this.renderNode=t,e||(this._renderNodeIndex=t.entityCollections.length,t.entityCollections.push(this)),t.ellipsoid&&this._updateGeodeticCoordinates(t.ellipsoid),this.setRenderer(t.renderer),this.shapeHandler.setRenderNode(t),this.polylineHandler.setRenderNode(t),this.pointCloudHandler.setRenderNode(t),this.events.dispatch(this.events.add,this)),this}_updateGeodeticCoordinates(t){for(var e=this._entities,i=e.length;i--;){var r=e[i];r._lonlat&&r.setCartesian3v(t.lonLatToCartesian(r._lonlat))}}setRenderer(t){t&&(this.billboardHandler.setRenderer(t),this.labelHandler.setRenderer(t),this.updateBillboardsTextureAtlas(),this.updateLabelsFontAtlas(),this.createPickingColors())}updateBillboardsTextureAtlas(){for(var t=this.billboardHandler._billboards,e=0;e<t.length;e++)t[e].setSrc(t[e]._src)}updateLabelsFontAtlas(){if(this.renderNode)for(var t=this.labelHandler._billboards,e=0;e<t.length;e++)t[e].assignFontAtlas(this.renderNode.fontAtlas)}remove(){if(this.renderNode){if(-1!=this._renderNodeIndex){this.renderNode.entityCollections.splice(this._renderNodeIndex,1);for(var t=this._renderNodeIndex;t<this.renderNode.entityCollections.length;t++)this.renderNode.entityCollections._renderNodeIndex=t}this.renderNode=null,this._renderNodeIndex=-1,this.events.dispatch(this.events.remove,this)}}getEntities(){return[].concat(this._entities)}each(t){for(var e=this._entities.length;e--;){var i=this._entities[e];i&&t(i)}}clear(){this.billboardHandler.clear(),this.labelHandler.clear(),this.shapeHandler.clear(),this.polylineHandler.clear(),this.pointCloudHandler.clear();for(var t=this._entities.length;t--;){var e=this._entities[t];this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(e),e._pickingColor.clear()),this._clearEntity(e)}this._entities.length=0,this._entities=[]}_clearEntity(t){t._entityCollection=null,t._entityCollectionIndex=-1;for(var e=0;e<t.childrenNodes.length;e++)this._clearEntity(t.childrenNodes[e])}}const ar=["entitymove","draw","drawend","add","remove","entityadd","entityremove","visibilitychange","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];class hr{constructor(){this._f=new Array(6);for(var t=0;t<6;t++)this._f[t]=new Array(4)}static planeNormalize(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]/=e,t[1]/=e,t[2]/=e,t[3]/=e}setFrustum(t){this._f[0][0]=t[3]-t[0],this._f[0][1]=t[7]-t[4],this._f[0][2]=t[11]-t[8],this._f[0][3]=t[15]-t[12],hr.planeNormalize(this._f[0]),this._f[1][0]=t[3]+t[0],this._f[1][1]=t[7]+t[4],this._f[1][2]=t[11]+t[8],this._f[1][3]=t[15]+t[12],hr.planeNormalize(this._f[1]),this._f[2][0]=t[3]+t[1],this._f[2][1]=t[7]+t[5],this._f[2][2]=t[11]+t[9],this._f[2][3]=t[15]+t[13],hr.planeNormalize(this._f[2]),this._f[3][0]=t[3]-t[1],this._f[3][1]=t[7]-t[5],this._f[3][2]=t[11]-t[9],this._f[3][3]=t[15]-t[13],hr.planeNormalize(this._f[3]),this._f[4][0]=t[3]-t[2],this._f[4][1]=t[7]-t[6],this._f[4][2]=t[11]-t[10],this._f[4][3]=t[15]-t[14],hr.planeNormalize(this._f[4]),this._f[5][0]=t[3]+t[2],this._f[5][1]=t[7]+t[6],this._f[5][2]=t[11]+t[10],this._f[5][3]=t[15]+t[14],hr.planeNormalize(this._f[5])}containsPoint(t){for(var e=0;e<6;e++)if(t.dotArr(this._f[e])+this._f[e][3]<=0)return!1;return!0}containsSphere(t){var e=-t.radius;return!(t.center.dotArr(this._f[0])+this._f[0][3]<=e)&&(!(t.center.dotArr(this._f[1])+this._f[1][3]<=e)&&(!(t.center.dotArr(this._f[2])+this._f[2][3]<=e)&&(!(t.center.dotArr(this._f[3])+this._f[3][3]<=e)&&(!(t.center.dotArr(this._f[4])+this._f[4][3]<=e)&&!(t.center.dotArr(this._f[5])+this._f[5][3]<=e)))))}containsSphere2(t,e){var i=-e;return!(t.dotArr(this._f[0])+this._f[0][3]<=i)&&(!(t.dotArr(this._f[1])+this._f[1][3]<=i)&&(!(t.dotArr(this._f[2])+this._f[2][3]<=i)&&(!(t.dotArr(this._f[3])+this._f[3][3]<=i)&&(!(t.dotArr(this._f[4])+this._f[4][3]<=i)&&!(t.dotArr(this._f[5])+this._f[5][3]<=i)))))}containsBox(t){for(var e,i,r=!0,s=0;s<6;s++){e=0,i=0;for(var n=0;n<8&&(0==i||0==e);n++){t.vertices[n].dotArr(this._f[s])+this._f[s][3]<0?e++:i++}if(0==i)return!1;e>0&&(r=!0)}return r}}class lr{constructor(t,e){this.renderer=null,this.events=new Xi(ur,this),this.eye=new Wt,this.frustum=new hr,this._aspect=e.aspect||0,this._nearDist=0,this._farDist=0,this._viewAngle=0,this._normalMatrix=new Vt,this._projectionMatrix=new Ht,this._viewMatrix=new Ht,this._projectionViewMatrix=new Ht,this._inverseProjectionViewMatrix=new Ht,this._projectionMatrixPrecise=new Ht,this._u=new Wt(0,1,0),this._v=new Wt(1,0,0),this.slope=0,this._n=new Wt(0,0,1),this._pu=this._u,this._pv=this._v,this._pn=this._n,this._peye=this.eye,this._moved=!1,this._tanViewAngle_hrad=0,this._tanViewAngle_hradOneByHeight=0,this.renderer=t,t&&this._initialize(e)}_setViewMatrix(){var t=this._u,e=this._v,i=this._n,r=this.eye;this._viewMatrix.set([t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,-r.dot(t),-r.dot(e),-r.dot(i),1])}checkMoveEnd(){var t=this._u,e=this._v,i=this._n,r=this.eye;this.events.moveend.handlers.length&&(this._peye.equal(r)&&this._pu.equal(t)&&this._pv.equal(e)&&this._pn.equal(i)?(this._moved&&this.events.dispatch(this.events.moveend,this),this._moved=!1):this._moved=!0),this._pu=t,this._pv=e,this._pn=i,this._peye=r}_initialize(t){this.setProjectionMatrix(t.viewAngle||cr.viewAngle,this._aspect||this.renderer.handler.getClientAspect(),t.near||cr.near,t.far||cr.far),this.set(t.eye||cr.eye.clone(),t.look||cr.look.clone(),t.up||cr.up.clone())}getUp(){return this._v.clone()}getDown(){return this._v.negateTo()}getRight(){return this._u.clone()}getLeft(){return this._u.negateTo()}getForward(){return this._n.negateTo()}getBackward(){return this._n.clone()}clone(){var t=new lr;return t.eye.copy(cam.eye),t._u.copy(cam._u),t._v.copy(cam._v),t._n.copy(cam._n),t.renderer=cam.renderer,t._projectionMatrix.copy(cam._projectionMatrix),t._viewMatrix.copy(cam._viewMatrix),t._projectionViewMatrix.copy(cam._projectionViewMatrix),t._inverseProjectionViewMatrix.copy(cam._inverseProjectionViewMatrix),t.frustum.setFrustum(t._projectionViewMatrix),t}update(){this._setViewMatrix(),this._projectionViewMatrix=this._projectionMatrix.mul(this._viewMatrix),this.frustum.setFrustum(this._projectionViewMatrix._m),this._inverseProjectionViewMatrix=this._projectionViewMatrix.inverseTo(),this._normalMatrix=this._viewMatrix.toMatrix3(),this.events.dispatch(this.events.viewchange,this)}refresh(){this.setProjectionMatrix(this._viewAngle,this._aspect,this._nearDist,this._farDist),this.update()}setAspectRatio(t){this._aspect=t,this.refresh()}getAspectRatio(){return this._aspect}setFar(t){this._farDist=t,this.refresh()}getFar(){return this._farDist}setNear(t){this._nearDist=t,this.refresh()}getNear(){return this._nearDist}setProjectionMatrix(t,e,i,r){this._viewAngle=t,this._aspect=e,this._nearDist=i,this._farDist=r,this._tanViewAngle_hrad=Math.tan(t*T),this._tanViewAngle_hradOneByHeight=this._tanViewAngle_hrad*this.renderer.handler._oneByHeight;var s=this.renderer.handler.canvas;this._projSizeConst=Math.min(s.clientWidth,s.clientHeight)/(this._viewAngle*A),this._projectionMatrix.setPerspective(t,e,i,r),this._projectionMatrixPrecise.setPerspective(t,e,.1,10)}setViewAngle(t){this._viewAngle=t,this.refresh()}set(t,e,i){return this.eye.x=t.x,this.eye.y=t.y,this.eye.z=t.z,e=e||this._n,i=i||this._v,this._n.x=t.x-e.x,this._n.y=t.y-e.y,this._n.z=t.z-e.z,this._u.copy(i.cross(this._n)),this._n.normalize(),this._u.normalize(),this._v.copy(this._n.cross(this._u)),this}look(t,e){this._n.set(this.eye.x-t.x,this.eye.y-t.y,this.eye.z-t.z),this._u.copy((e||this._v).cross(this._n)),this._n.normalize(),this._u.normalize(),this._v.copy(this._n.cross(this._u))}slide(t,e,i){this.eye.x+=t*this._u.x+e*this._v.x+i*this._n.x,this.eye.y+=t*this._u.y+e*this._v.y+i*this._n.y,this.eye.z+=t*this._u.z+e*this._v.z+i*this._n.z}roll(t){var e=Math.cos(A*t),i=Math.sin(A*t),r=this._u.clone();this._u.set(e*r.x-i*this._v.x,e*r.y-i*this._v.y,e*r.z-i*this._v.z),this._v.set(i*r.x+e*this._v.x,i*r.y+e*this._v.y,i*r.z+e*this._v.z)}pitch(t){var e=Math.cos(A*t),i=Math.sin(A*t),r=this._n.clone();this._n.set(e*r.x-i*this._v.x,e*r.y-i*this._v.y,e*r.z-i*this._v.z),this._v.set(i*r.x+e*this._v.x,i*r.y+e*this._v.y,i*r.z+e*this._v.z)}yaw(t){var e=Math.cos(A*t),i=Math.sin(A*t),r=this._u.clone();this._u.set(e*r.x-i*this._n.x,e*r.y-i*this._n.y,e*r.z-i*this._n.z),this._n.set(i*r.x+e*this._n.x,i*r.y+e*this._n.y,i*r.z+e*this._n.z)}unproject(t,e){var i=this.renderer.handler.canvas,r=.5*i.width,s=.5*i.height,n=(t-r)/r,o=-(e-s)/s,a=this._inverseProjectionViewMatrix.mulVec4(new Ut(n,o,-1,1)).affinity();return this._inverseProjectionViewMatrix.mulVec4(new Ut(n,o,0,1)).affinity().subA(a).toVec3().normalize()}project(t){var e=this._projectionViewMatrix.mulVec4(t.toVec4()),i=this.renderer.handler.canvas;return new Yt((1+e.x/e.w)*i.width*.5,(1-e.y/e.w)*i.height*.5)}rotateAround(t,e,i,r){i=i||Wt.ZERO,r=r||Wt.UP;var s=(new Ht).setRotation(e?this._v:r,t),n=(new Ht).setIdentity().translate(i),o=(new Ht).setIdentity().translate(i.negateTo()),a=n.mul(s).mul(o);this.eye=a.mulVec3(this.eye),this._v=s.mulVec3(this._v).normalize(),this._u=s.mulVec3(this._u).normalize(),this._n=s.mulVec3(this._n).normalize()}rotateHorizontal(t,e,i,r){this.rotateAround(t,e,i,r)}rotateVertical(t,e){this.rotateAround(t,!1,e,this._u)}projectedSize(t,e){return Math.atan(e/this.eye.distance(t))*this._projSizeConst}getNormalMatrix(){return this._normalMatrix}getProjectionMatrix(){return this._projectionMatrix}getViewMatrix(){return this._viewMatrix}getProjectionViewMatrix(){return this._projectionViewMatrix}getInverseProjecttionViewMatrix(){return this._inverseProjectionViewMatrix}}const ur=["viewchange","moveend"],cr={viewAngle:30,near:1,far:m,eye:new Wt(0,0,0),look:new Wt(0,0,0),up:new Wt(0,1,0)},_r=function(t,e,i){this.a=t||0,this.b=e||0,this.c=i||0};_r.get=function(t,e){return new _r(e.y-t.y,t.x-e.x,e.x*t.y-t.x*e.y)},_r.getParallel=function(t,e){return new _r(t.a,t.b,-t.a*e.x-t.b*e.y)},_r.getIntersection=function(t,e){var i=(e.b*t.c-t.b*e.c)/(t.b*e.a-e.b*t.a);return new Yt(i,-(t.c+t.a*i)/t.b)},_r.prototype.intersects=function(t){return _r.getIntersection(this,t)};const dr=function(t,e){this.p0=t?t.clone():new Wt,this.p1=e?e.clone():new Wt};dr.prototype.getSphereIntersection=function(t){var e=this.p0,i=this.p1,r=t.x,s=t.y,n=t.z,o=e.x,a=e.y,h=e.z,l=i.x-o,u=i.y-a,c=i.z-h,_=l*l+u*u+c*c,d=2*(o*l+a*u+h*c-l*r-u*s-c*n),f=d*d-4*_*(o*o-2*o*r+r*r+a*a-2*a*s+s*s+h*h-2*h*n+n*n-t.radius*t.radius);if(f<0)return null;var p=(-d-Math.Sqrt(f))/(2*_),v=new Wt(e.x*(1-p)+p*i.x,e.y*(1-p)+p*i.y,e.z*(1-p)+p*i.z);if(0==f)return v;var g=(-d+Math.Sqrt(f))/(2*_),m=new Wt(e.x*(1-g)+g*i.x,e.y*(1-g)+g*i.y,e.z*(1-g)+g*i.z);return Math.Abs(p-.5)<Math.abs(g-.5)?[v,m]:[m,v]};class fr{constructor(t,e){this.p=t?t.clone():new Wt,this.n=e?e.clone():new Wt}set(t,e){this.p.copy(t),this.n.copy(e)}getNormal(){return this.n}getIntersection(t,e,i){var r,s=t.n.cross(e.n),n=s.x>=0?s.x:-s.x,o=s.y>=0?s.y:-s.y,a=s.z>=0?s.z:-s.z;if(n+o+a<k){var h=e.p.sub(t.p);return 0==t.n.dot(h)?1:0}r=n>o?n>a?1:3:o>a?2:3;var l,u,c=new Wt;return l=-t.n.dot(t.p),u=-e.n.dot(e.p),1===r?(c.x=0,c.y=(u*t.n.z-l*e.n.z)/s.x,c.z=(l*e.n.y-u*t.n.y)/s.x):2===r?(c.x=(l*e.n.z-u*t.n.z)/s.y,c.y=0,c.z=(u*t.n.x-l*e.n.x)/s.y):3===r&&(c.x=(u*t.n.y-l*e.n.y)/s.z,c.y=(l*e.n.x-u*t.n.x)/s.z,c.z=0),i.p0.copy(c),i.p1.copy(c.add(s)),2}}const pr=function(t,e){this.origin=t.clone(),this.direction=e.clone()};pr.OUTSIDE=0,pr.INSIDE=1,pr.INPLANE=2,pr.AWAY=3,pr.prototype.set=function(t,e){return this.origin=t.clone(),this.direction=e.clone(),this},pr.prototype.getPoint=function(t){return Wt.add(this.origin,this.direction.scaleTo(t))},pr.prototype.hitTriangle=function(t,e,i,r){var s=e.sub(t),n=i.sub(t),o=s.cross(n),a=this.origin.sub(t),h=-o.dot(a),l=o.dot(this.direction);if(Math.abs(l)<X)return 0===h?(r.copy(this.origin),pr.INPLANE):pr.OUTSIDE;var u=h/l;if(r.copy(this.origin.add(this.direction.scaleTo(u))),u<0)return pr.AWAY;var c=s.dot(s),_=s.dot(n),d=n.dot(n),f=r.sub(t),p=f.dot(s),v=f.dot(n),g=_*_-c*d,m=(_*v-d*p)/g;if(m<0||m>1)return pr.OUTSIDE;var y=(_*p-c*v)/g;return y<0||m+y>1?pr.OUTSIDE:pr.INSIDE},pr.prototype.hitPlane=function(t,e,i,r){var s=Wt.sub(e,t),n=Wt.sub(i,t),o=s.cross(n),a=Wt.sub(this.origin,t),h=-o.dot(a),l=o.dot(this.direction);if(Math.abs(l)<X&&0===h)return pr.OUTSIDE;var u=h/l;if(u<0)return pr.OUTSIDE;var c=this.direction.scaleTo(u);return r.x=this.origin.x+c.x,r.y=this.origin.y+c.y,r.z=this.origin.z+c.z,pr.INSIDE},pr.prototype.hitSphere=function(t){var e=t.radius,i=t.center,r=this.origin,s=this.direction,n=Wt.sub(i,r);if(n.dot(s)<0){var o=n.length();if(o>e)return null;if(o===e)return r.clone();var a=i.projToRay(r,n),h=Wt.sub(a,i).length(),l=(c=Math.sqrt(e*e-h*h))-Wt.sub(a,r).length();return Wt.add(r,s.scaleTo(l))}a=i.projToRay(r,s);var u=Wt.sub(i,a).length();if(u>t.radius)return null;var c=Math.sqrt(e*e-u*u);return a.subA(r),l=n.length()>e?a.length()-c:a.length()+c,Wt.add(r,s.scaleTo(l))},pr.prototype.hitBox=function(t){};class vr{constructor(t,e){this._canvas=document.createElement("canvas"),this._canvas.width=t||256,this._canvas.height=e||256,this._context=this._canvas.getContext("2d")}getCanvas(){return this._canvas}getContext(){return this._context}fillEmpty(){for(var t=this._context.getImageData(0,0,this._canvas.width,this._canvas.height),e=t.data,i=0,r=e.length;i<r;i+=4)e[i]=e[i+1]=e[i+2]=e[i+3]=0;this._context.putImageData(t,0,0)}getData(){return this._context.getImageData(0,0,this._canvas.width,this._canvas.height).data}fillColor(t){this._context.fillStyle=t,this._context.fillRect(0,0,this._canvas.width,this._canvas.height)}setData(t){var e=this._context.createImageData(this._canvas.width,this._canvas.height);e.data.set(t),this._context.putImageData(e,0,0)}resize(t,e){this._canvas.width=t,this._canvas.height=e,this._context=this._canvas.getContext("2d")}drawImage(t,e,i,r,s){this._context=this._canvas.getContext("2d"),this._context.drawImage(t,e||0,i||0,r||t.width,s||t.height)}getImage(){var t=new Image;return t.width=this.getWidth(),t.height=this.getHeight(),t.src=this._canvas.toDataURL("image/png"),t}getTextWidth(t){var e=this._context.measureText(t);return Math.round(e.width)}drawText(t,e,i,r,s){this._context.fillStyle=s||"black",this._context.font=r||"normal 14px Verdana",this._context.fillText(t,e||0,i||14)}getWidth(){return this._canvas.width}getHeight(){return this._canvas.height}loadImage(t,e){var i=new Image,r=this;i.onload=function(){r.resize(i.width,i.height),r._context.drawImage(i,0,0,i.width,i.height),e&&e(i)},i.src=t}openImage(){var t=this.getImage(),e="<!DOCTYPE html>";e+="<html>",e+="<head><title>Print</title></head>",e+="<body>",e+='<img src="'+t.src+'">',e+="</body>",e+="</html>";var i=window.open("","","width="+t.width+"px ,height="+t.height+"px");i.document.open(),i.document.write(e),i.document.close(),i.focus()}destroy(){this._canvas.width=1,this._canvas.height=1,this._canvas=null,this._context=null}}const gr=function(t,e){e=e||{},this.handler=t,this._fbo=null,this._rbo=null,this._width=e.width||t.canvas.width,this._height=e.height||t.canvas.height,this._useDepth=void 0==e.useDepth||e.useDepth,this._active=!1,this.texture=e.texture||null};gr.prototype.destroy=function(){var t=this.handler.gl;t.deleteTexture(this.texture),t.deleteFramebuffer(this._fbo),t.deleteRenderbuffer(this._rbo),this.texture=null,this._rbo=null,this._fbo=null,this._active=!1},gr.prototype.init=function(){var t=this.handler.gl;this._fbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),!this.texture&&this.bindOutputTexture(this.handler.createEmptyTexture_l(this._width,this._height)),this._useDepth&&(this._rbo=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._rbo),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this._rbo),t.bindRenderbuffer(t.RENDERBUFFER,null)),t.bindFramebuffer(t.FRAMEBUFFER,null)},gr.prototype.bindOutputTexture=function(t){var e=this.handler.gl;this.texture=t,e.bindTexture(e.TEXTURE_2D,t),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.texture,0),e.bindTexture(e.TEXTURE_2D,null)},gr.prototype.setSize=function(t,e){this._width=t,this._height=e,this._active&&this.handler.gl.viewport(0,0,this._width,this._height),this._useDepth&&(this.destroy(),this.init())},gr.prototype.isComplete=function(){var t=this.handler.gl;return t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE},gr.prototype.readAllPixels=function(){var t=this.handler.gl;t.bindFramebuffer(t.FRAMEBUFFER,this._fbo);var e=new Uint8Array(4*this._width*this._height);return t.readPixels(0,0,this._width,this._height,t.RGBA,t.UNSIGNED_BYTE,e),t.bindFramebuffer(t.FRAMEBUFFER,null),e},gr.prototype.readPixel=function(t,e){var i=this.handler.gl;i.bindFramebuffer(i.FRAMEBUFFER,this._fbo);var r=new Uint8Array(4);return i.readPixels(t*this._width,e*this._height,1,1,i.RGBA,i.UNSIGNED_BYTE,r),i.bindFramebuffer(i.FRAMEBUFFER,null),r},gr.prototype.activate=function(){var t=this.handler.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),t.viewport(0,0,this._width,this._height),this._active=!0;var e=this.handler.framebufferStack.current().data;return e&&(e._active=!1),this.handler.framebufferStack.push(this),this},gr.prototype.deactivate=function(){var t=this.handler,e=t.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this._active=!1;var i=this.handler.framebufferStack.popPrev();i?(e.bindFramebuffer(e.FRAMEBUFFER,i._fbo),e.viewport(0,0,i._width,i._height)):e.viewport(0,0,t.canvas.width,t.canvas.height)},gr.prototype.getImage=function(){var t=this.readAllPixels(),e=new vr(this._width,this._height);return e.setData(t),e.getImage()},gr.prototype.openImage=function(){var t=this.getImage(),e="<!DOCTYPE html>";e+="<html>",e+="<head><title>Print</title></head>",e+="<body>",e+='<img src="'+t.src+'">',e+="</body>",e+="</html>";var i=window.open("","","width="+t.width+"px ,height="+t.height+"px");i.document.open(),i.document.write(e),i.document.close(),i.focus()};class mr{static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}constructor(t){t=t||{},this._id=mr._staticCounter++,this.name=t.name||"",this.events=new Xi(["tick","end"],this),this.startDate=t.startDate||0,this.endDate=t.endDate||0;var e=t.currentDate||ke(new Date);t.startDate&&e<t.startDate&&(e=t.startDate),t.endDate&&e>t.endDate&&(e=t.endDate),this.currentDate=e,this.multiplier=void 0!==t.multiplier?t.multiplier:1,this.deltaTicks=0,this.active=!0}setDate(t){var e=ke(t);this.startDate&&e<this.startDate&&(e=this.startDate),this.endDate&&e>this.endDate&&(e=this.endDate),this.currentDate=e}getDate(){return He(this.currentDate)}reset(){this.startDate&&(this.currentDate=this.startDate)}_tick(t){if(this.deltaTicks=t*this.multiplier,this.active){var e=We(this.currentDate,this.deltaTicks);this.multiplier>0?this.endDate&&e>this.endDate?(this.currentDate=this.startDate,this.events.dispatch(this.events.end,this)):this.currentDate=e:this.startDate&&e<this.startDate?(this.currentDate=this.endDate,this.events.dispatch(this.events.end,this)):this.currentDate=e,this.events.dispatch(this.events.tick,this)}}equal(t){return this._id===t._id}}const yr=function(t,e){this._program=e,this._handler=t,this._activated=!1};yr.prototype.initialize=function(){this._program.createProgram(this._handler.gl)},yr.prototype.getProgram=function(){return this._program},yr.prototype.activate=function(){if(!this._activated){this._handler.activeShaderProgram.deactivate(),this._handler.activeShaderProgram=this;var t=this._program;this._activated=!0,t.enableAttribArrays(),t.use()}return this},yr.prototype.remove=function(){var t=this._handler.shaderPrograms;t[this._program.name]&&(this._activated&&this.deactivate(),this._program.delete(),t[this._program.name]=null,delete t[this._program.name])},yr.prototype.deactivate=function(){this._program.disableAttribArrays(),this._activated=!1},yr.prototype.isActive=function(){return this._activated},yr.prototype.set=function(t){return this.activate(),this._program.set(t),this},yr.prototype.drawIndexBuffer=function(t,e){return this._program.drawIndexBuffer(t,e),this},yr.prototype.drawArray=function(t,e){return this._program.drawArray(t,e),this};class xr{constructor(){this.next=null,this.prev=null,this.data=null}}class br{constructor(t=256){this._current=new xr,this._head=this._current;for(var e=0;e<t;e++){var i=new xr;i.prev=this._current,this._current.next=i,this._current=i}this._current=this._head}current(){return this._current}push(t){this._current=this._current.next,this._current.data=t}pop(t){return this._current=this._current.prev,this._current.next.data}popPrev(t){return this._current=this._current.prev,this._current.data}}const Ar=["","WEBKIT_","MOZ_"],Cr=function(t,e){this.defaultClock=new mr,this._clocks=[],this.deltaTime=0,this.canvas=null,this.gl=null,this.shaderPrograms={},this.activeShaderProgram=null,this._params=e||{},this._params.anisotropy=this._params.anisotropy||8;var i=this._params.width;i>4096&&(i=4096),this._params.width=i||256;var r=this._params.height;r>4096&&(r=4096),this._params.height=r||256,this._params.context=this._params.context||{},this._params.extensions=this._params.extensions||[],this._oneByHeight=1/this._params.height,this.extensions={},this._id=t,this._lastAnimationFrameTime=0,this._initialized=!1,this._frameCallback=function(){},this.transparentTexture=null,this.framebufferStack=new br,(e.autoActivate||jt(e.autoActivate))&&this.initialize()};Cr.getExtension=function(t,e){var i,r;for(i in Ar)if(r=t.getExtension(Ar[i]+e))return r;return null},Cr.getContext=function(t,e){var i;try{i=t.getContext("webgl",e)||t.getContext("experimental-webgl",e)}catch(t){Mi.logErr("exception during the GL context initialization")}return i||Mi.logErr("could not initialise WebGL"),i},Cr.prototype.setFrameCallback=function(t){t&&(this._frameCallback=t)},Cr.prototype.createTexture_n=function(t){var e=this.gl,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),i},Cr.prototype.createEmptyTexture_hf=function(t,e){var i=this.gl,r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.HALF_FLOAT_OES,null),i.bindTexture(i.TEXTURE_2D,null),r},Cr.prototype.createEmptyTexture_f=function(t,e){var i=this.gl,r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.FLOAT,null),i.bindTexture(i.TEXTURE_2D,null),r},Cr.prototype.createEmptyTexture_n=function(t,e){var i=this.gl,r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.bindTexture(i.TEXTURE_2D,null),r},Cr.prototype.createEmptyTexture_l=function(t,e){var i=this.gl,r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.bindTexture(i.TEXTURE_2D,null),r},Cr.prototype.createTexture_l=function(t){var e=this.gl,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),i},Cr.prototype.createTexture_mm=function(t){var e=this.gl,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.generateMipmap(e.TEXTURE_2D),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),i},Cr.prototype.createTexture_a=function(t){var e=this.gl,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.generateMipmap(e.TEXTURE_2D),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameterf(e.TEXTURE_2D,this.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._params.anisotropy),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),i},Cr.prototype.createTexture=function(t){return this.createTexture_a(t)},Cr.prototype.loadCubeMapTexture=function(t){var e=this.gl,i=e.createTexture();e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR);var r=[[t.px,e.TEXTURE_CUBE_MAP_POSITIVE_X],[t.nx,e.TEXTURE_CUBE_MAP_NEGATIVE_X],[t.py,e.TEXTURE_CUBE_MAP_POSITIVE_Y],[t.ny,e.TEXTURE_CUBE_MAP_NEGATIVE_Y],[t.pz,e.TEXTURE_CUBE_MAP_POSITIVE_Z],[t.nz,e.TEXTURE_CUBE_MAP_NEGATIVE_Z]],s=new vr;s.fillEmpty();for(var n=s.getImage(),o=0;o<r.length;o++){var a=r[o][1];e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(a,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n)}for(o=0;o<r.length;o++){a=r[o][1];var h=new Image;h.crossOrigin="",h.onload=function(t,i,r){return function(){e.bindTexture(e.TEXTURE_CUBE_MAP,t),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(i,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r)}}(i,a,h),h.src=r[o][0]}return i},Cr.prototype.addShaderProgram=function(t,e){if(this.shaderPrograms[t.name])!COMPILED&&Mi.logWrn("og.webgl.Handler:284 - shader program: '"+t.name+"' is allready exists.");else{var i=new yr(this,t);this.shaderPrograms[t.name]=i,this._initShaderController(i),e&&(i._activated=!1)}return t},Cr.prototype.removeShaderProgram=function(t){this.shaderPrograms[t]&&this.shaderPrograms[t].remove()},Cr.prototype.addShaderPrograms=function(t){for(var e=0;e<t.length;e++)this.addShaderProgram(t[e])},Cr.prototype._initShaderController=function(t){this._initialized&&(t.initialize(),this.activeShaderProgram?(t.deactivate(),this.activeShaderProgram._program.enableAttribArrays(),this.activeShaderProgram._program.use()):(this.activeShaderProgram=t,t.activate()))},Cr.prototype._initShaderPrograms=function(){for(var t in this.shaderPrograms)this._initShaderController(this.shaderPrograms[t])},Cr.prototype.initializeExtension=function(t,e){if(!this.extensions||!this.extensions[t]){var i=Cr.getExtension(this.gl,t);i?this.extensions[t]=i:e&&!COMPILED&&Mi.logWrn("og.webgl.Handler: extension '"+t+"' doesn't initialize.")}return this.extensions&&this.extensions[t]},Cr.prototype.initialize=function(){this._id?this.canvas=document.getElementById(this._id):(this.canvas=document.createElement("canvas"),this.canvas.width=this._params.width,this.canvas.height=this._params.height),this.gl=Cr.getContext(this.canvas,this._params.context),this._initialized=!0,this._params.extensions.push("OES_standard_derivatives"),this._params.extensions.push("EXT_texture_filter_anisotropic"),this._params.extensions.push("OES_element_index_uint");for(var t=this._params.extensions.length;t--;)this.initializeExtension(this._params.extensions[t],!0);this.extensions.EXT_texture_filter_anisotropic||(this.createTexture=this.createTexture_mm),this._initShaderPrograms(),this._setDefaults()},Cr.prototype._setDefaults=function(){this.activateDepthTest(),this.setSize(this._params.width,this._params.height),this.gl.frontFace(this.gl.CCW),this.gl.cullFace(this.gl.BACK),this.activateFaceCulling(),this.deactivateBlending();var t=this;this.createDefaultTexture({color:"rgba(0,0,0,0.0)"},function(e){t.transparentTexture=e})},Cr.prototype.activateDepthTest=function(){this.gl.enable(this.gl.DEPTH_TEST)},Cr.prototype.deactivateDepthTest=function(){this.gl.disable(this.gl.DEPTH_TEST)},Cr.prototype.activateFaceCulling=function(){this.gl.enable(this.gl.CULL_FACE)},Cr.prototype.deactivateFaceCulling=function(){this.gl.disable(this.gl.CULL_FACE)},Cr.prototype.activateBlending=function(){this.gl.enable(this.gl.BLEND)},Cr.prototype.deactivateBlending=function(){this.gl.disable(this.gl.BLEND)},Cr.prototype.createArrayBuffer=function(t,e,i,r){var s=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,r||this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),s.itemSize=e,s.numItems=i,s},Cr.prototype.createElementArrayBuffer=function(t,e,i,r){var s=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,s),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,t,r||this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null),s.itemSize=e,s.numItems=i||t.length,s},Cr.prototype.setSize=function(t,e){t>4096&&(t=4096),e>4096&&(e=4096),this._params.width=t,this._params.height=e,this.canvas.width=t,this.canvas.height=e,this._oneByHeight=1/e,this.gl&&this.gl.viewport(0,0,t,e),this.onCanvasResize&&this.onCanvasResize(this.canvas)},Cr.prototype.getWidth=function(){return this.canvas.width},Cr.prototype.getHeight=function(){return this.canvas.height},Cr.prototype.getClientAspect=function(){return this.canvas.clientWidth/this.canvas.clientHeight},Cr.prototype.getCenter=function(){var t=this.canvas;return new Yt(Math.round(.5*t.width),Math.round(.5*t.height))},Cr.prototype.drawFrame=function(){var t=(new Date).getTime();this.deltaTime=t-this._lastAnimationFrameTime,this._lastAnimationFrameTime=t,this.defaultClock._tick(this.deltaTime);for(var e=0;e<this._clocks.length;e++)this._clocks[e]._tick(this.deltaTime);var i=this.canvas;i.clientWidth===i.width&&i.clientHeight===i.height||this.setSize(i.clientWidth,i.clientHeight),this._frameCallback()},Cr.prototype.clearFrame=function(){var t=this.gl;this.gl.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)},Cr.prototype.start=function(){if(!this._requestAnimationFrameId&&this._initialized){var t=new Date;this._lastAnimationFrameTime=t.getTime(),this.defaultClock.setDate(t),this._animationFrameCallback()}},Cr.prototype.stop=function(){this._requestAnimationFrameId&&(window.cancelAnimationFrame(this._requestAnimationFrameId),this._requestAnimationFrameId=null)},Cr.prototype._animationFrameCallback=function(){this._requestAnimationFrameId=window.requestAnimationFrame(()=>{this.drawFrame(),this._animationFrameCallback()})},Cr.prototype.createDefaultTexture=function(t,e){var i,r;if(t&&t.color)(i=new vr(2,2)).fillColor(t.color),(r=this.createTexture_n(i._canvas)).default=!0,e(r);else if(t&&t.url){var s=new Image,n=this;s.onload=function(){(r=n.createTexture(this)).default=!0,e(r)},s.src=t.url}else(i=new vr(2,2)).fillColor("#C5C5C5"),(r=this.createTexture_n(i._canvas)).default=!0,e(r)},Cr.prototype.destroy=function(){var t=this.gl;for(var e in this.stop(),this.shaderPrograms)this.removeShaderProgram(e);t.deleteTexture(this.transparentTexture),this.transparentTexture=null,this.framebufferStack=null,this.framebufferStack=new br,this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null;var i=t.getParameter(t.MAX_VERTEX_ATTRIBS),r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r);for(var s=0;s<i;++s)t.disableVertexAttribArray(s),t.vertexAttribPointer(s,4,t.FLOAT,!1,0,0),t.vertexAttrib1f(s,0);t.deleteBuffer(r);var n=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);for(s=0;s<n;++s)t.activeTexture(t.TEXTURE0+s),t.bindTexture(t.TEXTURE_CUBE_MAP,null),t.bindTexture(t.TEXTURE_2D,null);t.activeTexture(t.TEXTURE0),t.useProgram(null),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.DITHER),t.disable(t.SCISSOR_TEST),t.blendColor(0,0,0,0),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ZERO),t.clearColor(0,0,0,0),t.clearDepth(1),t.clearStencil(-1),this.gl=null,this._initialized=!1},Cr.prototype.addClock=function(t){t.__handler||(t.__handler=this,this._clocks.push(t))},Cr.prototype.addClocks=function(t){for(var e=0;e<t.length;e++)this.addClock(t[e])},Cr.prototype.removeClock=function(t){if(t.__handler)for(var e=this._clocks,i=e.length;i--;)if(e[i].equal(t)){t.__handler=null,e.splice(i,1);break}};const Er=function(t,e){e=e||{},this.handler=t,this._fbo=null,this._pFbo=[],this._rbo=null,this._size=e.size||1,this._width=e.width||256,this._height=e.height||256,this.textures=[],this._active=!1};Er.prototype.destroy=function(){var t=this.handler.gl;t.deleteFramebuffer(this._fbo),this._fbo=null,t.deleteRenderbuffer(this._rbo),this._rbo=null;for(var e=0;e<this._size;e++)t.deleteTexture(this.textures[e]),t.deleteFramebuffer(this._pFbo[e]);this.textures.length=0,this.textures=[],this._pFbo.length=0,this._pFbo=[]},Er.prototype.init=function(){var t=this.handler.gl,e=this.handler.extensions.WEBGL_draw_buffers;this._fbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo);for(var i=[],r=0;r<this._size;r++)i[r]=e.COLOR_ATTACHMENT0_WEBGL+r;e.drawBuffersWEBGL(i);for(r=0;r<this._size;r++)this.textures[r]=this.handler.createEmptyTexture_l(this._width,this._height),t.bindTexture(t.TEXTURE_2D,this.textures[r]),t.framebufferTexture2D(t.FRAMEBUFFER,e.COLOR_ATTACHMENT0_WEBGL+r,t.TEXTURE_2D,this.textures[r],0),t.bindTexture(t.TEXTURE_2D,null),i[r]=e.COLOR_ATTACHMENT0_WEBGL+r;this._rbo=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._rbo),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this._rbo),t.bindRenderbuffer(t.RENDERBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null);for(r=0;r<this._size;r++)this._pFbo[r]=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._pFbo[r]),t.bindTexture(t.TEXTURE_2D,this.textures[r]),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.textures[r],0),t.bindTexture(t.TEXTURE_2D,null);t.bindFramebuffer(t.FRAMEBUFFER,null)},Er.prototype.setSize=function(t,e){this._width=t,this._height=e,this.destroy(),this.init()},Er.prototype.readAllPixels=function(t){var e=this.handler.gl;e.bindFramebuffer(e.FRAMEBUFFER,this._pFbo[t||0]);var i=new Uint8Array(4*this._width*this._height);return e.readPixels(0,0,this._width,this._height,e.RGBA,e.UNSIGNED_BYTE,i),e.bindFramebuffer(e.FRAMEBUFFER,null),i},Er.prototype.readPixel=function(t,e,i){var r=this.handler.gl;r.bindFramebuffer(r.FRAMEBUFFER,this._pFbo[i||0]);var s=new Uint8Array(4);return r.readPixels(t*this._width,e*this._height,1,1,r.RGBA,r.UNSIGNED_BYTE,s),r.bindFramebuffer(r.FRAMEBUFFER,null),s},Er.prototype.isComplete=function(){var t=this.handler.gl;return t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),t.checkFramebufferStatus(t.FRAMEBUFFER)==t.FRAMEBUFFER_COMPLETE?(t.bindFramebuffer(t.FRAMEBUFFER,null),!0):(t.bindFramebuffer(t.FRAMEBUFFER,null),!1)},Er.prototype.activate=function(){var t=this.handler,e=t.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,this._fbo),e.viewport(0,0,this._width,this._height),this._active=!0;var i=this.handler.framebufferStack.current().data;return i&&(i._active=!1),t.framebufferStack.push(this),this},Er.prototype.deactivate=function(){var t=this.handler,e=t.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,t.canvas.width,t.canvas.height),this._active=!1;var i=t.framebufferStack.popPrev();i?(e.bindFramebuffer(e.FRAMEBUFFER,i._fbo),e.viewport(0,0,i._width,i._height)):e.viewport(0,0,t.canvas.width,t.canvas.height)},Er.prototype.getImage=function(t){var e=this.readAllPixels(t),i=new vr(this._width,this._height);return i.setData(e),i.getImage()},Er.prototype.openImage=function(t){var e=this.getImage(t),i="<!DOCTYPE html>";i+="<html>",i+="<head><title>Print</title></head>",i+="<body>",i+='<img src="'+e.src+'">',i+="</body>",i+="</html>";var r=window.open("","","width="+e.width+"px ,height="+e.height+"px");r.document.open(),r.document.write(i),r.document.close(),r.focus()};const Tr=function(){var t={},e={},i={},r=this,s=null,n=null;if(Tr.prototype._instance)return Tr.prototype._instance;Tr.prototype._instance=this,document.onkeydown=function(t){n=t,r.handleKeyDown.call(r)},document.onkeyup=function(t){n=t,r.handleKeyUp.call(r)};var o=function(t,e){return t.priority<e.priority};this.addEvent=function(t,n,a,h,l){switch(void 0===l&&(l=1600),t){case"keypress":null==h?s={callback:a,sender:n||r}:(e[h]||(e[h]=[]),e[h].push({callback:a,sender:n,priority:l}),e[h].sort(o));break;case"charkeypress":i[h]||(i[h]=[]),i[h].push({callback:a,sender:n,priority:l}),i[h].sort(o)}},this.isKeyPressed=function(e){return t[e]},this.handleKeyDown=function(){for(var e in s&&s.callback.call(s.sender,n),t[n.keyCode]=!0,i)if(String.fromCharCode(n.keyCode)==String.fromCharCode(e))for(var r=i[e],o=0;o<r.length;o++)r[o].callback.call(r[o].sender,n)},this.handleKeyUp=function(){t[n.keyCode]=!1},this.handleEvents=function(){for(var i in e)if(t[i])for(var r=e[i],s=0;s<r.length;s++)r[s].callback.call(r[s].sender,n)}},wr=function(t){this._htmlObject=t};wr.prototype.setEvent=function(t,e,i){switch(t){case"mousewheel":this._htmlObject.addEventListener("mousewheel",function(t){var r=t.deltaY||t.detail||t.wheelDelta;void 0==t.wheelDelta&&(t.wheelDelta=-120*r),i.call(e,t),t.preventDefault()},!1),this._htmlObject.addEventListener("wheel",function(t){var r=t.deltaY||t.detail||t.wheelDelta;void 0==t.wheelDelta&&(t.wheelDelta=-120*r),i.call(e,t),t.preventDefault()},!1);break;case"mousedown":this._htmlObject.addEventListener("mousedown",function(t){i.call(e,t)}),this._htmlObject.addEventListener("contextmenu",function(t){return t.preventDefault(),!1});break;case"mouseup":this._htmlObject.addEventListener("mouseup",function(t){i.call(e,t)});break;case"mousemove":this._htmlObject.addEventListener("mousemove",function(t){var r=this.getBoundingClientRect();i.call(e,{clientX:t.clientX-r.left,clientY:t.clientY-r.top})})}};const Br=function(t){this._htmlObject=t};Br.prototype.setEvent=function(t,e,i){switch(t){case"touchcancel":this._htmlObject.addEventListener("touchcancel",function(t){t.preventDefault();var r=this.getBoundingClientRect();t.offsetLeft=r.left,t.offsetTop=r.top,i.call(e,t),t.preventDefault()});break;case"touchstart":this._htmlObject.addEventListener("touchstart",function(t){t.preventDefault();var r=this.getBoundingClientRect();t.offsetLeft=r.left,t.offsetTop=r.top,i.call(e,t),t.preventDefault()});break;case"touchend":this._htmlObject.addEventListener("touchend",function(t){t.preventDefault();var r=this.getBoundingClientRect();t.offsetLeft=r.left,t.offsetTop=r.top,i.call(e,t),t.preventDefault()});break;case"touchmove":this._htmlObject.addEventListener("touchmove",function(t){t.preventDefault();var r=this.getBoundingClientRect();t.offsetLeft=r.left,t.offsetTop=r.top,i.call(e,t),t.preventDefault()})}};const Pr=["draw","resize","mousemove","mousestop","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchstart","touchend","touchcancel","touchmove","doubletouch","touchleave","touchenter"],Rr=function(t,e){if(e=e||{},this.div=null,this.handler=t,this._renderNodesArr=[],this.renderNodes={},this.cameras=[],this.activeCamera=null,this.events=new class extends Xi{constructor(t){super(Pr),this.renderer=t,this._touchHandler=new Br(t.handler.canvas),this._mouseHandler=new wr(t.handler.canvas),this._keyboardHandler=new Tr,this.mouseState={x:0,y:0,nx:0,ny:0,prev_x:0,prev_y:0,direction:new Wt,leftButtonUp:!1,rightButtonUp:!1,middleButtonUp:!1,leftButtonDown:!1,rightButtonDown:!1,middleButtonDown:!1,leftButtonHold:!1,rightButtonHold:!1,middleButtonHold:!1,leftButtonDoubleClick:!1,rightButtonDoubleClick:!1,middleButtonDoubleClick:!1,leftButtonClick:!1,rightButtonClick:!1,middleButtonClick:!1,moving:!1,justStopped:!1,doubleClickDelay:300,wheelDelta:0,sys:null,pickingObject:null,renderer:t},this.touchState={moving:!1,touchEnd:!1,touchStart:!1,touchCancel:!1,doubleTouch:!1,doubleTouchDelay:550,doubleTouchRadius:10,x:0,y:0,nx:0,ny:0,prev_x:0,prev_y:0,sys:null,pickingObject:null,renderer:t},this._dblTchCoords=new Yt,this._oneTouchStart=!1,this._dblTchBegins=0,this._mousestopThread=null,this._ldblClkBegins=0,this._rdblClkBegins=0,this._mdblClkBegins=0,this._lclickX=0,this._lclickY=0,this._rclickX=0,this._rclickY=0,this._mclickX=0,this._mclickY=0}handleEvents(){this.mouseState.direction=this.renderer.activeCamera.unproject(this.mouseState.x,this.mouseState.y),this.entityPickingEvents(),this._keyboardHandler.handleEvents(),this.handleMouseEvents(),this.handleTouchEvents()}on(t,e,i,r,s){"keypress"==t||"charkeypress"==t?this._keyboardHandler.addEvent(t,r,i,e,s):super.on(t,e,i)}isKeyPressed(t){return this._keyboardHandler.isKeyPressed(t)}initialize(){this._mouseHandler.setEvent("mouseup",this,this.onMouseUp),this._mouseHandler.setEvent("mousemove",this,this.onMouseMove),this._mouseHandler.setEvent("mousedown",this,this.onMouseDown),this._mouseHandler.setEvent("mousewheel",this,this.onMouseWheel),this._touchHandler.setEvent("touchstart",this,this.onTouchStart),this._touchHandler.setEvent("touchend",this,this.onTouchEnd),this._touchHandler.setEvent("touchcancel",this,this.onTouchCancel),this._touchHandler.setEvent("touchmove",this,this.onTouchMove)}onMouseWheel(t){this.mouseState.wheelDelta=t.wheelDelta}onMouseMove(t){var e=this.mouseState;if(e.sys=t,e.x!==t.clientX||e.y!==t.clientY){this._ldblClkBegins=0,this._rdblClkBegins=0,this._mdblClkBegins=0,e.x=t.clientX,e.y=t.clientY;var i=this.renderer.handler.canvas;e.nx=e.x/i.width,e.ny=e.y/i.height,e.moving=!0,clearTimeout(this._mousestopThread),this._mousestopThread=setTimeout(function(){e.justStopped=!0},100)}}onMouseDown(t){t.button===ai.MB_LEFT?(this._lclickX=t.clientX,this._lclickY=t.clientY,this.mouseState.sys=t,this.mouseState.leftButtonDown=!0):t.button===ai.MB_RIGHT?(this._rclickX=t.clientX,this._rclickY=t.clientY,this.mouseState.sys=t,this.mouseState.rightButtonDown=!0):t.button===ai.MB_MIDDLE&&(this._mclickX=t.clientX,this._mclickY=t.clientY,this.mouseState.sys=t,this.mouseState.middleButtonDown=!0)}onMouseUp(t){var e=this.mouseState;e.sys=t,t.button===ai.MB_LEFT?(e.leftButtonDown=!1,e.leftButtonUp=!0,this._lclickX===t.clientX&&this._lclickY===t.clientY&&(this._ldblClkBegins?((new Date).getTime()-this._ldblClkBegins<=e.doubleClickDelay&&(e.leftButtonDoubleClick=!0),this._ldblClkBegins=0):this._ldblClkBegins=(new Date).getTime(),e.leftButtonClick=!0)):t.button===ai.MB_RIGHT?(e.rightButtonDown=!1,e.rightButtonUp=!0,this._rclickX===t.clientX&&this._rclickY===t.clientY&&(this._rdblClkBegins?((new Date).getTime()-this._rdblClkBegins<=e.doubleClickDelay&&(e.rightButtonDoubleClick=!0),this._rdblClkBegins=0):this._rdblClkBegins=(new Date).getTime(),e.rightButtonClick=!0)):t.button===ai.MB_MIDDLE&&(e.middleButtonDown=!1,e.middleButtonUp=!0,this._mclickX===t.clientX&&this._mclickY===t.clientY)&&(this._mdblClkBegins?((new Date).getTime()-this._mdblClkBegins<=e.doubleClickDelay&&(e.middleButtonDoubleClick=!0),this._mdblClkBegins=0):this._mdblClkBegins=(new Date).getTime(),e.middleButtonClick=!0)}onTouchStart(t){var e=this.touchState;e.sys=t,e.x=t.touches.item(0).clientX-t.offsetLeft,e.y=t.touches.item(0).clientY-t.offsetTop;var i=this.renderer.handler.canvas;e.nx=e.x/i.width,e.ny=e.y/i.height,e.prev_x=e.x,e.prev_y=e.y,e.touchStart=!0,1===t.touches.length?(this._dblTchCoords.x=e.x,this._dblTchCoords.y=e.y,this._oneTouchStart=!0):this._oneTouchStart=!1}onTouchEnd(t){var e=this.touchState;e.sys=t,e.touchEnd=!0,0===t.touches.length&&(e.prev_x=e.x,e.prev_y=e.y,this._oneTouchStart)&&(this._dblTchBegins&&((new Date).getTime()-this._dblTchBegins<=e.doubleTouchDelay&&(e.doubleTouch=!0),this._dblTchBegins=0),this._dblTchBegins=(new Date).getTime(),this._oneTouchStart=!1)}onTouchCancel(t){var e=this.touchState;e.sys=t,e.touchCancel=!0}onTouchMove(t){var e=this.touchState;e.x=t.touches.item(0).clientX-t.offsetLeft,e.y=t.touches.item(0).clientY-t.offsetTop;var i=this.renderer.handler.canvas;e.nx=e.x/i.width,e.ny=e.y/i.height,e.sys=t,e.moving=!0,this._dblTchBegins=0,this._oneTouchStart=!1}entityPickingEvents(){var t=this.touchState,e=this.mouseState;if(!(e.leftButtonHold||e.rightButtonHold||e.middleButtonHold)){var i=this.renderer,r=i.colorObjects,s=i._currPickingColor,n=i._prevPickingColor;e.pickingObject=null,t.pickingObject=null;var o=r&&r[s[0]+"_"+s[1]+"_"+s[2]];if(e.pickingObject=o,t.pickingObject=o,s[0]!=n[0]||s[1]!=n[1]||s[2]!=n[2])if(s[0]||s[1]||s[2]){if(n[0]||n[1]||n[2]){let i=r[n[0]+"_"+n[1]+"_"+n[2]];if(i){let r=i.events||i._entityCollection&&i._entityCollection.events||i._layer&&i._layer.events;e.pickingObject=i,r&&r.dispatch(r.mouseleave,e),t.pickingObject=i,r&&r.dispatch(r.touchleave,t)}}if(o){var a=o.events||o._entityCollection&&o._entityCollection.events||o._layer&&o._layer.events;e.pickingObject=o,a&&a.dispatch(a.mouseenter,e),t.pickingObject=o,a&&a.dispatch(a.touchenter,t)}}else{let i=r[n[0]+"_"+n[1]+"_"+n[2]];if(i){let r=i.events||i._entityCollection&&i._entityCollection.events||i._layer&&i._layer.events;e.pickingObject=i,r&&r.dispatch(r.mouseleave,e),t.pickingObject=i,r&&r.dispatch(r.touchleave,t)}}}}handleMouseEvents(){let t=this.mouseState,e=t.pickingObject,i=null;t.leftButtonClick&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.lclick,t),this.dispatch(this.lclick,t),t.leftButtonClick=!1),t.rightButtonClick&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.rclick,t),this.dispatch(this.rclick,t),t.rightButtonClick=!1),t.middleButtonClick&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.mclick,t),this.dispatch(this.mclick,t),t.middleButtonClick=!1),t.leftButtonDown&&(t.leftButtonHold?(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.lhold,t),this.dispatch(this.lhold,t)):(t.leftButtonHold=!0,e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.ldown,t),this.dispatch(this.ldown,t))),t.rightButtonDown&&(t.rightButtonHold?(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.rhold,t),this.dispatch(this.rhold,t)):(t.rightButtonHold=!0,e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.rdown,t),this.dispatch(this.rdown,t))),t.middleButtonDown&&(t.middleButtonHold?(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.mhold,t),this.dispatch(this.mhold,t)):(t.middleButtonHold=!0,e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.mdown,t),this.dispatch(this.mdown,t))),t.leftButtonUp&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.lup,t),this.dispatch(this.lup,t),t.leftButtonUp=!1,t.leftButtonHold=!1),t.rightButtonUp&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.rup,t),this.dispatch(this.rup,t),t.rightButtonUp=!1,t.rightButtonHold=!1),t.middleButtonUp&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.mup,t),this.dispatch(this.mup,t),t.middleButtonUp=!1,t.middleButtonHold=!1),t.leftButtonDoubleClick&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.ldblclick,t),this.dispatch(this.ldblclick,t),t.leftButtonDoubleClick=!1),t.rightButtonDoubleClick&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.rdblclick,t),this.dispatch(this.rdblclick,t),t.rightButtonDoubleClick=!1),t.middleButtonDoubleClick&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.mdblclick,t),this.dispatch(this.mdblclick,t),t.middleButtonDoubleClick=!1),t.wheelDelta&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.mousewheel,t),this.dispatch(this.mousewheel,t),t.wheelDelta=0),t.moving&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.mousemove,t),this.dispatch(this.mousemove,t),t.prev_x=t.x,t.prev_y=t.y),t.justStopped&&(this.dispatch(this.mousestop,t),t.justStopped=!1)}handleTouchEvents(){var t=this.touchState,e=t.pickingObject,i=null;if(t.touchCancel&&(this.dispatch(this.touchcancel,t),t.touchCancel=!1),t.touchStart){var r=this.renderer;r._currPickingColor=r._drawBuffersExtension?r.pickingFramebuffer.readPixel(t.nx,1-t.ny,1):r.pickingFramebuffer.readPixel(t.nx,1-t.ny);var s=r.colorObjects,n=r._currPickingColor,o=s[n[0]+"_"+n[1]+"_"+n[2]];(e=t.pickingObject=o)&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.touchstart,t),this.dispatch(this.touchstart,t),t.touchStart=!1}t.doubleTouch&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.doubletouch,t),this.dispatch(this.doubletouch,t),t.doubleTouch=!1),t.touchEnd&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.touchend,t),this.dispatch(this.touchend,t),t.x=0,t.y=0,t.touchEnd=!1),t.moving&&(e&&(i=e.events||e._entityCollection&&e._entityCollection.events||e._layer&&e._layer.events)&&i.dispatch(i.touchmove,t),this.dispatch(this.touchmove,t),t.prev_x=t.x,t.prev_y=t.y)}}(this),this.controls={},e.controls)for(let t in e.controls)this.controls[e.controls[t].name]=e.controls[t];this.controlsBag={},this.colorObjects={},this._pickingCallbacks=[],this.pickingFramebuffer=null,this.sceneFramebuffer=null,this._currPickingColor=[0,0,0],this._prevPickingColor=[0,0,0],this._fnScreenFrame=null,this._initialized=!1,(e.autoActivate||jt(e.autoActivate))&&(this.initialize(),this.start())};Rr.prototype.addPickingCallback=function(t,e){this._pickingCallbacks.push({callback:e,sender:t})},Rr.prototype.getPickingObjectByColor=function(t,e,i){return this.colorObjects[t+"_"+e+"_"+i]},Rr.prototype.assignPickingColor=function(t){if(!t._pickingColor||t._pickingColor.isZero()){for(var e=0,i=0,r=0,s="0_0_0";!(e||i||r)||this.colorObjects[s];)s=(e=ot(1,255))+"_"+(i=ot(1,255))+"_"+(r=ot(1,255));t._pickingColor?t._pickingColor.set(e,i,r):t._pickingColor=new Wt(e,i,r),this.colorObjects[s]=t}},Rr.prototype.clearPickingColor=function(t){if(!t._pickingColor.isZero()){var e=t._pickingColor;e.isZero()||(this.colorObjects[e.x+"_"+e.y+"_"+e.z]=null,delete this.colorObjects[e.x+"_"+e.y+"_"+e.z],e.x=e.y=e.z=0)}},Rr.prototype.getWidth=function(){return this.handler.canvas.width},Rr.prototype.getHeight=function(){return this.handler.canvas.height},Rr.prototype.getCenter=function(){var t=this.handler.canvas;return new Yt(Math.round(.5*t.width),Math.round(.5*t.height))},Rr.prototype.addControl=function(t){t.addTo(this)},Rr.prototype.addControls=function(t){for(var e=0;e<t.length;e++)t[e].addTo(this)},Rr.prototype.removeControl=function(t){var e=this.controls[t.name];return e&&t.isEqual(e)&&(this.controls[t.name]=null,delete this.controls[t.name],e.remove()),this},Rr.prototype.initialize=function(){if(this._initialized)return;this._initialized=!0;var t=this;this.handler.setFrameCallback(function(){t.draw()}),this.activeCamera=new lr(this,{eye:new Wt(0,0,0),look:new Wt(0,0,-1),up:new Wt(0,1,0)}),this.events.initialize(),this.events.on("charkeypress",ai.KEY_APOSTROPHE,function(){Mi.setVisibility(!Mi.getVisibility())}),this.handler.onCanvasResize=function(e){t.activeCamera.setAspectRatio(e.clientWidth/e.clientHeight),t.sceneFramebuffer.setSize(e.clientWidth,e.clientHeight),t.events.dispatch(t.events.resize,e)},this.pickingFramebuffer=new gr(this.handler,{width:640,height:480}),this.pickingFramebuffer.init(),this.handler.addShaderProgram(new Fi("screenFrame",{uniforms:{texture:{type:Pi.SAMPLER2D}},attributes:{corners:{type:Pi.VEC3,enableArray:!0}},vertexShader:"attribute vec2 corners;                        varying vec2 tc;            void main(void) {                gl_Position = vec4(corners, 0.0, 1.0);                tc = corners * 0.5 + 0.5;            }",fragmentShader:"precision highp float;            uniform sampler2D texture;                        varying vec2 tc;                        void main(void) {                gl_FragColor = texture2D( texture, tc );            }"})),this._drawBuffersExtension=this.handler.initializeExtension("WEBGL_draw_buffers"),this._drawBuffersExtension?(this.sceneFramebuffer=new Er(this.handler,{size:3}),this.sceneFramebuffer.init(),this._fnScreenFrame=this._multiframebufferScreenFrame):(this.sceneFramebuffer=new gr(this.handler),this.sceneFramebuffer.init(),this._fnScreenFrame=this._singleframebufferScreenFrame),this._screenFrameCornersBuffer=this.handler.createArrayBuffer(new Float32Array([1,1,-1,1,1,-1,-1,-1]),2,4);let e=this.controls;this.controls={};for(let t in e)this.addControl(e[t])},Rr.prototype.addRenderNode=function(t){this.renderNodes[t.name]?Mi.logWrn("og.Renderer(370) - node name: "+t.name+" allready exists."):(t.assignRenderer(this),this._renderNodesArr.unshift(t),this.renderNodes[t.name]=t)},Rr.prototype.addRenderNodes=function(t){for(var e=0;e<t.length;e++)this.addRenderNode(t[e])},Rr.prototype.draw=function(){this.activeCamera.checkMoveEnd();var t=this.events;t.handleEvents(),t.dispatch(t.draw,this);var e=this.sceneFramebuffer;e.activate();var i=this.handler;i.clearFrame(),i.gl.activeTexture(i.gl.TEXTURE0),i.gl.bindTexture(i.gl.TEXTURE_2D,i.transparentTexture);for(var r=this._renderNodesArr,s=r.length;s--;)r[s].drawNode();e.deactivate(),this._drawPickingBuffer(),this._fnScreenFrame(),t.mouseState.moving=!1,t.touchState.moving=!1},Rr.prototype._multiframebufferScreenFrame=function(){var t=this.handler,e=t.shaderPrograms.screenFrame,i=e._program,r=t.gl;r.disable(r.DEPTH_TEST),e.activate(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.sceneFramebuffer.textures[0]),r.uniform1i(i.uniforms.texture,0),r.bindBuffer(r.ARRAY_BUFFER,this._screenFrameCornersBuffer),r.vertexAttribPointer(i.attributes.corners,2,r.FLOAT,!1,0,0),r.drawArrays(r.TRIANGLE_STRIP,0,4),r.enable(r.DEPTH_TEST)},Rr.prototype._singleframebufferScreenFrame=function(){var t=this.handler,e=t.shaderPrograms.screenFrame,i=e._program,r=t.gl;r.disable(r.DEPTH_TEST),e.activate(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.sceneFramebuffer.texture),r.uniform1i(i.uniforms.texture,0),r.bindBuffer(r.ARRAY_BUFFER,this._screenFrameCornersBuffer),r.vertexAttribPointer(i.attributes.corners,2,r.FLOAT,!1,0,0),r.drawArrays(r.TRIANGLE_STRIP,0,4),r.enable(r.DEPTH_TEST)},Rr.prototype.getPickingObject=function(t,e){var i,r=this.renderer.handler.canvas;return i=this._drawBuffersExtension?this.sceneFramebuffer.readPixel(t/r.width,(r.height-e)/r.height,1):this.sceneFramebuffer.readPixel(t/r.width,(r.height-e)/r.height),this.colorObjects[i[0]+"_"+i[1]+"_"+i[2]]},Rr.prototype.isMultiFramebufferCompatible=function(){return!!this._drawBuffersExtension},Rr.prototype._drawPickingBuffer=function(){this.pickingFramebuffer.activate();var t=this.handler,e=t.gl;e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.disable(t.gl.BLEND);for(var i=this._pickingCallbacks,r=i.length;r--;)i[r].callback.call(i[r].sender);this.pickingFramebuffer.deactivate();var s,n=this.events.mouseState,o=this.events.touchState;n.leftButtonHold||n.rightButtonHold||n.middleButtonHold||(this._prevPickingColor[0]=this._currPickingColor[0],this._prevPickingColor[1]=this._currPickingColor[1],this._prevPickingColor[2]=this._currPickingColor[2],o.x||o.y?(s=this.pickingFramebuffer.readPixel(o.nx,1-o.ny))[0]||s[1]||s[2]||!this._drawBuffersExtension||(s=this.sceneFramebuffer.readPixel(o.nx,1-o.ny,1)):(s=this.pickingFramebuffer.readPixel(n.nx,1-n.ny))[0]||s[1]||s[2]||!this._drawBuffersExtension||(s=this.sceneFramebuffer.readPixel(n.nx,1-n.ny,1)),this._currPickingColor=s)},Rr.prototype.start=function(){this.handler.start()};class zr{static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}constructor(t,e){e=e||{},this._name=t||"light_"+zr._staticCounter++,this._renderNode=null,this._position=e.position||new Wt,this.directional=void 0==e.derectional||e.derectional,this._ambient=e.ambient||new Wt,this._diffuse=e.diffuse||new Wt(.8,.8,.8),this._specular=e.specular||new Wt(.18,.18,.18),this._shininess=void 0!=e.shininess?e.shininess:3.3,this._active=!0,this._tempAmbient=this._ambient.clone(),this._tempDiffuse=this._diffuse.clone(),this._tempSpecular=this._specular.clone(),this._tempShininess=this._shininess}clone(){}setActive(t){if(t&&!this._active){var e=this._renderNode;if(e){var i=e._lightsNames.indexOf(this._name);this._shininess=e._lightsParamsf[i]=this._tempShininess,-1!=i&&(i*=9,this._ambient.x=e._lightsParamsv[i]=this._tempAmbient.x,this._ambient.y=e._lightsParamsv[i+1]=this._tempAmbient.y,this._ambient.z=e._lightsParamsv[i+2]=this._tempAmbient.z,this._diffuse.x=e._lightsParamsv[i+3]=this._tempDiffuse.x,this._diffuse.y=e._lightsParamsv[i+4]=this._tempDiffuse.y,this._diffuse.z=e._lightsParamsv[i+5]=this._tempDiffuse.z,this._specular.x=e._lightsParamsv[i+6]=this._tempSpecular.x,this._specular.y=e._lightsParamsv[i+7]=this._tempSpecular.y,this._specular.z=e._lightsParamsv[i+8]=this._tempSpecular.z)}this._active=!0}else!t&&this._active&&(this._tempAmbient=this._ambient.clone(),this._tempDiffuse=this._diffuse.clone(),this._tempSpecular=this._specular.clone(),this._tempShininess=this._shininess,this.setBlack(),this._active=!1)}isActive(){return this._active}setPosition(t){return this._position.x=t.x,this._position.y=t.y,this._position.z=t.z,this}getPosition(){return this._position.clone()}setAmbient(t){this._ambient=t;var e=this._renderNode;if(e){var i=9*e._lightsNames.indexOf(this._name);-1!=i&&(e._lightsParamsv[i]=t.x,e._lightsParamsv[i+1]=t.y,e._lightsParamsv[i+2]=t.z)}return this}setDiffuse(t){this._diffuse=t;var e=this._renderNode;if(e){var i=9*e._lightsNames.indexOf(this._name);-1!=i&&(e._lightsParamsv[i+3]=t.x,e._lightsParamsv[i+4]=t.y,e._lightsParamsv[i+5]=t.z)}return this}setSpecular(t){this._specular=t;var e=this._renderNode;if(e){var i=9*e._lightsNames.indexOf(this._name);-1!=i&&(e._lightsParamsv[i+6]=t.x,e._lightsParamsv[i+7]=t.y,e._lightsParamsv[i+8]=t.z)}return this}setShininess(t){this._shininess=t;var e=this._renderNode;if(e){var i=e._lightsNames.indexOf(this._name);-1!=i&&(e._lightsParamsf[i]=t)}return this}setBlack(){this._ambient.clear(),this._diffuse.clear(),this._specular.clear(),this._shininess=0;var t=this._renderNode;if(t){var e=9*t._lightsNames.indexOf(this._name);-1!=e&&(t._lightsParamsv[e]=t._lightsParamsv[e+1]=t._lightsParamsv[e+2]=t._lightsParamsv[e+3]=t._lightsParamsv[e+4]=t._lightsParamsv[e+5]=t._lightsParamsv[e+6]=t._lightsParamsv[e+7]=t._lightsParamsv[e+8]=0)}return this}addTo(t){return this._renderNode=t,t._lights.push(this),t._lightsNames.push(this._name),t._lightsParamsf.push(this._shininess),t._lightsParamsv.push.apply(t._lightsParamsv,this._ambient.toVec()),t._lightsParamsv.push.apply(t._lightsParamsv,this._diffuse.toVec()),t._lightsParamsv.push.apply(t._lightsParamsv,this._specular.toVec()),this}remove(){var t=this.renderNode;if(t){var e=t.getLightById(this._name);-1!=e&&(t._lights.splice(e,1),t._lightsNames.splice(e,1),t._lightsParamsf.splice(e,1),t._lightsParamsv.splice(e,9))}this._renderNode=null}}class Mr{constructor(t){this.name=t,this.topNode=this,this._dictionary=[],this._dictionary[t]=this,this.childNodes=[],this.parentNode=null,this.__staticId=Node.__staticCounter++}static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}addNode(t){null==this.parentNode?t.topNode=this:t.topNode=this.topNode,t.parentNode=this,t._dictionary=this.topNode._dictionary,this.childNodes.push(t),this.topNode._dictionary[t.name]=t}destroy(){for(var t=0;t<this.childNodes.length;t++)this.childNodes[t].destroy();this._clear()}getNodeByName(t){return this._dictionary[t]}_clear(){this.name="",this.parentNode=null,this.topNode=null,this.childNodes.length=0}}class Fr{constructor(t,e,i,r){this.left=t||0,this.right=i||0,this.top=e||0,this.bottom=r||0}clone(){return new Fr(this.left,this.top,this.right,this.bottom)}getWidth(){return Math.abs(this.right-this.left)}getHeight(){return Math.abs(this.bottom-this.top)}getSquare(){return this.getHeight()*this.getWidth()}getDiagonal(){var t=this.getWidth(),e=this.getHeight();return Math.sqrt(e*e+t*t)}fit(t,e){return this.getWidth()==t&&this.getHeight()==e}}class Sr{constructor(t){this._size=t||2048,this._array=new Array(this._size),this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}reset(){this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}clear(){this._array.length=0,this._array=new Array(this._size),this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}push(t){this.length++,this._array[this._popIndex++]=t}pop(){if(this.length){this.length--;var t=this._array[--this._popIndex];return this._array[this._popIndex]=null,this._array[this._popIndex-1]||(this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex),t}}unshift(t){this.length++,this._array[--this._shiftIndex]=t}shift(){if(this.length){this.length--;var t=this._array[this._shiftIndex];return this._array[this._shiftIndex++]=null,this._array[this._shiftIndex]||(this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex),t}}each(t){for(var e=this._shiftIndex;e<this._popIndex;e++)t(this._array[e])}}class Dr{constructor(){this.imagesCache={},this._counter=0,this._pendingsQueue=new Sr,this._imageIndexCounter=0}load(t,e){if(this.imagesCache[t])e(this.imagesCache[t]);else{var i={src:t,success:e};this._counter>=1?this._pendingsQueue.push(i):this._exec(i)}}_exec(t){this._counter++;var e=this,i=new Image;i.crossOrigin="",i.onload=function(){e.imagesCache[t.src]=i,this.__nodeIndex=e._imageIndexCounter++,t.success(this),e._dequeueRequest()},i.onerror=function(){e._dequeueRequest()},i.src=t.src}_dequeueRequest(){if(this._counter--,this._pendingsQueue.length&&this._counter<1)for(;this._pendingsQueue.length;){var t=this._pendingsQueue.pop();if(t){if(!this.imagesCache[t.src]){this._exec(t);break}this._counter<=0?this._counter=0:this._counter--,t.success(this.imagesCache[t.src])}}}}class Lr{constructor(t,e){this.nodes=[],this.texture=null,this.canvas=new vr(t||1024,e||1024),this.clearCanvas(),this._handler=null,this._images=[],this._btree=null,this._imagesCacheManager=new Dr,this.borderSize=4}getImage(){return this.canvas.getImage()}getCanvas(){return this.canvas._canvas}clearCanvas(){this.canvas.fillEmpty("black")}assignHandler(t){this._handler=t,this.createTexture()}getDiagonal(t){var e=t.atlasWidth||t.width,i=t.atlasHeight||t.height;return Math.sqrt(e*e+i*i)}addImage(t,e){if(t.width&&t.height)return this._images.push(t),this._makeAtlas(e),this.nodes[t.__nodeIndex]}_completeNode(t,e){if(e){var i=this.canvas.getWidth(),r=this.canvas.getHeight(),s=e.image,n=e.rect,o=Math.round(.5*this.borderSize);this.canvas.drawImage(s,n.left+o,n.top+o,s.atlasWidth,s.atlasHeight);var a=e.texCoords;a[0]=(n.left+o)/i,a[1]=(n.top+o)/r,a[2]=(n.left+o)/i,a[3]=(n.bottom-o)/r,a[4]=(n.right-o)/i,a[5]=(n.bottom-o)/r,a[6]=(n.right-o)/i,a[7]=(n.bottom-o)/r,a[8]=(n.right-o)/i,a[9]=(n.top+o)/r,a[10]=(n.left+o)/i,a[11]=(n.top+o)/r,t[s.__nodeIndex]=e}}_makeAtlas(t){if(t&&this._btree){var e=this._images[this._images.length-1];this._completeNode(this.nodes,this._btree.insert(e))}else{(e=this._images.slice(0)).sort(function(t,e){return(e.atlasWidth||e.width)-(t.atlasWidth||t.width)||(e.atlasHeight||e.height)-(t.atlasHeight||t.height)}),this._btree=new Nr(new Fr(0,0,this.canvas.getWidth(),this.canvas.getHeight())),this._btree.atlas=this,this.clearCanvas();for(var i=[],r=0;r<e.length;r++)this._completeNode(i,this._btree.insert(e[r]));this.nodes=[],this.nodes=i}}createTexture(){this._handler&&(this._handler.gl.deleteTexture(this.texture),this.texture=this._handler.createTexture_l(this.canvas._canvas))}loadImage(t,e){this._imagesCacheManager.load(t,e)}}class Nr{constructor(t){this.childNodes=null,this.image=null,this.rect=t,this.texCoords=[],this.atlas=null}insert(t){if(this.childNodes){var e=this.childNodes[0].insert(t);return null!=e?e:this.childNodes[1].insert(t)}if(null!=this.image)return null;var i=this.rect,r=(t.atlasWidth||t.width)+this.atlas.borderSize,s=(t.atlasHeight||t.height)+this.atlas.borderSize;return r>i.getWidth()||s>i.getHeight()?null:i.fit(r,s)?(this.image=t,this):(this.childNodes=new Array(2),this.childNodes[0]=new Nr,this.childNodes[0].atlas=this.atlas,this.childNodes[1]=new Nr,this.childNodes[1].atlas=this.atlas,i.getWidth()-r>i.getHeight()-s?(this.childNodes[0].rect=new Fr(i.left,i.top,i.left+r,i.bottom),this.childNodes[1].rect=new Fr(i.left+r,i.top,i.right,i.bottom)):(this.childNodes[0].rect=new Fr(i.left,i.top,i.right,i.top+s),this.childNodes[1].rect=new Fr(i.left,i.top+s,i.right,i.bottom)),this.childNodes[0].insert(t))}}class Ir{constructor(){var t=["monospace","sans-serif","serif"],e=document.getElementsByTagName("body")[0],i=document.createElement("span");i.style.fontSize="72px",i.innerHTML="mmmmmmmmmmlli";var r={},s={};for(var n in t)i.style.fontFamily=t[n],e.appendChild(i),r[t[n]]=i.offsetWidth,s[t[n]]=i.offsetHeight,e.removeChild(i);this.detect=function(n){var o=!1;for(var a in t){i.style.fontFamily=n+","+t[a],e.appendChild(i);var h=i.offsetWidth!=r[t[a]]||i.offsetHeight!=s[t[a]];e.removeChild(i),o=o||h}return o}}}class kr{constructor(t,e){this._handler=null,this._framebuffer0=null,this._framebuffer1=null,this._framebuffer2=null,this._vertexBuffer=null,this._width=t||512,this._height=e||512;var i=Math.max(this._width,this._height);this._outsideDistance=Math.round(80*i/512),this._insideDistance=Math.round(10*i/512),this._outsideMix=.71,this._insideMix=.679,this._sourceTexture=null,this.initialize()}initialize(){this._initHandler(this._width,this._height),this._initShaders()}_initHandler(t,e){this._handler=new Cr(null,{width:t,height:e,context:{alpha:!0,depth:!1}}),this._handler.initialize(),this._handler.deactivateFaceCulling(),this._handler.deactivateDepthTest(),this._vertexBuffer=this._handler.createArrayBuffer(new Float32Array([-1,-1,-1,1,1,-1,1,1]),2,4),this._framebuffer0=new gr(this._handler,{useDepth:!1}),this._framebuffer1=new gr(this._handler,{useDepth:!1}),this._framebuffer2=new gr(this._handler,{useDepth:!1}),this._framebuffer0.init(),this._framebuffer1.init(),this._framebuffer2.init()}_initShaders(){var t=new Fi("vfield",{uniforms:{uTexSize:{type:Pi.VEC2},uTex1:{type:Pi.SAMPLER2D},uDistance:{type:Pi.INT},uNeg:{type:Pi.VEC2}},attributes:{aPos:{type:Pi.VEC2,enableArray:!0}},vertexShader:"precision highp float;            attribute vec2 aPos;            uniform vec2 uTexSize;            varying vec2 TexCoord;            varying vec2 vTexSize;            void main() {                TexCoord = (aPos + 1.0) * 0.5;                TexCoord *= uTexSize;                vTexSize = uTexSize;                gl_Position.xy = aPos;                gl_Position.zw = vec2(0.0, 1.0);            }",fragmentShader:"precision highp float;            uniform sampler2D uTex1;            uniform int uDistance;            uniform vec2 uNeg;            varying vec2 TexCoord;            varying vec2 vTexSize;            const int maxDistance = "+this._outsideDistance+";            void main() {                if ( uNeg.x - uNeg.y * texture2D(uTex1, TexCoord / vTexSize).r > 0.5 ) {                    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);                    return;                }                for ( int i=1; i <= maxDistance; i++ ) {                    if(i > uDistance) break;                    if ( uNeg.x - uNeg.y * texture2D(uTex1, ( TexCoord + vec2(0.0, i) ) / vTexSize ).r > 0.5 ) {                        gl_FragColor = vec4( vec3(float(i)/float(uDistance)), 1.0 );                        return;                    }                    if ( uNeg.x - uNeg.y * texture2D(uTex1, ( TexCoord - vec2(0.0, i)) / vTexSize ).r > 0.5 ) {                        gl_FragColor = vec4(vec3(float(i)/float(uDistance)), 1.0);                        return;                    }                }                gl_FragColor = vec4(1.0);            }"}),e=new Fi("hfield",{uniforms:{uTexSize:{type:Pi.VEC2},uTex1:{type:Pi.SAMPLER2D},uDistance:{type:Pi.INT}},attributes:{aPos:{type:Pi.VEC2,enableArray:!0}},vertexShader:"precision highp float;            attribute vec2 aPos;            uniform vec2 uTexSize;            varying vec2 TexCoord;            varying vec2 vTexSize;            void main() {\n                TexCoord = (aPos + 1.0) * 0.5;                TexCoord *= uTexSize;                vTexSize = uTexSize;                gl_Position.xy = aPos;                gl_Position.zw = vec2(0.0, 1.0);            }",fragmentShader:"precision highp float;            uniform sampler2D uTex1;            uniform int uDistance;            varying vec2 TexCoord;            varying vec2 vTexSize;            const int maxDistance = "+this._outsideDistance+";            float CalcC(float H, float V) {                return ( sqrt( H * H + V * V ) );            }            void main(){                float dist = CalcC( 0.0, texture2D( uTex1, TexCoord / vTexSize ).r );                for ( int i = 1; i <= maxDistance; i++ ) {                    if(i > uDistance) break;                    float H = float(i) / float(uDistance);                    dist = min( dist, CalcC( H, texture2D( uTex1, ( TexCoord + vec2( float(i), 0.0) ) / vTexSize ).r ) );                    dist = min( dist, CalcC( H, texture2D( uTex1, ( TexCoord - vec2( float(i), 0.0) ) / vTexSize ).r ) );                }                gl_FragColor = vec4(dist);                gl_FragColor.w = 1.0;            }"}),i=new Fi("sum",{uniforms:{outside:{type:Pi.SAMPLER2D},inside:{type:Pi.SAMPLER2D},source:{type:Pi.SAMPLER2D}},attributes:{aPos:{type:Pi.VEC2,enableArray:!0}},vertexShader:"attribute vec2 aPos;\n                        varying vec2 TexCoord;\n                        void main(){\n                            TexCoord = (aPos * vec2(1.0,-1.0) + 1.0) * 0.5;\n                            gl_Position.xy = aPos;\n                            gl_Position.zw = vec2(0.0, 1.0);\n                        }",fragmentShader:"precision highp float;\n                        uniform sampler2D outside;\n                        uniform sampler2D inside;\n                        uniform sampler2D source;\n                        varying vec2 TexCoord;\n                        void main(){\n                            float o = texture2D(outside, TexCoord).r;\n                            float i = 1.0 - texture2D(inside, TexCoord).r;\n                            float s = texture2D(source, TexCoord).r;\n                            gl_FragColor = vec4( vec3(1.0 - mix(i, o, step(0.5, s) * "+this._outsideMix+" + (1.0 - step(0.5, s)) * "+this._insideMix+" )), 1.0);\n                        }"});this._handler.addShaderPrograms([t,e,i])}setSize(t,e){t===this._width&&e===this._height||(this._width=t,this._height=e,this._handler.setSize(t,e),this._framebuffer0.setSize(t,e),this._framebuffer1.setSize(t,e))}createSDF(t,e,i){var r=this._handler,s=r.gl;r.setSize(this._width,this._height),s.deleteTexture(this._sourceTexture),this._sourceTexture=r.createTexture_l(t),r.shaderPrograms.vfield.activate();var n=(a=r.shaderPrograms.vfield._program).attributes,o=a.uniforms;s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._sourceTexture),s.uniform1i(o.uTex1,0),s.uniform2fv(o.uTexSize,[this._width,this._height]),s.bindBuffer(s.ARRAY_BUFFER,this._vertexBuffer),s.vertexAttribPointer(n.aPos,this._vertexBuffer.itemSize,s.FLOAT,!1,0,0),this._framebuffer0.activate(),s.uniform1i(o.uDistance,this._outsideDistance),s.uniform2fv(o.uNeg,[0,-1]),s.drawArrays(s.TRIANGLE_STRIP,0,4),this._framebuffer0.deactivate(),this._framebuffer2.activate(),s.uniform2fv(o.uNeg,[1,1]),s.uniform1i(o.uDistance,this._insideDistance),s.drawArrays(s.TRIANGLE_STRIP,0,4),this._framebuffer2.deactivate(),r.shaderPrograms.hfield.activate();n=(a=r.shaderPrograms.hfield._program).attributes,o=a.uniforms;s.uniform2fv(o.uTexSize,[this._width,this._height]),s.bindBuffer(s.ARRAY_BUFFER,this._vertexBuffer),s.vertexAttribPointer(n.aPos,this._vertexBuffer.itemSize,s.FLOAT,!1,0,0),this._framebuffer1.activate(),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._framebuffer0.texture),s.uniform1i(o.uTex1,0),s.uniform1i(o.uDistance,this._outsideDistance),s.drawArrays(s.TRIANGLE_STRIP,0,4),this._framebuffer1.deactivate(),this._framebuffer0.activate(),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._framebuffer2.texture),s.uniform1i(o.uTex1,0),s.uniform1i(o.uDistance,this._insideDistance),s.drawArrays(s.TRIANGLE_STRIP,0,4),this._framebuffer0.deactivate(),r.setSize(e||this._width,i||this._height),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),r.shaderPrograms.sum.activate();var a;n=(a=r.shaderPrograms.sum._program).attributes,o=a.uniforms;return s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._framebuffer1.texture),s.uniform1i(o.outside,0),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,this._framebuffer0.texture),s.uniform1i(o.inside,1),s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_2D,this._sourceTexture),s.uniform1i(o.source,2),s.bindBuffer(s.ARRAY_BUFFER,this._vertexBuffer),s.vertexAttribPointer(n.aPos,this._vertexBuffer.itemSize,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLE_STRIP,0,4),r.canvas}}const Or=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","а","б","в","г","д","е","ё","ж","з","и","к","л","м","н","о","п","р","с","т","у","ф","х","ц","ч","ш","щ","ь","э","ъ","ю","я","й","А","Б","В","Г","Д","Е","Ё","Ж","З","И","К","Л","М","Н","О","П","Р","С","Т","У","Ф","Х","Ц","Ч","Ш","Щ","Ь","Э","Ъ","Ю","Я","Й","1","2","3","4","5","6","7","8","9","0","`","!","@","#","$","%","^","&","*","(",")","_","+","-","=","[","]","{","}","\\","|",";",":",'"',",",".","/","<",">","?"," ","    ","'","Á","á","Ć","ć","É","é","Í","í","Ĺ","ĺ","Ń","ń","Ó","ó","Ŕ","ŕ","Ś","ś","Ú","ú","Ý","ý","Ź","ź","ď","Ľ","ľ","ť","Ă","ă","Ğ","ğ","Ŭ","ŭ","Č","č","Ď","Ě","ě","Ň","ň","Ř","ř","Š","š","Ť","Ž","ž","Ç","ç","Ģ","ģ","Ķ","ķ","Ļ","ļ","Ņ","ņ","Ŗ","ŗ","Ş","ş","Ţ","ţ","Â","â","Ĉ","ĉ","Ê","ê","Ĝ","ĝ","Ĥ","ĥ","Î","î","Ĵ","ĵ","Ô","ô","Ŝ","ŝ","Û","û","Ŵ","ŵ","Ŷ","ŷ","Ä","ä","Ë","ë","Ï","ï","Ö","ö","Ü","ü","Ÿ","ÿ","Ċ","ċ","Ė","ė","Ġ","ġ","İ","ı","Ż","ż","Ő","ő","Ű","ű","À","à","È","è","Ì","ì","Ò","ò","Ù","ù","Ơ","ơ","Ư","ư","Ā","ā","Ē","ē","Ī","ī","Ō","ō","Ū","ū","Ą","ą","Ę","ę","Į","į","Ų","ų","Å","å","Ů","ů","Đ","đ","Ħ","ħ","Ł","ł","Ø","ø","Ã","ã","Ñ","ñ","Õ","õ","Æ","æ","Œ","œ","Ð","ð","Þ","þ","ß","ſ","Α","Β","Γ","Δ","Ε","Ζ","Η","Θ","Ι","Κ","Λ","Μ","Ν","Ξ","Ο","Π","Ρ","Σ","Τ","Υ","Φ","Χ","Ψ","Ω","Ά","Έ","Ή","Ί","Ό","Ύ","Ώ","Ϊ","Ϋ","α","β","γ","δ","ε","ζ","η","θ","ι","κ","λ","μ","ν","ξ","ο","π","ρ","σ","ς","τ","υ","φ","χ","ψ","ω","ά","έ","ή","ί","ό","ύ","ώ","ϊ","ϋ","ΐ","ΰ","’","‘","ḩ","Ḩ","ţ","Ţ","bٍ","°","´"];class Ur{constructor(){this.atlasesArr=[],this.atlasIndexes={},this.tokenImageSize=64,this.samplerArr=[0],this._handler=null,this.defaultFace="arial",this._counter=0,this._pendingsQueue=new Sr,this.fontDetector=new Ir,this._sdfCreator=new kr(256,256)}assignHandler(t){this._handler=t}getFontIndex(t,e,i){return this.atlasIndexes[this.getFullIndex(t,e,i)]}getFullIndex(t,e,i){return(!(t=t&&t.trim().toLowerCase())||t&&!this.fontDetector.detect(t))&&(t=this.defaultFace),t+" "+(e&&e.toLowerCase()||"normal")+" "+(i&&i.toLowerCase()||"normal")}createFont(t,e,i){var r=this.getFontIndex(t,e,i);if(void 0==r){var s=this.tokenImageSize,n=this.getFullIndex(t,e,i);r=this.atlasIndexes[n]=this.atlasesArr.length;var o=new Lr(2048,2048);o.assignHandler(this._handler),o.borderSize=6,this.samplerArr[this.atlasesArr.length]=this.atlasesArr.length,this.atlasesArr.push(o),o.canvas.fillColor("black");for(var a=Or,h=new vr(512,512),l=this._sdfCreator,u=Math.round(337.92),c=(e||"normal")+" "+(i||"normal")+" "+u+"px "+(t||this.defaultFace),_=0;_<a.length;_++){var d=a[_];h.fillColor("black"),h.drawText(d,49,u,c,"white");var f=l.createSDF(h._canvas,s,s);f.__nodeIndex=d;var p=o.addImage(f,!0),v=h.getTextWidth(d);p.emptySize=v/512}o.createTexture(),h.destroy(),h=null}return r}createFontAsync(t,e,i,r){var s={face:t,style:e,weight:i,callback:r};this._counter>=1?this._pendingsQueue.push(s):this._exec(s)}_exec(t){this._counter++;var e=this;setTimeout(function(){var i=e.createFont(t.face,t.style,t.weight);t.callback(i),e._dequeueRequest()},0)}_dequeueRequest(){var t;(this._counter--,this._pendingsQueue.length&&this._counter<1)&&((t=this._whilePendings())&&this._exec(t))}_whilePendings(){for(;this._pendingsQueue.length;){var t=this._pendingsQueue.pop(),e=this.getFontIndex(t.face,t.style,t.weight);if(void 0==e)return t;t.callback(e)}}}class Vr extends Mr{constructor(t){super(t),this.renderer=null,this.drawMode=null,this.show=!0,this._isActive=!0,this.lightEnabled=!1,this._lights=[],this._lightsTransformedPositions=[],this._lightsParamsv=[],this._lightsParamsf=[],this._lightsNames=[],this.entityCollections=[],this.billboardsTextureAtlas=new Lr,this.fontAtlas=new Ur,this.events=new Xi(null,this)}setFontAtlas(t){this.fontAtlas=t,this.renderer&&this.fontAtlas.assignHandler(this.renderer.handler)}assignRenderer(t){this.renderer=t,this.billboardsTextureAtlas.assignHandler(t.handler),this.fontAtlas.assignHandler(t.handler),t.addPickingCallback(this,this._entityCollectionPickingCallback);for(var e=0;e<this.entityCollections.length;e++)this.entityCollections[e].setRenderer(t);this.initialization&&this.initialization()}addEntityCollection(t,e){return t.addTo(this,e),this}removeEntityCollection(t){t.remove()}addLight(t){return t.addTo(this),this}getLightByName(t){var e=this._lightsNames.indexOf(t);return this._lights[e]}removeLight(t){t.remove()}drawNode(){this._isActive&&this._drawNodes()}isActive(){return this._isActive}setActive(t){this._isActive=t;for(var e=0;e<this.childNodes.length;e++)this.childNodes[e].setActive(t)}setDrawMode(t){this.drawMode=t;for(var e=0;e<this.childNodes.length;e++)this.childNodes[e].setDrawMode(t)}transformLights(){for(var t=this.renderer,e=0;e<this._lights.length;e++){var i,r=4*e;this._lights[e].directional?(i=t.activeCamera._normalMatrix.mulVec(this._lights[e]._position),this._lightsTransformedPositions[r+3]=0):(i=t.activeCamera._viewMatrix.mulVec3(this._lights[e]._position),this._lightsTransformedPositions[r+3]=1),this._lightsTransformedPositions[r]=i.x,this._lightsTransformedPositions[r+1]=i.y,this._lightsTransformedPositions[r+2]=i.z}}updateBillboardsTexCoords(){for(var t=0;t<this.entityCollections.length;t++)this.entityCollections[t].billboardHandler.refreshTexCoordsArr()}_drawNodes(){for(var t=0;t<this.childNodes.length;t++)this.childNodes[t]._isActive&&this.childNodes[t]._drawNodes();this.show&&(this.frame&&this.frame(),this.drawEntityCollections(this.entityCollections))}drawEntityCollections(t){if(t.length){var e=this.renderer.handler.gl;e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE),e.disable(e.CULL_FACE),e.enable(e.POLYGON_OFFSET_FILL),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.billboardsTextureAtlas.texture);for(var i=t.length;i--;){(s=t[i])._fadingOpacity&&(s.events.dispatch(s.events.draw,s),s.billboardHandler.draw())}var r=this.fontAtlas.atlasesArr;for(i=0;i<r.length;i++)e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_2D,r[i].texture);for(i=t.length;i--;)t[i]._fadingOpacity&&t[i].labelHandler.draw();for(i=t.length;i--;)t[i]._fadingOpacity&&t[i].polylineHandler.draw();for(e.polygonOffset(0,0),e.disable(e.POLYGON_OFFSET_FILL),e.enable(e.CULL_FACE),i=t.length;i--;){var s;(s=t[i])._fadingOpacity&&(s.shapeHandler.draw(),s.events.dispatch(s.events.drawend,s))}for(i=t.length;i--;)t[i]._fadingOpacity&&t[i].pointCloudHandler.draw()}}drawPickingEntityCollections(t){if(t.length){var e=this.renderer.handler.gl;e.disable(e.CULL_FACE),e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,-637e3);for(var i=t.length;i--;)t[i]._fadingOpacity&&t[i].billboardHandler.drawPicking();for(i=t.length;i--;)t[i]._fadingOpacity&&t[i].labelHandler.drawPicking();e.polygonOffset(0,0),e.disable(e.POLYGON_OFFSET_FILL),e.enable(e.CULL_FACE)}}_entityCollectionPickingCallback(){this.drawPickingEntityCollections(this.entityCollections)}}i.d(e,"bv",function(){return Hr}),i.d(e,"control",function(){return Xr}),i.d(e,"webgl",function(){return Yr}),i.d(e,"scene",function(){return jr}),i.d(e,"entity",function(){return Wr}),i.d(e,"jd",function(){return n}),i.d(e,"math",function(){return r}),i.d(e,"utils",function(){return s}),i.d(e,"input",function(){return ai}),i.d(e,"Control",function(){return ni}),i.d(e,"Camera",function(){return lr}),i.d(e,"LightSource",function(){return zr}),i.d(e,"EntityCollection",function(){return or}),i.d(e,"Handler",function(){return Cr}),i.d(e,"Renderer",function(){return Rr}),i.d(e,"Clock",function(){return mr}),i.d(e,"Events",function(){return Xi}),i.d(e,"RenderNode",function(){return Vr}),i.d(e,"Line2",function(){return _r}),i.d(e,"Line3",function(){return dr}),i.d(e,"Mat3",function(){return Vt}),i.d(e,"Mat4",function(){return Ht}),i.d(e,"Plane",function(){return fr}),i.d(e,"Quat",function(){return Xt}),i.d(e,"Ray",function(){return pr}),i.d(e,"Vec2",function(){return Yt}),i.d(e,"Vec3",function(){return Wt}),i.d(e,"Vec4",function(){return Ut}),i.d(e,"Entity",function(){return wi});const Hr={Box:class{constructor(){this.vertices=[new Wt,new Wt,new Wt,new Wt,new Wt,new Wt,new Wt,new Wt]}setFromBounds(t){var e=t[0],i=t[1],r=t[2],s=t[3],n=t[4],o=t[5];this.vertices[0].set(e,r,n),this.vertices[1].set(i,r,n),this.vertices[2].set(i,r,o),this.vertices[3].set(e,r,o),this.vertices[4].set(e,s,n),this.vertices[5].set(i,s,n),this.vertices[6].set(i,s,o),this.vertices[7].set(e,s,o)}setFromExtent(t,e){this.setFromBounds(e.getCartesianBounds(t))}},Sphere:class{constructor(t,e){this.radius=t||0,this.center=e?e.clone():new Wt}setFromBounds(t){this.center.set(t[0]+(t[1]-t[0])/2,t[2]+(t[3]-t[2])/2,t[4]+(t[5]-t[4])/2),this.radius=this.center.distance(new Wt(t[0],t[2],t[4]))}setFromExtent(t,e){this.setFromBounds(e.getCartesianBounds(t))}}},Xr={DebugInfo:oi,SimpleNavigation:hi,ShowFps:li},Wr={Billboard:ci,Label:vi,PointCloud:Ci,Polyline:yi},Yr={Framebuffer:gr,Handler:Cr,MultiFramebuffer:Er,types:Pi,ShaderProgram:Fi},jr={Axes:class extends Vr{constructor(t){super("Axes"),this.size=t||100,this.axesBuffer=null,this.axesColorBuffer=null}initialization(){this.createAxisBuffer(this.size),this.drawMode=this.renderer.handler.gl.LINES,this.renderer.handler.addShaderProgram(new Fi("axesShader",{uniforms:{projectionViewMatrix:"mat4"},attributes:{aVertexPosition:"vec3",aVertexColor:"vec4"},vertexShader:"attribute vec3 aVertexPosition;            attribute vec4 aVertexColor;            uniform mat4 projectionViewMatrix;            varying vec4 vColor;            void main(void) {                gl_Position = projectionViewMatrix * vec4(aVertexPosition, 1.0);                vColor = aVertexColor;            }",fragmentShader:"precision highp float;            varying vec4 vColor;            void main(void) {                gl_FragColor = vColor;            }"}))}frame(){this.renderer.handler.shaderPrograms.axesShader.activate().set({projectionViewMatrix:this.renderer.activeCamera._projectionViewMatrix._m,aVertexPosition:this.axisBuffer,aVertexColor:this.axisColorBuffer}),this.renderer.handler.shaderPrograms.axesShader.drawArray(this.drawMode,this.axisBuffer.numItems)}createAxisBuffer(t){var e=[0,0,0,t-1,0,0,0,0,0,0,t-1,0,0,0,0,0,0,t-1];this.axisBuffer=this.renderer.handler.createArrayBuffer(new Float32Array(e),3,6),this.axisColorBuffer=this.renderer.handler.createArrayBuffer(new Float32Array([1,0,0,1,1,0,0,1,0,0,1,1,0,0,1,1,0,1,0,1,0,1,0,1]),4,6)}}}}])});