!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("og",[],e):"object"==typeof exports?exports.og=e():t.og=e()}(window,(function(){return function(t){var e={};function i(r){if(e[r])return e[r].exports;var s=e[r]={i:r,l:!1,exports:{}};return t[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=t,i.c=e,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(r,s,function(e){return t[e]}.bind(null,s));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);class r{constructor(t,e){this._canvas=document.createElement("canvas"),this._canvas.width=t||256,this._canvas.height=e||256,this._context=this._canvas.getContext("2d")}getCanvas(){return this._canvas}getContext(){return this._context}fillEmpty(){for(var t=this._context.getImageData(0,0,this._canvas.width,this._canvas.height),e=t.data,i=0,r=e.length;i<r;i+=4)e[i]=e[i+1]=e[i+2]=e[i+3]=0;this._context.putImageData(t,0,0)}getData(){return this._context.getImageData(0,0,this._canvas.width,this._canvas.height).data}fillColor(t){this._context.fillStyle=t,this._context.fillRect(0,0,this._canvas.width,this._canvas.height)}setData(t){var e=this._context.createImageData(this._canvas.width,this._canvas.height);e.data.set(t),this._context.putImageData(e,0,0)}resize(t,e){this._canvas.width=t,this._canvas.height=e,this._context=this._canvas.getContext("2d")}drawImage(t,e,i,r,s){this._context=this._canvas.getContext("2d"),this._context.drawImage(t,e||0,i||0,r||t.width,s||t.height)}getImage(){var t=new Image;return t.width=this.getWidth(),t.height=this.getHeight(),t.src=this._canvas.toDataURL("image/png"),t}getTextWidth(t){var e=this._context.measureText(t);return Math.round(e.width)}drawText(t,e,i,r,s){this._context.fillStyle=s||"black",this._context.font=r||"normal 14px Verdana",this._context.fillText(t,e||0,i||14)}getWidth(){return this._canvas.width}getHeight(){return this._canvas.height}load(t,e){var i=new Image,r=this;i.onload=function(){r.resize(i.width,i.height),r._context.drawImage(i,0,0,i.width,i.height),e&&e(i)},i.src=t}openImage(){var t=this.getImage(),e="<!DOCTYPE html>";e+="<html>",e+="<head><title>Print</title></head>",e+="<body>",e+='<img src="'+t.src+'">',e+="</body>",e+="</html>";var i=window.open("","","width="+t.width+"px ,height="+t.height+"px");i.document.open(),i.document.write(e),i.document.close(),i.focus()}destroy(){this._canvas.width=1,this._canvas.height=1,this._canvas=null,this._context=null}}const s=function(t,e){e=e||{},this.handler=t,this._fbo=null,this._isBare=e.isBare||!1,this._depthRenderbuffer=null,this._filter=e.filter||"NEAREST",this._internalFormat=e.internalFormat||"RGBA",this._format=e.format||"RGBA",this._type=e.type||"UNSIGNED_BYTE",this._width=e.width||t.canvas.width,this._height=e.height||t.canvas.height,this._depthComponent=null!=e.depthComponent?e.depthComponent:"DEPTH_COMPONENT16",this._useDepth=null==e.useDepth||e.useDepth,this._active=!1,this._size=e.size||1,this.textures=e.textures||new Array(this._size)};s.prototype.destroy=function(){for(var t=this.handler.gl,e=0;e<this.textures.length;e++)t.deleteTexture(this.textures[e]);this.textures=new Array(this._size),t.deleteFramebuffer(this._fbo),t.deleteRenderbuffer(this._depthRenderbuffer),this._depthRenderbuffer=null,this._fbo=null,this._active=!1},s.prototype.init=function(){var t=this.handler.gl;if(this._fbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),!this._isBare)if(0===this.textures.length)this.bindOutputTexture(this.handler.createEmptyTexture2DExt(this._width,this._height,this._filter,this._internalFormat,this._format,this._type)),t.drawBuffers&&t.drawBuffers([t.COLOR_ATTACHMENT0]);else{let i=[];for(var e=0;e<this.textures.length;e++)this.bindOutputTexture(this.textures[e]||this.handler.createEmptyTexture2DExt(this._width,this._height,this._filter,this._internalFormat,this._format,this._type),e),i.push(t.COLOR_ATTACHMENT0+e);t.drawBuffers&&t.drawBuffers(i)}return this._useDepth&&(this._depthRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._depthRenderbuffer),t.renderbufferStorage(t.RENDERBUFFER,t[this._depthComponent],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this._depthRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null)),t.bindFramebuffer(t.FRAMEBUFFER,null),this},s.prototype.bindOutputTexture=function(t,e=0){var i=this.handler.gl;i.bindTexture(i.TEXTURE_2D,t),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,i.TEXTURE_2D,t,0),i.bindTexture(i.TEXTURE_2D,null),this.textures[e]=t},s.prototype.setSize=function(t,e,i){this._width=t,this._height=e,this._active&&this.handler.gl.viewport(0,0,this._width,this._height),(this._useDepth||i)&&(this.destroy(),this.init())},s.prototype.isComplete=function(){var t=this.handler.gl;return t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE},s.prototype.readPixels=function(t,e,i,r=0,s=1,n=1){var h=this.handler.gl;h.bindFramebuffer(h.FRAMEBUFFER,this._fbo),h.readBuffer&&h.readBuffer(h.COLOR_ATTACHMENT0+r||0),h.readPixels(e*this._width,i*this._height,s,n,h.RGBA,h[this._type],t),h.bindFramebuffer(h.FRAMEBUFFER,null)},s.prototype.readAllPixels=function(t,e=0){var i=this.handler.gl;i.bindFramebuffer(i.FRAMEBUFFER,this._fbo),i.readBuffer&&i.readBuffer(i.COLOR_ATTACHMENT0+e),i.readPixels(0,0,this._width,this._height,i.RGBA,i[this._type],t),i.bindFramebuffer(i.FRAMEBUFFER,null)},s.prototype.activate=function(){var t=this.handler.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),t.viewport(0,0,this._width,this._height),this._active=!0;var e=this.handler.framebufferStack.current().data;return e&&(e._active=!1),this.handler.framebufferStack.push(this),this},s.prototype.deactivate=function(){var t=this.handler,e=t.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this._active=!1;var i=this.handler.framebufferStack.popPrev();i?(e.bindFramebuffer(e.FRAMEBUFFER,i._fbo),e.viewport(0,0,i._width,i._height)):e.viewport(0,0,t.canvas.width,t.canvas.height)},s.prototype.getImage=function(){var t=new Uint8Array(4*this._width*this._height);this.readAllPixels(t);var e=new r(this._width,this._height);return e.setData(t),e.getImage()},s.prototype.openImage=function(){var t=this.getImage(),e="<!DOCTYPE html>";e+="<html>",e+="<head><title>Print</title></head>",e+="<body>",e+='<img src="'+t.src+'">',e+="</body>",e+="</html>";var i=window.open("","","width="+t.width+"px ,height="+t.height+"px");i.document.open(),i.document.write(e),i.document.close(),i.focus()};const n=new class{constructor(){this._container=document.createElement("div"),this._container.classList.add("ogConsole"),this._container.style.display="none",document.body&&document.body.appendChild(this._container),this._visibility=!1}getVisibility(){return this._visibility}setVisibility(t){this._visibility!=t&&(this._visibility=t,this._visibility?this.show():this.hide())}show(){this._container.parentNode||document.body&&document.body.appendChild(this._container),this._container.style.display="block",this._visibility=!0}hide(){this._container.style.display="none",this._visibility=!1}logErr(t){var e=document.createElement("div");e.classList.add("ogConsole-text"),e.classList.add("ogConsole-error"),e.innerHTML="error: "+t,console.log(e.innerHTML),this._container.appendChild(e),this.show()}logWrn(t){var e=document.createElement("div");e.classList.add("ogConsole-text"),e.classList.add("ogConsole-warning"),e.innerHTML="warning: "+t,console.log(e.innerHTML),this._container.appendChild(e),this.show()}log(t,e){var i=document.createElement("div");if(i.classList.add("ogConsole-text"),e)for(var r in e)i.style[r]=e[r];i.innerHTML=t,console.log(t),this._container.appendChild(i),this.show()}},h={ReadyState:{Uninitialized:0,Loading:1,Loaded:2,Interactive:3,Complete:4},Status:{OK:200,Created:201,Accepted:202,NoContent:204,BadRequest:400,Forbidden:403,NotFound:404,Gone:410,ServerError:500},Method:{Get:"GET",Post:"POST"},Asynchronous:!0,Synchronous:!1},a=function(t){var e=t;this.abort=function(){e.aborted=!0,e.abort()}},o={type:h.Method.Get,async:h.Asynchronous,data:null,sender:null,responseType:"text"};h.request=function(t,e){e=e||{};var i,r={};for(i in o)r[i]=o[i];for(i in e)r[i]=e[i];r.data=e.data;var s,n=function(){if(void 0!==typeof XMLHttpRequest)return new XMLHttpRequest;if(window.ActiveXObject)for(var t=["MSXML2.XMLHttp.5.0","MSXML2.XMLHttp.4.0","MSXML2.XMLHttp.3.0","MSXML2.XMLHttp","Microsoft.XMLHttp"],e=0;e<t.length;e++)try{return new ActiveXObject(t[e])}catch(t){console.log("error: og.ajax.createXMLHttp creation filed.")}}(),u=new a(n),l=null;if(r.type===h.Method.Post){if(r.data){l="";for(let t in r.data)s=r.data[t],l+=t+"="+encodeURIComponent(s instanceof Object?JSON.stringify(s):s)+"&";l=l.slice(0,-1)}n.open(r.type,t,r.async),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}else if(r.data){var _="?";for(let t in r.data)s=r.data[t],_+=t+"="+encodeURIComponent(s instanceof Object?JSON.stringify(s):s)+"&";_=_.slice(0,-1),n.open(r.type,t+_,r.async)}else n.open(r.type,t,r.async);return r.async&&(n.responseType=r.responseType),n.overrideMimeType("text/plain"),n.onreadystatechange=function(){n.readyState===h.ReadyState.Complete&&(n.status===h.Status.OK?e.success&&e.success.call(e.sender||u,n.response):n.aborted?e.abort&&e.abort.call(e.sender||u,n.response,n.status):e.error&&e.error.call(e.sender||u,n.response,n.status),delete n.onreadystatechange,n.onreadystatechange=null,n=null)},n.send(l),u};Math.PI,Math.PI,Number.MAX_VALUE,Math.log(2);const u=549755748352,l=-u,_=Math.PI/180,c=(Math.PI,.5*_);Math.sqrt(.5);const p=.5*Math.PI,f=(Math.PI,180/Math.PI),d=2*f,m=Math.PI/360,E=f*p,g=function(t,e,i){this.lon=t||0,this.lat=e||0,this.height=i||0};g.prototype.isZero=function(){return 0===this.lon&&0===this.lat&&0===this.height},g.join=function(t){for(var e=[],i=0;i<t.length;i++){var r=t[i];e[i]=new g(r[0],r[1],r[2])}return e},g.createFromArray=function(t){return new g(t[0],t[1],t[2])},g.forwardMercator=function(t,e,i){return new g(t*A,Math.log(Math.tan((90+e)*m))*R,i)},g.inverseMercator=function(t,e,i){return new g(t*M,d*Math.atan(Math.exp(e*v))-E,i)},g.prototype.set=function(t,e,i){return this.lon=t||0,this.lat=e||0,this.height=i||0,this},g.prototype.copy=function(t){return this.lon=t.lon,this.lat=t.lat,this.height=t.height,this},g.prototype.clone=function(){return new g(this.lon,this.lat,this.height)},g.prototype.forwardMercator=function(){return g.forwardMercator(this.lon,this.lat,this.height)},g.prototype.forwardMercatorEPS01=function(){var t=this.lat;return t>89.9?t=89.9:t<-89.9&&(t=-89.9),new g(this.lon*A,Math.log(Math.tan((90+t)*m))*R)},g.prototype.inverseMercator=function(){return g.inverseMercator(this.lon,this.lat,this.height)},g.prototype.equal=function(t){return t.height?this.lon===t.lon&&this.lat===t.lat&&this.height===t.height:this.lon===t.lon&&this.lat===t.lat};const T=20037508.34,v=Math.PI/T,R=T/Math.PI,b=.5*Math.PI,A=T/180,M=180/T,F=(Math.PI,Math.PI,180/Math.PI),D=2*T;var U;U=T,Math.atan(Math.exp(U*v));const C=function(t,e){this.southWest=t||new g,this.northEast=e||new g};C.FULL_MERC=new C(g.SW_MERC,g.NE_MERC),C.NORTH_POLE_DEG=new C(g.NW_MERC_DEG,new g(180,90)),C.SOUTH_POLE_DEG=new C(new g(-180,-90),g.SE_MERC_DEG),C.createFromArray=function(t){return new C(new g(t[0],t[1]),new g(t[2],t[3]))},C.createByCoordinates=function(t){for(var e=u,i=l,r=u,s=l,n=0;n<t.length;n++){var h=t[n];h.lon<e&&(e=h.lon),h.lon>i&&(i=h.lon),h.lat<r&&(r=h.lat),h.lat>s&&(s=h.lat)}return new C(new g(e,r),new g(i,s))},C.createByCoordinatesArr=function(t){for(var e=u,i=l,r=u,s=l,n=0;n<t.length;n++){var h=t[n];h[0]<e&&(e=h[0]),h[0]>i&&(i=h[0]),h[1]<r&&(r=h[1]),h[1]>s&&(s=h[1])}return new C(new g(e,r),new g(i,s))},C.fromTile=function(t,e,i,r,s){r=r||D,s=s||D;var n=Math.pow(2,i),h=r/Math.pow(2,i),a=s/n,o=.5*-r+t*h,u=.5*s-e*a,l=o+h;return new C(new g(o,u-a),new g(l,u))},C.prototype.setByCoordinates=function(t){for(var e=u,i=l,r=u,s=l,n=0;n<t.length;n++){var h=t[n];h.lon<e&&(e=h.lon),h.lon>i&&(i=h.lon),h.lat<r&&(r=h.lat),h.lat>s&&(s=h.lat)}return this.southWest.lon=e,this.southWest.lat=r,this.northEast.lon=i,this.northEast.lat=s,this},C.prototype.isInside=function(t){var e=this.southWest,i=this.northEast;return t.lon>=e.lon&&t.lon<=i.lon&&t.lat>=e.lat&&t.lat<=i.lat},C.prototype.overlaps=function(t){var e=this.southWest,i=this.northEast;return e.lon<=t.northEast.lon&&i.lon>=t.southWest.lon&&e.lat<=t.northEast.lat&&i.lat>=t.southWest.lat},C.prototype.getWidth=function(){return this.northEast.lon-this.southWest.lon},C.prototype.getHeight=function(){return this.northEast.lat-this.southWest.lat},C.prototype.clone=function(){return new C(this.southWest.clone(),this.northEast.clone())},C.prototype.getCenter=function(){var t=this.southWest,e=this.northEast;return new g(t.lon+.5*(e.lon-t.lon),t.lat+.5*(e.lat-t.lat))},C.prototype.getNorthWest=function(){return new g(this.southWest.lon,this.northEast.lat)},C.prototype.getNorthEast=function(){return new g(this.northEast.lon,this.northEast.lat)},C.prototype.getSouthWest=function(){return new g(this.southWest.lon,this.southWest.lat)},C.prototype.getSouthEast=function(){return new g(this.northEast.lon,this.southWest.lat)},C.prototype.getNorth=function(){return this.northEast.lat},C.prototype.getEast=function(){return this.northEast.lon},C.prototype.getWest=function(){return this.southWest.lon},C.prototype.getSouth=function(){return this.southWest.lat},C.prototype.equals=function(t){return this.southWest.lon===t.southWest.lon&&this.southWest.lat===t.southWest.lat&&this.northEast.lon===t.northEast.lon&&this.northEast.lat===t.northEast.lat},C.prototype.forwardMercator=function(){return new C(this.southWest.forwardMercator(),this.northEast.forwardMercator())},C.prototype.inverseMercator=function(){return new C(this.southWest.inverseMercator(),this.northEast.inverseMercator())},C.prototype.getCartesianBounds=function(t){for(var e=u,i=l,r=u,s=l,n=u,h=l,a=[new g(this.southWest.lon,this.southWest.lat),new g(this.southWest.lon,this.northEast.lat),new g(this.northEast.lon,this.northEast.lat),new g(this.northEast.lon,this.southWest.lat)],o=0;o<a.length;o++){var _=t.lonLatToCartesian(a[o]),c=_.x,p=_.y,f=_.z;c<e&&(e=c),c>i&&(i=c),p<r&&(r=p),p>s&&(s=p),f<n&&(n=f),f>h&&(h=f)}return[e,r,n,i,s,h]},C.prototype.toString=function(){return"["+this.southWest.lon+", "+this.southWest.lat+", "+this.northEast.lon+", "+this.northEast.lat+"]"};const P=function(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=r||0};P.identity=new P(0,0,0,1),P.fromVec=function(t){return new P(t[0],t[1],t[2],t[3])},P.prototype.toVec3=function(){return new S(this.x,this.y,this.z)},P.prototype.clone=function(t){return new P(this.x,this.y,this.z,this.w)},P.prototype.equal=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},P.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},P.prototype.toVec=function(){return[this.x,this.y,this.z,this.w]},P.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},P.prototype.set=function(t,e,i,r){return this.x=t,this.y=e,this.z=i,this.w=r,this},P.prototype.addA=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},P.prototype.subA=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},P.prototype.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},P.prototype.affinity=function(){var t=1/this.w;return this.x*=t,this.y*=t,this.z*=t,this.w=1,this},P.prototype.scaleTo=function(t){return new P(this.x*t,this.y*t,this.z*t,this.w*t)},P.prototype.getStep=function(t){return new P(this.x<t?0:1,this.y<t?0:1,this.z<t?0:1,this.w<t?0:1)},P.prototype.getFrac=function(t){return new P(og.math.frac(t.x),og.math.frac(t.y),og.math.frac(t.z),og.math.frac(t.w))},P.prototype.dot=function(t){return t.x*this.x+t.y*this.y+t.z*this.z+t.w*this.w};const I=function(){this._m=new Array(9)};I.prototype.set=function(t){return this._m[0]=t[0],this._m[1]=t[1],this._m[2]=t[2],this._m[3]=t[3],this._m[4]=t[4],this._m[5]=t[5],this._m[6]=t[6],this._m[7]=t[7],this._m[8]=t[8],this},I.prototype.clone=function(){var t=new I;return t.set(this),t},I.prototype.copy=function(t){return this.set(t._m)},I.prototype.transposeTo=function(){var t=new I,e=this._m;return t._m[0]=e[0],t._m[1]=e[3],t._m[2]=e[6],t._m[3]=e[1],t._m[4]=e[4],t._m[5]=e[7],t._m[6]=e[2],t._m[7]=e[5],t._m[8]=e[8],t},I.prototype.setIdentity=function(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=1,this._m[5]=0,this._m[6]=0,this._m[7]=0,this._m[8]=1,this},I.prototype.mulVec=function(t){var e=t.x,i=t.y,r=t.z,s=this._m;return new S(s[0]*e+s[3]*i+s[6]*r,s[1]*e+s[4]*i+s[7]*r,s[2]*e+s[5]*i+s[8]*r)},I.prototype.toMatrix4=function(){var t=new B,e=t._m,i=this._m;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=0,e[4]=i[3],e[5]=i[4],e[6]=i[5],e[7]=0,e[8]=i[6],e[9]=i[7],e[10]=i[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,t};const B=function(){this._m=new Array(16),this.left,this.right,this.bottom,this.top,this.near,this.far};B.identity=function(){var t=new B;return t._m[0]=1,t._m[1]=0,t._m[2]=0,t._m[3]=0,t._m[4]=0,t._m[5]=1,t._m[6]=0,t._m[7]=0,t._m[8]=0,t._m[9]=0,t._m[10]=1,t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t},B.prototype.set=function(t){return this._m[0]=t[0],this._m[1]=t[1],this._m[2]=t[2],this._m[3]=t[3],this._m[4]=t[4],this._m[5]=t[5],this._m[6]=t[6],this._m[7]=t[7],this._m[8]=t[8],this._m[9]=t[9],this._m[10]=t[10],this._m[11]=t[11],this._m[12]=t[12],this._m[13]=t[13],this._m[14]=t[14],this._m[15]=t[15],this},B.prototype.clone=function(){var t=new B;return t.set(this),t},B.prototype.copy=function(t){this.set(t._m)},B.prototype.toMatrix3=function(){var t=new I,e=this._m,i=t._m;return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[4],i[4]=e[5],i[5]=e[6],i[6]=e[8],i[7]=e[9],i[8]=e[10],t},B.prototype.mulVec3=function(t){var e=t.x,i=t.y,r=t.z;return new S(this._m[0]*e+this._m[4]*i+this._m[8]*r+this._m[12],this._m[1]*e+this._m[5]*i+this._m[9]*r+this._m[13],this._m[2]*e+this._m[6]*i+this._m[10]*r+this._m[14])},B.prototype.mulVec4=function(t){var e=t.x,i=t.y,r=t.z,s=t.w;return new P(this._m[0]*e+this._m[4]*i+this._m[8]*r+this._m[12]*s,this._m[1]*e+this._m[5]*i+this._m[9]*r+this._m[13]*s,this._m[2]*e+this._m[6]*i+this._m[10]*r+this._m[14]*s,this._m[3]*e+this._m[7]*i+this._m[11]*r+this._m[15]*s)},B.prototype.toInverseMatrix3=function(){var t=this._m,e=t[0],i=t[1],r=t[2],s=t[4],n=t[5],h=t[6],a=t[8],o=t[9],u=t[10],l=u*n-h*o,_=-u*s+h*a,c=o*s-n*a,p=e*l+i*_+r*c;if(!p)return null;p=1/p;var f=new I;return f._m[0]=l*p,f._m[1]=(-u*i+r*o)*p,f._m[2]=(h*i-r*n)*p,f._m[3]=_*p,f._m[4]=(u*e-r*a)*p,f._m[5]=(-h*e+r*s)*p,f._m[6]=c*p,f._m[7]=(-o*e+i*a)*p,f._m[8]=(n*e-i*s)*p,f},B.prototype.inverseTo=function(){var t=this._m[0],e=this._m[1],i=this._m[2],r=this._m[3],s=this._m[4],n=this._m[5],h=this._m[6],a=this._m[7],o=this._m[8],u=this._m[9],l=this._m[10],_=this._m[11],c=this._m[12],p=this._m[13],f=this._m[14],d=this._m[15],m=t*n-e*s,y=t*h-i*s,E=t*a-r*s,g=e*h-i*n,x=e*a-r*n,T=i*a-r*h,v=o*p-u*c,R=o*f-l*c,b=o*d-_*c,w=u*f-l*p,A=u*d-_*p,M=l*d-_*f,F=1/(m*M-y*A+E*w+g*b-x*R+T*v),z=new B;return z._m[0]=(n*M-h*A+a*w)*F,z._m[1]=(-e*M+i*A-r*w)*F,z._m[2]=(p*T-f*x+d*g)*F,z._m[3]=(-u*T+l*x-_*g)*F,z._m[4]=(-s*M+h*b-a*R)*F,z._m[5]=(t*M-i*b+r*R)*F,z._m[6]=(-c*T+f*E-d*y)*F,z._m[7]=(o*T-l*E+_*y)*F,z._m[8]=(s*A-n*b+a*v)*F,z._m[9]=(-t*A+e*b-r*v)*F,z._m[10]=(c*x-p*E+d*m)*F,z._m[11]=(-o*x+u*E-_*m)*F,z._m[12]=(-s*w+n*R-h*v)*F,z._m[13]=(t*w-e*R+i*v)*F,z._m[14]=(-c*g+p*y-f*m)*F,z._m[15]=(o*g-u*y+l*m)*F,z},B.prototype.transposeTo=function(){var t=new B;return t._m[0]=this._m[0],t._m[1]=this._m[4],t._m[2]=this._m[8],t._m[3]=this._m[12],t._m[4]=this._m[1],t._m[5]=this._m[5],t._m[6]=this._m[9],t._m[7]=this._m[13],t._m[8]=this._m[2],t._m[9]=this._m[6],t._m[10]=this._m[10],t._m[11]=this._m[14],t._m[12]=this._m[3],t._m[13]=this._m[7],t._m[14]=this._m[11],t._m[15]=this._m[15],t},B.prototype.setIdentity=function(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=0,this._m[5]=1,this._m[6]=0,this._m[7]=0,this._m[8]=0,this._m[9]=0,this._m[10]=1,this._m[11]=0,this._m[12]=0,this._m[13]=0,this._m[14]=0,this._m[15]=1,this},B.prototype.mul=function(t){let e=this._m[0],i=this._m[1],r=this._m[2],s=this._m[3],n=this._m[4],h=this._m[5],a=this._m[6],o=this._m[7],u=this._m[8],l=this._m[9],_=this._m[10],c=this._m[11],p=this._m[12],f=this._m[13],d=this._m[14],m=this._m[15],y=t._m[0],E=t._m[1],g=t._m[2],x=t._m[3],T=t._m[4],v=t._m[5],R=t._m[6],b=t._m[7],w=t._m[8],A=t._m[9],M=t._m[10],F=t._m[11],z=t._m[12],D=t._m[13],U=t._m[14],C=t._m[15];var P=new B;return P._m[0]=y*e+E*n+g*u+x*p,P._m[1]=y*i+E*h+g*l+x*f,P._m[2]=y*r+E*a+g*_+x*d,P._m[3]=y*s+E*o+g*c+x*m,P._m[4]=T*e+v*n+R*u+b*p,P._m[5]=T*i+v*h+R*l+b*f,P._m[6]=T*r+v*a+R*_+b*d,P._m[7]=T*s+v*o+R*c+b*m,P._m[8]=w*e+A*n+M*u+F*p,P._m[9]=w*i+A*h+M*l+F*f,P._m[10]=w*r+A*a+M*_+F*d,P._m[11]=w*s+A*o+M*c+F*m,P._m[12]=z*e+D*n+U*u+C*p,P._m[13]=z*i+D*h+U*l+C*f,P._m[14]=z*r+D*a+U*_+C*d,P._m[15]=z*s+D*o+U*c+C*m,P},B.prototype.translate=function(t){var e=t.x,i=t.y,r=t.z,s=this._m;return s[12]=s[0]*e+s[4]*i+s[8]*r+s[12],s[13]=s[1]*e+s[5]*i+s[9]*r+s[13],s[14]=s[2]*e+s[6]*i+s[10]*r+s[14],s[15]=s[3]*e+s[7]*i+s[11]*r+s[15],this},B.prototype.translateToPosition=function(t){var e=this._m;return e[12]=t.x,e[13]=t.y,e[14]=t.z,this},B.prototype.rotate=function(t,e){var i=Math.cos(e),r=Math.sin(e),s=new B,n=s._m;return n[0]=i+(1-i)*t.x*t.x,n[1]=(1-i)*t.y*t.x-r*t.z,n[2]=(1-i)*t.z*t.x+r*t.y,n[3]=0,n[4]=(1-i)*t.x*t.y+r*t.z,n[5]=i+(1-i)*t.y*t.y,n[6]=(1-i)*t.z*t.y-r*t.x,n[7]=0,n[8]=(1-i)*t.x*t.z-r*t.y,n[9]=(1-i)*t.y*t.z+r*t.x,n[10]=i+(1-i)*t.z*t.z,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,this.mul(s)},B.prototype.setRotation=function(t,e){var i=Math.cos(e),r=Math.sin(e),s=this._m;return s[0]=i+(1-i)*t.x*t.x,s[1]=(1-i)*t.y*t.x-r*t.z,s[2]=(1-i)*t.z*t.x+r*t.y,s[3]=0,s[4]=(1-i)*t.x*t.y+r*t.z,s[5]=i+(1-i)*t.y*t.y,s[6]=(1-i)*t.z*t.y-r*t.x,s[7]=0,s[8]=(1-i)*t.x*t.z-r*t.y,s[9]=(1-i)*t.y*t.z+r*t.x,s[10]=i+(1-i)*t.z*t.z,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this},B.prototype.rotateBetweenVectors=function(t,e){return N.getRotationBetweenVectors(t,e).getMat4()},B.prototype.scale=function(t){var e=this._m;return e[0]=e[0]*t.x,e[1]=e[1]*t.x,e[2]=e[2]*t.x,e[3]=e[3]*t.x,e[4]=e[4]*t.y,e[5]=e[5]*t.y,e[6]=e[6]*t.y,e[7]=e[7]*t.y,e[8]=e[8]*t.z,e[9]=e[9]*t.z,e[10]=e[10]*t.z,e[11]=e[11]*t.z,e[12]=e[12],e[13]=e[13],e[14]=e[14],e[15]=e[15],this},B.prototype.setFrustum=function(t,e,i,r,s,n){var h=e-t,a=r-i,o=n-s;return this._m[0]=2*s/h,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=0,this._m[5]=2*s/a,this._m[6]=0,this._m[7]=0,this._m[8]=(e+t)/h,this._m[9]=(r+i)/a,this._m[10]=-(n+s)/o,this._m[11]=-1,this._m[12]=0,this._m[13]=0,this._m[14]=-n*s*2/o,this._m[15]=0,this},B.prototype.setPerspective=function(t,e,i,r){return e*=t=i*Math.tan(t*Math.PI/360),this.setFrustum(-e,e,-t,t,i,r)},B.prototype.setOrtho=function(t,e,i,r,s,n){var h=1/(t-e),a=1/(i-r),o=1/(s-n),u=this._m;return u[0]=-2*h,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=-2*a,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=2*o,u[11]=0,u[12]=(t+e)*h,u[13]=(r+i)*a,u[14]=(n+s)*o,u[15]=1,this},B.prototype.eulerToMatrix=function(t,e,i){var r=Math.cos(t),s=Math.sin(t),n=Math.cos(e),h=Math.sin(e),a=Math.cos(i),o=Math.sin(i),u=r*h,l=s*h,_=this._m;return _[0]=n*a,_[1]=-n*o,_[2]=-h,_[4]=-l*a+r*o,_[5]=l*o+r*a,_[6]=-s*n,_[8]=u*a+s*o,_[9]=-u*o+s*a,_[10]=r*n,_[3]=_[7]=_[11]=_[12]=_[13]=_[14]=0,_[15]=1,this};const N=function(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=r||0};N.IDENTITY=new N(0,0,0,1),N.xRotation=function(t){return t*=.5,new N(Math.sin(t),0,0,Math.cos(t))},N.yRotation=function(t){return t*=.5,new N(0,Math.sin(t),0,Math.cos(t))},N.zRotation=function(t){return t*=.5,new N(0,0,Math.sin(t),Math.cos(t))},N.axisAngleToQuat=function(t,e){e=e||0;var i=t.normal(),r=.5*e,s=Math.sin(r);return new N(i.x*s,i.y*s,i.z*s,Math.cos(r))},N.getLookRotation=function(t,e){var i=t.normal().negate(),r=e.cross(i).normalize(),s=i.cross(r),n=1+r.x+s.y+i.z;if(n>1e-6){let t=1/(2*Math.sqrt(n));return new N((i.y-s.z)*t,(r.z-i.x)*t,(s.x-r.y)*t,.25/t)}if(r.x>s.y&&r.x>i.z){let t=1/(2*Math.sqrt(1+r.x-s.y-i.z));return new N(.25/t,(s.x+r.y)*t,(r.z+i.x)*t,(i.y-s.z)*t)}if(s.y>i.z){let t=1/(2*Math.sqrt(1+s.y-r.x-i.z));return new N((s.x+r.y)*t,.25/t,(i.y+s.z)*t,(r.z-i.x)*t)}let h=1/(2*Math.sqrt(1+i.z-r.x-s.y));return new N((r.z+i.x)*h,(i.y+s.z)*h,.25/h,(s.x-r.y)*h)},N.getLookAtSourceDest=function(t,e){var i=e.subA(t).normalize(),r=S.FORWARD.dot(i);if(Math.abs(r- -1)<1e-6)return N.axisAngleToQuat(S.UP,Math.PI);if(Math.abs(r-1)<1e-6)return new N(0,0,0,1);var s=Math.acos(r),n=S.FORWARD.cross(i).normalize();return N.axisAngleToQuat(n,s)},N.getRotationBetweenVectors=function(t,e){var i=t.cross(e);return new N(i.x,i.y,i.z,1+t.dot(e)).normalize()},N.getRotationBetweenVectorsUp=function(t,e,i){var r=t.dot(e);if(Math.abs(r+1)<1e-6)return N.axisAngleToQuat(i,Math.PI);if(Math.abs(r-1)<1e-6)return new N(0,0,0,1);var s=Math.acos(r),n=t.cross(e).normalize();return N.axisAngleToQuat(n,s)},N.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z&&0===this.w},N.prototype.clear=function(){return this.x=this.y=this.z=this.w=0,this},N.prototype.set=function(t,e,i,r){return this.x=t,this.y=e,this.z=i,this.w=r,this},N.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},N.prototype.setIdentity=function(){return this.x=0,this.y=0,this.z=0,this.w=1,this},N.prototype.clone=function(){return new N(this.x,this.y,this.z,this.w)},N.prototype.add=function(t){return new N(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)},N.prototype.sub=function(t){return new N(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)},N.prototype.scaleTo=function(t){return new N(this.x*t,this.y*t,this.z*t,this.w*t)},N.prototype.scale=function(t){return this.x,this.y,this.z,this.w*t},N.prototype.toVec=function(){return[this.x,this.y,this.z,this.w]},N.prototype.setFromSphericalCoords=function(t,e,i){var r=Math.sin(i/2),s=Math.cos(i/2),n=Math.sin(t),h=Math.cos(t),a=Math.sin(e),o=Math.cos(e);return this.x=r*h*a,this.y=r*n,this.z=r*n*o,this.w=s,this},N.prototype.setLookRotation=function(t,e){var i=t.normal().negate(),r=e.cross(i).normalize(),s=i.cross(r),n=1+r.x+s.y+i.z;if(n>1e-6){let t=1/(2*Math.sqrt(n));this.x=(i.y-s.z)*t,this.y=(r.z-i.x)*t,this.z=(s.x-r.y)*t,this.w=.25/t}else if(r.x>s.y&&r.x>i.z){let t=1/(2*Math.sqrt(1+r.x-s.y-i.z));this.x=.25/t,this.y=(s.x+r.y)*t,this.z=(r.z+i.x)*t,this.w=(i.y-s.z)*t}else if(s.y>i.z){let t=1/(2*Math.sqrt(1+s.y-r.x-i.z));this.x=(s.x+r.y)*t,this.y=.25/t,this.z=(i.y+s.z)*t,this.w=(r.z-i.x)*t}else{let t=1/(2*Math.sqrt(1+i.z-r.x-s.y));this.x=(r.z+i.x)*t,this.y=(i.y+s.z)*t,this.z=.25/t,this.w=(s.x-r.y)*t}return this},N.prototype.toSphericalCoords=function(){var t=this.w,e=Math.sqrt(1-t*t);Math.acos(t);Math.abs(e)<5e-4&&(e=1);var i,r=this.x/e,s=this.y/e,n=this.z/e,h=-Math.asin(s);return(i=r*r+n*n<5e-4?0:Math.atan2(r,n))<0&&(i+=360),{lat:h,lon:i,alpha:Math.acos(t)}},N.prototype.setFromAxisAngle=function(t,e){var i=t.normal(),r=.5*e,s=Math.sin(r);return this.set(i.x*s,i.y*s,i.z*s,Math.cos(r)),this},N.prototype.getAxisAngle=function(){var t,e,i=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);if(i>1e-7){var r=1/i;t=new S(x*r,y*r,z*r),e=this.w<0?2*Math.atan2(-i,-w):2*Math.atan2(i,w)}else t=new S(0,0,0),e=0;return{axis:t,angle:e}},N.prototype.setFromEulerAngles=function(t,e,i){var r=t*c,s=e*c,n=i*c,h=Math.cos(r),a=Math.cos(s),o=Math.cos(n),u=Math.sin(r),l=Math.sin(s),_=Math.sin(n),p=a*o,f=l*_;return this.w=h*p+u*f,this.x=u*p-h*f,this.y=h*l*o+u*a*_,this.z=h*a*_-u*l*o,this.normalize()},N.prototype.getEulerAngles=function(){let t=this.x,e=this.y,i=this.z,r=this.w,s=e*e,n=r*e-i*t;return n<-1?n=-1:n>1&&(n=1),{roll:Math.atan2(2*(r*t+e*i),1-2*(t*t+s)),pitch:Math.asin(2*n),yaw:Math.atan2(2*(r*i+t*e),1-2*(s+i*i))}},N.prototype.setFromMatrix4=function(t){var e,i,r,s,n,h=[],a=[1,2,0];return(e=(t=t._m)[0]+t[5]+t[10])>0?(i=Math.sqrt(e+1),this.w=i/2,i=.5/i,this.x=(t[6]-t[9])*i,this.y=(t[8]-t[2])*i,this.z=(t[1]-t[4])*i):(r=0,t[5]>t[0]&&(r=1),t[10]>t[5*r]&&(r=2),n=a[s=a[r]],i=Math.sqrt(t[5*r]-(t[5*s]+t[5*n])+1),h[r]=.5*i,0!==i&&(i=.5/i),h[3]=(t[4*s+n]-t[4*n+s])*i,h[s]=(t[4*r+s]+t[4*s+r])*i,h[n]=(t[4*r+n]+t[4*n+r])*i,this.x=h[0],this.y=h[1],this.z=h[2],this.w=h[3]),this},N.prototype.getMat4=function(t){var e=this.x+this.x,i=this.y+this.y,r=this.z+this.z,s=this.w*e,n=this.w*i,h=this.w*r,a=this.x*e,o=this.x*i,u=this.x*r,l=this.y*i,_=this.y*r,c=this.z*r;return(t||new B).set([1-(l+c),o-h,u+n,0,o+h,1-(a+c),_-s,0,u-n,_+s,1-(a+l),0,0,0,0,1])},N.prototype.getMat3=function(){var t=new I,e=t._m,i=this.x,r=this.y,s=this.z,n=this.w,h=i+i,a=r+r,o=s+s,u=i*h,l=i*a;i*=o;var _=r*a;return r*=o,s*=o,h*=n,a*=n,n*=o,e[0]=1-(_+s),e[1]=l-n,e[2]=i+a,e[3]=l+n,e[4]=1-(u+s),e[5]=r-h,e[6]=i-a,e[7]=r+h,e[8]=1-(u+_),t},N.prototype.mulVec3=function(t){var e=t.x,i=t.y,r=t.z,s=this.x,n=this.y,h=this.z,a=this.w,o=a*e+n*r-h*i,u=a*i+h*e-s*r,l=a*r+s*i-n*e;return new S(o*a+(e=-s*e-n*i-h*r)*-s+u*-h-l*-n,u*a+e*-n+l*-s-o*-h,l*a+e*-h+o*-n-u*-s)},N.prototype.mul=function(t){var e=this.x,i=this.y,r=this.z,s=this.w,n=t.x,h=t.y,a=t.z,o=t.w;return new N(e*o+s*n+i*a-r*h,i*o+s*h+r*n-e*a,r*o+s*a+e*h-i*n,s*o-e*n-i*h-r*a)},N.prototype.mulA=function(t){var e=this.x,i=this.y,r=this.z,s=this.w,n=t.x,h=t.y,a=t.z,o=t.w;return this.x=e*o+s*n+i*a-r*h,this.y=i*o+s*h+r*n-e*a,this.z=r*o+s*a+e*h-i*n,this.w=s*o-e*n-i*h-r*a,this},N.prototype.conjugate=function(){return new N(-this.x,-this.y,-this.z,this.w)},N.prototype.inverse=function(){var t=1/this.magnitude2();return new N(-this.x*t,-this.y*t,-this.z*t,this.w*t)},N.prototype.magnitude=function(){var t=this.x,e=this.y,i=this.z,r=this.w;return Math.sqrt(t*t+e*e+i*i+r*r)},N.prototype.magnitude2=function(){var t=this.x,e=this.y,i=this.z,r=this.w;return t*t+e*e+i*i+r*r},N.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},N.prototype.normalize=function(){var t=this.x,e=this.y,i=this.z,r=this.w,s=Math.sqrt(t*t+e*e+i*i+r*r);return 0===s?(this.x=0,this.y=0,this.z=0,this.w=0,this):(s=1/s,this.x=t*s,this.y=e*s,this.z=i*s,this.w=r*s,this)},N.prototype.isEqual=function(t){var e=this.dot(t);return Math.abs(e-1)<.001},N.prototype.slerp=function(t,e){var i,r,s,n,h,a=this.x,o=this.y,u=this.z,l=this.w,_=t.x,c=t.y,p=t.z,f=t.w;return(r=a*_+o*c+u*p+l*f)<0&&(r=-r,_=-_,c=-c,p=-p,f=-f),1-r>1e-6?(i=Math.acos(r),s=Math.sin(i),n=Math.sin((1-e)*i)/s,h=Math.sin(e*i)/s):(n=1-e,h=e),new N(n*a+h*_,n*o+h*c,n*u+h*p,n*l+h*f)},N.prototype.getRoll=function(t){var e=this.x,i=this.y,r=this.z,s=this.w;if(t){var n=2*i,h=2*r,a=h*s,o=n*e,u=n*i,l=h*r;return Math.atan2(o+a,1-(u+l))}return Math.atan2(2*(e*i+s*r),s*s+e*e-i*i-r*r)},N.prototype.getPitch=function(t){var e=this.x,i=this.y,r=this.z,s=this.w;if(t){var n=2*e,h=2*r,a=n*s,o=n*e,u=h*i,l=h*r;return Math.atan2(u+a,1-(o+l))}return Math.atan2(2*(i*r+s*e),s*s-e*e-i*i+r*r)},N.prototype.getYaw=function(t){var e=this.x,i=this.y,r=this.z,s=this.w;if(t){var n=2*i,h=n*s,a=2*e*e,o=2*r*e,u=n*i;return Math.atan2(o+h,1-(a+u))}return Math.asin(-2*(e*r-s*i))};const S=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0};S.UP=new S(0,1,0),S.DOWN=new S(0,-1,0),S.RIGHT=new S(1,0,0),S.LEFT=new S(-1,0,0),S.FORWARD=new S(0,0,-1),S.BACKWARD=new S(0,0,1),S.ZERO=new S,S.UNIT_X=new S(1,0,0),S.UNIT_Y=new S(0,1,0),S.UNIT_Z=new S(0,0,1),S.doubleToTwoFloats=function(t,e,i){let r=t.x,s=t.y,n=t.z;if(r>=0){var h=65536*Math.floor(r/65536);e.x=Math.fround(h),i.x=Math.fround(r-h)}else{h=65536*Math.floor(-r/65536);e.x=Math.fround(-h),i.x=Math.fround(r+h)}if(s>=0){h=65536*Math.floor(s/65536);e.y=Math.fround(h),i.y=Math.fround(s-h)}else{h=65536*Math.floor(-s/65536);e.y=Math.fround(-h),i.y=Math.fround(s+h)}if(n>=0){h=65536*Math.floor(n/65536);e.z=Math.fround(h),i.z=Math.fround(n-h)}else{h=65536*Math.floor(-n/65536);e.z=Math.fround(-h),i.z=Math.fround(n+h)}},S.doubleToTwoFloat32Array=function(t,e,i){let r=t.x,s=t.y,n=t.z;if(r>=0){var h=65536*Math.floor(r/65536);e[0]=Math.fround(h),i[0]=Math.fround(r-h)}else{h=65536*Math.floor(-r/65536);e[0]=Math.fround(-h),i[0]=Math.fround(r+h)}if(s>=0){h=65536*Math.floor(s/65536);e[1]=Math.fround(h),i[1]=Math.fround(s-h)}else{h=65536*Math.floor(-s/65536);e[1]=Math.fround(-h),i[1]=Math.fround(s+h)}if(n>=0){h=65536*Math.floor(n/65536);e[2]=Math.fround(h),i[2]=Math.fround(n-h)}else{h=65536*Math.floor(-n/65536);e[2]=Math.fround(-h),i[2]=Math.fround(n+h)}},S.fromVec=function(t){return new S(t[0],t[1],t[2])},S.angle=function(t,e){return Math.acos(t.dot(e)/Math.sqrt(t.length2()*e.length2()))},S.lerp=function(t,e,i){return S(t.x+(e.x-t.x)*i,t.y+(e.y-t.y)*i,t.z+(e.z-t.z)*i)},S.add=function(t,e){var i=new S(t.x,t.y,t.z);return i.addA(e),i},S.sub=function(t,e){var i=new S(t.x,t.y,t.z);return i.subA(e),i},S.scale=function(t,e){var i=new S(t.x,t.y,t.z);return i.scale(e),i},S.mul=function(t,e){var i=new S(t.x,t.y,t.z);return i.mulA(e),i},S.noncollinear=function(t,e){return t.y*e.z-t.z*e.y||t.z*e.x-t.x*e.z||t.x*e.y-t.y*e.z},S.proj_b_to_plane=function(t,e,i){var r=t.sub(e.scaleTo(e.dot(t)/e.dot(e)));return i&&r.isZero()?new S(i.x,i.y,i.z):r},S.proj_b_to_a=function(t,e){return e.scaleTo(e.dot(t)/e.dot(e))},S.orthoNormalize=function(t,e){return(t=t.normal()).scale(e.dot(t)),e.subA(t).normalize()},S.div=function(t,e){var i=new S(t.x,t.y,t.z);return i.divA(e),i},S.prototype.toVec4=function(){return new P(this.x,this.y,this.z,1)},S.prototype.clone=function(){return new S(this.x,this.y,this.z)},S.prototype.toString=function(){return"("+this.x+","+this.y+","+this.z+")"},S.prototype.isZero=function(){return!(this.x||this.y||this.z)},S.prototype.projToVec=function(t){return t.scaleTo(t.dot(this)/t.dot(t))},S.prototype.equal=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},S.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},S.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},S.prototype.length2=function(){return this.x*this.x+this.y*this.y+this.z*this.z},S.prototype.getQuat=function(){return new N(this.x,this.y,this.z)},S.prototype.addA=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},S.prototype.add=function(t){return new S(this.x+t.x,this.y+t.y,this.z+t.z)},S.prototype.subA=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},S.prototype.sub=function(t){return new S(this.x-t.x,this.y-t.y,this.z-t.z)},S.prototype.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this},S.prototype.scaleTo=function(t){return new S(this.x*t,this.y*t,this.z*t)},S.prototype.mulA=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},S.prototype.mul=function(t){return new S(this.x*t.x,this.y*t.y,this.z*t.z)},S.prototype.divA=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},S.prototype.div=function(t){return new S(this.x/t.x,this.y/t.y,this.z/t.z)},S.prototype.dot=function(t){return t.x*this.x+t.y*this.y+t.z*this.z},S.prototype.dotArr=function(t){return t[0]*this.x+t[1]*this.y+t[2]*this.z},S.prototype.cross=function(t){return new S(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},S.prototype.clear=function(){return this.x=this.y=this.z=0,this},S.prototype.normal=function(){var t=new S;t.copy(this);var e=1/t.length();return t.x*=e,t.y*=e,t.z*=e,t},S.prototype.normalNegate=function(){var t=new S;t.copy(this);var e=-1/t.length();return t.x*=e,t.y*=e,t.z*=e,t},S.prototype.normalNegateScale=function(t){var e=new S;e.copy(this);var i=-t/e.length();return e.x*=i,e.y*=i,e.z*=i,e},S.prototype.normalScale=function(t){var e=new S;e.copy(this);var i=t/e.length();return e.x*=i,e.y*=i,e.z*=i,e},S.prototype.normalize=function(){var t=1/this.length();return this.x*=t,this.y*=t,this.z*=t,this},S.prototype.toVec=function(){return[this.x,this.y,this.z]},S.prototype.toArray=function(){return[this.x,this.y,this.z]},S.prototype.distance=function(t){return S.sub(this,t).length()},S.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},S.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},S.prototype.negateTo=function(){return new S(-this.x,-this.y,-this.z)},S.prototype.projToRay=function(t,e){var i=S.proj_b_to_a(S.sub(this,t),e);return i.addA(t),i},S.prototype.angle=function(t){return S.angle(this,t)},S.prototype.lerp=function(t,e){return new S(this.x+(t.x-this.x)*e,this.y+(t.y-this.y)*e,this.z+(t.z-this.z)*e)},S.prototype.smerp=function(t,e){var i=1-e;return new S(this.x*e+t.x*i,this.y*e+t.y*i,this.z*e+t.z*i)},S.LERP_DELTA=1e-6,S.prototype.slerp=function(t,e){var i=new S;if(e<=0)i.copy(this);else{if(!(e>=1)){var r,s,n,h,a=this.dot(t);return 1-a>S.LERP_DELTA?(r=Math.acos(a),s=Math.sin(r),n=Math.sin((1-e)*r)/s,h=Math.sin(e*r)/s):(n=1-e,h=e),S.add(this.scaleTo(n),t.scale(h))}i.copy(t)}},S.prototype.getRotationTo=function(t,e){let i=this.clone(),r=t.clone();i.normalize(),r.normalize();let s=i.dot(r);if(s>=1)return N.IDENTITY.clone();if(s<1e-6-1){if(e.isEqual(S.ZERO)){let t=S.UNIT_X.cross(i);return t.isZero()&&(t=S.UNIT_Y.cross(i)),t.normalize(),N.axisAngleToQuat(Math.PI,t)}return N.axisAngleToQuat(Math.PI,e)}{let t=Math.sqrt(2*(1+s)),e=1/t,n=i.cross(r),h=new N(n.x*e,n.y*e,n.z*e,.5*t);return h.normalise(),h}};const L=function(t,e){this.x=t||0,this.y=e||0};function X(t){return null==t}L.UP=new L(0,1),L.DOWN=new L(0,-1),L.RIGHT=new L(1,0),L.LEFT=new L(-1,0),L.ZERO=new L,L.add=function(t,e){var i=new L(t.x,t.y);return i.addA(e),i},L.sub=function(t,e){var i=new oVec2(t.x,t.y);return i.subA(e),i},L.scale=function(t,e){var i=new L(t.x,t.y);return i.scale(e),i},L.mul=function(t,e){var i=new L(t.x,t.y);return i.mulA(e),i},L.div=function(t,e){var i=new L(t.x,t.y);return i.divA(e),i},L.proj_b_to_a=function(t,e){return e.scaleTo(e.dot(t)/e.dot(e))},L.angle=function(t,e){return Math.acos(t.dot(e)/Math.sqrt(t.length2()*e.length2()))},L.orthoNormalize=function(t,e){return(t=t.norm()).scale(e.dot(t)),e.sub(t).normalize()},L.prototype.toVector3=function(){return new S(this.x,this.y,0)},L.prototype.clone=function(){return new L(this.x,this.y)},L.prototype.equal=function(t){return this.x===t.x&&this.y===t.y},L.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this},L.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},L.prototype.length2=function(){return this.x*this.x+this.y*this.y},L.prototype.addA=function(t){return this.x+=t.x,this.y+=t.y,this},L.prototype.add=function(t){return new L(this.x+t.x,this.y+t.y)},L.prototype.subA=function(t){return this.x-=t.x,this.y-=t.y,this},L.prototype.sub=function(t){return new L(this.x-t.x,this.y-t.y)},L.prototype.scale=function(t){return this.x*=t,this.y*=t,this},L.prototype.scaleTo=function(t){return new L(this.x*t,this.y*t)},L.prototype.mulA=function(t){return this.x*=t.x,this.y*=t.y,this},L.prototype.mul=function(t){return new L(this.x*t.x,this.y*t.y)},L.prototype.divA=function(t){return this.x/=t.x,this.y/=t.y,this},L.prototype.dot=function(t){return t.x*this.x+t.y*this.y},L.prototype.dotArr=function(t){return t[0]*this.x+t[1]*this.y},L.prototype.cross=function(t){return this.x*t.y-this.y*t.x},L.prototype.clear=function(){return this.x=this.y=0,this},L.prototype.normal=function(){var t=new L;t.copy(this);var e=1/t.length();return t.x*=e,t.y*=e,t},L.prototype.normalize=function(){var t=1/this.length();return this.x*=t,this.y*=t,this},L.prototype.toVec=function(){return[this.x,this.y]},L.prototype.distance=function(t){return L.sub(this,t).length()},L.prototype.set=function(t,e){return this.x=t,this.y=e,this},L.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},L.prototype.negateTo=function(){return new L(-this.x,-this.y)},L.prototype.projToRay=function(t,e){var i=L.proj_b_to_a(L.sub(this,t),e);return i.add(t),i},L.prototype.angle=function(t){return L.angle(this,t)},L.prototype.lerp=function(t,e,i){var r=L.clone(this);return i<=0?r.copy(t):i>=1?r.copy(e):r=L.add(t,L.sub(e,t).scale(i)),r},L.LERP_DELTA=1e-6,L.prototype.slerp=function(t,e){var i=new L;if(e<=0)i.copy(this);else{if(!(e>=1)){var r,s,n,h,a=this.dot(t);return 1-a>L.LERP_DELTA?(r=Math.acos(a),s=Math.sin(r),n=Math.sin((1-e)*r)/s,h=Math.sin(e*r)/s):(n=1-e,h=e),L.add(this.scale(n),t.scale(h))}i.copy(t)}},"createImageBitmap"in window||(window.createImageBitmap=function(t){return new Promise((e,i)=>{let r=document.createElement("img");r.addEventListener("load",(function(){e(this)})),r.src=URL.createObjectURL(t)})});let O=0;function W(t,e,i){for(var r=0,s=t.length-1;r<=s;){var n=s+r>>1,h=i(e,t[n],n);if(h>0)r=n+1;else{if(!(h<0))return n;s=n-1}}return-r-1}class G{constructor(t,e){this._eventNames=[],t&&this.registerNames(t),this._sender=e||this,this._stopPropagation=!1,this._stampCache={},this.__id=G._staticCounter++}static get _staticCounter(){return this.__counter__||0===this.__counter__||(this.__counter__=0),this.__counter__}static set _staticCounter(t){this.__counter__=t}bindSender(t){this._sender=t||this}registerNames(t){for(var e=0;e<t.length;e++)this[t[e]]={active:!0,handlers:[]},this._eventNames.push(t[e])}_getStamp(t,e,i){return`${t}_${e}_${i}`}_stamp(t,e){var i=function(t){var e=t._openglobus_id;return e||(e=t._openglobus_id=++O),e}(e),r=this._getStamp(t,this.__id,i);return!this._stampCache[r]&&(this._stampCache[r]=i,!0)}on(t,e,i,r=0){if(this._stamp(t,e)&&this[t]){let a=e.bind(i||this._sender);a._openglobus_id=e._openglobus_id,a._openglobus_priority=r,s=this[t].handlers,(h=W(s,n=a,(t,e)=>e._openglobus_priority-t._openglobus_priority))<0&&(h=~h),s.splice(h,0,n)}var s,n,h}off(t,e){if(e){var i=this._getStamp(t,this.__id,e._openglobus_id);if(e._openglobus_id&&this._stampCache[i]){for(var r=this[t].handlers,s=r.length,n=-1;s--;){if(r[s]._openglobus_id===e._openglobus_id){n=s;break}}-1!==n&&(r.splice(n,1),this._stampCache[i]=void 0,delete this._stampCache[i])}}}dispatch(t,...e){if(t&&t.active)for(var i=t.handlers,r=i.length;r--&&!this._stopPropagation;)i[r](...e);this._stopPropagation=!1}stopPropagation(){this._stopPropagation=!0}clear(){for(var t=0;t<this._eventNames.length;t++){var e=this[this._eventNames[t]];e.handlers.length=0,e.handlers=[]}this._eventNames.length=0,this._eventNames=[]}}const H=.001,k=1e3,V=60,q=1/V,Y=3600,j=1/Y,K=12*Y,Q=86400,Z=1/864e5,$=1/Q,J=2451545;function tt(t){var e,i,r,s,n,h=(e=t.getUTCFullYear(),i=t.getUTCMonth()+1,r=t.getUTCDate(),(1461*(n=e+4800+(s=(i-14)/12|0))/4|0)+(367*(i-2-12*s)/12|0)-(3*((n+100)/100|0)/4|0)+r-32075),a=t.getUTCHours()-12;a<0&&(a+=24);var o=t.getUTCSeconds()+a*Y+t.getUTCMinutes()*V+t.getUTCMilliseconds()*H;o>=K&&h--;var u=o*$|0;return h+=u,(o-=Q*u)<0&&(h--,o+=Q),h+o*$}function et(t){var e=st,i=W(e,t,(function(t,e){return t-e.jd}));i<0&&(i=~i),i>=e.length&&(i=e.length-1);var r=e[i].leapSeconds;return 0!==i&&(e[i].jd-t)*Q>r&&(r=e[i-1].leapSeconds),t+r*$}function it(t){var e=0|t,i=(t-e)*Q;i>=K&&e++;var r=e+68569|0,s=4*r/146097|0,n=4e3*((r=r-((146097*s+3)/4|0)|0)+1)/1461001|0,h=80*(r=r-(1461*n/4|0)+31|0)/2447|0,a=r-(2447*h/80|0)|0,o=h+2-12*(r=h/11|0)|0,u=100*(s-49)+n+r|0,l=i*j|0,_=i-l*Y,c=_*q|0,p=0|(_-=c*V),f=(_-p)*k|0;return(l+=12)>23&&(l-=24),new Date(Date.UTC(u,o-1,a,l,c,p,f))}function rt(t,e){return{jd:t,leapSeconds:e}}const st=[rt(2441317.5,10),rt(2441499.5,11),rt(2441683.5,12),rt(2442048.5,13),rt(2442413.5,14),rt(2442778.5,15),rt(2443144.5,16),rt(2443509.5,17),rt(2443874.5,18),rt(2444239.5,19),rt(2444786.5,20),rt(2445151.5,21),rt(2445516.5,22),rt(2446247.5,23),rt(2447161.5,24),rt(2447892.5,25),rt(2448257.5,26),rt(2448804.5,27),rt(2449169.5,28),rt(2449534.5,29),rt(2450083.5,30),rt(2450630.5,31),rt(2451179.5,32),rt(2453736.5,33),rt(2454832.5,34),rt(2456109.5,35),rt(2457204.5,36)];et(J);class nt{static get _staticCounter(){return this._counter||0===this._counter||(this._counter=0),this._counter}static set _staticCounter(t){this._counter=t}constructor(t){t=t||{},this._id=nt._staticCounter++,this.name=t.name||"",this.events=new G(["tick","end"],this),this.startDate=t.startDate||0,this.endDate=t.endDate||0;var e=t.currentDate||tt(new Date);t.startDate&&e<t.startDate&&(e=t.startDate),t.endDate&&e>t.endDate&&(e=t.endDate),this.currentDate=e,this.multiplier=void 0!==t.multiplier?t.multiplier:1,this.deltaTicks=0,this.active=!0,this._intervalDelay=0,this._intervalStart=0,this._intervalCallback=null}clearInterval(){this._intervalDelay=0,this._intervalStart=0,this._intervalCallback=null}setInterval(t,e){this._intervalStart=this.currentDate,this._intervalDelay=t*Z,this._intervalCallback=e}setDate(t){var e=tt(t);this.startDate&&e<this.startDate&&(e=this.startDate),this.endDate&&e>this.endDate&&(e=this.endDate),this.currentDate=e}getDate(){return it(this.currentDate)}reset(){this.startDate&&(this.currentDate=this.startDate)}_tick(t){if(this.deltaTicks=t*this.multiplier,this.active){var e=(i=this.currentDate,r=this.deltaTicks,i+r*Z);this.multiplier>0?this.endDate&&e>this.endDate?(this.currentDate=this.startDate,this.events.dispatch(this.events.end,this)):this.currentDate=e:this.startDate&&e<this.startDate?(this.currentDate=this.endDate,this.events.dispatch(this.events.end,this)):this.currentDate=e,this._intervalCallback&&this.currentDate-this._intervalStart>=this._intervalDelay&&(this._intervalStart=this.currentDate,this._intervalCallback(this)),this.events.dispatch(this.events.tick,this)}var i,r}equal(t){return this._id===t._id}}const ht=function(t,e){this._program=e,this._handler=t,this._activated=!1};ht.prototype.initialize=function(){this._program.createProgram(this._handler.gl)},ht.prototype.getProgram=function(){return this._program},ht.prototype.activate=function(){if(!this._activated){this._handler.activeProgram.deactivate(),this._handler.activeProgram=this;var t=this._program;this._activated=!0,t.enableAttribArrays(),t.use()}return this},ht.prototype.remove=function(){var t=this._handler.programs;t[this._program.name]&&(this._activated&&this.deactivate(),this._program.delete(),t[this._program.name]=null,delete t[this._program.name])},ht.prototype.deactivate=function(){this._program.disableAttribArrays(),this._activated=!1},ht.prototype.isActive=function(){return this._activated},ht.prototype.set=function(t){return this.activate(),this._program.set(t),this},ht.prototype.drawIndexBuffer=function(t,e){return this._program.drawIndexBuffer(t,e),this},ht.prototype.drawArrays=function(t,e){return this._program.drawArrays(t,e),this};class at{constructor(){this.next=null,this.prev=null,this.data=null}}class ot{constructor(t=256){this._current=new at,this._head=this._current;for(var e=0;e<t;e++){var i=new at;i.prev=this._current,this._current.next=i,this._current=i}this._current=this._head}current(){return this._current}push(t){this._current=this._current.next,this._current.data=t}pop(t){return this._current=this._current.prev,this._current.next.data}popPrev(t){return this._current=this._current.prev,this._current.data}}const ut=["","WEBKIT_","MOZ_"],lt=function(t,e){e=e||{},this.defaultClock=new nt,this._clocks=[],this.deltaTime=0,this.canvas=null,this.gl=null,this.programs={},this.activeProgram=null,this._params=e||{},this._params.anisotropy=this._params.anisotropy||8;var i=this._params.width;i>4096&&(i=4096),this._params.width=i||256;var r=this._params.height;r>4096&&(r=4096),this._params.height=r||256,this._params.context=this._params.context||{},this._params.extensions=this._params.extensions||[],this._oneByHeight=1/this._params.height,this.extensions={},this._id=t,this._lastAnimationFrameTime=0,this._initialized=!1,this._frameCallback=function(){},this.transparentTexture=null,this.framebufferStack=new ot,(e.autoActivate||X(e.autoActivate))&&this.initialize()};lt.getExtension=function(t,e){var i,r;for(i in ut)if(r=t.getExtension(ut[i]+e))return r;return null};const _t=["webgl2","webgl"];lt.getContext=function(t,e){var i=null;try{for(let r=0;r<_t.length;r++)if(i=t.getContext(_t[r],e)){i.type=_t[r];break}}catch(t){n.logErr("exception during the GL context initialization")}return i||n.logErr("could not initialise WebGL"),i},lt.prototype.setFrameCallback=function(t){t&&(this._frameCallback=t)},lt.prototype.createTexture_n=function(t){var e=this.gl,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),i},lt.prototype.createEmptyTexture2DExt=function(t=1,e=1,i="NEAREST",r="RGBA",s="RGBA",n="UNSIGNED_BYTE",h=0){var a=this.gl,o=a.createTexture();return a.bindTexture(a.TEXTURE_2D,o),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),a.texImage2D(a.TEXTURE_2D,h,a[r.toUpperCase()],t,e,0,a[s.toUpperCase()],a[n.toUpperCase()],null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a[i.toUpperCase()]),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a[i.toUpperCase()]),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o},lt.prototype.createEmptyTexture_n=function(t,e){var i=this.gl,r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.bindTexture(i.TEXTURE_2D,null),r},lt.prototype.createEmptyTexture_l=function(t,e){var i=this.gl,r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.bindTexture(i.TEXTURE_2D,null),r},lt.prototype.createTexture_l=function(t){var e=this.gl,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),i},lt.prototype.createTexture_mm=function(t){var e=this.gl,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.generateMipmap(e.TEXTURE_2D),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),i},lt.prototype.createTexture_a=function(t){var e=this.gl,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.generateMipmap(e.TEXTURE_2D),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameterf(e.TEXTURE_2D,this.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._params.anisotropy),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),i},lt.prototype.createTexture=function(t){return this.createTexture_a(t)},lt.prototype.loadCubeMapTexture=function(t){var e=this.gl,i=e.createTexture();e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR);var s=[[t.px,e.TEXTURE_CUBE_MAP_POSITIVE_X],[t.nx,e.TEXTURE_CUBE_MAP_NEGATIVE_X],[t.py,e.TEXTURE_CUBE_MAP_POSITIVE_Y],[t.ny,e.TEXTURE_CUBE_MAP_NEGATIVE_Y],[t.pz,e.TEXTURE_CUBE_MAP_POSITIVE_Z],[t.nz,e.TEXTURE_CUBE_MAP_NEGATIVE_Z]],n=new r;n.fillEmpty();var h=n.getImage();for(let t=0;t<s.length;t++){let r=s[t][1];e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(r,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,h)}for(let t=0;t<s.length;t++){let r=s[t][1],n=new Image;n.crossOrigin="",n.onload=function(t,i,r){return function(){e.bindTexture(e.TEXTURE_CUBE_MAP,t),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(i,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r)}}(i,r,n),n.src=s[t][0]}return i},lt.prototype.addProgram=function(t,e){if(this.programs[t.name])console.log("og.webgl.Handler:284 - shader program: '"+t.name+"' is allready exists.");else{var i=new ht(this,t);this.programs[t.name]=i,this._initProgramController(i),e&&(i._activated=!1)}return t},lt.prototype.removeProgram=function(t){this.programs[t]&&this.programs[t].remove()},lt.prototype.addPrograms=function(t){for(var e=0;e<t.length;e++)this.addProgram(t[e])},lt.prototype._initProgramController=function(t){this._initialized&&(t.initialize(),this.activeProgram?(t.deactivate(),this.activeProgram._program.enableAttribArrays(),this.activeProgram._program.use()):(this.activeProgram=t,t.activate()))},lt.prototype._initPrograms=function(){for(var t in this.programs)this._initProgramController(this.programs[t])},lt.prototype.initializeExtension=function(t,e){if(!this.extensions||!this.extensions[t]){var i=lt.getExtension(this.gl,t);i?this.extensions[t]=i:e&&console.log("og.webgl.Handler: extension '"+t+"' doesn't initialize.")}return this.extensions&&this.extensions[t]},lt.prototype.initialize=function(){this._id?this.canvas=document.getElementById(this._id):(this.canvas=document.createElement("canvas"),this.canvas.width=this._params.width,this.canvas.height=this._params.height),this.gl=lt.getContext(this.canvas,this._params.context),this._initialized=!0,this._params.extensions.push("EXT_texture_filter_anisotropic"),"webgl"===this.gl.type?(this._params.extensions.push("OES_standard_derivatives"),this._params.extensions.push("OES_element_index_uint")):(this._params.extensions.push("EXT_color_buffer_float"),this._params.extensions.push("OES_texture_float_linear"));for(var t=this._params.extensions.length;t--;)this.initializeExtension(this._params.extensions[t],!0);this.extensions.EXT_texture_filter_anisotropic||(this.createTexture=this.createTexture_mm),this._initPrograms(),this._setDefaults()},lt.prototype._setDefaults=function(){this.activateDepthTest(),this.setSize(this.canvas.clientWidth||this._params.width,this.canvas.clientHeight||this._params.height),this.gl.frontFace(this.gl.CCW),this.gl.cullFace(this.gl.BACK),this.activateFaceCulling(),this.deactivateBlending();var t=this;this.createDefaultTexture({color:"rgba(0,0,0,0.0)"},(function(e){t.transparentTexture=e}))},lt.prototype.activateDepthTest=function(){this.gl.enable(this.gl.DEPTH_TEST)},lt.prototype.deactivateDepthTest=function(){this.gl.disable(this.gl.DEPTH_TEST)},lt.prototype.activateFaceCulling=function(){this.gl.enable(this.gl.CULL_FACE)},lt.prototype.deactivateFaceCulling=function(){this.gl.disable(this.gl.CULL_FACE)},lt.prototype.activateBlending=function(){this.gl.enable(this.gl.BLEND)},lt.prototype.deactivateBlending=function(){this.gl.disable(this.gl.BLEND)},lt.prototype.createArrayBuffer=function(t,e,i,r){var s=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,r||this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),s.itemSize=e,s.numItems=i,s},lt.prototype.createElementArrayBuffer=function(t,e,i,r){var s=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,s),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,t,r||this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null),s.itemSize=e,s.numItems=i||t.length,s},lt.prototype.setSize=function(t,e){t>4096&&(t=4096),e>4096&&(e=4096),this._params.width=t,this._params.height=e,this.canvas.width=t,this.canvas.height=e,this._oneByHeight=1/e,this.gl&&this.gl.viewport(0,0,t,e),this.onCanvasResize&&this.onCanvasResize(this.canvas)},lt.prototype.getWidth=function(){return this.canvas.width},lt.prototype.getHeight=function(){return this.canvas.height},lt.prototype.getClientAspect=function(){return this.canvas.clientWidth/this.canvas.clientHeight},lt.prototype.getCenter=function(){var t=this.canvas;return new L(Math.round(.5*t.width),Math.round(.5*t.height))},lt.prototype.drawFrame=function(){var t=(new Date).getTime();this.deltaTime=t-this._lastAnimationFrameTime,this._lastAnimationFrameTime=t,this.defaultClock._tick(this.deltaTime);for(var e=0;e<this._clocks.length;e++)this._clocks[e]._tick(this.deltaTime);var i=this.canvas;i.clientWidth===i.width&&i.clientHeight===i.height||this.setSize(i.clientWidth,i.clientHeight),this._frameCallback()},lt.prototype.clearFrame=function(){var t=this.gl;this.gl.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)},lt.prototype.start=function(){if(!this._requestAnimationFrameId&&this._initialized){var t=new Date;this._lastAnimationFrameTime=t.getTime(),this.defaultClock.setDate(t),this._animationFrameCallback()}},lt.prototype.stop=function(){this._requestAnimationFrameId&&(window.cancelAnimationFrame(this._requestAnimationFrameId),this._requestAnimationFrameId=null)},lt.prototype._animationFrameCallback=function(){this._requestAnimationFrameId=window.requestAnimationFrame(()=>{this.drawFrame(),this._animationFrameCallback()})},lt.prototype.createDefaultTexture=function(t,e){var i,s;if(t&&t.color)(i=new r(2,2)).fillColor(t.color),(s=this.createTexture_n(i._canvas)).default=!0,e(s);else if(t&&t.url){var n=new Image,h=this;n.onload=function(){(s=h.createTexture(this)).default=!0,e(s)},n.src=t.url}else(i=new r(2,2)).fillColor("#C5C5C5"),(s=this.createTexture_n(i._canvas)).default=!0,e(s)},lt.prototype.destroy=function(){var t=this.gl;for(var e in this.stop(),this.programs)this.removeProgram(e);t.deleteTexture(this.transparentTexture),this.transparentTexture=null,this.framebufferStack=null,this.framebufferStack=new ot,this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null;var i=t.getParameter(t.MAX_VERTEX_ATTRIBS),r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r);for(let e=0;e<i;++e)t.disableVertexAttribArray(e),t.vertexAttribPointer(e,4,t.FLOAT,!1,0,0),t.vertexAttrib1f(e,0);t.deleteBuffer(r);var s=t.getParameter(t.MAX_TEXTlURE_IMAGE_UNITS);for(let e=0;e<s;++e)t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_CUBE_MAP,null),t.bindTexture(t.TEXTURE_2D,null);t.activeTexture(t.TEXTURE0),t.useProgram(null),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.DITHER),t.disable(t.SCISSOR_TEST),t.blendColor(0,0,0,0),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ZERO),t.clearColor(0,0,0,0),t.clearDepth(1),t.clearStencil(-1),this.gl=null,this._initialized=!1},lt.prototype.addClock=function(t){t.__handler||(t.__handler=this,this._clocks.push(t))},lt.prototype.addClocks=function(t){for(var e=0;e<t.length;e++)this.addClock(t[e])},lt.prototype.removeClock=function(t){if(t.__handler)for(var e=this._clocks,i=e.length;i--;)if(e[i].equal(t)){t.__handler=null,e.splice(i,1);break}};const ct=function(t,e){e=e||{},this.handler=t,this._internalFormat=e.internalFormat?e.internalFormat.toUpperCase():"RGBA8",this._fbo=null,this._depthRenderbuffer=null,this._width=e.width||t.canvas.width,this._height=e.height||t.canvas.height,this._msaa=null!=e.msaa?e.msaa:4,this._useDepth=null==e.useDepth||e.useDepth,this._depthComponent=null!=e.depthComponent?e.depthComponent:"DEPTH_COMPONENT16",this._active=!1,this._size=e.size||1,this._filter=e.filter||"NEAREST",this._glFilter=null,this.renderbuffers=new Array(this._size)};ct.prototype.destroy=function(){for(var t=this.handler.gl,e=0;e<this.renderbuffers.length;e++)t.deleteRenderbuffer(this.renderbuffers[e]);this.renderbuffers=new Array(this._size),t.deleteFramebuffer(this._fbo),t.deleteRenderbuffer(this._depthRenderbuffer),this._depthRenderbuffer=null,this._fbo=null,this._active=!1},ct.prototype.init=function(){var t=this.handler.gl;if(this._glFilter=t[this._filter],this._fbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),0===this.renderbuffers.length){let e=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,e),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._msaa,t[this._internalFormat],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,e),this.renderbuffers.push(e),t.bindRenderbuffer(t.RENDERBUFFER,null),t.drawBuffers([t.COLOR_ATTACHMENT0])}else{let i=[];for(var e=0;e<this.renderbuffers.length;e++){let r=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,r),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._msaa,t[this._internalFormat],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.RENDERBUFFER,r),i.push(t.COLOR_ATTACHMENT0+e),this.renderbuffers[e]=r,t.bindRenderbuffer(t.RENDERBUFFER,null)}t.drawBuffers(i)}return this._useDepth&&(this._depthRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._depthRenderbuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._msaa,t[this._depthComponent],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this._depthRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null)),t.bindFramebuffer(t.FRAMEBUFFER,null),this},ct.prototype.blit=function(t,e=0){let i=this.handler.gl;i.bindFramebuffer(i.READ_FRAMEBUFFER,this._fbo),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._fbo),i.readBuffer(i.COLOR_ATTACHMENT0+e),i.clearBufferfv(i.COLOR,0,[0,0,0,1]),i.blitFramebuffer(0,0,this._width,this._height,0,0,t._width,t._height,i.COLOR_BUFFER_BIT,this._glFilter),i.bindFramebuffer(i.FRAMEBUFFER,null),i.bindFramebuffer(i.READ_FRAMEBUFFER,null),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,null)},ct.prototype.setSize=function(t,e,i){this._width=t,this._height=e,this._active&&this.handler.gl.viewport(0,0,this._width,this._height),(this._useDepth||i)&&(this.destroy(),this.init())},ct.prototype.isComplete=function(){var t=this.handler.gl;return t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE},ct.prototype.activate=function(){var t=this.handler.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),t.viewport(0,0,this._width,this._height),this._active=!0;var e=this.handler.framebufferStack.current().data;return e&&(e._active=!1),this.handler.framebufferStack.push(this),this},ct.prototype.deactivate=function(){var t=this.handler,e=t.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this._active=!1;var i=this.handler.framebufferStack.popPrev();i?(e.bindFramebuffer(e.FRAMEBUFFER,i._fbo),e.viewport(0,0,i._width,i._height)):e.viewport(0,0,t.canvas.width,t.canvas.height)};let pt=["FLOAT","DOUBLE","BOOL","INT","UINT","VEC2","VEC3","VEC4","DVEC2","DVEC3","DVEC4","BVEC2","BVEC3","BVEC4","IVEC2","IVEC3","IVEC4","UVEC2","UVEC3","UVEC4","MAT2","DMAT2","MAT3","DMAT3","MAT4","DMAT4","MAT2X3","MAT2X4","MAT3X2","MAT3X4","MAT4X2","MAT4X3","DMAT2X3","DMAT2X4","DMAT3X2","DMAT3X4","DMAT4X2","DMAT4X3","SAMPLER1D","SAMPLER2D","SAMPLER3D","SAMPLERCUBE","SAMPLER2DSHADOW","SAMPLER2DXX","INTXX","FLOATXX"];const ft={};for(let t=0;t<pt.length;t++)ft[pt[t]]=t;const dt={};for(let t=0;t<pt.length;t++)dt[pt[t].toLowerCase()]=ft[pt[t]];const mt={u:[],a:[]};mt.u[ft.MAT4]=function(t,e){t.gl.uniformMatrix4fv(e._pName,!1,e.value)},mt.u[ft.MAT3]=function(t,e){t.gl.uniformMatrix3fv(e._pName,!1,e.value)},mt.u[ft.FLOAT]=function(t,e){t.gl.uniform1f(e._pName,e.value)},mt.u[ft.INT]=function(t,e){t.gl.uniform1i(e._pName,e.value)},mt.u[ft.VEC2]=function(t,e){t.gl.uniform2fv(e._pName,e.value)},mt.u[ft.VEC3]=function(t,e){t.gl.uniform3fv(e._pName,e.value)},mt.u[ft.VEC4]=function(t,e){t.gl.uniform4fv(e._pName,e.value)},mt.u[ft.SAMPLER2D]=function(t,e){let i=t.gl;i.activeTexture(i.TEXTURE0+t._textureID),i.bindTexture(i.TEXTURE_2D,e.value),i.uniform1i(e._pName,t._textureID),t._textureID++},mt.u[ft.SAMPLERCUBE]=function(t,e){let i=t.gl;i.activeTexture(i.TEXTURE0+t._textureID),i.bindTexture(i.TEXTURE_CUBE_MAP,e.value),i.uniform1i(e._pName,t._textureID),t._textureID++},mt.u[ft.SAMPLER2DXX]=function(t,e){let i=t.gl,r=e.value.length,s=new Int32Array(r);for(let n=0;n<r;n++)i.activeTexture(i.TEXTURE0+t._textureID+n),i.bindTexture(i.TEXTURE_2D,e.value[n]),s[n]=n;i.uniform1iv(e._pName,s)},mt.u[ft.INTXX]=function(t,e){pgl.uniform1iv(e._pName,e.value)},mt.u[ft.FLOATXX]=function(t,e){t.gl.uniform1fv(e._pName,e.value)},mt.a[ft.FLOAT]=function(t,e){t.gl.vertexAttrib1f(e._pName,e.value)},mt.a[ft.VEC2]=function(t,e){t.gl.vertexAttrib2fv(e._pName,e.value)},mt.a[ft.VEC3]=function(t,e){t.gl.vertexAttrib3fv(e._pName,e.value)},mt.a[ft.VEC4]=function(t,e){t.gl.vertexAttrib4fv(e._pName,e.value)};class yt{constructor(t,e){this.name=t,this.attributes={},this.uniforms={},this._attributes={};for(let t in e.attributes)"string"==typeof e.attributes[t]||"number"==typeof e.attributes[t]?this._attributes[t]={type:e.attributes[t]}:this._attributes[t]=e.attributes[t];this._uniforms={};for(let t in e.uniforms)"string"==typeof e.uniforms[t]||"number"==typeof e.uniforms[t]?this._uniforms[t]={type:e.uniforms[t]}:this._uniforms[t]=e.uniforms[t];this.vertexShader=e.vertexShader,this.fragmentShader=e.fragmentShader,this.gl=null,this._variables={},this._p=null,this._textureID=0,this._attribArrays=[]}use(){this.gl.useProgram(this._p)}set(t){for(var e in this._textureID=0,t)this._variables[e].value=t[e],this._variables[e]._callback(this,this._variables[e])}apply(){this._textureID=0;var t=this._variables;for(var e in t)t[e]._callback(this,t[e])}drawIndexBuffer(t,e){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,e),this.gl.drawElements(t,e.numItems,this.gl.UNSIGNED_SHORT,0)}drawArrays(t,e){this.gl.drawArrays(t,0,e)}_getShaderCompileStatus(t,e){return this.gl.shaderSource(t,e),this.gl.compileShader(t),!!this.gl.getShaderParameter(t,this.gl.COMPILE_STATUS)||(n.logErr("og/Program/Program:"+this.name+" - "+this.gl.getShaderInfoLog(t)+"."),!1)}_createVertexShader(t){var e=this.gl.createShader(this.gl.VERTEX_SHADER);return this._getShaderCompileStatus(e,t)?e:null}_createFragmentShader(t){var e=this.gl.createShader(this.gl.FRAGMENT_SHADER);return this._getShaderCompileStatus(e,t)?e:null}disableAttribArrays(){for(var t=this.gl,e=this._attribArrays,i=e.length;i--;)t.disableVertexAttribArray(e[i])}enableAttribArrays(){for(var t=this.gl,e=this._attribArrays,i=e.length;i--;)t.enableVertexAttribArray(e[i])}delete(){this.gl.deleteProgram(this._p)}createProgram(t){this.gl=t,this._p=this.gl.createProgram();var e=this._createFragmentShader(this.fragmentShader),i=this._createVertexShader(this.vertexShader);if(t.attachShader(this._p,e),t.attachShader(this._p,i),t.linkProgram(this._p),!t.getProgramParameter(this._p,t.LINK_STATUS))return n.logErr("og/Program/Program:"+this.name+" - couldn't initialise shaders. "+t.getProgramInfoLog(this._p)+"."),void t.deleteProgram(this._p);for(var r in this.use(),this._attributes){if(this._variables[r]=this._attributes[r],this._attributes[r].enableArray=null==this._attributes[r].enableArray||this._attributes[r].enableArray,this._attributes[r].enableArray?this._attributes[r]._callback=yt.bindBuffer:"string"==typeof this._attributes[r].type?this._attributes[r]._callback=mt.a[dt[this._attributes[r].type.trim().toLowerCase()]]:this._attributes[r]._callback=mt.a[this._attributes[r].type],this._p[r]=t.getAttribLocation(this._p,r),null==this._p[r])return n.logErr("og/Program/Program:"+this.name+" - attribute '"+r+"' is not exists."),void t.deleteProgram(this._p);this._attributes[r].enableArray&&(this._attribArrays.push(this._p[r]),t.enableVertexAttribArray(this._p[r])),this._attributes[r]._pName=this._p[r],this.attributes[r]=this._p[r]}for(var s in this._uniforms){if("string"==typeof this._uniforms[s].type?this._uniforms[s]._callback=mt.u[dt[this._uniforms[s].type.trim().toLowerCase()]]:this._uniforms[s]._callback=mt.u[this._uniforms[s].type],this._variables[s]=this._uniforms[s],this._p[s]=t.getUniformLocation(this._p,s),null==this._p[s])return n.logErr("og/Program/Program:"+this.name+" - uniform '"+s+"' is not exists."),void t.deleteProgram(this._p);this._uniforms[s]._pName=this._p[s],this.uniforms[s]=this._p[s]}t.detachShader(this._p,e),t.detachShader(this._p,i),t.deleteShader(e),t.deleteShader(i)}static bindBuffer(t,e){var i=t.gl;i.bindBuffer(i.ARRAY_BUFFER,e.value),i.vertexAttribPointer(e._pName,e.value.itemSize,i.FLOAT,!1,0,0)}}class Et{constructor(t,e,i,r){this.left=t||0,this.right=i||0,this.top=e||0,this.bottom=r||0}clone(){return new Et(this.left,this.top,this.right,this.bottom)}getWidth(){return Math.abs(this.right-this.left)}getHeight(){return Math.abs(this.bottom-this.top)}getSquare(){return this.getHeight()*this.getWidth()}getDiagonal(){var t=this.getWidth(),e=this.getHeight();return Math.sqrt(e*e+t*t)}fit(t,e){return this.getWidth()==t&&this.getHeight()==e}isInside(t,e){return t>=this.left&&t<=this.right&&e>=this.top&&e<=this.bottom}}class gt{constructor(t){this._size=t||2048,this._array=new Array(this._size),this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}reset(){this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}clear(){this._array.length=0,this._array=new Array(this._size),this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}push(t){this.length++,this._array[this._popIndex++]=t}pop(){if(this.length){this.length--;var t=this._array[--this._popIndex];return this._array[this._popIndex]=null,this._array[this._popIndex-1]||(this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex),t}}unshift(t){this.length++,this._array[--this._shiftIndex]=t}shift(){if(this.length){this.length--;var t=this._array[this._shiftIndex];return this._array[this._shiftIndex++]=null,this._array[this._shiftIndex]||(this._popIndex=parseInt(.5*this._size),this._shiftIndex=this._popIndex),t}}each(t){for(var e=this._shiftIndex;e<this._popIndex;e++)t(this._array[e])}}class xt{constructor(){this.imagesCache={},this._counter=0,this._pendingsQueue=new gt,this._imageIndexCounter=0}load(t,e){if(this.imagesCache[t])e(this.imagesCache[t]);else{var i={src:t,success:e};this._counter>=1?this._pendingsQueue.push(i):this._exec(i)}}_exec(t){this._counter++;var e=this,i=new Image;i.crossOrigin="",i.onload=function(){e.imagesCache[t.src]=i,this.__nodeIndex=e._imageIndexCounter++,t.success(this),e._dequeueRequest()},i.onerror=function(){e._dequeueRequest()},i.src=t.src}_dequeueRequest(){if(this._counter--,this._pendingsQueue.length&&this._counter<1)for(;this._pendingsQueue.length;){var t=this._pendingsQueue.pop();if(t){if(!this.imagesCache[t.src]){this._exec(t);break}this._counter<=0?this._counter=0:this._counter--,t.success(this.imagesCache[t.src])}}}}class Tt{constructor(t,e){this.nodes=[],this.texture=null,this.canvas=new r(t||1024,e||1024),this.clearCanvas(),this._handler=null,this._images=[],this._btree=null,this._imagesCacheManager=new xt,this.borderSize=4}getImage(){return this.canvas.getImage()}getCanvas(){return this.canvas._canvas}clearCanvas(){this.canvas.fillEmpty("black")}assignHandler(t){this._handler=t,this.createTexture()}getDiagonal(t){var e=t.atlasWidth||t.width,i=t.atlasHeight||t.height;return Math.sqrt(e*e+i*i)}addImage(t,e){if(t.width&&t.height)return this._images.push(t),this._makeAtlas(e),this.nodes[t.__nodeIndex]}_completeNode(t,e){if(e){var i=this.canvas.getWidth(),r=this.canvas.getHeight(),s=e.image,n=e.rect,h=Math.round(.5*this.borderSize);this.canvas.drawImage(s,n.left+h,n.top+h,s.atlasWidth,s.atlasHeight);var a=e.texCoords;a[0]=(n.left+h)/i,a[1]=(n.top+h)/r,a[2]=(n.left+h)/i,a[3]=(n.bottom-h)/r,a[4]=(n.right-h)/i,a[5]=(n.bottom-h)/r,a[6]=(n.right-h)/i,a[7]=(n.bottom-h)/r,a[8]=(n.right-h)/i,a[9]=(n.top+h)/r,a[10]=(n.left+h)/i,a[11]=(n.top+h)/r,t[s.__nodeIndex]=e}}_makeAtlas(t){if(t&&this._btree){let t=this._images[this._images.length-1];this._completeNode(this.nodes,this._btree.insert(t))}else{let t=this._images.slice(0);t.sort((function(t,e){return(e.atlasWidth||e.width)-(t.atlasWidth||t.width)||(e.atlasHeight||e.height)-(t.atlasHeight||t.height)})),this._btree=new vt(new Et(0,0,this.canvas.getWidth(),this.canvas.getHeight())),this._btree.atlas=this,this.clearCanvas();for(var e=[],i=0;i<t.length;i++)this._completeNode(e,this._btree.insert(t[i]));this.nodes=[],this.nodes=e}}createTexture(){this._handler&&(this._handler.gl.deleteTexture(this.texture),this.texture=this._handler.createTexture_mm(this.canvas._canvas))}loadImage(t,e){this._imagesCacheManager.load(t,e)}getImageTexCoordinates(t){if(null!=t.__nodeIndex&&this.nodes[t.__nodeIndex])return this.nodes[t.__nodeIndex].texCoords}}class vt{constructor(t){this.childNodes=null,this.image=null,this.rect=t,this.texCoords=[],this.atlas=null}insert(t){if(this.childNodes){var e=this.childNodes[0].insert(t);return null!=e?e:this.childNodes[1].insert(t)}if(null!=this.image)return null;var i=this.rect,r=(t.atlasWidth||t.width)+this.atlas.borderSize,s=(t.atlasHeight||t.height)+this.atlas.borderSize;return r>i.getWidth()||s>i.getHeight()?null:i.fit(r,s)?(this.image=t,this):(this.childNodes=new Array(2),this.childNodes[0]=new vt,this.childNodes[0].atlas=this.atlas,this.childNodes[1]=new vt,this.childNodes[1].atlas=this.atlas,i.getWidth()-r>i.getHeight()-s?(this.childNodes[0].rect=new Et(i.left,i.top,i.left+r,i.bottom),this.childNodes[1].rect=new Et(i.left+r,i.top,i.right,i.bottom)):(this.childNodes[0].rect=new Et(i.left,i.top,i.right,i.top+s),this.childNodes[1].rect=new Et(i.left,i.top+s,i.right,i.bottom)),this.childNodes[0].insert(t))}}i.d(e,"Handler",(function(){return lt})),i.d(e,"Framebuffer",(function(){return s})),i.d(e,"Multisample",(function(){return ct})),i.d(e,"types",(function(){return ft})),i.d(e,"Program",(function(){return yt})),i.d(e,"TextureAtlas",(function(){return Tt}))}])}));